if(typeof(IWF) == 'undefined') IWF = window.IWF = {};
var utils = IWF.utils = {

    /*数组排序*/
    sort: function (arr, key) {
        var tkey = (key) ? key : 'index';
        return arr.sort(function (x, y) {
            return x[tkey] - y[tkey];
        });
    },

    ///*取得16*16图标*/
    //getIcon16: function (x, y) {
    //    if (y == undefined) {
    //        var ss = x.split(',');
    //        x = parseInt(ss[0]);
    //        y = parseInt(ss[1]);
    //    }
    //    if (x > 0 && y > 0)
    //        return 'background-image:url(resources/iwf-icon-16x16.png);height: 16px;width: 16px;display:block;background-position: -' + (y - 1) * 16 + 'px -' + (x - 1) * 16 + 'px;';
    //    else
    //        return 'height: 16px;width: 16px;display:block;';
    //},

    ///*取得48*48图标*/
    //getIcon48: function (x, y) {
    //    if (y == undefined) {
    //        var ss = x.split(',');
    //        x = parseInt(ss[0]);
    //        y = parseInt(ss[1]);
    //    }
    //    if (x > 0 && y > 0)
    //        return 'background-image:url(resources/iwf-icon-48x48.png);height: 52px;width: 52px;display:block;background-position: -' + (y - 1) * 67 + 'px -' + (x - 1) * 55 + 'px;';
    //    else
    //        return 'height: 52px;width: 52px;display:block;';
    //},

    tplReg1: /\{(\w+):(\{[^\{\}]+\})\}/g,       //{key:{a:b}}
    tplReg2: /\{([^\{\}]+)\}/g,                 //{key}
    tplReg3: /\{(\w+)\(([^\(\)]+)\)\}/g,        //{fn(key)}
    /*替换TPL中的变量{key} OR {key:{a:b}} OR {fn(key)}*/
    replaceTpl: function (tpl, data, fns) {
        return tpl.replace(utils.tplReg1, function (sender, key, value) {
            var json = utils.toJSON(value);
            var jsonkey = data[key] || key;
            return json[jsonkey] || jsonkey;
        }).replace(utils.tplReg3, function (sender, key, value) {
            var v = (value == 'this') ? data : data[value];
            return (fns[key]) ? fns[key](v) : v;
        }).replace(utils.tplReg2, function (sender, key) {
            return data[key] || '';
        });
    },

    /*取得一个随机号,以后可能用guid取代*/
    guid: function () {
        return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
    },

    /*增加一个随机ID*/
    params: function (arg) {
        if (arg) arg._rendomid = utils.guid();
        return arg;
    },

    /*取得当前时间*/
    now: function (format) {
        return utils.formatDate(new Date(), format);
    },

    /*格式化时间*/
    formatDate: function (date, format) {
        if (!format) format = 'yyyy-MM-dd hh:mm:ss';
        var year = date.getFullYear(), moth = date.getMonth() + 1, day = date.getDate(),
            hours = date.getHours(), minutes = date.getMinutes(), seconds = date.getSeconds();

        if (moth < 10) moth = "0" + moth;
        if (day < 10) day = "0" + day;
        if (hours < 10) hours = "0" + hours;
        if (minutes < 10) minutes = "0" + minutes;
        if (seconds < 10) seconds = "0" + seconds;

        return format.replace('yyyy', year).replace('MM', moth).replace('dd', day).replace('hh', hours).replace('mm', minutes).replace('ss', seconds);
    },

    /*将dom转换为有格式的HMTL字符串*/
    getDomHtml: function (root) {

        var htmlText = '',
            indentChar = '  ',
            breakChar = '\n',
            uncontrol = { input: 1, text: 1, br: 1 },
            unbreak = { strong: 1, em: 1, span: 1, u: 1, text: 1, a: 1, b: 1 },
            reg = /^<[^<>]+>/i;

        function startHtml(tchar, name, text) {
            if (unbreak[name]) {
                htmlText += text;
            }
            else {
                htmlText += breakChar + tchar + text;
            }
        }

        function endHtml(tchar, name, hasChild) {
            if (uncontrol[name]) return;
            if (hasChild && !unbreak[name]) htmlText += breakChar + tchar;
            htmlText += '</' + name + '>';
        }

        function domToHtml(dom, level) {
            var name = dom.nodeName.toLowerCase().replace('#', ''),
                ntext = (dom.outerHTML) ? dom.outerHTML.match(reg) : utils.trim(dom.nodeValue),
                tchar = '';
            for (var ti = 0; ti < level; ti++) tchar += indentChar;
            if (ntext) {
                startHtml(tchar, name, ntext);
                var hasChild = false;
                if (dom.childNodes.length > 0) {
                    utils.each(dom.childNodes, function (index, cdom) {
                        if (domToHtml(cdom, level + 1)) hasChild = true;
                    });
                }
                endHtml(tchar, name, hasChild);
                return true;
            } else {
                return false;
            }
        }
        /*去除root*/
        utils.each(root.childNodes, function (index, cdom) {
            domToHtml(cdom, 0);
        });

        return htmlText;
    },

    /*字符串转换成json*/
    toJSON: function (str) {
        return (str) ? eval("(" + str.replace(/\n/g, '') + ")") : {};
    },

    /*json转换成字符串*/
    fromJSON: function (object) {
        var type = typeof object;
        if (object == null) {
            type = 'undefined';
        } else if ('object' == type) {
            if (Array == object.constructor)
                type = 'array';
            else if (RegExp == object.constructor)
                type = 'regexp';
            else
                type = 'object';
        }
        switch (type) {
            case 'undefined':
            case 'unknown':
                return;
                break;
            case 'function':
            case 'boolean':
            case 'regexp':
                return object.toString();
                break;
            case 'number':
                return isFinite(object) ? object.toString() : 'null';
                break;
            case 'string':
                return '"' + object.replace(/(\\|\")/g, "\\$1").replace(/\n|\r|\t/g,
					function () {
					    var a = arguments[0];
					    return (a == '\n') ? '\\n' :
						(a == '\r') ? '\\r' :
						(a == '\t') ? '\\t' : ""
					}) + '"';
                break;
            case 'object':
                if (object === null) return 'null';
                var results = [];
                for (var property in object) {
                    var value = utils.fromJSON(object[property]);
                    if (value !== undefined)
                        results.push(utils.fromJSON(property) + ':' + value);
                }
                return '{' + results.join(',') + '}';
                break;
            case 'array':
                var results = [];
                for (var i = 0; i < object.length; i++) {
                    var value = utils.fromJSON(object[i]);
                    if (value !== undefined) results.push(value);
                }
                return '[' + results.join(',') + ']';
                break;
        }
    },

    /*取得URL中的值*/
    getUrlValue: function (name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]); return null;
    },

    /*动态添加样式表*/
    addSheetFile: function (path) {
        var fileref = document.createElement("link")
        fileref.rel = "stylesheet";
        fileref.type = "text/css";
        fileref.href = path;
        fileref.media = "screen";
        var headobj = document.getElementsByTagName('head')[0];
        headobj.appendChild(fileref);
    },

	/*动态添加JS*/
	addedScript: {},
	addScript: function (path,callback) {

		if(utils.addedScript[path]){
			console.log(path + " have already loaded ");
			if (typeof callback == 'function') callback();
			return;
		}
        var fileref = document.createElement("script")
        fileref.type = "text/javascript";
		try{
			if(fileref.async) fileref.async = false;
			if(fileref.defer) fileref.defer = true;
		}catch(e){}
        fileref.src = path;

		if (typeof callback == 'function') {
            if (typeof fileref.onload != 'undefined') {
                fileref.onload = callback;
            }
            else {
                fileref.onreadystatechange = function () {
                    if (this.readyState == "loaded" || this.readyState == "complete") {
                        callback();
                    }
                };
            }
        }

        var headobj = document.getElementsByTagName('head')[0];
        headobj.appendChild(fileref);
		utils.addedScript[path] = true;
    },

    /**/
    each: function (obj, fn) {
        if (obj == null) return;
        $.each(obj, fn);
    },

    makeInstance: function (obj) {
        var noop = new Function();
        noop.prototype = obj;
        obj = new noop;
        noop.prototype = null;
        return obj;
    },
    /**
     * 将source对象中的属性扩展到target对象上
     */
    extend: function (t, s, b) {
        if (s) {
            for (var k in s) {
                if (!b || !t.hasOwnProperty(k)) {
                    t[k] = s[k];
                }
            }
        }
        return t;
    },
    /**
     * 模拟继承机制，subClass继承superClass
     */
    inherits: function (subClass, superClass) {
        var oldP = subClass.prototype,
            newP = utils.makeInstance(superClass.prototype);
        utils.extend(newP, oldP, true);
        subClass.prototype = newP;
        return (newP.constructor = subClass);
    },

    /*
    *指定上下文
    */
    bind: function (fn, me) {
        return function () {
            return fn.apply(me, arguments);
        };
    },

    /**
     * 查找元素item在数组array中的索引, 若找不到返回-1
     */
    indexOf: function (array, item, start) {
        var index = -1;
        start = this.isNumber(start) ? start : 0;
        this.each(array, function (i, v) {
            if (i >= start && v === item) {
                index = i;
                return false;
            }
        });
        return index;
    },

    /**
     * 移除数组array中的元素item
     */
    removeItem: function (array, item) {
        for (var i = 0, l = array.length; i < l; i++) {
            if (array[i] === item) {
                array.splice(i, 1);
                i--;
            }
        }
    },

    /**
     * 删除字符串str的首尾空格
     */
    trim: function (str) {
        return str.replace(/(^[ \t\n\r]+)|([ \t\n\r]+$)/g, '');
    },

    /*清除字符串中的空格及回车换行等*/
    trim2: function (str) {
        return (str) ? str.replace(/[ \t\n\r]/g, '') : str;
    },

    /*去掉换行符及其后面的空格*/
    trim3: function (str) {
        return (str) ? str.replace(/[\t\n\r] */g, '') : str;
    },

    /**
     * 将str中的html符号转义,默认将转义''&<">''四个字符，可自定义reg来确定需要转义的字符
     */
    unhtml: function (str, reg) {
        return str ? str.replace(reg || /[&<">'](?:(amp|lt|quot|gt|#39|nbsp);)?/g, function (a, b) {
            if (b) {
                return a;
            } else {
                return {
                    '<': '&lt;',
                    '&': '&amp;',
                    '"': '&quot;',
                    '>': '&gt;',
                    "'": '&#39;'
                }[a]
            }

        }) : '';
    },
    /**
     * 将str中的转义字符还原成html字符
     */
    html: function (str) {
        return str ? str.replace(/&((g|l|quo)t|amp|#39);/g, function (m) {
            return {
                '&lt;': '<',
                '&amp;': '&',
                '&quot;': '"',
                '&gt;': '>',
                '&#39;': "'"
            }[m]
        }) : '';
    },

    /**
     * 判断obj对象是否为空
     */
    isEmptyObject: function (obj) {
        if (obj == null) return true;
        if (this.isArray(obj) || this.isString(obj)) return obj.length === 0;
        for (var key in obj) if (obj.hasOwnProperty(key)) return false;
        return true;
    },

    /**
     * 深度克隆对象，从source到target
     */
    clone: function (source, target) {
        var tmp;
        target = target || {};
        for (var i in source) {
            if (source.hasOwnProperty(i)) {
                tmp = source[i];
                if (typeof tmp == 'object') {
                    target[i] = utils.isArray(tmp) ? [] : {};
                    utils.clone(source[i], target[i])
                } else {
                    target[i] = tmp;
                }
            }
        }
        return target;
    },

    /*
    *注册事件
    */
    on: function (el, type, handler) {
        if (!el) return;
        var types = utils.isArray(type) ? type : [type];
        utils.each(types, function (index, key) {
            if (el.addEventListener) {
                el.addEventListener(key, handler, false);
            } else if (el.attachEvent) {
                el.attachEvent("on"+key,handler);
            }
        });
    },

	getUrlParams: function(){
		if(!document.location.search) return null;
		var URLParams = new Object();
		var aParams = document.location.search.substr(1).split('&');
		for (i = 0 ; i < aParams.length ; i++) {
			var aParam = aParams[i].split('=');
			var value = aParam[1];
			if(value && value.indexOf("#") > -1) value = value.substring(0,value.indexOf("#"));
			URLParams[aParam[0]] = decodeURIComponent(value);
		}
		return URLParams;
	}
}

/**
 * 判断str是否为字符串
 */
/**
 * 判断array是否为数组
 */
/**
 * 判断obj对象是否为方法
 */
/**
 * 判断obj对象是否为数字
 */
utils.each(['String', 'Function', 'Array', 'Number', 'RegExp', 'Object','Boolean'], function (index,v) {
    IWF.utils['is' + v] = function (obj) {
        return Object.prototype.toString.apply(obj) == '[object ' + v + ']';
    }
});
﻿EventBase = {
    allListeners: {},
    /*添加监听*/
    addListener: function (types, listener) {
        types = utils.trim(types).split(' ');
        for (var i = 0, ti; ti = types[i++];) {
            if (!this.allListeners[ti]) this.allListeners[ti] = [];
            this.allListeners[ti].push(listener);
        }
    },
    /*移除监听*/
    removeListener: function (types, listener) {
        types = utils.trim(types).split(' ');
        for (var i = 0, ti; ti = types[i++];) {
            if (this.allListeners[ti]) utils.removeItem(this.allListeners[ti], listener);
        }
    },
    /*触发事件*/
    fireEvent: function () {
        var types = arguments[0];
        types = utils.trim(types).split(' ');
        for (var i = 0, ti; ti = types[i++];) {
            var listeners = this.allListeners[ti];
            if (listeners) {
                for (var j = 0, l; l = listeners[j++];) {
                    l.apply(this, arguments);
                }
            }
        }
    }
};
//此文件是用来扩展 js 的原有对象的

String.prototype.format = function(args) {
	var result = this;
	if (arguments.length > 0) {
		if (arguments.length == 1 && args && typeof (args) == "object") {
			for (var key in args) {
				if(args[key]!=undefined){
					var reg = new RegExp("({" + key + "})", "g");
					result = result.replace(reg, args[key]);
				}
			}
		}
		else {
			for (var i = 0; i < arguments.length; i++) {
				if (arguments[i] != undefined) {
					var reg = new RegExp("({)" + i + "(})", "g");
					result = result.replace(reg, arguments[i]);
				}else{
					var reg = new RegExp("({)" + i + "(})", "g");
					result = result.replace(reg, "");
				}
			}
		}
	}
	return result;
};

Date.prototype.getChineseWeekName = function(){
	var week;
	if(this.getDay() == 0) week = "星期日";
	if(this.getDay() == 1) week = "星期一";
	if(this.getDay() == 2) week = "星期二";
	if(this.getDay() == 3) week = "星期三";
	if(this.getDay() == 4) week = "星期四";
	if(this.getDay() == 5) week = "星期五";
	if(this.getDay() == 6) week = "星期六";
	return week;
};


var FrameWork = IWF.FrameWork = function (doc, options) {
    var me = this;
    me.options = utils.extend({
        title: IWF.name,
        userInfo: {},
        navTree: []
    }, options);

    //用户网站后台安全密码盾变量，此变量每次登录都改变
    me.sid = me.options.sid;

	//我们自己管理后台安全密码盾变量，此变量每次登录都改变
    me.said = me.options.said;

    //设置登录用户信息为全局变量
    me.loginUser = me.options.userInfo;

    //命令
    me.commands = {};
    //导航
    //me.navigators = [];
    //权限
    me.rules = {};
    //首页portal
    me.portals = [];
	
	//当前模块 add by quan
	me.currentModule = {};
	
	//当前模块参数 add by quan
	me.currentModule.params = utils.getUrlParams();

    me.renderToDom(doc);
    me.loadPlugins();
    //初始化事件
    me.fireEvent('init');
    me.initEvent();
    /*渲染，与ready可能存在异步调用*/
    me.fireEvent('render');
    /*初始化完成*/
    me.fireEvent('ready');
    /*刷新机制*/
    me.fireEvent('hashchange');
};

FrameWork.prototype = {
    //文件上传消息
    uploadResponse: function (json, key) {
        var me = this;
        if (key) json.key = key;
        //触发上传事件
        me.fireEvent('upload', json);
    },

    width: function () {
        if (this.document) return this.document.documentElement.clientWidth;
        else return 0;
    },

    height: function () {
        if (this.document) return this.document.documentElement.clientHeight;
        else return 0;
    },

    renderToDom: function (doc) {

        var me = this;
        me.document = doc;
        me.window = doc.defaultView || window;
        me.body = doc.body;
        me.document.title = me.options.title;
    },

    initEvent: function () {
        var me = this;
        /*事件委托*/
        me.eventProxy = utils.bind(me.eventProxy, me);
        /*注册手势事件*/
        //utils.on(me.body, ['touchstart', 'touchend', 'touchmove', 'mouseup', 'mousedown', 'mouseup'], me.eventProxy);
        utils.on(me.window, ['resize','hashchange'], me.eventProxy);
    },

    /* 为编辑器设置默认参数值。*/
    setOpt: function (config) {
        utils.extend(this.options, config, true);
    },

    /*加载插件*/
    loadPlugins: function () {
        var me = this;
        for (var pi in IWF.plugins) {
            IWF.plugins[pi].call(me);
        };
    },

    /*执行命令*/
    execCommand: function (cmdName) {
        var key = cmdName.toLowerCase();
        var me = this, result, cmd = me.commands[key];
		if(!cmd) cmd = me.commands[cmdName];

        if (!cmd || !cmd.execCommand) {
            return null;
        }
        me.fireEvent('beforeexeccommand', key);
        arguments[0] = key;
        result = cmd.execCommand.apply(this, arguments);
        me.fireEvent('afterexeccommand', key);
        return result;
    },

    /*查询命令返回值*/
    queryCommandValue: function (cmdName) {
        var key = cmdName.toLowerCase();
        var me = this, cmd = me.commands[key];

        if (cmd && cmd.queryCommandValue) {
            arguments[0] = key;
            return cmd.queryCommandValue.apply(this, arguments);
        }
        else return null;
    },

    /*事件委托*/
    eventProxy: function (e) {
        this.fireEvent(e.type.replace(/^on/, ''), e);
    },

	/*检查权限*/
	hasPerm: function(perm){
		var me = this;
		var arr = (perm + "").split(",");
		var arUserPerm = (me.loginUser.Perms + "").split(",");
		var flag = false;
		for (var j = 0; j < arr.length; j++)
		{
			for (var i = 0; i < arUserPerm.length; i++)
			{
				if (arUserPerm[i].toLowerCase().trim() == "sysadm" || arUserPerm[i].toLowerCase().trim() == arr[j].toLowerCase())
				{
					flag = true;
					break;
				}
			}
		}
		return flag;
	},

    /*检查版本权限*/
	hasLicensePerm: function (perm) {
	    var me = this;
	    for (var i = 0; i < me.loginUser.LicensePerm.length; i++) {
	        if (perm == me.loginUser.LicensePerm[i]) {
	            return true;
	        }
	    }
	    return false;
	},

    /*后台版本*/
    getBackstage: function(){
        var me = this;
        return me.options.userInfo.Backstage;
    }
};
utils.extend(FrameWork.prototype, EventBase);

﻿
(function ($) {

    $('[data-toggle="popover"]').popover();

    $.fn.popSelector = function (options) {
        var me = $(this);

        var tpl = {
            item: '<a style="margin-bottom:10px;" item-id="{id}" class="col-sm-4" href="javascript:void(0)">{text}</a>'
        }

        function itemClick(sender) {
            var tag = $(sender.target);
            tag.toggleClass(opts.selcls);
            var allSelect = tag.siblings('a.' + opts.selcls);
            var v = { isSelect: tag.hasClass(opts.selcls), id: tag.attr('item-id'), text: tag.text(), items: [] };
            for (var i = 0, sel; sel = allSelect[i++]; ) {
                selUI = $(sel);
                v.items.push({ id: selUI.attr('item-id'), text: selUI.text() });
            }
            opts.callback(me, v);
        }

        function getContent() {

            var content = $('<div></div>');
            for (var i = 0, item; item = options.data[i++]; ) {
                var temp = $(utils.replaceTpl(tpl.item, item)).appendTo(content).bind('click', item, itemClick);
                if (utils.indexOf(opts.selectKeys, item.id) > -1) temp.addClass(opts.selcls);
            }
            return content;
        }

        var def = {
            data: [],
            selectKeys: [],
            html: true,
            selcls: 'text-selected',
            title: function () {
                var t = $('<div>请选择<a style="float:right;" href="javascript:void(0)"><i class=" icon-remove"></i></a></div>');
                t.children('a').bind('click', function () {
                    me.popover('hide');
                });
                return t;
            },
            trigger: 'click',
            placement: 'left',
            callback: function () { },
            content: getContent
        }
        var opts = $.extend(def, options);
        me.popover(opts);
    }

    $.fn.popoverButton = function (options) {
        var me = $(this);
        var def = {
            html: true,
            title: '你确定执行此操作吗？',
            text: '确定',
            trigger: 'click',
            placement: 'bottom',
            callback: function () { },
            content: function () {
                var bt = $('<button name="ok" class="btn btn-primary">[ ' + opts.text + ' ]</button> <button name="cancel" class="btn btn-default">[ 取消 ]</button>')
                    .bind('click', function (sender) {
                        if (this.name == 'ok') {
                            opts.callback(opts.data || me);
                        }
                        me.popover('hide');
                    });
                return bt;
            }
        }
        var opts = $.extend(def, options);
        me.popover(opts);
    }

    $.fn.listNav = function (options) {

        var tpl = {
            root: '<ul class="nav nav-pills nav-stacked ilist-group"></ul>',
            group: '<li class="igroup ibarbg2"><i class="icon-blue"></i>{title}</li>',
            item: '<li class="iitem"><a href="javascript:void(0);"><i class="{icon} {color}"></i>{title}<span class="list-nva-op">操作</span></a></li>',
            badge: '<span class="badge listbar-badge" style="float:right;">{text}</span>',
            icon: '<span class="listbar-badge" style="float:right;margin-left:5px;">{text}</span>'
        };

        var me;
        if (this.nodeName == 'UL' || this[0].nodeName == 'UL') {
            me = $(this);
            me.addClass('ilist-group');
        } else {
            $(this).empty();
            me = $(tpl.root).appendTo(this);
        }

        var opts = $.extend({
            selectIndex: -1,
            data: [],
            showBadge: true,
            showOption: true,
            showTip: true,
            iconOpen: 'icon-minus',
            iconClose: 'icon-plus',
            onItemClick: undefined,
            onTagClick: undefined,
            onGroupTagClick: undefined
        }, options);

        function showHideOption(p, data) {
            var sp = p.find('span.list-nva-op');
            if (sp.is(':hidden')) {
                if (data.tag.tip) sp.text(data.tag.tip);
                sp.show('fast');
                p.siblings().find('span.list-nva-op').hide('fast');
            }
            else sp.hide('fast');

        }

        function getData(index) {
            var i = 0;
            for (var j = 0, item; item = opts.data[j++]; ) {
                i++;
                if (index == i) return item;
                if (item.items) {
                    for (var k = 0, citem; citem = item.items[k++]; ) {
                        i++;
                        if (index == i) return citem;
                    }
                }

            }
        }

        function findItemData(target) {
            var id = target.closest('li').attr('item-id');
            if (id && id != opts.selectIndex) {
                opts.selectIndex = id;
                render();
            }
            return (id) ? getData(id) : null;
        }

        function findTagData(target) {
            var tagid = target.closest('span').attr('tag-id');
            if (tagid) {
                var pid = target.closest('li').attr('item-id');
                var pdata = getData(pid);
                var data = { item: pdata, tag: pdata.tags[tagid] }
                if (opts.showOption && !data.tag.hideTip) showHideOption(target.closest('li'), data);
                return data;
            } else {
                return null;
            }
        }

        function findGroupData(target) {
            var group = $(target).closest('li.igroup');
            if (group.length == 0) return null;

            var tagid = $(target).closest('span').attr('tag-id');
            if (tagid) {
                var pid = group.attr('item-id');
                var pdata = getData(pid);
                var data = { item: pdata, tag: pdata.tags[tagid] }
                return data;
            }

            if (group.length > 0) {
                var pid = group.attr('item-id');
                var pdata = getData(pid);

                group.children('i').toggleClass(opts.iconClose).toggleClass(opts.iconOpen);
                if (group.children('i').is('.' + opts.iconClose)) {
                    group.siblings('li[group-id="' + pid + '"]').hide();
                    pdata.close = true;
                } else {
                    group.siblings('li[group-id="' + pid + '"]').show();
                    pdata.close = false;
                }
                return pdata;
            } else {
                return null;
            }
        }

        function addItem(item, root, id, pid) {
            var itemUI = $(utils.replaceTpl(tpl.item, item)).appendTo(root);
            itemUI.attr('item-id', id);
            if (pid > 0) itemUI.attr('group-id', pid);
            if (opts.selectIndex == id) itemUI.addClass('active');

            if (item.tags) {
                var aUI = itemUI.find('a');
                var tempTpl = (opts.showBadge) ? tpl.badge : tpl.icon;

                $.each(item.tags, function (tid, tag) {
                    var obj = (tag.text) ? tag : { text: tag };
                    var tagUI = $(utils.replaceTpl(tempTpl, obj)).appendTo(aUI);
                    tagUI.attr('tag-id', tid);
                    if (opts.showTip) tagUI.show();
                });
            }
        }


        function render() {
            me.empty();
            var index = 0;
            $.each(opts.data, function (pid, item) {
                index++;
                if (item.items) {
                    var gui = $(utils.replaceTpl(tpl.group, item)).appendTo(me);
                    gui.attr('item-id', index);
                    gui.children('i').addClass(opts.iconOpen);
                    if (item.tags) {
                        $.each(item.tags, function (tid, tag) {
                            var obj = (tag.text) ? tag : { text: tag };
                            var tagUI = $(utils.replaceTpl(tpl.icon, obj)).appendTo(gui);
                            tagUI.attr('tag-id', tid);
                            tagUI.show();
                        });
                    }

                    var gid = index;
                    $.each(item.items, function (cid, cItem) {
                        index++;
                        addItem(cItem, me, index, gid);
                    });
                    //折叠
                    if (item.close) findGroupData(gui.children('i')[0]);
                } else {
                    addItem(item, me, index, 0);
                }
            });
        }

        var tagData;
        function clickHandler(event) {
            var groupData = findGroupData(event.target);
            if (groupData) {
                if (groupData.tag && typeof (opts.onGroupTagClick) === 'function') {
                    me.trigger('groupTagClick', [groupData, event.target]);
                }
            } else if (event.target.className == 'list-nva-op') {
                if (tagData && typeof (opts.onTagClick) === 'function') {
                    me.trigger('tagClick', [tagData, event.target]);
                }
            } else {
                var target = $(event.target);
                tagData = findTagData(target);
                if (tagData) {
                    //直接单击事件
                    if (tagData.tag.hideTip) me.trigger('tagClick', [tagData, event.target]);
                } else {
                    var itemData = findItemData(target);
                    if (itemData) me.trigger('itemClick', [itemData, event.target]);
                }
            }
        }

        me.off('click');
        me.off('itemClick');
        me.off('tagClick');
        me.off('groupTagClick');

        if (typeof (opts.onItemClick) === 'function') {
            me.on('itemClick', opts.onItemClick);
        }

        if (typeof (opts.onTagClick) === 'function') {
            me.on('tagClick', opts.onTagClick);
        }

        if (typeof (opts.onGroupTagClick) === 'function') {
            me.on('groupTagClick', opts.onGroupTagClick);
        }

        me.on('click', $.proxy(clickHandler, this));
        render();
    };
	
	var leftNavTimeout = {};
	$.fn.listNav2 = function (tab,leftnav,navconfig) {
	    $(leftnav).remove();
	    return;
		if(!navconfig.data) return;
		if(navconfig.data.length == 0) return;

		var me = $(this);

		tab.t.off("mouseenter").mouseenter(function(){
			$(this).addClass('active');
		    leftnav.show();
		});

		tab.t.off("mouseleave").mouseleave(function(){
			$(this).removeClass('active');
			leftNavTimeout[leftnav] = setTimeout(function(){ leftnav.hide(); },100);
		});

		leftnav.off("mouseenter").mouseenter(function(){
			tab.t.addClass('active');
			clearTimeout(leftNavTimeout[leftnav]);
		    leftnav.show();
		});

		leftnav.off("mouseleave").mouseleave(function(){
			tab.t.removeClass('active');
			leftnav.hide();
		});
		
		return;
		leftnav.find("ul").children().remove();
		for(var i = 0;i < navconfig.data.length;i++){
			if(navconfig.data[i].items){
				leftnav.find("ul").append("<li class='group'>{0}</li>".format(navconfig.data[i].title));
				var tmp = navconfig.data[i].items;
				for(var j = 0;j < tmp.length;j++){

					//if(tmp[j].perm && !me.hasPerm("SysAdm,SiteAdm")) continue;

					var li = $('<li style="padding-left:20px" a="{0}" b="{1}"><a href="javascript:void(0)"><i class="{2} {3}"></i><span>{4}</span></a></li>'.format(tmp[j].a,tmp[j].b,tmp[j].icon,tmp[j].color,tmp[j].title));
					li.unbind("click").bind("click",function(){ var data = {a: $(this).attr("a"),b: $(this).attr("b")};  navconfig.onItemClick(null,data); });
					leftnav.find("ul").append(li);
				}
			}else{
				//if(tmp[j].perm && !me.hasPerm("SysAdm,SiteAdm")) continue;

				var li = $('<li style="padding-left:20px" a="{0}" b="{1}"><a href="javascript:void(0)"><i class="{2} {3}"></i><span>{4}</span></a></li>'.format(navconfig.data[i].a,navconfig.data[i].b,navconfig.data[i].icon,navconfig.data[i].color,navconfig.data[i].title));
				li.unbind("click").bind("click",function(){ var data = {a: $(this).attr("a"),b: $(this).attr("b")};  navconfig.onItemClick(null,data); });
				leftnav.find("ul").append(li);
			}
		}
	}

    //表单设计器
    $.fn.iwfFormDesign = function (options) {

        var defaults = {
            plugins: {},
            commands: {},
            allListeners: {},
            /*添加监听*/
            addListener: function (types, listener) {
                types = utils.trim(types).split(' ');
                for (var i = 0, ti; ti = types[i++]; ) {
                    if (!me.allListeners[ti]) me.allListeners[ti] = [];
                    me.allListeners[ti].push(listener);
                }
            },
            /*触发事件*/
            fireEvent: function () {
                var types = arguments[0];
                types = utils.trim(types).split(' ');
                for (var i = 0, ti; ti = types[i++]; ) {
                    var listeners = me.allListeners[ti];
                    if (listeners) {
                        for (var j = 0, l; l = listeners[j++]; ) {
                            l.apply(me, arguments);
                        }
                    }
                }
            },
            /*执行命令*/
            execCommand: function (cmdName) {
                var key = cmdName.toLowerCase();
                var result, cmd = me.commands[key];
                if (!cmd) return null;

                me.fireEvent('beforeexeccommand', key);
                arguments[0] = key;
                result = cmd.apply(me, arguments);
                me.fireEvent('afterexeccommand', key);
                return result;
            },
            tools: [],
            code: {}
        };

        var me = $.extend(defaults, options);
        me.rootPanel = $('<div style="overflow:hidden"></div>').appendTo(this);
        me.toolPanel = $('<div style="position: fixed;z-index:99;"></div>').appendTo(me.rootPanel);
        me.statePanel = $('<div class="btn-group" style="background-color:#FFF;"></div>').appendTo(me.toolPanel);
        me.viewPanel = $('<div style="margin-top:35px;"></div>').appendTo(me.rootPanel);
        me.designPanel = $('<div style="height:100%;"></div>').appendTo(me.viewPanel);

        me.frame = $('<iframe style="min-height:600px;" width="100%" height="100%" src="javascript:void(function(){document.open();'
            + 'document.write(\'<!DOCTYPE html><html><head><link href=ref/bootstrap/css/bootstrap.css rel=stylesheet type=text/css>'
            + '<style type=text/css>body{margin:0px;min-height:600px;font-family:微软雅黑;font-size:14px;}'
            + '.mytable{border-collapse: collapse;}'
            + '.mytable thead{background: -webkit-gradient(linear, left top, left bottom, from(#FCFCFE), to(#ECF1F7));background: -ms-linear-gradient(top, #FCFCFE,#ECF1F7);}'
            + '.mytable td{border: 1px solid #AFC5DE;	line-height: 30px;}'
            + '.mytable tbody td{background-color:#FFF;}'
            + '</style>'
            + '</head><body>&nbsp;</body></html>\');document.close();}())" frameborder="0"></iframe>').appendTo(me.designPanel);

        me.codePanel = $('<div style="height:100%;min-height:600px;"></div>').appendTo(me.viewPanel).hide();
        me.codeView = $('<textarea style="width:100%;height:100%;" border="0"></textarea>').appendTo(me.codePanel);

        function activateEvent(e) {
            if (e.button == 2) return;
            if (e.type == 'keydown' && (e.ctrlKey || e.metaKey || e.shiftKey || e.altKey)) return;
            if (e.keyCode == 46) {
                me.execCommand('remove');
                return;
            }
            me.fireEvent('oncursor');
        }

        me.frame.bind('load', function () {
            me.document = me.frame[0].contentWindow.document;
            me.body = me.document.body;
            me.body.contentEditable = true;

            me.getSelection = function () {
                if (!me._tempSelection) me._tempSelection = me.document.getSelection();
                return me._tempSelection;
            };

            me.getRange = function () {
                return me.getSelection().getRangeAt(0);
            };

            me.frame.bind('activate', function () { me.fireEvent('activate'); });
            utils.on(me.document, ['mouseup', 'keydown'], activateEvent);

            for (var pi in me.plugins) {
                me.plugins[pi].call(me);
            };

            var tool = $('<div class="btn-group" style="margin:-3px 10px 0 3px"></div>').prependTo(me.toolPanel);
            var toolData = utils.sort(me.tools);
            for (var i = 0, titem; titem = toolData[i++]; ) {
                var temp = $('<button type="button" class="btn btn-default" title="' + titem.title + '"></button>').appendTo(tool);
                if (titem.ispop) {
                    temp.popoverButton({ callback: titem.click, data: titem });
                } else if (titem.click) temp.bind('click', titem, titem.click);

                if (titem.icon) $('<i class="' + titem.icon + '"></i>').appendTo(temp);
                else if (titem.text) temp.append(titem.text);
            }
            //me.toolbar = me.toolPanel.iwfToolBar({ data: utils.sort(me.tools) });
            me.fireEvent('ready');
        });

        me.plugins['tables'] = function () {
            function addTable() {
                //var t = '<table class="mytable" style="width: 98%;" cellspacing="1"><thead><tr><td colspan="4">标题测试</td></tr></thead><tbody><tr><td></td><td></td><td></td><td></td></tr></tbody></table>';
                var t = '<div class="panel panel-default">'
                    + '<div class="panel-heading">列表面板</div>'
                    + '<div class="panel-body">'
                    + '<div class="form-group col-sm-6">'
                    + '<label class="col-sm-2">用户名</label>'
                    + '<div class="col-sm-10"><input class="form-control" placeholder="Username"></div>'
                    + '</div>'
                    + '<div class="form-group col-sm-6">'
                    + '<label class="col-sm-2">密码</label>'
                    + '<div class="col-sm-10"><input class="form-control" placeholder="Password"></div>'
                    + '</div>'
                    + '<div class="form-group col-sm-6">'
                    + '<label class="col-sm-2">用户名</label>'
                    + '<div class="col-sm-10"><input class="form-control" placeholder="Username"></div>'
                    + '</div>'
                    + '<div class="form-group col-sm-6">'
                    + '<label class="col-sm-2">密码</label>'
                    + '<div class="col-sm-10"><input class="form-control" placeholder="Password"></div>'
                    + '</div>'

                    + '</div>'
                    + '<table class="table table-striped table-hover">'
                    + '<thead><tr><td>#</td><td>列一</td><td>列二</td><td>列三</td><td>列四</td></tr></thead>'
                    + '<tbody>'
                    + '<tr><td>1</td><td>值一</td><td>值二</td><td>值三</td><td>值四</td></tr>'
                    + '<tr><td>2</td><td>值一</td><td>值二</td><td>值三</td><td>值四</td></tr>'
                    + '</tbody>'
                    + '</table>'
                    + '</div>';

                me.execCommand('insert', t);
            }
            //me.tools.push({ type: 'split', index: 51 });
            me.tools.push({ title: '添加表格', icon: 'icon-table', click: addTable, index: 52 });
            //me.tools.push({ title: '删除表格', icon: '5,2', index: 53 });
            //me.tools.push({ title: '插入行', icon: '2,11', index: 54 });
            //me.tools.push({ title: '删除行', icon: '2,11', index: 55 });
            //me.tools.push({ title: '右合并单元格', icon: '2,11', index: 56 });
            //me.tools.push({ title: '追加列', icon: '2,11', index: 57 });
            //me.tools.push({ title: '删除列', icon: '2,11', index: 58 });
        };

        me.html = function (v) {
            if (v) me.execCommand("load", v);
            else return me.execCommand("getcode");
        }

        /*常用命令*/
        me.plugins['commoncommands'] = function () {

            function getContextualFragment(r, args) {
                if (r.createContextualFragment) return r.createContextualFragment(args);
                else {
                    var frag = me.document.createDocumentFragment(),
                        div = me.document.createElement("div");
                    frag.appendChild(div);
                    div.outerHTML = args;
                    return frag;
                }
            }

            /*resize*/
            me.commands['resize'] = function (key, args) {
                var h = me.body.offsetHeight;
                if (h > 0) me.viewPanel.height(h + 100);
                else me.viewPanel.height(600);

            };

            /*内置插入命令*/
            me.commands['insert'] = function (key, args) {
                var range = me.getRange();
                var fragment = getContextualFragment(range, args);
                //var fragment =  range.createContextualFragment(args);
                range.insertNode(fragment);
            };

            me.commands['append'] = function (key, args) {
                if (me.selectNode) $(me.selectNode).append(args);
            };

            me.commands['remove'] = function (key, args) {
                me.getRange().deleteContents();
            };

            /*向上移动选中单元*/
            me.commands['moveup'] = function (key, arg) {
                var sel = me.getSelection();
                var range = me.getRange();
                var index = range.startOffset - 1;
                if (index >= 0) {
                    var node = range.extractContents();
                    range.setStart(range.startContainer, index);
                    range.setEnd(range.startContainer, index);
                    range.insertNode(node);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            };

            /*向下移动选中单元*/
            me.commands['movedown'] = function (key, arg) {
                var sel = me.getSelection();
                var range = me.getRange();
                if (range.endOffset < range.endContainer.childElementCount) {
                    var index = range.startOffset + 1;
                    var node = range.extractContents();
                    range.setStart(range.startContainer, index);
                    range.setEnd(range.startContainer, index);
                    range.insertNode(node);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            };

            me.commands['clear'] = function () {
                var range = me.getRange();
                var text = utils.trim2(range.toString());
                var fragment = range.createContextualFragment(text);
                range.deleteContents();
                range.insertNode(fragment);
            };

            me.commands['link'] = function (key, arg) {
                var range = me.getRange();
                var text = utils.trim2(range.toString());
                if (text) {
                    text = '<a href="' + arg + '">' + text + '</a>';
                    var fragment = range.createContextualFragment(text);
                    range.deleteContents();
                    range.insertNode(fragment);
                }
            };

            me.commands['format'] = function (key, arg) {
                var range = me.getRange();
                var txt = range.toString();
                if (txt && arg) {
                    var temp = me.document.createElement(arg);
                    temp.innerText = txt;
                    range.deleteContents()
                    range.insertNode(temp);
                    range.selectNode(temp);
                }
            }

            me.commands['selectnode'] = function (key, node) {
                var sel = me.getSelection();
                var range = sel.getRangeAt(0);
                range.selectNode(node);

                sel.removeAllRanges();
                sel.addRange(range);

                if (node != me.selectNode) {
                    me.selectNode = node;
                    me.execCommand('statebar');
                    me.fireEvent('selectchange');
                }
            };

            function setCodeToView() {
                $(me.body).html(utils.trim3(me.code.html));
                me.codeView.val(me.code.html + '\n' + getJSCode());
            }

            function getJSCode() {
                if (!me.hideJS) {
                    var js = '<script>\nfunction ' + (me.formKey || 'formRoot') + "(me){\n";
                    if (me.code.myjs) js += '\n' + me.code.myjs + '\n\n';
                    js += me.execCommand('getautojs');
                    js += '\n};\n</script>';
                    return js;
                } else {
                    return "";
                }
            }

            me.commands['load'] = function (key, args) {
                me.code = {};
                var reg = /([\s\S]+)<script>([\s\S]+)<\/script>/i;
                var jsReg = /{([\s\S]+)(me\.vm [\s\S]+)}/i;
                if (temp = args.match(reg)) {
                    me.code.html = utils.trim(temp[1]);
                    if (jsTemp = temp[2].match(jsReg)) {
                        me.code.myjs = utils.trim(jsTemp[1]);
                        me.code.autojs = utils.trim(jsTemp[2]);
                    }
                } else {
                    me.code.html = utils.trim(args);
                }

                setCodeToView();
                //改变窗体大小
                me.execCommand('resize');
                me.fireEvent('befterload');
            };

            /*内置视图切换命令*/
            me.commands['view'] = function (key, arg) {
                me.fireEvent('befterviewchange', me.body, me.codeView);
                if (!arg) {
                    me.execCommand('load', me.codeView.val());
                    me.designPanel.show();
                    me.codePanel.hide();
                    //改变窗体大小
                    me.execCommand('resize');
                    me.fireEvent('viewchange', me.body, me.codeView);
                } else {
                    me.code.html = utils.getDomHtml(me.body);
                    setCodeToView();
                    me.codePanel.show();
                    me.designPanel.hide();
                    me.fireEvent('viewchange', me.body, me.codeView);
                }
            };

            /*取得表单源码*/
            me.commands['getcode'] = function () {
                if (me.frame.is(":hidden")) return me.codeView.val();
                else {
                    me.code.html = utils.getDomHtml(me.body);
                    return me.code.html + '\n' + getJSCode();
                }
            };

            me.addListener('oncursor', function () {
                var sel = me.getSelection();
                if (!sel.focusNode) return;

                var tnode = (sel.focusNode.childNodes.length == 0) ? sel.focusNode :
                    sel.focusNode.childNodes[sel.focusOffset - 1];
                if (tnode != me.selectNode) {
                    me.selectNode = tnode;
                    me.execCommand('statebar');
                    me.fireEvent('selectchange');
                }
            });
        };

        me.plugins['statebar'] = function () {
            var nodeList = [];

            function onStatebarClick(e, d, target) {
                if (d) me.execCommand('selectnode', d.tag);
            };

            function setNodeList(node) {
                var name = node.nodeName.toLowerCase();
                if (name != 'body') {
                    nodeList.push({ text: name, tag: node, type: 'link' });
                    setNodeList(node.parentNode);
                } else {
                    nodeList.push({ text: '元素路径:', type: 'text' });
                }
            }

            me.commands['statebar'] = function () {
                nodeList.splice(0, nodeList.length);
                if (me.selectNode) {
                    setNodeList(me.selectNode);
                }
                me.statePanel.iwfLinkBar({ data: nodeList.reverse(), onItemClick: onStatebarClick });
                //me.statePanel.iwfToolBar({ data: nodeList.reverse() });
            };
        };

        me.plugins['defaultplugins'] = function () {

            var tpls = {
                input: '<input type="text" class="form-control" />',
                button: '<input type="button" value="确定" />',
                checkbox: '<input type="checkbox" />',
                radio: '<input type="radio"/>',
                select: '  <select name="select" class="form-control"></select>',
                textarea: '<textarea class="form-control"  style="height:80px;"></textarea>'
            };

            function insertControl(sender) {
                var t = tpls[sender.data.key];
                if (!t) t = tpls.input;
                me.execCommand('insert', t);
            }

            function formatClick() {
                me.execCommand('format', this.key);
            }

            function insertLink() {
                var url = prompt("输入链接地址:", "javascript:void(0);");
                if (url) me.execCommand('link', url);
            }

            function changeView(sender) {
                sender.data.select = !sender.data.select;
                me.execCommand('view', sender.data.select);
            }

            function clearHTML() {
                me.execCommand('clear');
            };


            me.tools.push({ title: '视图切换', icon: 'icon-qrcode', select: false, click: changeView, index: 11 });
            me.tools.push({ title: '删除选择', icon: 'icon-trash', click: function () { me.execCommand('remove'); }, index: 12 });
            me.tools.push({ title: '加粗', key: 'strong', icon: 'icon-bold', lick: formatClick, index: 23 });
            me.tools.push({ title: '下划线', key: 'u', icon: 'icon-underline', click: formatClick, index: 24 });
            me.tools.push({ title: '链接', icon: 'icon-link', click: insertLink, index: 25 });
            me.tools.push({ title: '格式清除', icon: 'icon-edit', click: clearHTML, index: 26 });
            me.tools.push({ title: '单行文本框', key: 'input', text: '单行', click: insertControl, index: 32 });
            me.tools.push({ title: '多行文本框', key: 'textarea', text: '多行', click: insertControl, index: 33 });
            me.tools.push({ title: '多选框', key: 'checkbox', text: '多选', click: insertControl, index: 34 });
            me.tools.push({ title: '单选框', key: 'radio', text: '单选', click: insertControl, index: 35 });
            me.tools.push({ title: '下拉框', key: 'select', text: '下拉', click: insertControl, index: 36 });
            me.tools.push({ title: '按钮', key: 'button', text: '按钮', click: insertControl, index: 37 });
        };
        return me;
    };

    $.fn.iwfLinkBar = function (options) {

        var opts = $.extend({
            data: [],
            onItemClick: undefined
        }, options);

        var me = $(this);
        var tpl = {
            link: '<a href="javascript:void(0);" link-id="{index}">{text}</a>'
            , icon: '<i class="icon-angle-right" style="margin:0 5px 0 5px"></i>'
        };

        me.empty();

        me.off('click');

        if (typeof (opts.onItemClick) === 'function') {
            me.on('itemClick', opts.onItemClick);
        }

        function clickHandler(e) {
            var id = $(e.target).attr('link-id');
            var d = opts.data[id];
            me.trigger('itemClick', [d, event.target]);
        }

        me.on('click', $.proxy(clickHandler, this));

        $.each(opts.data, function (i, item) {
            if (i > 1) me.append(tpl.icon);
            item.index = i;
            me.append((item.type == 'link') ? utils.replaceTpl(tpl.link, item) : item.text);
        });
    };

    //分页控件 泉
    $.fn.pageNav = function (currentpage, pagecount, shownum, callback, css) {

        var pghtml = '<nav style="height:40px"><ul class="pagination '+(css?css:'')+'" style="margin:10px 0"><li><a href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>';

        var sp = Math.floor(currentpage / shownum); //得到页表分页点
        var startpage = 0;
        var stoppage = 0;
        if (sp == 0 && currentpage < shownum) {
            startpage = 1;
        }
        else if (currentpage % shownum == 0 && currentpage >= shownum) {
            startpage = currentpage - (shownum - 1);
        }
        else {
            startpage = sp * shownum + 1;
        }

		//保证当前页在中间，避免需要点击上一页和下一页来切换页码组
        startpage = currentpage - Math.floor(shownum / 2);
		if(startpage < 1) startpage = 1;

        stoppage = startpage + (shownum - 1);
        if (stoppage > pagecount){
            stoppage = pagecount;
        }

        for (var i = startpage; i <= stoppage; i++){
            if (i == currentpage) pghtml += '<li class="active"><a href="#" aria-label="' + i + '">' + i + '</a></li>';
            else pghtml += '<li><a href="#" aria-label="' + i + '">' + i + '</a></li>';
        }

        pghtml += '<li><a href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li></ul></nav>';
        $(this).html(pghtml);

        if (currentpage <= 1) $(this).find("a[aria-label=Previous]").parent().addClass("disabled");
        else $(this).find("a[aria-label=Previous]").parent().removeClass("disabled");

        if (currentpage >= pagecount) $(this).find("a[aria-label=Next]").parent().addClass("disabled");
        else $(this).find("a[aria-label=Next]").parent().removeClass("disabled");

        $(this).find("a").bind("click", function () {
            var page = $(this).attr("aria-label");
            var css = $(this).parent().attr("class");
            if (css && css.indexOf("disabled") > -1) { return false; }
            if (page) {
                if (page == "Previous") page = parseInt(currentpage) - 1;
                if (page == "Next") page = parseInt(currentpage) + 1;
                if (page <= 0) page = 1;
                if (page >= pagecount) page = pagecount;
                callback.call(this, page);
            }
            return false;
        });
    };

    // 页面的简单导航，用来代替锚点
    $.fn.extend({
        "simpleAnchorNav": function (options) {
            return this.each(function () {
                $(this).addClass('simpleAnchorNav').find("a").off('click.simpleScrollNav').on('click.simpleScrollNav', function (evt) {
                    $("html,body").animate({ scrollTop: $($(this).attr('href')).offset().top - 50 }, 1000);
                    return false;
                });
            });
        }
    });
	
	getElementTopWithBorder = function(obj) {
        var i = obj.offsetTop + parseFloat($(obj).css('border-top-width'));
        if (obj.offsetParent != null) i += getElementTopWithBorder(obj.offsetParent);
        return i;
    }
	
     $.fn.extend({
        "floatSaveBtn": function (options) {
            return this.each(function () {
                var self = this;
                options = options || {};
                var sHtml = '<div class="floatSaveBtnPanel floatSaveBox" >';
				sHtml += '<div class="floatSavebg">';
                sHtml += '<div class="floatSaveCont">';
                sHtml += '<input class="btn btn-success floatSaveBtn" type="button" value="保 存">';
                sHtml += '</div>';
				sHtml += '</div>';
                sHtml += '</div>';

                $(self).hide();
             
                var elem = $(sHtml);
                if (options.appendTo) {
                    elem.appendTo(options.appendTo);
                } else {
                    elem.insertAfter(self);
                }
                elem.find('.floatSaveBtn').off().on('click', function () {
                    $(self).click();
                });

                $(this).data('widget', elem);

                window.floatSaveBtnPanelTimeout = setInterval(function () {
                    if ($('.floatSaveBtn').length > 0) {
                        var bottom = getElementTopWithBorder($('#maincontent')[0]) + $('#maincontent').height();
                        if (bottom + $('.floatSaveBtnPanel').outerHeight() < $(window).height()) {
                            $('.floatSaveBtnPanel').css({ 'top': bottom });
							
                        } else {
                            $('.floatSaveBtnPanel').css({ 'top': $(window).height() - $('.floatSaveBtnPanel').outerHeight()});
							   $('#maincontent').css({ 'margin-bottom': '40px' });
                        }
                    }
                }, 1);
            });
        }
    });

	//为了方便设计，html模板里的图片等统计放在模板目录的 skinsrc 目录下，在加载时替换一下
	$.fn.loadHtmlTpl = function(url,callback){
	    var self = this;
	    self.hide();
		$.get(url,function(data,status){
			var path = url.substring(0,url.lastIndexOf("/"));
			data = data.replace(/skinsrc/g, path + "/skinsrc");
			self.html(data).fadeIn();
			callback.call();
		});
	};

	$.fn.serializeObject = function()  
	{
	   var o = {};
	   var a = this.serializeArray();
	   $.each(a, function() {
		   if (o[this.name]) {
			   if (!o[this.name].push) {
				   o[this.name] = [o[this.name]];
			   }
			   o[this.name].push(this.value || '');
		   } else {
			   o[this.name] = this.value || '';
		   }
	   });
	   return o;
	};

})(jQuery);

jQuery.extend({
    showResult: function (title, msg, autoClose) {
        if (arguments[0] === true || arguments[0] === false) {
            $.showResult3(arguments[0], arguments[1], arguments[2], arguments[3]);
            return;
        }
		$("#ResultDialog").remove();
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
		if(autoClose && autoClose > 0){
			setTimeout(function(){ $("#ResultDialog").remove(); },autoClose);
		}
	},
	showResult2: function (title, msg, autoClose) {
	    bootbox.hideAll();
	    bootbox.alert({
	        title: title,
	        message: msg
	    });
	    if (autoClose && autoClose > 0) {
	        setTimeout(function () { bootbox.hideAll() }, autoClose);
	    }
	},
	showResult3: function (isSuccess, msg, autoClose, closeCallback) {
	    $('.floatAlert').remove();
	    var html = '', alert;
	    if (isSuccess) {
	        html += '<span class="alert alert-success floatAlert" style="display:none">';
	        html += '<a href="javascript:;" class="close">&times;</a>';
	        html += '<strong>成功！</strong>' + msg;
	        html += '</span>';
	    } else {
	        html += '<span class="alert alert-warning floatAlert" style="display:none">';
	        html += '<a href="javascript:;" class="close">&times;</a>';
	        html += '<strong>错误！</strong><span class="spError">' + msg + '</span>';
	        html += '</span>';
	    };

	    alert = $(html).appendTo(me.content);
	    alert.css({ maxWidth: '800px' });
	    alert.css({
	        opacity: 1,
	        position: 'fixed',
	        top: (window.innerHeight - alert.outerHeight()) * 0.372 + 'px',
	        left: (window.innerWidth - alert.outerWidth()) / 2 + 'px',
	        zIndex: 99999,
	        width: 'auto',
	        height: 'auto'
	    });
	    alert.fadeIn(500);

	    alert.find('.close').off().on('click', function () {
	        $(this).closest('.floatAlert').remove();
	        if (typeof closeCallback == 'function') {
	            closeCallback();
	        }
	    });

	    if (autoClose && autoClose > 0) {
	        setTimeout(function () {
	            $('.floatAlert').find('.close').click();
	        }, autoClose);
	    }
	}
})

//数字格式
/*ko.bindingHandlers["number"] = {
    'init': function (element, valueAccessor, allBindingsAccessor, viewModel) {
        function onChanged() {
            var el = $(element);
            var v = parseFloat(el.val()) || 0;
            el.val(v);
            ko.expressionRewriting.writeValueToProperty(valueAccessor(), allBindingsAccessor, 'number', v);
        }
        ko.utils.registerEventHandler(element, "change", onChanged);
    },
    'update': function (element, valueAccessor, allBindingsAccessor, viewModel) {
        $(element).val(ko.utils.unwrapObservable(valueAccessor()));
        ko.utils.triggerEvent(element, 'change');
    }
};*/

﻿IWF.plugins['appedit'] = function () {

    var me = this;
	
	var myroot = null;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/apppackage/html/appedit.html",function() {

            $("#AppForm").validate({
                rules: {
                    tbName: "required",
                    tbIconImg: "required",
                    tbLoadingImg: "required",
                    tbUrl: "required"
                },
                messages: {
                    tbName: "名称不能为空",
                    tbIconImg: "APP图标不能为空",
                    tbLoadingImg: "APP启动界面不能为空",
                    tbUrl: "网址不能为空"
                },
                submitHandler: function (form) {
                    submitForm();
                    return false;
                },
                errorPlacement: function (error, element) {
                    if (element.is("#tbIconImg"))
                        error.appendTo('#errIconImg');
                    else if (element.is("#tbLoadingImg"))
                        error.appendTo('#errLoadingImg');
                    else
                        error.appendTo(element.parent());
                },
                ignore: []
            });
			
			bindUIEvent();
			myroot = root[0];
			if(me.DomainMobile) $("input[name=tbUrl]",myroot).val(me.DomainMobile);
			loadData();
		});
    }

	function bindUIEvent(){
		$("#BtnSelStartImg").unbind('click').bind("click",function(){
			openImageDialog1();
		});

		$("#BtnSelLoadingImg").unbind('click').bind("click",function(){
			openImageDialog2();
		});
	}

	function openImageDialog1() {
		top.YDM.FileManager('image', 1, function (aUrl) {
			if (aUrl.length > 0) {
				$('#tbIconImg').val(aUrl[0]);
				$('#previewImgIconImg').attr('src', aUrl[0]);
			}
		})
	}

	function openImageDialog2() {
		top.YDM.FileManager('image', 1, function (aUrl) {
			if (aUrl.length > 0) {
				$('#tbLoadingImg').val(aUrl[0]);
				$('#previewLoadingImg').attr('src', aUrl[0]);
			}
		})
	}
	
    function loadData() {
				
		if(me.currentModule.params && me.currentModule.params.id){
			var params = { sid: me.sid, id: me.currentModule.params.id };
			//$.getJSON("/admin/app/appmanage?act=getinfo", utils.params(params), function (json) {
			$.getJSON("/index.php?c=admin/app/Appmanage&a=getinfo", utils.params(params), function (json) {
				ko.applyBindings(json.info,myroot);
			});
		}
    }

    function submitForm() {
		$.showResult("提示","正在生成APP，大约需要一分钟，请耐心等待...");

        var params = $('#AppForm').serialize();
		//$.post("/admin/app/appmanage?act=edit",params,function(data, textStatus, jqXHR){
        $.post("/index.php?c=admin/app/Appmanage&a=edit",params,function(data, textStatus, jqXHR){
			if(data.success){
			    $.showResult(true, "APP 已经成功生成", 2000, function () {
			        me.execCommand('go', { a: 'app', b: 'applist' });
			    });
			}else{
			    $.showResult(false, data.msg);
			}
		},"json");
    }

    me.addListener('appedit', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['applist'] = function () {

	var me = this;
	
	var ViewModel = function () {
        this.applist = ko.observableArray();
        this.setData = function (data) { this.applist(data); };
    };
	
	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
		root.html();
        root.loadHtmlTpl("plugins/apppackage/html/applist.html?rand=" + Math.random(),function() {			
			ko.applyBindings(vm,root[0]);
			loadApp(1);
		});
    }
	
	var curpage = 1;
	var itemcount = 0;
	function loadApp(page){
        //$.getJSON("/admin/app/appmanage", utils.params({act: 'getlist'}), function (json) {
		$.getJSON("/index.php?c=admin/app/Appmanage&a=getlist", utils.params(), function (json) {
            vm.setData(json.list);

			curpage = json.curpage;
			itemcount = json.list.length;

			if(itemcount <= 0){
				$("#divWhatsApp").show();
				$("#divAppList").hide();
			}
			else{
				$("#divWhatsApp").hide();
				$("#divAppList").show();
			}

            if (json.pagecount < 2) $("#apppage").hide();
            else {
                //pageNav 方法定义在 /core/ui.js 里
                $("#apppage").pageNav(json.curpage, json.pagecount, 10, function (page) { loadApp(page); });
                $("#apppage").show().css("display","block");
            }

            bindGridEvent();
        });
	}

	function bindGridEvent() {

		$("*[name=BtnDown]").unbind('click').bind('click', function (event) {
			var id = $(this).attr("AppID");
			var siteid = $(this).attr("SiteID");
			var url = "/comdata/"+ siteid +"/app_"+ id +".apk";
			window.open(url);
			return false;
        });

		$("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
			var id = $(this).attr("AppID");
			me.execCommand('go', { a: 'app', b: 'appedit', params: { id: id} });
			return false;
        });

		$("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			var id = $(this).attr("AppID");
			if(!confirm("确认删除？")) return;
			//$.getJSON("/admin/app/appmanage?act=delete", utils.params({id:id}), function (json) {	
			$.getJSON("/index.php?c=admin/app/Appmanage&a=delete", utils.params({id:id}), function (json) {	
				if(itemcount > 1) loadApp(curpage);
				else loadApp(1);
			});
			return false;
		});

		$(".QrCode").unbind('mouseover').bind('mouseover', function () {
		    //var img = $('<img class="QRCode" style="position:absolute;width:150px;height:150px;top:-60px;z-index:10;border:solid 10px #fff;" src="/admin/app/AppManage?act=getAppQrCode&appid=' + $(this).attr("AppID") + '"/>');
			var img = $('<img class="QRCode" style="position:absolute;width:150px;height:150px;top:-60px;z-index:10;border:solid 10px #fff;" src="/index.php?c=admin/app/Appmanage&a=getAppQrCode&appid=' + $(this).attr("AppID") + '"/>');
		    $(this).parent().append(img);
		}).mouseout(function () {
		    $(".QRCode").remove();
		});
	}
	
	me.addListener('applist', function (key, args) {
		initUI(args);
	});
}

﻿IWF.plugins['app'] = function () {
	
    var me = this;

    function flash(args, tab,isgo) {
		me.execCommand('show', { a: args.a });
        setChildWindow(args,isgo);
    }

    function setChildWindow(args,isgo) {
		if(isgo) me.execCommand('go', args);
		else me.fireEvent(args.b, me.content); //me.content 定义在 core/content.js 里
    }

    me.addListener('app', function (key, args) {
        var tab = me.execCommand('gettab', {});
        flash(args, tab);
    });
};

﻿IWF.plugins['agentmemberlist'] = function () {

    var me = this;

    utils.addScript("/share/global.js");

    var ViewModel = function () {
        this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
        this.getTime = function (time) {
            return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
        }
        this.getMoney = function (money) {
            return Math.abs(money);
        },
        this.compareTime = function (t1, t2) {
            return new Date(t1).getTime() - new Date(t2).getTime();
        }
    };

    var ViewModelUserList = function () {
        this.list = ko.observableArray();
        this.selectUserClick = function () {
            var id = $(this).attr('UserID');
            var nickname = $(this).attr('NickName');
            $('.addNewFormModal [name=userid]').attr('userid', id).val('(ID:' + id + ') ' + nickname).blur();
            $('.userSelectPanelModal').modal('hide');
        }
    }

    var vm = new ViewModel();

    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/agentmemberlist.html?v=" + Math.random(), function () {
            loadAgentList();
            handleSearchParams();
            bindUIEvent();
            ko.applyBindings(vm, $("#showListTable")[0]);
            loadList(1);
        });
    }

    var curpage = 1;
    var itemcount = 0;
    function loadList(page) {
        var params = {
            sid: me.sid,
            userkeyword: $("#userkeyword").val(),
            agentID: $("#slAgent").val(),
            provinceID: $('.districtSelector [name=province]').val(),
            cityID: $('.districtSelector [name=city]').val(),
            districtID: $('.districtSelector [name=district]').val(),
            startTime: $("#startTime").val(),
            endTime: $("#endTime").val(),
            page: page,
            pagesize: 20
        }

        $.getJSON("/admin/business/regionalagency?act=getagentmemberlist", utils.params(params), function (json) {
            if (json.success) {
                vm.setData(json.list);
                curpage = json.curpage;
                itemcount = json.list.length;
                if (json.pagecount < 2) $(".pagination_mainlist").hide();
                else {
                    //pageNav 方法定义在 /core/util.js 里
                    $(".pagination_mainlist").pageNav(json.curpage, json.pagecount, 10, function (page) { loadList(page); });
                    $(".pagination_mainlist").show();
                }
                $('.total_mainlist').html('共 ' + json.pagecount + ' 页， ' + json.rowcount + '条记录');
                bindGridEvent();
            } else {
                $.showResult(false, json.msg);
            }
        });
    }

    function bindUIEvent() {
        $('.districtSelector').addClass('clearfix, form-control').districtSeletor({ showCountry: 0 });

        $.validator.addMethod("provinceCheck", function (value, element) {
            if (this.optional(element)) {
                return true;
            }

            var slProvince = $("form").find('[name=province]');
            var province = parseInt(slProvince.val());
            if (isNaN(province) || (slProvince.css('display') != 'none' && province <= 0)) return false;
            return true;
        }, '请选择地区');

        $.validator.addMethod("cityCheck", function (value, element) {
            if (this.optional(element)) {
                return true;
            }

            var slCity = $("form").find('[name=city]');
            var city = parseInt(slCity.val());
            if (isNaN(city) || (slCity.css('display') != 'none' && city <= 0)) return false;
            return true;
        }, '请选择地区');

        $.validator.addMethod("districtCheck", function (value, element) {
            if (this.optional(element)) {
                return true;
            }

            var slDistrict = $("form").find('[name=district]');
            var district = parseInt(slDistrict.val());
            if (isNaN(district) || (slDistrict.css('display') != 'none' && district <= 0)) return false;
            return true;
        }, '请选择地区');

        $("#startTime").datepicker({
            format: "yyyy/mm/dd",
            defaultDate: "+1w",
            changeMonth: true,
            dateFormat: "yy/mm/dd",
            language: "zh-CN",
            orientation: "bottom auto",
            showOptions: { direction: "down" },
            onClose: function (selectedDate) {
                $("#TimeEnd").datepicker("option", "minDate", selectedDate);
            }
        });

        $("#endTime").datepicker({
            format: "yyyy/mm/dd",
            defaultDate: "+1w",
            changeMonth: true,
            dateFormat: "yy/mm/dd",
            language: "zh-CN",
            orientation: "bottom auto",
            showOptions: { direction: "down" },
            onClose: function (selectedDate) {
                $("#TimeBegin").datepicker("option", "maxDate", selectedDate);
            }
        });

        $("#btnSearch").unbind('click').bind('click', function (event) {
            loadList(1);
        });

        $('#selectAll').off().on('click', function () {
            $('#showListTable [name=UserID]:checkbox').not(this).prop('checked', $('#showListTable :checkbox:eq(0)').prop('checked'));
        });

        $('#btnAssign').off().on('click', function () {
            var slAgent = $('#slAgent option').not('[value=0],[value=-1]');
            //if(slAgent.length == 0){
            //    alert('请先设置好代理');
            //    return;
            //}
            var chks = $('#showListTable [name=UserID]:checked');
            if (chks.length == 0) {
                alert('请先选择会员');
                return;
            }
            var html = '<div><label>选择代理: </label><select class="form-control"></select></div>';
            var el = $(html).appendTo('body');
            el.find('select').append($('#slAgent option').not('[value=-1]').clone());

            var dialog = bootbox.dialog({
                title: '会员分配',
                message: el,
                className: 'assignModal',
                buttons: {
                    'cancel': {
                        label: '取消'
                    },
                    'confirm': {
                        label: '确定',
                        className: "btn-success btnSubmit",
                        callback: function () {
                            var ids = '';
                            for (var i = 0; i < chks.length; i++) {
                                ids += chks[i].value + ',';
                            }
                            $.ajax({
                                type: 'get',
                                url: '/admin/business/regionalagency',
                                data: { act: 'assign', ids: ids, agentID: $('.assignModal select').val() },
                                dataType: 'json',
                                async: false,
                                cache: false,
                                success: function (json) {
                                    if (json.success) {
                                        $.showResult(true, "保存成功", 1500, function () {
                                            bootbox.hideAll();
                                            loadList(1);
                                        });
                                    } else {
                                        $.showResult(false, json.msg);
                                    }
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) {
                                    $.showResult(false, XMLHttpRequest.responseText);
                                }
                            })
                            return false;
                        }
                    }
                }
            });
        })
    }

    function bindGridEvent() {
        $('#showListTable [name=UserID]').off().on('click', function () {
            $('#selectAll').prop('checked', $('#showListTable [name=UserID]').length == $('#showListTable [name=UserID]:checked').length);
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
            if (!confirm("确认删除？")) return false;
            $.getJSON("/admin/user/usermanage?act=Delete", utils.params({ id: $(this).attr("UserID") }), function (json) {
                if (json.success) {
                    if (itemcount > 1) loadUserList(curpage); else loadUserList(1);
                } else {
                    $.showResult(false, json.msg);
                }
            });
            return false;
        });

        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'useredit', params: { id: $(this).attr("UserID") } });
            return false;
        });
    }

    function loadAgentList() {
        var params = {
            page: 1,
            pagesize: 9999
        }
        $.ajax({
            type: 'get',
            url: '/admin/business/regionalagency?act=getlist',
            data: params,
            dataType: 'json',
            async: false,
            cache: false,
            success: function (json) {
                if (json.success) {
                    $('#slAgent').html('<option value="-1">--不限--</option>');
                    $('#slAgent').append('<option value="0">--未分配--</option>');

                    for (var i = 0 ; i < json.list.length; i++) {
                        var agent = json.list[i];
                        if ($('#slAgent option[value=' + agent.UserID + ']').length > 0) continue;
                        $('#slAgent').append('<option value="' + agent.UserID + '">' + agent.UserNickName + '</option>');
                    }
                } else {
                    $.showResult(false, json.msg);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.showResult(false, XMLHttpRequest.responseText);
            }
        });
    }

    function handleSearchParams(){
        if (me.currentModule.params && me.currentModule.params.searchParams) {
            try {
                searchParams = JSON.parse(decodeURIComponent(me.currentModule.params.searchParams));
                $("#slAgent").val(searchParams.agentID);
            } catch (ex) {
            }
        }
    }

    var isSubmiting = false;
    function submitForm(form) {
        if (isSubmiting) return;
        isSubmiting = true;

        var params = $(form).serializeObject();
        params.userid = $(form).find('[name=userid]').attr('userid');
        $.ajax({
            type: 'post',
            url: '/admin/business/regionalagency?act=edit',
            data: params,
            dataType: 'json',
            async: false,
            cache: false,
            success: function (json) {
                if (json.success) {
                    $.showResult(true, "操作成功", 1500, function () {
                        bootbox.hideAll();
                        loadList(1);
                    });
                } else {
                    $.showResult(false, json.msg, '', function () {
                        $('.addNewFormModal .btnSubmit').prop('disabled', false);
                    });
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.showResult(false, XMLHttpRequest.responseText);
            },
            complete: function () {
                isSubmiting = false;
            }
        })
        return false;
    }

    me.addListener('agentmemberlist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['couponedit'] = function () {

    var me = this;
		
	var ViewModel = function() {
        this.setData = function (data) {
			for(var key in data){
				this[key] = data[key];
			}
		};
		this.getBeginTime = function(time){
			return time.replace(/T/g," ");
		};
		this.getEndTime = function(time,type,type2){
			if(type != type2) return '';
			if(type == 1) return time;
			else{
				var date = new Date(time * 1000);
				return date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + " " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
			}
		};
    };
	
	var vm = new ViewModel();
	var myroot = null;
	var mustUpload = true;
	function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_SHOP') || !me.hasLicensePerm('ENABLE_COUPON')) {
            root.load("/index.php?c=admin/page/Versiontip&page=couponedit");
            return; 
        }
        root.loadHtmlTpl("plugins/businesspackage/html/couponedit.html",function() {
            me.execCommand('initContentNav', root);
			$.validator.addMethod("isIntGteZero", function(value, element) { 
        		value=parseInt(value);      
		        return this.optional(element) || value>0;       
		    }, "整数必须大于0"); 

			$("#CouponEditForm").validate({
				   rules: {
					tbTitle: {required: true},
					tbLogoImg: "required",
					tbAmount: "required",
					tbEndTime0: {required:$("#tbEndTime1").prop("disabled")},
					tbEndTime1: {required:$("#tbEndTime1").prop("disabled"),isIntGteZero: true}
				},
				messages: {
					tbTitle: "请输入标题！",
					tbLogoImg: "请选择Logo图片",
					tbAmount: "请输入金额或折扣额",
					tbEndTime0: "请输入过期时间",
					tbEndTime1: {required:"请输入过期时间",isIntGteZero:"日期必须为大于0的整数"}
				},
				submitHandler: function (form) {
					submitForm();
					return false;
				}
			});

			$('#tbLogoImg',root).on('click', function () {
                YDM.FileManager('image', 1, function (aUrl) {
                    if (aUrl.length > 0) {
                        $('#tbLogoImg').val(aUrl[0]);
                        $('#previewImg').attr('src', aUrl[0]);
						$('#previewImg').css("display","block");
                    }
                })
            });

			$('#tbBeginTime', myroot).datetimepicker({
			    dayOfWeekStart: 1,
			    lang: 'ch',
			    format: 'Y-m-d H:i:s',
			    yearEnd:2030,  
			});

			$('#tbEndTime0', myroot).datetimepicker({
			    dayOfWeekStart: 1,
			    lang: 'ch',
			    format: 'Y-m-d H:i:s',
			    yearEnd:2030,  
			});

			$('#slType', myroot).unbind().change(function(){
			    if($(this).val() == "0") $("#amountTips").html("% 请输入折扣比例，如输入 95 表示 95 折");
				else $("#amountTips").html("请输入金额");
			});

			$('input[name=slEndTimeType]', myroot).unbind().change(function(){
			    if($("input[name=slEndTimeType]:checked").val() == "1"){
					$("#tbEndTime0").prop("disabled",true);
					$("#tbEndTime1").prop("disabled",false);
				}else{
					$("#tbEndTime0").prop("disabled",false);
					$("#tbEndTime1").prop("disabled",true);
				}
			});
			
			$('#saveBtn').floatSaveBtn();
			
			myroot = root[0];
			//读取是否开启了代理发优惠券
			$.getJSON('/index.php?c=admin/business/shopconfig&a=getinfo',null,function(data){
				if(data.success && !data.info.EnableAgentCoupon)
				{
					$('#agentCoupon').remove();
				}
			});
			if(me.currentModule.params && me.currentModule.params.id) loadInfo();
		});
    }

    function loadInfo() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        //$.getJSON("/admin/business/coupon?act=GetCouponInfo", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/business/coupon&a=GetCouponInfo", utils.params(params), function (json) {
			vm.setData(json.info);
			ko.applyBindings(vm,myroot);
			$('input[name=slEndTimeType]:checked', myroot).change();
        });
    }

    function submitForm(form) {
		var params = $('#CouponEditForm').serializeObject(); //此方法定义在 core/ui.js
		//$.post("/admin/business/coupon?act=EditCoupon",params,function(data, textStatus, jqXHR){
		$.post("/index.php?c=admin/business/coupon&a=EditCoupon",params,function(data, textStatus, jqXHR){
			if(data.success){
			    $.showResult(true,"保存成功",2000,function(){
			    	me.execCommand('go', { a: 'business', b: 'couponlist' });
			    });
			}else{
			    $.showResult(false, data.msg);
			}
		},"json");
		return false;
    }

    me.addListener('couponedit', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['couponlist'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.couponlist = ko.observableArray();
        this.setData = function (data) { this.couponlist(data); };
		this.getExTime = function(time,type){
			if(type == 1) return "领取后 "+ time +" 日";
			else{
				var date = new Date(time * 1000);
				return date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + " " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
			}
		}
		this.getType = function(type){
			if(type == 1) return "现金券";
			else return "折扣券";
		}
		this.getStatus = function(status){
			if(status == 1) return "<font color='green'>已生效</font>";
			else return "<font color='red'>已禁用</font>";
		}
		this.getBelong = function(belong){
			if(belong ==1) return "门店货代理分发";
			else return "平台分发";
		}
		this.getAmount = function(amount,type){
			if(type == 1) return amount + " 元";
			else return amount + " 折";
		}
    };

	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_SHOP') || !me.hasLicensePerm('ENABLE_COUPON')) {
            // root.load("<div style='color:red;padding:100px;text-align:center;width:100%;font-weight:bold;font-size:14px;'>当前版本不支持此功能，如要使用请订购！</div>");
            root.load("/index.php?c=admin/page/Versiontip&page=couponlist");
            return;
        }
        root.loadHtmlTpl("plugins/businesspackage/html/couponlist.html", function () {
            me.execCommand('initContentNav', root);
            //$("#FenXiaoTable > table").hide();

			
			$("#BtnSearchUser").unbind().click(function(){ loadUserList(1); });
			
			$("#BtnSelectUser").unbind().click(function(){
				loadUserList(1);
				$("#couponuserListPanel").dialog({ resizable: false,title: "选择用户", modal: true, width: 400, height:500, position: ['center', 'middle'], close: function (event, ui) {  $(this).remove("close");$(this).dialog("destroy"); },
					buttons: { "确定": function() { 
											var aTrs = $("#couponuserListPanel").find('tr.UserSelected');
											var aIds = [];
											var aNames = [];
											aTrs.each(function () {
											    aIds.push($(this).attr('data-userguid'));
												aNames.push($(this).find('td').text());
											});
											$('#tbUsersStr').val(aNames.join(','));
											$('#tbUserIdsStr').val(aIds.join(','));
											$(this).dialog("close");
									   },
							   "取消": function() { $(this).dialog("close");}
					}
				});
			});
			
			
			$("#BtnSearchCoupon").unbind().click(function(){ loadCouponList(1); });
			
			$("#BtnSelectCoupon").unbind().click(function(){
				loadCouponList(1);
				$("#couponListPanel").dialog({ resizable: false,title: "选择优惠券", modal: true, width: 400, height:500, position: ['center', 'middle'], close: function (event, ui) { $(this).remove("close"); },
					buttons: { "确定": function() { 
											var aTrs = $("#couponListPanel").find('tr.CouponSelected');
											var aIds = [];
											var aNames = [];
											aTrs.each(function () {
											    aIds.push($(this).attr('data-couponid'));
												aNames.push($(this).find('td').text());
											});
											$('#tbCouponStr').val(aNames.join(','));
											$('#tbCouponIdStr').val(aIds.join(','));
											$(this).dialog("close");
									   },
							   "取消": function() { $(this).dialog("close");}
					}
				});
			});
			
			
			$("input[name='slSendType']").unbind().click(function(){
				var v = $("input[name='slSendType']:checked").val();
				$("#trUserLevel").hide();
				$("#trUserIds").hide();
				if(v == "1") $("#trUserLevel").show();
				if(v == "2") $("#trUserIds").show();
			});
			
			loadLevelList();
			
			bindUIEvent();
			ko.applyBindings(vm,root[0]);
			loadList(1);
		});
    }
	
	
	var levellist = null;
	function loadLevelList() {
		//$.ajax({ url: "/admin/user/userconfig?act=GetLevelList", async: false, dataType: "json", success: function (json) {
		$.ajax({ url: "/index.php?c=admin/user/userconfig&a=GetLevelList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					levellist = json.list;
					for(var i = 0;i < json.list.length;i++){
						$("#slUserLevel").append("<option value='"+ json.list[i].ID +"'>"+ json.list[i].LevelName +"</option>");
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}
	
	
	function loadUserList(page) {
        var params = { sid: me.sid, keyword: $("#userkeyword").val(),page: page, pagesize: 20 };
        //$.getJSON("/admin/user/usermanage?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/user/usermanage&a=getlist", utils.params(params), function (json) {	
			var aList = json.list;
            var sHtml = '<tr style="background:#eee"><th>会员昵称</th></tr>';
            for (var i = 0; i < aList.length; i++) {
                sHtml += '<tr data-userid="' + aList[i].UserID + '" data-userguid="' + aList[i].UserGUID + '">';
                sHtml += '<td>' + aList[i].NickName + '</td>';
                sHtml += '</tr>';
            }
            $('#couponuserListPanel table').html(sHtml);
            $('#couponuserListPanel tr:gt(0)').on('mouseenter', function () {
                $(this).addClass('UserHover');
            }).on('mouseleave', function () {
                $(this).removeClass('UserHover');
            }).on('click', function () {
                $(this).toggleClass('UserSelected');
            });

            if (json.pagecount < 2) $("#couponuserListPages").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#couponuserListPages").pageNav(json.curpage, json.pagecount, 10, function (page) { loadUserList(page); });
                $("#couponuserListPages").show();
            }
        });
    }
	
	
	function loadCouponList(page) {
        var params = { sid: me.sid, keyword: $("#couponkeyword").val(),page: page, pagesize: 20 };
        //$.getJSON("/admin/user/usermanage?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/business/coupon&a=getlist", utils.params(params), function (json) {	
			var aList = json.list;
            var sHtml = '<tr style="background:#eee"><th>优惠券名</th></tr>';
            for (var i = 0; i < aList.length; i++) {
                sHtml += '<tr data-couponid="' + aList[i].CouponID + '" >';
                sHtml += '<td>' + aList[i].Title + '</td>';
                sHtml += '</tr>';
            }
            $('#couponListPanel table').html(sHtml);
            $('#couponListPanel tr:gt(0)').on('mouseenter', function () {
                $(this).addClass('CouponHover');
            }).on('mouseleave', function () {
                $(this).removeClass('CouponHover');
            }).on('click', function () {
            	$('#couponListPanel tr').each(function(){
            		$(this).removeClass('CouponSelected');
            	});
                $(this).toggleClass('CouponSelected');
            });

            if (json.pagecount < 2) $("#couponListPages").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#couponListPages").pageNav(json.curpage, json.pagecount, 10, function (page) { loadUserList(page); });
                $("#couponListPages").show();
            }
        });
    }

	
	    
	var curpage = 1;
	var itemcount = 0;
    function loadList(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(), page: page, pagesize: 20 };
        //$.getJSON("/admin/business/coupon?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/business/coupon&a=getlist", utils.params(params), function (json) {
            vm.setData(json.list);
			$('#selectAll').prop("checked",false);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadList(page); });
                $("#pagination").show();
            }

            bindGridEvent();
        });
    }

	function getSelectedCouponIDs(){
		var array = new Array();
		$("input[name=artid]:checked").each(function(){
			array.push($(this).val());
		});
		var id = array.join(',');
		return id;
	}

	function bindUIEvent(){
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadList(1);
        });

		$('#selectAll').unbind().on('click', function () {
			$('#showListTable :checkbox:gt(0)').prop('checked', $('#showListTable :checkbox:eq(0)').prop('checked'));
		});

		$("#BtnAddCoupon").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'couponedit' });
			return false;
        });
		
		$('#BtnSetClass').unbind().on('click', function () {
			var id = getSelectedCouponIDs();
			if(!id) alert('请至少选择一个');
			else showSetClassDialog(id,0);
			$(document).click();
			return false;
		});

		$('#BtnDelSelected').unbind().on('click', function () {
			var id = getSelectedCouponIDs();
			if(!id) alert('请至少选择一个');
			else{
				if(confirm("确认删除吗?")){
					//$.getJSON("/admin/business/coupon?act=delete", utils.params({'id': id}), function (json) {
					$.getJSON("/index.php?c=admin/business/coupon&a=delete", utils.params({'id': id}), function (json) {
						if(json.success){
							if(id.split(',').length >= itemcount) loadList(1);
							else loadList(curpage);
						}else{
							$.showResult("出错啦",json.msg);
						}
					});
				}
			}
			return false;
		});
		
		
        $("#saveBtn").off().on('click', function (event) {
            var params = $('#SendCouponForm').serializeObject();
            //$.post("/admin/business/shopconfig?act=updateshopbaseinfo", params, function (data, textStatus, jqXHR) {
            $.post("/index.php?c=admin/business/Coupon&a=SendCoupon", params, function (data, textStatus, jqXHR) {
                if (data.success) {
                    $.showResult(true, "发送成功", 1500);
                } else {
                    $.showResult(false, data.msg);
                }
            }, "json");
            return false;
        });
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'couponedit', params: { id: $(this).attr("AID")} });
			return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			//$.getJSON("/admin/business/coupon?act=Delete", utils.params({id:$(this).attr("AID")}), function (json) {
			$.getJSON("/index.php?c=admin/business/coupon&a=Delete", utils.params({id:$(this).attr("AID")}), function (json) {
				if(json.success){
					if(itemcount > 1) loadList(curpage);
					else loadList(1);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });
    }

    me.addListener('couponlist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['downloadclass'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
		this.array = [];
        this.setData = function (data) { this.array = data;this.list(data);};
		this.getSublist = function(parentid){
			var ret = [];
			for(var i = 0;i < this.array.length;i++){
				if(this.array[i].ParentID == parentid) ret.push(this.array[i]);
			}
			return ret;
		};
		this.getRootList = function(selectValue){
			var ret = [];
			ret.push({ClassID:0, Name: '设置根类别', Selected: false});
			for(var i = 0;i < this.array.length;i++){
				if(this.array[i].ParentID == 0){
					var obj = this.array[i];
					if(selectValue == obj.ClassID) obj['Selected'] = true;
					else obj['Selected'] = false;
					ret.push(obj);
				}
			}
			return ret;
		};
    };
	
	var vm = new ViewModel();
	function initUI(root) {
        root.empty();
        root.loadHtmlTpl("plugins/businesspackage/html/downloadclass.html?v=" + Math.random(), function () {
            me.execCommand('initContentNav', root);
			ko.applyBindings(vm,root[0]);
			bindUIEvent();
			loaddownloadclassList();
		});
    }

    function loaddownloadclassList() {
        //$.getJSON("/admin/download/download?act=getclasslist", utils.params({}), function (json) {
    	$.getJSON("/index.php?c=admin/download/download&a=getclasslist", utils.params({}), function (json) {
			if(json.success){
				vm.setData(json.list);
				bindGridEvent();
			}else{
				alert("出错了：" + json.msg);
			}
        });
    }

	function showResult(title,msg,autoClose) {
		$("#ResultDialog").remove();
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
		if(autoClose && autoClose > 0){
			setTimeout(function(){ $("#ResultDialog").remove(); },autoClose);
		}
	}

	function bindUIEvent(){
		$("#BtnAddNewClass").bind("click",function(){
			var form = $(this).closest('form');
			var formVals = $(form).serializeObject();
			var params = {Name: formVals.tbName,ParentID: formVals.slParentID};
			//$.getJSON("/admin/download/download?act=editclass", utils.params(params), function (json) {
			$.getJSON("/index.php?c=admin/download/download&a=editclass", utils.params(params), function (json) {
				if(json.success){
				    $.showResult(true, "添加成功", 1000);
					loaddownloadclassList();
				}else{
				    $.showResult(false, json.msg);
				}
			});
		});

		$('[name=tbName]').unbind('keypress').bind('keypress', function (evt) {
		    if (evt.keyCode == 13) {
		        $('#BtnAddNewClass').click();
		        evt.stopPropagation();
		        return false;
		    }
		});
	}

	function bindGridEvent() {
		$(".Tables").disableSelection();
		$(".sortUl").sortable({
			handle: ".T1",
			start: function (event, ui) {
				ui.item.css({ "border": "solid 1px red" });
			},
			update: function (event, ui) {

				var orders = new String();
				$(this).find(".MoveItem").each(function (i) {
					orders += $(this).attr("value") + "-" + i + ",";
				});
				$.ajax({
					type: "POST",
					dataType: 'json',
					//url: '/admin/download/download',
					//data: { act: "MoveClassOrder", Order: orders },
					url: '/index.php?c=admin/download/download',
					data: { a: "MoveClassOrder", Order: orders },
					success: function (json) {
						if(json.success) loaddownloadclassList();
						else alert("出错了：" + json.msg);
					},
					error: function (XMLHttpRequest, textStatus, errorThrown) {
						alert("系统出错了." + errorThrown);
					}
				});
			}, stop: function (event, ui) {
				ui.item.css({ "border": "0" });
			}
		});

		$(".SubTable").sortable({
			handle: ".SubHandle",
			start: function (event, ui) {
				ui.item.css({ "border": "solid 1px red" });
			},
			update: function (event, ui) {
				
				var orders = new String();
				$(this).find(".SubHandle").each(function (i) {
					orders += $(this).attr("value") + "-" + i + ",";
				});
				$.ajax({
					type: "POST",
					dataType: 'json',
					//url: '/admin/download/download',
					//data: { act: "MoveClassOrder", Order: orders },
					url: '/index.php?c=admin/download/download',
					data: { a: "MoveClassOrder", Order: orders },
					success: function (json) { 
						if(json.success) loaddownloadclassList();
						else alert("出错了：" + json.msg);
					},
					error: function (XMLHttpRequest, textStatus, errorThrown) {
						alert("系统出错了.");
					}
				});
			}, stop: function (event, ui) {
				ui.item.css({ "border": "0", "border-bottom": "solid 1px #ccc" });
			}
		});

		$("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var form = $(this).closest('form');
			var formVals = form.serializeObject();
			var params = {ClassID: formVals.tbClassID,Name: formVals.tbName,ParentID: formVals.slParentID};
			//$.getJSON("/admin/download/download?act=editclass", utils.params(params), function (json) {
			$.getJSON("/index.php?c=admin/download/download&a=editclass", utils.params(params), function (json) {
				if(json.success){
				    $.showResult(true, "修改成功", 1000);
					loaddownloadclassList();
				}else{
				    $.showResult(false, json.msg);
				}
			});
        });

		$("*[name=BtnDel]").bind("click",function(){
			if(!confirm("确认删除？")) return;
			//$.getJSON("/admin/download/download?act=deleteclass", utils.params({ClassID:$(this).attr("ClassID")}), function (json) {
			$.getJSON("/index.php?c=admin/download/download&a=deleteclass", utils.params({ClassID:$(this).attr("ClassID")}), function (json) {
				loaddownloadclassList();
			});
		});
	}

    me.addListener('downloadclass', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['downloadedit'] = function () {

    var me = this;
		
	var ViewModel = function() {
        this.setData = function (data) {
			for(var key in data){
				if(typeof(data[key]) == "object") this[key] = ko.observableArray(data[key]);
				else this[key] = ko.observable(data[key]);
			}
		};
		this.getPublishTime = function(time){
			return time().replace(/T/g," ");
		}
    };
	
	var vm = new ViewModel();
	var myroot = null;
	var mustUpload = true;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/downloadedit.html",function() {
            me.execCommand('initContentNav', root);
			$("#DownEditForm").validate({
				   rules: {
					tbSrc: { required: "#SrcTypeLink:checked" },
					tbDownFile: { required:function(){ return ($("#SrcTypeUpload").is(":checked")) && mustUpload; }},
					tbTitle: "required",
					tbContent: "required"
				},
				messages: {
					tbSrc: "请输入链接网址需要带http://开头！",
					tbDownFile: "请上传文件！",
					tbTitle: "请输入下载标题！",
					tbContent: "请输入详细介绍"
				},
				submitHandler: function (form) {
					submitForm();
					return false;
				}
			});

			$("input[name='SrcType']").click(function () {
				if ($(this).val() == "Link") {
					$("#tbSrc").show();
					$("#tbDownFile").hide(function () {
						$("label[for='tbDownFile']").hide();
						$("#pSrc").hide();
					});
					$("#trFileSize").show();
				} else {
					$("#tbDownFile").show(function () {
						$("label[for='tbDownFile']").show();
						$("#pSrc").show();
					});
					$("#tbSrc").hide();
					$("#trFileSize").hide();
				}
			});


			/*$('#openImageBtn',root).on('click', function () {
                YDM.FileManager('file', 1, function (aUrl) {
                    if (aUrl.length > 0) {
                        $('#tbSrc').val(aUrl[0]);
                    }
                })
            });*/
			
			$('#saveBtn').floatSaveBtn();
			
			loadClsList();
			myroot = root[0];
			if(me.currentModule.params && me.currentModule.params.id) loadDown();
			else initUE();
		});
    }

	var classlist = null;
	function loadClsList() {
		//$.ajax({ url: "/admin/download/download?act=GetClassList", async: false, dataType: "json", success: function (json) {
		$.ajax({ url: "/index.php?c=admin/download/download&a=GetClassList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					classlist = json.list;
					for(var i = 0;i < json.list.length;i++){
						if(json.list[i].ParentID == 0){
							$("#slClassID").append("<option value='"+ json.list[i].ClassID +"'>"+ json.list[i].Name +"</option>");
							for(var j = 0;j < json.list.length;j++){
								if(json.list[j].ParentID == json.list[i].ClassID){
									$("#slClassID").append("<option value='"+ json.list[j].ClassID +"'> └- "+ json.list[j].Name +"</option>");
								}
							}
						}
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}
	
	var ue = null;
	function initUE(){
	    try {
	        //if (ue != null) {
	        //ue.destroy();
	        //}
	        ue = new baidu.editor.ui.Editor({
	            initialFrameHeight: "300",
	            autoHeightEnabled: true,
	            toolbars: [[
                     'source', '|', 'undo', 'redo', '|',
                     'bold', 'italic', 'underline', 'fontborder', 'strikethrough', 'superscript', 'subscript', 'removeformat', 'formatmatch', 'autotypeset', 'blockquote', 'pasteplain', '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|',
                     'rowspacingtop', 'rowspacingbottom', 'lineheight', '|',
                     'customstyle', 'paragraph', 'fontfamily', 'fontsize', '|',
                     'directionalityltr', 'directionalityrtl', 'indent', '|',
                     'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', '|', 'touppercase', 'tolowercase', '|',
                     'link', 'unlink', 'anchor', '|', 'imagenone', 'imageleft', 'imageright', 'imagecenter', '|',
                     'insertvideo', 'map', 'gmap', 'insertcode', 'pagebreak', '|',
                     'horizontal', 'date', 'time', 'spechars', '|',
                     'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', '|',
                     'preview', 'searchreplace'
	            ]]
	        });
	        ue.ready(function () {
	            ue.setContent($("#tbContent", myroot).val());
	        });
	        ue.render('editor');
	    } catch (e) {
	        console.log("error: " + e);
	    }
	}

    function loadDown() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        //$.getJSON("/admin/download/download?act=GetDownloadInfo", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/download/download&a=GetDownloadInfo", utils.params(params), function (json) {
			vm.setData(json.info);
			ko.applyBindings(vm,myroot);

			//表示上传的资源
			if (json.info.Src != "" && /http:/.test(json.info.Src) == false && /ftp:/.test(json.info.Src) == false)
            {
				$("#SrcTypeUpload").prop("checked",true);
                $("#tbDownFile").show();
                $("#tbSrc").hide();
                $("#pSrc").show();
				$("#trFileSize").hide();
				var Src = "/comdata/{0}/download/{1}".format(json.info.SiteID, json.info.Src);
				$("#lbSrc").html("原上传的文件是：<a href='"+ Src +"' target='_blank'>"+ Src +"</a>");
				if(json.info.Src) mustUpload = false;
            }
			else
			{
                $("#SrcTypeLink").prop("checked",true);
                $("#tbDownFile").hide();
                $("#tbSrc").show();
				$("#tbSrc").val(json.info.Src);
				$("#trFileSize").show();
			}

			initUE();
        });
    }

	function ajaxFileUpload(params) {
		$.ajaxFileUpload
		(
			{
				//url: '/admin/download/download?act=EditDownload', //用于文件上传的服务器端请求地址
				url: '/index.php?c=admin/download/download&a=EditDownload', //用于文件上传的服务器端请求地址
				secureuri: false, //是否需要安全协议，一般设置为false
				fileElementId: 'tbDownFile', //文件上传域的ID
				dataType: 'json', //返回值类型 一般设置为json
				data: params,
				success: function (json, status)
				{
				    if (json.success) {
				        $.showResult(true, "保存成功", 1500, function () {
				            me.execCommand('go', { a: 'business', b: 'downloadlist' });
				        });
				    } else {
				        $.showResult(false, json.msg);
				    }
				},
				error: function (data, status, e)
				{
					alert(e);
				}
			}
		);
		return false;
	}

    function submitForm(form) {
		var html = ue.getContent();
		$('#tbContent').val(html);
		var params = $('#DownEditForm').serializeObject(); //此方法定义在 core/ui.js
		//console.log(params);return;
		ajaxFileUpload(params);
		return false;
    }

    me.addListener('downloadedit', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['downloadlist'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.adminlist = ko.observableArray();
        this.setData = function (data) { this.adminlist(data); };
		this.getClassName = function(classid){
			for(var i = 0;i < classlist.length;i++){
				if(classlist[i].ClassID == classid){
					return classlist[i].Name;
				}
			}
			return "未分类";
		}
		this.getTime = function(time){
			return time.replace(/T/gi," ").replace(/(\.\d+)/,"");
		}
    };

	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/downloadlist.html", function () {
            me.execCommand('initContentNav', root);
			bindUIEvent();
			loadClsList();
			ko.applyBindings(vm,root[0]);
			loadDownloadlist(1);
		});
    }
	
	var classlist = null;
	function loadClsList() {
		$("#classid").children().remove();
		$("#classid").append("<option value='0'>--全部分类--</option>");
		//$.ajax({ url: "/admin/download/download?act=GetClassList", async: false, dataType: "json", success: function (json) {
		$.ajax({ url: "/index.php?c=admin/download/download&a=GetClassList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					classlist = json.list;
					console.log(classlist);
					for(var i = 0;i < json.list.length;i++){
						if(json.list[i].ParentID == 0){
							$("#classid").append("<option value='"+ json.list[i].ClassID +"'>"+ json.list[i].Name +"</option>");
							for(var j = 0;j < json.list.length;j++){
								if(json.list[j].ParentID == json.list[i].ClassID){
									$("#classid").append("<option value='"+ json.list[j].ClassID +"'> &nbsp;&nbsp;└-"+ json.list[j].Name +"</option>");
								}
							}
						}
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}
    
	var curpage = 1;
	var itemcount = 0;
    function loadDownloadlist(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(),classid : $("#classid").val(), status: $("#status").val(), page: page, pagesize: 20 };
        //$.getJSON("/admin/download/download?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/download/download&a=getlist", utils.params(params), function (json) {
            vm.setData(json.list);
			$('#selectAll').prop("checked",false);
			curpage = json.curpage;
			itemcount = json.list.length;
			$(".downLoadName").each(function () { $(this).attr("href", json.detailurl.replace("{ID}", $(this).attr("downID"))); });
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadDownloadlist(page); });
                $("#pagination").show();
            }

            bindGridEvent();
        });
    }

	function showSetClassDialog(id,classid){
		var html = "<div id='SelClassDialog'><center>";
		html += "请选择分类：<select id='setclass_clsid' class='form-control' style='width:160px;display:inline'>";
		html += $("#classid").html();
		html += "</select>";
		$("body").append(html);
		$("#setclass_clsid option:first-child").remove();
		$("#setclass_clsid").val(classid);
		$("#SelClassDialog").dialog({ resizable: false, title: "设置分类", modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); },
			buttons: { "确定": function() { 
									setClass(id,$("#setclass_clsid").val());
									$(this).remove();
							   },
					   "取消": function() { $(this).remove(); }
			}
		});
	}

	function setClass(id,classid){
		var params = {'id':id, 'classid': classid};
		//$.post("/admin/download/download?act=setclass",params,function(data, textStatus, jqXHR){
		$.post("/index.php?c=admin/download/download&a=setclass",params,function(data, textStatus, jqXHR){
			if(data.success){
				loadDownloadlist(curpage);
			}else{
				alert(json.msg);
			}
		},"json");
	}

	function getSelectedArtIDs(){
		var array = new Array();
		$("input[name=artid]:checked").each(function(){
			array.push($(this).val());
		});
		var id = array.join(',');
		return id;
	}

	function showResult(title,msg,autoClose) {
		$("#ResultDialog").remove();
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
		if(autoClose && autoClose > 0){
			setTimeout(function(){ $("#ResultDialog").remove(); },autoClose);
		}
	}

	function bindUIEvent(){
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadDownloadlist(1);
        });

		$('#selectAll').unbind().on('click', function () {
			$('#showListTable :checkbox:gt(0)').prop('checked', $('#showListTable :checkbox:eq(0)').prop('checked'));
		});

		$("#BtnAddDownload").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'downloadedit' });
			return false;
        });
		
		$('#BtnSetClass').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else showSetClassDialog(id,0);
			$(document).click();
			return false;
		});

		$('#BtnSetStatus1').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				//$.getJSON("/admin/download/download?act=setstatus", utils.params({id:id,status: 1}), function (json) {
				$.getJSON("/index.php?c=admin/download/download&a=setstatus", utils.params({id:id,status: 1}), function (json) {
					if(json.success) loadDownloadlist(curpage);
					else{
						showResult("出错啦",json.msg);
					}
				});
			}
			$(document).click();
			return false;
		});

		$('#BtnSetStatus0').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				//$.getJSON("/admin/download/download?act=setstatus", utils.params({id:id,status: 0}), function (json) {
				$.getJSON("/index.php?c=admin/download/download&a=setstatus", utils.params({id:id,status: 0}), function (json) {
					if(json.success) loadDownloadlist(curpage);
					else{
						showResult("出错啦",json.msg);
					}
				});
			}
			$(document).click();
			return false;
		});

		$('#BtnDelSelected').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				if(confirm("确认删除吗?")){
					//$.getJSON("/admin/download/download?act=delete", utils.params({'id': id}), function (json) {
					$.getJSON("/index.php?c=admin/download/download&a=delete", utils.params({'id': id}), function (json) {
						if(json.success){
							if(id.split(',').length >= itemcount) loadDownloadlist(1);
							else loadDownloadlist(curpage);
						}else{
							showResult("出错啦",json.msg);
						}
					});
				}
			}
			return false;
		});
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'downloadedit', params: { id: $(this).attr("AID")} });
			return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			//$.getJSON("/admin/download/download?act=Delete", utils.params({id:$(this).attr("AID")}), function (json) {
			$.getJSON("/index.php?c=admin/download/download&a=Delete", utils.params({id:$(this).attr("AID")}), function (json) {
				if(json.success){
					if(itemcount > 1) loadDownloadlist(curpage);
					else loadDownloadlist(1);
				}else{
					showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetActive]").unbind('click').bind('click', function (event) {
			//$.getJSON("/admin/download/download?act=setstatus", utils.params({id:$(this).attr("AID"),status: 1}), function (json) {
			$.getJSON("/index.php?c=admin/download/download&a=setstatus", utils.params({id:$(this).attr("AID"),status: 1}), function (json) {
				if(json.success){
					loadDownloadlist(curpage);
				}else{
					showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetClass]").unbind('click').bind('click', function (event) {
			showSetClassDialog($(this).attr("AID"),$(this).attr("ClassID"));
			return false;
        });
    }

    me.addListener('downloadlist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

IWF.plugins['financelist'] = function () {

    var me = this;

    var ViewModel = function () {
        this.list = ko.observableArray();
        this.yongJinList = ko.observableArray();
        this.getTime = function (time) {
            return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
        }
        this.getMoney = function (money) {
            return Math.abs(money);
        }
    };

    var vm = new ViewModel();
    var myroot = null;

    function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_SHOP')) {
            root.load("/index.php?c=admin/page/Versiontip&page=financelist");
            return;
        }
        root.loadHtmlTpl("plugins/businesspackage/html/financelist.html?v=" + Math.random(), function () {
            myroot = root[0];
            setSomeOptionDisplay();
            bindUIEvent();
            ko.applyBindings(vm, $("#showListTable")[0]);
            loadList(1);
        });
    }

    var curpage = 1;
    var itemcount = 0;
    function loadList(page) {
        var params = {
            sid: me.sid,
            keyword: $("#keyword").val(),
            userkeyword: $("#userkeyword").val(),
            financeType: $("#financeType").val(),
            yongJinStatus: $("#yongJinStatus").val(),
            moneyType: $("#moneyType").val(),
            minMoney: $("#minMoney").val(),
            maxMoney: $("#maxMoney").val(),
            startTime: $("#startTime").val(),
            endTime: $("#endTime").val(),
            orderID: $('#orderID').val(),
            page: page,
            pagesize: 20
        }
        var minMoney = parseFloat(params.minMoney);
        if (params.minMoney != '' && (isNaN(minMoney) || minMoney < 0)) {
            $.showResult(false, '最小金额必须输入正数');
            return;
        }

        var maxMoney = parseFloat(params.maxMoney);
        if (params.maxMoney != '' && (isNaN(maxMoney) || maxMoney < 0)) {
            $.showResult(false, '最高金额必须输入正数');
            return;
        }

        var url = "/index.php?c=admin/business/financemanage&a=getlist";
        if (params.financeType == '9') {
            url = "/index.php?c=admin/business/financemanage&a=getyongjinlist";
        }
        $.getJSON(url, utils.params(params), function (json) {
            if (json.success) {
                if (params.financeType == 9) {
                    vm.yongJinList(json.list);
                } else {
                    vm.list(json.list);
                }
                curpage = json.curpage;
                itemcount = json.list.length;
                if (json.pagecount < 2) $("#pagination").hide();
                else {
                    //pageNav 方法定义在 /core/util.js 里
                    $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadList(page); });
                    $("#pagination").show();
                }
                bindGridEvent();
                setCellDisplay();
            } else {
                $.showResult(false, json.msg);
            }
        });
    }

    function bindUIEvent() {
        $("<div></div>").appendTo(myroot).loadHtmlTpl("/admin/widget/userSelector.html");

        $("#btnSearch").unbind('click').bind('click', function (event) {
            loadList(1);
        });

        $("#startTime").datepicker({
            format: "yyyy/mm/dd",
            defaultDate: "+1w",
            changeMonth: true,
            dateFormat: "yy/mm/dd",
            language: "zh-CN",
            orientation: "bottom auto",
            showOptions: { direction: "down" },
            onClose: function (selectedDate) {
                $("#TimeEnd").datepicker("option", "minDate", selectedDate);
            }
        });

        $("#endTime").datepicker({
            format: "yyyy/mm/dd",
            defaultDate: "+1w",
            changeMonth: true,
            dateFormat: "yy/mm/dd",
            language: "zh-CN",
            orientation: "bottom auto",
            showOptions: { direction: "down" },
            onClose: function (selectedDate) {
                $("#TimeBegin").datepicker("option", "maxDate", selectedDate);
            }
        });

        $('#financeType').off().on('change', function () {
            setSomeOptionDisplay();
        })

        $('#btnExportFinanceList, #btnExportYongJinList').off().on('click', function () {
            var action = $(this).attr('action');
            var params = {
                a: action,
                sid: me.sid,
                keyword: $("#keyword").val(),
                userkeyword: $("#userkeyword").val(),
                financeType: $("#financeType").val(),
                yongJinStatus: $("#yongJinStatus").val(),
                moneyType: $("#moneyType").val(),
                minMoney: $("#minMoney").val(),
                maxMoney: $("#maxMoney").val(),
                startTime: $("#startTime").val(),
                endTime: $("#endTime").val(),
                orderID: $('#orderID').val()
            };
            window.open("/index.php?c=admin/business/financemanage&" + $.param(params));
        });

        $('#btnAddNew').off().on('click', function () {
            var dialog = bootbox.dialog({
                title: '新增财务记录',
                message: $('.divAddFinanceForm').prop('outerHTML'),
                className: 'addFinanceFormModal',
                buttons: {
                    'cancel': {
                        label: '取消'
                    },
                    'confirm': {
                        label: '保存',
                        className: "btn-success btnSubmit",
                        callback: function () {
                            if ($('.addFinanceFormModal .addFinanceForm').valid()) {
                                $('.addFinanceFormModal .btnSubmit').prop('disabled', true);
                                $('.addFinanceFormModal .addFinanceForm').submit();
                            }
                            return false;
                        }
                    }
                }
            });

            $.validator.addMethod("isFloatNum2", function (value, element) {
                return this.optional(element) || /^\d+\.{0,1}\d{0,2}$/.test(value);
            }, "必须是正数，并且小数为最多为两位");

            dialog.find('.addFinanceForm').validate({
                rules: {
                    userid: { required: true },
                    money: { required: true, isFloatNum2: true },
                    about: { required: true },
                    moneyType: { required: true }
                },
                messages: {
                    userid: { required: "请选择会员" },
                    money: { required: "请填写金额", isFloatNum2: "必须是正数，并且小数为最多为两位" },
                    about: { required: "请填写详情" },
                    moneyType: { required: "请选择类型" }
                },
                success: function (error, element) {
                    $(element).parent('.form-group').removeClass('has-error').addClass('has-success');
                    //error.hide();
                },
                showErrors: function (errorMap, errorList) {
                    for (var i = 0; i < errorList.length ; i++) {
                        $(errorList[i].element).parent('.form-group').addClass('has-error').removeClass('has-success');
                    }
                    this.defaultShowErrors();
                },
                submitHandler: function (form) {
                    submitForm(form);
                    return false;
                }
            });

            dialog.find('.divAddFinanceForm').show();

            dialog.find('[name^=userid]').userSelector({
                selectUser: function (data) {
                    $(data.boundingElem).attr('userid', data.userid).val('(ID:' + data.userid + ') ' + data.nickName).blur();
                }
            });
        });
    }

    function bindGridEvent() {

    }

    function setSomeOptionDisplay() {
        var type = $('#financeType').val();
        //$('[related]').not($('[related=' + type + ']')).fadeOut();
        $('.Filter-Group [related], .input-group [related]').hide();
        $('.Filter-Group [related=' + type + ']').show();
        $('.input-group [related=' + type + ']').show();
    }

    function setCellDisplay() {
        var type = $('#financeType').val();
        //$('#showListTable [related]').not($('#showListTable [related=' + type + ']')).fadeOut();
        $('#showListTable [related]').hide();
        $('#showListTable [related=' + type + ']').show();
    }

    var isSubmiting = false;
    function submitForm(form) {
        if (isSubmiting) return;
        isSubmiting = true;

        var params = $(form).serializeObject();
        params.userid = $(form).find('[name=userid]').attr('userid');
        $.ajax({
            type: 'post',
            //url: '/admin/business/financemanage?act=edit',
            url: '/index.php?c=admin/business/financemanage&a=edit',
            data: params,
            dataType: 'json',
            async: false,
            cache: false,
            success: function (json) {
                if (json.success) {
                    $.showResult(true, "操作成功", 1500, function () {
                        bootbox.hideAll();
                        loadList(1);
                    });
                } else {
                    $.showResult(false, json.msg, '', function () {
                        $('.addFinanceFormModal .btnSubmit').prop('disabled', false);
                    });
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.showResult(false, XMLHttpRequest.responseText);
            },
            complete: function () {
                isSubmiting = false;
            }
        })
        return false;
    }

    me.addListener('financelist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['business'] = function () {

    var me = this;
    var nav = { icon: 'fa fa-briefcase',color: 'icon-green', title: '商务', a: 'business', b: 'productlist', index: 5, canClose: false };

    var leftRoot, rightRoot, leftNav;

    var navConfig = {
        showOption:false,

		data: [
        {
            icon: 'fa fa-edit', color: 'icon-red', title: '产品管理',
            items: [
                { icon: 'fa fa-list-ul', color: 'icon-blue', title: '产品列表', a: 'business', b: 'productlist' }
				//,{ icon: 'fa fa-plus', color: 'icon-green', title: '添加产品', a: 'business', b: 'productedit' }
				,{ icon: 'fa fa-list-alt', color: 'icon-red', title: '产品分类', a: 'business', b: 'productclass' }
				,{ icon: 'fa fa-cog', color: 'icon-blue', title: '产品设置', a: 'business', b: 'productparams' }
            ]
        }, {
            icon: 'fa fa-edit', color: 'icon-red', title: '会员管理',
            items: [
                { icon: 'fa fa-list-ul', color: 'icon-blue', title: '会员列表', a: 'business', b: 'userlist'}
                , { icon: 'fa fa-comments', color: 'icon-red', title: '消息管理', a: 'business', b: 'usermsglist' }
				, { icon: 'fa fa-cog', color: 'icon-green', title: '会员设置', a: 'business', b: 'userconfig' }
				, { icon: 'fa fa-plus', color: 'icon-yellow', title: '添加会员', a: 'business', b: 'useredit' }
                , { icon: 'fa fa-userinfo', color: 'icon-yellow', title: '会员详情', a: 'business', b: 'useredit' }
                , { icon: 'fa fa-subdist', color: 'icon-yellow', title: '下级分销', a: 'business', b: 'usersubdist' }
            ]
        }, {
            icon: 'fa fa-edit', color: 'icon-red', title: '商城系统',
            items: [
                { icon: 'fa fa-list-ul', color: 'icon-blue', title: '订单列表', a: 'business', b: 'orderlist' }
				, { icon: 'fa fa-list-ul', color: 'icon-blue', title: '退款列表', a: 'business', b: 'refundslist' }
				, { icon: 'fa fa-cog', color: 'icon-blue', title: '分销设置', a: 'business', b: 'shopconfig' }
                , { icon: 'fa fa-cog', color: 'icon-blue', title: '商城设置', a: 'business', b: 'shoppingmallconfig' }
				,{ icon: 'fa fa-cc', color: 'icon-blue', title: '分销提成审核', a: 'business', b: 'tichengreview'}
				,{ icon: 'fa fa-money', color: 'icon-blue', title: '提现管理', a: 'business', b: 'tixianlist'}
            ]
        }, {
            icon: 'fa fa-edit', color: 'icon-red', title: '商城统计',
            items: [
                { icon: 'fa fa-list-ul', color: 'icon-blue', title: '商城统计', a: 'business', b: 'shopstatistics' }
            ]
        }, {
            icon: 'fa fa-edit', color: 'icon-red', title: '其它',
            items: [
                { icon: 'fa fa-comments', color: 'icon-red', title: '留言管理', a: 'business', b: 'messagelist'}
				, { icon: 'fa fa-list-ul', color: 'icon-red', title: '相册管理', a: 'business', b: 'sitegallerylist' }
                , { icon: 'fa fa-list-ul', color: 'icon-red', title: '下载列表', a: 'business', b: 'downloadlist' }
                , { icon: 'fa fa-calendar', color: 'icon-green', title: '自定义表单', a: 'form', b: 'formlist' }
            ]
        }],

        onItemClick: function (sender, data) {
			leftNav.hide();
			me.execCommand('go', data);
        },

        setSelect: function (args) {
            var index = 0;
            $.each(navConfig.data, function (i, item) {
                index++;
                if (item.a == args.a && item.b == args.b) {
                    navConfig.selectIndex = index;
                }
                if (item.items) {
                    $.each(item.items, function (k, citem) {
                        index++;
                        if (citem.a == args.a && citem.b == args.b) {
                            navConfig.selectIndex = index;
                        }
                    });
                }
            });
        }
    };

    me.addListener('init', function () {
		var tab = me.execCommand('addtab', nav);
		if (tab.c.children().length == 0) {
            var temp = $('<div class="row"></div>').appendTo(tab.c);
            //leftRoot = $('<div class="col-sm-1 col-md-2 mainside"></div>').appendTo(temp);
            rightRoot = $('<div class="col-sm-9 col-md-10 col-sm-offset-3 col-md-offset-0"></div>').appendTo(temp);
            //leftRoot.append('<div class="navcontent"></div>');
        }

		leftNav = $('<div class="sidebarNavPanel"><div class="titlebar"><div class="title">'+ nav.title +'</div></div><div class="content"><ul></ul></div></div>').appendTo("body");
		leftNav.find('.content>ul').listNav2(tab,leftNav,navConfig);

		tab.t.click(function(){ leftNav.hide(); });
        $('li:contains(会员详情), li:contains(下级分销)').css('display', 'none');
	});

    function flash(args, tab,isgo) {
        

        //原来架框的建立下级菜单过程
		//navConfig.setSelect(args);
        //leftRoot.find('div.navcontent').listNav(navConfig);

		me.execCommand('show', { a: args.a });
        setChildWindow(args,rightRoot,isgo);
    }

    function setChildWindow(args, root,isgo) {
        /*var temp = root.find('#' + args.b);
        if (temp.length == 0) {
            temp = $('<div id="' + args.b + '"></div>').appendTo(root);
        }
        temp.show();
        temp.siblings().hide();
        if(isgo) me.execCommand('go', args);
		else me.fireEvent(args.b, temp);*/

		if(isgo) me.execCommand('go', args);
		else me.fireEvent(args.b, me.content); //me.content 定义在 core/content.js 里
    }

    me.commands['initContentNav' + nav.a] = {
        execCommand: function(key, domObj) {
            var items = [];
            if(/^product/.test(me.currentModule.b)) {
                items = $.map(navConfig.data[0].items, function(obj) { return $.extend(true, {}, obj); });
                items.splice(1, 0, {title: '产品评论', a: 'business', b: 'productcomment'});
				items.splice(3, 0, {title: '批量添加', a: 'business', b: 'productbatadd'});
                items.push({title: '产品展示样式', a: 'business', b: 'productstyle'});
                items.push({title: '产品标签设置', a: 'business', b: 'productlabel'});
            } else if(/^user/.test(me.currentModule.b)) {
                items = navConfig.data[1].items;
            } else if(/^download/.test(me.currentModule.b)) {
                items.push({title: '下载列表', a: 'business', b: 'downloadlist'});
                items.push({title: '添加下载', a: 'business', b: 'downloadedit'});
                items.push({title: '下载分类', a: 'business', b: 'downloadclass'});
            }
            me.execCommand('addContentNav', domObj, items);
        }
    }

    me.addListener(nav.a, function (key, args) {
        var tab = me.execCommand('gettab', nav);
        flash(args, tab);
    });
};

﻿IWF.plugins['jifenconfig'] = function () {

    var me = this;

    var myroot = null;
    function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_JIFEN')) {
            root.load("/index.php?c=admin/page/Versiontip&page=jifenconfig");
            return;
        }
        root.loadHtmlTpl("plugins/businesspackage/html/jifenconfig.html?v=" + Math.random(), function () {
            myroot = root[0];

            bindUIEvent();
            $('#BtnSave').floatSaveBtn();
            loadConfig();
        });
    }

    function loadConfig() {
        //$.getJSON("/admin/business/shopconfig?act=getinfo", null, function (json) {
    	$.getJSON("/index.php?c=admin/business/shopconfig&a=getinfo", null, function (json) {
            ko.applyBindings({ config: json.info }, myroot);
        });
    }

    function bindUIEvent() {
        $("#JiFenQianDao").unbind().click(function () {
            me.execCommand('go', { a: 'weixy', b: 'signin' });
            return false;
        });
        $("#JiFenYingXiao").unbind().click(function () {
            me.execCommand('go', { a: 'weixy', b: 'lucknew' });
            return false;
        });
        
        $('#ShopConfigForm').validate({
    		rules: {
    			'JiFenScaleIn':{required:true,digits:true},
    			'JiFenScaleOut':{required:true,digits:true},
    			'JiFenScaleMax':{required:true,digits:true},
    			'JiFenNewUser':{required:true,digits:true},
    			'JiFenAddSub':{required:true,digits:true},
				'JiFenAddSub2':{required:true,digits:true},
				'JiFenAddSub3':{required:true,digits:true},
    		},
    		messages:{
    			'JiFenScaleIn':{required:'请输入整数',digits:'请输入整数'},
    			'JiFenScaleOut':{required:'请输入整数',digits:'请输入整数'},
    			'JiFenScaleMax':{required:'请输入整数',digits:'请输入整数'},
    			'JiFenNewUser':{required:'请输入整数',digits:'请输入整数'},
    			'JiFenAddSub':{required:'请输入整数',digits:'请输入整数'},
				'JiFenAddSub2':{required:'请输入整数',digits:'请输入整数'},
				'JiFenAddSub3':{required:'请输入整数',digits:'请输入整数'},
    		},
    		submitHandler:function(form){
    			 var params = $('#ShopConfigForm').serializeObject();
    	            //$.post("/admin/business/shopconfig?act=editjifenconfig", params, function (data, textStatus, jqXHR) {
    	            $.post("/index.php?c=admin/business/shopconfig&a=editjifenconfig", params, function (data, textStatus, jqXHR) {
    	                if (data.success) {
    	                    $.showResult3("提示", "修改成功", 1500);
    	                } else {
    	                    $.showResult3("出错啦", data.msg);
    	                }
    	            }, "json");
    	            return false;
    		},
    		errorPlacement: function (error, element) {
			    error.appendTo(element.parent());
			},
        });
        
        $("#BtnSave").unbind().bind('click', function (event) {
        	$('#ShopConfigForm').submit();
        });
    }

    me.addListener('jifenconfig', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['messageconfig'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.regitems = ko.observableArray();
		this.levels = ko.observableArray();
    };

	var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/messageconfig.html",function(){
			ko.applyBindings(vm,root[0]);
			loadRegItem();
		});
    }
	    
	function loadRegItem() {
        //$.getJSON("/admin/message/messageconfig?act=getregitemlist", null, function (json) {
		$.getJSON("/index.php?c=admin/message/messageconfig&a=getregitemlist", null, function (json) {
			vm.regitems(json.list);
			bindUIEvent();
        });
    }

	function bindUIEvent(){
		$("*[name=BtnSetDisplay]").unbind('click').bind('click', function (event) {
			var nameinput = $(this).closest("tr").find("input[name=ItemEnName]");
			var name = nameinput.val();
			//$.getJSON("/admin/message/messageconfig?act=SetRegItemDisplay", utils.params({enName: name,isShow: $(this).attr("IsShow")}), function (json) {
			$.getJSON("/index.php?c=admin/message/messageconfig&a=SetRegItemDisplay", utils.params({enName: name,isShow: $(this).attr("IsShow")}), function (json) {
				if(json.success){
					loadRegItem();
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });

        $("*[name=BtnSetRequire]").unbind('click').bind('click', function (event) {
			var nameinput = $(this).closest("tr").find("input[name=ItemEnName]");
			var name = nameinput.val();
			//$.getJSON("/admin/message/messageconfig?act=SetRegItemRequired", utils.params({enName: name,isRequired: $(this).attr("IsRequired")}), function (json) {
			$.getJSON("/index.php?c=admin/message/messageconfig&a=SetRegItemRequired", utils.params({enName: name,isRequired: $(this).attr("IsRequired")}), function (json) {
				if(json.success){
					loadRegItem();
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });
	}

    me.addListener('messageconfig', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['messageedit'] = function () {
	
    var me = this;
	
	var ViewModel = function() {
        this.setData = function (data) {
			for(var key in data){
				if(typeof(data[key]) == "object") this[key] = ko.observableArray(data[key]);
				else this[key] = ko.observable(data[key]);
			}
		};
    };
	
	var vm = new ViewModel();
	var myroot = null;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/messageedit.html?v=" + Math.random(), function() {

			$("#MsgEditForm").validate({
                rules: {
                    tbTitle: "required",
                    tbContent: "required"
                },
                messages: {
                    tbTitle: { required: "标题不能为空" },
                    tbContent: { required: "内容不能为空" }
                },
				submitHandler: function (form) {
					submitForm();
					return false;
				}
			});
			
			myroot = root[0];
			$('#BtnSave').floatSaveBtn();
			if(me.currentModule.params && me.currentModule.params.id) loadMsgInfo();
			else initUE();
		});
    }
	
    function loadMsgInfo() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        //$.getJSON("/admin/message/message?act=GetInfo", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/message/message&a=GetInfo", utils.params(params), function (json) {
			vm.setData(json.info);
			ko.applyBindings(vm,myroot);
        });
    }

    function submitForm(form) {
        var params = $('#MsgEditForm').serialize();
		//console.log(params);return;
        //$.post("/admin/message/message?act=Edit", params, function (json, textStatus, jqXHR) {
        $.post("/index.php?c=admin/message/message&a=Edit", params, function (json, textStatus, jqXHR) {
            if (json.success) {
                $.showResult(true, "保存成功", 1500, function () {
                    me.execCommand('go', { a: 'business', b: 'messagelist' });
                });
            } else {
                $.showResult(false, json.msg);
            }
		},"json");
    }

    me.addListener('messageedit', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['messagelist'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.msglist = ko.observableArray();
        this.setData = function (data) { this.msglist(data); };
		this.getTime = function(time){
			return time.replace(/T/g," ").replace(/(\.\d+)/g," ");
		}
    };

	var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/messagelist.html?v=" + Math.random(),function(){
			bindUIEvent();
			ko.applyBindings(vm,root[0]);
			loadMessageList(1);
		});
    }
	 
	var curpage = 1;
	var itemcount = 0;
    function loadMessageList(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(),reply : $("#reply").val(), status: $("#status").val(), page: page, pagesize: 20 };
        //$.getJSON("/admin/message/message?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/message/message&a=getlist", utils.params(params), function (json) {
            vm.setData(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadMessageList(page); });
                $("#pagination").show();
            }

            bindGridEvent();
        });
    }

	function showResult(title,msg,autoClose) {
		$("#ResultDialog").remove();
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
		if(autoClose && autoClose > 0){
			setTimeout(function(){ $("#ResultDialog").remove(); },autoClose);
		}
	}

	function bindUIEvent(){
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadMessageList(1);
        });
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'messageedit', params: { id: $(this).attr("MsgID")} });
			return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			//$.getJSON("/admin/message/message?act=Delete", utils.params({id:$(this).attr("MsgID")}), function (json) {
			$.getJSON("/index.php?c=admin/message/message&a=Delete", utils.params({id:$(this).attr("MsgID")}), function (json) {
				if(json.success){
					if(itemcount > 1) loadMessageList(curpage);
					else loadMessageList(1);
				}else{
				    $.showResult(false, json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetStatus]").unbind('click').bind('click', function (event) {
			//$.getJSON("/admin/message/message?act=setstatus", utils.params({id:$(this).attr("MsgID"),status: $(this).attr("Status")}), function (json) {
			$.getJSON("/index.php?c=admin/message/message&a=setstatus", utils.params({id:$(this).attr("MsgID"),status: $(this).attr("Status")}), function (json) {
				if(json.success){
					loadMessageList(curpage);
				}else{
				    $.showResult(false, json.msg);
				}
			});
			return false;
        });			
    }

    me.addListener('messagelist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['orderedit'] = function () {
	
    var me = this;
	
	utils.addScript("/framework/ref/scripts/jquery-xml-to-json.js");

	var ViewModel = function() {
        this.setData = function (data) {
			for(var key in data){
				this[key] = data[key];
				if(key == "Goods") this.goods = $.xml2json(data[key]);
			}
		};
		this.goods = [];
		this.getProductName = function (name, norms) {
		    var s = name;
		    if (norms && norms != "默认价格") s += ' <font color="red">' + norms + '</font>';
		    return s;
		};
		this.getTime = function (time) {
		    if (time)
		        return time.replace(/T/g, " ").replace(/\.\d+$/, '');
		    return time;
		};
		this.compareTime = function (t1, t2) {
		    return new Date(t1).getTime() - new Date(t2).getTime();
		};
		this.formatCurrency = function (num) {
		    num = (num + '').replace(/\$|\,/g, '');
		    if (isNaN(num))
		        num = "0";
		    sign = (num == (num = Math.abs(num)));
		    num = Math.floor(num * 100 + 0.50000000001);
		    cents = num % 100;
		    num = Math.floor(num / 100) + '';
		    if (cents < 10)
		        cents = "0" + cents;
		    for (var i = 0; i < Math.floor((num.length - (1 + i)) / 3) ; i++)
		        num = num.substring(0, num.length - (4 * i + 3)) + ',' +
                num.substring(num.length - (4 * i + 3));
		    return (((sign) ? '' : '-') + num + '.' + cents);
		}
    };
	
	var vm = new ViewModel();
	var myroot = null;
	function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_SHOP')) {
            root.load("/index.php?c=admin/page/Versiontip&page=orderedit");
            return;
        }
        root.loadHtmlTpl("plugins/businesspackage/html/orderedit.html?v=" + Math.random(),function() {
			$("#OrderEditForm").validate({
                rules: {
                    tbContact: "required",
					tbAddress: "required",
					tbMobile: "required"
                },
                messages: {
                    tbContact: { required: "收货人不能为空" },
                    tbAddress: { required: "收货地址不能为空" },
                    tbMobile: { required: "联系号码不能为空" }
                },
				submitHandler: function (form) {
					submitForm();
					return false;
				}
			});

			$("#BtnReturnOrderList").unbind().click(function () {
			    if (me.currentModule.params && me.currentModule.params.searchParams) {
			        me.execCommand('go', { a: 'business', b: 'orderlist', params: { searchParams: me.currentModule.params.searchParams } });
			    } else {
			        history.back();
			    }
			});

			$("#BtnSetLogisticsInfo").unbind().click(function(){
				$("#SetLogisticsInfoDialog").remove();
				$("body").append("<div id='SetLogisticsInfoDialog' style='display'></div>");
				var onload = function(){
					
					$("#OrderLogisForm").validate({
						rules: {
							txtLogisticsName: "required",
							txtInvoiceNo: "required"
						},
						messages: {
							txtLogisticsName: { required: "物流公司名称不能为空" },
							txtInvoiceNo: { required: "物流发货单号不能为空" }
						},
						submitHandler: function (form) {
							var params = $('#OrderLogisForm').serialize();
							$.post("/index.php?c=admin/order/order&a=SetLogisticsInfo",params,function(data, textStatus, jqXHR){
//							$.post("/admin/order/order?act=SetLogisticsInfo",params,function(data, textStatus, jqXHR){
								if(data.success){
									$("#SetLogisticsInfoDialog").remove();
									$.showResult(true, "物流信息设置成功", 3000);
									setTimeout(function () {
									    window.location.reload();
									}, 2000);
								}else{
								    $.showResult(false, "物流信息设置失败：" + data.msg);
								}
							},"json");
							return false;
						}
					});

					var form = $("#OrderLogisForm");
					$("input[name=tbOrderID]",form).val(OrderInfo.OrderID);
					$("input[name=txtLogisticsName]",form).val(OrderInfo.LogisticsName);
					$("input[name=txtInvoiceNo]",form).val(OrderInfo.InvoiceNo);
					$("#SetLogisticsInfoDialog").dialog({ resizable: false, title: "设置订单物流信息", modal: true, width: 500, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
				}
				$("#SetLogisticsInfoDialog").loadHtmlTpl("plugins/businesspackage/html/orderLogisticsInfo.html",onload);
			});

			$('#btnUseDefaultRefunds').off().click(function () {
			    $('#refundsForm [name=contact]').val(shopcfg.RefundsDefaultContact ? shopcfg.RefundsDefaultContact : '');
			    $('#refundsForm [name=contactNumber]').val(shopcfg.RefundsDefaultContactNumber ? shopcfg.RefundsDefaultContactNumber : '');
			    $('#refundsForm [name=address]').val(shopcfg.RefundsDefaultAddr ? shopcfg.RefundsDefaultAddr : '');
			    $('#refundsForm [name=reply]').val(shopcfg.RefundsDefaultReply ? shopcfg.RefundsDefaultReply : '');
			});

			$('#btnEditDefaultRefunds').off().click(function () {
			    $('#refundsDialog').modal('hide');
			    setTimeout(function () {
			        me.execCommand('go', { a: 'business', b: 'shoppingmallconfig' });
			    }, 1000);
			});

			$('#btnArgeeRefund,#btnRejectRefund').off().on('click', function () {
			    var isAgree = $(this).attr('isagree');
			    if (confirm(isAgree == 1 ? "确定同意退款？" : "确定拒绝退款？")) {
			        $('#refundsForm [name=isAgree]').val(isAgree);
			        var data = $('#refundsForm').serializeArray();
			        $.ajax({
			            type: 'get',
//			            url: '/admin/order/refunds?act=edit',
			            url: '/index.php?c=admin/order/refunds&a=edit',
			            data: data,
			            dataType: 'json',
			            success: function (json) {
			                if (!json.success) {
			                    alert(json.msg);
			                    return;
			                }
			                alert('退款状态已修改成功');
			                $('#refundsDialog').modal('hide');
			                window.location.reload();
			            },
			            error: function (req) {
			                alert(req.responseText);
			            }
			        })
			    }
			});

			$('#slStatus').off().on('change', function () {
			    if (this.value == 1 || this.value == 7) {
			        $('#btnLogisticsInfoWrap').show();
			    } else {
			        $('#btnLogisticsInfoWrap').hide();
			    }
			    if (this.value != 0) {
			        $('#logisticsInfoWrap').show();
			    } else {
			        $('#logisticsInfoWrap').hide();
			    }
			})
			
			$('#btnModifyMoney').off().on('click', function () {
			    var self = $(this);
			    //if (isOrderContainFenXiao || isOrderContainAgent) {
			    //    $('#modifyMoneyDialog').appendTo('body').modal('show');
			    //    $('#modifyMoneyDialog .btnGoOnModifyMoney').off().on('click', function () {
			    //        $('#tbNewMoney,#btnConfirmNewMoney,#btnCancelNewMoney').show();
			    //        $('#money, #btnModifyMoney').hide();
			    //        $('#tbNewMoney').val($('#money').attr('currentMoney'));
			    //        $('#modifyMoneyDialog').modal('hide');
			    //        return false;
			    //    });
			    //} else {
			        $('#tbNewMoney,#btnConfirmNewMoney,#btnCancelNewMoney').show();
			        $('#money, #btnModifyMoney').hide();
			        $('#tbNewMoney').val($('#money').attr('currentMoney'));
			    //}
			});

			$('#btnConfirmNewMoney').off().on('click', function () {
			    if (isNaN(Number($('#tbNewMoney').val()))) {
			        alert('请输入数字');
			        return;
			    }
			    $('#tbNewMoney,#btnConfirmNewMoney,#btnCancelNewMoney').hide();
			    $('#money, #btnModifyMoney').show();
			    $('#tbHasModifiedMoney').val(1);
			    $('#money').attr('currentMoney', $('#tbNewMoney').val()).text($('#tbNewMoney').val());
			    //$('#originMoneyHint').text('(' + $('#money').attr('originMoney')+ ')');
			    toggleOriginMoneyHint();
			});

			$('#btnCancelNewMoney').off().on('click', function () {
			    $('#tbNewMoney,#btnConfirmNewMoney,#btnCancelNewMoney').hide();
			    $('#money, #btnModifyMoney').show();
			});

			myroot = root[0];
			if(me.currentModule.params && me.currentModule.params.id) loadMsgInfo();
			else initUE();
		});
    }
	
	var OrderInfo = null;
	var intervalForTable = null;
	var shopcfg = {};
	var refundsLogs = [];
    function loadMsgInfo() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        $.getJSON("/index.php?c=admin/order/order&a=GetInfo", utils.params(params), function (json) {
//        $.getJSON("/admin/order/order?act=GetInfo", utils.params(params), function (json) {
            if (!json.success) {
                alert(json.msg);
                return;
            }
            OrderInfo = json.info;
            if (json.user) {
                json.info.UserName = json.user.NickName;
            } else {
                json.info.UserName = '已删除';
            }
            
            if(me.currentModule.params.status)
		    {
				$('#slStatus').val(me.currentModule.params.status);
				$('#slStatus').trigger('change');
				json.info.Status='';
		    }
            
            json.info.canModifyMoney = json.canModifyMoney;
			vm.setData(json.info);

			ko.applyBindings(vm, myroot);

			shopcfg = json.shopcfg || {};

			var goodsList = vm.goods.OrderGoods || [];
			refundsLogs = json.refundslogs || [];
			if (!$.isArray(goodsList)) goodsList = [goodsList];

			for (var i = 0; i < goodsList.length; i++) {
			    for (var j = 0; j < refundsLogs.length; j++) {
			        if (goodsList[i].Pkey == refundsLogs[j].Pkey) {
			            var statusText = '';
			            if (refundsLogs[j].Status == 0) {
			                statusText = '<font style="color:#337ab7">退款申请中</font>';
			            } else if (refundsLogs[j].Status == 1) {
			                statusText = '<font style="color:#4CAF50">已同意退款</font>';
			            } else if (refundsLogs[j].Status == 2) {
			                statusText = '<font style="color:red">已拒绝退款</font>';
			            } else if (refundsLogs[j].Status == 3) {
			                statusText = '<font style="color:#337ab7">退款已完成</font>';
			            }
			            $('#productTable tbody tr').eq(i).find('.tdRefundStatus').append(statusText)

			            var sHtml = '<a href="javascript:;" class="btnEditRefund" logID=' + refundsLogs[j].ID + '>处理退款</a>';
			            $(sHtml).appendTo($('#productTable tbody tr').eq(i).find('.tdOperation'));
			            break;
			        }
			    }
			}
			
			if($.inArray(json.info.Status, [0, 7 ,8]) == -1) $("#trTradeNo").show();

			toggleOriginMoneyHint();

			bindOperationBtnEvent();
		    
        });
    }

    function bindOperationBtnEvent() {
        $('.btnRefunds').off().on('click', function () {
            var log = $(this).data('refundsLog');
            var goods = JSON.parse(log.Goods);
            $('#refundsDialog input[type=text]').val('');
            $('#refundsDialog textarea').text('')
            $('#refundsDialog [limitshow=1]').show();
            $('#refundsLogID').val(log.ID);
            $('#refundsDialog .reason').text(log.Reason);
            $('#refundsDialog .productName').text(goods.ProductName);
            $('#refundsDialog .price').text('￥' + goods.ProductPrice);
            $('#refundsDialog .productNum').text('X ' + goods.ProductNum);
            $('#refundsDialog .total').text('￥' + parseFloat(goods.ProductPrice) * parseFloat(goods.ProductNum));
            $('#refundsDialog').modal();
        });

        $('.btnEditRefund').off().on('click', function () {
            $('#refundsDialog input[type=text]').val('');
            $('#refundsDialog textarea').text('')
            var logID = $(this).attr('logID');
            var list = refundsLogs;
            console.log(list)
            if (list && list.length > 0) {
                for (var i = 0; i < list.length; i++) {
                    var log = list[i];
                    if (log.ID == logID) {
                        //$('#refundsDialog [limitshow=1]').show();
                        $('#refundsLogID').val(log.ID);
                        $('#refundsDialog .reason').text(log.Reason);
                        $('#refundsDialog .productName').text(log.ProductName);
                        $('#refundsDialog .productNum').text(log.ProductNum);
                        $('#refundsDialog .total').text('￥' + log.RtnMoney);
                        $('#refundsDialog [name=contact]').val(log.Contact);
                        $('#refundsDialog [name=contactNumber]').val(log.ContactNumber);
                        $('#refundsDialog [name=address]').val(log.Address);
                        $('#refundsDialog [name=reply]').text(log.Reply);
                    }
                }
            }
            $('#refundsDialog').modal('show');
        });
         /*查询物流*/
		$('#viewLogisticsInfo').off('click').on('click',function(){
			var company = $('.company').html();
			var oddnum = $('.oddnum').html();
			$('.promptModal3').modal('show');
			$('.promptModal3').find('.modal-content');
			$('#iframechaxuan').attr('src','http://m.kuaidi100.com/index_all.html?type='+company+'&postid='+oddnum)
			
			//window.open('http://m.kuaidi100.com/index_all.html?type='+company+'&postid='+oddnum); 
			
		})
		
    }

    function checkHasModifyOrderMoney() {
        var originMoney = parseFloat($('#money').attr('originMoney'));
        //var modifiedMoney = parseFloat($('#money').attr('modifiedMoney'));
        var currentMoney = parseFloat($('#money').attr('currentMoney'));
        return originMoney != currentMoney;
    }

    function toggleOriginMoneyHint() {
        checkHasModifyOrderMoney() ? $('#originMoneyHint').show() : $('#originMoneyHint').hide();
    }

    function submitForm(form) {
        if ($('[name=tbHasModifiedMoney]').val() == 1 && !/^([0-9]+)(\.[0-9]+)?$/.test($('[name=tbNewMoney]').val() + '')) {
            alert('新金额必须为数字');
            return;
        }
        var params = $('#OrderEditForm').serialize();
        $.post("/index.php?c=admin/order/order&a=Edit", params, function (json, textStatus, jqXHR) {
//        $.post("/admin/order/order?act=Edit", params, function (json, textStatus, jqXHR) {
            if (json.success) {
                $.showResult(true, "修改成功", 1000, function () {
                    if (me.currentModule.params && me.currentModule.params.searchParams) {
                        me.execCommand('go', { a: 'business', b: 'orderlist', params: { searchParams: me.currentModule.params.searchParams } });
                    } else {
                        me.execCommand('go', { a: 'business', b: 'orderlist' });
                    }
                });
            } else {
                $.showResult(false, json.msg);
            }
		},"json");
    }

    me.addListener('orderedit', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['orderlist'] = function () {

    var me = this;
	
    utils.addScript("/framework/ref/scripts/jquery-xml-to-json.js");
    

	var ViewModel = function () {
	    this.orderlist = ko.observableArray();
	    this.enableAcquireCustoms = ko.observable(0);
        this.setList = function (list) {
            list = list || [];
            for (var i = 0; i < list.length; i++) {
                var goods = $.xml2json(list[i].Goods) || {};
                if (goods.OrderGoods) {
                    if ($.isArray(goods.OrderGoods)) list[i].OrderGoods = goods.OrderGoods;
                    else list[i].OrderGoods = [goods.OrderGoods];
                } else {
                    list[i].OrderGoods = {};
                }
            }
            this.orderlist(list);
        }
        this.getTime = function (time) {
            if (time) {
                return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
            }
		}
        this.getStatusHtml = function (status) {
            for (var i = 0; i < aStatus.length; i++) {
                if (aStatus[i][0] == status)
                    return '<font style="color:' + aStatus[i][2] + ';">' + aStatus[i][1] + '</font>';
            }
        };
        this.formatCurrency = function(num) {
            num = (num + '').replace(/\$|\,/g,'');
            if(isNaN(num))
                num = "0";
            sign = (num == (num = Math.abs(num)));
            num = Math.floor(num*100+0.50000000001);
            cents = num%100;
            num = Math.floor(num / 100) + '';
            if(cents<10)
                cents = "0" + cents;
            for (var i = 0; i < Math.floor((num.length-(1+i))/3); i++)
                num = num.substring(0,num.length-(4*i+3))+','+
                num.substring(num.length-(4*i+3));
            return (((sign)?'':'-') + num + '.' + cents);
        }
        this.compareTime = function (t1, t2) {
            return new Date(t1).getTime() - new Date(t2).getTime();
        }
        this.getDate = function (time) {
            if (time) {
                return time.replace(/\s.*$/gi, " ");
            }
        }
    };

	var vm = new ViewModel();

	function initUI(root) {
		root.children().remove();
		if (!me.hasLicensePerm('ENABLE_SHOP')) {
            root.load("/index.php?c=admin/page/Versiontip&page=orderlist");
            return;
        }
		root.loadHtmlTpl("plugins/businesspackage/html/orderlist.html?v=" + Math.random(), function () {
			bindUIEvent();
			ko.applyBindings(vm, root[0]);
			loadStatusCount();
			loadStroelist();
			$('#combineStatusList li a').eq(0).click();

			$(function() {
				$( "#TimeBegin" ).datepicker({
					format: "yyyy/mm/dd",
					defaultDate: "+1w",
					changeMonth: true,
					dateFormat: "yy/mm/dd",
					language: "zh-CN",
					orientation: "bottom auto",
					showOptions: { direction: "down" },
					onClose: function( selectedDate ) {
						$( "#TimeEnd" ).datepicker( "option", "minDate", selectedDate );
					}
				});
				$( "#TimeEnd" ).datepicker({
					format: "yyyy/mm/dd",
					defaultDate: "+1w",
					changeMonth: true,
					dateFormat: "yy/mm/dd",
					language: "zh-CN",
					orientation: "bottom auto",
					showOptions: { direction: "down" },
					onClose: function( selectedDate ) {
						$( "#TimeBegin" ).datepicker( "option", "maxDate", selectedDate );
					}
				});
			});
		});
	}
	    
	var curpage = 1;
	var itemcount = 0;
	var clip = null;
	var searchParams = {};

	var aStatus = [
		['0', '未付款', '#EB4646'],
		['1', '已付款，等待发货', '#FF9A29'],
        ['3', '等待确认收货', '#50BB13'],
        ['7', '货到付款，等待发货', '#FF9A29'],
        ['8', '货到付款，等待确认收货', '#50BB13'],
        ['2', '交易成功', '#03860F'],
		['4', '交易关闭', '#999999'],
		['5', '退款处理中', '#ff0000'],
		['6', '退款完成', '#03860F'],
		['9', '已付款，未取货', 'red']
	];

	function loadOrderlist(page, params) {
	    params = params || { sid: me.sid, TimeBegin: $("#TimeBegin").val(), TimeEnd: $("#TimeEnd").val(), keyword: $("#keyword").val(), status: $("#status").val(), orderby: $("#orderby").val(), timetype: $("#timetype").val(), page: page, pagesize: 20 ,store_uid: $("#belong_store").val() };
	    $.getJSON("/index.php?c=admin/order/order&a=getlist", utils.params(params), function (json) {
//	    $.getJSON("/admin/order/order?act=getlist", utils.params(params), function (json) {
	        vm.setList(json.list);
	        vm.enableAcquireCustoms(json.enableAcquireCustoms);
			$('#selectAll').prop("checked", false);
			curpage = json.curpage;
			itemcount = json.list.length;
			if(json.pagecount < 2) $("#pagination").hide(); else {
				//pageNav 方法定义在 /core/util.js 里
				$("#pagination").pageNav(json.curpage, json.pagecount, 10, function(page) { loadOrderlist(page); });
				$("#pagination").show();
			}
			if(json.statuscount)
			{
				$('#statusAll').text(json.statuscount.statusAll);
                $('#statusNoPay').text(json.statuscount.statusNoPay);
                $('#statusOrderPay').text(json.statuscount.statusOrderPay);
                $('#statusOrderOver').text(json.statuscount.statusOrderOver);
                $('#statusOrderRefunds').text(json.statuscount.statusOrderRefunds);
                $('#statusOrderSend').text(json.statuscount.statusOrderSend);
                $('#statusOrderPickup').text(json.statuscount.statusOrderPickup);
			}
			
			bindGridEvent();
			searchParams = params;
		});
		
	}

    function loadStatusCount() {
    	$.getJSON("/index.php?c=admin/order/order&a=GetStatusCount", { queryStatus: "statusAll,statusNoPay,statusOrderPay,statusOrderOver,statusOrderRefunds,statusOrderSend,statusOrderPickup" }, function (json) {
//        $.getJSON("/admin/order/order?act=GetStatusCount", { queryStatus: "statusAll,statusNoPay,statusOrderPay,statusOrderOver,statusOrderRefunds,statusOrderSend" }, function (json) {
            if (json.success) {
                $('#statusAll').text(json.statusObj.statusAll);
                $('#statusNoPay').text(json.statusObj.statusNoPay);
                $('#statusOrderPay').text(json.statusObj.statusOrderPay);
                $('#statusOrderOver').text(json.statusObj.statusOrderOver);
                $('#statusOrderRefunds').text(json.statusObj.statusOrderRefunds);
                $('#statusOrderSend').text(json.statusObj.statusOrderSend);
                $('#statusOrderPickup').text(json.statusObj.statusOrderPickup);
            }
        });
        
    }
    
    function loadStroelist(){
    	$.getJSON("/index.php?c=admin/order/order&a=GetStoreList",null,function(json){
    		if(json.success)
    		{
    		    $('#belong_store').html('');
    		    $('#belong_store').prepend('<option value="">--选择店铺--</option>');
    		    for(var a in json.list)
    		    	$('#belong_store').append('<option value="'+json.list[a].WebUserID+'">'+json.list[a].StoreName+'</option>');
    		}

    	});
    }

	function getSelectedArtIDs(){
		var array = new Array();
		$(".chkOrder:checked").each(function () {
			array.push($(this).attr('orderid'));
		});
		var id = array.join(',');
		return id;
		
	}

	function showResult(title,msg,autoClose) {
		$("#ResultDialog").remove();
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
		if(autoClose && autoClose > 0){
			setTimeout(function(){ $("#ResultDialog").remove(); },autoClose);
		}
		
	}

	function bindUIEvent(){
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadOrderlist(1);
        });

		$('#selectAll').unbind().on('click', function () {
		    $('.chkOrder').prop('checked', $(this).prop('checked'));
		});
		
		$(document).off('click.chkOrder').on('click.chkOrder', '.chkOrder', function () {
		    $('#selectAll').prop('checked', $('.chkOrder').length == $('.chkOrder:checked').length);
		});
		
		$('#BtnDelSelected').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一条记录');
			else{
				if(confirm("确认删除吗?")){
				//	$.getJSON("/admin/order/order?act=delete", utils.params({'id': id}), function (json) {
					$.getJSON("/index.php?c=admin/order/order&a=delete", utils.params({'id': id}), function (json) {
						if(json.success){
							if(id.split(',').length >= itemcount) loadOrderlist(1);
							else loadOrderlist(curpage);
						}else{
							showResult("出错啦",json.msg);
						}
					});
				}
			}
			
			return false;
		});
		$(document).off('click.BtnExportLogisticstable').on('click.BtnExportLogisticstable', '#BtnExportLogisticstable', function () {
		    var action = $(this).attr('action');
		    var html = '<div class="alert  clearfix form-group" role="form" style="margin:-15px;font-family:Microsoft YaHei;">';
		    html += '<div class="exportdiv clearfix"><span>类型:</span>'
		    html += '<label style="margin-right: 10px;"><input type="radio" name="exportType" value="exportwuliubiao">物流</label>';
		    html += '<label style="margin-right: 10px;"><input type="radio" name="exportType" value="exportcsv">订单</label>';
		    if (vm.enableAcquireCustoms() == 1) {
		        html += '<label style="margin-right: 10px;"><input type="radio" name="exportType" value="exportxlsforacquirecustoms">报关</label>';
		    }
		    html += '</div>';
		    html += '<div class="exportdiv clearfix"><span>导出:</span><div>最多<input class="form-control" type="text" id="exportRowCount" value="10000" />条记录</div></div>';
		    html += '<div class="exportdiv clearfix" style="display:none;height: auto;" related="exportwuliubiao">';
		    html += '<span>订单状态:</span>';
		    html += '<div style="height: auto;">';
		    html += '<p style="margin: 0;"><input type="checkbox" value="1" name="changeState">导出的"待发货"订单状态更改为"等待确认收货"</p>';
		    html += '<p style="margin: 0;"><input type="checkbox" value="2" name="changeState">导出的"货到付款，待发货"订单状态更改为"货到付款，已发货"</p>';
		    html += '</div>';
		    html += '</div>';
		    html += '<div class="exportdiv clearfix" style="display:none;" related="exportwuliubiao"><span>物流打印软件:</span><div>建议软件下载地址<a href="http://www.f-dou.com/" target="_blank" style="color:red;">"下载软件"</a>,你可以选择其他的打印软件。</div></div>';
		    html += '</div>';

		    var dialog = bootbox.dialog({
		        title: '订单信息导出',
		        message: html,
		        className: 'exportModal',
		        buttons: {
		            confirm: {
		                label: "确定",
		                className: "btn-success",
		                callback: function () {
		                    var action = $('.exportModal').find('[name=exportType]:checked').val();
		                    var changeState = 0;
		                    $('[name=changeState]:checked').each(function () {
		                        changeState += this.value + ',';
		                    });
		                    var params = {
		                        sid: me.sid,
		                        //act: action,
		                        a: action,
		                        TimeBegin: $("#TimeBegin").val(),
		                        TimeEnd: $("#TimeEnd").val(),
		                        keyword: $("#keyword").val(),
		                        status: $("#status").val(),
		                        orderby: $('#orderby').val(),
		                        timetype: $('#timetype').val(),
		                        page: 1,
		                        pagesize: $('#exportRowCount').val(),
		                        changeState: changeState
		                    };
		                    if (action == 'exportxlsforacquirecustoms') {
		                        window.open("/admin/order/order?act=exportxlsforacquirecustoms&" + $.param(params));
		                    } else {
		                        window.open("/index.php?c=admin/order/order&" + $.param(params));
		                    }
		                    
		                }
		            },
		            close1: {
		                label: "关闭",
		                className: "btn-default",
		                callback: function () {
		                    $(this).modal('hide');
		                }
		            }

		        }
		    });
		    dialog.find('[name=exportType]').off().on('change', function () {
		        var action = $('.exportModal').find('[name=exportType]:checked').val();
		        if (action == 'exportwuliubiao') {
		            dialog.find('[related=exportwuliubiao]').show();
		        } else {
		            dialog.find('[related=exportwuliubiao]').hide();
		        }
		    });
		    dialog.find('[name=exportType][value=exportwuliubiao]').click();
		});

		$(document).off('click.BtnExport').on('click.BtnExport', '#BtnExport, #BtnExportForAcquireCustoms', function () {
			var action = $(this).attr('action');
			var html = '<div class="alert alert-info clearfix form-group" role="form">';
			html += '<label class="" style="float:left;line-height:32px;">导出 最多</label>';
			html += '<input class="form-control" style="float:left;width:120px;margin:0 10px;" type="text" id="exportRowCount" value="10000" />';
			html += '<label class="" style="float:left;line-height:32px;">条记录</label>';
			html += '</div>';

			bootbox.dialog({
			    title: '导出订单',
			    message: html,
			    buttons: {
			        confirm: {
			            label: "确定",
			            className: "btn-success",
			            callback: function () {
			                var params = {
			                    sid: me.sid,
//			                    act: action,
			                    a:action,
			                    TimeBegin: $("#TimeBegin").val(),
			                    TimeEnd: $("#TimeEnd").val(),
			                    keyword: $("#keyword").val(),
			                    status: $("#status").val(),
			                    orderby: $('#orderby').val(),
			                    timetype: $('#timetype').val(),
			                    page: 1,
			                    pagesize: $('#exportRowCount').val()
			                };
			                if (action == 'exportxlsforacquirecustoms') {
			                    window.open("/admin/order/order?act=exportxlsforacquirecustoms&" + $.param(params));
			                } else {
			                    window.open("/index.php?c=admin/order/order&" + $.param(params));
			                }
//			                window.open("/admin/order/order?" + $.param(params));
			            }
			        },
			        close1: {
			            label: "关闭",
			            className: "btn-default",
			            callback: function () {
			                $(this).modal('hide');
			            }
			        }

			    }
			});
		});

		$('#combineStatusList a').off().on('click', function () {
		    $('#status').html('');
		    var relstatus = $(this).attr('relstatus');
		    $('#status').prepend('<option value="' + relstatus + '">--订单状态--</option>');
		    if (relstatus == '') {
		        for (var i = 0; i < aStatus.length; i++) {
		            $('#status').append('<option value="' + aStatus[i][0] + '">' + aStatus[i][1] + '</option>');
		        }
		    } else {
		        var aRelstatus = relstatus.split(',');
		        for (var i = 0; i < aStatus.length; i++) {
		            if ($.inArray(aStatus[i][0], aRelstatus) > -1) {
		                $('#status').append('<option value="' + aStatus[i][0] + '">' + aStatus[i][1] + '</option>');
		            }
		        }
		    }
		       if (me.currentModule.params && me.currentModule.params.searchParams) {
		        try {
		            searchParams = JSON.parse(decodeURIComponent(me.currentModule.params.searchParams));
		            $("#keyword").val(searchParams.keyword);
		            $("#TimeBegin").val(searchParams.TimeBegin);
		            $("#TimeEnd").val(searchParams.TimeEnd);
		            $("#keyword").val(searchParams.keyword);
		            if(searchParams.status) 	
		            	$("#status").val(searchParams.status);
		            else
		            	$("#status").val(relstatus);
		            $("#orderby").val(searchParams.orderby);
		            $("#timetype").val(searchParams.timetype);

		            loadOrderlist(1,searchParams);
		        } catch (ex) {
		        	 loadOrderlist(1);
		         }
			}else{
				loadOrderlist(1);
			}
			$('#combineStatusList li a').removeClass("btn-success")
		    $(this).addClass("btn-success") 
		});
		
		$("#btnfy").unbind('click').bind('click', function (event) {
	        var params = {};
			params['OrderID'] = $("#fyorderid").val();
			params['AddFinance'] = $("#fyaddfinance").prop('checked') ? '1' : '0';
			params['Amount'] = $("#fyadmount").val();
			var amount = parseFloat(params['Amount']);
			if(params['AddFinance'] == '1' && (isNaN(amount) || amount <= 0)){
				alert('请输入入款金额');
				return false;
			}
			$("#btnfy").prop('disable',true);
			$.getJSON("/index.php?c=admin/order/order&a=Repay", params, function (json) {
//			$.getJSON("/admin/order/order?act=Repay", params, function (json) {
				if(json.success){
					$("#btnfy").prop('disable',false);
					$('#myModal').modal('hide');
					$('#fenyong' + params['OrderID']).hide();
					$.showResult('提示','操作成功',2000);
				}else{
					$("#btnfy").prop('disable',false);
					$('#myModal').modal('hide');
					$.showResult('出错啦',json.msg);
				}
			});
			return;
	    });

		$("#fyaddfinance").unbind().bind('change', function (event) {
			var checked = $(this).prop("checked");
			if(checked) $("#fymoneyin").show();
			else $("#fymoneyin").hide();
		});
	}

	function bindGridEvent() {

	    $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
	        var searchParamsStr = JSON.stringify(searchParams);
	        searchParamsStr = encodeURIComponent(searchParamsStr);
	        me.execCommand('go', { a: 'business', b: 'orderedit', params: { id: $(this).attr("OrderID"), searchParams: searchParamsStr } });
	        return false;
	    });

		$("*[name=BtnFenYong]").unbind('click').bind('click', function (event) {
			var orderid = $(this).attr("OrderID");
			$("#spanfyorderid").html(orderid);
			$("#fyorderid").val(orderid);
			$.getJSON("/index.php?c=admin/order/order&a=GetInfo", {id:orderid}, function (json) {
//			$.getJSON("/admin/order/order?act=GetInfo", {id:orderid}, function (json) {
				$("#fyadmount2").html(json.totalmoney);
			});
	        $('#myModal').modal();
			$("#fyaddfinance").prop('checked',true);
			$("#fyaddfinance").change();
			$("#fyadmount").val('');
	    });

	    $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
	        if (!confirm("确认删除？")) return false;
	        var searchParamsStr = JSON.stringify(searchParams);
	        $.getJSON("/index.php?c=admin/order/order&a=Delete", utils.params({ id: $(this).attr("OrderID"), searchParams: searchParamsStr }), function (json) {
//	        $.getJSON("/admin/order/order?act=Delete", utils.params({ id: $(this).attr("OrderID"), searchParams: searchParamsStr }), function (json) {
	            if(json.success){
	                if(itemcount > 1) loadOrderlist(curpage);
	                else loadOrderlist(1);
	            }else{
	                showResult("出错啦",json.msg);
	            }
	        });
	        return false;
	    });

	    if (typeof ZeroClipboard == 'undefined') {
	        utils.addScript("/share/ueditor/third-party/zeroclipboard/ZeroClipboard.min.js", function () {
	            initZeroClipboard();
	        });
	    } else {
	        initZeroClipboard();
	    }
	    
	    /*查询物流*/
		$('.chaxunbtn').off('click').on('click',function(){
			var company = $(this).closest(".orderCont").find('.company').html();
			var oddnum = $(this).closest(".orderCont").find('.oddnum').html();
			$('.promptModal3').modal('show');
			$('.promptModal3').find('.modal-content');
			$('#iframechaxuan').attr('src','http://m.kuaidi100.com/index_all.html?type='+company+'&postid='+oddnum)
			//window.open('http://m.kuaidi100.com/index_all.html?type='+company+'&postid='+oddnum); 
			
		})
	    
	    
	    
    }

    function initZeroClipboard() {
        if (clip) {
            clip.destroy();
            clip = null;
        }
        if (clip == null) {
            clip = new ZeroClipboard($('.btnCopyInvoiceNo'));
            clip.on("copy", function (evt) {
                evt = evt || window.event;
                var target = evt.target;
                if (target) {
                    var text = $(target).closest('tr').find('.InvoiceNo').text();
                    clip.setText(text);
                    alert('复制成功，编号：' + text);
                }
            });
        }
    }

    me.addListener('orderlist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['productbatadd'] = function () {

    var me = this;
					
	var myroot = null;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/productbatadd.html",function() {
            me.execCommand('initContentNav', root);
			$(".myEditSuccess").find(".close").unbind('click').click(function(){
				me.execCommand('go', { a: 'business', b: 'productlist' });
				return false;
			});

			$(".myAlertError").find(".close").unbind('click').click(function(){
				$("#divForm").show();
				$(".myAlertError").hide();
				return false;
			});

			$("#BtnAddProImg").unbind().click(function(){
				$("#Filedata").click();
				$("#Filedata").unbind().change(function(){
					if($("#Filedata").val() != "") doUpload();
				});
			});

			$("#BtnSaveBatAdd").unbind().click(function(){
				submitForm();
			});
			$('#BtnSaveBatAdd').floatSaveBtn();
			loadClsList();
			initSwfUpload();
			myroot = root[0];
		});
    }

	var swfu;
	function initSwfUpload(){
		if ($("#swfUploadPlaceholder").is("span")) {
			var params = {};
			if(me.currentModule.params && me.currentModule.params.id) params["Pid"] = me.currentModule.params.id;
			params['ssid'] = getCookie("sid") || '';
            swfu = new SWFUpload({
            	upload_url: "/index.php?c=admin/product/productmanage&a=UploadImg&InitSiteID=" + getCookie('InitSiteID') + "&PSESSID=" + getCookie('PHPSESSID'),
//                upload_url: "/admin/product/productmanage?act=UploadImg&InitSiteID=" + getCookie('InitSiteID'),
                post_params: params,
                file_size_limit: "3 MB",
                file_types: "*.jpg;*.gif;*.png",
                file_types_description: "Image Files",
                /*file_upload_limit: "5",*/
                file_queue_error_handler: fileQueueError,
                file_dialog_complete_handler: fileDialogComplete,
                upload_progress_handler: uploadProgress,
                upload_error_handler: uploadError,
                upload_success_handler: uploadSuccess,
                upload_complete_handler: uploadComplete,
                button_image_url: "/images/swfuplod-bg.gif",
                button_placeholder_id: "swfUploadPlaceholder",
                button_width: 96,
                button_height: 34,
                button_text: '<b><font color="#ffffff">添加产品</font></b>',
                button_text_top_padding: 8,
                button_text_left_padding: 15,
                button_window_mode: SWFUpload.WINDOW_MODE.OPAQUE,
                flash_url: "/share/swfupload.swf",
                custom_settings: {
                    upload_target: "FileProgressContainer"
                },
                debug: false
            });
        }
	}

	function uploadSuccess(file, serverResponse) {
        try {
			eval("var data = " + serverResponse);
            if(data.success){
				addImg(data.SmallFileName,data.fileName,data.uploadFileName);
			}else{
                $.showResult(false, data.msg);
			}
            var progress = new FileProgress(file, this.customSettings.upload_target);
            progress.setStatus("Thumbnail Created.");
            progress.toggleCancel(false);
        } catch (ex) {
            this.debug(ex);
        }
    }

	var classlist = null;
	function loadClsList() {
		$.ajax({ url: "/index.php?c=admin/product/productmanage&a=GetClassList", async: false, dataType: "json", success: function (json) {
//		$.ajax({ url: "/admin/product/productmanage?act=GetClassList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					classlist = json.list;
					for(var i = 0;i < json.list.length;i++){
						if(json.list[i].ParentID == 0){
							$("#slClassID").append("<option value='"+ json.list[i].ClassID +"'>"+ json.list[i].Name +"</option>");
							for(var j = 0;j < json.list.length;j++){
								if(json.list[j].ParentID == json.list[i].ClassID){
								    $("#slClassID").append("<option value='" + json.list[j].ClassID + "'> └- " + json.list[j].Name + "</option>");
								    for (var k = 0; k < json.list.length; k++) {
								        if (json.list[k].ParentID == json.list[j].ClassID) {
								            $("#slClassID").append("<option value='" + json.list[k].ClassID + "'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└-" + json.list[k].Name + "</option>");
								        }
								    }
								}
							}
						}
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}
	
	function doUpload(){
		var params = {};
		if(me.currentModule.params && me.currentModule.params.id) params["Pid"] = me.currentModule.params.id;
		$("#BtnAddProImg").val("正在上传，请稍候");
		$.ajaxFileUpload
		(
			{
				url: '/index.php?c=admin/product/productmanage&a=UploadImg',
				//url: '/admin/product/productmanage?act=UploadImg', //用于文件上传的服务器端请求地址
				secureuri: false, //是否需要安全协议，一般设置为false
				fileElementId: 'Filedata', //文件上传域的ID
				dataType: 'json', //返回值类型 一般设置为json
				data: params,
				success: function (data, status)
				{
				    if (data.success) {
					    addImg(data.SmallFileName, data.fileName, data.uploadFileName);
					}else{
				        $.showResult(false, data.msg);
					}
					$("#BtnAddProImg").val("添加产品");
				},
				error: function (data, status, e)
				{
				    $.showResult(false, e);
					$("#BtnAddProImg").val("添加产品");
				}
			}
		);
	}

	function addImg(smallimg,bigimg,uploadFileName){
		$(".ShowAddedImg").css("display","block");
		var siteid = getCookie("InitSiteID");
		var img = "/comdata/" + siteid + "/product/" + smallimg;
		var index = parseInt(Math.random() * 100000);
		var objImg = $('<li SmallImage="' + smallimg + '" BigImage="' + bigimg + '"><div><span></span><i><a class="icon-remove"></a></i></div><img src="' + img + '"/><input type="hidden" name="SmallImg' + index + '" value="' + smallimg + '"><input type="hidden" name="BigImg' + index + '" value="' + bigimg + '"><input class="ProName form-control" placeholder="请输入产品名称" type="text" name="ProName' + index + '" value="' + uploadFileName + '"></li>');
		$(".ShowAddedImg").append(objImg);
		objImg.find(".icon-remove").click(function(){
			var li = $(this).closest("li");
			delImg(li,li.attr("SmallImage"),li.attr("BigImage"));
		});
	}

	function delImg(liobj,smallimg,bigimg){		
		var paramsObj = {ProductID: $("#tbProductID").val(),SmallImage: smallimg,BigImage: bigimg};
		$.post("/index.php?c=admin/product/productmanage&a=DeleteImg",paramsObj,function(data, textStatus, jqXHR){
//		$.post("/admin/product/productmanage?act=DeleteImg",paramsObj,function(data, textStatus, jqXHR){
			if(data.success){
				liobj.remove();
			}else{
			    $.showResult(false, data.msg);
			}
		},"json");
	}

    function submitForm() {
		
		var nameok = true;
		$('#ProBatAddForm').find("input[type=text]").each(function(){
			if(/(ProName)/.test($(this).attr("name"))){
				if($(this).val().trim() == ""){
					alert("请输入产品名称");
					$(this).focus();
					nameok = false;
				}
			}
		});

		if(!nameok) return false;

		var params = $('#ProBatAddForm').serializeObject();
		//console.log(params);return false;
		$.post("/index.php?c=admin/product/productmanage&a=batadd",params,function(data, textStatus, jqXHR){
//		$.post("/admin/product/productmanage?act=batadd",params,function(data, textStatus, jqXHR){
		    if (data.success) {
		        $(".myEditSuccess").css({
		            opacity: 1,
		            top: ($(window).outerHeight() - $(".myEditSuccess").outerHeight()) / 2 + 'px',
		            left: ($(window).outerWidth() - $(".myEditSuccess").outerWidth()) / 2 + 'px',
		            position: 'fixed',
		            width: 'auto',
		            height: 'auto'
		        });
		        $(".myEditSuccess").slideToggle(500);
		        //$("#divForm").hide();
		        $(".myAlertError").hide();
		        setTimeout(function () {
		            $(".myEditSuccess").find(".close").click();
		        }, 1500);
		    } else {
		        $(".myAlertError").css('display', 'inline-block');
		        $(".myAlertError").css({
		            opacity: 1,
		            top: ($(window).outerHeight() - $(".myAlertError").outerHeight()) / 2 + 'px',
		            left: ($(window).outerWidth() - $(".myAlertError").outerWidth()) / 2 + 'px',
		            position: 'fixed',
		            width: 'auto',
		            height: 'auto'
		        });
		        $(".spError").html(data.msg);
		        //$("#divForm").hide();
		        $(".myEditSuccess").hide();
			}
		},"json");
		return false;
    }

    me.addListener('productbatadd', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['productclass'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
		this.array = [];
		this.tree = [];
		this.treeok = false;
		var self = this;
        this.setData = function (data) { 
        	this.array = data;
        	this.list(data);
        };
		this.getSublist = function(parentid){
			var ret = [];
			for(var i = 0;i < this.array.length;i++){
				if(this.array[i].ParentID == parentid) ret.push(this.array[i]);
			}
			return ret;
		};
		this.getRootList = function(selectValue){
			var ret = [];
			ret.push({ClassID:0, Name: '根类', Selected: false});
			for(var i = 0;i < this.array.length;i++){
				if(this.array[i].ParentID == 0){
					var obj = this.array[i];
					if(selectValue == obj.ClassID) obj['Selected'] = true;
					else obj['Selected'] = false;
					ret.push(obj);
				}
			}
			return ret;
		};
		this.getTree = function(){
			if(!this.treeok && this.array.length > 0){
				this.tree = [];
				for (var i = 0; i < this.array.length; i++) {
			        if (this.array[i].ParentID == 0) {
			            this.tree.push(this.array[i]);
			            for (var j = 0; j < this.array.length; j++) {
			                if (this.array[j].ParentID == this.array[i].ClassID) {
			                    this.array[j].Name = '└-' + this.array[j].Name;
			                    this.tree.push(this.array[j]);
			                }
			            }
			        }
			    }
				this.treeok = true;
			}
		}
		this.getSecondList = function (selectValue) {
		    var ret = [];
		    ret.push({ ClassID: 0, Name: '根类',ParentID:-1, Selected: false });
		    this.getTree();
		    
		    for (var i = 0; i < this.tree.length; i++) {
		    	var o1st = $.extend({}, this.tree[i]);
	            if(selectValue == o1st.ClassID) o1st.Selected = true;
	            ret.push(o1st);
		    }
		    return ret;
		}
		this.getLevel = function (classid, arr, level){
			if(typeof arr == 'undefined'){
				arr = self.tree;
			}
			if(typeof level == 'undefined'){
				level = 1;
			}
			if(classid == 0)
				return level - 1;
			for(var i = 0; i < arr.length; i++){
				if(arr[i].ClassID == classid){
					return self.getLevel(arr[i].ParentID, arr, ++level);
				}
			}
			throw 'cant get the level';
		}
		this.addNewClassParentIDChange = function(){
			var classid = $('#newClassForm select[name=slParentID]').val();
			var level = self.getLevel(classid);
			if(level >= 2){
				$('#newClassForm .classImagePanel').show();
			}else{
				$('#newClassForm .classImagePanel').hide();
			}

			$('#newClassForm .classImage').unbind().bind('click', function(){
				var self = this;
				YDM.FileManager('image', 1, function (aUrl) {
					if (aUrl.length > 0){
						$(self).attr('src', aUrl[0]).attr('imageurl', aUrl[0]);
					}
				});
			});
			
			$('#newClassForm .btnClearClassImage').unbind().bind('click', function(){
				$(this).siblings('.classImage').attr('src', '').attr('imageurl', '');
			});
		}

    };
	
	var vm = new ViewModel();
	function initUI(root) {
	   
        root.empty();
        root.loadHtmlTpl("plugins/businesspackage/html/productclass.html?v=" + Math.random(), function () {
            me.execCommand('initContentNav', root);
			ko.applyBindings(vm,root[0]);
			bindUIEvent();
            loadProClassList();

        });
    }

    function loadProClassList() {
    	$.getJSON("/index.php?c=admin/product/productmanage&a=getclasslist", utils.params({}), function (json) {
       // $.getJSON("/admin/product/productmanage?act=getclasslist", utils.params({}), function (json) {
			if(json.success){
				if(json.sitetype === 1){
					for(var x = 0;x < json.list.length;x++){
						json.list[x].EnableCust = json.list[x].MobileEnableCust;
						json.list[x].PageID = json.list[x].MobilePageID;
					}
				}
				vm.setData(json.list);
				bindGridEvent();
			}else{
				alert("出错了：" + json.msg);
			}
        });
    }
    
    
    
	function showProClassEditDialog(classid,parentid,level) {
		$.ajax({
				type: "get",
				url:'/index.php?c=admin/product/productmanage&a=GetClassInfo',
	            async: false,
	            cache: false,
	            dataType: "json",
	            data: {ClassID:classid},
	            success: function (data) {
	            	if (!data.success) {
	                    showErrMsg(data.msg);
	                    return;
	                }
  		
	            	var html = "<div id='ProClassEditDialog'>";
	            	html += "<form>";
	            	html += "<input type='hidden' name='tbClassID' value='"+classid+"'/>";
	            	html += "<p>";
	        		html += "<span>分类名称：</span><input type='text' name='tbName' size='10' value='"+data.info.Name+"' class='form-control input' style='width: 260px;'/>";
	        		html += "</p>";
	        		html += "<p>";
	        		if(level == 1){
	        			html += "<span>所属父类：</span><select name='slParentID' class='form-control' style='width:260px;display:inline;' data-bind='options: $root.getRootList("+classid+"), optionsText: \"Name\",optionsValue: \"ClassID\",value: "+parentid+"'></select>";
	        		}else if(level == 2 || level == 3){
	        			html += "<span>所属父类：</span><select name='slParentID' class='form-control' style='width:260px;display:inline;' data-bind='options: $root.getSecondList("+classid+"), optionsText: \"Name\",optionsValue: \"ClassID\",value: "+parentid+"'></select>";
	        		}
	        		html += "</p>";
	        		
	        		if(level == 3){
		        		html += "<p>";
	        			html += "<input type='hidden' name='previewImgUrl' value='"+data.info.Image+"'/>";
	        			html += "<div class='clearfix previewImgPanel'>"
		        		html += "<p style='float:left;'>";
		        		html += "<span style='float:left;width:76.98px;text-align:right;display:block;'>图标：</span><img src='"+data.info.Image+"' id='previewImg"+classid+"' height='40' width='40' alt='' onerror='this.src =\"/images/nopic.gif\"' />";
		        		html += "</p>";
		        		html +=	"<p style='float:left;margin:14px 0 0 15px;'>"
	        			html += "<a class='selectImgBtn btn btn-primary btn-sm openImageBtn' style='display:inline' role='button'>选择图片</a>";
	        			html += "<a class='clearImgBtn btn btn-warning btn-sm clearImageBtn' style='display:inline;margin-left:10px;' role='button'>清除图片</a>";
	        			html += "</p>"
	        			html += "</div>"
	        			html += "</p>";
	        		}
	        		html += "<div style='text-align:center;'>"
	        		html += "<input type='button' class='btn btn-primary' style='width:100px;' name='btnEditProClass' value='保存'>";
	        		html += "</div>"
	        		html += "</form>";
	        		html += "</div>";
	        		$("body").append(html);
	        		ko.applyBindings(vm, $('#ProClassEditDialog')[0]);

	        		$("*[name=btnEditProClass]").unbind('click').bind('click', function (event) {
	                    var form = $(this).closest('form');
	        			var formVals = form.serializeObject();
						var parentid = formVals.slParentID;
						var imageurl = '';
						if(vm.getLevel(parentid) >= 2){
							imageurl = formVals.previewImgUrl;
						}
	        			var params = { ClassID: formVals.tbClassID, Name: formVals.tbName, ParentID: formVals.slParentID, Image: imageurl };
	        			$.getJSON("/index.php?c=admin/product/productmanage&a=editclass", utils.params(params), function (json) {
	        				if(json.success){
	        				    $.showResult(true, "修改成功", 1000);
	        				    $("#ProClassEditDialog").dialog('close');
	        					loadProClassList();
	        				}else{
	        				    $.showResult(false, json.msg);
	        				}
	        			});
	        		});
	        		
					$('#ProClassEditDialog select[name=slParentID]').off().on('click', function(){
						var parentid = $(this).val();
						if(vm.getLevel(parentid) >= 2){
							$('.previewImgPanel').show();
						}else{
							$('.previewImgPanel').hide();
						}
					});

	        		$('.openImageBtn').off().on('click', function () {
	        		    var self = this;
	                        YDM.FileManager('image', 1, function (aUrl) {
	                            if (aUrl.length > 0)
	                            {
	                                var dd = $('#ProClassEditDialog');
	                                dd.find('[name^=previewImgUrl]').val(aUrl[0]);
	                                dd.find('[id^=previewImg]').attr('src', aUrl[0]);
	                                
	                            }
	                        })
	                });
	                
	        		$('.clearImageBtn').off().on('click', function () {
	        		    var self = this;
	        		    var dd = $('#ProClassEditDialog');
	                    dd.find('[name^=previewImgUrl]').val('');
	                    dd.find('[id^=previewImg]').attr('src', '');
	                });
	        		
	        		
	        		$("#ProClassEditDialog").dialog({
	        			resizable: false,
	        			title: "修改产品分类",
	        			modal: true,
	        			width: 385,
	        			height: 250,
	        			position: ['center', 'middle'],
	        			close: function(event, ui) { $(this).remove(); },
	        		});

	            },
	            error: function (data) {         	
	                alert("<?php echo \YouZhan\Commons\Common::lg('loadfailed'); ?>");
	            }		
		});		
	}

	function bindUIEvent(){
		$("#BtnAddProClass").unbind().bind("click",function(){
			var params = {};
			var form = $(this).closest('form');
			var formVals = $(form).serializeObject();
			params.ParentID = formVals.slParentID;

			var names = '';
			var check = true;
			$(form).find('[name=tbName]').each(function(){
				var val = $.trim($(this).val());
				if(val === ''){
					$.showResult(false, "类别名称不能为空", 1000);
					$(this).focus();
					check = false;
					return false;
				}
				names += val + ',';
			});
			if(!check) return;
			names = names.replace(/,$/, '');
			params.names = names;

			if(vm.getLevel(formVals.slParentID) >= 2){
				var images = '';
				$(form).find('.classImage').each(function(){
					var val = $.trim($(this).val());
					images += ($(this).attr('imageurl') || '') + ',';
				});
				images = images.replace(/,$/, '');
				params.images = images;
			}

			$.getJSON("/index.php?c=admin/product/productmanage&a=addclass", utils.params(params), function (json) {
				if(json.success){
				    $.showResult(true, "添加成功", 1000);
					vm.treeok = false;
					loadProClassList();
					$('[newClassTd="1"]:gt(0)').remove();
					$('[newClassTd="1"]').find('[name=tbName]').val('');
					$('[newClassTd="1"]').find('.classImage').attr('src', '').attr('imageurl', '');
					$('[newClassTd="1"]').find('.classImagePanel').hide()
				}else{
				    $.showResult(false, json.msg);
				}
			});
		});

		$('#newClassForm .BtnAddProClassItem').unbind().bind("click", function(){
			var clone = $('[newClassTd="1"]').eq(0).clone(true);
			clone.find('[name=tbName]').val('');
			clone.find('.BtnDeleteNewProClassItem').show();
			clone.find('.classImage').attr('src', '').attr('imageurl', '');
			clone.insertAfter($(this).closest('tr'));

			$('#newClassForm .BtnDeleteNewProClassItem').unbind().bind('click', function(){
				if($('[newClassTd="1"]').length <= 1) return;
				$(this).closest('tr').remove();
			});

		});

		$('[name=tbName]').unbind('keypress').bind('keypress', function (evt) {
		    if (evt.keyCode == 13) {
		        $('#BtnAddProClass').click();
		        evt.stopPropagation();
		        return false;
		    }
		});
	}

	function bindGridEvent() {
		$(".Tables").disableSelection();
		$(".sortUl").sortable({
			handle: ".T1",
			start: function (event, ui) {
				ui.item.css({ "border": "solid 1px red" });
			},
			update: function (event, ui) {

				var orders = new String();
				$(this).find(".MoveItem").each(function (i) {
					orders += $(this).attr("value") + "-" + i + ",";
				});
				$.ajax({
					type: "POST",
					dataType: 'json',
					url:'/index.php?c=admin/product/productmanage&a=MoveClassOrder',
					data: { Order: orders },
//					url: '/admin/product/productmanage',
//					data: { act: "MoveClassOrder", Order: orders },
					success: function (json) {
						if(json.success) loadProClassList();
						else alert("出错了：" + json.msg);
					},
					error: function (XMLHttpRequest, textStatus, errorThrown) {
						alert("系统出错了." + errorThrown);
					}
				});
			}, stop: function (event, ui) {
				ui.item.css({ "border": "0" });
			}
		});

		$(".SubTable").sortable({
			handle: ".SubHandle",
			start: function (event, ui) {
				ui.item.css({ "border": "solid 1px red" });
			},
			update: function (event, ui) {
				
				var orders = new String();
				$(this).find(".SubHandle").each(function (i) {
					orders += $(this).attr("value") + "-" + i + ",";
				});
				$.ajax({
					type: "POST",
					dataType: 'json',
					url: '/index.php?c=admin/product/productmanage&a=MoveClassOrder',
					data: { Order: orders },
					//url: '/admin/product/productmanage',
					//data: { act: "MoveClassOrder", Order: orders },
					success: function (json) { 
						if(json.success) loadProClassList();
						else alert("出错了：" + json.msg);
					},
					error: function (XMLHttpRequest, textStatus, errorThrown) {
						alert("系统出错了.");
					}
				});
			}, stop: function (event, ui) {
				ui.item.css({ "border": "0", "border-bottom": "solid 1px #ccc" });
			}
		});

		$(".ThirdLevelTable").sortable({
		    handle: ".ThirdHandle",
		    start: function (event, ui) {
		        ui.item.css({ "border": "solid 1px red" });
		    },
		    update: function (event, ui) {

		        var orders = new String();
		        $(this).find(".ThirdHandle").each(function (i) {
		            orders += $(this).attr("value") + "-" + i + ",";
		        });
		        $.ajax({
		            type: "POST",
		            dataType: 'json',
		            url: '/index.php?c=admin/product/productmanage&a=MoveClassOrder',
		            data:{Order:orders},
//		            url: '/admin/product/productmanage',
//		            data: { act: "MoveClassOrder", Order: orders },
		            success: function (json) {
		                if (json.success) loadProClassList();
		                else alert("出错了：" + json.msg);
		            },
		            error: function (XMLHttpRequest, textStatus, errorThrown) {
		                alert("系统出错了.");
		            }
		        });
		    }, stop: function (event, ui) {
		        ui.item.css({ "border": "0", "border-bottom": "solid 1px #ccc" });
		    }
		});

		$("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
			showProClassEditDialog($(this).attr("ClassID"),$(this).attr("ParentID"),$(this).attr("Level"));
			return false;
        });
		
 
//      $("#BtnSave").on('click', function (event) {
//			var params = { 
//				arr:[]
//			};
//				$(".saveoredit").each(function(){
//					var classitem = {};
//					classitem.ClassID = $(this).find("[name='tbClassID']").val();
//					classitem.Name = $(this).find("[name='tbName']").val();
//					classitem.ParentID = $(this).find("[name='slParentID']").val();
//					classitem.Image = $(this).find("[name='previewImgUrl']").val() || "";
//					params.arr.push(classitem);
//				})
//			$.ajax({
//				type:"post",
//				url:"/index.php?c=admin/product/productmanage&a=editclass",
//				data:{params:params},
//				success:function(data){
//					if(data.success == true){ 
//						console.log(1)
//					}
//				}
//			});
//		});	

		$("*[name=BtnEnableCust]").unbind('click').bind('click', function (event) {
            var form = $(this).closest('form');
			var formVals = form.serializeObject();
			var params = {ClassID: $(this).attr("ClassID"),EnableCust: 1};
			$.getJSON("/index.php?c=admin/product/productmanage&a=editclasscust", utils.params(params), function (json) {
//			$.getJSON("/admin/product/productmanage?act=editclasscust", utils.params(params), function (json) {
				if(json.success){
				    //$.showResult(true,"修改成功",1000);
					loadProClassList();
				}else{
				    $.showResult(false, json.msg);
				}
			});
        });

		$("*[name=BtnDisableCust]").unbind('click').bind('click', function (event) {
            var form = $(this).closest('form');
			var formVals = form.serializeObject();
			var params = {ClassID: $(this).attr("ClassID"),EnableCust: 0};
			$.getJSON("/index.php?c=admin/product/productmanage&a=editclasscust", utils.params(params), function (json) {
//			$.getJSON("/admin/product/productmanage?act=editclasscust", utils.params(params), function (json) {
				if(json.success){
				    //$.showResult(true,"修改成功",1000);
					loadProClassList();
				}else{
				    $.showResult(false, json.msg);
				}
			});
        });

		$("*[name=BtnDesignCust]").bind("click",function(){
		    var url = "/ProductCust/" + $(this).attr("PageID") + "-" + $(this).attr("ClassID") + '.html';
			window.open(url);
		});

		$("*[name=BtnDel]").bind("click",function(){
			if(!confirm("确认删除？")) return;
			$.getJSON("/index.php?c=admin/product/productmanage&a=deleteclass", utils.params({ClassID:$(this).attr("ClassID")}), function (json) {
//			$.getJSON("/admin/product/productmanage?act=deleteclass", utils.params({ClassID:$(this).attr("ClassID")}), function (json) {
				vm.treeok = false;
				loadProClassList();
			});
		});

		$("*[name=BtnParam]").bind("click",function(){
			me.execCommand('go', { a: "business",b:"productparams",params:{ClassID: $(this).attr("ClassID")} });
		});

		/*
		$('.openImageBtn').off().on('click', function () {
		    var self = this;
                YDM.FileManager('image', 1, function (aUrl) {
                    if (aUrl.length > 0)
                    {
                        var dd = $(self).closest('.ThirdLevelLine');
                        dd.find('[name^=previewImgUrl]').val(aUrl[0]);
                        dd.find('[id^=previewImg]').attr('src', aUrl[0]);
                        //dd.find("[name^=BtnEdit]").click();
                        
                    }
                })
        });

        
		$('.clearImageBtn').off().on('click', function () {
		    var self = this;
		    var dd = $(self).closest('.ThirdLevelLine');
            dd.find('[name^=previewImgUrl]').val('');
            dd.find('[id^=previewImg]').attr('src', '');
            //dd.find('[name^=BtnEdit]').click();
        });
        */
	}

    me.addListener('productclass', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['productcomment'] = function () {

    var me = this;
				
	var ViewModelComment = function () {
        this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
		this.getTime = function (time) {
		    return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
		}
		this.getScore = function(score){
			var star = "";
			for(var i = 1; i <= score;i++){
				star += "<i class='fa fa-star'></i>";
			}
			return star;
		}
	};
	
	var vmcomment = new ViewModelComment();
	var myroot = null;
	function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_SHOP')) {
            root.load("/index.php?c=admin/page/Versiontip&page=productcomment");
            return;
        }
        root.loadHtmlTpl("plugins/businesspackage/html/productcomment.html",function() {
			myroot = root[0];
            me.execCommand('initContentNav', root);
			$('#btnSetCommentStatus1').unbind().on('click', function () {
				var id = getSelectedCommentIDs();
				if(!id) alert('请至少选择一个评论');
				else{
					$.getJSON("/index.php?c=admin/product/productcomment&a=setstatus", utils.params({id:id,status: 1}), function (json) {
//					$.getJSON("/admin/product/productcomment?act=setstatus", utils.params({id:id,status: 1}), function (json) {
						if(json.success) loadComment(curpage);
						else{
							$.showResult("出错啦",json.msg);
						}
					});
					$("#selectAll").prop('checked',false);
				}
				$(document).click();
				return false;
			});

			$('#btnSetCommentStatus0').unbind().on('click', function () {
				var id = getSelectedCommentIDs();
				if(!id) alert('请至少选择一个评论');
				else{
					$.getJSON("/index.php?c=admin/product/productcomment&a=setstatus", utils.params({id:id,status: 0}), function (json) {
//					$.getJSON("/admin/product/productcomment?act=setstatus", utils.params({id:id,status: 0}), function (json) {
						if(json.success) loadComment(curpage);
						else{
							$.showResult("出错啦",json.msg);
						}
					});
					$("#selectAll").prop('checked',false);
				}
				$(document).click();
				return false;
			});

			$('#btnDelCommentBatch').unbind().on('click', function () {
				var id = getSelectedCommentIDs();
				if(!id) alert('请至少选择一个评论');
				else{
					if(confirm("确认删除吗?")){
						$.getJSON("/index.php?c=admin/product/productcomment&a=delete", utils.params({'id': id}), function (json) {
//						$.getJSON("/admin/product/productcomment?act=delete", utils.params({'id': id}), function (json) {
							if(json.success){
								if(id.split(',').length >= itemcount) loadComment(1);
								else loadComment(curpage);
							}else{
								$.showResult("出错啦",json.msg);
							}
						});
						$("#selectAll").prop('checked',false);
					}
				}
				return false;
			});

			$('#selectAll').unbind().on('click', function () {
				$('#tabCommentList :checkbox:gt(0)').prop('checked', $('#tabCommentList :checkbox:eq(0)').prop('checked'));
			});

			$("#BtnSearch").unbind('click').bind('click', function (event) {
				loadComment(1);
			});
			
			ko.applyBindings(vmcomment, $('#tabCommentList')[0]);

			loadComment(1);
		});
    }

	var curpage = 1;
	var itemcount = 0;
    function loadComment(page) {
		var params = { keyword:$('#keyword').val().trim(),status:$('#status').val(),page: page, pagesize: 100 };
		$.getJSON("/index.php?c=admin/product/productcomment&a=getlist", utils.params(params), function (json) {
//		$.getJSON("/admin/product/productcomment?act=getlist", utils.params(params), function (json) {
            vmcomment.setData(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadComment(page); });
                $("#pagination").show();
            }
			bingCommentGridEvent();
        });
    }

	function bingCommentGridEvent(){
		$("*[name=btnSetCommentStatus]").unbind('click').bind('click', function (event) {
			$.getJSON("/index.php?c=admin/product/productcomment&a=setstatus", utils.params({id:$(this).attr("CommentID"),status: $(this).attr("value")}), function (json) {
//			$.getJSON("/admin/product/productcomment?act=setstatus", utils.params({id:$(this).attr("CommentID"),status: $(this).attr("value")}), function (json) {
				if(json.success){
					loadComment(curpage);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=btnDelComment]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			$.getJSON("/index.php?c=admin/product/productcomment&a=Delete", utils.params({id:$(this).attr("CommentID")}), function (json) {
//			$.getJSON("/admin/product/productcomment?act=Delete", utils.params({id:$(this).attr("CommentID")}), function (json) {
				if(json.success){
					if(itemcount > 1) loadComment(curpage);
					else loadComment(1);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=btnGoProduct]").unbind('click').bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'productedit', params: { id: $(this).attr("proid") } });
			return false;
        });
	}

	function getSelectedCommentIDs(){
		var array = new Array();
		$("input[name=CommentID]:checked").each(function(){
			array.push($(this).val());
		});
		var id = array.join(',');
		return id;
	}
	
	function submitComment() {
		var params = $('#CommentForm').serializeObject();
		if(params['Comment'] == ''){
			alert('请输入评论内容');
			return;
		}
		$.post("/index.php?c=admin/product/productcomment&a=addcomment",params,function(data, textStatus, jqXHR){
//		$.post("/admin/product/productcomment?act=addcomment",params,function(data, textStatus, jqXHR){
			if(data.success){
				$('#CommentForm input[name=UserNickName]').val('');
				$('#CommentForm *[name=Comment]').val('');
			    loadComment(1);
			}else{
			    $.showResult('出错啦',data.msg);
			}
		},"json");
		return false;
	}

    me.addListener('productcomment', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['productconfig'] = function () {

    var me = this;

    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/productconfig.html?rand=" + Math.random(),function(){
			loadConfig();
		});
    }
	    
    function loadConfig() {
        $.getJSON("/admin/product/productconfig?act=GetStyleList", null, function (json) {
			$("#ProductStyleList").html(json.info);
			$("#ProductStyleList").find(" > label").each(function(){
				if($(this).attr("curtpl") == "1"){
					$(this).addClass("selected");
					$(this).find("input[type=radio]").prop("checked",true);
				}

				$(this).off("click").on("click",function(e){
					$(this).parent().children().removeClass("selected");
					$(this).find("input[type=radio]").prop("checked",true);
					$(this).addClass("selected");
					if(e.target.tagName !== "INPUT") setStyle();
				});
			});

			/*$("#ProductStyleList").find("input[name='style']").each(function(){
				$(this).unbind().click(function(){
					setStyle();
				});
			});*/
        });
    }

	function setStyle(){
		var style = $("input[name='style']:checked").val();
		$.getJSON("/admin/product/productconfig?act=setstyle", utils.params({style:style}), function (json) {
			if(!json.success){
				$.showResult("出错啦",json.msg); //此方法定义在 core/ui.js 里
			}else{
				$("#DivTips").html("<b>设置已保存</b>");
				$("#DivTips").show();
				setTimeout(function(){$("#DivTips").hide(300)},2000);
			}
		});
		return false;
	}

    me.addListener('productconfig', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

IWF.plugins['productedit'] = function () {

    var me = this;

	var protype = '';				
	var ViewModel = function() {
		this.norms = ko.observableArray();
		this.isnew = ko.observable();
        this.setData = function (data) {
			for(var key in data){
				if(typeof(data[key]) == "object") this[key] = ko.observableArray(data[key]);
				else this[key] = ko.observable(data[key]);
			}
		};
		this.getTime = function(time){
		    return time().replace(/T/g, " ").replace(/\.\d+$/, '');
		};
		this.freightCheck = function(setting){
			return jQuery.parseJSON(setting).FreightMoneyCalType;
		};
		this.availableState = ko.observableArray([0,1,2,3]);
    };

	var ViewModelComment = function () {
        this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
		this.getTime = function (time) {
		    return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
		}
		this.getScore = function(score){
			var star = "";
			for(var i = 1; i <= score;i++){
				star += "<i class='fa fa-star' style='color: rgb(51, 51, 51)'></i>";
			}
			return star;
		}
		this.getImages = function(images){
			var html = '';
			var aImages = (images || '').split(',');
			for(var i = 0; i < aImages.length; i++){
				if(aImages[i]){
					html += '<img class="commentImg" src="/comdata/' + getCookie('InitSiteID') + '/productcomment' +  aImages[i] + '"/>';
				}
			}
			return html;
		}
	};
	
	var ViewModelVirtual = function () {
        this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
	};

	var vm = new ViewModel();
	var vmcomment = new ViewModelComment();
	var vmvirtual = new ViewModelVirtual();
	var uploadvmvirtual = new ViewModelVirtual();
	var myroot = null;
	var mustUpload = true;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/productedit.html?v=" + Math.random(),function() {
			myroot = root[0];
            me.execCommand('initContentNav', root);
			//判断权限
			if(!me.hasLicensePerm('ENABLE_FENXIAO')){
				$('#trFenXiaoStatus').remove();
				$('#trFenXiao').remove();
			}
			if(me.hasLicensePerm('ENABLE_AGENT') || me.hasLicensePerm('ENABLE_FENXIAO')){
				$('#tbCostPrice').attr('readonly',false);
			}else{
				$('#tbCostPrice').attr('readonly',true);
			}
            if (me.hasLicensePerm('ENABLE_VIRPRO')) {
            //if (getCookie('InitSiteID')=='16218' || getCookie('InitSiteID')=='6815') {
                $('[aboutvirpro="1"]').show();
            } else {
                $('[aboutvirpro="1"]').hide();
                $.get("/index.php?c=admin/page/Versiontip&page=productedit&msgtype=alert", null, function (json) {
      				$('#Virtual').popover({
	            		content:json,
	            		placement:'right',
	            		title:'注意',
	            	});
                });
                $("#Virtual").off('click').on('click',function(){
                	$('body').unbind('click').click(function (event) {
			            var target = $(event.target);
			            if (!target.hasClass('popover') && target.parent('popover-content').length === 0 && target.parent('popover-title').length === 0 && target.parent('popover').length === 0 && target.data('toggle') !== 'popover' && target.prop("tagName") != 'INPUT') {
			                $('#Virtual').popover('hide');
			            }
			        });
			        $('#Virtual').attr('checked',false);
			        $('#Actual').attr('checked',true);
			        $('#BtnVirImport').remove();
			        $('#Actual').click();
                });
            }
            
			if (!me.hasLicensePerm('ENABLE_SHOP')) {
				$.get("/index.php?c=admin/page/Versiontip&page=productedit", null, function (json) {
					$('#tabComment').html(json);
					
				});
				$("#switch-state").attr('checked',false);
				$("#switch-state").attr('disabled',true);
				$("#switch-state").parent().unbind('click').on('click',function(){
					$.get("/index.php?c=admin/page/Versiontip&page=productedit&msgtype=alert", null, function (json) {
						alert(json);
						
					});
				});
				// $('#switch-state').bootstrapSwitch('setActive', false);
			}else{
				$("#switch-state").attr('disabled',false);
			}

			$.validator.addMethod("isNumber", function (value, element) {
                return this.optional(element) || /^[0-9\.]+$/.test(value);
            }, "必须是数字");

			///当前时间与传入的时间比较
			jQuery.validator.addMethod("checkPrice", function (value, element, params) {
				var price = Number(value);
				var cost = Number($(params).val());
				if(!cost) cost = 0;
				//console.log(price + "," + cost);
				//有分销或代理权限时 才去检测
				if(me.hasLicensePerm('ENABLE_AGENT') || me.hasLicensePerm('ENABLE_FENXIAO')){
					return this.optional(element) || price == 0 || ((price - cost) > 0);
				}
				else{
					return true;
				}
			}, jQuery.validator.format("产品销售价必须大于成本价"));

			jQuery.validator.addMethod("guanshuicheck", function (value, element) {
			    return this.optional(element) || (value != '' && /^\d+(\.\d{1,2})?$/.test(value));
			}, "小数位不能超过三位");

			$("#ProEditForm").validate({
				rules: {
				    tbName: { required: true, maxlength: 100 },
					tbCostPrice: { required: false, isNumber: true },
					tbPrice: { required: false, isNumber: true, checkPrice: $("#tbCostPrice", myroot) },
					tbUpTime: { required: true },
					tbMarketPrice: { required: false, isNumber: true },
					tbProductQuantity: { required: false, digits: true },
					tbSalesCount: { required: false, digits: true },
					tbXingYouTaxRate: { required: false, guanshuicheck: true }
				},
				messages: {
				    tbName: { required: "* 请填写", maxlength: "* 产品名称太长了" },
					tbCostPrice: { isNumber: "价格必须是数字，并且大于0" },
					tbPrice: { isNumber: "价格必须是数字，并且大于0", checkPrice: "产品销售价必须大于代理低价" },
					tbUpTime: { required: "请输入时间" },
					tbMarketPrice: { required: "请输入市场价", isNumber: "市场价必须为数字，并且大于0" },
					tbProductQuantity: { required: "请输入产品库存量", digits: "产品库存必须为整数" },
					tbSalesCount: { required: "请输入产品销量", digits: "产品销量必须为整数" },
					tbXingYouTaxRate: { guanshuicheck: '关税最多输入两位小数' }
				},
				submitHandler: function (form) {
					try{
						submitForm();
					}catch(e){
						alert(e.description + ' ' + e.message);
					}
					return false;
				},
				errorPlacement: function (error, element) {
				    error.appendTo(element.parent());
				},
			});

			$("#btnTaobaoImport").unbind().click(function(){
				taobaoImport();
			});
			
			
			//产品类型切换
			$("input[name='ProductType']").click(function () {
				if ($(this).val() == "1") {
					$("#BtnVirImport").show();
					$("#BtnAddPrice").hide();
					$("#hdTabProductAttr").hide();
				} else {
					$("#BtnVirImport").hide();
					$("#BtnAddPrice").show();
					$("#hdTabProductAttr").show();
				}
			});
			
			//虚拟产品导入
			$("#BtnVirImport").unbind().click(function () {
			    $('a[href=#tabProductVirtual]').click(); return;
			});
			//导入触发
			$("#VirProImport").unbind().click(function () {
				if($('input[name="ProductType"]:checked').val() != 1){
					alert('请先选择产品类型为虚拟产品再进行导入!');
					return false;
				}
			});
				
			$("#VirProImport").on('change',function () {
 				VirProUpload();
            });

			$("#BtnAddPrice").unbind().click(function () {
			    $('a[href=#tabProductAttr]').click(); return;

			    addNorm();

			    $('#divEnable0YuanShopping').hide();
			    $('#divNorms').fadeIn();
			});

			$('#tbPrice').off('blur').on('blur', function () {
			    var val = parseFloat($('#tbPrice').val());
			    if (isNaN(val)) {
			        val == 0;
			    }
			    if (val == 0) {
			        $('#divEnable0YuanShopping').fadeIn();
			    } else {
			        $('#divEnable0YuanShopping').hide();
			    }
			    $('#tabProductAttr .commonPrice').text('￥' + val.toFixed(2));
			    $('#divNorms').hide();

                /*
			    var val = parseFloat($('#tbPrice').val());
			    if (isNaN(val)) {
			        val == 0;
			    }
			    if ($("#TabNorms>tbody>tr").length == 0 && val == 0) { // 没有更多价格 并且 销售价为0
			        $('#divEnable0YuanShopping').fadeIn();
			        $('#divNorms').hide();
			    } else if ($("#TabNorms>tbody>tr").length == 0 && val != 0) {// 没有更多价格 并且 销售价不为0
			        $('#divEnable0YuanShopping').hide();
			        $('#divNorms').hide();
			    } else {
			        $('#divEnable0YuanShopping').hide();
			        $('#divNorms').fadeIn();
			    }
                */
			});

			$("#BtnAddProImg").unbind().click(function(){
				$("#Filedata").click();
				$("#Filedata").unbind().change(function(){
					if($("#Filedata").val() != "") doUpload();
				});
			});

			$("#BtnShowImage").unbind().click(function(){
				if($(".ShowImg").css("display") == "none"){
					$(".ShowImg").show();
				} else {
					$(".ShowImg").hide();
				}
			});

			$('#tbUpTime', myroot).datetimepicker({
			    dayOfWeekStart: 1,
			    lang: 'ch',
			    format: 'Y-m-d H:i:s'
			});

			$('#hdTabComment').hide();
			$('#CrTime', myroot).datetimepicker({
			    dayOfWeekStart: 1,
			    lang: 'ch',
			    format: 'Y-m-d H:i:s'
			});

			$(".scorestar").off('click').on('click',function(){
				$(".scorestar").css('color','gray');
				var v = parseInt($(this).attr('value'));
				$(".scorestar").each(function(i,item){
					var v2 = parseInt($(item).attr('value'));
					if(v2 <= v) $(item).css('color','#daa607');
				});
				$("#Score").val(v);
			});
			$(".scorestar:last-child").click();

			$(document).off('click.productcommentUpImg').on('click.productcommentUpImg', '.btnDeleteUploadImg', function(){
				$(this).closest('.gridUpImg').remove();
				if($('.gridUpImg').length < 5){
					$('.btnAddUploadImg').show();
				}else{
					$('.btnAddUploadImg').hide();
				}
			});

			$("#btnAddComment").unbind().click(function(){
				submitComment();
			});

			$('#btnSetCommentStatus1').unbind().on('click', function () {
				var id = getSelectedCommentIDs();
				if(!id) alert('请至少选择一个评论');
				else{
					$.getJSON("/index.php?c=admin/product/productcomment&a=setstatus", utils.params({id:id,status: 1}), function (json) {
//					$.getJSON("/admin/product/productcomment?act=setstatus", utils.params({id:id,status: 1}), function (json) {
						if(json.success) loadComment(curpage);
						else{
						    $.showResult(false, json.msg);
						}
					});
					$("#selectAll").prop('checked',false);
				}
				$(document).click();
				return false;
			});

			$('#btnSetCommentStatus0').unbind().on('click', function () {
				var id = getSelectedCommentIDs();
				if(!id) alert('请至少选择一个评论');
				else{
					$.getJSON("/index.php?c=admin/product/productcomment&a=setstatus", utils.params({id:id,status: 0}), function (json) {
//					$.getJSON("/admin/product/productcomment?act=setstatus", utils.params({id:id,status: 0}), function (json) {
						if(json.success) loadComment(curpage);
						else{
						    $.showResult(false, json.msg);
						}
					});
					$("#selectAll").prop('checked',false);
				}
				$(document).click();
				return false;
			});

			$('#btnDelCommentBatch').unbind().on('click', function () {
				var id = getSelectedCommentIDs();
				if(!id) alert('请至少选择一个评论');
				else{
					if(confirm("确认删除吗?")){
						$.getJSON("/index.php?c=admin/product/productcomment&a=delete", utils.params({'id': id}), function (json) {
//						$.getJSON("/admin/product/productcomment?act=delete", utils.params({'id': id}), function (json) {
							if(json.success){
								if(id.split(',').length >= itemcount) loadComment(1);
								else loadComment(curpage);
							}else{
								$.showResult("出错啦",json.msg);
							}
						});
						$("#selectAll").prop('checked',false);
					}
				}
				return false;
			});

			$('#selectAll').unbind().on('click', function () {
				$('#tabCommentList :checkbox:gt(0)').prop('checked', $('#tabCommentList :checkbox:eq(0)').prop('checked'));
			});

			$("#PImg").disableSelection();
			$(".ShowImg").sortable({update: function (event, ui) {
				sortImg();
			}});

			$('#btnSetFenXiao').unbind().click(function(){
				if(me.currentModule.params && me.currentModule.params.id){
					$('#FenXiaoDialog').remove();
					var param = "?id=" + $('#tbFenXiaoID').val() + "&costprice=" + $('#tbCostPrice').val() + "&price=" + $('#tbPrice').val() + "&proid="+ me.currentModule.params.id +"&proname=" + encodeURIComponent($('#tbName').val());
					$("body").append("<div id='FenXiaoDialog' style='overflow:hidden'><iframe src='/admin/widget/ProductFenXiaoSetting.html"+ param +"' frameborder='0' width='100%' height='100%'></iframe></div>");
					var title = $('#tbName').val();
					if(title.length > 20) title = title.substr(0,20) + "...";
					title += " 的分销设置";
					$('#FenXiaoDialog').dialog({width:'600',height:'650',modal:true,title:title});
					$('#FenXiaoDialog').closest('.ui-dialog').find('.ui-dialog-content').css('padding','0');
				}
			});
		
			$('#btnMemberPrice').unbind().click(function (){
				if(me.currentModule.params && me.currentModule.params.id){
					$('#MemberPriceDialog').remove();
					var param = "?id="+me.currentModule.params.id+"&setting="+$('#tbMemberPrice1').attr('setting');
					$("body").append("<div id='MemberPriceDialog' style='overflow-y:hidden'><iframe src='/admin/widget/ProductMemberPriceSetting.html"+ param +"' frameborder='0' width='100%' height='100%'></iframe></div>");
					var title = $('#tbName').val();
					if(title.length > 20) title = title.substr(0,20) + "...";
					title += " 的会员价设置";
					$('#MemberPriceDialog').dialog({width:'400',height:'300',modal:true,title:title});
					$('#MemberPriceDialog').closest('.ui-dialog').find('.ui-dialog-content').css('padding','0');
				}
		    });

			$('#tbFenXiaoID1').unbind().click(function(){
				if($(this).val() == '' || $(this).val() == '0') $('#btnSetFenXiao').click();
			});
			
			initVirtualProduct();
			ko.applyBindings(vmcomment, $('#tabCommentList')[0]);
			ko.applyBindings(vmvirtual, $('#showListVir')[0]);
		    ko.applyBindings(uploadvmvirtual, $('#uploadListVir')[0]);

			$('#saveBtn').floatSaveBtn({ appendTo: '.contentBox' });
			$('.subTab a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
			    if ($(e.target).is("a[href=#tabProductAttr], a[href=#tabBase],a[href=#tabJiFen],a[href=#tabProductVirtual]")) {
			        $('#saveBtn').data('widget').show();
			    } else {
			        $('#saveBtn').data('widget').hide();
			    }
			});
			
			/*
			$('#custom_percent').unbind('click').on('click',function(){
				if($('#custom_percent:checked').val()==undefined)
				{
					$('.div_per').hide();
					$('.global_jfs').show();
				}
				else
				{
					$('.div_per').show();
					$('.global_jfs').hide();
				}
					
			});
			*/
			$('#default_per').unbind('click').on('click',function(){
				$('.div_per').hide();
				$('.global_jfs').show();
			});
			$('#custom_per').unbind('click').on('click',function(){
				$('.div_per').show();
				$('.global_jfs').hide();
			});
			
			
			$('input[name="exchange_type"]').unbind('change').on('change',function(){
				if($('input[name="exchange_type"]:checked').val()==1)
				{
					$('.fixed_type').show();
					$('.change_type').hide();
				}
				else
				{
					$('.fixed_type').hide();
					$('.change_type').show();
				}
			});
			loadClsList();
			loadShopConfig();
			loadLabelList();
			loadparamList(0);
			initSwfUpload();
			
			// if(!me.hasLicensePerm("ENABLE_JIFENMALL")){
			// 	// root.load("/index.php?c=admin/page/Versiontip&page=productedit");
			// 	$('#formjf').remove();
			// 	$.get("/index.php?c=admin/page/Versiontip&page=productedit", null, function (json) {
			// 		$('.tip').html(json);
			// 	});
			// 	// return;
			// }
			// else
			// 	$('.tip').remove();
			if(!me.hasLicensePerm("ENABLE_JIFENMALL")){
				// root.load("/index.php?c=admin/page/Versiontip&page=productedit");
				$('.jifenmall').remove();
				$('.tip').remove();
				// $.get("/index.php?c=admin/page/Versiontip&page=productedit", null, function (json) {
				// 	$('.tip').html(json);
				// });
				// return;
			}
			else
				$('.tip').remove();
				
			if (me.currentModule.params && me.currentModule.params.id) {
				initJiFen(me.currentModule.params.id);
			    loadProduct();
			    loadComment(1);
			    loadVirtualProduct(1);
			  
			}
			else {
				$('#trMemberPrice,#trFenXiaoStatus,#trFenXiao').css('cssText', 'display:none !important');
			    if ($('#tbUpTime').val() == '') {
			        $('#tbUpTime').val(dtToStr(new Date(), 'yyyy-MM-dd hh:mm:ss'));
			    }
			    initUE();
			    loadlevelList();
			    $('.isaut').remove();
			}

			loadEnableAcquireCustoms();

			
			$('input[name="enable_jfdiscount"]').change(function(){
				if($(this).val()==1)
					{
						$('.display').show();
//						if($('input[name="custom_percent"]:checked').val())
//							$('input[name="custom_percent"]').trigger('click');
						$('input[name="enable_jflist"]').attr('checked',false);
						$('.setting').hide();
						$('input[name="dispercent"]').val('');
					}
				else
				{
					$('input[name="enable_jflist"]').attr('checked',false);
					$('.display').hide();
				}
			});
			
			$('input[name="enable_jflist"]').change(function(){
				if($(this).attr('checked'))
				{
					$('.setting').hide();
					$(this).attr('checked',false);
				}
				else
				{
					$(this).attr('checked',true);
					$('.setting').show();
				}
			});
			
			$(function() {
				
				//
				$('#AddPLevel').click(function(){
					var chosen='';
					$('[name="chosenlevel"] option:selected').each(function(i){
						if(i==0)
							chosen='chosenlevel[]='+$(this).val();
						else
							chosen+='&chosenlevel[]='+$(this).val();
					});
					
					$.get('/index.php?c=admin/product/productmanage&a=saveChosenLevel',{product_id:$('#tbProductID').val(),chosenlevel:chosen},function(json){
						if(json.success==false)
							alert('修改失败');
						else
							$.showResult(true, "设置已保存", 2000);
					});
					
				});

				$('#ClearPLevel').click(function () {
				    $('.search-choice').remove();
				    $.get('/index.php?c=admin/product/productmanage&a=saveChosenLevel', { product_id: $('#tbProductID').val() }, function (json) {
				        if (json.success == false)
				            alert('修改失败');
				        else
				            $.showResult(true, "设置已保存", 2000);
				    });
				})
				
				$("#switch-state").not("[data-switch-no-init]").bootstrapSwitch();
			    $('#switch-state').on('switchChange.bootstrapSwitch',function  (event,state) {
			    	if (state == true) {
			    	    $("#mall").css("display", "block");
			    	    $('#trFreightMoneyCalType').css("display", "block");
			    	}else{
			    	    $("#mall").css("display", "none");
			    	    $('#trFreightMoneyCalType').css("display", "none");
			    	};
			    });
			    
			  });

			//产品类型切换
			if($('input[name="ProductType"]:checked').val() == '1'){
				$("#hdTabProductAttr").hide();
			}else{
				$("#hdTabProductAttr").show();		
			} 
			
			if ($("#TabParams").is(':hidden')) {
				$('#tabclose').hide()
			}else{
				$('#tabclose').show();
			};

			if ($("#tdLabels").is(':hidden')) {
				$('#titleclose').hide()
			}else{
				$('#titleclose').show();
			};

			$("#slClassID").unbind().change(function () {
			    $('#TabParams tr[iscommonparam=0]').remove();
			    loadparamList($(this).val(), false);
			});
			$('#tabclose').click(function  () {
				$(this).text($('#TabParams').is(":hidden")?"收起":"展开");
				$('#TabParams').slideToggle();
			})
			$('#titleclose').click(function  () {
				$(this).text($('#bqiandiv').is(":hidden")?"收起":"展开");
				$('#bqiandiv').slideToggle();
			})
			$('#tbPrice').blur();

			if (!me.hasLicensePerm('ENABLE_SHOP')) {
			    $('#BtnAddPrice').remove();
			    $('a[href="#tabProductAttr"]').parent('li').remove();
			    $('#tabProductAttr').remove();
			}
			initProductAttr();

			initUploadFuJian();
		});
    }
    
	function initProductAttr() {
	    bindBtnProductAttrEvent();
	    setBtnAddNewProductAttrKeyDisplay();

	    $('#btnAddNewProductAttrKey').off().on('click', function () {
	        $('#productAttrPanel').append(createNewProductAttrKeyHtml());
	        bindBtnProductAttrEvent();
	        setBtnAddNewProductAttrKeyDisplay();
	    });

	    $('#btnCollapseProductAttr').off().on('click', function () {
	        $('#productAttrPanel').toggle();
	    });

	    $('#btnCollapseProductSku').off().on('click', function () {
	        $('#productSkuPanel').toggle();
	    });

	    $('.btnBatchModify').off().on('click', function () {
	        $('#txBatchUpdateVal,#btnConfirmBatchUpdate,#btnCancelBatchUpdate').show();
	        $('.btnBatchModify').hide();
	        $('#txBatchUpdateVal').val('').attr('placeholder', '请输入' + $(this).text()).attr('targetselector', $(this).attr('targetselector')).focus();
	    });

	    $('#btnConfirmBatchUpdate').off().on('click', function () {
	        $($('#txBatchUpdateVal').attr('targetselector')).val($('#txBatchUpdateVal').val());
	        $('#txBatchUpdateVal,#btnConfirmBatchUpdate,#btnCancelBatchUpdate').hide();
	        $('.btnBatchModify').show();
	    });

	    $('#btnCancelBatchUpdate').off().on('click', function () {
	        $('#txBatchUpdateVal,#btnConfirmBatchUpdate,#btnCancelBatchUpdate').hide();
	        $('.btnBatchModify').show();
	    });

	    loadProductAttr();
	}
	
	function initJiFen(productid)
	{
		$.getJSON("/index.php?c=admin/product/productmanage&a=LoadJiFenAttr", {pid:productid}, function (data) {
			$('#JiFenScaleOut').html(data.globalScaleOut);
			if(data.Enable==0)
			{
				$('input[name="enable_jfdiscount"][value="0"]').attr('checked',true);
				$('.display').hide();
			}
			else
			{
				$('input[name="enable_jfdiscount"][value="1"]').attr('checked',true);
				$('.display').show();
			}
				
			
			if(data.Joined==1)
			{
				$('input[name="enable_jflist"]').trigger('click');
				
			}
			if(data.ExchangeType)
			{
				$('input[name="exchange_type"][value=1]').attr('checked',true);
				if(data.CustomJFScaleOut)
				{
					$('input[name="fixed_point"]').val(jQuery.parseJSON(data.CustomJFScaleOut).point);
					$('input[name="fixed_price"]').val(jQuery.parseJSON(data.CustomJFScaleOut).price);
				}
			}
			else
			{
				$('input[name="exchange_type"][value=0]').attr('checked',true);
				if(isInt(data.CustomJFScaleOut))
				{
					$('.custom_jfs').show();
					$('.global_jfs').hide();
					//$('#custom_percent').trigger('click');
					$('#custom_per').trigger('click');
					$('#customjf').val(data.CustomJFScaleOut);
				}
				else
					$('#default_per').trigger('click');
			}
			$('input[name="exchange_type"]').trigger('change');
			

			if(data.Maxium==''||data.Maxium)
				$('input[name="dispercent"]').val(data.Maxium);
	    });
	}

	function createNewProductAttrValHtml(data) {
	    data = data || {};
	    var attrValID = data.AttrValID;
	    attrValID = data.AttrValID ? data.AttrValID : 'n' + (new Date().getTime() + '' + Math.floor((Math.random() * 1000)));

	    var html = '<span class="productAttrVal" style="position:relative;display:inline-block;float: left;">';
	    html += '<input type="text" class="form-control input txProductAttrValName" attrvalid="' + attrValID + '" value="' + (data.AttrValName ? data.AttrValName : '') + '"  placeholder="例如：M" />'
	    html += '<i class="fa fa-close btnDeleteAttrVal" style="display:none;position: absolute;top: 14px;right: 4px;color: red;font-size: 16px;cursor:pointer;" title="点击删除" attrvalid="' + attrValID + '"></i>';
	    html += '</span>';
	    return html;
	}

	function createNewProductAttrKeyHtml(data) {
	    data = data || {};
	    var attrKeyID = data.AttrKeyID;
	    attrKeyID = data.AttrKeyID ? data.AttrKeyID : 'n' + (Math.floor((Math.random() * 1000)) + '' + new Date().getTime());

	    var newProductAttrKeyHtml = '<div class="productAttrKey" style="margin: 5px;" attrkeyid="' + attrKeyID + '">';
	    newProductAttrKeyHtml += '<div style="margin-top: 15px;">';
	    newProductAttrKeyHtml += '<label style="margin-right: 10px;">规格名称：</label>';
	    newProductAttrKeyHtml += '<div class="clearfix" style="display: inline-block;">';
	    newProductAttrKeyHtml += '<input type="text" class="form-control input2 txProductAttrKeyName"  placeholder="例如：尺码" value="' + (data.AttrKeyName ? data.AttrKeyName : '') + '" attrkeyid="' + attrKeyID + '" />';
	    newProductAttrKeyHtml += '<button class="btn btn-link btn-xs btnDeleteProductAttrKey" style="display: inline;color: red;margin-left:16px;">删除</button>';
	    newProductAttrKeyHtml += '</div>';
	    newProductAttrKeyHtml += '</div>';
	    newProductAttrKeyHtml += '<div class="clearfix" style="display: inline-block;margin-top: 12px;line-height: 44px;">';
	    newProductAttrKeyHtml += '<label style="float: left;width: 70px;margin-right: 10px;text-align: right;">规格：</label>';
	    newProductAttrKeyHtml += '<div style="float: left;width: 800px;">';
	    var attrVals = data.attrVals || [];
	    for (var i = 0; i < attrVals.length; i++) {
	        newProductAttrKeyHtml += createNewProductAttrValHtml(attrVals[i]);
	    }
	    newProductAttrKeyHtml += '<button class="btn btn-default btnAddNewProductAttrVal" style="float:left;margin-top: 5px;margin-left:8px">+</button>';
	    newProductAttrKeyHtml += '</div>';
	    newProductAttrKeyHtml += '</div>';
	    newProductAttrKeyHtml += '</div>';
	    return newProductAttrKeyHtml;
	}

	function bindBtnProductAttrEvent() {
	    var attrPanel = $('#productAttrPanel');
	    attrPanel.find('.btnAddNewProductAttrVal').off().on('click', function () {
	        cacheProductSkuData();
	        $(this).before(createNewProductAttrValHtml());
	        refreshProductSku(skuCahceData);
	        bindBtnProductAttrEvent();
	    });

	    attrPanel.find('.btnDeleteProductAttrKey').off().on('click', function () {
	        cacheProductSkuData();
	        $(this).closest('.productAttrKey').remove();
	        refreshProductSku(skuCahceData);
	        setBtnAddNewProductAttrKeyDisplay();
	        bindBtnProductAttrEvent();
	    });
	    
	    attrPanel.find('.txProductAttrKeyName').off().on('blur', function () {
	        cacheProductSkuData();
	        removeErrorHintForProductAttr(this);
	        refreshProductSku(skuCahceData);
	    });

	    attrPanel.find('.productAttrVal').off().on('mouseenter', function () {
	        $(this).find('.btnDeleteAttrVal').show();
	    }).on('mouseleave', function () {
	        $(this).find('.btnDeleteAttrVal').hide();
	    });

	    attrPanel.find('.txProductAttrValName').off().on('blur', function () {
	        cacheProductSkuData();
	        removeErrorHintForProductAttr(this);
	        refreshProductSku(skuCahceData);
	    });

	    attrPanel.find('.btnDeleteAttrVal').off().on('click', function () {
	        cacheProductSkuData();
	        $(this).closest('.productAttrVal').remove();
	        refreshProductSku(skuCahceData);
	    });
	}

	function cacheProductSkuData() {
	    skuCahceData = [];
	    $('#productSkuPanel table tbody tr').each(function () {
	        var obj = {};
	        obj.Path = $(this).attr('path');
	        obj.SkuID = $(this).attr('skuid');
	        obj.CostPrice = $(this).find('.sku_costPrice').val();
	        obj.Price = $(this).find('.sku_price').val();
	        obj.ProductQuantity = $(this).find('.sku_productQuantity').val();
	        skuCahceData.push(obj);
	    });
	    return skuCahceData;
	}

	function setBtnAddNewProductAttrKeyDisplay() {
	    if ($('#productAttrPanel').find('.productAttrKey').length >= 3) {
	        $('#btnAddNewProductAttrKey').hide();
	    } else {
	        $('#btnAddNewProductAttrKey').show();
	    }
	    if ($('#productAttrPanel').find('.productAttrKey').length > 0) {
	        $('#btnCollapseProductAttr').show();
	    } else {
	        $('#btnCollapseProductAttr').hide();
	    }
	}

	function loadProductAttr() {
	    if ($('#tbProductID').val()) {
	        $.ajax({
	            type: 'get',
	            url: '/index.php?c=admin/product/productmanage&a=loadProductAttr&productid=' + $('#tbProductID').val(),
	            async: true,
	            cache: false,
	            data: {},
	            dataType: 'json',
	            success: function (json) {
	                if (!json.success) {
	                    $.showResult(false, json.msg);
	                    return;
	                }
	                json.data = json.data || '{}';
	                var attrkeys = json.data.attrkeys || {};
	                var productSkus = json.data.productSkus || {};

	                $('#productAttrPanel').html('');
	                for (var i = 0; i < attrkeys.length; i++) {
	                    $('#productAttrPanel').append(createNewProductAttrKeyHtml(attrkeys[i]));
	                }

	                refreshProductSku(productSkus);

	                refreshCommonField();

	                bindBtnProductAttrEvent();
	                setBtnAddNewProductAttrKeyDisplay();
	            },
	            error: function () {
	                $.showResult(false, arguments[0].responseText);
	            }
	        });
	    }
	}

	function hasSkus() {
	    return $('#productSkuPanel tbody tr').length > 0;
	}

	function refreshCommonField() {
	    if (hasSkus()) {
	        var total_productQuantity = 0;
	        $('#productSkuPanel tbody tr').find('.sku_productQuantity').each(function () {
	            var val = parseInt(this.value);
	            if (!isNaN(val)) {
	                total_productQuantity += val;
	            }
	        })

	        $('#tbProductQuantity').attr('readonly', true).val(total_productQuantity);
	    } else {
	        $('#tbProductQuantity').attr('readonly', false);
	    }
	}

	function checkBeforeSubmitProductAttr() {
	    removeErrorHintForProductAttr();

	    var check = true;

	    var tempVals = [];
	    $('#productAttrPanel .txProductAttrKeyName').each(function () {
	        var val = $.trim(this.value);
	        if (val == '') {
	            check = false;
	            createErrorHintForProductAttr(this, '规格名称不能为空');
	            return true;
	        }

	        if ($.inArray(val, tempVals) > -1) {
	            check = false;
	            createErrorHintForProductAttr(this, '规格名称不能重复');
	            return true;
	        }
	        
	        if ($(this).closest('.productAttrKey').find('.productAttrVal').length == 0) {
	            check = false;
	            createErrorHintForProductAttr(this, '请先添加规格');
	            return true;
	        }
	        tempVals.push(val);
	    });

	    tempVals = [];
	    $('#productAttrPanel .txProductAttrValName').each(function () {
	        var val = $.trim(this.value);
	        if (val == '') {
	            check = false;
	            createErrorHintForProductAttr(this, '规格名称不能为空');
	            return true;
	        }
			/*
	        if ($.inArray(val, tempVals) > -1) {
	            check = false;
	            createErrorHintForProductAttr(this, '规格名称不能重复');
	            return true;
	        }
			*/
			$(this).closest('.productAttrKey').find('.txProductAttrValName').not(this).each(function(){
				var val2 = $.trim(this.value);
				if(val == val2){
					check = false;
					createErrorHintForProductAttr(this, '规格名称不能重复');
					return true;
				}
			});

	        tempVals.push(val);
	    });

	    $('#productSkuPanel .sku_costPrice').each(function () {
	        var val = $.trim(this.value);
	        if (val == '') {
	            check = false;
	            createErrorHintForProductAttr(this, '请输入代理底价');
	            return true;
	        };
	        if ((isNaN(val) || parseFloat(val) < 0) && protype != 'store') {
	            check = false;
	            createErrorHintForProductAttr(this, '代理底价必须为大于0的数字');
	            return true;
	        };
	        if (shopconfig && shopconfig.EnableAgent == 1) {
	            var sku_price = parseFloat($(this).closest('tr').find('.sku_price').val());
	            if ((sku_price > 0 && parseFloat(val) <= 0) && protype != 'store') {
	                check = false;
	                createErrorHintForProductAttr(this, '开启代理功能时，代理底价必须大于0');
	                return true;
	            }
	        }
	    });

	    $('#productSkuPanel .sku_price').each(function () {
	        var val = $.trim(this.value);
	        if (val == '') {
	            check = false;
	            createErrorHintForProductAttr(this, '请输入售价');
	            return true;
	        };
	        if (isNaN(val) || parseFloat(val) < 0) {
	            check = false;
	            createErrorHintForProductAttr(this, '售价必须为大于等于0的数字');
	            return true;
	        };
	        var sku_costPrice = parseFloat($(this).closest('tr').find('.sku_costPrice').val());
	        if (parseFloat(val) > 0 && sku_costPrice > parseFloat(val)) {
	            check = false;
	            createErrorHintForProductAttr(this, '售价不能低于代理底价');
	            return true;
	        }
	    });

	    $('#productSkuPanel .sku_productQuantity').each(function () {
	        var val = $.trim(this.value);
	        if (val == '') {
	            check = false;
	            createErrorHintForProductAttr(this, '请输入可售数量');
	            return true;
	        };
	        if (isNaN(val) || parseFloat(val) < 0 || !/^\d+$/.test(val)) {
	            check = false;
	            createErrorHintForProductAttr(this, '可售数量必须为大于0的正整数');
	            return true;
	        };
	    });
	    if (!check) {
	        $.showResult(false, '规格填写不正确');
	        return false;
	    }

	    //if ($('#productSkuPanel table tbody tr').length > 100) {
	    //    $.showResult(false, '您好，您的规格组合已经超过100个');
	    //    return false;
	    //}
	    return true;
	}

	function createErrorHintForProductAttr(obj, errHint) {
	    var html = '<i class="fa fa-exclamation-circle errHint" style="position: absolute;color: red;font-size: 14px;" data-toggle="tooltip" data-placement="top" title="' + errHint + '"></i>';
	    var el = $(html).insertAfter(obj);
	    el.css({
	        top: $(obj).position().top + $(obj).height() / 2,
	        left: $(obj).position().left + $(obj).outerWidth() - el.width() - 14
	    });
	    $(obj).addClass('error');
	}

	function removeErrorHintForProductAttr(obj) {
	    if (obj) {
	        $(obj).removeClass('error');
	        $(obj).next('.errHint').remove();
	    } else {
	        $('#tabProductAttr .error').removeClass('error');
	        $('#tabProductAttr .errHint').remove();
	    }
	}

	var saveProductAttrState = 0;
	function saveProductAttr(productid) {
	    var params = {};
	    if (productid > 0) params.productid = productid;
	    else params.productid = $('#tbProductID').val();
	    params.attrdata = {};
	    params.attrdata.productAttrKeys = [];
	    params.attrdata.productSkus = [];

	    var attrPanel = $('#productAttrPanel');
	    attrPanel.find('input.txProductAttrKeyName').each(function (i) {
	        var productAttrKey = {};
	        var attrkeyid = $(this).attr('attrkeyid');
	        productAttrKey.attrkey_id = (typeof attrkeyid == 'undefined' || attrkeyid == 0) ? 0 : attrkeyid;
	        productAttrKey.attrkey_name = $.trim(this.value);
	        productAttrKey.attrvals = [];

	        $(this).closest('.productAttrKey').find('.txProductAttrValName').each(function (j) {
	            var productAttrVals = {};
	            var attrvalid = $(this).attr('attrvalid');
	            productAttrVals.attrval_id = (typeof attrvalid == 'undefined' || attrvalid == 0) ? 0 : attrvalid;
	            productAttrVals.attrval_name = $.trim(this.value);
	            productAttrKey.attrvals.push(productAttrVals);
	        });

	        params.attrdata.productAttrKeys.push(productAttrKey);
	    });

	    $('#productSkuPanel tbody tr').each(function () {
	        var productSku = {};
	        var skuid = $(this).attr('skuid');
	        productSku.sku_id = (typeof skuid == 'undefined' || skuid == 0) ? 0 : skuid;
	        productSku.path = $.trim($(this).attr('path'));
	        productSku.sku_costPrice = $.trim($(this).find('.sku_costPrice').val());
	        productSku.sku_price = $.trim($(this).find('.sku_price').val());
	        productSku.sku_productQuantity = $.trim($(this).find('.sku_productQuantity').val());
	        params.attrdata.productSkus.push(productSku);
	    });

	    params.attrdata = encodeURI(JSON.stringify(params.attrdata));

	    $.ajax({
	        type: 'post',
	        url: '/index.php?c=admin/product/productmanage&a=saveProductAttr',
	        async: false,
	        cache: false,
	        data: params,
	        dataType: 'json',
	        success: function (json) {
	            if (!json.success) {
	                $.showResult(false, json.msg);
	                return;
	            }
	            $.showResult(true, "产品规格保存成功", 2000);
	            //loadProductAttr();
	            saveProductAttrState = 1;
	        },
	        error: function () {
	            $.showResult(false, arguments[0].responseText);
	            saveProductAttrState = 0;
	        },
	        complete: function () {

	        }
	    });
	}

	function refreshProductSku(productSkus) {
	    var thead = $('#productSkuPanel table thead');
	    var theadHtml = '<tr>';
	    $('#productAttrPanel .productAttrKey').each(function () {
	        theadHtml += '<th>' + $(this).find('.txProductAttrKeyName').val() + '</th>';
	    });
	    theadHtml += '<th>代理底价</th><th>售价</th><th>库存</th>';
	    theadHtml += '</tr>';
	    thead.html(theadHtml);

	    var attrkeys = [];
	    $('#productAttrPanel .productAttrKey').each(function (i) {
	        var attrKeyID = $(this).attr('attrkeyid');
	        attrVals = [];
	        $(this).find('.txProductAttrValName').each(function (j) {
	            var self = $(this);
	            var attrValID = $(this).attr('attrvalid');

	            var point = '';
	            if (attrValID.indexOf('n') == -1) {
	                point = attrValID;
	            } else {
	                point = attrKeyID + '_' + attrValID;
	            }

	            attrVals[j] = {
	                point: point,
	                attrValName: self.val()
	            }
	        });
	        attrkeys[i] = {
	            length: $(this).find('.productAttrVal').length,
	            attrKeyName: $(this).val(),
	            attrVals: attrVals
	        }
	    });

	    var whole = [];
	    var paths = [];
	    for (var i = 0; i < attrkeys.length; i++) {
	        len = whole.length;
	        for (var v in attrkeys[i].attrVals) whole.push([attrkeys[i].attrVals[v]]);
	        for (var j = 0; j < len; j++) {
	            for (var v in attrkeys[i].attrVals) {
	                attrval = whole[j].concat(attrkeys[i].attrVals[v]);
	                whole.push(attrval);
	                if (attrval.length == attrkeys.length) paths.push(attrval);
	            }
	        }
	    }
	    if (attrkeys.length == 1) paths = whole;

	    var html = '';
	    for (var i = 0; i < paths.length; i++) {
	        var tds = '';
	        var path = '';
	        for (var j = 0; j < paths[i].length; j++) {
	            tds += '<td>' + paths[i][j].attrValName + '</td>';
	            path += paths[i][j].point + ','
	        }
	        path = path.replace(/(^,*)|(,*$)/g, '');
	        html += '<tr path="' + path + '">';
	        html += tds;
	        html += '<td><input type="text" class="form-control input sku_costPrice "  /></td>';
	        html += '<td><input type="text" class="form-control input sku_price "  /></td>';
	        html += '<td><input type="text" class="form-control input sku_productQuantity"  /></td>';
	        html += '</tr>';
	    }
	    $('#productSkuPanel table tbody').html(html);

	    function calRowspan(attrkeys, curlevel) {
	        rowspan = 1;
	        for (curlevel++; curlevel < attrkeys.length; curlevel++) {
	            rowspan *= attrkeys[curlevel].length;
	        }
	        return rowspan;
	    }
	    for (var i = attrkeys.length - 1; i >= 0; i--) {
	        var rowspan = calRowspan(attrkeys, i);
	        $('#productSkuPanel table tbody tr').each(function (j) {
	            if (j % rowspan == 0) {
	                $(this).children('td').eq(i).attr('rowspan', rowspan);
	            } else {
	                $(this).children('td').eq(i).remove();
	            }
	        });
	    }

	    if (productSkus && $.isArray(productSkus)) {
	        for (var i = 0; i < productSkus.length; i++) {
	            var row = $('#productSkuPanel table tr[path="' + (productSkus[i].Path + '').replace(/(^,*)|(,*$)/g, '') + '"]');
	            row.attr('skuid', productSkus[i].SkuID);
	            row.find('.sku_costPrice').val(productSkus[i].CostPrice);
	            row.find('.sku_price').val(productSkus[i].Price);
	            row.find('.sku_productQuantity').val(productSkus[i].ProductQuantity);
	        }
	    }

	    refreshCommonField();

	    if ($('#productSkuPanel table tbody tr').length > 0) {
	        $('#productSkuToolBar').show();
	        $('#productSkuPanel').show();
	    } else {
	        $('#productSkuToolBar').hide();
	        $('#productSkuPanel').hide();
	    }
	}

	function dtToStr(date, fmt) {
	    var o = {
	        "M+": date.getMonth() + 1,                 //月份   
	        "d+": date.getDate(),                    //日   
	        "h+": date.getHours(),                   //小时   
	        "m+": date.getMinutes(),                 //分   
	        "s+": date.getSeconds(),                 //秒   
	        "q+": Math.floor((date.getMonth() + 3) / 3), //季度   
	        "S": date.getMilliseconds()             //毫秒   
	    };
	    if (/(y+)/.test(fmt))
	        fmt = fmt.replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
	    for (var k in o)
	        if (new RegExp("(" + k + ")").test(fmt))
	            fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
	    return fmt;
	}

	var shopconfig = null;
	function loadShopConfig() {
		//$.ajax({ url: "/admin/business/shopconfig?act=getinfo", async: false, dataType: "json", success: function (json) {
		$.ajax({ url: "/index.php?c=admin/business/Shopconfig&a=getinfo", async: false, dataType: "json", success: function (json) {
				if(json.success){
					shopconfig = json.info;
					if (me.hasLicensePerm('ENABLE_SHOP') && me.hasLicensePerm('ENABLE_FENXIAO') && me.currentModule.params && me.currentModule.params.id){
						$("#trFenXiao,#trFenXiaoStatus").show();
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}

	var classlist = null;
	function loadClsList() {
		$.ajax({ url: "/index.php?c=admin/product/productmanage&a=GetClassList", async: false, dataType: "json", success: function (json) {
//		$.ajax({ url: "/admin/product/productmanage?act=GetClassList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					classlist = json.list;
					for(var i = 0;i < json.list.length;i++){
						if(json.list[i].ParentID == 0){
							$("#slClassID").append("<option value='"+ json.list[i].ClassID +"'>"+ json.list[i].Name +"</option>");
							for(var j = 0;j < json.list.length;j++){
								if(json.list[j].ParentID == json.list[i].ClassID){
								    $("#slClassID").append("<option value='" + json.list[j].ClassID + "'> └- " + json.list[j].Name + "</option>");
								    for (var k = 0; k < json.list.length; k++) {
								        if (json.list[k].ParentID == json.list[j].ClassID) {
								            $("#slClassID").append("<option value='" + json.list[k].ClassID + "'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└-" + json.list[k].Name + "</option>");
								        }
								    }
								}
							}
						}
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}

	var labellist = null;
	function loadLabelList() {
		$.ajax({ url: "/index.php?c=admin/product/productlabel&a=GetList", async: false, dataType: "json", success: function (json) {
//		$.ajax({ url: "/admin/product/productlabel?act=GetList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					labellist = json.list;
					for(var j = 0;j < json.list.length;j++){
						if(json.list[j].Status == 1){
							$("#tdLabels").append("<label for='label"+ json.list[j].ID +"'><input type='checkbox' name='cbLabel[]' id='label"+ json.list[j].ID +"' value='"+ json.list[j].ID +"'/> "+ json.list[j].Name + "</label>　");
						}
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}

	var paramlist = null;
	function loadparamList(classid,async) {
		if(typeof async == "undefined") async = false;
		$.ajax({ url: "/index.php?c=admin/product/productparams&a=GetList&ClassID=" + classid, async: async, dataType: "json", success: function (json) {
//		$.ajax({ url: "/admin/product/productparams?act=GetList&ClassID=" + classid, async: async, dataType: "json", success: function (json) {
				if(json.success){
					paramlist = json.list;
					for(var j = 0;j < json.list.length;j++){
						if(json.list[j].Status == 1){
						    addParam(json.list[j].ID, json.list[j].Name, '', classid == 0);
						}
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}

	var ue = null;
	function initUE(){
	    try {
	        ue = new baidu.editor.ui.Editor({
	            initialFrameHeight: "300",
	            autoHeightEnabled: true,
	            toolbars: [[
                     'source', '|', 'undo', 'redo', '|',
                     'bold', 'italic', 'underline', 'fontborder', 'strikethrough', 'superscript', 'subscript', 'removeformat', 'formatmatch', 'autotypeset', 'blockquote', 'pasteplain', '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|',
                     'rowspacingtop', 'rowspacingbottom', 'lineheight', '|',
                     'customstyle', 'paragraph', 'fontfamily', 'fontsize', '|',
                     'directionalityltr', 'directionalityrtl', 'indent', '|',
                     'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', '|', 'touppercase', 'tolowercase', '|',
                     'link', 'unlink', 'anchor', '|', 'imagenone', 'imageleft', 'imageright', 'imagecenter', '|',
                     'insertvideo', 'map', 'gmap', 'insertcode', 'pagebreak', '|',
                     'horizontal', 'date', 'time', 'spechars', '|',
                     'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', '|',
                     'preview', 'searchreplace'
	            ]]
	        });
	        ue.ready(function () {
	            ue.setContent($("#tbContent", myroot).val());
	        });
	        ue.render('editor');
	    } catch (e) {
	        console.log("error: " + e);
	    }
	}
	
	//读取会员等级
	
	function loadlevelList(buyauth) {
		var levellist = [];
		if(buyauth != '' && buyauth != null){
			levellist = buyauth.split(',');
		}
		$.ajax({ url: "/index.php?c=admin/user/Userconfig&a=GetLevelList", async: false, dataType: "json", success: function (json) {
				if(json.success==true){
					for(var i = 0;i < json.list.length;i++){
						for(var j = 0;j < levellist.length;j++){
							var selected = '';
							if(json.list[i].ID == levellist[j]){
								selected = 'selected';
								break;
							}
						}
						$("#BuySelect").append("<option " + selected +" value='"+ json.list[i].ID +"'>"+ json.list[i].LevelName +"</option>");
					}
					$('#BuySelect').multiselect({
						includeSelectAllOption: true,//开启全选按钮
						selectAllText: '全选',//全选按钮文本
						nSelectedText: '个被选中',//有n个值的时候显示n个被选中  
						allSelectedText: '全选',//所有被选中的时候 全选（n）  
						nonSelectedText:"请选择会员等级", //没有选择时显示文本
								
					});
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}

	function taobaoImport(){
		if($('#tbTaobaoUrl').val() == ''){
			alert('请填写淘宝或天猫或阿里巴巴的商品详情网址');
			return;
		}
		var url = $('#tbTaobaoUrl').val().trim();
		if(/^(https:\/\/)/.test(url) == false && /^(http:\/\/)/.test(url) == false){
			url = "http://" + url;
		}
		$("#btnTaobaoImport").val('正在处理，请稍候...');
		$("#btnTaobaoImport").prop('disabled',true);
		$.getJSON("/index.php?c=admin/product/productmanage&a=TaobaoImport&url=" + escape(url), null, function (json) {
			if(json.success){
				$('#tbName').val(json.info.Name);
				$('#tbMarketPrice').val(parseFloat(json.info.Price * 1.2).toFixed(2));
				$('#tbCostPrice').val(parseFloat(json.info.Price * 0.5).toFixed(2));
				$('#tbPrice').val(json.info.Price);
				$('#tbContent').val(json.info.Detail);
				ue.setContent($("#tbContent", myroot).val());
				for(i = 0;i < json.info.Pics.length;i++){
					var img = json.info.Pics[i].substring(json.info.Pics[i].lastIndexOf("/") + 1);
					addImg(img,img);
				}
			}else{
			    $.showResult(false, json.msg);
			}
			$("#btnTaobaoImport").val('导入');
			$("#btnTaobaoImport").prop('disabled',false);
		});
	}

	function loadEnableAcquireCustoms() {
	    $.ajax({
	        type: 'get',
	        url: '/index.php?c=admin/product/productmanage&a=GetEnableAcquireCustoms',
//	        url: '/admin/product/productmanage?act=GetEnableAcquireCustoms',
	        data: {},
	        dataType: 'json',
	        async: true,
	        cache: false,
	        success: function (json) {
	            if (json.success && json.enableGlobalPurchase == 1) {
	                $('[aboutglobalpurchase=1]').show();
	            }
	        }
	    });
	}

	var swfu;
	function initSwfUpload(){
		if ($("#swfUploadPlaceholder").is("span")) {
			var params = {};
			if(me.currentModule.params && me.currentModule.params.id) params["Pid"] = me.currentModule.params.id;
			params['ssid'] = getCookie("sid") || '';
            swfu = new SWFUpload({
            	upload_url: "/index.php?c=admin/product/productmanage&a=UploadImg&InitSiteID=" + getCookie('InitSiteID') + "&PSESSID=" + getCookie('PHPSESSID'),
//                upload_url: "/admin/product/productmanage?act=UploadImg&InitSiteID=" + getCookie('InitSiteID'),
                post_params: params,
                file_size_limit: "3 MB",
                file_types: "*.jpg;*.gif;*.png",
                file_types_description: "Image Files",
                /*file_upload_limit: "5",*/
                file_queue_error_handler: fileQueueError,
                file_dialog_complete_handler: fileDialogComplete,
                upload_progress_handler: uploadProgress,
                upload_error_handler: uploadError,
                upload_success_handler: uploadSuccess,
                upload_complete_handler: uploadComplete,
                button_image_url: "/images/swfuplod-bg.gif",
                button_placeholder_id: "swfUploadPlaceholder",
                button_width: 96,
                button_height: 34,
                button_text: '<b><font color="#ffffff">上传产品图片</font></b>',
                button_text_top_padding: 8,
                button_text_left_padding: 5,
                button_window_mode: SWFUpload.WINDOW_MODE.OPAQUE,
                flash_url: "/share/swfupload.swf",
                custom_settings: {
                    upload_target: "FileProgressContainer"
                },
                debug: false
            });
        }

	}

	function uploadSuccess(file, serverResponse) {
        try {
			eval("var data = " + serverResponse);
            if(data.success){
				addImg(data.SmallFileName,data.fileName);
			}else{
                $.showResult(false, data.msg);
			}
            var progress = new FileProgress(file, this.customSettings.upload_target);
            progress.setStatus("Thumbnail Created.");
            progress.toggleCancel(false);
        } catch (ex) {
            this.debug(ex);
        }
    }

	function loadProduct() {
	    var params = { sid: me.sid, id: me.currentModule.params.id };
	    $.ajax({
	        type: 'get',
	        url: '/index.php?c=admin/product/productmanage&a=GetProductInfo',
//	        url: '/admin/product/productmanage?act=GetProductInfo',
	        data: params,
	        dataType: 'json',
	        async: false,
	        cache: false,
	        success: function (json) {
	        	loadlevelList(json.info.UserLevel);
	        	if(json.info.FreightSetting!=null)
	        	{	
	        		var setting=jQuery.parseJSON(json.info.FreightSetting);
	        		var exist=0;
	        		json.info.FreightSetting=setting.FreightMoneyCalType;
	        		for(var i=0;i<json.info.freightTemp.length;i++)
	        		{
	        			if(setting.FreightTemplate)
	        			{
	        				if(setting.FreightTemplate==json.info.freightTemp[i].Template_id)
	        				{
	        					json.info.TemplateCheck=setting.FreightTemplate;
	        					exist=1;
	        				}
	        			}
	        			else
	        			{
	        				if(json.info.freightTemp[i].IsDefault)
	        				{
	        					json.info.TemplateCheck=json.info.freightTemp[i].Template_id;
	        					exist=1;
	        				}
	        			}
	        			
	        		}
	        		if(!exist)
	        			json.info.TemplateCheck='';
	        		console.log(setting.FreightTemplate);
	        		console.log(json.info.freightTemp);
	        	}
	        	else
	        		json.info.TemplateCheck='';
	            vm.setData(json.info);
	            vm.norms(json.norms);
	            ko.applyBindings(vm, $('#tabBase')[0]);
				$('#CommentProductID').val(json.info.ProductID);
				$('#hdTabComment').show();
	            if (json.norms && json.norms.length > 0) {
	                for (i = 0; i < json.norms.length; i++) {
	                    addNorm(json.norms[i].Norms, json.norms[i].Price);
	                }
	            }
	            loadparamList(json.info.ClassID, false);
	            if (json.paramlist && json.paramlist.length > 0) {
	                for (i = 0; i < json.paramlist.length; i++) {
	                    addParam(json.paramlist[i].ID, json.paramlist[i].Name, json.paramlist[i].ParamValue);
	                }
	            }
	            if (json.info.SmallImages) {
	                var smalls = json.info.SmallImages.split(",");
	                var bigs = json.info.BigImages.split(",");
	                for (i = 0; i < smalls.length; i++) {
	                    addImg(smalls[i], bigs[i] ? bigs[i] : "");
	                }
	            }
	            if (json.info.Labels) {
	                $.each($("input[name='cbLabel[]']", $(myroot)), function (i, item) {
	                    if (json.info.Labels.indexOf( $(item).val()) > -1) {
	                        //$(item).click();
	                    	$(item).attr('checked','checked');
	                    }
	                });
	            }
	            
	            $("#BtnShowImage").show().html("隐藏图片（" + json.info.SmallImages.split(",").length + "）");

				if(json.ProductFenXiaoSetting){
					if(json.info.FenXiaoID > 0) $('#tbFenXiaoID1').prop('checked',true);
					$('#tbFenXiaoID1').val(json.ProductFenXiaoSetting.ID);
				}
				if(json.info.MemberPriceSetting>0)
					$('#tbMemberPrice1').prop('checked',true);
				if(json.info.MemPriceSetting)
					$('#tbMemberPrice1').attr('setting',json.info.MemPriceSetting);
				if($("#Virtual").is(':checked')){
					$("#BtnVirImport").show();
					$("#BtnAddPrice").hide();
				}else{
					$("#BtnVirImport").hide();
					$("#BtnAddPrice").show();
				}
				$("#mall").find("input[type='text']").each(function  () {
	        		if ($(this).val() != 0) {
	            		$("#switch-state").attr("checked","checked");
	            		$("#mall").css("display","block");
	       		 	}
	    		})
	            initUE();
	            protype = $('.type').val();
	            //审核产品 是否显示输入审核原因文本框
	            $('#autsel').off('change').on('change',function(){
	            	if(parseInt($(this).val()) >  1){
	            		$('.auttext').show();
	            	}else{
	            		$('.auttext').hide();
	            	}
	            })

				// 绑定产品评论添加图片按钮事件
				//bindFileUpload('.btnAddUploadImg .fileImg');
	        }
	    });
    }

	function addParam(paramid,name,value,isCommon){
		$("#TabParams").css("display","block");
		var tr = null;
		var trid = "trParams" + paramid;
		var trs =  $("#TabParams").find("#" + trid);
		if(trs.length == 0){
		    var html = '<tr id="' + trid + '" iscommonparam="' + (isCommon ? 1 : 0) + '"><td>' + name + '</td>';
			html += '<td><input name="Params' + paramid + '" type="text" value="'+ value +'" class="form-control input" style="width:250px;"/></td>';
			//html += '<td style="cursor:pointer">清空</td>';
			html += '</tr>';
			tr = $(html);
			$("#TabParams>tbody").append(tr);
		}else{
			tr = trs[0];
			$(tr).find("input[type=text]").val(value);
		}

		/*$(tr).children("td:last-child").click(function (){
			$(this).parent().find("input[type=text]").val('');
		});*/
	}

	function addNorm(name,value){
		$("#TabNorms").css("display","block");
		var vIndex = $("#TabNorms>tbody>tr").toArray().length;
		var html = '<tr><td><input class="form-control" name="Norms' + vIndex + '" type="text" value="'+ (name ? name : '') +'" style="width:120px;"/></td>';
		html += '<td><input class="form-control" name="NormsPrice' + vIndex + '" type="text" value="'+ (value ? value : '0') +'" /></td>';
		html += '<td class="btn btn-link" style="cursor:pointer;color:#ff0000;" >删除</td></tr>';
		var tr = $(html);
		$(tr).children("td:last-child").click(function () {
			$(this).parent().remove();
			if ($("#TabNorms>tbody>tr").toArray().length == 0) { //如果没有行了
			    $('#divEnable0YuanShopping').fadeIn();
			    $('#divNorms').hide();
			}
		});
		$("#TabNorms>tbody").append(tr);
	}

	function doUpload(){
		var params = {};
		if(me.currentModule.params && me.currentModule.params.id) params["Pid"] = me.currentModule.params.id;
		$("#BtnAddProImg").val("正在上传，请稍候");
		$.ajaxFileUpload
		(
			{
				url: '/index.php?c=admin/product/productmanage&a=UploadImg', //用于文件上传的服务器端请求地址
//				url: '/admin/product/productmanage?act=UploadImg', //用于文件上传的服务器端请求地址
				secureuri: false, //是否需要安全协议，一般设置为false
				fileElementId: 'Filedata', //文件上传域的ID
				dataType: 'json', //返回值类型 一般设置为json
				data: params,
				success: function (data, status)
				{
					if(data.success){
						addImg(data.SmallFileName,data.fileName);
					}else{
					    $.showResult(false, data.msg);
					}
					$("#BtnAddProImg").val("添加产品图");
				},
				error: function (data, status, e)
				{
				    $.showResult(false, e);
					$("#BtnAddProImg").val("添加产品图");
				}
			}
		);
	}	

	function sortImg(){
		var Smallimgfile = "";
		var Bigimgfile = "";
		$(".ShowImg").find("li").each(function(){
			var small = $(this).attr("SmallImage");
			var big = $(this).attr("BigImage");
			Smallimgfile += small + ",";
			Bigimgfile += big + ",";
		});
		Smallimgfile = Smallimgfile.replace(/,+$/,"");
		Bigimgfile = Bigimgfile.replace(/,+$/,"");
		$("#Smallimgfile").val(Smallimgfile);
		$("#Bigimgfile").val(Bigimgfile);
	}

	function addImg(smallimg,bigimg){
		$(".ShowImg").css("display","block");
		var siteid = getCookie("InitSiteID");
		var img = "/comdata/" + siteid + "/product/" + smallimg;
		var objImg = $('<li SmallImage="' + smallimg + '" BigImage="' + bigimg + '"><div><span></span><i><a class="icon-remove"></a></i></div><img title="拖动我改变顺序" src="' + img + '"/></li>');
		$(".ShowImg").append(objImg);
		objImg.find(".icon-remove").click(function(){
			var li = $(this).closest("li");
			delImg(li,li.attr("SmallImage"),li.attr("BigImage"));
		});

		var Bigimgfile = $("#Bigimgfile").val();
		if(Bigimgfile) Bigimgfile += "," + bigimg;
		else Bigimgfile = bigimg;
		$("#Bigimgfile").val(Bigimgfile);

		var Smallimgfile = $("#Smallimgfile").val();
		if(Smallimgfile) Smallimgfile += "," + smallimg;
		else Smallimgfile = smallimg;
		$("#Smallimgfile").val(Smallimgfile);

		$("#BtnShowImage").show().html("隐藏图片（"+ $("#Smallimgfile").val().split(",").length +"）");
	}

	function delImg(liobj,smallimg,bigimg){		
		var paramsObj = {ProductID: $("#tbProductID").val(),SmallImage: smallimg,BigImage: bigimg};

		$.post("/index.php?c=admin/product/productmanage&a=DeleteImg",paramsObj,function(data, textStatus, jqXHR){
//		$.post("/admin/product/productmanage?act=DeleteImg",paramsObj,function(data, textStatus, jqXHR){
			if(data.success){
				liobj.remove();
				var Bigimgfile = $("#Bigimgfile").val();
				Bigimgfile = Bigimgfile.replace(bigimg + ",","").replace(bigimg,"").replace(/,+$/,"");
				$("#Bigimgfile").val(Bigimgfile);

				var Smallimgfile = $("#Smallimgfile").val();
				Smallimgfile = Smallimgfile.replace(smallimg + ",","").replace(smallimg,"").replace(/,+$/,"");
				$("#Smallimgfile").val(Smallimgfile);

				if($("#Smallimgfile").val() == "") $("#BtnShowImage").hide();
				else $("#BtnShowImage").show().html("隐藏图片（"+ $("#Smallimgfile").val().split(",").length +"）");

			}else{
			    $.showResult(false, data.msg);
			}
		},"json");
	}

	var curpage = 1;
	var itemcount = 0;
    function loadComment(page) {
		var params = { ProductID: me.currentModule.params.id, page: page, pagesize: 1000 };
		$.getJSON("/index.php?c=admin/product/productcomment&a=getlist", utils.params(params), function (json) {
//		$.getJSON("/admin/product/productcomment?act=getlist", utils.params(params), function (json) {
            vmcomment.setData(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadComment(page); });
                $("#pagination").show();
            }
			bingCommentGridEvent();
        });
    }

	function bingCommentGridEvent(){
		$("*[name=btnSetCommentStatus]").unbind('click').bind('click', function (event) {
			$.getJSON("/index.php?c=admin/product/productcomment&a=setstatus", utils.params({id:$(this).attr("CommentID"),status: $(this).attr("value")}), function (json) {
//			$.getJSON("/admin/product/productcomment?act=setstatus", utils.params({id:$(this).attr("CommentID"),status: $(this).attr("value")}), function (json) {
				if(json.success){
					loadComment(curpage);
				}else{
				    $.showResult(false, json.msg);
				}
			});
			return false;
        });

		$("*[name=btnDelComment]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			$.getJSON("/index.php?c=admin/product/productcomment&a=Delete", utils.params({id:$(this).attr("CommentID")}), function (json) {
//			$.getJSON("/admin/product/productcomment?act=Delete", utils.params({id:$(this).attr("CommentID")}), function (json) {
				if(json.success){
					if(itemcount > 1) loadComment(curpage);
					else loadComment(1);
				}else{
				    $.showResult(false, json.msg);
				}
			});
			return false;
        });
	}

	function getSelectedCommentIDs(){
		var array = new Array();
		$("input[name=CommentID]:checked").each(function(){
			array.push($(this).val());
		});
		var id = array.join(',');
		return id;
	}
	
	function submitComment() {
		var params = $('#CommentForm').serializeObject();
		if(params['Comment'] == ''){
			alert('请输入评论内容');
			return;
		}
		var val = '';
		$('[name=txFileName]').each(function(){
			val += (this.value || '') + ',';
		});
		params['ImgFileNames'] = val;
		$.post("/index.php?c=admin/product/productcomment&a=addcomment",params,function(data, textStatus, jqXHR){
//		$.post("/admin/product/productcomment?act=addcomment",params,function(data, textStatus, jqXHR){
			if(data.success){
				$('#CommentForm input[name=UserNickName]').val('');
				$('#CommentForm *[name=Comment]').val('');
				$('.btnDeleteUploadImg').click();
			    loadComment(1);
			}else{
			    $.showResult(false, data.msg);
			}
		},"json");
		return false;
	}

	function getLoadingPanel(msg) {
	    var html = '<div class="loadingPanel" style="position: fixed;top: 0;left: 0;width: 100%; height: 100%;opacity: 1;background: rgba(252,252,252,0.7);text-align: center;padding-top: 250px;z-index:999999">';
	    html += '<span><i class="fa fa-spinner fa-spin" style="font-size: 30px;margin-bottom: 10px;"></i></span>';
	    html += '<span>' + msg + '</span>';
	    html += '</div>';
	    return html;
	}

	function saveJiFen(productid)
	{
		$.ajax({
			type:'post',
			url:'/index.php?c=admin/product/productmanage&a=savejifen',
			data:$('#formjf').serialize()+ '&pid='+ productid  ,
			dataType:'json',
			success:function(data){
				if(!data.success)
					 $.showResult(false, data.msg);
			},
		   error: function () {
		        $.showResult(false, arguments[0].responseText);
		    },
		});
		
	}
	
	function initVirtualProduct(){
		vmvirtual = new ViewModelVirtual();
		uploadvmvirtual = new ViewModelVirtual();
	}
	function loadVirtualProduct(page){
		if ($('#tbProductID').val()) {
			var params = { page: page, pagesize: 30 };
	        $.ajax({
	            type: 'get',
	            url: '/index.php?c=admin/product/productmanage&a=getvirprolist&productid=' + $('#tbProductID').val(),
	            async: true,
	            cache: false,
	            data: params,
	            dataType: 'json',
	            success: function (json) {
	                if (json.success) {
	                	vmvirtual.setData(json.list);
	                	if (json.pagecount < 2) $("#virpropagination").hide();
	                    else {
	                        //pageNav 方法定义在 /core/util.js 里
	                        $("#virproListPages").pageNav(json.curpage, json.pagecount, 30, function (page) { loadVirtualProduct(page); });
	                        $("#virproListPages").show();
	                    }

	                }
	            },
	            error: function () {
	                $.showResult(false, arguments[0].responseText);
	            }
	        });
	    }
	}
	
    
    function VirProUpload() {
    	 $.ajaxFileUpload({
                 url: '/index.php?c=admin/product/productmanage&a=importvirpro', //用于文件上传的服务器端请求地址
                 secureuri: false, //是否需要安全协议，一般设置为false
                 fileElementId: 'VirProImport', //文件上传域的ID
                 dataType: 'json', //返回值类型 一般设置为json
                 success: function (data, status)  //服务器成功响应处理函数
                 {       
	         		//绑定触发
         			$("#VirProImport").on('change',function () {
         				VirProUpload();
                     });
         			
         			if (data.success) {
         				uploadvmvirtual.list(data.list);
                    }else{
                    	$.showResult(false, data.msg);
                    }
                 },
                 error: function (data, status, e)//服务器响应失败处理函数
                 {
                     alert(e);
                 }
             });
    }
    
    function saveProductVirtual(productid){
    	var params = {};
    	params.productid = productid;
    	params.datalist = encodeURI(JSON.stringify(uploadvmvirtual.list()));
    	$.ajax({
			type:'post',
			url:'/index.php?c=admin/product/productmanage&a=addvirpro',
			data:params,
			dataType:'json',
			success:function(data){
				//uploadvmvirtual.list([]);
			},
		    error: function () {
		       
		    },
		});
    }
	
    function initUploadFuJian() {
        $('#FileFuJian').off().on('change', function () {
            if (typeof FileReader == 'undefined') {
                alert("不支持FileReader对象");
                return;
            }

            var filename = '';
            for (var i = 0; i < this.files.length; i++) {
                var file = this.files[i];
                var fileExt = file.name.match(/^.*\.([^.]+)$/);
                fileExt = fileExt ? fileExt[1].toLowerCase() : '';
                var allowExts = ['jpg', 'gif', 'png', 'jpeg', 'pdf', 'doc', 'docx', 'txt', 'csv', 'xls', 'xlsx'];
                if ($.inArray(fileExt, allowExts) == -1) {
                    alert("文件格式不允许");
                    this.value = "";
                    return false;
                }
                if (file.size > 1024 * 1024 * 2) {
                    alert("文件不能超过2M!");
                    this.value = "";
                    return false;
                }
                filename = this.files[0].name;
            }
            if (filename) {
                $('#txFuJian').val(filename);
                savedFuJian();
            }
        });

        $('#btnDeleteFuJian').off().on('click', function () {
            $('#txFuJian, #FileFuJian').val('');
        });
    }

    function savedFuJian() {
        $('body').append(getLoadingPanel('&nbsp;&nbsp;正在上传附件，请勿刷新...'));
        $.ajaxFileUpload
        (
            {
                url: '/index.php?c=admin/product/productmanage&a=uploadfujian', //用于文件上传的服务器端请求地址
                secureuri: false, //是否需要安全协议，一般设置为false
                fileElementId: 'FileFuJian', //文件上传域的ID
                dataType: 'json', //返回值类型 一般设置为json
                data: {},
                success: function (json, status) {
                    $('.loadingPanel').remove();
                    initUploadFuJian();
                    if (json.success) {
                        console.log(json);
                        $('#txFuJian').val(json.fuJian);
                    } else {
                        $.showResult(false, json.msg);
                    }
                },
                error: function (data, status, e) {
                    $('.loadingPanel').remove();
                    initUploadFuJian();
                    $.showResult(false, e);
                }
            }
        );
    }

	function bindFileUpload(fileInput){
		fileInput = $(fileInput);
		$(fileInput).fileupload({
			url: '/index.php?c=admin/product/productcomment&a=uploadcommentimg&ProductID=' + $('#tbProductID').val(),
			formData: {},
			dataType: 'json',
			acceptFileTypes: /(\.|\/)(jpe?g|png)$/i,
			disableImageResize: /Android(?!.*Chrome)|Opera/.test(window.navigator.userAgent),
			previewMaxWidth: 800,
			previewMaxHeight: 800,
			maxFileSize: 2 * 1024 * 1024,
			previewCrop: true,
			done: function (e, data) {
				console.log(data);
				if(!data.result.success){
					$.showResult(false, data.result.msg);
					return;
				}
				if($(this).closest('.btnAddUploadImg').length > 0){
					createUpImg(data.result.url, data.result.fileName);
				}else{
					$(this).closest('.gridUpImg').find('.upImg').css('background-image', 'url(' + data.result.url +')');
					$(this).closest('.gridUpImg').find('[name=txFileName]').val(data.result.fileName);
					$(this).closest('.gridUpImg').find('.fileImg').val('');
				}
			}, 
			fail: function (e, data) {
				alert("上传失败：图片太大或者格式不对");
			}
		});
	}

	function createUpImg(previewUrl, fileName){
		var html = '';
		html += '<div class="gridUpImg">';
		html += '<span class="upImg" style="background-image:url(' + previewUrl +')">';
		html += '<input type="file" name="fileImg" accept="image/png,image/jpg,image/jpeg" class="fileImg" />';
		html += '</span>';
		html += '<input type="hidden" name="txFileName" value="' + fileName + '" />';
		html += '<input type="button" class="btn btn-link btnDeleteUploadImg" value="删除" />';
		html += '</div>';
		var newElem = $(html).insertBefore('.btnAddUploadImg');
		bindFileUpload(newElem.find('.fileImg'));
		$('.btnAddUploadImg .fileImg').val('');
		if($('.gridUpImg').length >= 5){
			$('.btnAddUploadImg').hide();
		}
	}

    function submitForm(form) {
		var showOrder = $.trim($('#tbShowOrder').val());
		if(showOrder == '') showOrder = 0;
		if(isNaN(showOrder)){
			$.showResult(false, '排序编号必须填写大于等于0的整数');
			return;
		}

        if (shopconfig && shopconfig.EnableAgent == 1) {
            if (!hasSkus() && parseFloat($("#tbPrice").val()) > 0 && parseFloat($("#tbCostPrice").val()) <= 0 && protype != 'store') {
                alert("开启代理功能时，产品成本价必须大于0");
                $("#tbCostPrice").focus();
                return false;
            }
        }

		$('#ProEditForm').find("input[type=text]").each(function(){
			if(/(Norms\d+)/.test($(this).attr("name"))){
				if($(this).val().trim() == ""){
					alert("请输入价格名称");
					$(this).focus();
					return false;
				}
			}
			if(/(NormsPrice\d+)/.test($(this).attr("name"))){
				if(/[0-9\.]+/.test($(this).val().trim()) == false){
					alert("请输入价格，必须是数字");
					$(this).focus();
					return false;
				}
			}
		});
		
		if($('input[name="enable_jflist"]:checked').length>0)
		{
			if($('input[name="exchange_type"]:checked').length==0)
			{
				alert('积分兑换类型');
				return false;
			}
	
			if($('input[name="exchange_type"]:checked').val()==1) //固定积分
			{
				if(!isInt($('input[name="fixed_point"]').val()) || !isNumber($('input[name="fixed_price"]').val()) || $('input[name="fixed_point"]').val()<=0 ||$('input[name="fixed_price"]').val()<=0)
				{
					alert('兑换金额请输入大于0的整数');
					return false;
				}
			}
			else	//按比例
			{
				if($('input[name="custom_percent"]:checked').length==0)
				{
						alert('请选择积分兑换类型');
						return false;
				}
				if($('input[name="custom_percent"]:checked').val()==1)
				{
					if(!isNumber($('input[name="jifen"]').val()) || $('input[name="jifen"]').val()<=0)
					{
						alert('兑换金额请输入大于0的整数');
						return false
					}
				}
			}
		
		}
		
		

		var html = ue.getContent();
		$('#tbContent').val(html);
		var params = $('#ProEditForm').serialize(); //此方法定义在 core/ui.js
        //console.log(params);return false;

		if (!checkBeforeSubmitProductAttr()) {
		    $('[href="#tabProductAttr"]').click();
		    return;
		}
		
		var percent=$('input[name="dispercent"]').val();
		var jflist=$('input[name="enable_jflist"]:checked').val();
		var exchange_type=$('input[name="exchange_type"]:checked').val();
		if((parseInt(percent) >100 || parseInt(percent)<0 || percent=='') && jflist &&exchange_type==0)
		{
			$('input[name="dispercent"]').css({ 
				'border-color': 'rgba(232, 6, 0, 0.8)',
			    'outline': '0',
			    'outline': 'thin dotted \9',    /* IE6-9 */  
			    'box-shadow': 'inset 0 1px 1px rgba(232, 6, 6, 0.075), 0 0 8px rgba(241, 13, 13, 0.6)',});

			$.showResult(false, '请填写0-100的整数');
			return false;
		}

		$('body').append(getLoadingPanel('&nbsp;&nbsp;保存中...'));
		if($("#ProductAuditingInfo").val() == '' && $('#autsel').val() > 1){
			$(".hidspan").text("*请填写审核说明！");
			$.showResult(false, "请填写审核说明！");
			$('.loadingPanel').remove();
			return;
		}else{
			$.ajax({
			    type: 'post',
	//		    url: '/admin/product/productmanage?act=editproduct',
			    url: '/index.php?c=admin/product/productmanage&a=editproduct',
			    cache: false,
			    async: true,
			    data: params,
			    dataType: 'json',
			    success: function (data) {
			        if (data.success) {
			            saveProductAttr(data.productid);
			            saveJiFen(data.productid);
			            if($('input[name="ProductType"]:checked').val() == 1){
							saveProductVirtual(data.productid);
						} 
			            if (saveProductAttrState == 1) {
						
		                $.showResult(true, "设置已保存", 2000, function () {
		                    if (me.currentModule.params && me.currentModule.params.id && me.currentModule.params.searchParams) {
		                    	if(protype == 'store')
		                        	me.execCommand('go', { a: 'business', b: 'productstorylist', params: { searchParams: me.currentModule.params.searchParams } });
		                        else
		                        	me.execCommand('go', { a: 'business', b: 'productlist', params: { searchParams: me.currentModule.params.searchParams } });
		                    } else {
		                    	if(protype == 'store')
		                        	me.execCommand('go', { a: 'business', b: 'productstorylist' });
		                        else
		                        	me.execCommand('go', { a: 'business', b: 'productlist' });
		                    }
		                });
			        } 
			        }
			        else {
			            $.showResult(false, data.msg);
			        }
			    },
			    error: function () {
			        $.showResult(false, arguments[0].responseText);
			    },
			    complete: function () {
			        $('.loadingPanel').remove();
			    }
			});
		}
		return false;
    }

    me.addListener('productedit', function (key, args) {
		initUI(args);
    });
    
}


﻿IWF.plugins['productlabel'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
		this.array = [];
        this.setData = function (data) { this.array = data;this.list(data);};
    };
	
	var vm = new ViewModel();
	function initUI(root) {
        root.empty();
        root.loadHtmlTpl("plugins/businesspackage/html/productlabel.html", function () {
            me.execCommand('initContentNav', root);
			ko.applyBindings(vm,root[0]);
			bindUIEvent();
			loadParamsList();
		});
    }

    function loadParamsList() {
    	$.getJSON("/index.php?c=admin/product/productlabel&a=getlist", utils.params({}), function (json) {
//        $.getJSON("/admin/product/productlabel?act=getlist", utils.params({}), function (json) {
			if(json.success){
				vm.setData(json.list);
				bindGridEvent();
			}else{
				alert("出错了：" + json.msg);
			}
        });
    }

	function bindUIEvent(){
		$("#BtnAddProLabel").bind("click",function(){
			var form = $(this).closest('form');
			var formVals = $(form).serializeObject();
			var params = {Name: formVals.tbName,ParentID: formVals.slParentID};
			$.getJSON("/index.php?c=admin/product/productlabel&a=edit", utils.params(params), function (json) {
//			$.getJSON("/admin/product/productlabel?act=edit", utils.params(params), function (json) {
				if(json.success){
				    $.showResult(true, "添加成功", 1000);
					form[0].tbName.value = "";
					loadParamsList();
				}else{
				    $.showResult(false, json.msg);
				}
			});
		});
	}

	function bindGridEvent() {
		$(".Tables").disableSelection();
		$(".sortUl").sortable({
			handle: ".ProLabelsT1",
			start: function (event, ui) {
				ui.item.css({ "border": "solid 1px red" });
			},
			update: function (event, ui) {

				var orders = new String();
				$(this).find(".MoveItem").each(function (i) {
					orders += $(this).attr("value") + "-" + i + ",";
				});
				$.ajax({
					type: "POST",
					dataType: 'json',
					url: '/index.php?c=admin/product/productlabel&a=MoveOrder',
					data: { Order: orders },
//					url: '/admin/product/productlabel',
//					data: { act: "MoveOrder", Order: orders },
					success: function (json) {
						if(json.success) loadParamsList();
						else alert("出错了：" + json.msg);
					},
					error: function (XMLHttpRequest, textStatus, errorThrown) {
						alert("系统出错了." + errorThrown);
					}
				});
			}, stop: function (event, ui) {
				ui.item.css({ "border": "0" });
			}
		});

		$("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var form = $(this).closest('form');
			var formVals = form.serializeObject();
			var params = {LabelID: formVals.tbLabelID,Name: formVals.tbName};
			$.getJSON("/index.php?c=admin/product/productlabel&a=edit", utils.params(params), function (json) {
//			$.getJSON("/admin/product/productlabel?act=edit", utils.params(params), function (json) {
				if(json.success){
				    $.showResult(true, "修改成功", 1000);
					loadParamsList();
				}else{
				    $.showResult(false, json.msg);
				}
			});
        });

		$("*[name=BtnSetStatus]").unbind('click').bind('click', function (event) {
			$.getJSON("/index.php?c=admin/product/productlabel&a=setstatus", utils.params({id:$(this).attr("LabelID"), status: $(this).attr("value")}), function (json) {
//			$.getJSON("/admin/product/productlabel?act=setstatus", utils.params({id:$(this).attr("LabelID"), status: $(this).attr("value")}), function (json) {
				if(json.success) loadParamsList();
				else{
				    $.showResult(false, json.msg);
				}
			});
		});

		$("*[name=BtnDel]").unbind('click').bind("click",function(){
			if(!confirm("确认删除？")) return;
			$.getJSON("/index.php?c=admin/product/productlabel&a=delete", utils.params({LabelID:$(this).attr("LabelID")}), function (json) {
//			$.getJSON("/admin/product/productlabel?act=delete", utils.params({LabelID:$(this).attr("LabelID")}), function (json) {
				loadParamsList();
			});
		});
	}
	$(window).scroll(function () {
        var h_num = $(window).scrollTop();
        if (h_num >145) {
            $('.Cclass').addClass('fixer');
        } else {
            $('.Cclass').removeClass('fixer');
        }
    });

    me.addListener('productlabel', function (key, args) {
		initUI(args);
    });
}

IWF.plugins['productlist'] = function () {

    var me = this, page;
	
	var ViewModel = function () {
        this.prolist = ko.observableArray();
        this.setData = function (data) { this.prolist(data); };
        this.isShowAgentNum = ko.observable();
		this.getClassName = function(classid){
			for(var i = 0;i < classlist.length;i++){
				if(classlist[i].ClassID == classid){
					return classlist[i].Name;
				}
			}
			return "未分类";
		}
		this.getTime = function (time) {
		    return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
		}
		this.getLabels = function (labels) {
			var strlabels = "";
			var arr = (labels + '').split(',');
			for(var j = 0;j < arr.length;j++){
				for(var i = 0;i < labellist.length;i++){
					if(labellist[i].ID == arr[j]){
						strlabels += "<span style='margin:0px 5px;padding:0px 5px;color:white;background:#1d67b1;font-size:11px;' title='标签'>"+ labellist[i].Name + "</span>";
					}
				}
			}
			return strlabels;
		}
		this.getImage = function (siteid,productid,imgs) {
			if(imgs){
				var arr = imgs.split(',');
				return "<img class='imgpreview' siteid='"+ siteid +"' productid='"+ productid +"' imgsrc='"+ arr[0] +"' src='/images/icon-img.gif' />";
			}
			return "";
		}
		this.getQRCode = function(siteid, productid, qrcode) {
			//if(qrcode){
			//	return "<img class='qrcodepreview' siteid='"+ siteid +"' productid='"+ productid +"' qrcode='"+ qrcode +"'
			// src='/images/icon-qrcode2.gif' />"; }
			return "";
		}
		this.joinProductNumber = function(time, ProductID, $index) {
			return /*time.replace(/[-:T]/g, '') + ProductID*/ $index + 1 + ((me.page - 1) * 20);
		}
		this.getAgentNum = function(pid){
			var num = 0;
			$.ajax({ url: "/index.php?c=front/agentsetting&a=getProAgentNum",data:{pid: pid}, async: false, dataType: "json", success: function (json){
				if(json.success){
					num = json.num;
				}
				
			}});
			return num;
		}
		if(me.hasLicensePerm('ENABLE_AGENT')){
			this.isShowAgentNum(true);
		}else{
			this.isShowAgentNum(false);
		}
	};

	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/productlist.html?v=" + Math.random(), function () {
            me.execCommand('initContentNav', root);
			bindUIEvent();
			loadClsList();
			// loadStoreList();
			loadLabelList();
			ko.applyBindings(vm, root[0]);
			if (me.currentModule.params && me.currentModule.params.searchParams) {
			    try{
			        searchParams = JSON.parse(decodeURIComponent(me.currentModule.params.searchParams));
			        $("#keyword").val(searchParams.keyword, $("#classid").val(searchParams.classid));
			        loadProductList(1, searchParams);
			    } catch (ex) {
			        loadProductList(1);
			    }
			} else {
			    loadProductList(1);
			}
		});
    }
	
	// var storelist = null;
	// function loadStoreList()
	// {
	// 	$("#store").children().remove();
	// 	$("#store").append("<option value=''>--全部店铺--</option>");
	// 	$.ajax({ url: "/index.php?c=admin/product/productmanage&a=GetStoreList", async:false, dataType:'json',success:function(json){
	// 			if(json.success){
	// 				storelist = json.list;
	// 				for(var j = 0;j < json.list.length;j++){
	// 					if(json.list[j].AllState == 1){
	// 						$("#store").append("<option value='"+json.list[j].WebUserID+"'>"+json.list[j].StoreName+"</option>");
	// 					}
	// 				}
	// 			}else{
	// 				alert("出错了：" + json.msg);
	// 			}
	// 		}
	// 	});
	// }
	
	var classlist = null;
	function loadClsList() {
		$("#classid").children().remove();
		$("#classid").append("<option value=''>--全部分类--</option>");
		$.ajax({ url: "/index.php?c=admin/product/productmanage&a=GetClassList", async: false, dataType: "json", success: function (json) {
//		$.ajax({ url: "/admin/product/productmanage?act=GetClassList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					classlist = json.list;
					for(var i = 0;i < json.list.length;i++){
						if(json.list[i].ParentID == 0){
							$("#classid").append("<option value='"+ json.list[i].ClassID +"'>"+ json.list[i].Name +"</option>");
							for(var j = 0;j < json.list.length;j++){
								if(json.list[j].ParentID == json.list[i].ClassID){
								    $("#classid").append("<option value='" + json.list[j].ClassID + "'> &nbsp;&nbsp;└-" + json.list[j].Name + "</option>");
								    for (var k = 0; k < json.list.length; k++) {
								        if (json.list[k].ParentID == json.list[j].ClassID) {
								            $("#classid").append("<option value='" + json.list[k].ClassID + "'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└-" + json.list[k].Name + "</option>");
								        }
								    }
								}
							}
						}
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}

	var labellist = null;
	function loadLabelList() {
		$.ajax({ url: "/index.php?c=admin/product/productlabel&a=getlist", async: false, dataType: "json", success: function (json) {
//		$.ajax({ url: "/admin/product/productlabel?act=GetList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					labellist = json.list;
					for(var j = 0;j < json.list.length;j++){
						if(json.list[j].Status == 1){
							$("#spLabels").append("<label for='label"+ json.list[j].ID +"'><input type='checkbox' name='labels' id='label"+ json.list[j].ID +"' value='"+ json.list[j].ID +"'/> "+ json.list[j].Name + "</label>　");
						}
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}
    
	var curpage = 1;
	var itemcount = 0;
	var searchParams = {};
    function loadProductList(page, params) {
		me.page = page;
		var labels = [];
		$.each($("input[name=labels]:checked"),function(i,item){
			labels.push($(item).val());
		});
		params = params || { sid: me.sid, keyword: $("#keyword").val(),classid : $("#classid").val(), status: $("#status").val(), labels: labels.join(','), page: page, pagesize: 20 ,store:$("#store").val()};
		$.getJSON("/index.php?c=admin/product/productmanage&a=getlist", utils.params(params), function (json) {
//		$.getJSON("/admin/product/productmanage?act=getlist", utils.params(params), function (json) {
            vm.setData(json.list);
			$('#selectAll').prop("checked",false);
			curpage = json.curpage;
			itemcount = json.list.length;
			$("a[name=LinkDetail]").each(function(){ $(this).attr("href",json.detailurl.replace("{ID}",$(this).attr("ProductID"))); });
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadProductList(page); });
                $("#pagination").show();
            }

            bindGridEvent();
            searchParams = params;
        });
    }

	function showSetClassDialog(id,classid){
		var html = "<div id='SelClassDialog'><center>";
		html += "请选择分类：<select id='setclass_clsid' class='form-control' style='width:160px;display:inline'>";
		html += $("#classid").html();
		html += "</select>";
		$("body").append(html);
		$("#setclass_clsid option:first-child").remove();
		$("#setclass_clsid").val(classid);
		$("#SelClassDialog").dialog({ resizable: false, title: "设置分类", modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); },
			buttons: { "确定": function() { 
									setClass(id,$("#setclass_clsid").val());
									$(this).remove();
							   },
					   "取消": function() { $(this).remove(); }
			}
		});
	}

	function setClass(id,classid){
		var params = {'id':id, 'classid': classid};
		$.post("/index.php?c=admin/product/productmanage&a=setclass",params,function(data, textStatus, jqXHR){
//		$.post("/admin/product/productmanage?act=setclass",params,function(data, textStatus, jqXHR){
			if(data.success){
				loadProductList(curpage);
			}else{
				alert(json.msg);
			}
		},"json");
	}

	function getSelectedArtIDs(){
		var array = new Array();
		$("input[name=proid]:checked").each(function(){
			array.push($(this).val());
		});
		var id = array.join(',');
		return id;
	}
	
	var hideqrcodetimeout = null;
	function bindUIEvent(){
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadProductList(1);
        });

		$('#selectAll').unbind().on('click', function () {
			$('#showListTable :checkbox:gt(0)').prop('checked', $('#showListTable :checkbox:eq(0)').prop('checked'));
		});

		$("#BtnAddProduct").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'productedit' });
			return false;
        });

		$("#BtnBatAdd").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'productbatadd' });
			return false;
        });
		
		$('#BtnSetClass').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else showSetClassDialog(id,0);
			$(document).click();
			return false;
		});

		$('#BtnSetStatus1').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				$.getJSON("/index.php?c=admin/product/productmanage&a=setstatus", utils.params({id:id,status: 1}), function (json) {
//				$.getJSON("/admin/product/productmanage?act=setstatus", utils.params({id:id,status: 1}), function (json) {
					if(json.success) loadProductList(curpage);
					else{
						$.showResult("出错啦",json.msg);
					}
				});
			}
			$(document).click();
			return false;
		});

		$('#BtnSetStatus0').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				$.getJSON("/index.php?c=admin/product/productmanage&a=setstatus", utils.params({id:id,status: 0}), function (json) {
//				$.getJSON("/admin/product/productmanage?act=setstatus", utils.params({id:id,status: 0}), function (json) {
					if(json.success) loadProductList(curpage);
					else{
						$.showResult("出错啦",json.msg);
					}
				});
			}
			$(document).click();
			return false;
		});

		$('#BtnDelSelected').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				if(confirm("确认删除吗?")){
					$.getJSON("/index.php?c=admin/product/productmanage&a=delete", utils.params({'id': id}), function (json) {
//					$.getJSON("/admin/product/productmanage?act=delete", utils.params({'id': id}), function (json) {
						if(json.success){
							if(id.split(',').length >= itemcount) loadProductList(1);
							else loadProductList(curpage);
						}else{
							$.showResult("出错啦",json.msg);
						}
					});
				}
			}
			return false;
		});

		$(document).on("mouseover.productlist", "body", function (e) {
			$("#helperXXss").remove();
			$("<div id='helperXXss' style='position:fixed;bottom:0px'></div>").appendTo("body");
			var maxh = $("#helperXXss").position().top;
			if ($(e.target).hasClass("imgpreview")){
				$("#divImgPreview").remove();
				var html = "<div id='divImgPreview' style='padding:5px;border:1px solid #cccccc;background:white;position:absolute;'>";
				html += "<img src='/comdata/"+ $(e.target).attr("siteid") +"/product/"+ $(e.target).attr("imgsrc") +"' style='width:200px;height:200px;'/>";
				html += "</div>";
				$("body").append(html);
				var top = $(e.target).offset().top + 20;
				if(top + $("#divImgPreview").height() > maxh) top = $(e.target).offset().top - $("#divImgPreview").height();
				$("#divImgPreview").css({top:top,left:$(e.target).offset().left + 20});
			}
			if ($(e.target).hasClass("qrcodepreview")){
				$("#divQRCodePreview").remove();
				var qrcodesrc = "/comdata/"+ $(e.target).attr("siteid") +"/product/"+ $(e.target).attr("qrcode");
				var html = "<div id='divQRCodePreview' class='divQRCodePreview' style='padding:5px;border:1px solid #cccccc;background:white;position:absolute;'>";
				html += "<img src='"+ qrcodesrc +"' width='190'/>";
				html += "<div style='margin:2px;background:#764BA7;color:white;text-align:center;padding:5px;'>点击右键下载或复制二维码</div>";
				html += "</div>";
				$("body").append(html);
				var top = $(e.target).offset().top + 20;
				if(top + $("#divQRCodePreview").height() > maxh) top = $(e.target).offset().top - $("#divQRCodePreview").height();
				$("#divQRCodePreview").css({top:top,left:$(e.target).offset().left + 20});
			}
			if ($(e.target).hasClass("divQRCodePreview") || $(e.target).parent().hasClass("divQRCodePreview") || $(e.target).parent().parent().hasClass("divQRCodePreview")) {
				clearTimeout(hideqrcodetimeout);
			}
			e.preventDefault();
		});
		$(document).on("mouseout.productlist", "body", function (e) {
			if ($(e.target).hasClass("imgpreview")) {
				$("#divImgPreview").remove();
			}
			if ($(e.target).hasClass("qrcodepreview")) {
				hideqrcodetimeout = setTimeout(function(){ $("#divQRCodePreview").remove() },100);
			}
			if ($(e.target).hasClass("divQRCodePreview")) {
				hideqrcodetimeout = setTimeout(function(){ $("#divQRCodePreview").remove() },100);
			}
			e.preventDefault();
		});
	}

    function bindGridEvent() {

        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var searchParamsStr = JSON.stringify(searchParams);
            searchParamsStr = encodeURIComponent(searchParamsStr);
            me.execCommand('go', { a: 'business', b: 'productedit', params: { id: $(this).attr("AID"), searchParams: searchParamsStr } });
			return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			$.getJSON("/index.php?c=admin/product/productmanage&a=delete",utils.params({id:$(this).attr("AID")}), function (json) {
//			$.getJSON("/admin/product/productmanage?act=Delete", utils.params({id:$(this).attr("AID")}), function (json) {
				if(json.success){
					if(itemcount > 1) loadProductList(curpage);
					else loadProductList(1);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetActive]").unbind('click').bind('click', function (event) {
			$.getJSON("/index.php?c=admin/product/productmanage&a=setstatus", utils.params({id:$(this).attr("AID"),status: 1}), function (json) {
				if(json.success){
					loadProductList(curpage);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetClass]").unbind('click').bind('click', function (event) {
			showSetClassDialog($(this).attr("AID"),$(this).attr("ClassID"));
			return false;
        });		

		$("[name=txShowOrder]").unbind().bind('blur', function (event) {
			var productID = $(this).attr('AID');
			var showOrder = $.trim($(this).val());

			if(showOrder == '') showOrder = 0;
			if(isNaN(showOrder)){
				$.showResult(false, '排序编号必须填写大于等于0的整数');
				return;
			}

			$.ajax({
				type:'get',
				url:'/index.php?c=admin/product/productmanage&a=SetShowOrder',
				async:false,
				cache:false,
				data:{productID: productID, showOrder: showOrder},
				dataType:'json',
				success:function(data){
					if(!data.success){
						$.showResult(false, data.msg);
						return;
					}
					loadProductList(1);
				},
				error:function(){
					$.showResult(false, arguments[0].responseText);
				}
			});
		});
    }

    me.addListener('productlist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['productparams'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
		this.array = [];
        this.setData = function (data) { this.array = data;this.list(data);};
    };
	
	var vm = new ViewModel();
	function initUI(root) {
        root.empty();
        root.loadHtmlTpl("plugins/businesspackage/html/productparams.html", function () {
            me.execCommand('initContentNav', root);
			ko.applyBindings(vm,root[0]);
			bindUIEvent();
			loadClsList();
			loadClassInfo();
			loadParamsList();
		});
    }

	var classlist = null;
	function loadClsList() {
		var html = "";
		$.ajax({ url: "/index.php?c=admin/product/productmanage&a=GetClassList", async: true, dataType: "json", success: function (json) {
//		$.ajax({ url: "/admin/product/productmanage?act=GetClassList", async: true, dataType: "json", success: function (json) {
				if(json.success){
					$("#divClassTree").html("");
					classlist = json.list;
					html += "<option class='classhandle classselected' classid='0'>产品通用参数</option>";
					for (var i = 0; i < json.list.length; i++) {
					    if (json.list[i].ParentID == 0) {
					        html += "<option class='classhandle' classid='" + json.list[i].ClassID + "' value='" + json.list[i].ClassID + "'>&nbsp;&nbsp;" + json.list[i].Name + "</option>";
					        for (var j = 0; j < json.list.length; j++) {
					            if (json.list[j].ParentID == json.list[i].ClassID) {
					                html += "<option class='classhandle' classid='" + json.list[j].ClassID + "' value='" + json.list[j].ClassID + "'>&nbsp;&nbsp;&nbsp;└- " + json.list[j].Name + "</option>";
					                for (var k = 0; k < json.list.length; k++) {
					                    if (json.list[k].ParentID == json.list[j].ClassID) {
					                        html += "<option class='classhandle' classid='" + json.list[k].ClassID + "' value='" + json.list[k].ClassID + "'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└- " + json.list[k].Name + "</option>";
					                    }
					                }
					            }
					        }
					    }
					}

					$("#divClassTree").html(html);
				    $("#divClassTree").unbind().change(function(){
				        $("#divClassTree option.classhandle").removeClass("classselected");
				        $(this).find('[classid=' + this.value + ']').addClass("classselected");
				    	if(!me.currentModule.params) me.currentModule.params = {};
				    	me.currentModule.params["ClassID"] = parseInt(this.value);
				    	me.currentModule.params["ClassID"] = parseInt(this.value);
				    	loadClassInfo();
				    	loadParamsList();
				    });
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}

	function loadClassInfo(){
		var classid = 0;
		if(me.currentModule.params && me.currentModule.params.ClassID) classid = me.currentModule.params.ClassID;
		if(classid > 0){
			$.getJSON("/index.php?c=admin/product/productmanage&a=GetClassInfo", utils.params({ClassID: classid}), function (json) {
//			$.getJSON("/admin/product/productmanage?act=GetClassInfo", utils.params({ClassID: classid}), function (json) {
				if(json.success){
					$("#classinfo").html("您当前在设置分类 '" + json.info.Name + "' 的参数<!--　<input type='button' value='返回管理产品分类' class='btn btn-sm btn-success' onclick=\"location='#business.productclass'\">-->");
				}else{
					alert("出错了：" + json.msg);
				}
			});
		}else{
			$("#classinfo").html("您当前正在设置产品通用参数");
		}
	}

    function loadParamsList() {
		var classid = 0;
		if(me.currentModule.params && me.currentModule.params.ClassID) classid = me.currentModule.params.ClassID;
		$.getJSON("/index.php?c=admin/product/productparams&a=getlist&NoParent=1", utils.params({ClassID: classid}), function (json) {
//        $.getJSON("/admin/product/productparams?act=getlist&NoParent=1", utils.params({ClassID: classid}), function (json) {
			if(json.success){
				vm.setData(json.list);
				bindGridEvent();
			}else{
				alert("出错了：" + json.msg);
			}
        });
    }

	function bindUIEvent(){
		$("#BtnAddProParam").bind("click",function(){
			var form = $(this).closest('form');
			var formVals = $(form).serializeObject();
			var classid = 0;
			if(me.currentModule.params && me.currentModule.params.ClassID) classid = me.currentModule.params.ClassID;
			var params = {Name: formVals.tbName,ClassID: classid};
			$.getJSON("/index.php?c=admin/product/productparams&a=edit", utils.params(params), function (json) {
//			$.getJSON("/admin/product/productparams?act=edit", utils.params(params), function (json) {
				if(json.success){
				    $.showResult(true, "添加成功", 1000);
					form[0].tbName.value = "";
					loadParamsList();
				}else{
				    $.showResult(false, json.msg);
				}
			});
		});
	}

	function bindGridEvent() {
		$(".Tables").disableSelection();
		$(".sortUl").sortable({
			handle: ".ProParamsT1",
			start: function (event, ui) {
				ui.item.css({ "border": "solid 1px red" });
			},
			update: function (event, ui) {

				var orders = new String();
				$(this).find(".MoveItem").each(function (i) {
					orders += $(this).attr("value") + "-" + i + ",";
				});
				$.ajax({
					type: "POST",
					dataType: 'json',
					url: '/index.php?c=admin/product/productparams&a=MoveOrder',
					data: {Order: orders },
//					url: '/admin/product/productparams',
//					data: { act: "MoveOrder", Order: orders },
					success: function (json) {
						if(json.success) loadParamsList();
						else alert("出错了：" + json.msg);
					},
					error: function (XMLHttpRequest, textStatus, errorThrown) {
						alert("系统出错了." + errorThrown);
					}
				});
			}, stop: function (event, ui) {
				ui.item.css({ "border": "0" });
			}
		});

		$("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var form = $(this).closest('form');
			var formVals = form.serializeObject();
			var params = {ParamID: formVals.tbParamID,Name: formVals.tbName};
			$.getJSON("/index.php?c=admin/product/productparams&a=edit", utils.params(params), function (json) {
//			$.getJSON("/admin/product/productparams?act=edit", utils.params(params), function (json) {
				if(json.success){
				    $.showResult(true, "修改成功", 1000);
					loadParamsList();
				}else{
				    $.showResult(false, json.msg);
				}
			});
        });

		$("*[name=BtnSetStatus]").unbind('click').bind('click', function (event) {
			$.getJSON("/index.php?c=admin/product/productparams&a=setstatus", utils.params({id:$(this).attr("ParamID"), status: $(this).attr("value")}), function (json) {
//			$.getJSON("/admin/product/productparams?act=setstatus", utils.params({id:$(this).attr("ParamID"), status: $(this).attr("value")}), function (json) {
				if(json.success) loadParamsList();
				else{
				    $.showResult(false, json.msg);
				}
			});
		});

		$("*[name=BtnDel]").unbind('click').bind("click",function(){
			if(!confirm("确认删除？")) return;
			$.getJSON("/index.php?c=admin/product/productparams&a=delete", utils.params({ParamID:$(this).attr("ParamID")}), function (json) {
//			$.getJSON("/admin/product/productparams?act=delete", utils.params({ParamID:$(this).attr("ParamID")}), function (json) {
				loadParamsList();
			});
		});
	}

	$(window).scroll(function () {
        var h_num = $(window).scrollTop();
        if (h_num >170) {
            $('.Cclass').addClass('fixer');
        } else {
            $('.Cclass').removeClass('fixer');
        }
    });

    me.addListener('productparams', function (key, args) {
		initUI(args);
    });
}

IWF.plugins['productstorylist'] = function () {

    var me = this, page;
	
	var ViewModel = function () {
        this.prolist = ko.observableArray();
        this.setData = function (data) { this.prolist(data); };
		this.getClassName = function(classid){
			for(var i = 0;i < classlist.length;i++){
				if(classlist[i].ClassID == classid){
					return classlist[i].Name;
				}
			}
			return "未分类";
		}
		this.getStoreName = function(uid){
			for(var i = 0;i < storelist.length;i++){
				if(storelist[i].WebUserID == uid){
					return storelist[i].StoreName;
				}
			}
			return '';
		}
		this.getTime = function (time) {
		    return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
		}
		this.getLabels = function (labels) {
			var strlabels = "";
			var arr = (labels + '').split(',');
			for(var j = 0;j < arr.length;j++){
				for(var i = 0;i < labellist.length;i++){
					if(labellist[i].ID == arr[j]){
						strlabels += "<span style='margin:0px 5px;padding:0px 5px;color:white;background:#1d67b1;font-size:11px;' title='标签'>"+ labellist[i].Name + "</span>";
					}
				}
			}
			return strlabels;
		}
		this.getImage = function (siteid,productid,imgs) {
			if(imgs){
				var arr = imgs.split(',');
				return "<img class='imgpreview' siteid='"+ siteid +"' productid='"+ productid +"' imgsrc='"+ arr[0] +"' src='/images/icon-img.gif' />";
			}
			return "";
		}
		this.getQRCode = function(siteid, productid, qrcode) {
			//if(qrcode){
			//	return "<img class='qrcodepreview' siteid='"+ siteid +"' productid='"+ productid +"' qrcode='"+ qrcode +"'
			// src='/images/icon-qrcode2.gif' />"; }
			return "";
		}
		this.joinProductNumber = function(time, ProductID, $index) {
			return /*time.replace(/[-:T]/g, '') + ProductID*/ $index + 1 + ((me.page - 1) * 20);
		}
		this.getAgentNum = function(pid){
			var num = 0;
			$.ajax({ url: "/index.php?c=front/agentsetting&a=getProAgentNum",data:{pid: pid}, async: false, dataType: "json", success: function (json){
				if(json.success){
					num = json.num;
				}
				
			}});
			return num;
		}
	};

	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/storeproductlist.html?v=" + Math.random(), function () {
            me.execCommand('initContentNav', root);
			bindUIEvent();
			loadClsList();
			loadStoryList();
			ko.applyBindings(vm, root[0]);
			if (me.currentModule.params && me.currentModule.params.searchParams) {
			    try{
			        searchParams = JSON.parse(decodeURIComponent(me.currentModule.params.searchParams));
			        $("#keyword").val(searchParams.keyword, $("#classid").val(searchParams.classid));
			        loadProductList(1, searchParams);
			    } catch (ex) {
			        loadProductList(1);
			    }
			} else {
			    loadProductList(1);
			}
		});
    }
	
	var classlist = null;
	function loadClsList() {
		$("#classid").children().remove();
		$("#classid").append("<option value=''>--全部分类--</option>");
		$.ajax({ url: "/index.php?c=admin/product/productmanage&a=GetClassList", async: false, dataType: "json", success: function (json) {
//		$.ajax({ url: "/admin/product/productmanage?act=GetClassList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					classlist = json.list;
					for(var i = 0;i < json.list.length;i++){
						if(json.list[i].ParentID == 0){
							$("#classid").append("<option value='"+ json.list[i].ClassID +"'>"+ json.list[i].Name +"</option>");
							for(var j = 0;j < json.list.length;j++){
								if(json.list[j].ParentID == json.list[i].ClassID){
								    $("#classid").append("<option value='" + json.list[j].ClassID + "'> &nbsp;&nbsp;└-" + json.list[j].Name + "</option>");
								    for (var k = 0; k < json.list.length; k++) {
								        if (json.list[k].ParentID == json.list[j].ClassID) {
								            $("#classid").append("<option value='" + json.list[k].ClassID + "'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└-" + json.list[k].Name + "</option>");
								        }
								    }
								}
							}
						}
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}
	
	var storelist = null;
	function loadStoryList()
	{
		$.ajax({ url: "/index.php?c=admin/product/productfromstore&a=getStoreList", async: false, dataType: "json", 
			success: function (json) 
			{
				if(json.success)
				{
					storelist=json.list;
					for(var k = 0;k < json.list.length;k++)
						$("#storeid").append("<option value='" + json.list[k].WebUserID + "'> " + json.list[k].StoreName + "</option>");
				}
			}
		});
		
//			可以全部写翻落去product个表啊度噶
			
	}
    
	var curpage = 1;
	var itemcount = 0;
	var searchParams = {};
    function loadProductList(page, params) {
		me.page = page;
		var labels = [];
		$.each($("input[name=labels]:checked"),function(i,item){
			labels.push($(item).val());
		});
		params = params || { sid: me.sid, keyword: $("#keyword").val(),classid : $("#classid").val(), status: $("#status").val(), storeid: $("#storeid").val() , page: page, pagesize: 20,type:'store' };
		$.getJSON("/index.php?c=admin/product/productmanage&a=getlist&type=store", utils.params(params), function (json) {
//		$.getJSON("/admin/product/productmanage?act=getlist", utils.params(params), function (json) {
            vm.setData(json.list);
			$('#selectAll').prop("checked",false);
			curpage = json.curpage;
			itemcount = json.list.length;
			$("a[name=LinkDetail]").each(function(){ $(this).attr("href",json.detailurl.replace("{ID}",$(this).attr("ProductID"))); });
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadProductList(page); });
                $("#pagination").show();
            }

            bindGridEvent();
            searchParams = params;
        });
    }

	function showSetClassDialog(id,classid){
		var html = "<div id='SelClassDialog'><center>";
		html += "请选择分类：<select id='setclass_clsid' class='form-control' style='width:160px;display:inline'>";
		html += $("#classid").html();
		html += "</select>";
		$("body").append(html);
		$("#setclass_clsid option:first-child").remove();
		$("#setclass_clsid").val(classid);
		$("#SelClassDialog").dialog({ resizable: false, title: "设置分类", modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); },
			buttons: { "确定": function() { 
									setClass(id,$("#setclass_clsid").val());
									$(this).remove();
							   },
					   "取消": function() { $(this).remove(); }
			}
		});
	}

	function setClass(id,classid){
		var params = {'id':id, 'classid': classid};
		$.post("/index.php?c=admin/product/productmanage&a=setclass",params,function(data, textStatus, jqXHR){
//		$.post("/admin/product/productmanage?act=setclass",params,function(data, textStatus, jqXHR){
			if(data.success){
				loadProductList(curpage);
			}else{
				alert(json.msg);
			}
		},"json");
	}

	function getSelectedArtIDs(){
		var array = new Array();
		$("input[name=proid]:checked").each(function(){
			array.push($(this).val());
		});
		var id = array.join(',');
		return id;
	}
	
	var hideqrcodetimeout = null;
	function bindUIEvent(){
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadProductList(1);
        });

		$('#selectAll').unbind().on('click', function () {
			$('#showListTable :checkbox:gt(0)').prop('checked', $('#showListTable :checkbox:eq(0)').prop('checked'));
		});

		$("#BtnAddProduct").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'productedit' });
			return false;
        });

		$("#BtnBatAdd").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'productbatadd' });
			return false;
        });
		
		$('#BtnSetClass').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else showSetClassDialog(id,0);
			$(document).click();
			return false;
		});

		$('#BtnSetStatus1').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				$.getJSON("/index.php?c=admin/product/productmanage&a=setstatus", utils.params({id:id,status: 1}), function (json) {
//				$.getJSON("/admin/product/productmanage?act=setstatus", utils.params({id:id,status: 1}), function (json) {
					if(json.success) loadProductList(curpage);
					else{
						$.showResult("出错啦",json.msg);
					}
				});
			}
			$(document).click();
			return false;
		});

		$('#BtnSetStatus0').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				$.getJSON("/index.php?c=admin/product/productmanage&a=setstatus", utils.params({id:id,status: 0}), function (json) {
//				$.getJSON("/admin/product/productmanage?act=setstatus", utils.params({id:id,status: 0}), function (json) {
					if(json.success) loadProductList(curpage);
					else{
						$.showResult("出错啦",json.msg);
					}
				});
			}
			$(document).click();
			return false;
		});

		$('#BtnDelSelected').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				if(confirm("确认删除吗?")){
					$.getJSON("/index.php?c=admin/product/productmanage&a=delete", utils.params({'id': id}), function (json) {
//					$.getJSON("/admin/product/productmanage?act=delete", utils.params({'id': id}), function (json) {
						if(json.success){
							if(id.split(',').length >= itemcount) loadProductList(1);
							else loadProductList(curpage);
						}else{
							$.showResult("出错啦",json.msg);
						}
					});
				}
			}
			return false;
		});
		
		$('#BtnSetPass').unbind().on('click',function(){
			var pid=getSelectedArtIDs();
			if(!pid) 
				alert('请至少选择一个选项');
			else
			{
				$.get('/index.php?c=admin/product/productfromstore&a=AccProductState',{id:pid},function(data){
					if(data.success)
					{
						loadProductList(1);
					}
				});
			}
			return false;
		});
		
		$('#BtnSetReject').unbind().on('click',function(){
			var pid=getSelectedArtIDs();
			if(!pid) 
				alert('请至少选择一个选项');
			else
			{
				$('#pid').val(pid);
				$('#myModal').modal();
			}
			return false;
		});

		//审核产品页面
		$('#BtnAud').off('click').on('click',function(){
			loadProductList(1,{aud:1});
		});

		$(document).on("mouseover.productlist", "body", function (e) {
			$("#helperXXss").remove();
			$("<div id='helperXXss' style='position:fixed;bottom:0px'></div>").appendTo("body");
			var maxh = $("#helperXXss").position().top;
			if ($(e.target).hasClass("imgpreview")){
				$("#divImgPreview").remove();
				var html = "<div id='divImgPreview' style='padding:5px;border:1px solid #cccccc;background:white;position:absolute;'>";
				html += "<img src='/comdata/"+ $(e.target).attr("siteid") +"/product/"+ $(e.target).attr("imgsrc") +"' />";
				html += "</div>";
				$("body").append(html);
				var top = $(e.target).offset().top + 20;
				if(top + $("#divImgPreview").height() > maxh) top = $(e.target).offset().top - $("#divImgPreview").height();
				$("#divImgPreview").css({top:top,left:$(e.target).offset().left + 20});
			}
			if ($(e.target).hasClass("qrcodepreview")){
				$("#divQRCodePreview").remove();
				var qrcodesrc = "/comdata/"+ $(e.target).attr("siteid") +"/product/"+ $(e.target).attr("qrcode");
				var html = "<div id='divQRCodePreview' class='divQRCodePreview' style='padding:5px;border:1px solid #cccccc;background:white;position:absolute;'>";
				html += "<img src='"+ qrcodesrc +"' width='190'/>";
				html += "<div style='margin:2px;background:#764BA7;color:white;text-align:center;padding:5px;'>点击右键下载或复制二维码</div>";
				html += "</div>";
				$("body").append(html);
				var top = $(e.target).offset().top + 20;
				if(top + $("#divQRCodePreview").height() > maxh) top = $(e.target).offset().top - $("#divQRCodePreview").height();
				$("#divQRCodePreview").css({top:top,left:$(e.target).offset().left + 20});
			}
			if ($(e.target).hasClass("divQRCodePreview") || $(e.target).parent().hasClass("divQRCodePreview") || $(e.target).parent().parent().hasClass("divQRCodePreview")) {
				clearTimeout(hideqrcodetimeout);
			}
			e.preventDefault();
		});
		$(document).on("mouseout.productlist", "body", function (e) {
			if ($(e.target).hasClass("imgpreview")) {
				$("#divImgPreview").remove();
			}
			if ($(e.target).hasClass("qrcodepreview")) {
				hideqrcodetimeout = setTimeout(function(){ $("#divQRCodePreview").remove() },100);
			}
			if ($(e.target).hasClass("divQRCodePreview")) {
				hideqrcodetimeout = setTimeout(function(){ $("#divQRCodePreview").remove() },100);
			}
			e.preventDefault();
		});
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var searchParamsStr = JSON.stringify(searchParams);
            searchParamsStr = encodeURIComponent(searchParamsStr);
            me.execCommand('go', { a: 'business', b: 'productedit', params: { id: $(this).attr("AID"), searchParams: searchParamsStr } });
			return false;
        });

        $("*[name=BtnReject]").unbind('click').bind('click',function(event){
        	$('#myModal').modal();
        	$('#pid').val($(this).attr("AID"));
        });
        
        $("*[name=BtnPass]").unbind('click').bind('click',function(event){
        	$.get('/index.php?c=admin/product/productfromstore&a=AccProductState',{id: $(this).attr("AID")},function(json){
        		if(json.success)
        		{
        			$.showResult3('提示','操作成功,产品已发布',1500);
        			loadProductList(1);
        		}
        		else
        			$.showResult3(json.msg,1500);
        	});
        });
        
        $("#btnfy").click(function(){
        	if($("#memo").val() == ''){
        		alert("请填写审核说明！");
        		$.showResult3(json.msg,1500);
        	}else{
        		$('#myModal').modal('hide');
        		$.get('/index.php?c=admin/product/productfromstore&a=RejectProductState',{memo:$('#memo').val(),id:$('#pid').val()},function(data){
        			loadProductList(1);
        		});
        	}
        });
//      	$('#myModal').modal('hide');
//      	$.get('/index.php?c=admin/product/productfromstore&a=RejectProductState',{memo:$('#memo').val(),id:$('#pid').val()},function(data){
//      		if(data.success)
//      			loadProductList(1);
//      		else
//      			$.showResult3(json.msg,1500);
//      	});

		$("*[name=BtnSetClass]").unbind('click').bind('click', function (event) {
			showSetClassDialog($(this).attr("AID"),$(this).attr("ClassID"));
			return false;
        });		
    }

    me.addListener('productstorylist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}
﻿IWF.plugins['productstyle'] = function () {

    var me = this;

    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/productstyle.html?rand=" + Math.random(), function () {
            me.execCommand('initContentNav', root);
			loadConfig();
		});
    }
	    
    function loadConfig() {
    	$.getJSON("/index.php?c=admin/product/productstyle&a=GetStyleList", null, function (json) {
//        $.getJSON("/admin/product/productstyle?act=GetStyleList", null, function (json) {
			$("#ProductStyleList").html(json.info);
			$("#ProductStyleList").find(" > label").each(function(){
				if($(this).attr("curtpl") == "1"){
					$(this).addClass("selected");
					$(this).find("input[type=radio]").prop("checked",true);
				}

				$(this).off("click").on("click",function(e){
					$(this).parent().children().removeClass("selected");
					$(this).find("input[type=radio]").prop("checked",true);
					$(this).addClass("selected");
					if(e.target.tagName !== "INPUT") setStyle();
				});
			});
        });
    }

	function setStyle(){
		var style = $("input[name='style']:checked").val();
		$.getJSON("/index.php?c=admin/product/productstyle&a=setstyle", utils.params({style:style}), function (json) {
//		$.getJSON("/admin/product/productstyle?act=setstyle", utils.params({style:style}), function (json) {
			if(!json.success){
				$.showResult("出错啦",json.msg); //此方法定义在 core/ui.js 里
			}else{
				$("#DivTips").html("<b>设置已保存</b>");
				$("#DivTips").show();
				setTimeout(function(){$("#DivTips").hide(300)},2000);
			}
		});
		return false;
	}

    me.addListener('productstyle', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['refundslist'] = function () {

    var me = this;

    var ViewModel = function () {
        this.list = ko.observableArray();
        this.getTime = function (time) {
            if (time) {
                return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
            }
        }
        this.getStatusHtml = function (status) {
            for (var i = 0; i < aStatus.length; i++) {
                if (aStatus[i][0] == status)
                    return '<font style="color:' + aStatus[i][2] + ';">' + aStatus[i][1] + '</font>';
            }
        }
    };

    var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_SHOP')) {
            root.load("/index.php?c=admin/page/Versiontip&page=refundslist");
            return;
        }
        root.loadHtmlTpl("plugins/businesspackage/html/refundslist.html", function () {
            
            bindUIEvent();
            ko.applyBindings(vm, root[0]);
            loadList(1);
            loadConfig();
        });
    }

    var curpage = 1;
    var itemcount = 0;

    var aStatus = [
		['0', '申请中', '#2196F3;'],
		['1', '同意', '#58a350'],
        ['2', '拒绝', 'red']
    ];

    function loadList(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(), status: $("#status").val(), orderby: $('#orderby').val(), page: page, pagesize: 20 };
        $.getJSON("/index.php?c=admin/order/refunds&a=getlist", utils.params(params), function (json) {
//        $.getJSON("/admin/order/refunds?act=getlist", utils.params(params), function (json) {
            vm.list(json.list);
            $('#selectAll').prop("checked", false);
            curpage = json.curpage;
            itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadList(page); });
                $("#pagination").show();
            }

            bindGridEvent();
        });
    }

    var shopcfg = {};
    function loadConfig() {
        $.ajax({
            type: 'get',
            url: '/index.php?c=admin/business/shopconfig&a=GetInfo',
            dataType: 'json',
            async: false,
            cache: false,
            success: function (json) {
                if (!json.success) {
                    alert(json.msg);
                    return;
                }
                shopcfg = json.info;
            }
        })
    }

    function bindUIEvent() {
        $("#BtnSearch").off('click').on('click', function (event) {
            loadList(1);
        });

        $('#btnUseDefaultRefunds').off().click(function () {
            $('#refundsForm [name=contact]').val(shopcfg.RefundsDefaultContact ? shopcfg.RefundsDefaultContact : '');
            $('#refundsForm [name=contactNumber]').val(shopcfg.RefundsDefaultContactNumber ? shopcfg.RefundsDefaultContactNumber : '');
            $('#refundsForm [name=address]').val(shopcfg.RefundsDefaultAddr ? shopcfg.RefundsDefaultAddr : '');
            $('#refundsForm [name=reply]').val(shopcfg.RefundsDefaultReply ? shopcfg.RefundsDefaultReply : '');
        });

        $('#btnEditDefaultRefunds').off().click(function () {
            $('#refundsDialog').modal('hide');
            setTimeout(function () {
                me.execCommand('go', { a: 'business', b: 'shoppingmallconfig' });
            }, 1000);
        });

        $('#btnArgeeRefund,#btnRejectRefund').off().on('click', function () {
            var isAgree = $(this).attr('isagree');
            if (confirm(isAgree == 1 ? "确定同意退款？" : "确定拒绝退款？")) {
                $('#refundsForm [name=isAgree]').val(isAgree);
                var data = $('#refundsForm').serializeArray();
                $.ajax({
                    type: 'get',
                    url:'/index.php?c=admin/order/refunds&a=edit',
//                    url: '/admin/order/refunds?act=edit',
                    data: data,
                    dataType: 'json',
                    success: function (json) {
                        if (!json.success) {
                            alert(json.msg);
                            return;
                        }
                        alert('退款状态已修改成功');
                        $('#refundsDialog').modal('hide');
                        window.location.reload();
                    },
                    error: function (req) {
                        alert(req.responseText);
                    }
                })
            }
        });
    }

    function bindGridEvent() {
        $('.btnEdit').off().on('click', function () {
            $('#refundsDialog input[type=text]').val('');
            $('#refundsDialog textarea').text('')
            var logID = $(this).attr('logID');
            var list = vm.list();
            if (list && list.length > 0) {
                for (var i = 0; i < list.length; i++) {
                    var log = list[i];
                    if (log.ID == logID) {
                        //$('#refundsDialog [limitshow=1]').show();
                        $('#refundsLogID').val(log.ID);
                        $('#refundsDialog .reason').text(log.Reason);
                        $('#refundsDialog .productName').text(log.ProductName);
                        $('#refundsDialog .productNum').text(log.ProductNum);
                        $('#refundsDialog .total').text('￥' + log.RtnMoney);
                        $('#refundsDialog [name=contact]').val(log.Contact);
                        $('#refundsDialog [name=contactNumber]').val(log.ContactNumber);
                        $('#refundsDialog [name=address]').val(log.Address);
                        $('#refundsDialog [name=reply]').text(log.Reply);
                    }
                }
            }
            $('#refundsDialog').modal('show');
        });

        $('.btnDelete').off().on('click', function () {
            if (confirm("确认删除吗?")) {
                var id = $(this).attr('logID');
                $.getJSON("/index.php?c=admin/order/refunds&a=delete", utils.params({ 'id': id }), function (json) {
//                $.getJSON("/admin/order/refunds?act=delete", utils.params({ 'id': id }), function (json) {
                    if (json.success) {
                        if (id.split(',').length >= itemcount) loadList(1);
                        else loadList(curpage);
                    } else {
                        showResult("出错啦", json.msg);
                    }
                });
            }
        });
    }

    me.addListener('refundslist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['regionalagencylist'] = function () {

    var me = this;

    utils.addScript("/share/global.js");

    var ViewModel = function () {
        this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
        this.getTime = function (time) {
            return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
        }
        this.getMoney = function (money) {
            return Math.abs(money);
        }
    };

    var ViewModelUserList = function () {
        this.list = ko.observableArray();
        this.selectUserClick = function () {
            var id = $(this).attr('UserID');
            var nickname = $(this).attr('NickName');
            $('.addNewFormModal [name=userid]').attr('userid', id).val('(ID:' + id + ') ' + nickname).blur();
            $('.userSelectPanelModal').modal('hide');
        }
    }

    var vm = new ViewModel();

    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/regionalagencylist.html?v=" + Math.random(), function () {
            bindUIEvent();
            ko.applyBindings(vm, $("#showListTable")[0]);
            loadList(1);
        });
    }

    var curpage = 1;
    var itemcount = 0;
    function loadList(page) {
        var params = {
            page: page,
            pagesize: 20
        }

        $.getJSON("/admin/business/regionalagency?act=getlist", utils.params(params), function (json) {
            if (json.success) {
                vm.setData(json.list);
                curpage = json.curpage;
                itemcount = json.list.length;
                if (json.pagecount < 2) $(".pagination_mainlist").hide();
                else {
                    //pageNav 方法定义在 /core/util.js 里
                    $(".pagination_mainlist").pageNav(json.curpage, json.pagecount, 10, function (page) { loadList(page); });
                    $(".pagination_mainlist").show();
                }
                bindGridEvent();
            } else {
                $.showResult(false, json.msg);
            }
        });
    }

    function bindUIEvent() {
        $.validator.addMethod("provinceCheck", function (value, element) {
            if (this.optional(element)) {
                return true;
            }

            var slProvince = $("form").find('[name=province]');
            var province = parseInt(slProvince.val());
            if (isNaN(province) || (slProvince.css('display') != 'none' && province <= 0)) return false;
            return true;
        }, '请选择地区');

        $.validator.addMethod("cityCheck", function (value, element) {
            if (this.optional(element)) {
                return true;
            }

            var slCity = $("form").find('[name=city]');
            var city = parseInt(slCity.val());
            if (isNaN(city) || (slCity.css('display') != 'none' && city <= 0)) return false;
            return true;
        }, '请选择地区');

        $.validator.addMethod("districtCheck", function (value, element) {
            if (this.optional(element)) {
                return true;
            }

            var slDistrict = $("form").find('[name=district]');
            var district = parseInt(slDistrict.val());
            if (isNaN(district) || (slDistrict.css('display') != 'none' && district <= 0)) return false;
            return true;
        }, '请选择地区');

        $('#btnAddNew').off().on('click', function () {
            var html = $('.divAddNewForm').prop('outerHTML');
            var modal = $(html);
            modal.appendTo('body');
            modal.find('.districtSelector').addClass('clearfix').districtSeletor({ showCountry: 0 }).find('select').addClass('form-control');
            var dialog = bootbox.dialog({
                title: '新增区域代理',
                message: modal,
                className: 'addNewFormModal',
                buttons: {
                    'cancel': {
                        label: '取消'
                    },
                    'confirm': {
                        label: '保存',
                        className: "btn-success btnSubmit",
                        callback: function () {
                            if ($('.addNewFormModal .addNewForm').valid()) {
                                $('.addNewFormModal .btnSubmit').prop('disabled', true);
                                $('.addNewFormModal .addNewForm').submit();
                            }
                            return false;
                        }
                    }
                }
            });

            dialog.find('.addNewForm').validate({
                rules: {
                    userid: { required: true },
                    province: { provinceCheck: true },
                    city: { cityCheck: false },
                    district: { districtCheck: false },
                    remark: { rangelength: [0, 500] },
                },
                messages: {
                    userid: { required: "请选择代理" },
                    province: { provinceCheck: '请选择省份或直辖市' },
                    city: { cityCheck: '请选择城市' },
                    district: { districtCheck: '请选择市区' },
                    remark: { rangelength: '最多500字' },
                },
                success: function (error, element) {
                    $(element).parent('.form-group').removeClass('has-error').addClass('has-success');
                    //error.hide();
                },
                showErrors: function (errorMap, errorList) {
                    for (var i = 0; i < errorList.length ; i++) {
                        $(errorList[i].element).parent('.form-group').addClass('has-error').removeClass('has-success');
                    }
                    this.defaultShowErrors();
                },
                errorPlacement: function (error, element) {
                    error.insertAfter(element.parent());
                },
                submitHandler: function (form) {
                    submitForm(form);
                    return false;
                }
            });

            dialog.find('.divAddNewForm').show();

            dialog.find('[name=userid]').off().on('click', function () {
                //bootbox.hideAll()
                dialog2 = bootbox.dialog({
                    title: '选择会员',
                    message: $('#userSelectPanel').html(),
                    className: 'userSelectPanelModal'
                });

                var vmUserList = new ViewModelUserList();
                ko.applyBindings(vmUserList, dialog2[0]);

                dialog2.find('.btnSearch').off().on('click', function () {
                    var keyword = dialog2.find(".keyword").val();
                    var loadUserList = function (page) {
                        $.getJSON("/admin/user/usermanage?act=getlist", {
                            keyword: keyword,
                            page: page,
                            pagesize: 10
                        }, function (json) {
                            vmUserList.list(json.list);

                            if (json.pagecount < 2) $(".userSelectPanelModal .userSelectPagination").hide();
                            else {
                                $(".userSelectPanelModal .userSelectPagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadUserList(page); });
                                $(".userSelectPanelModal .userSelectPagination").show().find('.pagination').addClass('pagination-sm');
                            }
                        });
                    }
                    loadUserList(1);
                })
            });
        });

        $('#btnShowNoAssigns').off().on('click', function () {
            var searchParams = { agentID: 0 };
            var searchParamsStr = JSON.stringify(searchParams);
            searchParamsStr = encodeURIComponent(searchParamsStr);
            me.execCommand('go', { a: 'business', b: 'agentmemberlist', params: { searchParams: searchParamsStr } });
        })
    }

    function bindGridEvent() {
        $('.btnDelete').off().on('click', function () {
            if (confirm("删除代理，会使该代理下的会员成为未分配区域会员，确定删除?")) {
                var id = $(this).attr('rid');
                var params = { id: id };
                $.ajax({
                    type: 'post',
                    url: '/admin/business/regionalagency?act=delete',
                    data: params,
                    dataType: 'json',
                    async: false,
                    cache: false,
                    success: function (json) {
                        if (json.success) {
                            $.showResult(true, "删除成功", 1500, function () {
                                bootbox.hideAll();
                                loadList(1);
                            });
                        } else {
                            $.showResult(false, json.msg);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $.showResult(false, XMLHttpRequest.responseText);
                    }
                });
            }
        });

        $('.btnShowMembers').off().on('click', function () {
            var searchParams = { agentID: $(this).attr('userid') };
            var searchParamsStr = JSON.stringify(searchParams);
            searchParamsStr = encodeURIComponent(searchParamsStr);
            me.execCommand('go', { a: 'business', b: 'agentmemberlist', params: { searchParams: searchParamsStr } });
            return false;
        })
    }

    var isSubmiting = false;
    function submitForm(form) {
        if (isSubmiting) return;
        isSubmiting = true;

        var params = $(form).serializeObject();
        params.userid = $(form).find('[name=userid]').attr('userid');
        $.ajax({
            type: 'post',
            url: '/admin/business/regionalagency?act=edit',
            data: params,
            dataType: 'json',
            async: false,
            cache: false,
            success: function (json) {
                if (json.success) {
                    $.showResult(true, "操作成功", 1500, function () {
                        bootbox.hideAll();
                        loadList(1);
                    });
                } else {
                    $.showResult(false, json.msg, '', function () {
                        $('.addNewFormModal .btnSubmit').prop('disabled', false);
                    });
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.showResult(false, XMLHttpRequest.responseText);
            },
            complete: function () {
                isSubmiting = false;
            }
        })
        return false;
    }

    me.addListener('regionalagencylist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['salesstatistics'] = function () {

    var me = this;

    var ViewModel = function () {
    	var self = this;
        self.todayList = ko.observableArray();
        self.yesterdayList = ko.observableArray();
        self.weekList = ko.observableArray();
        self.monthList = ko.observableArray();
        self.allList = ko.observableArray();
        self.getList = function (type) {
            if (type == 0) return self.todayList();
            else if (type == 1) return self.yesterdayList();
            else if (type == 2) return self.weekList();
            else if (type == 3) return self.monthList();
            else if (type == 4) return self.allList();
        }
        self.subSaleCount = function (type) {
            var list = self.getList(type);
            var count = 0;
            for (var i = 0; i < list.length ; i++) {
                count += list[i].SaleCount;
            }
            return count;
        };
        self.subQuantityCount = function (type) {
            var list = self.getList(type);
            var count = 0;
            for (var i = 0; i < list.length ; i++) {
                count += list[i].ProductQuantity;
            }
            return count;
        };
    };

    var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_SHOP')) {
            root.load("/index.php?c=admin/page/Versiontip&page=salesstatistics");
            return;
        }
        root.loadHtmlTpl("plugins/businesspackage/html/salesstatistics.html", function () {
            bindUIEvent();
            loadClsList();
            ko.applyBindings(vm, root[0]);
            //loadList();
            loadDefaultData(0);
        });
    }

    
    
    
	var classlist = null;
	function loadClsList() {
		$("#classid").children().remove();
		$("#classid").append("<option value=''>--全部分类--</option>");
		$.ajax({ url: "/index.php?c=admin/product/productmanage&a=GetClassList", async: false, dataType: "json", success: function (json) {
//		$.ajax({ url: "/admin/product/productmanage?act=GetClassList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					classlist = json.list;
					for(var i = 0;i < json.list.length;i++){
						if(json.list[i].ParentID == 0){
							$("#classid").append("<option value='"+ json.list[i].ClassID +"'>"+ json.list[i].Name +"</option>");
							for(var j = 0;j < json.list.length;j++){
								if(json.list[j].ParentID == json.list[i].ClassID){
								    $("#classid").append("<option value='" + json.list[j].ClassID + "'> &nbsp;&nbsp;└-" + json.list[j].Name + "</option>");
								    for (var k = 0; k < json.list.length; k++) {
								        if (json.list[k].ParentID == json.list[j].ClassID) {
								            $("#classid").append("<option value='" + json.list[k].ClassID + "'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└-" + json.list[k].Name + "</option>");
								        }
								    }
								}
							}
						}
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}

    function loadList(type, startTime, endTime) {
        var params = { startTime: startTime, endTime: endTime, type: type,classid : $("#classid").val() };
        $.getJSON("/index.php?c=admin/business/shopstatistics&a=sales_count", utils.params(params), function (json) {
//        $.getJSON("/admin/business/salesstatistics?act=getlist", utils.params(params), function (json) {
            if (!json.success) {
                alert(json.msg);
                return;
            }
            if (type == 0) {
                vm.todayList(json.list);
            } else if (type == 1) {
                vm.yesterdayList(json.list);
            } else if (type == 2) {
                vm.weekList(json.list);
            } else if (type == 3) {
                vm.monthList(json.list);
            } else if (type == 4) {
	            vm.allList(json.list);
	        }
        });
    }

    function loadListAndRefreshControl(type, startTime, endTime) {
        var dStartTime = new Date(startTime);
        var dEndTime = new Date(endTime);
        if (type == 0) {
            loadList(0, formatDate(dStartTime), formatDate(dEndTime));
            $('#dtTime [name=txStartTime]').datepicker('setDate', formatDate(dStartTime)).datepicker('update');
            $('#dtTime [name=txEndTime]').datepicker('setDate', formatDate(dEndTime)).datepicker('update');
        } else if (type == 1) {
            loadList(1, formatDate(dStartTime), formatDate(dEndTime));
            $('#dtTime [name=txStartTime]').datepicker('setDate', formatDate(dStartTime)).datepicker('update');
            $('#dtTime [name=txEndTime]').datepicker('setDate', formatDate(dEndTime)).datepicker('update');
        } else if (type == 2) {
            loadList(2, formatDate(dStartTime), formatDate(dEndTime));
            $('#dtTime [name=txStartTime]').datepicker('setDate', formatDate(dStartTime)).datepicker('update');
            $('#dtTime [name=txEndTime]').datepicker('setDate', formatDate(dEndTime)).datepicker('update');
        } else if (type == 3) {
            dStartTime = new Date(dStartTime.getFullYear() + '-' + (dStartTime.getMonth() + 1) + '-01');
            dEndTime = new Date(dEndTime.getFullYear() + '-' + (dEndTime.getMonth() + 2) + '-01');
            dEndTime.setDate(dEndTime.getDate() - 1);
            loadList(3, formatDate(dStartTime), formatDate(dEndTime));
            $('#dtTime [name=txStartTime]').datepicker('setDate', formatDate(dStartTime)).datepicker('update');
            $('#dtTime [name=txEndTime]').datepicker('setDate', formatDate(dEndTime)).datepicker('update');
        } else if (type == 4) {
            loadList(4, '', '');
        }
    }

    function loadDefaultData(type) {
        if (type == 0) {          	//今天
        	var nowDay = new Date();
        	var dStartTime = new Date();
        	var dEndTime = dStartTime;
        	loadListAndRefreshControl(0, dStartTime, dEndTime);
        } else if (type == 1) {     //昨天
            var dStartTime = new Date();
            dStartTime.setDate(dStartTime.getDate() - 1);
            var dEndTime = dStartTime;
            loadListAndRefreshControl(1, dStartTime, dEndTime);
        } else if (type == 2) {		//一周
            var dEndTime = new Date();
            var dStartTime = dEndTime;
            dStartTime.setDate(dStartTime.getDate() - 6);
            dEndTime = new Date();
            loadListAndRefreshControl(2, dStartTime, dEndTime);
        } else if (type == 3) {		//一月
            var dStartTime = new Date();
            dStartTime = new Date(dStartTime.getFullYear() + '-' + (dStartTime.getMonth() + 1) + '-01');
            var dEndTime = new Date();
            dEndTime = new Date(dEndTime.getFullYear() + '-' + (dEndTime.getMonth() + 2) + '-01');
            dEndTime.setDate(dEndTime.getDate() - 1);
            loadListAndRefreshControl(3, dStartTime, dEndTime);
        } else if (type == 4) {		//全部
            var dStartTime = new Date();
            dStartTime = new Date(dStartTime.getFullYear() + '-' + (dStartTime.getMonth() + 1) + '-01');
            var dEndTime = new Date();
            dEndTime = new Date(dEndTime.getFullYear() + '-' + (dEndTime.getMonth() + 2) + '-01');
            dEndTime.setDate(dEndTime.getDate() - 1);
            loadListAndRefreshControl(4, dStartTime, dEndTime);
        }
    }

    function bindUIEvent() {
        $('#ulStat a[data-toggle="tab"]').off().on('show.bs.tab', function (e) {
            if ($(this).attr('stattype') && $(this).attr('hasloaddefaultdata') != 1) {
                loadDefaultData($(this).attr('stattype'));
                $(this).attr('hasloaddefaultdata', 1);
            }
        })
      
        $('#dtTime').datepicker({
            format: "yyyy-mm-dd",
            clearBtn: true,
            language: "zh-CN",
            orientation: "bottom auto",
            todayHighlight: true,
            toggleActive: true,
            multidate: false
        });

        $("#btnSearch").off('click').on('click', function (event) {
            var type = $('#ulStat li.active >a').attr('stattype');
            loadList(type, $('#dtTime input[name=txStartTime]').val(), $('#dtTime input[name=txEndTime]').val());
        });

        
        $('#ulStat a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            if ($(e.target).is("a[href=#tabToday]")) {
                loadDefaultData($(this).attr('stattype'));
            } 
            if ($(e.target).is("a[href=#tabYesterday]")) {
            	loadDefaultData($(this).attr('stattype'));
            }
            if ($(e.target).is("a[href=#tabrecently]")) {
            	loadDefaultData($(this).attr('stattype'));
            }
            if ($(e.target).is("a[href=#tabMonth]")) {
            	loadDefaultData($(this).attr('stattype'));
            }
            if ($(e.target).is("a[href=#tabAll]")) {
            	loadDefaultData($(this).attr('stattype'));
            }
        });
    }

    function formatDate(date, format) {
        var month = date.getMonth() + 1;
        if ((month + '').length == 1) month = '0' + month;
        var ri = date.getDate();
        if ((ri + '').length == 1) ri = '0' + ri;

        if (format == 'yyyy-mm') {
            return date.getFullYear() + '-' + month;
        }
        return date.getFullYear() + '-' + month + '-' + ri;
    }

    me.addListener('salesstatistics', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['shopconfig'] = function () {

    var me = this;

    var myroot = null;
	var fenxiaoMaxLevel = 20;
    function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_FENXIAO')) {
            root.load("/index.php?c=admin/page/Versiontip&page=shopconfig");
            return;
        }
        root.loadHtmlTpl("plugins/businesspackage/html/shopconfig.html?v=" + Math.random(), function () {
            myroot = root[0];
            if (me.hasLicensePerm('ENABLE_AGENT')) {
                $('[aboutagent="1"]').show();
            } else {
                $('[aboutagent="1"]').remove();
                // $.get("/index.php?c=admin/page/Versiontip&page=shopconfig&msgtype=alert", null, function (json) {
                //     $('#EnableAgent').popover({
                //         content:json,
                //         placement:'bottom',
                //         title:'注意',
                //     });
                // });
                // $('#EnableAgent').unbind('click').click(function(){
                //     $('body').unbind('click').click(function (event) {
                //         var target = $(event.target);
                //         if (!target.hasClass('popover') && target.parent('popover-content').length === 0 && target.parent('popover-title').length === 0 && target.parent('popover').length === 0 && target.data('toggle') !== 'popover' && target.prop("tagName") != 'INPUT') {
                //             $('#EnableAgent').popover('hide');
                //         }
                //     });
                //     $("#EnableAgent").prop("checked",false);
                //     return;
                // });
            }
            

            $('#BtnSave').floatSaveBtn();
			
            loadConfig();
            bindUIEvent();
        });
    }

    function loadConfig() {
    	$.getJSON("/index.php?c=admin/business/shopconfig&a=getinfo", null, function (json) {
    		json.info.proxy_delivery=me.hasLicensePerm('ENABLE_AGENT_PROXY_DELIVERY');
			fenxiaoMaxLevel = json.info.FenXiaoMaxLevel;
			if(fenxiaoMaxLevel == 1) $('#FenXiaoLevel').prop('readonly', true).closest('tr').hide();
			else $('#FenXiaoLevel').prop('readonly', false).closest('tr').show();
			if(parseInt(json.info.FenXiaoLevel) > fenxiaoMaxLevel) json.info.FenXiaoLevel = fenxiaoMaxLevel;
            ko.applyBindings({ config: json.info}, myroot);
            try {
                eval("var yongJin = " + (json.info.FenXiaoYongJin || '{}'));
                eval("var agentYongJin = " + (json.info.AgentYongJin || '{}'));
                var agentLevel=json.info.AgentLevel;
                var level = 0;
                for (var k in yongJin) { level++; }
                if (level > json.info.FenXiaoLevel) level = json.info.FenXiaoLevel;
                addFenXiaoLevel(level, yongJin);
            } catch (e) { }

            try {
                eval("var agentYongJin = " + (json.info.AgentYongJin || '{}'));
                var level = 0;
                for (var k in agentYongJin) { level++; }
                if (level > json.info.AgentLevel) level = json.info.AgentLevel;
                addAgentLevel(level, agentYongJin);
            } catch (e) { }

            if($('.BtnSelBg').eq(3).hasClass('selectedbg')){
                $('.customCon').css({'display':'block','padding':'8px'});
            }
            if($('#FenXiaoQRCode').val()== '/images/SelBg1.jpg'){
                $('.BtnSelBg').removeClass('selectedbg');
                $('.BtnSelBg').eq(0).addClass('selectedbg');
            }else if($('#FenXiaoQRCode').val()== '/images/SelBg2.jpg'){
                $('.BtnSelBg').removeClass('selectedbg');
                $('.BtnSelBg').eq(1).addClass('selectedbg');
            }else if($('#FenXiaoQRCode').val()== '/images/SelBg3.jpg'){
                $('.BtnSelBg').removeClass('selectedbg');
                $('.BtnSelBg').eq(2).addClass('selectedbg');
            }else{
                $('.BtnSelBg').removeClass('selectedbg');
                $('.BtnSelBg').eq(3).addClass('selectedbg');
            }

            var src = json.info.FenXiaoQRCode;
            if (!src) src = "/images/SelBg1.jpg";
            $("#tdFenXiaoQRCode").prepend("<img id='FenXiaoQRCodePreview' src='" + src + "' height='400' draggable='false'/>");
            /*
            if (!json.info.FenXiaoQRCodeTipsLeft) $("#FenXiaoQRCodeTipsLeft").val(15);
            if (!json.info.FenXiaoQRCodeTipsTop) $("#FenXiaoQRCodeTipsTop").val(30);
            if (!json.info.FenXiaoFontSize) $("#FenXiaoFontSize").val(14);

            if (!json.info.FenXiaoQRCodeLeft) $("#FenXiaoQRCodeLeft").val(16);
            if (!json.info.FenXiaoQRCodeTop) $("#FenXiaoQRCodeTop").val(66);

            if (!json.info.FenXiaoHeadLeft) $("#FenXiaoHeadLeft").val(35);
            if (!json.info.FenXiaoHeadeTop) $("#FenXiaoHeadeTop").val(15);*/
			calTichengDemoList();			
			
			 $("#BtnSave").unbind().bind('click', function (event) {
		            var params = $('#ShopConfigForm').serializeObject();
		            var percent = 0;
		            var agentfee = parseFloat($('#AgentSiteFee').val());
		            var fenXiaoLevel = parseInt($('#FenXiaoLevel').val());
		 //           var agentLevel = parseInt($('#AgentLevel').val());

		            if ($("#EnableFenXiao").prop("checked")) {
		                $('[id^=FenXiaoYongJin]').each(function () {
		                    var num = $(this).attr('id').replace(/FenXiaoYongJin/i, '');
		                    if (num > fenXiaoLevel) return true;
		                    percent += parseFloat('0' + $(this).val());
		                });
		            }

		            //检查分销+代理提成的比例是否超过100%
		            if(me.hasLicensePerm('ENABLE_AGENT'))
		            {
		            	for(var a=1;a<=agentLevel;a++)
		            	{
		            		//你hold得住人家才行的啊
		            		percent+=parseFloat(agentYongJin['level'+a]);
		            	}
		            }
		            /*
		            for (var key in params) {
		                if (/^FenXiaoYongJin\d+/.test(key) || /^AgentYongJin\d+/.test(key)) {
		                    if(/^AgentYongJin\d+/.test(key) && $("#EnableAgent").prop("checked") == false) continue;
							if(/^FenXiaoYongJin\d+/.test(key) && $("#EnableFenXiao").prop("checked") == false) continue;
		                    // percent += parseFloat(('0' + params[key]).toFixed(2));
							percent += parseFloat('0' + params[key]);
		                }
		            }
		            */

		            if (isNaN(percent)) {
		                $.showResult(false, "代理或分销的总提成输入格式有误");
		                return;
		            }

		            if (percent > 100) {
		                $.showResult(false, "代理+分销的总提成点不能超过100%");
		                return;
		            }
		            if(agentfee>100||agentfee<0||isNaN(agentfee) && $("input[name='EnableAgentDelivery']:checked").val() ){
		            	$.showResult(false,"平台手续费只能0-100的小数");
		            	return ;
		            }
		            	

		            if (!/^\d+$/.test($('[name=MinTiXian]').val())) {
		                $.showResult(false, '最小提现金额请请输入正整数');
		                return;
		            }

		            if (!/^\d+$/.test($('[name=FenXiaoMinAmount]').val())) {
		                $.showResult(false, '分销员最低必须消费金额请输入正整数');
		                return;
		            }

		            var flag = true;
		            $('[name^=FenXiaoYongJin]').each(function () {
		                if (this.value != '' && !/^[0-9]+([.]{1}[0-9])?$/.test(this.value)) {
		                    $.showResult(false, '只能保留一位小数');
		                    flag = false;
		                    return false;
		                }
		            });
		            $('[name^=AgentYongJin]').each(function () {
		                // if (this.value != '' && !/^\d+$/.test(this.value)) {
		                if (this.value != '' && !/^[0-9]+([.]{1}[0-9])?$/.test(this.value)) {
		                    $.showResult(false, '只能保留一位小数');
		                    flag = false;
		                    return false;
		                }
		            });
		            if (!flag) return;
		            /*
		            if (percent < 100 && $("#EnableAgent").prop("checked") == true) {
		                var dialog = bootbox.dialog({
		                    title: '提示',
		                    message: '<div style="font-size:14px;">您开启的代理+分销设置百分比必须为100% </br><font style="color:red;">注意：商家只拿到产品代理底价，利润全部分配给代理和分销员！</font></br>如有疑问请查看代理/分销价格表！</div>',
		                    buttons: {
		                        confirm: {
		                            label: "确定",
		                            className: 'btn-success',
		                            callback: function () {
		                               savejson(params);
		                            }
		                        },
		                        close1: {
		                            label: "取消",
		                            className: "btn-default",
		                            callback: function () {
		                                $(this).modal('hide');
		                            }
		                        }
		                      
		                    }
		                });
		                return;
		            }

		            if (me.hasLicensePerm('ENABLE_AGENT')) {
		                if (percent == 100 || (percent < 100 && $("#EnableAgent").prop("checked") == false)) {
		                    savejson(params);
		                };
		            } else {
		                // 没有代理权限，小于等于100可以保存
		                savejson(params);
		            }
		            
		            return false;
		            */
		            savejson(params);
		            $.showResult(true, "保存成功", 2000);
		            
		        });
		        function savejson (params) {  
		            //$.post("/admin/business/shopconfig?act=editfenxiaoconfig", params, function (data, textStatus, jqXHR) {
		        	$.post("/index.php?c=admin/business/shopconfig&a=editfenxiaoconfig", params, function (data, textStatus, jqXHR) {
		                if (data.success) {
		                    $.showResult(true, "保存成功", 2000);
		                } else {
		                    $.showResult(false, data.msg);
		                }
		            }, "json");
		        }

        });
    }

	function calTichengDemoList(){
		var price = 1000;
		var amount = 600;
		var chengben = 400;
		//计算代理的提成
		var EnableAgent = $("#EnableAgent").prop("checked");
		var AgentLevel = parseInt($("#AgentLevel").val());
		var ahtml = "";
		var allAgentMoney = 0;
		var allpercent = 0;
		if(EnableAgent){
			ahtml = "<b>代理提成表：</b><table class='table table-hover table-bordered'><tr><td>代理级别</td><td>下级用户购买提成</td><td>代理拿货价</td></tr>";
			for(var i = 1;i <= AgentLevel;i++){
				var percent = $("#AgentYongJin" + i).val();
				percent = percent / 100;
				ahtml += "<tr><td>" + i + " 级代理</td><td><font color='red'>"+ parseFloat((amount * percent).toFixed(2)) +"</font> 元</td><td><font color='red'>"+ parseFloat((chengben + amount * allpercent).toFixed(2)) +"</font> 元</td></tr>";
				allpercent += percent;
				allAgentMoney += parseFloat((amount * percent).toFixed(2));
			}
			ahtml += "</table>";
			if(me.hasLicensePerm('ENABLE_AGENT_PROXY_DELIVERY'))
				$('.agent_delivery').show();
			$('.agent_binding').show();
			$('.agent_decoration').show();
			$('.agent_coupon').show();
		}
		else
		{
			$('.agent_delivery').hide();
			$('.agent_binding').hide();
			$('.agent_decoration').hide();
			$('.agent_coupon').hide();
		}
		
		//计算分销员的提成
		var EnableFenXiao = $("#EnableFenXiao").prop("checked");
		var FenXiaoLevel = parseInt($("#FenXiaoLevel").val());
		var html = "";
		if(EnableFenXiao){
			html = "<b>分销员提成表：</b><br>";
			var allFenXiaoMoney = 0;
			for(var i = 1;i <= FenXiaoLevel;i++){
				var percent = $("#FenXiaoYongJin" + i).val();
				percent = percent / 100;
				html += i + " 级分销提成：<font color='red'>"+ parseFloat((amount * percent).toFixed(2)) +"</font> 元<br>";
				allFenXiaoMoney += parseFloat((amount * percent).toFixed(2));
			}
		}
		//算出商家最终得到的钱
		var shtml = "商家最终得到： <font color='red'>"+ (EnableAgent ? chengben : (price - allFenXiaoMoney)) +"</font> 元" + (EnableAgent ? "(当有代理时，商家与一级代理间是底价结算)":"");
		shtml += "<br><br>如果商家不希望以底价结算，那可以将代理会员都设置为二级以上代理，那么商家得到的钱就是 底价+ 一级代理的提成，如此类推";
		$("#divTichengDemoList").html(ahtml + html + shtml);
	}

	function loadPrice(){
		//先加载独立的分成配置表
		var productFenXiaoSetting = null;
		//$.ajax({ url: "/admin/product/ProductFenXiaoSetting?act=getlist", async: false, dataType: "json", success: function (json) {
		$.ajax({ url: "/index.php?c=admin/product/Productfenxiaosetting&a=getlist", async: false, dataType: "json", success: function (json) {	
				productFenXiaoSetting = json.list;
			}
		});

		var params = { sid: me.sid,keyword: $("#pricekeyword").val(), page: 1, pagesize: 2000 };
		//$.getJSON("/admin/product/productmanage?act=getlist", utils.params(params), function (productdata) {
		$.getJSON("/index.php?c=admin/product/productmanage&a=getlist", utils.params(params), function (productdata) {
            var products = productdata.list;

			//$.getJSON("/admin/business/shopconfig?act=getinfo", null, function (configdata) {
            $.getJSON("/index.php?c=admin/business/shopconfig&a=getinfo", null, function (configdata) {
				var config = configdata.info;
				if(config.FenXiaoYongJin == ''){
					config.FenXiaoYongJin = '{}';
				}
				if(config.AgentYongJin == ''){
					config.AgentYongJin = '{}';
				}
				eval("var FenXiaoYongJin = " + (config.FenXiaoYongJin || '{}'));
				eval("var AgentYongJin = " +(config.AgentYongJin || '{}'));
				var html = "";
				if(config.EnableAgent == 1){
					html += "说明：代理直接分销提成 = 产品销售价 - 代理拿货价 - 总分销提成，下级代理销售提成 = 下级代理拿货价 - 自己拿货价";
				}
				html += "<table class='table table-bordered' style='background:white'><tr>";
				html += "<td rowspan='2' scope='row'>编号</td>";
				html += "<td rowspan='2'>名称</td>";
				html += "<td rowspan='2'>代理底价</br>(最高级代理商)</td>";
				html += "<td rowspan='2'>销售价</td>";
				if(config.EnableAgent == 1) html += "<td colspan='"+ config.AgentLevel +"'>代理拿货价/下级用户购买提成</td>";
				html += "<td colspan='"+ config.FenXiaoLevel +"'>分销提成</td>";
				html += "</tr>";
				html += "<tr>";
				if(config.EnableAgent == 1){
					for(var i = 1;i <= config.AgentLevel;i++){
						html += "<td>"+ i +"级代理("+AgentYongJin['level' + i]+"%)</td>";
					}
				}
				for(var i = 1;i <= config.FenXiaoLevel;i++){
					html += "<td>"+ i +"级分销("+FenXiaoYongJin['level' + i]+"%)</td>";
				}
				html += "</tr>";
				for(var i = 0;i < products.length;i++){
					var flag = false;
					eval("var FenXiaoYongJinPro = " + config.FenXiaoYongJin);
					eval("var AgentYongJinPro = " + config.AgentYongJin);
					if(productFenXiaoSetting && productFenXiaoSetting.length > 0){
						for(var v = 0; v < productFenXiaoSetting.length;v++){
							if(productFenXiaoSetting[v].ID == products[i].FenXiaoID){
								eval("FenXiaoYongJinPro = " + productFenXiaoSetting[v].FenXiaoYongJin);
								eval("AgentYongJinPro = " + productFenXiaoSetting[v].AgentYongJin);
								flag = true;
								break;
							}
						}
					}

					var amount = products[i].Price - products[i].CostPrice;
					var proname = products[i].Name;
					if(proname.length > 10) proname = proname.substring(0,10) + "...";
					if(flag) proname = "<font color='red'>" + proname + "</font>";
					var allfenxiaopercent = 0;
					var allfenxiaomoney2 = 0;
					for(var level = 1;level <= config.FenXiaoLevel;level++){
						var key = "level" + level;
                        if (FenXiaoYongJinPro[key] && FenXiaoYongJinPro[key].toString().substr(0,1) == "$")
                        {
                            allfenxiaomoney2 += parseFloat("0" + FenXiaoYongJinPro[key].substr(1));
                            flag = true;
                        }
                        else
                        {
							var percent = FenXiaoYongJinPro[key];
							percent /= 100;
							allfenxiaopercent += percent;
						}
					}
					var allfenxiaomoney = 0;
					if (flag) allfenxiaomoney = allfenxiaomoney2;
					else allfenxiaomoney = parseFloat((allfenxiaopercent * amount).toFixed(2));

					html += "<tr>";
					html += "<td rowspan='2'>"+ (i+1) +"</td>";
					html += "<td rowspan='2'><a href='#' class='productinfo' productid='"+ products[i].ProductID +"' title='"+ products[i].Name +"'>"+ proname +"</a></td>";
					html += "<td rowspan='2'>"+ products[i].CostPrice +"</td>";
					html += "<td rowspan='2'>"+ products[i].Price +"</td>";
					var agentpercent = 0;
					var agentprice = 0;
					if(config.EnableAgent == 1){
						for(var level = 1;level <= config.AgentLevel;level++){
							var percent = 0;
                            var m1 = 0;
                            var m2 = 0;
                            var key = "level" + level;
							if (AgentYongJinPro[key] && AgentYongJinPro[key].toString().substr(0,1) == "$")
                            {
                                m1 = parseFloat("0" + AgentYongJinPro[key].substr(1));
                                var keynext = "level" + (level + 1);
                                if (AgentYongJinPro[keynext] && AgentYongJinPro[keynext].toString().substr(0,1) == "$"){
                                    m2 = parseFloat("0" + AgentYongJinPro[keynext].substr(1)) - m1;
                                }
                            }
                            else
                            {
                                percent = AgentYongJinPro[key];
                                m1 = products[i].CostPrice + parseFloat((agentpercent * amount).toFixed(2));
                                m2 = parseFloat((percent / 100 * amount).toFixed(2));
                                agentpercent += percent / 100;
                            }

                            var m3 = parseFloat((products[i].Price - m1 - allfenxiaomoney).toFixed(2)); //销价-自己拿货价-总分销提成
                            html +=("<td rowspan='2'>拿货价：<font color='green'>" + m1 + "</font>");
                            if (level < config.AgentLevel) html += ("<br><font color='blue'>下级代理销售提成：" + m2 + "</font>");
                            html +=("<br><font color='#684b20'>直接分销提成：" + m3 + "</font></td>");
						}
					}
					html += "<td colspan='"+ config.FenXiaoLevel +"' align='center'>总分成："+ allfenxiaomoney +" 元</td>";
					html += "</tr><tr>";
					for(var level = 1;level <= config.FenXiaoLevel;level++){
						var key = "level" + level;
                        var m1 = 0;
                        if (FenXiaoYongJinPro[key] && FenXiaoYongJinPro[key].toString().substr(0,1) == "$")
                        {
                            m1 = parseFloat("0" + FenXiaoYongJinPro[key].substr(1));
                        }
                        else
                        {
							var percent = FenXiaoYongJinPro['level' + level];
							percent /= 100;
                            m1 = parseFloat((percent * amount).toFixed(2));
						}
						html += "<td>";
						html += "<font color='red'>"+ m1 +"</font></td>";
					}
					html += "</tr>";
				}
				html += "</table>";
				$("#FenXiaoPriceList").html(html);
				$("#FenXiaoPriceList .productinfo").unbind().click(function(element){
					me.execCommand('go', { a: 'business', b: 'productedit', params: { id: $(this).attr("productid") } });
					return false;
				});
			});
			//console.log(products);//ProductID Price CostPrice Name
        });
	}

    function bindUIEvent() {

		$("#FenXiaoTable",myroot).unbind("change").change(function(){
			calTichengDemoList();
		});
		$("#BtnExportPriceList").unbind().click(function(){
			//window.open("/admin/business/shopconfig?act=exportpricelist");
			window.open("/index.php?c=admin/business/shopconfig&a=exportpricelist");
		});
		$("#BtnSearch").unbind().click(loadPrice);
        $("#FenXiaoFontSize").unbind().bind("change",markTipsPosition);
        $("#BtnMarkTips").unbind().click(markTipsPosition);
        $("#BtnMarkQrcode").unbind().click(markQrCodePosition);
        $("#BtnMarkHead").unbind().click(markHeadPosition);

        $('.subTab a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            if ($(e.target).is("a[href=#divFenXiaoQRCode]")) {
                $("#markTipsPosition,#markQrcodePosition,#markHeadPosition").show();
            } else {
                $("#markTipsPosition,#markQrcodePosition,#markHeadPosition").hide();
            }

            if ($(e.target).is("a[href=#FenXiaoPriceTable]")) {
                //$("#BtnSave").hide();
                $(".floatSaveBox").hide();
                loadPrice();
            }
            else {
                //$("#BtnSave").show();
                $(".floatSaveBox").show();
            }

            if ($(e.target).is("a[href=#divFenXiaoQRCode]")) {
                markTipsPosition();
                markQrCodePosition();
                markHeadPosition();
            }
        });
        $('.BtnSelBg').click(function  () {
            $('.BtnSelBg').removeClass('selectedbg');
            $(this).addClass('selectedbg');
            if ($(this).index() == 0) {
                $('#FenXiaoQRCode').val('/images/SelBg1.jpg');
                $('#FenXiaoQRCodePreview').attr('src','/images/SelBg1.jpg');
            }else if($(this).index() == 1){
                $('#FenXiaoQRCode').val('/images/SelBg2.jpg');
                $('#FenXiaoQRCodePreview').attr('src','/images/SelBg2.jpg');
            }else if($(this).index() == 2){
                $('#FenXiaoQRCode').val('/images/SelBg3.jpg');
                $('#FenXiaoQRCodePreview').attr('src','/images/SelBg3.jpg');
            }else if ($(this).index() == 3) {
                $('#FenXiaoQRCode').val(' ');
                $('#FenXiaoQRCodePreview').attr('src','/images/SelBg4.jpg');
            };
             if ($(this).hasClass('selectedbg') && $(this).index() == 3) {
                $('.customCon').css({'display':'block','padding':'8px'});
            }else{
                $('.customCon').css({'display':'none','padding':'0px'});
            };

        })

        $("#BtnSelQRCode").unbind('click').bind("click", function () {
            top.YDM.FileManager('image', 1, function (aUrl) {
                if (aUrl.length > 0) {
                    $('#FenXiaoQRCode').val(aUrl[0]);
                    $('#FenXiaoQRCodePreview').attr('src', aUrl[0]);
                }
            })
        });
       
        $("#DisabledButton").unbind().bind("click", function () {
            if ($(this).val() == 0) {
                $(this).val(1);
            } else {
                $(this).val(0);
            }
        });

        $("#FenXiaoLevel").off("keyup").on('keyup', function () {
            var value = $(this).val();
            if (value.length == 1) {
                value = value.replace(/[^1-9]/g, '');
            } else {
                value = value.replace(/\D/g, '');
            }
            $(this).val(value);
        }).off("afterpaste").on("afterpaste", function () {
            var value = $(this).val();
            if (value.length == 1) {
                value = value.replace(/[^1-9]/g, '');
            } else {
                value = value.replace(/\D/g, '');
            }
            $(this).val(value);
        }).off("change").on("change", function () {
			var val = parseInt($(this).val());
			if(!isNaN(val) && val > fenxiaoMaxLevel){
				$(this).val(fenxiaoMaxLevel);
			}
            addFenXiaoLevel(parseInt($(this).val()));
        });

        $("#AgentLevel").off("keyup").on('keyup', function () {
            var value = $(this).val();
            if (value.length == 1) {
                value = value.replace(/[^1-9]/g, '');
            } else {
                value = value.replace(/\D/g, '');
            }
            $(this).val(value);
        }).off("afterpaste").on("afterpaste", function () {
            var value = $(this).val();
            if (value.length == 1) {
                value = value.replace(/[^1-9]/g, '');
            } else {
                value = value.replace(/\D/g, '');
            }
            $(this).val(value);
        }).off("change").on("change", function () {
            addAgentLevel(parseInt($(this).val()));
        });

        $("#FenXiaoQRCodeSize").off("keyup").on('keyup', function () {
            var value = $(this).val();
            if (value.length == 1) {
                value = value.replace(/[^1-9]/g, '');
            } else {
                value = value.replace(/\D/g, '');
            }
            $(this).val(value);
        }).off("afterpaste").on("afterpaste", function () {
            var value = $(this).val();
            if (value.length == 1) {
                value = value.replace(/[^1-9]/g, '');
            } else {
                value = value.replace(/\D/g, '');
            }
            $(this).val(value);
        }).off("change").on("change", function () {
            var qrsize = parseInt($("#FenXiaoQRCodeSize").val());
            var bili = 63 / 200 * qrsize; //计算图例的二维码与真实尺寸的比例
            $("#markQrcodePosition").css({ width: bili + 'px', height: bili + 'px' });
        });

        $('#ShowFenXiaoAlly').off().on('click', function () {
            if ($(this).prop('checked')) {
                $('#ShowFenXiaoAllyLevel2, #ShowFenXiaoAllyLevel3, #ShowFenXiaoAllyLevelOther').prop('disabled', false);
            } else {
                $('#ShowFenXiaoAllyLevel2, #ShowFenXiaoAllyLevel3, #ShowFenXiaoAllyLevelOther').prop('checked', false).prop('disabled', true);
            }
        });
    }

    function addFenXiaoLevel(level, values) {
		if(level > fenxiaoMaxLevel){
			level = fenxiaoMaxLevel;
		}
        for (var i = 1; i <= level; i++) {
            var obj = $("#trXiaoYongJin" + i);
            if (obj.length == 0) {
                obj = $("<tr id='trXiaoYongJin" + i + "'><td style='text-align:right;'>" + i + " 级分销提成：</td><td><input type='text' class='form-control input' id='FenXiaoYongJin" + i + "' name='FenXiaoYongJin" + i + "'>%</td></tr>").insertBefore($("#trMinTiXian"));
            } else {
                obj.show();
            }
            if (values && values['level' + i]) {
                obj.find("input").val(values['level' + i]);
            }
        }
        for (var i = level + 1; i <= 100; i++) {
            var obj = $("#trXiaoYongJin" + i);
            if (obj.length > 0) {
                obj.hide();
            }
        }
        
    }

    function addAgentLevel(level, values) {
        for (var i = 1; i <= level; i++) {
            var obj = $("#trAgentYongJin" + i);
            if (obj.length == 0) {
                obj = $("<tr id='trAgentYongJin" + i + "'><td style='text-align:right;'>" + i + " 级代理提成：</td><td><input type='text' class='form-control input' id='AgentYongJin" + i + "' name='AgentYongJin" + i + "'>%</td></tr>").insertBefore($("#trAgentEnd"));
            } else {
                obj.show();
            }
            if (values && values['level' + i]) {
                obj.find("input").val(values['level' + i]);
            }
        }
        for (var i = level + 1; i <= 100; i++) {
            var obj = $("#trAgentYongJin" + i);
            if (obj.length > 0) {
                obj.hide();
            }
        }
    }
    var headLeft = 0, headTop = 0;
    function markHeadPosition() {
        $("#markHeadPosition").remove();
        $(myroot).append("<div id='markHeadPosition' style='position:absolute;width:85px;height:85px;border-radius:50%;overflow:hidden;padding:0;border:0;cursor:move;'><img src='/images/share/head.png' width='100%'></div>");
        var img = $("#FenXiaoQRCodePreview");
        var imgpos = $("#FenXiaoQRCodePreview").position();
        $("#markHeadPosition").css({ top: imgpos.top + "px", left: imgpos.left + "px", width: '85px', height: '85px' });
        headLeft = parseFloat($("#FenXiaoHeadLeft").val());
        headTop = parseFloat($("#FenXiaoHeadeTop").val());
        if (headLeft) $("#markHeadPosition").css("left", imgpos.left + img.width() * headLeft / 100);
        if (headTop) $("#markHeadPosition").css("top", imgpos.top + img.height() * headTop / 100);
        $("#markHeadPosition").draggable({
            containment: $("#FenXiaoQRCodePreview"),
            drag: function (event, ui) {
                headLeft = ((ui.position.left - imgpos.left) / $("#FenXiaoQRCodePreview").width() * 100).toFixed(2);
                headTop = ((ui.position.top - imgpos.top) / $("#FenXiaoQRCodePreview").height() * 100).toFixed(2);
                console.log(headLeft + "," + headTop);
                $("#FenXiaoHeadLeft").val(headLeft);
                $("#FenXiaoHeadeTop").val(headTop);
            }
        });
    }
    var tipsLeft = 0, tipsTop = 0;
    function markTipsPosition() {
        $("#markTipsPosition").remove();
        $(myroot).append("<div id='markTipsPosition' style='position:absolute;width:200px;height:50px;background:none;border:0;padding:0;color:white;cursor:move;white-space:nowrap;'><span style='width: 10em;display: inline-block;overflow: hidden;'>我是XX</span><br>向您推荐 XXXXXX</div>");
        var img = $("#FenXiaoQRCodePreview");
        var imgpos = $("#FenXiaoQRCodePreview").position();
        var fontSize = parseInt($("#FenXiaoFontSize").val());
        $("#markTipsPosition").css({ 'top': imgpos.top + "px", 'left': imgpos.left + "px",'font-size':fontSize +"px" });
        tipsLeft = parseFloat($("#FenXiaoQRCodeTipsLeft").val());
        tipsTop = parseFloat($("#FenXiaoQRCodeTipsTop").val());
        if (tipsLeft) $("#markTipsPosition").css("left", imgpos.left + img.width() * tipsLeft / 100);
        if (tipsTop) $("#markTipsPosition").css("top", imgpos.top + img.height() * tipsTop / 100);
        $("#markTipsPosition").draggable({
            containment: $("#FenXiaoQRCodePreview"),
            drag: function (event, ui) {
                tipsLeft = ((ui.position.left - imgpos.left) / $("#FenXiaoQRCodePreview").width() * 100).toFixed(2);
                tipsTop = ((ui.position.top - imgpos.top) / $("#FenXiaoQRCodePreview").height() * 100).toFixed(2);
                console.log(tipsLeft + "," + tipsTop);
                $("#FenXiaoQRCodeTipsLeft").val(tipsLeft);
                $("#FenXiaoQRCodeTipsTop").val(tipsTop);
            }
        });
    }

    var qrcodeLeft = 0, qrcodeTop = 0;
    function markQrCodePosition() {
        $("#markQrcodePosition").remove();
        $(myroot).append("<div id='markQrcodePosition' style='position:absolute;width:80px;height:80px;overflow:hidden;color:white;padding:0;border:0;cursor:move;'><img src='plugins/businesspackage/html/skinsrc/images/qrcode.jpg' width='100%'></div>");
        var img = $("#FenXiaoQRCodePreview");
        var imgpos = $("#FenXiaoQRCodePreview").position();
        var qrsize = parseInt($("#FenXiaoQRCodeSize").val());
        if (!qrsize) qrsize = 200;
        var bili = 63 / 200 * qrsize; //计算图例的二维码与真实尺寸的比例
        $("#markQrcodePosition").css({ top: imgpos.top + "px", left: imgpos.left + "px", width: bili + 'px', height: bili + 'px' });
        qrcodeLeft = parseFloat($("#FenXiaoQRCodeLeft").val());
        qrcodeTop = parseFloat($("#FenXiaoQRCodeTop").val());
        if (qrcodeLeft) $("#markQrcodePosition").css("left", imgpos.left + img.width() * qrcodeLeft / 100);
        if (qrcodeTop) $("#markQrcodePosition").css("top", imgpos.top + img.height() * qrcodeTop / 100);
        $("#markQrcodePosition").draggable({
            containment: $("#FenXiaoQRCodePreview"),
            drag: function (event, ui) {
                qrcodeLeft = ((ui.position.left - imgpos.left) / $("#FenXiaoQRCodePreview").width() * 100).toFixed(2);
                qrcodeTop = ((ui.position.top - imgpos.top) / $("#FenXiaoQRCodePreview").height() * 100).toFixed(2);
                console.log(qrcodeLeft + "," + qrcodeTop);
                $("#FenXiaoQRCodeLeft").val(qrcodeLeft);
                $("#FenXiaoQRCodeTop").val(qrcodeTop);
            }
        });
    }

    me.addListener('shopconfig', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['shoppingmallconfig'] = function () {

    var me = this;

    var myroot = null;
    var ViewModel = function () {
        this.setData = function (data) {
            for (var key in data) {
                if (typeof (data[key]) == "object") this[key] = ko.observableArray(data[key]);
                else this[key] = ko.observable(data[key]);
            }
        };
    };
    var vm = new ViewModel();

    function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_SHOP')) {
            root.load("/index.php?c=admin/page/Versiontip&page=shoppingmallconfig");
            return;
        }
        root.loadHtmlTpl("plugins/businesspackage/html/shoppingmallconfig.html?v=" + Math.random(), function () {
            myroot = root[0];
            bindUIEvent();
            loadConfig();
            loadPaymentConfig();
            ko.applyBindings(vm, myroot);
        });
    }

    function loadConfig() {
        $.ajax({
            type: 'get',
            //url: '/admin/business/shopconfig?act=getinfo',
            url: '/index.php?c=admin/business/shopconfig&a=getinfo',
            cache: false,
            async: false,
            data: {},
            dataType: 'json',
            success: function (json) {
                vm.setData(json.info);
                try{
                    eval("var freightData = " + json.info.FreightSetting);
                    if (freightData && freightData.RelieveFreightItem.length > 0) {
                        for (var i = 0; i < freightData.RelieveFreightItem.length; i++) {
                            addFreight(freightData.RelieveFreightItem[i].OrderMoney, freightData.RelieveFreightItem[i].Freight);
                        }
                    }
                }catch(ex){
                }
            }
        })
    }

    function loadPaymentConfig() {
        $.ajax({
            type: 'get',
            //url: '/admin/business/shopconfig?act=getpaymentconfig',
            url: '/index.php?c=admin/business/shopconfig&a=getpaymentconfig',
            cache: false,
            async: false,
            dataType: 'json',
            data: {},
            success: function (json) {
                vm.setData(json.info);
            }
        })
    }

    function bindUIEvent() {
        // if (!me.hasLicensePerm('ENABLE_SHOP')) {
            // $("#ShopConfigForm").before("<b style='color:red'>当前版本不支持商城功能，仅用于测试，如要使用请升级至高版本！</b>");
            //return;
        // }

        $("#BtnSave").off().on('click', function (event) {
            if ($('#slEnableShop').val() == '1' && $('#slEnableTransferPay').val() == '1') {
                var errMsg = '';
                if ($.trim($('#txTransferPayContactMobile').val()) == '') {
                    errMsg = '请设置商家电话';
                }
                if ($.trim($('#txTransferPayContactQQ').val()) == '') {
                    errMsg = '请设置商家QQ';
                }
                if ($.trim($('#txTransferPayContactWxQrCode').val()) == '') {
                    errMsg = '请设置联系人微信二维码';
                }
                if (errMsg) {
                    $('[href="#divTransferPay"]').click();
                    setTimeout(function () { alert(errMsg); }, 300);
                    return false;
                }
            }

            var params = $('#ShopConfigForm').serializeObject();
            //$.post("/admin/business/shopconfig?act=updateshopbaseinfo", params, function (data, textStatus, jqXHR) {
            $.post("/index.php?c=admin/business/shopconfig&a=updateshopbaseinfo", params, function (data, textStatus, jqXHR) {
                if (data.success) {
                    $.showResult(true, "保存成功", 1500);
                } else {
                    $.showResult(false, data.msg);
                }
            }, "json");
            return false;
        });

        $('#BtnSave').floatSaveBtn();

        $(".btnCert").off("click").on("click", function () {
            YDM.FileManager('file', 1, function (aUrl) {
                if (aUrl.length > 0) {
                    $("#APICertPath").val(aUrl[0]);
                }
            });
        });
        
        $(".btnPEMCert").off("click").on("click", function () {
            YDM.FileManager('file', 1, function (aUrl) {
                if (aUrl.length > 0) {
                    $("#APIPEMCertPath").val(aUrl[0]);
                }
            });
        });
        
        $(".btnKey").off("click").on("click", function () {
            YDM.FileManager('file', 1, function (aUrl) {
                if (aUrl.length > 0) {
                    $("#APIPEMKeyPath").val(aUrl[0]);
                }
            });
        });

        $("#slEnableShop").unbind().bind("change", function () {
            if ($(this).val() == "1") {
                $("[isshop=1]").fadeIn();
            }
            else $("[isshop=1]").fadeOut();
        });

        $("#slAlipay").unbind().bind("change", function () {
            if ($(this).val() == "1") $("[isalipay=1]").fadeIn();
            else $("[isalipay=1]").fadeOut();
        });

        $("#slEnableWxPay").unbind().bind("change", function () {
            $("#slEnableWxScanPay").prop("disabled", $(this).val() != "1");
            if ($(this).val() == "1") $("[iswxpay=1]").fadeIn();
            else $("[iswxpay=1]").fadeOut();
        });

        $("#slEnableEpaylinksPay").unbind().bind("change", function () {
            if ($(this).val() == "1") $("[isepaylinkspay=1]").fadeIn();
            else $("[isepaylinkspay=1]").fadeOut();
        });

        $('#slEnableTransferPay').unbind().bind('change', function () {
            if ($(this).val() == "1") $("[transferpay=1]").fadeIn();
            else $("[transferpay=1]").fadeOut();
        });

        $('#slEnableAcquireCustoms').unbind().bind('change', function () {
            if (this.value == 1) $('.trAcquireCustoms').fadeIn();
            else $('.trAcquireCustoms').fadeOut();
        });

		/*$("#ShopConfigTabs", myroot).tabs({ 
			active: 0
		});*/

		$('#btnAddFreight').unbind().click(function(){
			addFreight('','');
		});

		$('#btnSelectWxTransferPayQrCode').unbind().click(function () {
		    YDM.FileManager('image', 1, function (aUrl) {
		        if (aUrl.length > 0) {
		            $("#txWxTransferPayQrCode").val(aUrl[0]);
		        }
		    });
		});

		$('#btnSelectTransferPayContactWxQrCode').unbind().click(function () {
		    YDM.FileManager('image', 1, function (aUrl) {
		        if (aUrl.length > 0) {
		            $("#txTransferPayContactWxQrCode").val(aUrl[0]);
		        }
		    });
		});
    }

	function addFreight(ordermoney,freight){
		var id = $(".FreightOrderMoney").length + 1;
		$('#tabFreight').append("<tr><td style='text-align:left'>订单金额满 <input type='text' class='form-control input FreightOrderMoney' value='"+ ordermoney +"' name='FreightOrderMoney"+id+"' > 元，运费 <input type='text' class='form-control input' name='FreightMoney"+id+"' value='"+ freight +"' > 元 <input type='button' class=' btn  btn-link ' value='删除' name='btnDelFreight'></td></tr>");
		$("*[name=btnDelFreight]").unbind().click(function(){
			$(this).closest("tr").remove();
		});
	}

    me.addListener('shoppingmallconfig', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
	
	
}

﻿IWF.plugins['shopstatistics'] = function () {

    var me = this;

    var ViewModel = function () {
        var self = this;
        self.totalSiteUserCount = ko.observable('0');
        self.totalOrderCount = ko.observable(0);
        self.totalOrderPayMoney = ko.observable('0');
        self.totalFinanceAdminPay = ko.observable('0'); //新增消费总额(手工支出)
        self.totalYongJin = ko.observable('0');
        self.totalRechargeMoney = ko.observable('0');
        self.totalRechargeAdminMoney = ko.observable('0');   //新增总收入(手工入账)
        self.totalBalance = ko.observable('0');
        self.weekList = ko.observableArray();
        self.monthList = ko.observableArray();
        self.yearList = ko.observableArray();
        self.formatMoney = function (money) {
            return '￥' + money;
        }
        self.getList = function (type) {
            if (type == 0) return self.weekList();
            else if (type == 1) return self.monthList();
            else return self.yearList();
        }
        self.subTotalSiteUserCount = function (type) {
            var list = self.getList(type);
            var count = 0;
            for (var i = 0; i < list.length ; i++) {
                count += list[i].SiteUserCount;
            }
            return count;
        };
        self.subTotalOrderCount = function (type) {
            var list = self.getList(type);
            var count = 0;
            for (var i = 0; i < list.length ; i++) {
                count += list[i].OrderCount;
            }
            return count;
        };
        self.subTotalOrderPayMoney = function (type) {
            var list = self.getList(type);
            var count = 0;
            for (var i = 0; i < list.length ; i++) {
                count += list[i].OrderPayMoney;
            }
            return count.toFixed(2);
        };
        //新增消费总额(手工支出)
        self.subTotalFinanceAdminPay = function (type) {
            var list = self.getList(type);
            var count = 0;
            for (var i = 0; i < list.length ; i++) {
                count += list[i].FinanceAdminPay;
            }
            return count.toFixed(2);
        };
        self.subTotalYongJin = function (type) {
            var list = self.getList(type);
            var count = 0;
            for (var i = 0; i < list.length ; i++) {
                count += list[i].YongJin;
            }
            return count.toFixed(2); ;
        };
        self.subTotalTiXianMoney = function (type) {
            var list = self.getList(type);
            var count = 0;
            for (var i = 0; i < list.length ; i++) {
                count += list[i].TiXianMoney;
            }
            return count.toFixed(2);
        };
        self.subTotalDepositMoney = function (type) {
            var list = self.getList(type);
            var count = 0;
            for (var i = 0; i < list.length ; i++) {
                count += list[i].DepositMoney;
            }
            return count.toFixed(2);
        };
        //新增总收入(手工入账)
        self.subTotalDepositAdminMoney = function (type) {
            var list = self.getList(type);
            var count = 0;
            for (var i = 0; i < list.length ; i++) {
                count += list[i].DepositAdminMoney;
            }
            return count.toFixed(2);
        };
        self.isAllZero = function (data) {
            if (data.OrderCount == 0 && data.OrderPayMoney == 0 && data.SiteUserCount == 0 && data.TiXianMoney == 0 && data.YongJin == 0)
                return true;
            return false;
        }
    };

    var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_SHOP')) {
            root.load("/index.php?c=admin/page/Versiontip&page=shopstatistics");
            return;
        }
        root.loadHtmlTpl("plugins/businesspackage/html/shopstatistics.html", function () {
            
            bindUIEvent();
            ko.applyBindings(vm, root[0]);
            loadInfo();
            loadDefaultData(0);
        });
    }

    function loadInfo() {
    	$.getJSON("/index.php?c=admin/business/shopstatistics&a=getinfo", function (json) {
//        $.getJSON("/admin/business/shopstatistics?act=getinfo", function (json) {
            if (!json.success) {
                alert(json.msg);
                return;
            }
            vm.totalSiteUserCount(json.info.SiteUserCount);
            vm.totalOrderCount(json.info.OrderCount);
            vm.totalOrderPayMoney(json.info.OrderPayMoney);
            vm.totalFinanceAdminPay(json.info.FinanceAdminPay);
            vm.totalYongJin(json.info.YongJin);
            vm.totalRechargeMoney(json.info.RechargeMoney);
            vm.totalRechargeAdminMoney(json.info.RechargeAdminMoney);
            vm.totalBalance(json.info.Balance);
        });
    }

    function loadList(type, startTime, endTime) {
        var params = { sid: me.sid, startTime: startTime, endTime: endTime, type: type };
        $.getJSON("/index.php?c=admin/business/shopstatistics&a=getlist", utils.params(params), function (json) {
//        $.getJSON("/admin/business/shopstatistics?act=getlist", utils.params(params), function (json) {
            if (!json.success) {
                alert(json.msg);
                return;
            }
            if (type == 0) {
                vm.weekList(json.list);
            } else if (type == 1) {
                vm.monthList(json.list);
            } else if (type == 2) {
                vm.yearList(json.list);
            }
        });
    }

    function loadListAndRefreshControl(type, startTime, endTime) {
        var dStartTime = new Date(startTime);
        var dEndTime = new Date(endTime);
        if (type == 0) {
            loadList(0, formatDate(dStartTime), formatDate(dEndTime));
            $('#dtWeek [name=txStartTime]').datepicker('setDate', formatDate(dStartTime)).datepicker('update');
            $('#dtWeek [name=txEndTime]').datepicker('setDate', formatDate(dEndTime)).datepicker('update');
        } else if (type == 1) {
            dStartTime = new Date(dStartTime.getFullYear() + '-' + (dStartTime.getMonth() + 1) + '-01');
            dEndTime = new Date(dEndTime.getFullYear() + '-' + (dEndTime.getMonth() + 2) + '-01');
            dEndTime.setDate(dEndTime.getDate() - 1);
            loadList(1, formatDate(dStartTime), formatDate(dEndTime));
            $('#dtMonth [name=txStartTime]').datepicker('setDate', formatDate(dStartTime)).datepicker('update');
            $('#dtMonth [name=txEndTime]').datepicker('setDate', formatDate(dEndTime)).datepicker('update');
        } else if (type == 2) {
            var sStartTime = dStartTime.getFullYear() + '-01';
            var sEndTime = dEndTime.getFullYear() + '-12';
            loadList(2, sStartTime, sEndTime);
            $('#dtYear [name=txStartTime]').datepicker('setDate', sStartTime).datepicker('update');
            $('#dtYear [name=txEndTime]').datepicker('setDate', sEndTime).datepicker('update');
        }
    }

    function loadDefaultData(type) {
        if (type == 0) {
            // 这个星期的
            //var dStartTime = new Date();
            //dStartTime.setDate(dStartTime.getDate() - (dStartTime.getDay() == 0 ? 7 : dStartTime.getDay() - 1));
            //var dEndTime = new Date(dStartTime);
            //dEndTime.setDate(dEndTime.getDate() + 6);

            // 从今天开始往前推7天
            var dEndTime = new Date();
            var dStartTime = new Date(dEndTime);
            dStartTime.setDate(dStartTime.getDate() - 6);
            loadListAndRefreshControl(0, dStartTime, dEndTime);
        } else if (type == 1) {
            var dStartTime = new Date();
            dStartTime = new Date(dStartTime.getFullYear() + '-' + (dStartTime.getMonth() + 1) + '-01');
            var dEndTime = new Date();
            dEndTime = new Date(dEndTime.getFullYear() + '-' + (dEndTime.getMonth() + 2) + '-01');
            dEndTime.setDate(dEndTime.getDate() - 1);
            loadListAndRefreshControl(1, dStartTime, dEndTime);
        } else if (type == 2) {
            var sStartTime = new Date().getFullYear() + '-01';
            var sEndTime = new Date().getFullYear() + '-12';
            loadListAndRefreshControl(2, sStartTime, sEndTime);
        }
    }

    function bindUIEvent() {
        $('#ulStat a[data-toggle="tab"]').off().on('show.bs.tab', function (e) {
            if ($(this).attr('stattype') && $(this).attr('hasloaddefaultdata') != 1) {
                loadDefaultData($(this).attr('stattype'));
                $(this).attr('hasloaddefaultdata', 1);
            }
        })

        $('#dtWeek').datepicker({
            format: "yyyy-mm-dd",
            clearBtn: true,
            //startDate: '-0d',
            //endDate: '+7d',
            language: "zh-CN",
            orientation: "bottom auto",
            todayHighlight: true,
            toggleActive: true,
            multidate: false
        })
        $('#dtMonth [name=txStartTime]').datepicker({
            format: "yyyy-mm-01",
            minViewMode: 1,
            clearBtn: true,
            language: "zh-CN",
            orientation: "bottom auto",
            multidate: false
        });
        $('#dtMonth [name=txEndTime]').datepicker({
            format: {
                toDisplay: function (date, format, language) {
                    var d = new Date(date);
                    d = new Date(d.getFullYear(), d.getMonth());
                    d.setMonth(d.getMonth() + 1);
                    d.setDate(d.getDate() - 1);
                    return formatDate(d);
                },
                toValue: function (date, format, language) {
                    var d = new Date(date);
                    return d;
                }
            },
            minViewMode: 1,
            clearBtn: true,
            language: "zh-CN",
            orientation: "bottom auto",
            multidate: false
        });
        $('#dtYear [name=txStartTime]').datepicker({
            format: "yyyy-01",
            startView: 1,
            minViewMode: 2,
            clearBtn: true,
            language: "zh-CN",
            orientation: "bottom auto",
            multidate: false
        })
        $('#dtYear [name=txEndTime]').datepicker({
            format: "yyyy-12",
            startView: 1,
            minViewMode: 2,
            clearBtn: true,
            language: "zh-CN",
            orientation: "bottom auto",
            multidate: false
        })

        $("#btnWeekSearch").off('click').on('click', function (event) {
            loadList(0, $('#dtWeek input[name=txStartTime]').val(), $('#dtWeek input[name=txEndTime]').val());
        });
        $("#btnMonthSearch").off('click').on('click', function (event) {
            loadList(1, $('#dtMonth input[name=txStartTime]').val(), $('#dtMonth input[name=txEndTime]').val());
        });
        $("#btnYearSearch").off('click').on('click', function (event) {
            loadList(2, $('#dtYear input[name=txStartTime]').val(), $('#dtYear input[name=txEndTime]').val());
        });
    }

    function formatDate(date, format) {
        var month = date.getMonth() + 1;
        if ((month + '').length == 1) month = '0' + month;
        var ri = date.getDate();
        if ((ri + '').length == 1) ri = '0' + ri;

        if (format == 'yyyy-mm') {
            return date.getFullYear() + '-' + month;
        }
        return date.getFullYear() + '-' + month + '-' + ri;
    }

    me.addListener('shopstatistics', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['sitegalleryedit'] = function () {

    me = this;

    var ViewModel = function () {
        this.ID = ko.observable();
        this.Title = ko.observable();
        this.Banner = ko.observable();
        this.Intro = ko.observable();
        this.imgList = ko.observableArray();
        this.setInfo = function (data) {
            for (var key in data) {
                if (this[key] == undefined)
                    this[key] = ko.observable(data[key]);
                else
                    this[key](data[key]);
            }
        };
        this.setImgList = function (data) {
            this.imgList(data || []);
        }
        this.addItem = function (item) {
            this.imgList.push(item);
            bindGridEvent();
        };
        this.getImage = function (image) {
            var imgsrc = "/comdata/" + getCookie("InitSiteID") + "/gallery/" + image;
            return imgsrc;
        };
        this.getTime = function (time) {
            if (/^(1970)/.test(time)) return "";
            return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
        }
    };

    var vm = null;
    var myroot = null;

    function initUI(root) {
        vm = new ViewModel();
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/sitegalleryedit.html", function () {
            myroot = root[0];
            bindUIEvent();
            ko.applyBindings(vm, myroot);
            if (me.currentModule.params && me.currentModule.params.id) {
                $('#imgListTr').show();
                loadInfo();
                loadList();
            }
        });
    }

    function loadInfo() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        $.ajax({
            type: 'get',
            //url: '/admin/sitegallerymanage?act=GetInfo',
            url: '/index.php?c=admin/gallery/sitegallerymanage&a=GetInfo',
            data: utils.params(params),
            dataType: 'json',
            async: false,
            cache: false,
            success: function (json) {
                vm.setInfo(json.info);
            },
            error: function (req) {
                alert(req.responseText);
            }
        })
    }

    function loadList() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        $.ajax({
            type: 'get',
            //url: '/admin/sitegallerymanage?act=GetImageList',
            url: '/index.php?c=admin/gallery/sitegallerymanage&a=GetImageList',
            data: utils.params(params),
            dataType: 'json',
            async: false,
            cache: false,
            success: function (json) {
                vm.setImgList(json.list);
                bindGridEvent();
            },
            error: function (req) {
                alert(req.responseText);
            }
        })
    }

    function bindUIEvent() {
        initSwfUpload();

        $('#btnBackList').unbind().bind('click', function () {
            me.execCommand('go', { a: 'business', b: 'sitegallerylist' });
            return false;
        });

        $('#Banner', myroot).off('click').on('click', function () {
            YDM.FileManager('image', 1, function (aUrl) {
                if (aUrl.length > 0) {
                    $('#Banner').val(aUrl[0]);
                    $('#ImgPreview').html("<img src='" + aUrl[0] + "' width='360'>").show();
                }
            })
        });

        $("#gridtbody").sortable({
            handle: "img",
            start: function (event, ui) {
                ui.item.addClass('movingItem');
            },
            update: function (event, ui) {

            }, stop: function (event, ui) {
                ui.item.removeClass('movingItem');
            },
            placeholder: 'dropPlaceholder'
        }).disableSelection();

        $("#itemLink").off().on('click', function () {
            var curInput = this;
            top.YDM.LinkSelector($("#itemLink").val(), function (url) {
                $("#itemLink").val(url);
                $(curInput).blur();
            }, function () { }, { norewrite: 1 });
        });

        $("#MainForm", myroot).validate({
            invalidHandler: function () {
                $(".gray").removeClass("gray");
            },
            rules: {
                Title: "required"
                //, Banner: "required"
                //, Intro: "required"
            },
            messages: {
                Title: { required: "请输入标题！" }
                , Banner: "请选择封面"
				, Intro: "请输入简介"
            },
            submitHandler: function (form) {
                submitForm();
                return false;
            },
            ignore: []
        });

        $('#saveAndBackList').off().on('click', function () {
            $('#MainForm').submit();
        })
    }

    function bindGridEvent() {
        $('.item').unbind().bind('mouseover', function () {
            $(this).find('.itemControlBar').show();
        }).bind('mouseout', function () {
            $(this).find('.itemControlBar').hide();
        }).bind('click', function () {
            $('#itemInfo input[rel], #itemInfo textarea[rel]').blur();
            $('.item.curSelected').removeClass('curSelected');
            $(this).addClass('curSelected');
            $('#itemInfo').hide();
            var curItem = $(this);
            $('#itemInfo input[rel], #itemInfo textarea[rel]').each(function () {
                $(this).val(curItem.find('[name^=' + $(this).attr('rel') + ']').val());
            }).unbind('blur').bind('blur', function () {
                curItem.find('[name^=' + $(this).attr('rel') + ']').val($(this).val());
            });
            $('#itemInfo').fadeIn();
        });

        $(".btnChangeImg").unbind('click').bind('click', function () {
            var obj = $(this);
            $("#Filedata").click();
            $("#Filedata").unbind().change(function () {
                if ($("#Filedata").val() != "") singleUpload(obj);
            });
        });

        $(".btnDel").unbind('click').bind('click', function (event) {
            var id = $(this).attr("ItemID");
            var file = $(this).attr("file");
            if (!confirm("确认删除？")) return;
            var obj = $(this);
            //$.getJSON("/admin/sitegallerymanage?act=DeleteImg", utils.params({ id: id, file: file }), function (json) {
            $.getJSON("/index.php?c=admin/gallery/sitegallerymanage&a=DeleteImg", utils.params({ id: id, file: file }), function (json) {
                loadList();
            });
            return false;
        });
    }

    var swfu;
    function initSwfUpload() {
        if ($("#swfUploadPlaceholder").is("span")) {
            var params = {};
            if (me.currentModule.params && me.currentModule.params.id) params["id"] = me.currentModule.params.id;
            params['ssid'] = getCookie("sid") || '';
            swfu = new SWFUpload({
                //upload_url: "/admin/sitegallerymanage?act=UploadImg&InitSiteID=" + getCookie('InitSiteID'),
            	upload_url: "/index.php?c=admin/gallery/sitegallerymanage&a=UploadImg&InitSiteID=" + getCookie('InitSiteID')  + "&PSESSID=" + getCookie('PHPSESSID'),
                post_params: params,
                file_size_limit: "3 MB",
                file_types: "*.jpg;*.gif;*.png",
                file_types_description: "Image Files",
                /*file_upload_limit: "5",*/
                file_queue_error_handler: fileQueueError,
                file_dialog_complete_handler: fileDialogComplete,
                upload_progress_handler: uploadProgress,
                upload_error_handler: uploadError,
                upload_success_handler: uploadSuccess,
                upload_complete_handler: uploadComplete,
                button_image_url: "/images/swfuplod-bg.gif",
                button_placeholder_id: "swfUploadPlaceholder",
                button_width: 96,
                button_height: 34,
                button_text: '<b><font color="#ffffff">添加图片</font></b>',
                button_text_top_padding: 8,
                button_text_left_padding: 20,
                button_window_mode: SWFUpload.WINDOW_MODE.OPAQUE,
                flash_url: "/share/swfupload.swf",
                custom_settings: {
                    upload_target: "FileProgressContainer"
                },
                debug: false
            });
        }
    }

    function uploadSuccess(file, serverResponse) {
        try {
            data = JSON.parse(serverResponse);
            if (data.success) {
                //vm.addItem(data.newItem)
                loadList();
            } else {
                $.showResult("错误", data.msg);
            }
            var progress = new FileProgress(file, this.customSettings.upload_target);
            progress.setStatus("Thumbnail Created.");
            progress.toggleCancel(false);
        } catch (ex) {
            this.debug(ex);
        }
    }

    function singleUpload(btnobj) {
        var params = {};
        params["itemid"] = $(btnobj).attr("itemid");
        //params["oldfile"] = $(btnobj).closest('.item').find('[name^=ItemImage]').val();
        $(btnobj).val("处理中...");
        $(btnobj).prop("disabled", true);
        $.ajaxFileUpload
		(
			{
			    //url: '/admin/sitegallerymanage?act=UploadImg', //用于文件上传的服务器端请求地址
				url: '/index.php?c=admin/gallery/sitegallerymanage&a=UploadImg', //用于文件上传的服务器端请求地址
			    secureuri: false, //是否需要安全协议，一般设置为false
			    fileElementId: 'Filedata', //文件上传域的ID
			    dataType: 'json', //返回值类型 一般设置为json
			    data: params,
			    success: function (data, status) {
			        if (data.success) {
			            var tr = $(btnobj).closest("div.item");
			            tr.find("[name^=ItemImage]").val(data.fileName);
			            tr.find(".itemPreviewImg").attr("src", "/comdata/" + getCookie("InitSiteID") + "/gallery/" + data.fileName);
			        } else {
			            $.showResult("错误", data.msg);
			        }
			        $(btnobj).val("更换图片");
			        $(btnobj).prop("disabled", false);
			    },
			    error: function (data, status, e) {
			        $.showResult("错误", e);
			        $(btnobj).val("更换图片");
			        $(btnobj).prop("disabled", false);
			    }
			}
		);
    }

    function submitForm() {
        $('#gridtbody .item').each(function (i) {
            $(this).find('[name^=ItemShowOrder]').val(i);
        });

        if ($('#gridtbody .item').length > 0)
            $('#Banner').val($('#gridtbody .item:eq(0) [name^=ItemImage]').val());
        else
            $('#Banner').val('');

        var params = $('#MainForm').serializeObject();
        //$.post("/admin/sitegallerymanage?act=Edit", params, function (json, textStatus, jqXHR) {
        $.post("/index.php?c=admin/gallery/sitegallerymanage&a=Edit", params, function (json, textStatus, jqXHR) {
            if (json.success) {
                $.showResult(true, "保存成功", 1500);
            } else {
                $.showResult(false, json.msg);
            }
        }, "json");
    }

    me.addListener('sitegalleryedit', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['sitegallerylist'] = function () {

    var me = this;

    var ViewModel = function () {
        this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
        this.showImage = function (image) {
            var imgsrc = "/comdata/" + getCookie("InitSiteID") + "/gallery/" + image;
            return imgsrc;
        }
        this.getTime = function (time) {
            if (/^(1970)/.test(time)) return "不限制结束时间";
            return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
        }
    };

    var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/sitegallerylist.html", function () {
            bindUIEvent();
            ko.applyBindings(vm, root[0]);
            loadgallerylist(1);
        });
    }

    var curpage = 1;
    var itemcount = 0;
    function loadgallerylist(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(), page: page, pagesize: 20 };
        //$.getJSON("/admin/sitegallerymanage?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/gallery/sitegallerymanage&a=getlist", utils.params(params), function (json) {
            vm.setData(json.list);
            curpage = json.curpage;
            itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadgallerylist(page); });
                $("#pagination").show();
            }
            bindGridEvent();
        });
    }

    function bindUIEvent() {
        $("#BtnSearch").unbind('click').bind('click', function (event) {
            loadgallerylist(1);
        });
    }

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("GalleryID") };
            me.execCommand('go', { a: 'business', b: 'sitegalleryedit', params: params });
            return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
            if (!confirm("确认删除？")) return false;
            //$.getJSON("/admin/sitegallerymanage?act=Delete", utils.params({ id: $(this).attr("GalleryID") }), function (json) {
            $.getJSON("/index.php?c=admin/gallery/sitegallerymanage&a=Delete", utils.params({ id: $(this).attr("GalleryID") }), function (json) {
                if (json.success) {
                    if (itemcount > 1) loadgallerylist(curpage);
                    else loadgallerylist(1);
                } else {
                    $.showResult("出错啦", json.msg);
                }
            });
            return false;
        });

        $("*[name=BtnUploadGallery]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("GalleryID") };
            me.execCommand('go', { a: 'business', b: 'galleryupload', params: params });
            return false;
        });

        $("*[name=BtnSetStatus]").unbind('click').bind('click', function (event) {
            //$.getJSON("/admin/sitegallerymanage?act=setstatus", utils.params({ id: $(this).attr("GalleryID"), status: $(this).attr("Status") }), function (json) {
        	$.getJSON("/index.php?c=admin/gallery/sitegallerymanage&a=setstatus", utils.params({ id: $(this).attr("GalleryID"), status: $(this).attr("Status") }), function (json) {
                if (json.success) {
                    loadgallerylist(curpage);
                } else {
                    $.showResult("出错啦", json.msg);
                }
            });
            return false;
        });
    }

    me.addListener('sitegallerylist', function (key, args) {
        initUI(args);
    });
}

IWF.plugins['storetichengreview'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
		this.getTime = function (time) {
			try{
				return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
			}catch(e){
				console.log('load time error');
			}
		}
		this.getMoney = function (money) {
		    return Math.abs(money);
		}
    };

	var vm = new ViewModel();
	var vm2 = new ViewModel();
	function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_FENXIAO')) {
            root.load("/index.php?c=admin/page/Versiontip&page=tichengreview");
            return;
        }
        root.loadHtmlTpl("plugins/businesspackage/html/storetichengreview.html?v=" + Math.random(), function () {
            
			bindUIEvent();
			ko.applyBindings(vm,$("#showListTable")[0]);
			ko.applyBindings(vm2,$("#divFinanceList")[0]);
			loadList(1);
		});
    }
	    
	var curpage = 1;
	var itemcount = 0;
    function loadList(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(), fstatus: $("#fstatus").val(),ostatus: $("#ostatus").val(), page: page, pagesize: 20 ,isstore:1};
        //$.getJSON("/admin/business/tixianmanage?act=GetTiChengCount", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/business/tixianmanage&a=GetTiChengCount", utils.params(params), function (json) {
            vm.setData(json.list);
            $('#selectAll').prop("checked",false);
            curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadList(page); });
                $("#pagination").show();
            }

            bindGridEvent();
        });
    }

	
	function loadFinanceInfo(orderid){
		$("#divFinanceList").dialog({
			width: 630, height: 400, resizable: true, modal: true,
			open: function (event, ui) {
				//$.getJSON("/admin/business/tixianmanage?act=GetTiChengList", utils.params({OrderID: orderid}), function (json) {
				$.getJSON("/index.php?c=admin/business/tixianmanage&a=GetTiChengList", utils.params({OrderID: orderid,isstore:1}), function (json) {
					vm2.setData(json.list);

					bindGridEvent();
				});
			},
			close: function (event, ui) {
				$(this).dialog("close");
			}
		});
	}

	function review(orderid, status, cancelReviewRemark) {
	    var params = { OrderID: orderid, Status: status };
	    if (status == 90) params.CancelReviewRemark = cancelReviewRemark;
		//$.post("/admin/business/tixianmanage?act=TiChengReview",params,function(data, textStatus, jqXHR){
		$.post("/index.php?c=admin/business/tixianmanage&a=TiChengReview",params,function(data, textStatus, jqXHR){
			if(data.success){
				$.showResult("提示","操作成功",3000);
				loadList(curpage);
			}else{
				$.showResult("提示","操作出错：" + data.msg);
				loadList(curpage);
			}
		},"json");
		return false;
	}
	
	function getSelectedOrderIDs(){
		var array = new Array();
		$("input[name=orderid]:checked").each(function(){
			array.push($(this).val());
		});
		var id = array.join(',');
		return id;
	}

	function submitForm(form) {
		var params = $('#TixianEditForm').serialize(); //此方法定义在 core/ui.js
		//$.post("/admin/business/tixianmanage?act=TiChengReview",params,function(data, textStatus, jqXHR){
		$.post("/index.php?c=admin/business/tixianmanage&a=TiChengReview",params,function(data, textStatus, jqXHR){
			if(data.success){
			    $("#divTixianEditForm").dialog("close");
				loadList(curpage);
			}else{
			    $("#divTixianEditForm").dialog("close");
				loadList(curpage);
			}
		},"json");
		return false;
    }
	
	function bindUIEvent(){
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadList(1);
        });
		
		$('#selectAll').unbind().on('click', function () {
			$('#showListTable :checkbox:gt(0)').prop('checked', $('#showListTable :checkbox:eq(0)').prop('checked'));
		});
		
		$('#BtnBatchReview').unbind('click').bind('click', function (event) {
			var id = getSelectedOrderIDs();
			if(!id) alert('请至少选择一条记录');
			else{
				if(confirm("确认审核吗?")){
					$.post("/index.php?c=admin/business/tixianmanage&a=TiChengBatchReview", utils.params({'id': id,'Status': 91}), function (json) {
						if(json.success){
							loadList(curpage);
						}else{
							showResult("出错啦",json.msg);
						}
					});
				}
			}
			return false;
		});
		
		
		$('#BtnBatchCancel').unbind('click').bind('click', function (event) {
			var id = getSelectedOrderIDs();
			if(!id) alert('请至少选择一条记录');
			else{
				var cancelReviewRemark = $(this).attr('CancelReviewRemark') || '';
			    var html = "<font style='font-size:18px'>若审核的佣金已被客户领取，此操作会导致客户的可提现佣金显示负数，请谨慎操作！是否确定取消选中订单的佣金发放！</font>";
			    html += "<div><label>取消备注：</label><textarea name='cancelReviewRemark' class='form-control' maxlength='255'>" + cancelReviewRemark + "</textarea></div>";
				bootbox.dialog({
				    message: html,
	                buttons: {
	                    'cancel': {
	                        label: '取消'
	                    },
	                    'confirm': {
	                        label: '确定',
	                        callback: function () {
	                            if (!$('[name=cancelReviewRemark]').val()) {
	                                alert('请填写取消备注');
	                                return false;
	                            }
	                            $.post("/index.php?c=admin/business/tixianmanage&a=TiChengBatchReview", utils.params({'id': id,'Status': 90,'CancelReviewRemark':$('[name=cancelReviewRemark]').val()}), function (json) {
	        						if(json.success){
	        							loadList(curpage);
	        						}else{
	        							showResult("出错啦",json.msg);
	        						}
	        					});
	                        }
	                    }
	                }
	            });
				return false;
			}
		    
        });
		
	}

    function bindGridEvent() {    
    	$("*[name=BtnUserEdit]").unbind('click').bind('click', function(event) {
			me.execCommand('go', {a: 'business', b: 'useredit', params: {id: $(this).attr("UserID")}});
			$("#divFinanceList").dialog('destroy');
			return false;
		});
    	
        $("*[name=BtnDetail]").unbind('click').bind('click', function (event) {
			loadFinanceInfo($(this).attr("OrderID"));
			return false;
        });

		$("*[name=BtnReview]").unbind('click').bind('click', function (event) {
			$orderid = $(this).attr("OrderID");
			var status = $(this).attr("OrderStatus");
			if(status != 2){
				bootbox.dialog({
	                message: "<font style='font-size:18px'>该订单为未完成状态！是否发放佣金？</font>",
	                buttons: {
	                    'cancel': {
	                        label: '取消'
	                    },
	                    'confirm': {
	                        label: '确定',
	                        callback: function () {
	                        	review($orderid,91);
	                        }
	                    }
	                }
	            });
			}else{
				review($(this).attr("OrderID"),91);
			}		
			return false;
        });

		$("*[name=BtnCancelReview]").unbind('click').bind('click', function (event) {
		    $orderid = $(this).attr("OrderID");
		    var cancelReviewRemark = $(this).attr('CancelReviewRemark') || '';
		    var html = "<font style='font-size:18px'>若审核的佣金已被客户领取，此操作会导致客户的可提现佣金显示负数，请谨慎操作！是否确定取消此订单佣金发放！</font>";
		    html += "<div><label>取消备注：</label><textarea name='cancelReviewRemark' class='form-control' maxlength='255'>" + cancelReviewRemark + "</textarea></div>";
			bootbox.dialog({
			    message: html,
                buttons: {
                    'cancel': {
                        label: '取消'
                    },
                    'confirm': {
                        label: '确定',
                        callback: function () {
                            if (!$('[name=cancelReviewRemark]').val()) {
                                alert('请填写取消备注');
                                return false;
                            }

                            review($orderid, 90, $('[name=cancelReviewRemark]').val());
                            //return false;
                        }
                    }
                }
            });
			return false;
        });
		
		$("*[name=BtnGoOrder]").unbind('click').bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'orderedit', params: { id: $(this).attr("OrderID")} });
			return false;
        });
    }

    me.addListener('storetichengreview', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['tichengreview'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
		this.getTime = function (time) {
			try{
				return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
			}catch(e){
				console.log('load time error');
			}
		}
		this.getMoney = function (money) {
		    return Math.abs(money);
		}
    };

	var vm = new ViewModel();
	var vm2 = new ViewModel();
	function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_FENXIAO')) {
            root.load("/index.php?c=admin/page/Versiontip&page=tichengreview");
            return;
        }
        root.loadHtmlTpl("plugins/businesspackage/html/tichengreview.html?v=" + Math.random(), function () {
            
			bindUIEvent();
			ko.applyBindings(vm,$("#showListTable")[0]);
			ko.applyBindings(vm2,$("#divFinanceList")[0]);
			loadList(1);
		});
    }
	    
	var curpage = 1;
	var itemcount = 0;
    function loadList(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(), fstatus: $("#fstatus").val(),ostatus: $("#ostatus").val(), page: page, pagesize: 20 };
        //$.getJSON("/admin/business/tixianmanage?act=GetTiChengCount", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/business/tixianmanage&a=GetTiChengCount", utils.params(params), function (json) {
            vm.setData(json.list);
            $('#selectAll').prop("checked",false);
            curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadList(page); });
                $("#pagination").show();
            }

            bindGridEvent();
        });
    }

	
	function loadFinanceInfo(orderid){
		$("#divFinanceList").dialog({
			width: 630, height: 400, resizable: true, modal: true,
			open: function (event, ui) {
				//$.getJSON("/admin/business/tixianmanage?act=GetTiChengList", utils.params({OrderID: orderid}), function (json) {
				$.getJSON("/index.php?c=admin/business/tixianmanage&a=GetTiChengList", utils.params({OrderID: orderid}), function (json) {
					vm2.setData(json.list);

					bindGridEvent();
				});
			},
			close: function (event, ui) {
				$(this).dialog("close");
			}
		});
	}

	function review(orderid, status, cancelReviewRemark) {
	    var params = { OrderID: orderid, Status: status };
	    if (status == 90) params.CancelReviewRemark = cancelReviewRemark;
		//$.post("/admin/business/tixianmanage?act=TiChengReview",params,function(data, textStatus, jqXHR){
		$.post("/index.php?c=admin/business/tixianmanage&a=TiChengReview",params,function(data, textStatus, jqXHR){
			if(data.success){
				$.showResult("提示","操作成功",3000);
				loadList(curpage);
			}else{
				$.showResult("提示","操作出错：" + data.msg);
				loadList(curpage);
			}
		},"json");
		return false;
	}
	
	function getSelectedOrderIDs(){
		var array = new Array();
		$("input[name=orderid]:checked").each(function(){
			array.push($(this).val());
		});
		var id = array.join(',');
		return id;
	}

	function submitForm(form) {
		var params = $('#TixianEditForm').serialize(); //此方法定义在 core/ui.js
		//$.post("/admin/business/tixianmanage?act=TiChengReview",params,function(data, textStatus, jqXHR){
		$.post("/index.php?c=admin/business/tixianmanage&a=TiChengReview",params,function(data, textStatus, jqXHR){
			if(data.success){
			    $("#divTixianEditForm").dialog("close");
				loadList(curpage);
			}else{
			    $("#divTixianEditForm").dialog("close");
				loadList(curpage);
			}
		},"json");
		return false;
    }
	
	function bindUIEvent(){
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadList(1);
        });
		
		$('#selectAll').unbind().on('click', function () {
			$('#showListTable :checkbox:gt(0)').prop('checked', $('#showListTable :checkbox:eq(0)').prop('checked'));
		});
		
		$('#BtnBatchReview').unbind('click').bind('click', function (event) {
			var id = getSelectedOrderIDs();
			if(!id) alert('请至少选择一条记录');
			else{
				if(confirm("确认审核吗?")){
					$.post("/index.php?c=admin/business/tixianmanage&a=TiChengBatchReview", utils.params({'id': id,'Status': 91}), function (json) {
						if(json.success){
							loadList(curpage);
						}else{
							showResult("出错啦",json.msg);
						}
					});
				}
			}
			return false;
		});
		
		
		$('#BtnBatchCancel').unbind('click').bind('click', function (event) {
			var id = getSelectedOrderIDs();
			if(!id) alert('请至少选择一条记录');
			else{
				var cancelReviewRemark = $(this).attr('CancelReviewRemark') || '';
			    var html = "<font style='font-size:18px'>若审核的佣金已被客户领取，此操作会导致客户的可提现佣金显示负数，请谨慎操作！是否确定取消选中订单的佣金发放！</font>";
			    html += "<div><label>取消备注：</label><textarea name='cancelReviewRemark' class='form-control' maxlength='255'>" + cancelReviewRemark + "</textarea></div>";
				bootbox.dialog({
				    message: html,
	                buttons: {
	                    'cancel': {
	                        label: '取消'
	                    },
	                    'confirm': {
	                        label: '确定',
	                        callback: function () {
	                            if (!$('[name=cancelReviewRemark]').val()) {
	                                alert('请填写取消备注');
	                                return false;
	                            }
	                            $.post("/index.php?c=admin/business/tixianmanage&a=TiChengBatchReview", utils.params({'id': id,'Status': 90,'CancelReviewRemark':$('[name=cancelReviewRemark]').val()}), function (json) {
	        						if(json.success){
	        							loadList(curpage);
	        						}else{
	        							showResult("出错啦",json.msg);
	        						}
	        					});
	                        }
	                    }
	                }
	            });
				return false;
			}
		    
        });
		
	}

    function bindGridEvent() {    
    	$("*[name=BtnUserEdit]").unbind('click').bind('click', function(event) {
			me.execCommand('go', {a: 'business', b: 'useredit', params: {id: $(this).attr("UserID")}});
			$("#divFinanceList").dialog('destroy');
			return false;
		});
    	
        $("*[name=BtnDetail]").unbind('click').bind('click', function (event) {
			loadFinanceInfo($(this).attr("OrderID"));
			return false;
        });

		$("*[name=BtnReview]").unbind('click').bind('click', function (event) {
			$orderid = $(this).attr("OrderID");
			var status = $(this).attr("OrderStatus");
			if(status != 2){
				bootbox.dialog({
	                message: "<font style='font-size:18px'>该订单为未完成状态！是否发放佣金？</font>",
	                buttons: {
	                    'cancel': {
	                        label: '取消'
	                    },
	                    'confirm': {
	                        label: '确定',
	                        callback: function () {
	                        	review($orderid,91);
	                        }
	                    }
	                }
	            });
			}else{
				review($(this).attr("OrderID"),91);
			}		
			return false;
        });

		$("*[name=BtnCancelReview]").unbind('click').bind('click', function (event) {
		    $orderid = $(this).attr("OrderID");
		    var cancelReviewRemark = $(this).attr('CancelReviewRemark') || '';
		    var html = "<font style='font-size:18px'>若审核的佣金已被客户领取，此操作会导致客户的可提现佣金显示负数，请谨慎操作！是否确定取消此订单佣金发放！</font>";
		    html += "<div><label>取消备注：</label><textarea name='cancelReviewRemark' class='form-control' maxlength='255'>" + cancelReviewRemark + "</textarea></div>";
			bootbox.dialog({
			    message: html,
                buttons: {
                    'cancel': {
                        label: '取消'
                    },
                    'confirm': {
                        label: '确定',
                        callback: function () {
                            if (!$('[name=cancelReviewRemark]').val()) {
                                alert('请填写取消备注');
                                return false;
                            }

                            review($orderid, 90, $('[name=cancelReviewRemark]').val());
                            //return false;
                        }
                    }
                }
            });
			return false;
        });
		
		$("*[name=BtnGoOrder]").unbind('click').bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'orderedit', params: { id: $(this).attr("OrderID")} });
			return false;
        });
    }

    me.addListener('tichengreview', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['tixianlist'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
		this.getTime = function (time) {
			try{
				return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
			}catch(e){
				console.log('load time error');
			}
		}
		this.getMoney = function (money) {
		    return Math.abs(money);
		}
    };

	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_FENXIAO')) {
            root.load("/index.php?c=admin/page/Versiontip&page=tichengreview");
            return;
        }
        root.loadHtmlTpl("plugins/businesspackage/html/tixianlist.html", function () {
			bindUIEvent();
			ko.applyBindings(vm,$("#showListTable")[0]);
			loadList(1);
		});
    }
	    
	var curpage = 1;
	var itemcount = 0;
    function loadList(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(), status: $("#status").val(), page: page, pagesize: 20 };
        //$.getJSON("/admin/business/tixianmanage?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/business/tixianmanage&a=getlist", utils.params(params), function (json) {
            vm.setData(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadList(page); });
                $("#pagination").show();
            }

            bindGridEvent();
        });
    }

	function loadFinanceInfo(financeId){
		$("#BtnSave").hide();
		$("#divTixianEditForm").dialog({
			width: 600, height: 400, resizable: false, modal: true,
			open: function (event, ui) {
				//$.getJSON("/admin/business/tixianmanage?act=GetInfo", utils.params({FinanceID: financeId}), function (json) {
				$.getJSON("/index.php?c=admin/business/tixianmanage&a=GetInfo", utils.params({FinanceID: financeId}), function (json) {
					ko.applyBindings(json.info,$("#divTixianEditForm")[0]);
					$("#BtnSave").show();
					$("#BtnSave").unbind().click(function(){ submitForm(); });
				});
			},
			close: function (event, ui) {
				$(this).dialog("close");
			}
		});
	}

	function submitForm(form) {
		var params = $('#TixianEditForm').serialize(); //此方法定义在 core/ui.js
		//$.post("/admin/business/tixianmanage?act=edit",params,function(data, textStatus, jqXHR){
		$.post("/index.php?c=admin/business/tixianmanage&a=edit",params,function(data, textStatus, jqXHR){
			if(data.success){
			    $("#divTixianEditForm").dialog("close");
				loadList(curpage);
			}else{
				alert(data.msg);
				return false;
				/*
			    $("#divTixianEditForm").dialog("close");
				loadList(curpage);
				*/
			}
		},"json");
		return false;
    }
	
	function bindUIEvent(){
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadList(1);
        });
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
			loadFinanceInfo($(this).attr("FinanceID"));
			return false;
        });
		
		$("*[name=BtnGoUser]").unbind('click').bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'useredit', params: { id: $(this).attr("UserID")} });
			return false;
        });
    }

    me.addListener('tixianlist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['userconfig'] = function () {

    var me = this;
	
    var ViewModel = function () {
        this.regitems = ko.observableArray();
		this.levels = ko.observableArray();
		this.logincfg = ko.observable();
		this.BaiduLbsKey = ko.observable();
		this.setLevelUpgradeConditionOr = function(rowIndex){
			$('#userLevelList .trUpgradeCondition:eq(' + rowIndex + ') .upgradeConditionText:visible').each(function(){
				if($(this).nextAll('.upgradeConditionText:visible').length > 0){
					$('<span class="upgradeConditionTextOr"> 或 </span>').insertAfter(this);
				}
			});
		}
    };

	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/businesspackage/html/userconfig.html?v=" + Math.random(), function () {
            me.execCommand('initContentNav', root);
					$('li:contains(会员详情), li:contains(下级分销)').css('display', 'none');
			//$("#UserConfigTabs",root).tabs({ active: 0 });
			bindUIEvent();
			ko.applyBindings(vm,root[0]);
			loadLevel();
			loadRegItem();
			loadLoginConfig();
			loadLbsConfig();
		});
    }
	    
    function loadLevel() {
        //$.getJSON("/admin/user/userconfig?act=getlevellist", null, function (json) {
    	$.getJSON("/index.php?c=admin/user/userconfig&a=getlevellist", null, function (json) {
			vm.levels(json.list);
            bindLevelGridEvent();
			if(json.canaddnew) $("#trNewLevel").show();
        });
    }

	function loadRegItem() {
        //$.getJSON("/admin/user/userconfig?act=getregitemlist", null, function (json) {
		$.getJSON("/index.php?c=admin/user/userconfig&a=getregitemlist", null, function (json) {
		    vm.regitems(json.list);
		    $('[name=customFormID]').val(json.formid || '');
			bindRegItemGridEvent();
			initCustomForm(json.formid || '', '会员信息');
        });
    }

	function loadLoginConfig() {
        //$.getJSON("/admin/user/userconfig?act=getLoginConfig", null, function (json) {
		$.getJSON("/index.php?c=admin/user/userconfig&a=getLoginConfig", null, function (json) {
			//vm.setLoginCfg(json.info);
			ko.applyBindings({ logincfg: json.info },$("#UserLoginTable")[0]);
			bindLoginConfigGridEvent();
        });
    }

	function loadLbsConfig() {
	    $.getJSON("/index.php?c=admin/user/userconfig&a=getLbsConfig", null, function (json) {
	        //vm.setLoginCfg(json.info);
	        vm.BaiduLbsKey(json.info.BaiduLbsKey);
	        //ko.applyBindings({ lbscfg: json.info }, $("#LbsServiceTable")[0]);
	    });
	}

	function bindUIEvent(){
		$('#BtnEditLbsCfg').off().on('click', function () {
		    var params = { BaiduLbsKey: $('[name=BaiduLbsKey]').val() }
		    $.ajax({
		        url: '/index.php?c=admin/user/userconfig&a=editLbsConfig',
		        type: 'post',
		        async: false,
		        cache: false,
		        data: params,
		        dataType: 'json',
		        success: function (json) {
		            if (json.success) {
		                $.showResult(true, "保存成功", 2000);
		            } else {
		                $.showResult(false, json.msg);
		            }
		        },
		        error: function (XMLHttpRequest, textStatus, errorThrown) {
		            $.showResult(false, XMLHttpRequest.responseText);
		        }
		    })
		});

		$('#BtnSaveUserRegConfig').off().on('click', function () {
		    saveUserRegConfig();
		});

		$('#BtnSaveUserRegConfig').floatSaveBtn({ appendTo: '#UserRegTable' });
		$('#UserRegTable .floatSaveBtn').css('margin-left', '-300px');
	}

	function bindRegItemGridEvent(){
	    $("*[name=BtnSetDisplay]").unbind('click').bind('click', function (event) {
	        var val = $(this).attr('IsShow');
	        if (val == "1") {
	            $(this).attr('isShow', 0).val('不显示').addClass('btn-default').removeClass('btn-primary');
	        } else {
	            $(this).attr('isShow', 1).val('显示').addClass('btn-primary').removeClass('btn-default');
	        }
        });

	    $("*[name=BtnSetRequire]").unbind('click').bind('click', function (event) {
	        var val = $(this).attr('IsRequired');
	        if (val == "1") {
	            $(this).attr('IsRequired', 0).val('非必填').addClass('btn-default').removeClass('btn-danger');
	        } else {
	            $(this).attr('IsRequired', 1).val('必填').addClass('btn-danger').removeClass('btn-default');
	        }
        });

	    $("*[name=BtnSetRegSmsValidate]").unbind('click').bind('click', function (event) {
	        var val = $(this).attr("regsmsvalidate");
	        var self = this;

	        $.ajax({
	            type: 'get',
	            url: '/index.php?c=admin/user/userconfig&a=cansetregsmsvalidate',
	            cache: false,
	            async: true,
	            data: {regsmsvalidate: val == '1' ? 0 : 1},
	            dataType: 'json',
	            success: function (json) {
	                if (!json.success) {
	                    $.showResult(false, json.msg);
	                    return;
	                }

	                if (val == "1") {
	                    $(self).attr('regsmsvalidate', 0).val('关闭短信验证').addClass('btn-default').removeClass('btn-info');
	                } else {
	                    var tr = $('input[name=ItemEnName][value=Mobile]').closest('tr');
	                    if (tr.find('[name=BtnSetDisplay]').attr('IsShow') == "0") {
	                        tr.find('[name=BtnSetDisplay]').click();
	                    }
	                    if (tr.find('[name=BtnSetRequire]').attr('IsRequired') == "0") {
	                        tr.find('[name=BtnSetRequire]').click();
	                    }
	                    $(self).attr('regsmsvalidate', 1).val('开启短信验证').addClass('btn-info').removeClass('btn-default');
	                }
	            },
	            error: function () {
	                $.showResult(false, arguments[0].responseText);
	            }
	        })
        });
	}

	function saveUserRegConfig() {
	    var submitSystemFieldData = function () {
	        var displayItems = '';
	        var requiredItems = '';
	        $('[name=BtnSetDisplay]').each(function () {
	            if ($(this).attr('IsShow') == "1") {
	                displayItems += $(this).closest('tr').find('[name=ItemEnName]').val() + ',';
	            }
	        });
	        $('[name=BtnSetRequire]').each(function () {
	            if ($(this).attr('IsRequired') == "1") {
	                requiredItems += $(this).closest('tr').find('[name=ItemEnName]').val() + ',';
	            }
	        });

	        displayItems = displayItems.replace(/,$/, '');
	        requiredItems = requiredItems.replace(/,$/, '');

	        var regsmsvalidate = $("[name=BtnSetRegSmsValidate]").attr('regsmsvalidate') == "1" ? 1 : 0;

	        var data = {
	            displayItems: displayItems,
	            requiredItems: requiredItems,
	            regsmsvalidate: regsmsvalidate
	        }

	        $.ajax({
	            type: 'post',
	            url: '/index.php?c=admin/user/userconfig&a=saveuserregconfig',
	            cache: false,
	            async: true,
	            data: data,
	            dataType: 'json',
	            success: function (json) {
	                if (!json.success) {
	                    $.showResult(false, json.msg);
	                    return;
	                }
	                $.showResult(true, '保存成功', 1500);
	            },
	            error: function () {
	                $.showResult(false, arguments[0].responseText);
	            }
	        });
	    }

	    var func = function (data) {
	        console.log(data);
	        if (!data.success) {
	            $.showResult(false, data.msg);
	            return;
	        }
	        submitSystemFieldData();
	        window.frames['customFormFrame'].location.reload();
	    }
	    window.frames['customFormFrame'].framework.submitForm(func);
	}

    function bindLevelGridEvent(){
        $("[name=BtnAddUserLevel]").unbind('click').bind('click', function () {
			var level = $(this).closest('tr').index('tr');
			showUserLevelForm(true, {Level: level + 1});
        });

        $("[name=BtnEditLevel]").unbind('click').bind('click', function () {
			var level = $(this).closest('tr').index('tr');
			var obj = vm.levels()[level - 1];
			obj.Level = level;
			showUserLevelForm(false, obj);
        });

        $("[name=BtnDelLevel]").unbind('click').bind('click', function () {
			var levels = vm.levels();
			var level = $(this).closest('tr').index('tr');
			var levelID = $(this).attr("levelId");
			var html = '<div>';
			html += '<h5 style="">您要删除该等级，请选择该等级会员的新等级！</h5>';
			html += '<select name="targetUserLevel" class="form-control" style="width: auto;">';
			for(var i = 0; i < levels.length; i++){
				if(levels[i].ID == levelID) continue;
				html += '<option value="' + levels[i].ID + '">' + levels[i].LevelName + '</option>';
			}
			html += '</select>';
			html += '<div>';

			var dialog = bootbox.dialog({
				title: '删除等级',
				message: html,
				className: 'deleteUserLevelDialog',
				buttons: {
					'cancel': {
						label: '取消'
					},
					'confirm': {
						label: '确定',
						className: "btn-success",
						callback: function () {
							var targetUserLevel = $(this).find('[name=targetUserLevel]').val();
							$.getJSON("/index.php?c=admin/user/userconfig&a=deletelevel", utils.params({levelId: levelID, targetUserLevel: targetUserLevel}), function (json) {
								if(json.success){
									$.showResult(true, '删除成功', 3000);
									loadLevel();
									bootbox.hideAll();
								}else{
									$.showResult(false, json.msg);
								}
							});
							return false;
						}
					}
				}
			});
        });

		$('.btnSetRegisterDefault').off().on('click', function(){
			setRegisterDefault($(this).attr("levelId"), 1);
		});

		$('.btnCancelRegisterDefault').off().on('click', function(){
			setRegisterDefault($(this).attr("levelId"), 0);
		});

		$("[name=enableMinConsumptionForUpgrade],[name=enableMinAccumulatedPointsForUpgrade]").unbind('change').bind('change', function (event) {
			if($(this).prop('checked')){
				$(this).next('.spInputerGroup').removeClass('disabled').find(':text').prop('disabled', false);
			}else{
				$(this).next('.spInputerGroup').addClass('disabled').find(':text').prop('disabled', true);
			}
		});
    }

	function setRegisterDefault(levelId, state){
		$.ajax({
			type:'get',
			url:'/index.php?c=admin/user/userconfig&a=setlevelregisterdefault',
			data:{levelId: levelId, state: state},
			dataType:'json',
			cache:false,
			async:true,
			success:function(json){
				if(json.success){
					loadLevel();
				}else{
					$.showResult(false, json.msg);
				}
			},
			error:function(){
				$.showResult(false, arguments[0].responseText);
			}
		});

	}

	function showUserLevelForm(isNew, options){
		var content = $('.editUserLevelForm').find('form').clone().show();

		if(isNew){
			$('[name=LevelID]', content).val(options.LevelID);
			$('[name=Level]', content).val(options.Level);
			$('[name=LevelName]', content).val('');
			$('[name=DisCount]', content).val('100');
			$('[name=enableMinConsumptionForUpgrade]', content).prop('checked', false);
			$('[name=MinConsumptionForUpgrade]', content).val('');
			$('[name=enableMinAccumulatedPointsForUpgrade]', content).prop('checked', false);
			$('[name=MinAccumulatedPointsForUpgrade]', content).val('');
			$('[name=enableMinChildUsersCountForUpgrade]', content).prop('checked', false);
			$('[name=MinChildUsersCountForUpgrade]', content).val('');
			$('[name=enableMinChildUserConsumptionForUpgrade]', content).prop('checked', false);
			$('[name=MinChildUserConsumptionForUpgrade]', content).val('');
		}else{
			$('[name=LevelID]', content).val(options.ID);
			$('[name=Level]', content).val(options.Level);
			$('[name=LevelName]', content).val(options.LevelName);
			$('[name=DisCount]', content).val(options.DisCount);
			$('[name=enableMinConsumptionForUpgrade]', content).prop('checked', options.MinConsumptionForUpgrade !== null);
			$('[name=MinConsumptionForUpgrade]', content).val(options.MinConsumptionForUpgrade);
			$('[name=enableMinAccumulatedPointsForUpgrade]', content).prop('checked', options.MinAccumulatedPointsForUpgrade !== null);
			$('[name=MinAccumulatedPointsForUpgrade]', content).val(options.MinAccumulatedPointsForUpgrade);
			$('[name=enableMinChildUsersCountForUpgrade]', content).prop('checked', options.MinChildUsersCountForUpgrade !== null);
			$('[name=MinChildUsersCountForUpgrade]', content).val(options.MinChildUsersCountForUpgrade);
			$('[name=enableMinChildUserConsumptionForUpgrade]', content).prop('checked', options.MinChildUserConsumptionForUpgrade !== null);
			$('[name=MinChildUserConsumptionForUpgrade]', content).val(options.MinChildUserConsumptionForUpgrade);
		}

		var level = parseInt(options.Level);
		var levels = vm.levels();

		if(level == 1){
			for(var i = 0; i < levels.length; i++){
				if(levels[i].RegisterDefault == 1){
					$('.conditionsField', content).hide();
					break;
				}
			}
		}

		var prevMinConsumptionForUpgrade = 0;
		for(var i = 0; i < levels.length; i++){
			if(i <= level - 2){
				prevMinConsumptionForUpgrade = Math.max(parseFloat(levels[i]['MinConsumptionForUpgrade']) || 0, prevMinConsumptionForUpgrade);
			}
		}
		var nextMinConsumptionForUpgrade = 999999999999;
		for(var i = 0; i < levels.length; i++){
			if(i >= (isNew ? level - 1 : level)){
				nextMinConsumptionForUpgrade = Math.min(parseFloat(levels[i]['MinConsumptionForUpgrade']) || 999999999999, nextMinConsumptionForUpgrade);
			}
		}
		var hint = '(' + prevMinConsumptionForUpgrade + ' ~ ' + (nextMinConsumptionForUpgrade == 999999999999 ? '无限制' : nextMinConsumptionForUpgrade) + ')';
		$('.MinConsumptionForUpgradeHint', content).html(hint);

		var prevMinAccumulatedPointsForUpgrade = 0;
		for(var i = 0; i < levels.length; i++){
			if(i <= level - 2){
				prevMinAccumulatedPointsForUpgrade = Math.max(parseFloat(levels[i]['MinAccumulatedPointsForUpgrade']) || 0, prevMinAccumulatedPointsForUpgrade);
			}
		}
		var nextMinAccumulatedPointsForUpgrade = 999999999999;
		for(var i = 0; i < levels.length; i++){
			if(i >= (isNew ? level - 1 : level)){
				nextMinAccumulatedPointsForUpgrade = Math.min(parseFloat(levels[i]['MinAccumulatedPointsForUpgrade']) || 999999999999, nextMinAccumulatedPointsForUpgrade);
			}
		}
		var hint = '(' + prevMinAccumulatedPointsForUpgrade + ' ~ ' + (nextMinAccumulatedPointsForUpgrade == 999999999999 ? '无限制' : nextMinAccumulatedPointsForUpgrade) + ')';
		$('.MinAccumulatedPointsForUpgradeHint', content).html(hint);

		var prevMinChildUsersCountForUpgrade = 0;
		for(var i = 0; i < levels.length; i++){
			if(i <= level - 2){
				prevMinChildUsersCountForUpgrade = Math.max(parseFloat(levels[i]['MinChildUsersCountForUpgrade']) || 0, prevMinChildUsersCountForUpgrade);
			}
		}
		var nextMinChildUsersCountForUpgrade = 999999999999;
		for(var i = 0; i < levels.length; i++){
			if(i >= (isNew ? level - 1 : level)){
				nextMinChildUsersCountForUpgrade = Math.min(parseFloat(levels[i]['MinChildUsersCountForUpgrade']) || 999999999999, nextMinChildUsersCountForUpgrade);
			}
		}
		var hint = '(' + prevMinChildUsersCountForUpgrade + ' ~ ' + (nextMinChildUsersCountForUpgrade == 999999999999 ? '无限制' : nextMinChildUsersCountForUpgrade) + ')';
		$('.MinChildUsersCountForUpgradeHint', content).html(hint);	

		var prevMinChildUserConsumptionForUpgrade = 0;
		for(var i = 0; i < levels.length; i++){
			if(i <= level - 2){
				prevMinChildUserConsumptionForUpgrade = Math.max(parseFloat(levels[i]['MinChildUserConsumptionForUpgrade']) || 0, prevMinChildUserConsumptionForUpgrade);
			}
		}
		var nextMinChildUserConsumptionForUpgrade = 999999999999;
		for(var i = 0; i < levels.length; i++){
			if(i >= (isNew ? level - 1 : level)){
				nextMinChildUserConsumptionForUpgrade = Math.min(parseFloat(levels[i]['MinChildUserConsumptionForUpgrade']) || 999999999999, nextMinChildUserConsumptionForUpgrade);
			}
		}
		var hint = '(' + prevMinChildUserConsumptionForUpgrade + ' ~ ' + (nextMinChildUserConsumptionForUpgrade == 999999999999 ? '无限制' : nextMinChildUserConsumptionForUpgrade) + ')';
		$('.MinChildUserConsumptionForUpgradeHint', content).html(hint);

		content.validate({
			ignore: "",
			rules: {
				LevelName: {"required": true},
				DisCount: {"required": true, "range": [0, 100]},
				MinConsumptionForUpgrade: {"required": function(){
					return content.find('[name=enableMinConsumptionForUpgrade]').prop('checked');
				}, 'min': prevMinConsumptionForUpgrade + 0.00000000001, 'max': nextMinConsumptionForUpgrade - 0.00000000001},
				MinAccumulatedPointsForUpgrade: {"required": function(){
					return content.find('[name=enableMinAccumulatedPointsForUpgrade]').prop('checked');
				}, 'min': prevMinAccumulatedPointsForUpgrade + 0.00000000001, 'max': nextMinAccumulatedPointsForUpgrade - 0.00000000001},
				MinChildUsersCountForUpgrade: {"required": function(){
					return content.find('[name=enableMinChildUsersCountForUpgrade]').prop('checked');
				}, 'min': prevMinChildUsersCountForUpgrade + 0.00000000001, 'max': nextMinChildUsersCountForUpgrade - 0.00000000001},
				MinChildUserConsumptionForUpgrade: {"required": function(){
					return content.find('[name=enableMinChildUserConsumptionForUpgrade]').prop('checked');
				}, 'min': prevMinChildUserConsumptionForUpgrade + 0.00000000001, 'max': nextMinChildUserConsumptionForUpgrade - 0.00000000001}
			},
			messages: {
				LevelName: {"required": "请输入会员等级名称"},
				DisCount: {"required": "请输入会员折扣", 'range': '请输入0-100的数字'},
				MinConsumptionForUpgrade: {"required": "请输入消费金额", 'min': '不能小于等于 ' + prevMinConsumptionForUpgrade, 'max': '不能大于等于 ' + nextMinConsumptionForUpgrade},
				MinAccumulatedPointsForUpgrade: {"required": "请输入积分数", 'min': '不能小于等于 ' + prevMinAccumulatedPointsForUpgrade, 'max': '不能大于等于 ' + nextMinAccumulatedPointsForUpgrade},
				MinChildUsersCountForUpgrade: {"required": "请输入推荐会员数", 'min': '不能小于等于 ' + prevMinChildUsersCountForUpgrade, 'max': '不能大于等于 ' + nextMinChildUsersCountForUpgrade},
				MinChildUserConsumptionForUpgrade: {"required": "请输入推荐会员消费金额", 'min': '不能小于等于 ' + prevMinChildUserConsumptionForUpgrade, 'max': '不能大于等于 ' + nextMinChildUserConsumptionForUpgrade}
			},			
			errorPlacement: function (error, element) {
				error.appendTo(element.parent());
			}
		});

		$(".conditionSwitch", content).off('change').on('change', function (event) {
			$(this).nextAll('[type=number]').prop('disabled', !$(this).prop('checked'));
		}).change();

		var dialog = bootbox.dialog({
			title: isNew ? '新增会员等级' : '修改会员等级',
			message: content,
			className: 'editUserLevelDialog',
			buttons: {
				'cancel': {
					label: '取消'
				},
				'confirm': {
					label: '确定',
					className: "btn-success",
					callback: function () {
						if(!$(this).find('form').valid()){
							return false;
						}

						var form = $(this).find('form');
						var level = parseInt(form.find('[name=Level]').val());

						var enableMinConsumptionForUpgrade = form.find('[name=enableMinConsumptionForUpgrade]').prop('checked') ? 1 : 0;
						var MinConsumptionForUpgrade = parseFloat(form.find("input[name=MinConsumptionForUpgrade]").val());
						if(enableMinConsumptionForUpgrade){
							if(MinConsumptionForUpgrade <= prevMinConsumptionForUpgrade){
								$.showResult(false, '升级满消费金额不能小于等于更低级别金额 ' + prevMinConsumptionForUpgrade + ' 元');
								return false;
							}
							if(MinConsumptionForUpgrade >= nextMinConsumptionForUpgrade){
								$.showResult(false, '升级满消费金额不能大于等于更高级别金额 ' + nextMinConsumptionForUpgrade + ' 元');
								return false;
							}
						}

						var enableMinAccumulatedPointsForUpgrade = form.find('[name=enableMinAccumulatedPointsForUpgrade]').prop('checked') ? 1 : 0;
						var MinAccumulatedPointsForUpgrade = parseInt(form.find("input[name=MinAccumulatedPointsForUpgrade]").val());
						if(enableMinAccumulatedPointsForUpgrade){
							if(MinAccumulatedPointsForUpgrade <= prevMinAccumulatedPointsForUpgrade){
								$.showResult(false, '升级累计积分不能小于等于更低级别 ' + prevMinAccumulatedPointsForUpgrade + ' 积分');
								return false;
							}
							if(MinAccumulatedPointsForUpgrade >= nextMinAccumulatedPointsForUpgrade){
								$.showResult(false, '升级累计积分不能大于等于更高级别 ' + nextMinAccumulatedPointsForUpgrade + ' 积分');
								return false;
							}
						}

						var enableMinChildUsersCountForUpgrade = form.find('[name=enableMinChildUsersCountForUpgrade]').prop('checked') ? 1 : 0;
						var MinChildUsersCountForUpgrade = parseFloat(form.find("input[name=MinChildUsersCountForUpgrade]").val());
						if(enableMinChildUsersCountForUpgrade){
							if(MinChildUsersCountForUpgrade <= prevMinChildUsersCountForUpgrade){
								$.showResult(false, '推荐会员数不能小于等于更低级别 ' + prevMinChildUsersCountForUpgrade + ' 人');
								return false;
							}
							if(MinChildUsersCountForUpgrade >= nextMinChildUsersCountForUpgrade){
								$.showResult(false, '推荐会员数不能大于等于更高级别金额 ' + nextMinChildUsersCountForUpgrade + ' 元');
								return false;
							}
						}

						var enableMinChildUserConsumptionForUpgrade = form.find('[name=enableMinChildUserConsumptionForUpgrade]').prop('checked') ? 1 : 0;
						var MinChildUserConsumptionForUpgrade = parseFloat(form.find("input[name=MinChildUserConsumptionForUpgrade]").val());
						if(enableMinChildUserConsumptionForUpgrade){
							if(MinChildUserConsumptionForUpgrade <= prevMinChildUserConsumptionForUpgrade){
								$.showResult(false, '推荐会员消费金额不能小于等于更低级别金额 ' + prevMinChildUserConsumptionForUpgrade + ' 元');
								return false;
							}
							if(MinChildUserConsumptionForUpgrade >= nextMinChildUserConsumptionForUpgrade){
								$.showResult(false, '推荐会员消费金额不能大于等于更高级别金额 ' + nextMinChildUserConsumptionForUpgrade + ' 元');
								return false;
							}
						}

						var saveLevel = function(){
							$.getJSON("/index.php?c=admin/user/userconfig&a=editlevel", form.serialize(), function (json) {
								if(json.success){
									$.showResult(true,'保存成功', 3000);
									loadLevel();
									bootbox.hideAll();
								}else{
									$.showResult(false, json.msg);
								}
							});
						}

						if(level == 1 && options.RegisterDefault == 1){
							saveLevel();
						}else{
							var dialogConfirm = bootbox.dialog({
								title: false,
								message: '旧会员达到此条件，会自动升级到该等级，确定使用？',
								className: '',
								closeButton: false,
								buttons: {
									'cancel': {
										label: '取消',
										className: "btn-default btn-sm"
									},
									'confirm': {
										label: '确定',
										className: "btn-success btn-sm",
										callback: function () {
											saveLevel();
										}
									}
								}
							});
							var zIndex = 2000;
							$('.modal-backdrop').eq(-1).css('z-index', zIndex + 2);
							dialogConfirm.css('z-index', zIndex + 3);
							dialogConfirm.find('.modal-dialog').css('margin-top', 120);
							return false;
						}
					}
				}
			}
		});

	}

	function bindLoginConfigGridEvent(){
        $("#BtnEditLoginCfg").unbind('click').bind('click', function (event) {
			var params = $('#UserLoginConfigForm').serialize();
			//$.post("/admin/user/userconfig?act=EditLoginConfig",params,function(data, textStatus, jqXHR){
			$.post("/index.php?c=admin/user/userconfig&a=EditLoginConfig",params,function(data, textStatus, jqXHR){
				if(data.success){
				    $.showResult(true, "设置已保存", 2000);
				}else{
				    $.showResult(false, data.msg);
				}
			},"json");
			return false;
        });
    }

	function initCustomForm(formid, formname) {
	    $("#customForm").html("<iframe id='customFormFrame' name='customFormFrame' src='widget/customform.html?FormID=" + formid
            + "&FormName=" + formname + "&HideSaveBtn=1&DisableEmptyCheck=1&DisableFieldTypes=6,7,8' frameborder='0' style='width:100%;height:100%;'></iframe>");
	    setInterval(function () {
	        $('#customFormFrame').css({
	            'height': $('#customFormFrame').contents().height(),
	        });
	        setCustomFormStyle();
	    }, 100);
	}

	function setCustomFormStyle() {
	    var outerStyle = $('#customFormFrame').contents().find('style#outerStyle');
	    if (outerStyle.length == 0) {
	        $('#customFormFrame').contents().find('body').append('<style id="outerStyle"></style>');
	        outerStyle = $('#customFormFrame').contents().find('style#outerStyle');
	    }
	    var html = 'html{overflow-y:hidden;}';
	    html += 'body{background-color: #fff;}\r\n';
	    html += '.DivTitle span{background-color: #fff;color: #777676;}\r\n';
	    html += '.CustFieldsTable ul li div{background-color:transparent;}\r\n';
	    html += '.CustFieldsTable span{border: 0;}\r\n';
	    html += '.CustFieldsTable ul li {border-top: 1px solid #ccc;}\r\n';
	    html += '.MoveItem.fa-arrows{color: gray;}\r\n';
	    //html += '.CustFieldsT3 select{width: 100% !important;}\r\n';
	    outerStyle.html(html);
	}

    me.addListener('userconfig', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['useredit'] = function () {

	var me = this;

	var ViewModel = function() {
		this.setData = function(data) {
			for(var key in data) {
				//this[key] = data[key];
				if (data[key] == null) {
			        this[key] = '';
		        } else {
		            this[key] = data[key];
		        }
			}
		};
		this.getCrTime = function(time) {
			return time.replace(/T/g, " ");
		};
		this.getLogTime = function(time) {
			try {
				var parts = time.split("-");
				if(parseInt(parts[0]) < 2010) return "<font color='gray'>从未登录</font>";
			} catch(e) {}
			return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
		};
	};

	var ViewModelUserList = function () {
	    this.adminlist = ko.observableArray();
	    this.setData = function (data) {
	        this.adminlist(data);
	    };
	    this.getAgent = function (isagent) {
	        return isagent == 1 ? " <font color='red'>代理</font>" : "";
	    };
	}

	var vm = new ViewModel();
	var vmUserList = new ViewModelUserList();
	var myroot = null;
	var mustUpload = true;
	
	function initUI(root) {
		root.children().remove();
		root.loadHtmlTpl("plugins/businesspackage/html/useredit.html?v=" + Math.random(), function() {
			me.execCommand('initContentNav', root);
			//权限设置
			
			// if (!me.hasLicensePerm('ENABLE_JIFEN')){
			// 	$.get("/index.php?c=admin/page/Versiontip&page=useredit&msgtype=alert", null, function (json) {
			// 		$('input[name=tbPoint]').popover({
	  //           		content:json,
	  //           		placement:'right',
	  //           		title:'注意',
	  //           	});
	  //           	// $('input[name=tbPoint]').popover('show');
		            
		 //        });
			// 	$('input[name=tbPoint]').unbind('focus').focus(function(){
			// 		$('body').click(function (event) {
			//             var target = $(event.target);
			//             if (!target.hasClass('popover') && target.parent('popover-content').length === 0 && target.parent('popover-title').length === 0 && target.parent('popover').length === 0 && target.data('toggle') !== 'popover' && target.prop("tagName") != 'INPUT') {
			//                 $('input[name=tbPoint]').popover('hide');
			//             }
			//         });
			//         $('input[name=tbPoint]').blur();
			// 		$('input[name=tbPoint]').val(0);
			// 	});
			// }

            if (!me.hasLicensePerm('ENABLE_FENXIAO')){
            	$.get("/index.php?c=admin/page/Versiontip&page=useredit&msgtype=alert", null, function (json) {
      				$('#slUserType').popover({
	            		content:json,
	            		placement:'right',
	            		title:'注意',
	            	});
                });
                $('#slUserType').click(function(){
                    $('body').unbind('click').click(function (event) {
			            var target = $(event.target);
			            if (!target.hasClass('popover') && target.parent('popover-content').length === 0 && target.parent('popover-title').length === 0 && target.parent('popover').length === 0 && target.data('toggle') !== 'popover' && target.prop("tagName") != 'SELECT') {
			                $('#slUserType').popover('hide');
			            }
			        });
			        $('#slUserType').attr('disabled',true);
                });
            }
            if (!me.hasLicensePerm('ENABLE_AGENT')){
            	$.get("/index.php?c=admin/page/Versiontip&page=useredit&msgtype=alert", null, function (json) {
                        $('#isAgent').popover({
		            		content:json,
		            		placement:'right',
		            		title:'注意',
		            	});
		            	
                    });
                $('#isAgent').unbind('click').click(function(){
                	
                	$('body').click(function (event) {
			            var target = $(event.target);
			            if (!target.hasClass('popover') && target.parent('popover-content').length === 0 && target.parent('popover-title').length === 0 && target.parent('popover').length === 0 && target.data('toggle') !== 'popover' && target.prop("tagName") != 'SELECT') {
			                $('#isAgent').popover('hide');
			            }
			        });
                    $('#isAgent').attr('disabled',true);
                });
                
            }
			
			// $('#slUserType').unbind('click').click(function(){
			// 	$.get("/index.php?c=admin/page/Versiontip&page=useredit&msgtype=alert", null, function (json) {
		 //            alert(json);
		 //        });
			// });
			// $('#isAgent').unbind('click').click(function(){
			// 	$.get("/index.php?c=admin/page/Versiontip&page=useredit&msgtype=alert", null, function (json) {
		 //            alert(json);
		 //        });
			// });
			$('li:contains(会员详情), li:contains(下级分销)').css('display', 'none');

			$.validator.addMethod("mobile", function(value, element) {
				return this.optional(element) || isMobile(value);
			}, "手机号码格式不正确");

			$.validator.addMethod("mobileOrEmail", function(value, element) {
				if($(element).prop("readonly")) return true;
				return this.optional(element) || isMobile(value) || isEmail(value);
			}, "格式不正确");

			$.validator.addMethod("passwordCheck", function(value, element) {
				if(this.optional(element)) {
					return true;
				}
				if(/\s+/.test(value)) {
					return false;
				}
				if(!/\d+/.test(value)) {
					return false;
				}
				if(!/[a-zA-Z]+/.test(value)) {
					return false;
				}
				return true;
			}, "密码必须包含数字和字母，不能包含空格");

			$("#UserEditForm").validate({
				rules: {
					tbUserName: {required: true, mobileOrEmail: true},
					tbPassword: {required: true, rangelength: [7, 15], passwordCheck: true},
					tbPasswordC: {equalTo: "#tbPassword"},
					tbEmail: {required: false, email: true},
					tbTel: {required: false},
					tbMobile: {required: false, mobile: true},
					tbNickName: {required: false, maxlength: 100}
				}, messages: {
					tbUserName: {required: "请输入邮箱或者手机号码！", mobileOrEmail: "请输入邮箱或者手机号码"},
					tbPassword: {required: "请输入密码！", rangelength: "密码至少7位，最多15位", passwordCheck: "密码必须包含数字和字母，不能包含空格"},
					tbPasswordC: {equalTo: "两次密码不一致！"},
					tbEmail: {required: "请输入您的联系邮箱", email: "邮箱地址不正确！"},
					tbTel: {required: "请输入您的联系电话！", isTel: "电话号码格式不正确"},
					tbMobile: {required: "请输入手机号码", mobile: "手机号码格式不正确"},
					tbNickName: {required: "请输入昵称", maxlength: "昵称最多100个字符"}
				}, submitHandler: function(form) {
					submitForm();
					return false;
				}, errorPlacement: function(error, element) {
					error.appendTo($(element).closest('td'));
				}
			});

			$("#isSetPwd").unbind().click(function() {
				$('#tbPassword,#tbPasswordC').val('').prop('disabled', !$(this).prop("checked"));
				$('label[for=tbPassword]').hide();
			});

			$('#saveBtn').floatSaveBtn();
			loadLevelList();
			myroot = root[0];
			//会员中心取消店铺装修和优惠券的设置
			// var div='<div class="lcoupon"><div>选择所有优惠券 <input type="checkbox" id="allCoupon"></div>';
			// $.getJSON("/index.php?c=admin/business/coupon&a=GetList&isagent=1",'uid='+me.currentModule.params.id,function(data){
			// 	for(var l in data.list)
			// 	{
			// 		if(data.list[l].AgentUserID)
			// 			var checked=data.list[l].AgentUserID.indexOf('('+data.storeid+'|')>=0 ? 'checked':'';
			// 		else
			// 			var checked='';
			// 		div+='<div>'+data.list[l].Title+'<input type="checkbox" name="coupon[]" value="'+data.list[l].CouponID+'" '+checked+'></div>';
			// 	} 
			// 	div+='</div>';
			// 	$('#coupon_list').html(div);
			// 	console.log(div);
			// });
			
			if (me.currentModule.params && me.currentModule.params.id) {
			    $('#trUserID').show();
			    $('#trUserName').hide();
			    loadUser();
			}
			else {
			    $('#trUserID').hide();
			    $('#trUserName').show();
			    $("#isSetPwd").click();
			}

			$("#BtnSetParentUser").unbind().click(function () {
			    $("#SetParentUserDialog").remove();
			    $("body").append("<div id='SetParentUserDialog'></div>");
			    var onload = function () {
			        ko.applyBindings(vmUserList, $("#SetParentUserDialog")[0]);
			        vmUserList.setData('');
			        $("#BtnCancel").unbind().click(function () {
			            $("#tbParentUserName").val("无");
			            $("#tbParentUserID").val("");
			            $("#SetParentUserDialog").remove();
			        });
			        $("#BtnSearch").unbind().click(function () {
			            if ($("#keyword").val() != '') {
			                //$.getJSON("/admin/user/usermanage?act=getlist", GetParams(1), function (json) {
			            	$.getJSON("/index.php?c=admin/user/usermanage&a=getlist", GetParams(1), function (json) {
			                    vmUserList.setData(json.list);
			                    bindGridEvent();
			                });
			            }
			        });
			        $("#SetParentUserDialog").dialog({ resizable: false, title: "设置推荐人", modal: true, width: 500, maxHeight : 500, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
			    }
			    $("#SetParentUserDialog").loadHtmlTpl("plugins/businesspackage/html/userlistmini.html", onload);
			});
			
			$('#isAgent').change(function(){
				if($('#isAgent').val()==1)
				{
//					if(agent_binding>0)
//					{
//						if($('#AgentBinding').length==0)
//							$('#isAgent').parents('tr').after('<tr class="isasd" id="AgentBinding"><td style="text-align:right;">绑定公众号：</td><td><input type="checkbox" name="AgentBinding" value="1"></td></tr>');
//					}
//					//会员中心取消店铺装修和优惠券的设置
					// if(agent_decoration>0)
					// {
					// 	if($('#AgentDecoration').length==0)
					// 		$('#isAgent').parents('tr').after('<tr class="isasd" id="AgentDecoration"><td style="text-align:right;">店铺装修：</td><td><input type="checkbox" name="AgentDecoration" value="1"></td></tr>');
					// }
					if(agent_delivery>0&&me.hasLicensePerm('ENABLE_AGENT_PROXY_DELIVERY'))
					{
						$('#isAgent').parents('tr').after('<tr class="isasd" id="AgentDelivery"><td style="text-align:right;">代理发货：</td><td><input type="checkbox" name="IsAgentDelivery" value="1">此代理可以自行发货</td></tr>');
						if(is_agent_delivery)
							$('input[name="IsAgentDelivery"]').attr('checked',true);
					}
					//会员中心取消店铺装修和优惠券的设置
					// if(agent_coupon>0)
					// {
					// 	$('#isAgent').parents('tr').after('<tr class="isasd" id="AgentCoupon"><td style="text-align:right;">代理发送优惠券：</td><td><input type="checkbox" name="AgentCoupon" value="1"></td></tr>');
					
					// 	//$('#isAgent').parents('tr').after('<tr class="isasd" id="AgentCoupon"><td style="text-align:right;">代理发送优惠券：</td><td><input type="checkbox" name="AgentCoupon" value="1"></td></tr>');
						
					// 	$('input[name="AgentCoupon"]').after($('#coupon_list').html());
					// 	$('input[name="AgentCoupon"]').change(function(){
					// 		if($(this).prop('checked'))
					// 		{
					// 			$('.lcoupon').show();
					// 		}
					// 		else
					// 		{
					// 			$('.lcoupon').hide();
					// 			$('.lcoupon').find('input[type="checkbox"]').attr('checked',false);
					// 		}
							
					// 	});
					// 	$('#allCoupon').click(function (){
					// 		if($(this).prop('checked'))
					// 			$('.lcoupon').find('input[type="checkbox"]').prop('checked',true);
					// 		else
					// 			$('.lcoupon').find('input[type="checkbox"]').prop('checked',false);
					// 	});
					// }
				}
				else if($('#isAgent').val()>1)
				{
					/*
					if(agent_binding>0)
					{
						if($('#AgentBinding').length==0)
							$('#isAgent').parents('tr').after('<tr class="isasd" id="AgentBinding"><td style="text-align:right;">绑定公众号：</td><td><input type="checkbox" name="AgentBinding" value="1"></td></tr>');
					}
					*/
					//会员中心取消店铺装修和优惠券的设置
					// if(agent_decoration>0)
					// {
					// 	if($('#AgentDecoration').length==0)
					// 		$('#isAgent').parents('tr').after('<tr class="isasd" id="AgentDecoration"><td style="text-align:right;">店铺装修：</td><td><input type="checkbox" name="AgentDecoration" value="1"></td></tr>');
					// }
					$('#AgentDelivery').remove();
					$('#AgentCoupon').remove();
				}
				else if($('#isAgent').val()==0)
				{
					$('.isasd').remove();
				}
					
			});

			loadRegItemList();
			loadCustomFormData();
		});

	}

	function GetParams(page) {
	    return utils.params({
	        keyword: $("#keyword").val(),
	        page: page,
	        pagesize: 10
	    });
	}

	function bindGridEvent() {

	    $("*[name=BtnChooseParent]").unbind('click').bind('click', function (event) {
	        $("#tbParentUserName").val("(ID:" + $(this).attr("UserID") + ")" + $(this).attr("NickName"));
	        $("#tbParentUserID").val($(this).attr("UserID"));
	        $("#SetParentUserDialog").remove();
	    });
	}

	var levellist = null;

	function loadLevelList() {
		$.ajax({
			//url: "/admin/user/userconfig?act=GetLevelList", async: false, dataType: "json", success: function(json) {
			url: "/index.php?c=admin/user/userconfig&a=GetLevelList", async: false, dataType: "json", success: function(json) {
				if(json.success) {
					levellist = json.list;
					for(var i = 0; i < json.list.length; i++) {
						$("#userLevel").append("<option value='" + json.list[i].ID + "'>" + json.list[i].LevelName + "</option>");
					}
				} else {
					alert("出错了：" + json.msg);
				}
			}
		});
	}
	var agent_delivery=0;
	var agent_decoration=0;
	var agent_binding=0;
	var agent_coupon=0;
	var is_agent_delivery=0;
	
	function loadUser() {
		$('#maincontent li:contains("会员详情"), #maincontent li:contains("下级分销")').show();
		$('li:contains("会员详情")').addClass('active');
		$('li a:contains("会员详情"), li a:contains("下级分销")').attr('p', '{"id":"' + me.currentModule.params.id + '"}');
		var params = {sid: me.sid, id: me.currentModule.params.id};
		//$.getJSON("/admin/user/usermanage?act=GetInfo", utils.params(params), function(json) {
		$.getJSON("/index.php?c=admin/user/usermanage&a=GetInfo", utils.params(params), function(json) {
			vm.setData(json.info);
			ko.applyBindings(vm, myroot);
			$("#isAgent").children().remove();
			$.each(json.agentLevels, function(i,item){
				$("#isAgent").append("<option value='"+ item.level +"'>"+ item.name +"</option>");
			});
			$("#isAgent").val(json.info.IsAgent);
			
			if(json.info.EnableAgent)
			{
				if(json.info.IsAgent==1&&json.info.EnableAgentDelivery>0&&me.hasLicensePerm('ENABLE_AGENT_PROXY_DELIVERY'))
				{
					agent_delivery=1;
					$('#isAgent').parents('tr').after('<tr class="isasd" id="AgentDelivery"><td style="text-align:right;">代理发货：</td><td><input type="checkbox" name="IsAgentDelivery" value="1">此代理可以自行发货</td></tr>');
					if(json.info.IsAgentDelivery==1)
					{
						is_agent_delivery=1;
						$('input[name="IsAgentDelivery"]').attr('checked',true);
					}
				}
				/*
				if(json.info.EnableAgentBinding>0)
				{
					agent_binding=1;
					$('#isAgent').parents('tr').after('<tr class="isasd" id="AgentBinding"><td style="text-align:right;">绑定公众号：</td><td><input type="checkbox" name="AgentBinding" value="1"></td></tr>');
					if(json.info.AgentBinding==1)
						$('input[name="AgentBinding"]').attr('checked',true);
				}
				*/
			//会员中心取消店铺装修和优惠券的设置
				// if(json.info.EnableAgentDecoration>0)
				// {
				// 	agent_decoration=1;
				// 	$('#isAgent').parents('tr').after('<tr class="isasd" id="AgentDecoration"><td style="text-align:right;">店铺装修：</td><td><input type="checkbox" name="AgentDecoration" value="1"></td></tr>');
				// 	if(json.info.AgentDecoration==1)
				// 		$('input[name="AgentDecoration"]').attr('checked',true);
				// }
				// if(json.info.IsAgent==1&&json.info.EnableAgentCoupon>0)
				// {
				// 	agent_coupon=1;
				// 	$('#isAgent').parents('tr').after('<tr class="isasd" id="AgentCoupon"><td style="text-align:right;">代理发送优惠券：</td><td><input type="checkbox" name="AgentCoupon" value="1"></td></tr>');
					
				// 	$('input[name="AgentCoupon"]').after($('#coupon_list').html());
				// 	$('input[name="AgentCoupon"]').change(function(){
				// 		if($(this).prop('checked'))
				// 		{
				// 			$('.lcoupon').show();
				// 		}
				// 		else
				// 		{
				// 			$('.lcoupon').hide();
				// 			$('.lcoupon').find('input[type="checkbox"]').prop('checked',false);
				// 		}
						
				// 	});
				// 	$('#allCoupon').click(function (){
				// 		if($(this).prop('checked'))
				// 			$('.lcoupon').find('input[type="checkbox"]').prop('checked',true);
				// 		else
				// 			$('.lcoupon').find('input[type="checkbox"]').prop('checked',false);
				// 	});
				// 	if(json.info.AgentCoupon==1)
				// 	{
				// 		$('input[name="AgentCoupon"]').attr('checked',true);
				// 	}
				// }
					
			}
			$("#tbUserName", myroot).prop("readonly", true);
		    try {
		        if (json.parentInfo) {
		            $("#tbParentUserName").val("(ID:" + json.parentInfo.UserID + ")" + json.parentInfo.NickName);
		            $("#BtnSetParentUser").val("修改推荐人");
		        } else {
		            $("#tbParentUserName").val('无');
		        }
		    } catch (e) { }
		});
	}

	function loadRegItemList() {
	    $.ajax({
	        type: 'get',
	        url: '/index.php?c=admin/user/userconfig&a=GetRegItemList&v=' + Math.random(),
	        data: {},
	        cache: false,
	        async: false,
	        dataType: "json",
	        success: function (json) {
	            if (!json.success) {
	                $.showResult(false, json.msg);
	                return;
	            }
	            if (json.list) {
	                for (var i = 0; i < json.list.length; i++) {
	                    if ($.inArray(json.list[i].ItemEnName.toLowerCase(), ['mobile', 'email']) == -1) {
	                        if (json.list[i].IsShow) {
	                            $('[name="tb' + json.list[i].ItemEnName + '"]').closest('tr').show();
	                        } else {
	                            $('[name="tb' + json.list[i].ItemEnName + '"]').closest('tr').hide();
	                        }
	                    }
	                }
	            }
	        },
	        error: function () {
	            $.showResult(false, arguments[0].responseText);
	        }
	    });
	}

	function loadCustomFormData() {
	    var userid = me.currentModule ? (me.currentModule.params ? me.currentModule.params.id : 0) : 0;

	    $.ajax({
	        type: 'get',
	        url: '/index.php?c=admin/user/usermanage&a=GetCustomFormData&v=' + Math.random(),
	        data: { userid: userid },
	        cache: false,
	        async: false,
	        dataType: "json",
	        success: function (json) {
	            if (!json.success) {
	                $.showResult(false, json.msg);
	                return;
	            }
	            if (json.formcss) {
	                $('#formStyle').html(json.formcss);
	            }
	            if (json.formhtml) {
	                use_external_submit_UserEditForm = 1; // prevent customform default validate or submit

	                $('#formContent').html(json.formhtml);

	                $('#formContent .customFormItem').each(function () {
	                    var name = $(this).find('input[name], textarea[name], select[name]').attr('name');
	                    if (name) {
	                        var html = '<tr class="customFormItem" matchcolname="' + name + '">';
	                        html += '<td></td><td></td>';
	                        html += '</tr>';

	                        if ($('tr[matchcolname]').length == 0) {
	                            $(html).insertAfter($('#formContent').parent('tr'));
	                        } else {
	                            $(html).insertAfter($('[matchcolname]:last'));
	                        }
	                    }
	                });

	                $('#formContent .customFormItem').each(function () {
	                    var name = $(this).find('input[name], textarea[name], select[name]').attr('name');
	                    var matchcoltr = $('tr[matchcolname="' + name + '"]');
	                    $(this).find('.customFieldName').appendTo(matchcoltr.children('td:eq(0)'));
	                    $(this).children().appendTo(matchcoltr.children('td:eq(1)'));
	                    matchcoltr.children('td:eq(1)').find(':text, textarea, select').addClass('form-control EditUserInput');
	                    matchcoltr.children('td:eq(1)').find('select').css('width', '200px');
	                    matchcoltr.find('td:eq(0)>.customFieldName>font').remove();
	                    matchcoltr.find('td:eq(0)>.customFieldName').html(matchcoltr.find('td:eq(0)>.customFieldName').text() + '：');
	                });

	                if (typeof formValidateOptions == 'function') {
	                    if ($('#UserEditForm').data('validator')) {
	                        var customFormValidateOpts = formValidateOptions('#UserEditForm');
	                        $('#UserEditForm').data('validator').settings.rules = $.extend(true, $('#UserEditForm').data('validator').settings.rules, customFormValidateOpts.rules) || {};
	                        $('#UserEditForm').data('validator').settings.messages = $.extend(true, $('#UserEditForm').data('validator').settings.messages, customFormValidateOpts.messages) || {};
	                    }
	                }
	            }

	            $('#formContent').parent('tr').hide();

	            if (json.data) {
	                var data = json.data;
	                for (var key in data) {
	                    if (key.indexOf('cc_') === 0) {
	                        var chname = key.replace(/cc_(.*)/i, '$1');
	                        var ctrls = $('[chname="' + chname + '"]');
	                        if (ctrls.is('.customFormRadio')) {
	                            $('[chname="' + chname + '"][value="' + data[key] + '"]').prop('checked', true);
	                        } else if (ctrls.is('.customFormCheckbox')) {
	                            if ($.isArray(data[key])) {
	                                for (var i = 0 ; i < data[key].length; i++) {
	                                    $('[chname="' + chname + '"][value="' + data[key][i] + '"]').prop('checked', true);
	                                }
	                            } else if (typeof data[key] == 'string') {
	                                $('[chname="' + chname + '"][value="' + data[key] + '"]').prop('checked', true);
	                            }
	                        } else if (ctrls.is('.customFormSelect')) {
	                            $('[chname="' + chname + '"]').val(data[key])
	                            if (data[key] !== '') {
	                                $('[chname="' + chname + '"]').data('hasVal', 1);
	                            }
	                        } else {
	                            $('[chname="' + chname + '"]').val(data[key]);
	                        }
	                    }
	                }
	            }
	        },
	        error: function () {
	            $.showResult(false, arguments[0].responseText);
	        }
	    });
	}

	function submitForm(form) {
	    var paramsObj = $('#UserEditForm').serializeObject(); //此方法定义在 core/ui.js
	    //console.log(paramsObj);return;
	    //$.post("/admin/user/usermanage?act=edit", paramsObj, function (json, textStatus, jqXHR) {
	    $.post("/index.php?c=admin/user/usermanage&a=edit", paramsObj, function (json, textStatus, jqXHR) {
	        if (json.success) {
	            $.showResult(true, "修改成功", 1000, function () {
	                // me.execCommand('go', { a: 'business', b: 'userlist' });
	                if (me.currentModule.params && me.currentModule.params.id && me.currentModule.params.searchParams) {
		                me.execCommand('go', { a: 'business', b: 'userlist', params: { searchParams: me.currentModule.params.searchParams } })
		            } else {
		                me.execCommand('go', { a: 'business', b: 'userlist' });
		            }
	            });
	        } else {
	            $.showResult(false, json.msg);
	        }
	        $('li:contains("会员详情"), li:contains("下级分销")').hide();
	    }, "json");
	    return false;
	}

	me.addListener('useredit', function(key, args) {
		initUI(args);
	});
}

﻿IWF.plugins['userlist'] = function() {

	var me = this;

	var ViewModel = function() {
		this.adminlist = ko.observableArray();
		this.setData = function(data) { this.adminlist(data); };
		this.getLevelName = function(levelid) {
			for(var i = 0; i < levellist.length; i++) {
				if(levellist[i].ID == levelid) {
					return levellist[i].LevelName;
				}
			}
			return "未分级";
		}
		this.getTime = function(time) {
			return time.replace(/T/gi, " ").replace(/(\.\d+)/, "").split(' ')[0];
		}
		this.getAgent = function(isagent) {
			//return isagent == 1 ? " <font color='red'>代理</font>" : "";
			return isagent >0 ? " <font color='red'>"+isagent+"级代理</font>" : "";
		};
		this.getLogTime = function(time) {
			try {
				var parts = time.split("-");
				if(parseInt(parts[0]) < 2010) return "<font color='gray'>从未登录</font>";
			} catch(e) {}
			return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
		},
        this.compareTime = function (t1, t2) {
            return new Date(t1).getTime() - new Date(t2).getTime();
        }
	};

	var ViewModelProduct = function () {
        this.prolist = ko.observableArray();
        this.setData = function (data) { this.prolist(data); };
	};
	
	var ViewModelLevel = function () {
		this.setData = function (data) {
			for(var key in data){
				if(data[key] == null){
					this[key]=0;
				}else{
					this[key] = data[key];
				}	
			}
		};      
	};

	var vm = new ViewModel();

	function initUI(root) {
		root.children().remove();
		// if (!me.hasLicensePerm('ENABLE_SHOP')) {
  //           root.load("/index.php?c=admin/page/Versiontip&page=userlist");
  //           return;
  //       }
		root.loadHtmlTpl("plugins/businesspackage/html/userlist.html", function() {
			me.execCommand('initContentNav', root);
			
			$('li:contains(会员详情), li:contains(下级分销)').css('display', 'none');
			bindUIEvent();
			loadUserLevel();
			ko.applyBindings(vm, $('#showListTable')[0]);
			if (me.currentModule.params && me.currentModule.params.searchParams) {
		        try {
		            searchParams = JSON.parse(decodeURIComponent(me.currentModule.params.searchParams));
		            $("#keyword").val(searchParams.keyword);
		            $("#Minimum").val(searchParams.Minimum);
		            $("#Maximum").val(searchParams.Maximum);
		            $("#TimeBegin").val(searchParams.TimeBegin);
		            $("#TimeEnd").val(searchParams.TimeEnd);
		            $("#levelid").val(searchParams.levelid);
		            $("#status").val(searchParams.status);
		            $("#distribution").val(searchParams.distribution);
		            $("#TimeStamp").val(searchParams.TimeStamp);
		            loadUserList(1,searchParams);
		        } catch (ex) {
		        	loadUserList(1);
		        }
			}else{
				loadUserList(1);
			}
			$(function() {
				$( "#TimeBegin" ).datepicker({
					format: "yyyy/mm/dd",
					defaultDate: "+1w",
					changeMonth: true,
					dateFormat: "yy/mm/dd",
					language: "zh-CN",
					orientation: "bottom auto",
					showOptions: { direction: "down" },
					onClose: function( selectedDate ) {
						$( "#TimeEnd" ).datepicker( "option", "minDate", selectedDate );
					}
				});
				$( "#TimeEnd" ).datepicker({
					format: "yyyy/mm/dd",
					defaultDate: "+1w",
					changeMonth: true,
					dateFormat: "yy/mm/dd",
					language: "zh-CN",
					orientation: "bottom auto",
					showOptions: { direction: "down" },
					onClose: function( selectedDate ) {
						$( "#TimeBegin" ).datepicker( "option", "maxDate", selectedDate );
					}
				});
			});
			$('#agent').change(function(){
				if($('#agent >option:selected').val()==1)
				{
					$('#agentlevel').parent('.input-group').show();
					loadAgentLevel();
				}
				else
					$('#agentlevel').parent('.input-group').hide();
			});
		});
	}

	var levellist = null;

	function loadUserLevel() {
		$("#levelid").children().remove();
		$("#levelid").append("<option value=''>--全部级别--</option>");
		$.ajax({
			//url: "/admin/user/userconfig?act=GetLevelList", async: false, dataType: "json", success: function(json) {
			url: "/index.php?c=admin/user/userconfig&a=GetLevelList", async: false, dataType: "json", success: function(json) {
				if(json.success) {
					levellist = json.list;
					for(var i = 0; i < json.list.length; i++) {
						$("#levelid").append("<option value='" + json.list[i].ID + "'>" + json.list[i].LevelName + "</option>");
					}
				} else {
					alert("出错了：" + json.msg);
				}
			}
		});
	}
	
	function loadAgentLevel(){
		$("#agentlevel").html("");
		$("#agentlevel").append("<option value='0'>--所有代理--</option>");
		$.ajax({
			url: "/index.php?c=admin/user/usermanage&a=getinfo", async: false, dataType: "json", success: function(json) {
				if(json.success) {
					for(var i = 1; i < json.agentLevels.length; i++) {
						$("#agentlevel").append("<option value='" + json.agentLevels[i].level + "'>" + json.agentLevels[i].name + "</option>");
					}
				} else {
					alert("出错了：" + json.msg);
				}
			}
		});
	}

	var curpage = 1;
	var itemcount = 0;
	var searchParams = {};
	function loadUserList(page,params) {
		params = params || {keyword: $("#keyword").val(),Minimum: $("#Minimum").val(),Maximum: $("#Maximum").val(),TimeBegin: $("#TimeBegin").val(),TimeEnd: $("#TimeEnd").val(),level: $("#levelid").val(),status: $("#status").val(),distribution: $("#distribution").val(),agent:$('#agent').val(),agentlevel:$('#agentlevel').val(),TimeStamp: $("#TimeStamp").val(),orderby:$("#orderby").val(),page: page,pagesize: 20};
		//$.getJSON("/admin/user/usermanage?act=getlist", GetParams(page), function(json) {
		$.getJSON("/index.php?c=admin/user/usermanage&a=getlist",utils.params(params), function(json) {
			var OrderObject = {}, ParenObject = {};
			var FinanceObject = {};
			json.order && json.order[0] && (function() {
				for(var i = 0, j; j = json.order[i++];) {
					OrderObject[j['UserID']] = j;
				}
			})();
			/*
			json.parents && json.parents[0] && (function() {
				for(var i = 0, j; j = json.parents[i++];) {
					ParenObject[j['UserID']] = j;
				}
			})();
			json.finance && json.finance[0] && (function() {
				for(var i = 0, j; j = json.finance[i++];) {
					FinanceObject[j['UserID']] = j;
				}
			})();
			*/
			json.list && json.list[0] && (function() {
				for(var i = 0, j; j = json.list[i++];) {
					j['TotalMoney'] = OrderObject[j['UserID']] ? OrderObject[j['UserID']]['Money'] : 0;
					j['TotalOrder'] = OrderObject[j['UserID']] ? OrderObject[j['UserID']]['OrderID'] : 0;
					//j['ParentUser'] = ParenObject[j['ParentUserID']] ? ParenObject[j['ParentUserID']]['NickName'] : '(无)';
					//j['ParentUsID'] = ParenObject[j['ParentUserID']] ? j['ParentUserID'] : '';
					//j['FinanceMoney'] = FinanceObject[j['UserID']] ? FinanceObject[j['UserID']]['FINMoney'] : 0;
				}
			})();
			//con  sole.log(json.parents);
			//con  sole.log(OrderObject);
			//con  sole.log(json.order);
			//con  sole.log(json.list);
			vm.setData(json.list);
			$('#selectAll').prop("checked", false);
			curpage = json.curpage;
			itemcount = json.list ? json.list.length : 0;
			if(json.pagecount < 2) $("#pagination").hide(); else {
				//pageNav 方法定义在 /core/util.js 里
				$("#pagination").pageNav(json.curpage, json.pagecount, 10, function(page) { loadUserList(page); });
				$("#pagination").show();
			}
			$('#Total').html('共 ' + json.pagecount + ' 页， ' + json.rowcount + '条记录');
			$('#TimeColumn').html({'':'注册时间','1':'首笔订单','0':'最新订单'}[$('#TimeStamp').val()]);
			bindGridEvent();
			searchParams = params;
		});
	}

	function ExportUserList() {
		window.open("/index.php?c=admin/user/usermanage&a=Export&" + $.param(GetParams()));
		//$.getJSON("/admin/user/usermanage?act=Export", GetParams(), function(json) {
		/*
		$.getJSON("/index.php?c=admin/user/usermanage&a=Export", GetParams(), function(json) {
			window.location.href = '/comdata/' + getCookie('InitSiteID') + '/Excel/ExportUserList.csv';
		});
		*/
	}

	function GetParams(page){
		return utils.params({
			keyword: $("#keyword").val(),
			Minimum: $("#Minimum").val(),
			Maximum: $("#Maximum").val(),
			TimeBegin: $("#TimeBegin").val(),
			TimeEnd: $("#TimeEnd").val(),
			level: $("#levelid").val(),
			status: $("#status").val(),
			distribution: $("#distribution").val(),
			TimeStamp: $("#TimeStamp").val(),
			page: page,
			pagesize: 20
		});
	}

	function showSetLevelDialog(id, levelid) {
		var html = "<div id='SelLevelDialog'><center>";
		html += "请选择分类：<select id='setlevel_lid' class='form-control' style='width:160px;display:inline'>";
		html += $("#levelid").html();
		html += "</select>";
		$("body").append(html);
		$("#setlevel_lid option:first-child").remove();
		$("#setlevel_lid").val(levelid);
		$("#setlevel_lid").append("<option value='0'>设为未分级</option>");
		$("#SelLevelDialog").dialog({
			resizable: false,
			title: "设置分类",
			modal: true,
			width: 300,
			position: ['center', 'middle'],
			close: function(event, ui) { $(this).remove(); },
			buttons: {
				"确定": function() {
					setUserLevel(id, $("#setlevel_lid").val());
					$(this).remove();
				}, "取消": function() { $(this).remove(); }
			}
		});
	}

	function loadProductClsList() {
		$("#ProductClassID").children().remove();
		$("#ProductClassID").append("<option value=''>--全部分类--</option>");
		$.ajax({ url: "/index.php?c=admin/product/productmanage&a=GetClassList", async: true, dataType: "json", success: function (json) {
				if(json.success){
					classlist = json.list;
					for(var i = 0;i < json.list.length;i++){
						if(json.list[i].ParentID == 0){
							$("#ProductClassID").append("<option value='"+ json.list[i].ClassID +"'>"+ json.list[i].Name +"</option>");
							for(var j = 0;j < json.list.length;j++){
								if(json.list[j].ParentID == json.list[i].ClassID){
								    $("#ProductClassID").append("<option value='" + json.list[j].ClassID + "'> &nbsp;&nbsp;└-" + json.list[j].Name + "</option>");
								    for (var k = 0; k < json.list.length; k++) {
								        if (json.list[k].ParentID == json.list[j].ClassID) {
								            $("#ProductClassID").append("<option value='" + json.list[k].ClassID + "'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└-" + json.list[k].Name + "</option>");
								        }
								    }
								}
							}
						}
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}
	
	var vmpro = new ViewModelProduct();
    function loadProductList(page) {
		var params = { sid: me.sid, keyword: $("#ProductKeyword").val(),classid : $("#ProductClassID").val(), page: page, pagesize: 15 };
		$.getJSON("/index.php?c=admin/product/productmanage&a=getlist&status=1", utils.params(params), function (json) {
            vmpro.setData(json.list);
            if (json.pagecount < 2) $("#ProductPagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#ProductPagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadProductList(page); });
                $("#ProductPagination").show();
            }

			$("*[name=btnOrderProduct]").unbind('click').bind('click', function(event) {
				var params = "&UserID=" + $(this).attr('UserID') + '&ProductID=' + $(this).attr('ProductID');
				params += "&AdminBuyForUserAutoOrderOver=" + ($('#AdminBuyForUserAutoOrderOver:checked').val() | 0);
				params += "&AdminBuyForUserAutoFenYong=" + ($('#AdminBuyForUserAutoFenYong:checked').val() | 0);
				params += "&AdminBuyForUserNoWuliu=" + ($('#AdminBuyForUserNoWuliu:checked').val() | 0);
				params += "&AdminBuyForUserAutoLogout=" + ($('#AdminBuyForUserAutoLogout:checked').val() | 0);
				//if(window.location.toString().indexOf('isphp') > -1) window.open("/index.php?c=Admin/Business/AdminBuyForUser" + params,'adminbuywindow');
				//else window.open("/admin/business/adminbuyforuser?act=GoToBuy" + params,'adminbuywindow');
				window.open("/index.php?c=Admin/Business/AdminBuyForUser" + params,'adminbuywindow');
				$("#AdminBuyDialog").dialog("close");
			});
        });
    }

	function showAdminBuyDialog(id,nickname) {
		var html = "<div id='AdminBuyDialog'>";
		html += "产品分类：<select id='ProductClassID' class='form-control' style='width:160px;display:inline'>";
		html += "<input type='text' class='form-control input' id='ProductKeyword' placeholder='产品关键词' style='margin-left:20px;width:200px'>";
		html += "<input type='button' class='btn btn-primary' id='btnSearchProduct' value='搜索产品' style='margin-left:20px'>";
		html += "</select>";
		html += "<div style='margin-top:10px'>";
		html += "<p style='width:100%'><input type='checkbox' id='AdminBuyForUserNoWuliu' checked value='1'>下单时无需填写收货地址</p>";
		html += "<p style='width:100%'><input type='checkbox' id='AdminBuyForUserAutoOrderOver' checked value='1'>订单直接变“交易成功”状态（无需商家在后台更改订单状态）</p>";
		html += "<p style='width:100%'><input type='checkbox' id='AdminBuyForUserAutoFenYong' checked value='1'>自动审核佣金（无需商家手工审核）</p>";
		html += "<p style='width:100%'><input type='checkbox' id='AdminBuyForUserAutoLogout' checked value='1'>下单后退出该会员账号</p>";
		html += "</div>";
		html += "<div id='ProductList' style='margin-top:10px'>";
		html += "<table class='table table-hover table-bordered table-striped'><tbody data-bind='foreach: prolist'>";
		html += "<tr><td data-bind='text:Name'></td><td><input type='button' class='btn btn-primary' name='btnOrderProduct' UserID='"+ id +"' data-bind='attr:{ProductID:ProductID}' value='下单'></td></tr>";
		html += "</tbody></table></div>";
		html += "<div id='ProductPagination'></div>";
		$("body").append(html);
		vmpro = new ViewModelProduct();
		ko.applyBindings(vmpro, $('#ProductList')[0]);
		loadProductClsList();
		loadProductList();
		$("#btnSearchProduct").unbind().click(function(){
			loadProductList();
		});
		$("#AdminBuyDialog").dialog({
			resizable: false,
			title: "代客 "+ nickname + "(" + id +") 下单",
			modal: true,
			width: 700,
			height: 600,
			position: ['center', 'middle'],
			close: function(event, ui) { $(this).remove(); },
		});
	}

	function setUserLevel(id, level) {
		var params = {'id': id, 'level': level};
		//$.post("/admin/user/usermanage?act=setlevel", params, function(data, textStatus, jqXHR) {
		$.post("/index.php?c=admin/user/usermanage&a=setlevel", params, function(data, textStatus, jqXHR) {
			if(data.success) {
				loadUserList(curpage);
			} else {
				alert(json.msg);
			}
		}, "json");
	}

	function getSelectedArtIDs() {
		var array = new Array();
		$("input[name=UserID]:checked").each(function() {
			array.push($(this).val());
		});
		var id = array.join(',');
		return id;
	}

	function bindUIEvent() {
		$("#BtnSearch").unbind('click').bind('click', function(event) {
			loadUserList(1);
		});

		$('#selectAll').unbind().on('click', function() {
			$('#showListTable :checkbox:gt(0)').prop('checked', $('#showListTable :checkbox:eq(0)').prop('checked'));
		});

		$("#BtnAddUser").unbind().bind('click', function(event) {
			me.execCommand('go', {a: 'business', b: 'useredit'});
			return false;
		});

		$('#BtnSetLevel').unbind().on('click', function() {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一个用户'); else showSetLevelDialog(id, 0);
			$(document).click();
			return false;
		});

		$('#BtnSetStatus1').unbind().on('click', function() {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一个用户'); else {
				//$.getJSON("/admin/user/usermanage?act=setstatus", utils.params({id: id, status: 1}), function(json) {
				$.getJSON("/index.php?c=admin/user/usermanage&a=setstatus", utils.params({id: id, status: 1}), function(json) {
					if(json.success) loadUserList(curpage); else {
					    $.showResult(false, json.msg);
					}
				});
			}
			$(document).click();
			return false;
		});

		$('#BtnSetStatus0').unbind().on('click', function() {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一个用户'); else {
				//$.getJSON("/admin/user/usermanage?act=setstatus", utils.params({id: id, status: 0}), function(json) {
				$.getJSON("/index.php?c=admin/user/usermanage&a=setstatus", utils.params({id: id, status: 0}), function(json) {
					if(json.success) loadUserList(curpage); else {
					    $.showResult(false, json.msg);
					}
				});
			}
			$(document).click();
			return false;
		});

		$('#BtnDelSelected').unbind().on('click', function() {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一个用户'); else {
				if(confirm("确认删除吗?")) {
					//$.getJSON("/admin/user/usermanage?act=delete", utils.params({'id': id}), function(json) {
					$.getJSON("/index.php?c=admin/user/usermanage&a=delete", utils.params({'id': id}), function(json) {
						if(json.success) {
							if(id.split(',').length >= itemcount) loadUserList(1); else loadUserList(curpage);
						} else {
						    $.showResult(false, json.msg);
						}
					});
				}
			}
			return false;
		});
		$('#ExportUserList').off('click').on('click', function() {
			ExportUserList();
		});
	}
	
	function getLoadingPanel() {
	    var html = '<div class="loadingPanel" style="width: 100%; height: 100%;position: absolute;top: 0;left: 0;opacity: 1;background: #F9F9F9;text-align: center;padding-top: 150px;">';
	    html += '<i class="fa fa-spinner fa-spin" style="font-size: 30px;margin-right: 20px;';
	    html += '"></i>正在加载。。。';
	    html += '</div>';
	    return html;
	}
	
	function loadFenXiaoInFo(userid){
		$('.fenxiaodialog').remove();
		$("#divFenXiaoInfo").dialog({
			width: 700, height: 420, resizable: true, modal: true,
			dialogClass:"fenxiaodialog",
			title: '分销详情',
			open: function (event, ui) {
			    $('.loadingPanel').remove();
			    // $('#divFenXiaoInfo').append(getLoadingPanel());
				//$.getJSON("/admin/business/tixianmanage?act=GetTiChengList", utils.params({OrderID: orderid}), function (json) {
				$.getJSON("/index.php?c=admin/user/usermanage&a=GetChildLevel", utils.params({UserID: userid}), function (json) {
					vmlevel = new ViewModelLevel();
					vmlevel.setData(json);
					ko.applyBindings(vmlevel,$("#divFenXiaoInfo")[0]);		
					bindGridEvent();
					$('.loadingPanel').remove();
				});
			},
			close: function (event, ui) {
				$(this).dialog("close");
			}
		});
	}
	

	function bindGridEvent() {
		$("*[name=BtnEdit]").unbind('click').bind('click', function(event) {
			// me.execCommand('go', {a: 'business', b: 'useredit', params: {id: $(this).attr("UserID")}});
			var searchParamsStr = JSON.stringify(searchParams);
	        searchParamsStr = encodeURIComponent(searchParamsStr);
	        me.execCommand('go', { a: 'business', b: 'useredit', params: { id: $(this).attr("UserID"), searchParams: searchParamsStr } });
			return false;
		});
		$('a[href="#business.orderlist"]').off().on('click', function(event){
			
			var searchParams = { sid: '', TimeBegin: '', TimeEnd: '', keyword: $(this).attr("keyword"), status: '', orderby: '', timetype: '', page: 1, pagesize: 20 ,store_uid: '' };
			var searchParamsStr = JSON.stringify(searchParams);
			searchParamsStr = encodeURIComponent(searchParamsStr);
			me.execCommand('go', {a: 'business', b: 'orderlist', params: {searchParams: searchParamsStr}});
			return false;
		});

		$("*[name=BtnDel]").unbind('click').bind('click', function(event) {
			if(!confirm("确认删除？")) return false;
			//$.getJSON("/admin/user/usermanage?act=Delete", utils.params({id: $(this).attr("UserID")}), function(json) {
			$.getJSON("/index.php?c=admin/user/usermanage&a=Delete", utils.params({id: $(this).attr("UserID")}), function(json) {
				if(json.success) {
					if(itemcount > 1) loadUserList(curpage); else loadUserList(1);
				} else {
					$.showResult(false, json.msg);
				}
			});
			return false;
		});

		$("*[name=BtnSetActive]").unbind('click').bind('click', function(event) {
			//$.getJSON("/admin/user/usermanage?act=setstatus", utils.params({
			$.getJSON("/index.php?c=admin/user/usermanage&a=setstatus", utils.params({
				id: $(this).attr("UserID"),
				status: 1
			}), function(json) {
				if(json.success) {
					loadUserList(curpage);
				} else {
					$.showResult(false, json.msg);
				}
			});
			return false;
		});

		$("*[name=BtnSetLevel]").unbind('click').bind('click', function(event) {
			showSetLevelDialog($(this).attr("UserID"), $(this).attr("UserLevelID"));
			return false;
		});

		$("*[name=BtnAdminBuy]").unbind('click').bind('click', function(event) {
			showAdminBuyDialog($(this).attr("UserID"),$(this).attr("NickName"));
			return false;
		});
		
        $("*[name=BtnFenxiaoDetail]").unbind('click').bind('click', function (event) {
			loadFenXiaoInFo($(this).attr("UserID"));
			return false;
        });
		
		//console.log(me);
		if (me.hasLicensePerm('ENABLE_BUYFORUSER')) $("*[name=BtnAdminBuy]").show();
		if (me.hasLicensePerm('ENABLE_AGENT')) $("*[name=BtnFenxiaoDetail]").text('代理/分销详情');
		if (!me.hasLicensePerm('ENABLE_AGENT') && !me.hasLicensePerm('ENABLE_FENXIAO')) $("*[name=BtnFenxiaoDetail]").hide();
	}

	me.addListener('userlist', function(key, args) {
		args.addClass('row');
		initUI(args);
	});
}

		
﻿IWF.plugins['usermsgedit'] = function () {

    var me = this;
	
	var ViewModel = function() {
        this.setData = function (data) {
			for(var key in data){
				//this[key] = data[key];
				if (data[key] == null) {
			        this[key] = '';
		        } else {
		            this[key] = data[key];
		        }
			}
		};
		this.isSendType = function(sendType){
			alert(sendType + " -- " + this["SendType"] + " = " + (sendType == this["SendType"]));
			return sendType == this["SendType"];
		}
    };
	
	var vm = new ViewModel();
	var myroot = null;
	var mustUpload = true;
	function initUI(root) {
        root.children().remove();
        //if (!me.hasLicensePerm('ENABLE_SHOP')) {
        //    root.load("/index.php?c=admin/page/Versiontip&page=usermsgedit");
        //    return;
        //}
        root.loadHtmlTpl("plugins/businesspackage/html/usermsgedit.html",function() {
			
			$("#UserMsgEditForm").validate({
				   rules: {
					tbSendTitle: "required",
					tbSendContent: "required"
				},
				messages: {
					tbSendTitle: "请输入下载标题！",
					tbSendContent: "请输入详细介绍"
				},
				submitHandler: function (form) {
					submitForm();
					return false;
				}
			});

			$(".myEditSuccess").find(".close").unbind('click').click(function(){
				me.execCommand('go', { a: 'business', b: 'usermsglist' });
				return false;
			});

			$(".myAlertError").find(".close").unbind('click').click(function(){
				$("#divForm").show();
				$(".myAlertError").hide();
				return false;
			});

			$("#BtnSearchUser").unbind().click(function(){ loadUserList(1); });

			$("#BtnSelectUser").unbind().click(function(){
				loadUserList(1);
				$("#userListPanel").dialog({ resizable: false, title: "选择用户", modal: true, width: 400, height:500, position: ['center', 'middle'], close: function (event, ui) { $(this).remove("close"); },
					buttons: { "确定": function() { 
											var aTrs = $("#userListPanel").find('tr.UserSelected');
											var aIds = [];
											var aNames = [];
											aTrs.each(function () {
											    aIds.push($(this).attr('data-userguid'));
												aNames.push($(this).find('td').text());
											});
											$('#tbUsersStr').val(aNames.join(','));
											$('#tbUserIdsStr').val(aIds.join(','));
											$(this).dialog("close");
									   },
							   "取消": function() { $(this).dialog("close"); }
					}
				});
			});

			$("input[name='slSendType']").unbind().click(function(){
				var v = $("input[name='slSendType']:checked").val();
				$("#trUserLevel").hide();
				$("#trUserIds").hide();
				if(v == "1") $("#trUserLevel").show();
				if(v == "2") $("#trUserIds").show();
			});
			
			$('#saveBtn').floatSaveBtn();
			
			loadLevelList();
			myroot = root[0];
			if(me.currentModule.params && me.currentModule.params.id) loadUserMsg();
			else initUE();
		});
    }

	var levellist = null;
	function loadLevelList() {
		//$.ajax({ url: "/admin/user/userconfig?act=GetLevelList", async: false, dataType: "json", success: function (json) {
		$.ajax({ url: "/index.php?c=admin/user/userconfig&a=GetLevelList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					levellist = json.list;
					for(var i = 0;i < json.list.length;i++){
						$("#slUserLevel").append("<option value='"+ json.list[i].ID +"'>"+ json.list[i].LevelName +"</option>");
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}
	
	var ue = null;
	function initUE(){
		try{
			UE.getEditor('UserMsgEditor').destroy();
		}catch(e){}
		ue = UE.getEditor('UserMsgEditor');
	}

    function loadUserMsg() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        //$.getJSON("/admin/user/usermsg?act=GetInfo", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/user/usermsg&a=GetInfo", utils.params(params), function (json) {
            json.info.nicknames = json.nicknames;
			vm.setData(json.info);
			ko.applyBindings(vm,myroot);
			$("input[name='slSendType'][value="+ json.info.SendType +"]").prop("checked",true).click();
			initUE();
        });
    }

	function loadUserList(page) {
        var params = { sid: me.sid, keyword: $("#userkeyword").val(),page: page, pagesize: 20 };
        //$.getJSON("/admin/user/usermanage?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/user/usermanage&a=getlist", utils.params(params), function (json) {	
			var aList = json.list;
            var sHtml = '<tr style="background:#eee"><th>会员昵称</th></tr>';
            for (var i = 0; i < aList.length; i++) {
                sHtml += '<tr data-userid="' + aList[i].UserID + '" data-userguid="' + aList[i].UserGUID + '">';
                sHtml += '<td>' + aList[i].NickName + '</td>';
                sHtml += '</tr>';
            }
            $('#userListPanel table').html(sHtml);
            $('#userListPanel tr:gt(0)').on('mouseenter', function () {
                $(this).addClass('UserHover');
            }).on('mouseleave', function () {
                $(this).removeClass('UserHover');
            }).on('click', function () {
                $(this).toggleClass('UserSelected');
            });

            if (json.pagecount < 2) $("#userListPages").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#userListPages").pageNav(json.curpage, json.pagecount, 10, function (page) { loadUserList(page); });
                $("#userListPages").show();
            }
        });
    }

    function submitForm(form) {
		
		var html = ue.getContent();
		$('#tbSendContent').val(html);

		var paramsObj = $('#UserMsgEditForm').serializeObject();
		if (paramsObj.slSendType == "2") {
			if (paramsObj.tbUserIdsStr == '') {
				$.showResult('错误','请选择至少一个会员');
				return false;
			}
		}

		//$.post("/admin/user/usermsg?act=sendmsg", paramsObj, function (json, textStatus, jqXHR) {
		$.post("/index.php?c=admin/user/usermsg&a=sendmsg", paramsObj, function (json, textStatus, jqXHR) {
		    if (json.success) {
		        $.showResult(true, "修改成功", 1000, function () {
		            me.execCommand('go', { a: 'business', b: 'usermsglist' });
		        });
		    } else {
		        $.showResult(false, json.msg);
		    }
		},"json");
		return false;
    }

    me.addListener('usermsgedit', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['usermsglist'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.msglist = ko.observableArray();
        this.setData = function (data) { this.msglist(data); };
		this.getTime = function(time){
			return time.replace(/T/gi," ").replace(/(\.\d+)/,"");
		}
		this.getUserLevel = function(level){
			for(var i = 0;i < levellist.length;i++){
				if(levellist[i].ID == level) return levellist[i].LevelName;
			}
			return "会员等级";
		}
    };

	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
        //if (!me.hasLicensePerm('ENABLE_SHOP')) {
        //    root.load("/index.php?c=admin/page/Versiontip&page=usermsglist");
        //    return;
        //}
        root.loadHtmlTpl("plugins/businesspackage/html/usermsglist.html", function () {
            me.execCommand('initContentNav', root);
					$('li:contains(会员详情), li:contains(下级分销)').css('display', 'none');
			bindUIEvent();
			loadLevelList();
			ko.applyBindings(vm,root[0]);
			loadUserMsgList(1);
		});
    }

	var levellist = [];
	function loadLevelList() {
		//$.ajax({ url: "/admin/user/userconfig?act=GetLevelList", async: false, dataType: "json", success: function (json) {
		$.ajax({ url: "/index.php?c=admin/user/userconfig&a=GetLevelList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					levellist = json.list;
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}
	    
	var curpage = 1;
	var itemcount = 0;
    function loadUserMsgList(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(),sendType : $("#SendType").val(), page: page, pagesize: 20 };
        //$.getJSON("/admin/user/usermsg?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/user/usermsg&a=getlist", utils.params(params), function (json) {
            vm.setData(json.list);
			$('#selectAllUserMsg').prop("checked",false);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadUserMsgList(page); });
                $("#pagination").show();
            }

            bindGridEvent();
        });
    }	

	function getSelectedArtIDs(){
		var array = new Array();
		$("input[name=msgid]:checked").each(function(){
			array.push($(this).val());
		});
		var id = array.join(',');
		return id;
	}

	function bindUIEvent(){
		$("#BtnSearch").unbind().bind('click', function (event) {
			loadUserMsgList(1);
        });

		$('#selectAllUserMsg').unbind().on('click', function () {
			$('#showUserMsgListTable :checkbox:gt(0)').prop('checked', $('#showUserMsgListTable :checkbox:eq(0)').prop('checked'));
		});

		$("#BtnAddUserMsg").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'usermsgedit' });
			return false;
        });

		$('#BtnDelSelected').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一条记录');
			else{
				if(confirm("确认删除吗?")){
					//$.getJSON("/admin/user/usermsg?act=delete", utils.params({'id': id}), function (json) {
					$.getJSON("/index.php?c=admin/user/usermsg&a=delete", utils.params({'id': id}), function (json) {
						if(json.success){
							if(id.split(',').length >= itemcount) loadUserMsgList(1);
							else loadUserMsgList(curpage);
						}else{
						    $.showResult(false, json.msg);
						}
					});
				}
			}
			return false;
		});
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'usermsgedit', params: { id: $(this).attr("MsgID")} });
			return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			//$.getJSON("/admin/user/usermsg?act=Delete", utils.params({id:$(this).attr("MsgID")}), function (json) {
			$.getJSON("/index.php?c=admin/user/usermsg&a=Delete", utils.params({id:$(this).attr("MsgID")}), function (json) {
				if(json.success){
					if(itemcount > 1) loadUserMsgList(curpage);
					else loadUserMsgList(1);
				}else{
				    $.showResult(false, json.msg);
				}
			});
			return false;
        });
    }

    me.addListener('usermsglist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

IWF.plugins['usersubdist'] = function() {
	var me = this, ViewModel = function() {
		this.SubUserList = ko.observableArray();
		this.setData = function(data) { this.SubUserList(data); };
		this.getLevelName = function(levelid) {
			for(var i = 0; i < levellist.length; i++) {
				if(levellist[i].ID == levelid) {
					return levellist[i].LevelName;
				}
			}
			return "未分级";
		}
		this.getTime = function(time) {
			return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
		}
		this.getAgent = function(isagent) {
			return isagent == 1 ? " <font color='red'>代理</font>" : "";
		};
		this.getLogTime = function(time) {
			try {
				var parts = time.split("-");
				if(parseInt(parts[0]) < 2010) return "<font color='gray'>从未登录</font>";
			} catch(e) {}
			return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
		}
	}, vm = new ViewModel(), myroot = null, curpage = 1, itemcount = 0, levellist = null;

	function initUI(root) {
		myroot = root[0];
		root.children().remove();
		root.loadHtmlTpl("plugins/businesspackage/html/usersubdist.html", function() {
			me.execCommand('initContentNav', root);
			$('li:contains("下级分销")').addClass('active');
			$('li a:contains("会员详情"), li a:contains("下级分销")').attr('p', '{"id":"' + me.currentModule.params.id + '"}');
			bindUIEvent();
			loadUserLevel();
			ko.applyBindings(vm, root[0]);
			loadSubUserList(1);
		});
	}

	function bindUIEvent() {}
	function bindGridEvent() {
		$("*[name=BtnEdit]").unbind('click').bind('click', function(event) {
			me.execCommand('go', {a: 'business', b: 'useredit', params: {id: $(this).attr("UserID")}});
			return false;
		});

		$("*[name=BtnDel]").unbind('click').bind('click', function(event) {
			if(!confirm("确认删除？")) return false;
			$.getJSON("/index.php?c=admin/user/usermanage&a=Delete", utils.params({id: $(this).attr("UserID")}), function(json) {
				if(json.success) {
					if(itemcount > 1) loadUserList(curpage); else loadUserList(1);
				} else {
					$.showResult("出错啦", json.msg);
				}
			});
			return false;
		});

		$("*[name=BtnSetActive]").unbind('click').bind('click', function(event) {
			$.getJSON("/index.php?c=admin/user/usermanage&a=setstatus", utils.params({
				id: $(this).attr("UserID"),
				status: 1
			}), function(json) {
				if(json.success) {
					loadSubUserList(curpage);
				} else {
					$.showResult("出错啦", json.msg);
				}
			});
			return false;
		});

		$("*[name=BtnSetLevel]").unbind('click').bind('click', function(event) {
			showSetLevelDialog($(this).attr("UserID"), $(this).attr("UserLevelID"));
			return false;
		});
	}
	function loadUserLevel() {
		$("#levelid").children().remove();
		$("#levelid").append("<option value=''>--全部级别--</option>");
		$.ajax({
			url: "/index.php?c=admin/user/userconfig&a=GetLevelList", async: false, dataType: "json", success: function(json) {
				if(json.success) {
					levellist = json.list;
					for(var i = 0; i < json.list.length; i++) {
						$("#levelid").append("<option value='" + json.list[i].ID + "'>" + json.list[i].LevelName + "</option>");
					}
				} else {
					alert("出错了：" + json.msg);
				}
			}
		});
	}

	function loadSubUserList(Page) {
		$.getJSON("/index.php?c=admin/user/usermanage&a=getlist", utils.params({
			sid: me.sid,
			parentidequal: me.currentModule.params.id,
			page: Page,
			pagesize: 20
		}), function(json) {
			var OrderObject = {}, ParenObject = {};
			json.order && json.order[0] && (function() {
				for(var i = 0, j; j = json.order[i++];) {
					OrderObject[j['UserID']] = j;
				}
			})();
			json.parents && json.parents[0] && (function() {
				for(var i = 0, j; j = json.parents[i++];) {
					ParenObject[j['UserID']] = j;
				}
			})();
			json.list && json.list[0] && (function() {
				for(var i = 0, j; j = json.list[i++];) {
					j['TotalMoney'] = OrderObject[j['UserID']] ? OrderObject[j['UserID']]['Money'] : 0;
					j['TotalOrder'] = OrderObject[j['UserID']] ? OrderObject[j['UserID']]['OrderID'] : 0;
					j['ParentUser'] = ParenObject[j['ParentUserID']] ? ParenObject[j['ParentUserID']]['NickName'] : '(无)';
				}
			})();
			//con  sole.log(json.parents);
			//con  sole.log(OrderObject);
			//con  sole.log(json.order);
			//con  sole.log(json.list);
			vm.setData(json.list);
			$('#ParentUser').html(json.ParentUserName);
			curpage = json.curpage;
			itemcount = json.list ? json.list.length : 0;
			if(json.pagecount < 2) $("#pagination").hide(); else {
				//pageNav 方法定义在 /core/util.js 里
				$("#pagination").pageNav(json.curpage, json.pagecount, 10, function(page) { loadSubUserList(page); });
				$("#pagination").show();
			}
			bindGridEvent();
		});
	}
	me.addListener('usersubdist', function(key, args) {
		initUI(args);
	});
};
IWF.plugins['yifangyuan'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
        this.member_total = ko.observable('0');
        this.agent_total=ko.observable('0');

        this.option = ko.observableArray();
        this.setOption= function (data) { this.option(data); };
        this.setData = function (data) { this.list(data); };
		this.getTime = function (time) {
			try{
				return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
			}catch(e){
				console.log('load time error');
			}
		}
		this.getMoney = function (money) {
		    return Math.abs(money);
		}
    };
	var vm = new ViewModel();
	var vm2 = new ViewModel();
	var vm3 = new ViewModel();
	function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_SHOP')) {
            root.load("/index.php?c=admin/page/Versiontip&page=yifangyuan");
            return;
        }
        root.loadHtmlTpl("plugins/site"+getCookie('InitSiteID')+"/yifangyuan_addition.html", function () {
			
            bindUIEvent();
			ko.applyBindings(vm,$(".table-responsive")[0]);
			ko.applyBindings(vm3,$("#fstatus")[0]);
			loadmember();
			loadList(1);

		});
    }
	    
	var curpage = 1;
	var itemcount = 0;
    function loadList(page) {
        	var params = { sid: me.sid, keyword: $("#keyword").val(), fstatus: $("#fstatus").val(), page: page, pagesize: 20 ,start: $('#startTime').val() ,end:$('#endTime').val() };
        //$.getJSON("/admin/business/tixianmanage?act=GetTiChengCount", utils.params(params), function (json) {
        $.getJSON("/index.php?m=site"+getCookie('InitSiteID')+"&c=admin/staticsyifangyuan&a=getlist", utils.params(params), function (json) {
        	if(json.list){
				vm.setData(json.list);
				vm.member_total(json.member_total);
				vm.agent_total(json.agent_total);

				curpage = json.curpage;
				itemcount = json.list.length;
				if (json.pagecount < 2) $("#pagination").hide();
				else {
					//pageNav 方法定义在 /core/util.js 里
					$("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadList(page); });
					$("#pagination").show();
				}

				bindGridEvent();
			}
        	else
        	{
        		vm.setData('');
				vm.member_total(0);
				vm.agent_total(0);
				bindGridEvent();
        	}
        });
    }
    
//    function loadstatistics()
//    {
//    	// var params = { sid: me.sid, keyword: $("#keyword").val(), fstatus: $("#fstatus").val(), page: page, pagesize: 20 };
//    	$.getJSON("/index.php?m=site"+getCookie('InitSiteID')+"&c=admin/staticsyifangyuan&a=staticsfy", '' , function (json) {
//    		vm2.member_total(json.info.member_total);
//    		vm2.agent_total(json.info.agent_total);
//    		vm2.agent1_num(json.info.agent1_num);
//    		vm2.agent2_num(json.info.agent2_num);
//    		vm2.agent3_num(json.info.agent3_num);
//    	});
//    }
    
    function loadmember()
    {
    	$.getJSON("/index.php?m=site"+getCookie('InitSiteID')+"&c=admin/staticsyifangyuan&a=getoptions", '' , function (json) {
    		 vm3.setData(json.list);
    		 //json.list[0].value;
    	});

    }

	
	
	function bindUIEvent(){
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadList(1);
        });
		
		 $("#startTime").datepicker({
	            format: "yyyy/mm/dd",
	            defaultDate: "+1w",
	            changeMonth: true,
	            dateFormat: "yy/mm/dd",
	            language: "zh-CN",
	            orientation: "bottom auto",
	            showOptions: { direction: "down" },
	            onClose: function (selectedDate) {
	                $("#TimeEnd").datepicker("option", "minDate", selectedDate);
	            }
	        });

	        $("#endTime").datepicker({
	            format: "yyyy/mm/dd",
	            defaultDate: "+1w",
	            changeMonth: true,
	            dateFormat: "yy/mm/dd",
	            language: "zh-CN",
	            orientation: "bottom auto",
	            showOptions: { direction: "down" },
	            onClose: function (selectedDate) {
	                $("#TimeBegin").datepicker("option", "maxDate", selectedDate);
	            }
	        });
	}

    function bindGridEvent() {    
    	$("*[name=BtnUserEdit]").unbind('click').bind('click', function(event) {
			me.execCommand('go', {a: 'business', b: 'useredit', params: {id: $(this).attr("UserID")}});
			//$("#divFinanceList").dialog('destroy');
			return false;
		});
    	
        $("*[name=BtnDetail]").unbind('click').bind('click', function (event) {
			loadFinanceInfo($(this).attr("OrderID"));
			return false;
        });

		$("*[name=BtnReview]").unbind('click').bind('click', function (event) {
			review($(this).attr("OrderID"),91);
			return false;
        });

		$("*[name=BtnCancelReview]").unbind('click').bind('click', function (event) {
			review($(this).attr("OrderID"),0);
			return false;
        });
		
		$("*[name=BtnGoOrder]").unbind('click').bind('click', function (event) {
            me.execCommand('go', { a: 'business', b: 'orderedit', params: { id: $(this).attr("OrderID")} });
			return false;
        });
    }

    me.addListener('yifangyuan', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿
IWF.plugins['backuplist'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.backuplist = ko.observableArray();
        this.setData = function (data) { this.backuplist(data); };

		this.getTime = function(time){
			return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
		}
    };

	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
		if(!me.hasLicensePerm("HIDE_FREE_VERSION_HINT")){
			root.html("<h1>免费版本不支持此功能</h1>");
		}else{
			root.loadHtmlTpl("plugins/configpackage/html/backuplist.html", function () {
				//me.execCommand('initContentNav', root);
				ko.applyBindings(vm,root[0]);
				loadbackuplist(1);			
			});
		}
    }
    
	var curpage = 1;
	var itemcount = 0;
    function loadbackuplist(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(), type: $("#type").val(), page: page, pagesize: 20 };
        //$.getJSON("/admin/backuprestore?act=getlist", utils.params(params), function (json) {
		$.getJSON("/index.php?c=admin/config/backup&a=getlist", utils.params(params), function (json) {
            vm.setData(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 1) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadbackuplist(page); });
                $("#pagination").show();
            }

            bindGridEvent();
        });
    }

    function bindGridEvent() {
        $("*[name=BtnRestore]").unbind('click').bind('click', function (event) {
			var id = $(this).attr("BID");
			$("#BtnRestoreAct").unbind('click').bind('click',function(event){
				$("#restoreDialog").dialog("close");
				$.showResult("操作提示","正在处理，请稍候...");
				$.getJSON("/index.php?c=admin/config/backup&a=restore", utils.params({ id: id,type: $("*[name=restoreType]:checked").val()}), function (json) {
				//$.getJSON("/admin/backuprestore?act=Restore", utils.params({ id: id,type: $("*[name=restoreType]:checked").val()}), function (json) {
					if (!json.success) {
						$.showResult("出错啦",json.msg);
						return;
					}
					$.showResult("操作提示","还原成功",2000);
				});
			});
			$("#restoreDialog").dialog({
				width: 500, height: 260, resizable: false, modal: true
			});
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return;
			//$.getJSON("/admin/backuprestore?act=delete", utils.params({ id: $(this).attr("BID") }), function (json) {
			$.getJSON("/index.php?c=admin/config/backup&a=delete", utils.params({ id: $(this).attr("BID") }), function (json) {
			    if (!json.success) {
			        alert(json.msg);
			        return;
			    }
				if(itemcount > 1) loadbackuplist(curpage);
				else loadbackuplist(1);
			});
        });

		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadbackuplist(1);
        });

		$("#BtnBackup").unbind('click').bind('click', function (event) {
			$.showResult("操作提示","正在处理，请稍候...");
			//$.getJSON("/admin/backuprestore?act=Backup", utils.params({ id: $(this).attr("BID") }), function (json) {
			$.getJSON("/index.php?c=admin/config/backup&a=backup", utils.params({ id: $(this).attr("BID") }), function (json) {
			    if (!json.success) {
			        $.showResult("出错啦",json.msg);
			        return;
			    }
				$.showResult("操作提示","备份成功",2000);
				loadbackuplist(1);
			});
		});
    }

    me.addListener('backuplist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['bbsconfig'] = function () {
    var me = this;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/configpackage/html/bbsconfig.html", function () {
            me.execCommand('initContentNav', root);
			loadInfo();
			bindUIEvent();
		});
    }

    function loadInfo() {
		$.getJSON("/index.php?c=admin/config/bbsconfig&a=getInfo", null, function (json) {
			if(json.info){
				json.info.DiscuzStatus = parseInt(json.info.DiscuzStatus);
				ko.applyBindings(json.info,$('#BbsCfgForm')[0]);
				if(json.info.DiscuzStatus == 1){
					$('#tddownload').show();$('#tdline').show();
				}else{
					$('#tddownload').hide();$('#tdline').hide();
				}
			}
        });
    }

	function bindUIEvent(){
		$("#btnsave").unbind('click').click(function () {
			if($('#DiscuzStatus').prop('checked') && $('#DiscuzUrl').val() == ""){
				alert('请填写论坛的网址');
				return;
			}
			var params = $('#BbsCfgForm').serialize();
			$.post("/index.php?c=admin/config/bbsconfig&a=edit", params, function (data, textStatus, jqXHR) {
				if (data.success) {
					$.showResult(true, "保存成功", 1500);
					loadInfo();
				} else {
					$.showResult(false, data.msg);
				}
			}, "json");
		});
		$('#btnAddMenu').unbind('click').click(function () {
			me.execCommand('go', {a:'config',b:'editmenu',params:{'SiteType':getCookie('SiteType'),'LinkType':32}});
			return false;
		});
	}

    me.addListener('bbsconfig', function (key, args) {
		initUI(args);
    });
}

﻿
IWF.plugins['configlang'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
    };
	
	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_MULTI_LANGUAGE')) {
			root.load("/index.php?c=admin/page/Versiontip&page=configlang");
			return;
		}
        root.loadHtmlTpl("plugins/configpackage/html/configlang.html", function () {
            me.execCommand('initContentNav', root);
            
			ko.applyBindings(vm,root[0]);
			loadSiteList();
			bindUIEvent();
		});
    }

    function loadSiteList() {
        //$.getJSON("/admin/sitelangs?act=getlist", null, function (json) {
		$.getJSON("/index.php?c=admin/config/sitelangs&a=GetList", null, function (json) {
			vm.setData(json.list);
            bindGridEvent();
        });
    }

	function bindUIEvent(){
		$("#btnAddLang").unbind('click').click(
			function () {
				$("#AddLangDialog").css("display", "");
				$("#AddLangDialog").dialog({ resizable: false, title: '添加新语言', modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { } });
			}
		);

		$("#slLang").change(function () {
			if ($(this).val() == "") {
				$("#divCustomLang").css("display", "");
			} else {
				$("#divCustomLang").css("display", "none");
			}
		});

		$("#btnAddLangSubmit").unbind('click').click(function () {
			if ($("#slLang").val() == "0") {
				alert("请选择语言");
				return;
			}
			if ($("#slLang").val() == "" && $("#txLangName").val().trim() == "") {
				alert("请填写语言名称");
				return;
			}

			var Lang = $("#slLang").val();
			var LangName = $("#slLang").find("option:selected").text();
			if (Lang == "") LangName = $("#txLangName").val();
			var xmlhttp = $.ajax({
				type: "POST",
				//url: "/admin/sitelangs",
				//data: { "act": "AddSite", "NewLang": Lang, "NewLangName": LangName },
				url : "/index.php?c=admin/config/sitelangs&a=AddSite",
				data: { "NewLang": Lang, "NewLangName": LangName },
				dataType: "json",
				contentType: "application/x-www-form-urlencoded; charset=UTF-8",
				cache: false, async: true,
				beforeSend: function () {
					$("#AddLangDialog").dialog("close");
					showResult("提示信息", "正在处理，请稍候...");
				},
				success: function (data) {
					$("#ResultDialog").dialog("close");
					if (data.success) {
						loadSiteList();
					} else {
						showResult("提示信息", "语言添加失败：" + data.msg);
					}
				},
				error: function (request, status, error) {
					$("#ResultDialog").dialog("close");
					var msg = request.responseText;
					showResult("提示信息", "语言添加失败：" + msg);
				}
			});
		});
	}

	function bindGridEvent() {
		$("*[name='btnDel']").unbind('click').click(function () {
			if (confirm("网站删除后不可恢复，确定吗？")) {
				var xmlhttp = $.ajax({
					type: "POST",
					//url: "/admin/sitelangs",
					url : "/index.php?c=admin/config/sitelangs&a=delete",
					data: { "act": "Delete", "SiteID": $(this).attr("SiteID") },
					dataType: "json",
					contentType: "application/x-www-form-urlencoded; charset=UTF-8",
					cache: false, async: true,
					beforeSend: function () {
						$("#divCopyTo").remove();
						showResult("提示信息", "正在处理，请稍候...");
					},
					success: function (data) {
						$("#ResultDialog").dialog("close");
						if (data.success) {
							loadSiteList();
						}
						else showResult("提示信息", "删除失败：" + data.msg);
					},
					error: function (request, status, error) {
						$("#ResultDialog").dialog("close");
						var msg = request.responseText;
						showResult("提示信息", "删除失败：" + msg);
					}
				});
			}
			return false;
		});

		$("*[name='btnCopyTo']").unbind('click').click(function () {
			var srcSiteID = $(this).attr("SiteID");
			$("#divCopyTo").remove();
			var html = "<div id='divCopyTo' style='padding:10px;text-align:center;'></div>";
			$("body").append(html);
			var select = "复制到：<select id='slCopyTo'>";
			var has = false;
			$("*[name='spSiteInfo']").each(function (j, bobj) {
				if (srcSiteID != $(bobj).attr("SiteID")) {
					select += "<option value='" + $(bobj).attr("SiteID") + "'>" + $(bobj).html() + "</option>";
					has = true;
				}
			});
			select += "</select>";
			if (has) {
			    select += "<br><span style='color:red;font-weight:bold;'>复制站点会将目标站点全部数据清空（包括PC站，微站的数据，包括产品、新闻、前台模块的数据）</span>";
			    select += "<br><input type='button' id='btnCopySubmit' value='复制'>";
				$("#divCopyTo").html(select);
				$("#btnCopySubmit").unbind('click').click(function () {
					if (confirm("将删除 " + $("#slCopyTo").find("option:selected").text() + " 这个站点的电脑、微站数据重新初始化，确定吗？")) {
						var xmlhttp = $.ajax({
							type: "POST",
							//url: "/admin/sitelangs",
							url: "/index.php?c=admin/config/sitelangs&a=CopySite",
							data: { "act": "CopySite", "srcSiteID": srcSiteID, "dstSiteID": $("#slCopyTo").val() },
							dataType: "json",
							contentType: "application/x-www-form-urlencoded; charset=UTF-8",
							cache: false, async: true,
							beforeSend: function () {
								$("#divCopyTo").remove();
								showResult("提示信息", "正在处理，请稍候...");
							},
							success: function (data) {
								$("#ResultDialog").dialog("close");
								if (data.success) showResult("提示信息", "复制成功");
								else showResult("提示信息", "复制失败：" + data.msg);
							},
							error: function (request, status, error) {
								$("#ResultDialog").dialog("close");
								var msg = request.responseText;
								showResult("提示信息", "复制失败：" + msg);
							}
						});
					}
				});
			} else {
				$("#divCopyTo").html("您没有开启其它语言版本");
			}
			$("#divCopyTo").dialog({ resizable: false, title: "复制网站", modal: true, width: 400, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
			return false;
		});

		$("*[name='cbStatus']").unbind('click').click(function () {
			var Status = $(this).get(0).checked ? "1" : "0";
			var SiteID = $(this).val();
			var xmlhttp = $.ajax({
				type: "POST",
				//url: "/admin/sitelangs",
				url : "/index.php?c=admin/config/sitelangs&a=ChangeStatus",
				data: { "act": "ChangeStatus", "Status": Status, "SiteID": SiteID },
				dataType: "json",
				contentType: "application/x-www-form-urlencoded; charset=UTF-8",
				cache: false, async: true,
				success: function (msg) {
					
				},
				error: function (request, status, error) {
					var msg = request.responseText;
					showResult("提示信息", "设置失败：" + msg);
				}
			});
		});

		$("*[name='btnSetDefault']").unbind('click').click(function () {
			var Status = $(this).get(0).checked ? "1" : "0";
			var SiteID = $(this).attr("SiteID");
			var xmlhttp = $.ajax({
				type: "POST",
				//url: "/admin/sitelangs",
				url : "/index.php?c=admin/config/sitelangs&a=SetDefault",
				data: { "act": "SetDefault", "SiteID": SiteID },
				dataType: "json",
				contentType: "application/x-www-form-urlencoded; charset=UTF-8",
				cache: false, async: true,
				success: function (data) {
					if (data.success) loadSiteList();
					else showResult("提示信息", "复制失败：" + data.msg);
				},
				error: function (request, status, error) {
					var msg = request.responseText;
					showResult("提示信息", "设置失败：" + msg);
				}
			});

			return false;
		});
	}

	function showResult(title,msg) {
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
	}

    me.addListener('configlang', function (key, args) {
		initUI(args);
    });
}

﻿
IWF.plugins['configmenu'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
		this.array = [];
        this.setData = function (data) { this.array = data; this.list(data); };
		this.getSublist = function(parentid){
			var ret = [];
			for(var i = 0;i < this.array.length;i++){
				if(this.array[i].ParentID == parentid) ret.push(this.array[i]);
			}
			return ret;
		};
		this.getCurrentSiteType = function(){
			var t = parseInt($('#SiteType').val());
			if(t == 0) $(".TMenu8").show();
			else $(".TMenu8").hide();
			return t;
		}
    };
	
	var vm = new ViewModel();
	function initUI(root) {
        root.empty();
        root.loadHtmlTpl("plugins/configpackage/html/configmenu.html?v=" + Math.random(), function () {
            me.execCommand('initContentNav', root);
			ko.applyBindings(vm,root[0]);
			bindUIEvent();
			$("#mMobile").hide();

			var curSiteType = 0;
			if (me.currentModule.params) {
			    if (me.currentModule.params.SiteType == 1) {
			        curSiteType = 1;
			    }
			} else {
			    curSiteType = getCookie('SiteType');
			}

			$('#SiteType').val(curSiteType);
			if (curSiteType == 1) {
			    $("#mMobile").click();
			    $("#mPC").hide();
			} else {
			    $("#mPC").click();
			    $("#mMobile").hide();
			}

			if (!me.currentModule.params) {
			    loadMenuList();
			}
		});
    }

    function loadMenuList() {
        //$.getJSON("/admin/sitemenu?act=getlist", null, function (json) {
    	$.getJSON("/index.php?c=admin/config/sitemenu&a=getlist", null, function (json) {
			if(json.success){
				vm.setData(json.list);
				bindGridEvent();
			}else{
				alert("出错了：" + json.msg);
			}
        });
    }

	function bindUIEvent(){
		$("#mPC").unbind('click').bind("click",function(){
			$(this).attr("class","titleOn");
			$("#mMobile").attr("class","title");
			$('#SiteType').val(0);
			loadMenuList();
		});

		$("#mMobile").unbind('click').bind("click",function(){
			$(this).attr("class","titleOn");
			$("#mPC").attr("class","title");
			$('#SiteType').val(1);
			loadMenuList();
		});

		$("#BtnAddMenu").unbind('click').bind("click",function(){
			me.execCommand('go', { a: 'config', b: 'editmenu', params: { SiteType: $('#SiteType').val()} });
		});
	}

	function bindGridEvent() {
		$(".Tables").disableSelection();
		$(".sortUl").sortable({
			handle: ".TMenu0",
			start: function (event, ui) {
				ui.item.css({ "border": "solid 1px red" });
			},
			update: function (event, ui) {

				var orders = new String();
				$(this).find(".MoveItem").each(function (i) {
					orders += $(this).attr("value") + "-" + i + ",";
				});
				$.ajax({
					type: "POST",
					dataType: 'json',
					//url: '/admin/sitemenu',
					url: '/index.php?c=admin/config/Sitemenu&a=MoveOrder',
					//data: { act: "MoveOrder", Order: orders },
					data: { Order: orders },
					success: function (json) {
						if(json.success) loadMenuList();
						else alert("出错了：" + json.msg);
					},
					error: function (XMLHttpRequest, textStatus, errorThrown) {
						alert("系统出错了." + errorThrown);
					}
				});
			}, stop: function (event, ui) {
				ui.item.css({ "border": "0" });
			}
		});

		$(".SubTable").sortable({
			handle: ".SubHandle",
			start: function (event, ui) {
				ui.item.css({ "border": "solid 1px red" });
			},
			update: function (event, ui) {
				
				var orders = new String();
				$(this).find(".SubHandle").each(function (i) {
					orders += $(this).attr("value") + "-" + i + ",";
				});
				$.ajax({
					type: "POST",
					dataType: 'json',
					//url: '/admin/sitemenu',
					url: '/index.php?c=admin/config/Sitemenu&a=MoveOrder',
					//data: { act: "MoveOrder", Order: orders },
					data: { Order: orders },
					success: function (json) { 
						if(json.success) loadMenuList();
						else alert("出错了：" + json.msg);
					},
					error: function (XMLHttpRequest, textStatus, errorThrown) {
						alert("系统出错了.");
					}
				});
			}, stop: function (event, ui) {
				ui.item.css({ "border": "0", "border-bottom": "solid 1px #ccc" });
			}
		});

		$("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            me.execCommand('go', { a: 'config', b: 'editmenu', params: { MenuID: $(this).attr("MenuID")} });
        });

		$("*[name=BtnAddSub]").unbind('click').bind("click",function(){
			me.execCommand('go', { a: 'config', b: 'editmenu', params: { ParentID: $(this).attr("ParentID"), SiteType: $('#SiteType').val()} });
		});

		$("*[name=BtnDel]").unbind('click').bind("click",function(){
			if(!confirm("确认删除？")) return;
			//$.getJSON("/admin/sitemenu?act=delmenu", utils.params({MenuID:$(this).attr("MenuID")}), function (json) {
			$.getJSON("/index.php?c=admin/config/Sitemenu&a=delmenu", utils.params({MenuID:$(this).attr("MenuID")}), function (json) {
				loadMenuList();
			});
		});
		
		$("img[name=ImgIcon]").each(function(i,item){
			if(!$(item).attr("src")) $(item).hide();
		});
	}

    me.addListener('configmenu', function (key, args) {
		initUI(args);
    });
}

﻿
IWF.plugins['configrewrite'] = function () {

    var me = this;
	
	var ViewModel = function () {
	    this.list = ko.observableArray();
	    this.prefix = ko.observable();
		this.index = 0;
		this.getIndex = function(){
			return ++this.index;
		}
    };
	
	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/configpackage/html/configrewrite.html?v=" + Math.random(),function() {			
            me.execCommand('initContentNav', root);
			$("#RewriteForm").validate({
				submitHandler: function (form) {
					submitForm();
					return false;
				}
			});
			
			ko.applyBindings(vm,root[0]);
			bindUIEvent();
			$('#BtnSave').floatSaveBtn();
			loadRewriteList();
		});
    }

    function loadRewriteList() {
        $.getJSON("/index.php?c=admin/config/siterewrite&a=getlist", null, function (json) {
			if(json.success){
				vm.index = 0;
				vm.list(json.list);
				vm.prefix(json.prefix);
			} else {
			    $.showResult(false, json.msg);
			}
        });
    }

	function bindUIEvent(){
	}
	
	function submitForm(){
		var params = $('#RewriteForm').serialize();
		$.post("/index.php?c=admin/config/siterewrite&a=save", params, function (data, textStatus, jqXHR) {
		    if (data.success) {
		        $.showResult(true, "设置已保存", 2000, function () {
		            loadRewriteList();
		        });
		    } else {
		        $.showResult(false, data.msg);
		    }
		},"json");
	}

    me.addListener('configrewrite', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['configsite'] = function () {

	var me = this;
	utils.addScript("/framework/ref/scripts/jquery-validator-method.js");
	utils.addScript("/framework/ref/scripts/jquery.class.js");
	utils.addScript("/framework/ref/scripts/jquery.city.js");

	var myroot = null;
	var hasAutoClosePC = false;
	function initUI(root) {
	    root.children().remove();
        root.loadHtmlTpl("plugins/configpackage/html/configsite.html?v=" + Math.random(),function() {
            me.execCommand('initContentNav', root);
			hasAutoClosePC = false;
            $.validator.addMethod("checkDomain", function (value, element) {
                var DomainName = $('#DomainName').val().replace(/(^,*)|,*$/g, '');
                var aDomainName = DomainName.split(',');
                var DomainMobile = $('#DomainMobile').val().replace(/(^,*)|,*$/g, '');
                var aDomainMobile = DomainMobile.split(',');

                var flag = true;
                for (var i = 0; i < aDomainName.length; i++) {
                    for (var j = 0; j < aDomainMobile.length; j++) {
                        if (aDomainName[i] == aDomainMobile[j]) {
                            flag = false;
                        }
                    }
                }
                return this.optional(element) || flag;
            }, "必须是数字");

			$("#AdminForm").validate({
				invalidHandler: function () { $(".error").removeClass("gray"); },
                ignore: "",
                rules: {
                    tbSiteName: "required",
                    tbCompany: "required",
                    tbContact: "required",
                    tbAddress: "required",
                    province: "required",
                    city: "required",
                    DomainMobile: { checkDomain: true },
                    tbTel: "required"
                    /*
                    tbSmtpServer: "required",
                    tbSmtpUser: "required",
                    tbSmtpPass: "required",
                    tbSmtpMail: "required"
                    */
                },
                messages: {
                    tbSiteName: "请输入网站名称！",
                    tbCompany: "请输入企业名称！",
                    tbContact: "请输入联系人！",
                    tbAddress: "请输入公司地址！",
                    province: "请选择所在省份！",
                    city: "请选择所在城市！",
                    DomainMobile: { checkDomain: "微站域名不能含有与电脑站相同的域名！" },
                    tbTel: "请输入联系电话！",
                    tbSmtpServer: "请输入邮箱服务器！",
                    tbSmtpUser: "请输入邮箱帐号！",
                    tbSmtpPass: "请输入邮箱密码！",
                    tbSmtpMail: "请输入发信邮箱！"
                },
				submitHandler: function (form) {
					submitForm();
					return false;
				}
			});
			$('.ResetPassword').off("click").on("click", function () {
			    $('.MailBody').dialog({
			        resizable: false,
			        modal: true,
			        title: '取回密码内容邮件内容',
			        close: function () {
			            $(this).dialog( "destroy" )
			        }
			    });
			});

			$("#BtnTestMail").unbind('click').bind("click",function(){ TestMail($("#AdminForm").get(0)) });

			$("#slWelCome").unbind('click').bind("change",function(){ 
				if($(this).val() == "1") $("#LiteralWelCome").html("启用需要编辑网站欢迎首页<a href='../../home/welcome' style='color:Red;' target='_blank'>【编辑欢迎页】</a>");
				else $("#LiteralWelCome").html('');
			});
			
			if(me.hasPerm("SysAdm") || me.hasPerm("SiteAdm")){
				$("#trWelCom").show();
			}

			if (!me.hasLicensePerm('ENABLE_WAP') || !me.hasLicensePerm('ENABLE_SET_DOMAIN_NAME')) {
			    $('#DomainMobile').closest('tr').remove();
			    //$('#AutoVisitMobile').closest('tr').hide();
			    //$('#LiteralMobile').html("<b>当前版本不支持此功能，请升级至高版本！</b>");
			}

			$('#AutoVisitMobile').change(function(){
				if(me.loginUser.fIDProd == '3120'){
					if($(this).val() == '1' && !hasAutoClosePC){
						$('#EnablePCVisit').val('0');
						hasAutoClosePC = true;
					}
				}
			});

			if (!me.hasPerm('SysAdm')) {
			    $('#admincontrolinfo').remove();
			    $('#domaininfo').remove();
			} else {
			    $('#admincontrolinfo').show();
			    $('#domaininfo').show();
			}

			$('#simplenav').simpleAnchorNav();
			$('#btnPost').floatSaveBtn();

			myroot = root[0];
			loadInfo();	  
			$("#switch-state").not("[data-switch-no-init]").bootstrapSwitch();
			$('#switch-state').on('switchChange.bootstrapSwitch',function  (event,state) {
				if (state == true) {
				    $("#sitemailinfo").css("display","block");
				}else{
				    $("#sitemailinfo").css("display","none");
				};
			})
		});
    }

	function TestMail(form) {
		form.tbSmtpServer.value = trim(form.tbSmtpServer.value);
		form.tbSmtpUser.value = trim(form.tbSmtpUser.value);
		form.tbSmtpPass.value = trim(form.tbSmtpPass.value);
		form.tbSmtpMail.value = trim(form.tbSmtpMail.value);
		if (form.tbSmtpServer.value == "") {
			alert("邮箱服务器不能为空");
			form.tbSmtpServer.focus();
			return;
		}
		if (form.tbSmtpUser.value == "") {
			alert("邮箱用户不能为空");
			form.tbSmtpUser.focus();
			return;
		}
		if (form.tbSmtpPass.value == "") {
			alert("邮箱密码不能为空");
			form.tbSmtpPass.focus();
			return;
		}
		if (form.tbSmtpMail.value == "") {
			alert("发信邮箱不能为空");
			form.tbSmtpMail.focus();
			return;
		}
		var url = "/index.php?c=admin/config/siteconfig&a=testmail&SysSmtpServer=" + form.tbSmtpServer.value;
		url += "&SysSmtpUser=" + form.tbSmtpUser.value;
		url += "&SysSmtpPass=" + form.tbSmtpPass.value;
		url += "&SysSmtpFrom=" + form.tbSmtpMail.value;
		$("body").append("<div id='divTestMailDialog' style='background:#fff;'>正在测试，请稍候...</div>");
		$("#divTestMailDialog").dialog({ resizable: false, title: '邮箱测试结果', modal: true, width: 300,position: ['center', 'middle'],close: function (event, ui) { $(this).remove(); } });
		$.getJSON(url, null, function (json) {
			$("#divTestMailDialog").html(json.msg);
        });
	}

	function trim(input) {
		input = input.replace(/ /gi, "");
		return input;
	}

    function loadInfo() {
    	$.getJSON("/index.php?c=admin/config/siteconfig&a=getinfo", null, function (json) {
			ko.applyBindings(json.info,myroot);
			
			$("#PClass").Class(parseInt(json.info.UserInfo.Class1) || 0, "");
			$("#City").City(json.info.UserInfo.Pid || 0, json.info.UserInfo.Cid || 0);
			$("#sClass").remove();
			$("#fClass option:first-child").text("-=请选择所属行业=-");
			$("#fClass").addClass("form-control").css("width",200);
			$("#province").addClass("form-control").css({"width":110,"display":"inline"});
			$("#city").addClass("form-control").css({"width":110,"display":"inline"});

			$("#sitemailinfo").find("input[type='text']").each(function  () {
	            if ($(this).val() != "") {
	                $('#switch-state').bootstrapSwitch('state', true);  
	            }
        	})
        });

    }

    function submitForm() {
        var params = $('#AdminForm').serialize();
        $.post("/index.php?c=admin/config/siteconfig&a=edit",params,function(data, textStatus, jqXHR){
		    if (data.success) {
		        $.showResult(true, "保存成功", 1500);
		    } else {
		        $.showResult(false, data.msg);
		    }
		},"json");
    }

    me.addListener('configsite', function (key, args) {
		initUI(args);
    });	
}
﻿
IWF.plugins['editadmin'] = function () {

    var me = this;

    var ViewModel = function () {
        this.UserName = ko.observable('');
        this.RealName = ko.observable('');
        this.Status = ko.observable();
        this.AdminID = ko.observable('');
        this.Perms = ko.observableArray([]);
        this.setData = function (data) {
            for (var key in data) {
                if (typeof (data[key]) == "object") this[key] = ko.observableArray(data[key]);
                else this[key] = ko.observable(data[key]);
            }
        };
        this.hasPerm = function (a) {
            alert(this["Perms"]);
        }
    };

    var vm = null;
    var myroot = null;
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/configpackage/html/editadmin.html?v=" + Math.random(), function () {
            me.execCommand('initContentNav', root);
            myroot = root[0];
            vm = new ViewModel();
           
            if (me.hasPerm("SysAdm")) {
                $('#permsPanel').show();
                loadCommonPerms();
            } else if (!me.hasPerm("SysAdm") && me.hasPerm("SiteAdm")) {
                $('#rolelist, #trSysAdm, #trSiteAdm').remove();
                $('[group=NormalAdm]').prop('disabled', false);
                $('#permsPanel').show();
            }

            if (!me.hasLicensePerm('ENABLE_SHOP')) {
                $('#OrderAdm').closest('tr').remove();
                $('#FinanceAdm').closest('tr').remove();
            } else {
                $('#OrderAdm').closest('tr').show();
                $('#FinanceAdm').closest('tr').show();
            }

            if (!me.hasLicensePerm('ENABLE_FENXIAO')) {
                $('#FenXiaoAdm').closest('tr').remove();
            } else {
                $('#FenXiaoAdm').closest('tr').show();
            }

            if (!me.hasLicensePerm('ENABLE_WEIXIN')) {
                $('#WxAdm').closest('tr').remove();
                $('#WyxAdm').closest('tr').remove();
            } else {
                $('#WxAdm').closest('tr').show();
                $('#WyxAdm').closest('tr').show();
            }

			if (!me.hasLicensePerm('ENABLE_AGENT')){
				$('#StoreAdm').closest('tr').remove();
			}else {
				$('#StoreAdm').closest('tr').show();
			}

            if (!me.hasPerm('AppAdm')) {
                $('#AppAdm').closest('tr').remove();
            } else {
                $('#AppAdm').closest('tr').show();
            }

            if (!me.hasPerm('WyxAdm')) {
                $('#WyxAdm').closest('tr').remove();
            } else {
                $('#WyxAdm').closest('tr').show();
            }

            $("#AdminForm").validate({
                rules: {
                    tbUserName: { required: true },
                    tbRealName: "required",
                    tbPassC: { equalTo: "#tbPass" }
                },
                messages: {
                    tbUserName: { required: "请输入用户名！" },
                    tbRealName: "请输入姓名！",
                    tbPassC: { equalTo: "两次密码不一致！" }
                },
                submitHandler: function (form) {
                    submitForm();
                    return false;
                }
            });

            $('#BtnSubmit').floatSaveBtn();

            $('#permlist tr>td:nth-child(1), #permlist tr>td:nth-child(1)').each(function () {
                return false;
            });

            $('#permlist tr').each(function () {
                $(this).children('td:lt(2)').on('selectstart', function () {
                    return false;
                });
            });

            $('[name=adminType]').off().on('change', function () {
                if (this.value == 1) {
                    var perms = [];
                    $('[parent=SiteAdm], [group=NormalAdm], #SiteAdm, #SysAdm').each(function (i) {
                        perms.push(this.value);
                        $(this).prop('disabled', true);
                    });
                    vm.Perms(perms);
                } else if (this.value == 2) {
                    var perms = [];
                    $('[parent=SiteAdm], [group=NormalAdm], #SiteAdm').each(function (i) {
                        perms.push(this.value);
                        $(this).prop('disabled', true);
                    });
                    vm.Perms(perms);
                } else if (this.value == 3) {
                    $('#SiteAdm, #SysAdm').prop('disabled', true);
                    $('[group=NormalAdm]').prop('disabled', false);
                    var perms = vm.Perms();
                    for (var i = 0; i < perms.length; i++) {
                        if (perms[i] == 'SysAdm' || perms[i] == 'SiteAdm') {
                            perms.splice(i--, 1);
                        }
                    }
                    vm.Perms(perms);
                }
            });

            if (me.currentModule.params && me.currentModule.params.id) loadAdmin();
            else ko.applyBindings(vm, myroot);
        });
    }

    function loadAdmin() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        //$.getJSON("/admin/adminmanage?act=getinfo", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/config/adminmanage&a=getinfo", utils.params(params), function (json) {
            if (json.info.Perms) json.info.Perms = json.info.Perms.split(",");
            else json.info.Perms = [];
            vm.setData(json.info);
            if ($.inArray('SysAdm', json.info.Perms) > -1) {
                $('[name=adminType][value=1]').click();
            } else if ($.inArray('SysAdm', json.info.Perms) == -1 && $.inArray('SiteAdm', json.info.Perms) > -1) {
                $('[name=adminType][value=2]').click();
            } else {
                $('[name=adminType][value=3]').click();
            }
            ko.applyBindings(vm, myroot);
        });
    }

    function loadCommonPerms() {
        $.ajax({
            type: 'get',
            //url: '/admin/adminmanage?act=getcommonperms',
            url: '/index.php?c=admin/config/adminmanage&a=getcommonperms',
            data: {},
            async: false,
            cache: false,
            dataType: 'json',
            success: function (json) {
                if (json.info.ShowApp == 1) $('#AppAdm').show();
                else $('#AppAdm').remove();

                if (json.info.ShowWyx == 1) $('#WyxAdm').show();
                else $('#WyxAdm').remove();
            }
        })
    }

    function submitForm() {
        var params = $('#AdminForm').serializeObject();
        var perms = "";
        $('[name=cbPerm]:checked').each(function () {
            perms += this.value + ',';
        });
        params.cbPerm = perms;

        //$.post("/admin/adminmanage?act=edit", params, function (data, textStatus, jqXHR) {
        $.post("/index.php?c=admin/config/adminmanage&a=edit", params, function (data, textStatus, jqXHR) {
            if (data.success) {
                $.showResult(true, "保存成功", 1500, function () {
                    me.execCommand('go', { a: 'config', b: 'listadmin' });
                });
            } else {
                $.showResult(false, data.msg);
            }
        }, "json");
    }

    me.addListener('editadmin', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['editlink'] = function () {

    var me = this;
	
	var ViewModel = function() {
		this.info = {};
		this.getLogo = function(linkInfo) {
			if(linkInfo.Logo){
				var path = "../comdata/"+ linkInfo.SiteID +"/links/" + linkInfo.Logo + "?" + Math.random();
				return "<img src='"+ path +"'>";
			}
		};
    };
	
	var vm = new ViewModel();
	var myroot = null;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/configpackage/html/editlink.html",function() {

			$("#EditLinkForm").validate({
				rules: {
					tbName: "required",
					tbUrl: "required"
				},
				messages: {
					tbName: { required: "请输入链接名称" },
					tbUrl: { required: "请输入链接地址" }
				},
				submitHandler: function (form) {
					submitForm(form);
					return false;
				}
			});

			$(".myAlertSuccess").find(".close").unbind('click').click(function(){
				me.execCommand('go', { a: 'config', b: 'friendlinks' });
				return false;
			});

			$(".myAlertError").find(".close").unbind('click').click(function(){
				$("#divForm").show();
				$(".myAlertError").hide();
				return false;
			});

			myroot = root[0];
			if(me.currentModule.params && me.currentModule.params.LinkID) loadLinkInfo();
		});
    }

    function loadLinkInfo() {
        var params = { sid: me.sid, LinkID: me.currentModule.params.LinkID };
        //$.getJSON("/admin/friendlinks?act=getinfo", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/config/friendlinks&a=getinfo", utils.params(params), function (json) {
			vm.info = json.info;
			$("#LinkImg").html(vm.getLogo(json.info));
			ko.applyBindings(vm,myroot);
        });
    }

	function ajaxFileUpload(params) {
		$.ajaxFileUpload
		(
			{
				//url: '/admin/friendlinks?act=edit', //用于文件上传的服务器端请求地址
				url: '/index.php?c=admin/config/friendlinks&a=edit', //用于文件上传的服务器端请求地址
				secureuri: false, //是否需要安全协议，一般设置为false
				fileElementId: 'tbLogoFile', //文件上传域的ID
				dataType: 'json', //返回值类型 一般设置为json
				data: params,
				success: function (data, status)  //服务器成功响应处理函数
				{
					if(data.success){
					    $(".myAlertSuccess").css({
					        opacity: 1,
					        top: ($(window).outerHeight() - $(".myAlertSuccess").outerHeight()) / 2 + 'px',
					        left: ($(window).outerWidth() - $(".myAlertSuccess").outerWidth()) / 2 + 'px',
					        position: 'fixed',
					        width: 'auto',
					        height: 'auto'
					    });
					    $(".myAlertSuccess").slideToggle(500);
					    //$("#divForm").hide();
					    $(".myAlertError").hide();
					    setTimeout(function () {
					        $(".myAlertSuccess").find(".close").click();
					    }, 1500);
					}else{
					    $(".myAlertError").css('display', 'inline-block');
					    $(".myAlertError").css({
					        opacity: 1,
					        top: ($(window).outerHeight() - $(".myAlertError").outerHeight()) / 2 + 'px',
					        left: ($(window).outerWidth() - $(".myAlertError").outerWidth()) / 2 + 'px',
					        position: 'fixed',
					        width: 'auto',
					        height: 'auto'
					    });
					    $(".spError").html(data.msg);
					    //$("#divForm").hide();
					    $(".myEditSuccess").hide();
					}
				},
				error: function (data, status, e)//服务器响应失败处理函数
				{
					alert(e);
				}
			}
		)
		return false;
	}

    function submitForm(form) {

		if (form.tbLinkID.value == "" && form.slType.value == "1") {
			//form.tbLogoFile.value = form.tbLogoFile.value.trim(); 有bug
			if (form.tbLogoFile.value == "") {
				alert("链接图片不能为空");
				form.tbLogoFile.focus();
				return false;
			}
			if (/(.gif)$|(.jpg)$|(.jpeg)$|(.png)$/.test(form.tbLogoFile.value.toLowerCase()) == false) {
				alert("只能上传 gif、jpg 或 png 格式的图片");
				form.tbLogoFile.focus();
				return false;
			}
		}

        var params = $('#EditLinkForm').serializeObject(); //此方法定义在 core/ui.js
		ajaxFileUpload(params);
    }

    me.addListener('editlink', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['editmenu'] = function () {

    var me = this;
	
	var myroot = null;
	var menuinfo = null;
	var curSiteType = 0;

	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/configpackage/html/editmenu.html",function() {

			$("#MenuForm").validate({
				rules: {
					tbName: "required",
					slType: "required"
				},
				messages: {
					tbName: "请输入导航的中文名称！",
					slType: "请选择导航的类型！"
				},
				submitHandler: function (form) {
					submitForm();
					return false;
				}
			});

			if (me.currentModule.params) {
			    if (me.currentModule.params.SiteType == 1) {
			        curSiteType = 1;
			    }
			} else {
			    curSiteType = getCookie('SiteType');
			}
			$("#tbSiteType").val(curSiteType);

			if (me.currentModule.params) {
			    $("#tbMenuID").val(me.currentModule.params.MenuID);
			}
		
			if (curSiteType == 1) {
				$("#trIcon").show();
				//$("#trParentID").hide();
			}

			bindUIEvent();

			myroot = root[0];
			loadData();
		});
    }

	function bindUIEvent(){
		$("#slType").unbind('click').bind("change",function(){
			ChangeType($(this).get(0).form, $(this).val());
		});

		$("*[name=UrlType]").unbind('click').bind("click",function(){
			ChageUrlType($(this).get(0).form);
		});
		
		$("*[name=tbIcon]").unbind('click').bind("click",function(){
			YDM.FileManager('image', 1, function (aUrl) {
                if (aUrl.length > 0) {
					$("*[name=tbIcon]").val(aUrl[0]);
					$('#IconPreview').attr('src',aUrl[0]);
					$('#IconPreview').show();
                }
            }, 'systemIcons');
		});

		$(".myAlertSuccess").find(".close").unbind('click').click(function(){
			me.execCommand('go', { a: 'config', b: 'configmenu',params:{SiteType: $("#tbSiteType").val() } });
			return false;
		});

		$(".myAlertError").find(".close").unbind('click').click(function(){
			$("#divMenuForm").show();
			$(".myAlertError").hide();
			return false;
		});
	}

	function ChageUrlType(form) {
        if (form.UrlType[0].checked) $("#trUrl").show();
        else {
            $("#tbUrl").val(""); $("#trUrl").hide();
        }
    }

	function ChangeType(form, type) {
		if (type == "99") {
			$("#trUrlType").show();
			
			if (form.UrlType[0].checked) $("#trUrl").show();
			else $("#trUrl").hide();

			$("#trSubType").hide();
		} else {
			$("#trUrl").hide();
			$("#trUrlType").hide();

			$("#divSubType").html("");
			var ContentID = (menuinfo && menuinfo.ContentID) || 0;
			var ty = (menuinfo && menuinfo.Type) || 0;
			if (ty != parseInt(type)) ContentID = 0;

			if (type == '2') {
				$("#trSubType").show();
				//$.get("/admin/sitemenu?act=LoadSubType&SubType=product&ContentID=" + ContentID,function(data,status){
				$.get("/index.php?c=admin/config/Sitemenu&a=LoadSubType&SubType=product&ContentID=" + ContentID,function(data,status){
					$("#divSubType").html(data);
			    });

			} else if (type == '3') {
				$("#trSubType").show();
				//$.get("/admin/sitemenu?act=LoadSubType&SubType=article&ContentID=" + ContentID,function(data,status){
				$.get("/index.php?c=admin/config/Sitemenu&a=LoadSubType&SubType=article&ContentID=" + ContentID,function(data,status){
					$("#divSubType").html(data);
			    });

			} else if (type == '4') {
				$("#trSubType").show();
				//$.get("/admin/sitemenu?act=LoadSubType&SubType=download&ContentID=" + ContentID,function(data,status){
				$.get("/index.php?c=admin/config/Sitemenu&a=LoadSubType&SubType=download&ContentID=" + ContentID,function(data,status){
					$("#divSubType").html(data);
			    });
			} else {
				$("#trSubType").hide();
			}
		}
    }
	
    function loadData() {
		
		//$.ajax({ url: "/admin/sitemenu?act=LoadPageTypeList", async: false, dataType: "json", success: function (json) {
    	$.ajax({ url: "/index.php?c=admin/config/Sitemenu&a=LoadPageTypeList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					for(var i = 0;i < json.list.length;i++){
						$("#slType").append("<option value='"+ json.list[i].Type +"'>"+ json.list[i].Name +"</option>");
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});

		//$.ajax({ url: "/admin/sitemenu?act=getlist", async: false, dataType: "json", success: function (json) {
    	$.ajax({ url: "/index.php?c=admin/config/Sitemenu&a=getlist", async: false, dataType: "json", success: function (json) {
				if(json.success){
					for(var i = 0;i < json.list.length;i++){
					    if (json.list[i].ParentID == 0 && json.list[i].SiteType == parseInt("0" + curSiteType)) {
							$("#slParentID").append("<option value='"+ json.list[i].MenuID +"'>"+ json.list[i].Name +"</option>");
						}
					}
					if(me.currentModule.params && me.currentModule.params.ParentID){
						$("#slParentID").val(me.currentModule.params.ParentID);
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
		
		if(me.currentModule.params && me.currentModule.params.MenuID){
			var params = { sid: me.sid, MenuID: me.currentModule.params.MenuID };
			//$.getJSON("/admin/sitemenu?act=getinfo", utils.params(params), function (json) {
			$.getJSON("/index.php?c=admin/config/Sitemenu&a=getinfo", utils.params(params), function (json) {
			    menuinfo = json.info;
			    ko.applyBindings(json, myroot);
				
				$("#tbSiteType").val(menuinfo.SiteType);
				if(menuinfo.PageID > 0){
					$("#UrlType2").attr("checked",true).click();
				}
				if (menuinfo.SiteType == 1){
					//$("#trParentID").hide();
					$("#trIcon").show();
				}
				if(menuinfo.Icon){
					$("#IconPreview").show();
				}
				$('#slParentID option[value=' + $('#tbMenuID').val() + ']').remove();
			});
		} else {
		    $('#slType option[value=99]').prop('selected', true);
			if(me.currentModule.params && me.currentModule.params.LinkType) $("#slType").val(me.currentModule.params.LinkType);
		    $('#slType').trigger('change');
		    $('#UrlType2').trigger('click');
		    ChageUrlType($('#UrlType2').get(0).form);
		}
    }

    function submitForm() {
        var params = $('#MenuForm').serialize();
		//$.post("/admin/sitemenu?act=edit",params,function(data, textStatus, jqXHR){
        $.post("/index.php?c=admin/config/Sitemenu&a=edit",params,function(data, textStatus, jqXHR){
		    if (data.success) {
		        $(".myAlertSuccess").css({
		            opacity: 1,
		            top: ($(window).outerHeight() - $(".myAlertSuccess").outerHeight()) / 2 + 'px',
		            left: ($(window).outerWidth() - $(".myAlertSuccess").outerWidth()) / 2 + 'px',
		            position: 'fixed',
		            width: 'auto',
		            height: 'auto'
		        });
		        $(".myAlertSuccess").slideToggle(500);
		        $(".myAlertError").hide();
		        setTimeout(function () {
		            $(".myAlertSuccess").find(".close").click();
		        }, 1500);
		    } else {
		        $(".myAlertError").css('display', 'inline-block');
		        $(".myAlertError").css({
		            opacity: 1,
		            top: ($(window).outerHeight() - $(".myAlertError").outerHeight()) / 2 + 'px',
		            left: ($(window).outerWidth() - $(".myAlertError").outerWidth()) / 2 + 'px',
		            position: 'fixed',
		            width: 'auto',
		            height: 'auto'
		        });
		        $(".spError").html(data.msg);
		        $(".myAlertSuccess").hide();
			}
		},"json");
    }

    me.addListener('editmenu', function (key, args) {
		initUI(args);
    });
}

﻿
IWF.plugins['editadminpass'] = function () {

    var me = this;
		
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/configpackage/html/editpass.html",function() {
            me.execCommand('initContentNav', root);
			$("#PassForm").validate({
                rules: {
                    tbOldPass: "required",
                    tbNewPass: "required",
                    tbNewPassC: { required: true, equalTo: "#tbNewPass" }
                },
                messages: {
                    tbOldPass: "旧密码不能为空！",
                    tbNewPass: "新密码不能为空！",
                    tbNewPassC: { required: "重复密码不能为空！", equalTo: "两次密码不一致！" }
                },
				submitHandler: function (form) {
					submitForm();
					return false;
				}
			});

			$("#spUserName").html(me.loginUser.UserName);

			$(".myAlertSuccess").find(".close").unbind('click').click(function(){
				me.execCommand('go', { a: 'config', b: 'listadmin' });
				return false;
			});

			$(".myAlertError").find(".close").unbind('click').click(function(){
				$("#divForm").show();
				$(".myAlertError").hide();
				return false;
			});

		});
    }

    function submitForm() {
        var params = {password:$("#tbNewPass").val().trim(),oldpassword: $("#tbOldPass").val().trim()};
        //$.post("/admin/adminmanage?act=editpass", params, function (json, textStatus, jqXHR) {
        $.post("/index.php?c=admin/config/adminmanage&a=editpass", params, function (json, textStatus, jqXHR) {
            if (json.success) {
                $.showResult(true, "修改成功", 1000);
            } else {
                $.showResult(false, json.msg);
            }
		},"json");
    }

    me.addListener('editadminpass', function (key, args) {
		initUI(args);
    });
}

﻿
IWF.plugins['export'] = function () {

    var me = this;
		
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/configpackage/html/export.html?v=" + Math.random(),function() {
			$("#btnExport").unbind('click').click(function(){
				loadLicInfo();
			});
		});
    }

	function loadLicInfo(){
		$("#btnExport").attr("disabled","true");
		$("#divExportInfo").html("正在处理，可能需要5至10分钟，请耐心等候系统处理...").css("display","block");
        $.getJSON("/index.php?c=admin/config/export&a=doExport", null, function (json) {
			$("#divExportInfo").html(json.msg);
			if(json.success){
				$("#divExportInfo").removeClass("alert-danger");
				$("#divExportInfo").addClass("alert-success");
			}else{
				$("#divExportInfo").removeClass("alert-success");
				$("#divExportInfo").addClass("alert-danger");
			}
			$("#btnExport").get(0).disabled = false; 
        });
	}

    me.addListener('export', function (key, args) {
		initUI(args);
    });
}

﻿
IWF.plugins['foldermanage'] = function () {

    var me = this;
	var curpage = 1,pagesize = 20;
	var ViewModel = function () {
        this.list = ko.observableArray();
        this.flist = ko.observableArray();
    };
	
	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/configpackage/html/foldermanage.html",function() {			
			ko.applyBindings(vm,root[0]);
			bindUIEvent();
			loadDirList();
		});
    }

    function loadDirList() {
        // $.getJSON("/admin/foldermanage?act=getlist", null, function (json) {
        
        $.getJSON("/index.php?c=admin/config/foldermanage&a=getlist", null, function (json) {
			if(json.success){
				vm.list(json.list);
				bindGridEvent();
				BindFileListShowEvent();
			}else{
				$(".myAlertError").show();
				$(".spError").html(json.msg);
				$("#divRewriteForm").hide();
				$(".myAlertSuccess").hide();
			}
        });
    }

    function bindFlistEvent(){
    	$('.change-fname-btn').off('click').on('click',function(){
    		var fileid = $(this).attr('fileid');
    		var filename = $(this).parent().prev('td').find('span').text();
    		var foldername = $('.flist-modal').attr('foldername');
    		var thisfile = $(this).closest('tr').find('.filst-oper');
    		var thisfilename = $(this).parent().prev('td').find('span');
    		$('#modiyfile-folder option:contains("'+foldername+'")').each(function(){
    			if($(this).text() == foldername){
    				$(this).attr('selected', true);
    			}
    		});
    		var folderid = $('#modiyfile-folder option:selected').val();

    		$('#modiyfile-name').val(filename);
    		$('#file-modal').modal({'backdrop':false});

    		//提交修改的数据
    		$('#modiysub').off('click').on('click',function(){
	    		var mfolderid = $('#modiyfile-folder option:selected').val();
	    		var mfoldername = $('#modiyfile-folder option:selected').text();
	    		var mfilename = $('#modiyfile-name').val();
	    		
	    		if(mfolderid == folderid && mfilename == filename){
	    			$('#file-modal').modal('hide');
	    			
	    		}
	    		var data = {'name':mfilename,'id':fileid,'folderid':mfolderid};
	    		$.getJSON("/index.php?c=admin/config/foldermanage&a=FileRename", data, function (json) {
					if(json.success){
						$('#file-modal').modal('hide');
						if(mfolderid != folderid){
							thisfile.closest('tr').remove();
						}else{
							thisfilename.text(mfilename);
						}
					}else{
						alert(json.msg);
					}
				});
	    	});
            $('#file-modal').on('hidden.bs.modal', function (e) {
                $('body').addClass('modal-open');
            });
    	});
    	//删除文件
    	$('.delete-file-btn').off('click').on('click',function(){
    		var fileid = $(this).attr('fileid');
    		var thisfile = $(this).closest('tr').find('.filst-oper');
    		var filename = $(this).attr('fileName');

    		var html = '<div style="font-size: 26px;">确定删除文件"' + filename + '"？</div><div style="margin-top: 10px;color: gray; text-indent: 10px;color: red;">删除文件，会影响网站使用，请谨慎操作！</div>';
    		var dialog = bootbox.dialog({
    		    message: html,
    		    className: '',
    		    buttons: {
    		        'cancel': {
    		            label: '取消'
    		        },
    		        'delete': {
    		            label: '删除',
    		            className: "btn-danger",
    		            callback: function () {
    		                $.getJSON("/index.php?c=admin/config/foldermanage&a=FileDelete", { fileid: fileid }, function (json) {
    		                    dialog.modal('hide')
    		                    if (json.success) {
    		                        thisfile.closest('tr').remove();
    		                        $.showResult(true, '删除成功', 1500);
    		                    } else {
    		                        $.showResult(false, json.msg);
    		                    }
    		                });
    		                return false;
    		            }
    		        }
    		    }
    		});
    		dialog.css({ 'padding-top': '200px' });
    	});
    }
    function BindFileListShowEvent() {
    	$('.open-btn').off('click').on('click',function(){
    		curpage = 1;
    		var folderid = $(this).attr('folderid');
    		var foldername = $(this).attr('foldername');
    		$('#flisttitle').text('.\\'+foldername+' 文件管理');
    		FileListShow(folderid,foldername,'');
    		$("#BtnSearch").off('click').on('click',function(){
    			var key = $('#keyword').val();
    			FileListShow(folderid,foldername,key);
    			$('#goback').off('click').on('click',function(){
	    			FileListShow(folderid,foldername,'');
	    			return;
	    		});
    		});
    	});
    }

    function FileListShow(folderid,foldername,key){
    	$.getJSON("/index.php?c=admin/config/foldermanage&a=GetFileList", {page: curpage, pagesize: pagesize,folderid:folderid,key:key}, function (json) {
			if(json.success){
				vm.flist(json.flist);
				$('.flist-modal').attr('id','flist-modal-'+folderid);
				$('.flist-modal').attr('foldername',foldername);
				curpage = json.curpage;
				if (json.pagecount < 2) $("#pagination").hide();
				else {
	                //pageNav 方法定义在 /core/util.js 里
	                $("#pagination").pageNav(curpage, json.pagecount, 10, function (page) {
	                    curpage = page;
	                    FileListShow(folderid,foldername);
	                });
	                $("#pagination").show();
	            }
	            $('#flist-modal-'+folderid).modal({backdrop: 'static', keyboard: true});
                $('#flist-modal-'+folderid).on('shown.bs.modal', function (e) {
                    $(".modal-backdrop").css('height','1px');
                });
	            bindFlistEvent();
			}else{
				$(".myAlertError").show();
				$(".spError").html(json.msg);
				$("#divRewriteForm").hide();
				$(".myAlertSuccess").hide();
			}
        });
    }

	function toggleEditBox(editBox, isShow) {
		if (isShow) {
			$(editBox).closest('tr').find('.new-name').val($(editBox).closest('tr').find('.name').text().trim());
			$(editBox).closest('tr').find('.name').hide();
			$(editBox).closest('tr').find('.edit-name-box').show();
			$(editBox).closest('tr').find('.new-name')[0].focus();
		} else {
			$(editBox).closest('tr').find('.name').show();
			$(editBox).closest('tr').find('.edit-name-box').hide();
		}
	}

	function bindGridEvent(){
		$('.change-name-btn').on('click', function () {
			toggleEditBox(this, true);
		});

		$('.cancel').on('click', function () {
			toggleEditBox(this, false);
		});

		$('.confirm').on('click', function () {
			var name = $(this).closest('tr').find('.name').text().trim();
			var newName = $(this).closest('tr').find('.new-name').val().trim();
			if (name == newName) {
				toggleEditBox(this, false);
				return;
			}
			curEditBox = $(this).closest('tr').find('.edit-name-box');
			var data = { "name": name, "newName": newName };
			// $.getJSON("/admin/foldermanage?act=rename", data, function (json) {
			$.getJSON("/index.php?c=admin/config/foldermanage&a=rename", data, function (json) {
				if(json.success){
					curEditBox.closest('tr').find('.name').text(newName);
					toggleEditBox(curEditBox, false);
					curEditBox = null;
				}else{
					alert(json.msg);
				}
			});
		});

		$('.delete-folder-btn').on('click', function () {
		    var name = $(this).closest('tr').find('.name').text().trim();
		    var self = this;

		    var html = '<div style="font-size: 26px;">确定删除文件夹"' + name + '"？</div><div style="margin-top: 10px;color: gray; text-indent: 10px;color: red;">删除文件夹会把属于文件夹内的文件全部清空，严重影响网站使用，请谨慎操作！</div>';
		    var dialog = bootbox.dialog({
		        message: html,
		        className: '',
		        buttons: {
		            'cancel': {
		                label: '取消'
		            },
		            'delete': {
		                label: '删除',
		                className: "btn-danger",
		                callback: function () {
		                    curEditBox = $(self).closest('tr').find('.edit-name-box');
		                    var data = { "name": name };
		                    $.getJSON("/index.php?c=admin/config/foldermanage&a=delete", data, function (json) {
		                        dialog.modal('hide')
		                        if (json.success) {
		                            curEditBox.closest('tr').remove();
		                            curEditBox = null;
		                            $.showResult(true, '删除成功', 1500);
		                        } else {
		                            $.showResult(false, json.msg);
		                        }
		                    });
		                    return false;
		                }
		            }
		        }
		    });
		    dialog.css({ 'padding-top': '200px' });
		});		
	}

	function bindUIEvent(){
		$('#BtnAddNewFolder').on('click', function () {
			var name = $("#newfolder").val().trim();
			if(name == ""){
				alert("文件夹名称不能为空");
				return;
			}
			var data = { "folderName": name };
			// $.getJSON("/admin/foldermanage?act=create", data, function (json) {
			$.getJSON("/index.php?c=admin/config/foldermanage&a=create", data, function (json) {
				if(json.success){
					loadDirList();
				}else{
					alert(json.msg);
				}
			});
		});
	}
	
    me.addListener('foldermanage', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['friendlinks'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
		this.getType = function(type){
			return type == 0 ? "文字链接" : "图片链接";
		};
		this.getLogo = function(siteid,logo){
			if(logo){
				var path = "../comdata/"+ siteid +"/links/" + logo + "?" + Math.random();
				return "<img src='"+ path +"'>";
			}
		};
    };
	
	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/configpackage/html/friendlinks.html",function() {
			ko.applyBindings(vm,root[0]);
			bindUIEvent();
			loadLinkList(1);
		});
    }
	
	var curpage = 1;
	var itemcount = 0;
    function loadLinkList(page) {
		var params = { sid: me.sid, Keyword: $("#Keyword").val(), LinkType: $("#LinkType").val(), page: page, pagesize: 20 };
        //$.getJSON("/admin/friendlinks?act=getlist", utils.params(params), function (json) {
		$.getJSON("/index.php?c=admin/config/friendlinks&a=getlist", utils.params(params), function (json) {
			if(json.success){
				vm.list(json.list);

				curpage = json.curpage;
				itemcount = json.list.length;
				if (json.pagecount < 2) $("#pagination").hide();
				else {
					//pageNav 方法定义在 /core/util.js 里
					$("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadLinkList(page); });
					$("#pagination").show();
				}

				bindGridEvent();
			}else{
				alert("出错了：" + json.msg);
			}
        });
    }

	function bindUIEvent(){
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadLinkList(1);
        });

		$("#BtnAdd").unbind('click').bind('click', function (event) {
			me.execCommand('go', { a: 'config', b: 'editlink' });
        });
	}

	function bindGridEvent() {
		$("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            me.execCommand('go', { a: 'config', b: 'editlink', params: { LinkID: $(this).attr("LinkID")} });
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return;
			//$.getJSON("/admin/friendlinks?act=delete", utils.params({LinkID:$(this).attr("LinkID")}), function (json) {
			$.getJSON("/index.php?c=admin/config/friendlinks&a=delete", utils.params({LinkID:$(this).attr("LinkID")}), function (json) {
				if(itemcount > 1) loadLinkList(curpage);
				else loadLinkList(1);
			});
        });
	}

    me.addListener('friendlinks', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['config'] = function () {

    var me = this;
    var nav = { icon: 'fa fa-gears',color: 'icon-green', title: '设置', a: 'config', b: 'configsite', index: 3, canClose: false };

    var leftRoot, rightRoot, leftNav;


    var navConfig = {
        showOption:false,
        
        /*data: [
            { icon: 'fa fa-edit', color: 'icon-red', title: '管理员列表', a: 'admin', b: 'listadmin' }
			, { icon: 'fa fa-key', color: 'icon-blue', title: '修改密码', a: 'admin', b: 'editadminpass' }
            , { icon: 'fa fa-plus', color: 'icon-green', title: '添加管理员', a: 'admin', b: 'editadmin' }
        ],*/

        data: [
        {
            icon: 'fa fa-edit', color: 'icon-red', title: '管理员管理',
            items: [
                { icon: 'fa fa-key', color: 'icon-blue', title: '修改密码', a: 'config', b: 'editadminpass' }
            ]
        }, {
            icon: 'fa fa-edit', color: 'icon-red', title: '网站设置',
            items: [
                { icon: 'fa fa-cog', color: 'icon-blue', title: '网站参数设置', a: 'config', b: 'configsite'}
                , { icon: 'fa fa-magic', color: 'icon-green', title: '伪静态设置', a: 'config', b: 'configrewrite' }
                , { icon: 'fa fa-tasks', color: 'icon-red', title: '网站导航', a: 'config', b: 'configmenu' }
                , { icon: 'fa fa-language', color: 'icon-yellow', title: '多语言站点', a: 'config', b: 'configlang' }
				, { icon: 'fa fa-cube', color: 'icon-yellow', title: '网站备份', a: 'config', b: 'backuplist' }
            ]
        }, {
            icon: 'fa fa-edit', color: 'icon-red', title: '其它',
            items: [
                { icon: 'fa fa-folder', color: 'icon-blue', title: '文件夹管理', a: 'config', b: 'foldermanage'}
                , { icon: 'fa fa-group', color: 'icon-green', title: '在线客服', a: 'config', b: 'onlineIM' }
                , { icon: 'fa fa-link', color: 'icon-yellow', title: '友情链接', a: 'config', b: 'friendlinks' }
                , { icon: 'fa fa-refresh', color: 'icon-red', title: '更新授权', a: 'config', b: 'license' }
            ]
        }],

        onItemClick: function (sender, data) {
            leftNav.hide();
            me.execCommand('go', data);
        },

        setSelect: function (args) {
            var index = 0;
            $.each(navConfig.data, function (i, item) {
                index++;
                if (item.a == args.a && item.b == args.b) {
                    navConfig.selectIndex = index;
                }
                if (item.items) {
                    $.each(item.items, function (k, citem) {
                        index++;
                        if (citem.a == args.a && citem.b == args.b) {
                            navConfig.selectIndex = index;
                        }
                    });
                }
            });
        }
    };

    me.addListener('init', function () { 

        //添加导出网站的菜单，这里应该加上权限的
        if (!me.loginUser.SingleWeb && me.hasLicensePerm("ENABLE_EXPORT_WEBSITE")) {
            navConfig.data[2].items.push({ icon: 'fa fa-database', color: 'icon-yellow', title: '导出网站', a: 'config', b: 'export' });
        }
        if(me.hasPerm("SysAdm,SiteAdm")){
            navConfig.data[0].items.push({ icon: 'fa fa-list-ul', color: 'icon-red', title: '管理员列表', a: 'config', b: 'listadmin' });
            navConfig.data[0].items.push({ icon: 'fa fa-plus ', color: 'icon-green', title: '添加/修改管理员', a: 'config', b: 'editadmin' });
        }

        if (getCookie('SiteType') == 1) {
            var items = navConfig.data[1].items;
            var i = 0;
            for (; i < items.length; i++) {
                if (items[i].b == 'configlang')
                break;
            }
            navConfig.data[1].items.splice(i, 1);
        }

        var tab = me.execCommand('addtab', nav);
        if (tab.c.children().length == 0) {
            var temp = $('<div class="row"></div>').appendTo(tab.c);
            //leftRoot = $('<div class="col-sm-1 col-md-2 mainside"></div>').appendTo(temp);
            rightRoot = $('<div class="col-sm-9 col-md-10 col-sm-offset-3 col-md-offset-0"></div>').appendTo(temp);
            //leftRoot.append('<div class="navcontent"></div>');
        }

        leftNav = $('<div class="sidebarNavPanel"><div class="titlebar"><div class="title">'+ nav.title +'</div></div><div class="content"><ul></ul></div></div>').appendTo("body");
        leftNav.find('.content>ul').listNav2(tab,leftNav,navConfig);

        tab.t.click(function(){ leftNav.hide(); });
    });

    function flash(args, tab,isgo) {
        

        //原来架框的建立下级菜单过程
        //navConfig.setSelect(args);
        //leftRoot.find('div.navcontent').listNav(navConfig);

        me.execCommand('show', { a: args.a });
        setChildWindow(args,rightRoot,isgo);
    }

    function setChildWindow(args, root,isgo) {
        /*var temp = root.find('#' + args.b);
        if (temp.length == 0) {
            temp = $('<div id="' + args.b + '"></div>').appendTo(root);
        }
        temp.show();
        temp.siblings().hide();
        if(isgo) me.execCommand('go', args);
		else me.fireEvent(args.b, temp);*/

        if(isgo) me.execCommand('go', args);
        else me.fireEvent(args.b, me.content); //me.content 定义在 core/content.js 里
    }

    me.commands['initContentNav' + nav.a] = {
        execCommand: function (key, domObj) {
            var items = [];
            if (/^(editadmin)|(listadmin)|(editadminpass)$/.test(me.currentModule.b)) {
                if (me.hasPerm("SysAdm,SiteAdm")) {
                    items.push({ title: '管理员列表', a: 'config', b: 'listadmin' });
                    items.push({ title: '添加/修改管理员', a: 'config', b: 'editadmin' });
                    items.push({ title: '修改密码', a: 'config', b: 'editadminpass' });
                }
            } else if (/^config/.test(me.currentModule.b)) {
                items = navConfig.data[1].items;
            }
            me.execCommand('addContentNav', domObj, items);
        }
    }

    me.addListener(nav.a, function (key, args) {
        var tab = me.execCommand('gettab', nav);
        flash(args, tab);
    });
};

﻿
IWF.plugins['license'] = function () {

    var me = this;
		
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/configpackage/html/license.html",function() {
			loadLicInfo();
		});
    }

	function loadLicInfo(){
		$("#divLicInfo").html("正在检测授权信息，请稍候...");
        $.getJSON("/index.php?c=admin/config/license&a=getinfo", null, function (json) {
			$("#divLicInfo").html(json.msg);
			if(json.success){
				$("#divLicInfo").removeClass("alert-danger");
				$("#divLicInfo").addClass("alert-success");
			}else{
				$("#divLicInfo").removeClass("alert-success");
				$("#divLicInfo").addClass("alert-danger");
			}
        });
	}

    me.addListener('license', function (key, args) {
		initUI(args);
    });
}

﻿
IWF.plugins['listadmin'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.adminlist = ko.observableArray();
        this.setData = function (data) { this.adminlist(data); };
    };

	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/configpackage/html/listadmin.html?v=" + Math.random(), function () {
            me.execCommand('initContentNav', root);
			ko.applyBindings(vm,root[0]);
			loadAdminList(1);

			$('#BtnAddAdmin').off().on('click', function () {
			    me.execCommand('go', { a: 'config', b: 'editadmin' });
			})
		});
    }
    
	var curpage = 1;
	var itemcount = 0;
    function loadAdminList(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(), status: $("#status").val(), page: page, pagesize: 20 };
        //$.getJSON("/admin/adminmanage?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/config/adminmanage&a=getlist", utils.params(params), function (json) {
            vm.setData(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 1) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadAdminList(page); });
                $("#pagination").show();
            }

            bindGridEvent();
        });
    }

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            me.execCommand('go', { a: 'config', b: 'editadmin', params: { id: $(this).attr("AID")} });
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return;
			//$.getJSON("/admin/adminmanage?act=delete", utils.params({ id: $(this).attr("AID") }), function (json) {
			$.getJSON("/index.php?c=admin/config/adminmanage&a=delete", utils.params({ id: $(this).attr("AID") }), function (json) {
			    if (!json.success) {
			        alert(json.msg);
			        return;
			    }
				if(itemcount > 1) loadAdminList(curpage);
				else loadAdminList(1);
			});
        });

		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadAdminList(1);
        });
    }

    me.addListener('listadmin', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿
IWF.plugins['onlineIM'] = function () {

    var me = this;
	
	var ViewModel = function () {
		this.EnableOnlineService = ko.observable(false);
		this.Location = ko.observable();
		this.Accounts = ko.observableArray([]);
		this.ShowContacts = ko.observable(false);
		this.Contacts = ko.observableArray([]);
		this.ShowQrCode = ko.observable(false);
		this.QrCodePath = ko.observable();
		this.style = ko.observable();
		this.Color = ko.observable();
		this.EnableThirdService = ko.observable(false);
		this.Other = ko.observable();
		
		var self = this;
		this.setInfo = function(data){
			for(var key in data){
				if(key in self){
					var val = data[key];
					if($.isArray(self[key]()) && !$.isArray(val)) val = [];
					self[key](val);
				}
			}
		}
		
		this.editAccount = function(){
			showEditAccountDialog(false, this);
		}
		this.deleteAccount = function(){
			if(confirm('确定删除吗？')){
				var items = self.Accounts();
				for(var i = 0; i < items.length; i++){
					if(items[i].ItemID == this.ItemID){
						items.splice(i, 1);
						break;
					}
				}
				self.Accounts(items);
			}
		}
		this.editContact = function(){
			showEditContactDialog(false, this);
		}
		this.deleteContact = function(){
			if(confirm('确定删除吗？')){
				var items = self.Contacts();
				for(var i = 0; i < items.length; i++){
					if(items[i].ItemID == this.ItemID){
						items.splice(i, 1);
						break;
					}
				}
				self.Contacts(items);
			}
		}

		this.getIMType = function(type){
			if(type == 1) return "QQ";
			if(type == 2) return "淘宝旺旺";
			if(type == 3) return "MSN";
			return "--";
		}

		this.getIMDisp = function(type,account,name){
			if(type == 1) return "<a target='_blank' href='http://wpa.qq.com/msgrd?v=1&uin="+account+"'><img border='0' SRC='http://wpa.qq.com/pa?p=1:"+account+":4' alt='点击这里给我发消息' align='absmiddle' onerror='this.alt=\"无此账号\"'> "+name+"</a>";
			if(type == 2) return "<a target='_blank' href='http://amos1.taobao.com/msg.ww?v=2&uid="+account+"&s=2' ><img border='0' src='http://amos1.taobao.com/online.ww?v=2&uid="+account+"&s=2' alt='点击这里给我发消息' onerror='this.alt=\"无此账号\"'/> "+name+"</a>";
			if(type == 3) return "<a target='_blank' href='msnim:chat?contact="+account+"'><img border='0' SRC='/images/msn.gif' alt='点击这里给我发消息' align='absmiddle' onerror='this.alt=\"无此账号\"'> "+name+"</a>";
			return "--";
		}
    };
	
	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/configpackage/html/onlineIM.html?v=" + Math.random(),function() {
			bindUIEvent();
			ko.applyBindings(vm,root[0]);
			loadInfo();
		});
    }
	
    function loadInfo() {
    	$.getJSON("/index.php?c=admin/config/onlineim&a=getinfo", null, function (json) {
			if(json.success){
				if(!json.info){ // 视为新站，给一些默认数据
					json.info = {};
					json.info.EnableOnlineService = 0;
					json.info.Location = 1;
					json.info.Accounts = [
						{"Name":"客服1","Type":"1","Account":"123456","ItemID":1},
						{"Name":"客服2","Type":"2","Account":"123456","ItemID":2}
					];
					json.info.Accounts = JSON.stringify(json.info.Accounts);
					json.info.ShowContacts = 1;
					json.info.Contacts = [
						{"Name":"热线电话","Content":"400-12345678","ItemID":1},
						{"Name":"上班时间","Content":"周一至周五","ItemID":2}
					];
					json.info.Contacts = JSON.stringify(json.info.Contacts);
					json.info.ShowQrCode = 1;
					json.info.QrCodePath = '/images/onlineService/baiduqrcode.png';
					json.info.style = 23;
					json.info.Color = 'black';
					json.info.EnableThirdService = 0;
				}
				json.info.Accounts = JSON.parse(json.info.Accounts || '[]');
				json.info.Contacts = JSON.parse(json.info.Contacts || '[]');
				json.info.ShowContacts = parseInt(json.info.ShowContacts);
				json.info.ShowQrCode = parseInt(json.info.ShowQrCode);
				vm.setInfo(json.info);
				initData(json);
			}else{
			    $.showResult(false, "加载信息失败：" + json.msg);
			}
        });
    }

	function initData(json){
		var style = json.info.style;
		var curStyleElem = $('input[name=raStyle][value=' + style + ']');
		curStyleElem.prop("checked", true);
		curStyleElem.closest('li').show();
		
		if($('[name=raStyle]:checked').length == 0){
			curStyleElem = $('[name=raStyle][value=20]');
			curStyleElem.prop("checked", true);
		}
		
		var li = curStyleElem.closest('li');
		li.mouseenter();
		li.find('.colorGrid[color="' + $('[name=txColor]').val() + '"]').click();
	}
	
	function bindUIEvent(){
		$('#btnSave').floatSaveBtn();
		$("#btnSave").off().click(function(){
			if($('[name=chkShowQrCode]').prop('checked') && $.trim($('[name=txQrCodePath]').val()) == ''){
				$.showResult(false, '请先添加二维码图片');
				return;
			}
			var params = $('#OnlineServiceForm').serializeObject();
			params.Accounts = JSON.stringify(vm.Accounts()) || '';
			params.Contacts = JSON.stringify(vm.Contacts()) || '';
			
			$.ajax({
				type:'post',
				url: '/index.php?c=admin/config/onlineim&a=EditInfo',
				async:false,
				cache:false,
				data:params,
				dataType:'json',
				success:function(data){
					if(!data.success){
						$.showResult(false, data.msg);
						return;
					}
					$.showResult(true, '保存成功！', 1500);
				},
				error:function(){
					$.showResult(false, arguments[2]);
				}
			});
		});

		$("#btnAddAccount").off().on('click', function(){ 
			showEditAccountDialog(true);
		});
		
		$('#btnAddContact').off().on('click', function(){
			showEditContactDialog(true);
		});
		
		$("#accountsList>tbody").sortable({
			axis: 'y',
			cursor: "move",
			forceHelperSize: true,
			forcePlaceholderSize: true,
			handle: "td:eq(0)",
			helper: "helper",
			tolerance: "pointer",
			stop: function (event, ui) {
				var items = vm.Accounts();
				var newOrders = [];
				$('#accountsList>tbody>tr').each(function(){
					newOrders.push($(this).attr('ItemID') + '');
				});
				items.sort(function(a, b){
					return $.inArray(a.ItemID + '', newOrders) - $.inArray(b.ItemID + '', newOrders);
				});
				vm.Accounts(items);
			}
		});
        $("#accountsList").disableSelection();

		$("#contactsList>tbody").sortable({
			axis: 'y',
			cursor: "move",
			forceHelperSize: true,
			forcePlaceholderSize: true,
			handle: "td:eq(0)",
			helper: "helper",
			tolerance: "pointer",
			stop: function (event, ui) {
				var items = vm.Contacts();
				var newOrders = [];
				$('#contactsList>tbody>tr').each(function(){
					newOrders.push($(this).attr('ItemID') + '');
				});
				items.sort(function(a, b){
					return $.inArray(a.ItemID + '', newOrders) - $.inArray(b.ItemID + '', newOrders);
				});
				vm.Contacts(items);
			}
		});
		$("#contactsList").disableSelection();
		
		$('#btnSelectQrCode').off().on('click', function(){
			top.YDM.FileManager('image', 1, function (aUrl) {
				if (aUrl.length > 0) {
					$('[name=txQrCodePath]').val(aUrl[0]);
				}
			});
		});
	
		$('#styleList>li').off().on('mouseenter', function(){
			var li = $(this);
			if(li.find('[name=raStyle]').val() <= 13){
				return;
			}
			if(li.is('.selected')) return;
			$('.colorSelectPanel').not('#styleList>li.selected>.colorSelectPanel').remove();
			var colors = [{name:'red', color:'#e60012'}, 
				{name:'green', color:'#a9e047'}, 
				{name:'blue', color:'#4BACE8'}, 
				{name:'yellow', color:'#ffb800'},
				{name:'black',color:'#010101'}
			];
			var html = '<div class="colorSelectPanel">';
			html += '<div class="colorSelectPanelMask"></div>';
			html += '<div class="colorAllTogether">';
			for(var i = 0; i < colors.length; i++){
				html += '<span class="colorGrid" style="background: ' + colors[i].color + '" color="' + colors[i].name + '"></span>';
			}
			html += '</div>';
			html += '</div>';
			li.append(html);

			$('.colorGrid').off().on('click',function(){
				var li = $(this).closest('li');
				$('.colorSelectPanel').not(li.find('.colorSelectPanel')).remove();
				$('#styleList>li').removeClass('selected');
				$('.colorGrid').removeClass('fa fa-check');
				li.addClass('selected');
				$(this).addClass('fa fa-check');
				li.find('[name=raStyle]').prop('checked', true);
				$('[name=txColor]').val($(this).attr('color'));
			});
		}).on('mouseleave', function(){
			var li = $(this);
			$('.colorSelectPanel').not('#styleList>li.selected>.colorSelectPanel').remove();
		});

	}
	
	function showEditAccountDialog(isNew, options){
		var content = $('#IMItemForm').find('form').clone().show();
		if(isNew){
			$('[name=txItemID]', content).val('');
			$('[name=txName]', content).val('');
			$('[name=slType]', content).val('');
			$('[name=txAccount]', content).val('');
		}else{
			$('[name=txItemID]', content).val(options.ItemID);
			$('[name=txName]', content).val(options.Name);
			$('[name=slType]', content).val(options.Type);
			$('[name=txAccount]', content).val(options.Account);
		}

		content.validate({
			ignore: "",
			rules: {
				txAccount: {"required": true},
				txName: {"required": true}
			},
			messages: {
				txAccount: {"required": "请输入帐号！"},
				txName: {"required": "请输入客服名称！"}
			}
		});
		
		var dialog = bootbox.dialog({
			title: isNew ? '新增在线客服' : '修改在线客服',
			message: content,
			className: 'editAccountDialog',
			buttons: {
				'cancel': {
					label: '取消'
				},
				'confirm': {
					label: '确定',
					className: "btn-success",
					callback: function () {
						if(!$(this).find('form').valid()){
							return false;
						}
						var items = vm.Accounts();
						var item = {
								Name: $(this).find('[name=txName]').val() || '',
								Type: $(this).find('[name=slType]').val() || '',
								Account: $(this).find('[name=txAccount]').val() || ''
							};
						if(isNew){
							var maxItemID = 0;
							for(var i = 0; i < items.length; i++){
								maxItemID = Math.max(maxItemID, parseInt(items[i].ItemID));
							}
							item.ItemID = maxItemID + 1;
							items.push(item);
							vm.Accounts(items);
						}else{
							for(var i = 0; i < items.length; i++){
								if(items[i].ItemID == $(this).find('[name=txItemID]').val()){
									item.ItemID = items[i].ItemID,
									items[i] = item;
									vm.Accounts(items);
									break;
								}
							}
						}
					}
				}
			}
		});

	}
	
	function showEditContactDialog(isNew, options){
		var content = $('#ContactsForm').find('form').clone().show();
		if(isNew){
			$('[name=txItemID]', content).val('');
			$('[name=txName]', content).val('');
			$('[name=txContent]', content).val('');
		}else{
			$('[name=txItemID]', content).val(options.ItemID);
			$('[name=txName]', content).val(options.Name);
			$('[name=txContent]', content).val(options.Content);
		}
		
		content.validate({
			ignore: "",
			rules: {
				txAccount: {"required": true},
				txName: {"required": true},
				txContent: {"required": true},
			},
			messages: {
				txAccount: {"required": "请输入帐号！"},
				txName: {"required": "请输入客服名称！"},
				txContent: {"required": "请输入内容！"}
			}
		});
		
		var dialog = bootbox.dialog({
			title: isNew ? '新增联系方式' : '修改联系方式',
			message: content,
			className: 'editContactsDialog',
			buttons: {
				'cancel': {
					label: '取消'
				},
				'confirm': {
					label: '确定',
					className: "btn-success",
					callback: function () {
						if(!$(this).find('form').valid()){
							return false;
						}
						
						var items = vm.Contacts();
						var item = {
								Name: $(this).find('[name=txName]').val() || '',
								Content: $(this).find('[name=txContent]').val() || ''
							};
						
						if(isNew){
							var maxItemID = 0;
							for(var i = 0; i < items.length; i++){
								maxItemID = Math.max(maxItemID, parseInt(items[i].ItemID));
							}
							item.ItemID = maxItemID + 1;
							items.push(item);
							vm.Contacts(items);
						}else{
							for(var i = 0; i < items.length; i++){
								if(items[i].ItemID == $(this).find('[name=txItemID]').val()){
									item.ItemID = items[i].ItemID,
									items[i] = item;
									vm.Contacts(items);
									break;
								}
							}
							vm.Contacts(items);
						}
					}
				}
			}
		});
	}	
	     
    me.addListener('onlineIM', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['banner'] = function () {

    var me = this;

    function changeDate(d) {
        return d.replace(/^(\d+)-(\d+)-(\d+) (\d+):(\d+).+$/, '$1年$2月$3日');
    }

    me.addListener('render', function () {

    });

    this.addListener('ready', function () {
        me.fireEvent('timer');
    });
};
﻿IWF.plugins['content'] = function () {

    var me = this,
    ACTCSS = "active";
    tab = $('#maintab'),
    me.content = content = $('#maincontent');
	headernav = $('#mainheadbar');

    var tabTpl = '<li index={index}><div><div class="tabHandle" style="text-align:center" data-toggle="tab" href="#{a}_{b}" style="cursor:pointer"><br>{name}</div></div></li>';
    var colTpl = '<button type="button" class="close"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>';
    var contentTpl = '<div class="tab-pane" id="{a}_{b}"></div>';

    items = [];

    function itemClick(sender) {
        me.execCommand('go', { a: sender.data.a, b: sender.data.b });
    };

    function itemClose(sender) {
        me.execCommand('close', sender.data);
    };

    function newTab(a, b, icon, color,params, name, canClose,index) {
        var item = { a: a, b: b, params: params, name: name };
        var c = $(utils.replaceTpl(contentTpl, item)).appendTo(content);
        item.c = c;
		item.index = index || 1;
		
		/*
		//这里有BUG，没有处理 index 的问题
        var t = $(utils.replaceTpl(tabTpl, item)).appendTo(tab);
        t.children().children('span').bind('click', item, itemClick);
		*/

		//** 添加tab并处理index排序的问题
		var t = $(utils.replaceTpl(tabTpl, item));
		t.children().children('div.tabHandle').bind('click', item, itemClick);
		var tabcount = items.length;
		var max = 0;
		var min = 999999;
		var childbefore = 0;
		var childindex = 0;
		tab.children().each(function(){
			var ii = $(this).attr("index");
			if(ii){
				ii = parseInt(ii);
				if(ii > max) max = ii;
				if(ii >= item.index){
					if(min > ii){
						min = ii;
						childbefore = childindex;
					}
				}
			}
			childindex++;
		});
		var msg = t.text();
        /*
		if(!index || index >= max){
			t.appendTo(tab);
		}
		else{
			var xx = $(tab.children().get(childbefore));
			t.insertBefore(xx);
		}
        */
		//** END 添加tab并处理index排序的问题

        if (icon) t.children().children().prepend('<i class="' + icon + ' icon-2x"/>');
        item.t = t;

        if (canClose) {
            var cols = $(colTpl).appendTo(t.children('div'));
            cols.bind('click', item, itemClose);
        }

        items.push(item);
        return item;
    }

    function getTab(a, b) {
        for (var i = 0; i < items.length; i++) {
            if (a == items[i].a) {
                if (!b || b == items[i].b) return items[i];
            }
        }
        return null;
    }

    me.addListener('beforeclose', function (key, args) {
        for (var i = 0, item ; item = items[i++];) {
            if (args.a == item.a) {
                utils.removeItem(items, item);
                item.t.remove();
                item.c.remove();
                item = null;
            }
        }
    });

    //添加Tab
    me.commands['addtab'] = {
        execCommand: function (key, args) {
            var temp = getTab(args.a, args.b);
            if (temp == null) {
                var name = args.title || args.a + "_" + args.b;
                temp = newTab(args.a, args.b, args.icon, args.color, args.params, name, args.canClose, args.index);
            }
            return temp;
        }
    };

    //取得tab页
    me.commands['gettab'] = {
        execCommand: function (key, args) {
            return getTab(args.a, args.b);
        }
    };

    //显现当前页
    me.commands['show'] = {
        execCommand: function (key, args) {
            var temp = getTab(args.a, args.b);
            //if (temp && !temp.t.hasClass(ACTCSS)) temp.t.children().children('div.tabHandle').tab('show'); //改为用 moveover 触发子菜单时，不应该再检测 hasClass(ACTCSS)
			if (temp) temp.t.children().children('div.tabHandle').tab('show');
        }
    };

	//构建头部导航
	me.commands['buildheader'] = {
        execCommand: function (key, args) {
			headernav.append(args.html);
        }
	};

    //初始化内容区导航
	me.commands['initContentNav'] = {
	    execCommand: function (key, args) {
	        me.execCommand('initContentNav' + me.currentModule.a, args);
	    }
	}

    //添加内容区导航
	me.commands['addContentNav'] = {
	    execCommand: function (key, domObj, items) {
	        return;
	        if (items && items.length > 0) {
	            var tab = $('<ul class="nav nav-tabs contentNavTab"></ul>');
	            for (var i = 0; i < items.length; i++) {
	                var isActive = true;
	                if (items[i].b != me.currentModule.b) {
	                    isActive = false;
	                }
                    // 判断是否只传sitetype参数
	                var paramLength = 0;
	                var paramName = '';
	                if (me.currentModule.params) {
	                    for (param in me.currentModule.params) {
	                        paramLength++;
	                        paramName = param;
	                    }
	                }
	                if (paramLength == 1 && paramName.toLowerCase() != 'sitetype') {
	                    isActive = false;
	                }
	                var p = ' p="{&quot;SiteType&quot;:' + document.cookie.match(/sitetype=(\d+)/i)[1] + '}"';
	                tab.append('<li role="presentation" class="' + (isActive ? 'active' : '') + '"><a a="' + items[i].a + '" b="' + items[i].b + '"' + p + ' style="cursor:pointer;">' + items[i].title + '</a></li>');
	            }
	            tab.prependTo(domObj);
	            tab.find('a').off('click').on('click', function () {
	                var params = {};
	                try {
	                    params = JSON.parse($(this).attr('p'));
	                } catch (ex) {
                        console.log(ex)
	                }
	                me.execCommand('go', { a: $(this).attr('a'), b: $(this).attr('b'), params: params });
	            })
	        }
	    }
	}
};
﻿//IWF.plugins['content'] = function () {
var nouseXXXX = function () {
    var me = this,
    ACTCSS = "active";
    tab = $('#maintab'),
    content = $('#maincontent');
	headernav = $('#mainheadbar');

    var tabTpl = '<li index={index}><div><span data-toggle="tab" href="#{a}_{b}" style="cursor:pointer">{name}</span></div></li>';
    var colTpl = '<button type="button" class="close"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>';
    var contentTpl = '<div class="tab-pane" id="{a}_{b}"></div>';

    items = [];

    function itemClick(sender) {
        me.execCommand('go', { a: sender.data.a, b: sender.data.b });
    };

    function itemClose(sender) {
        me.execCommand('close', sender.data);
    };

    function newTab(a, b, icon, color,params, name, canClose,index) {
        var item = { a: a, b: b, params: params, name: name };
        var c = $(utils.replaceTpl(contentTpl, item)).appendTo(content);
        item.c = c;
		item.index = index || 1;
		
		/*
		//这里有BUG，没有处理 index 的问题
        var t = $(utils.replaceTpl(tabTpl, item)).appendTo(tab);
        t.children().children('span').bind('click', item, itemClick);
		*/

		//** 添加tab并处理index排序的问题
		var t = $(utils.replaceTpl(tabTpl, item));
		t.children().children('span').bind('click', item, itemClick);
		var tabcount = items.length;
		var max = 0;
		var min = 999999;
		var childbefore = 0;
		var childindex = 0;
		tab.children().each(function(){
			var ii = $(this).attr("index");
			if(ii){
				ii = parseInt(ii);
				if(ii > max) max = ii;
				if(ii >= item.index){
					if(min > ii){
						min = ii;
						childbefore = childindex;
					}
				}
			}
			childindex++;
		});
		var msg = t.text();
		if(!index || index >= max){
			t.appendTo(tab);
		}
		else{
			var xx = $(tab.children().get(childbefore));
			t.insertBefore(xx);
		}
		//** END 添加tab并处理index排序的问题

        if (icon) t.children().prepend('<i class="' + icon + ' ' + color + '" style="margin-left:10px;"/>');
        item.t = t;

        if (canClose) {
            var cols = $(colTpl).appendTo(t.children('div'));
            cols.bind('click', item, itemClose);
        }

        items.push(item);
        return item;
    }

    function getTab(a, b) {
        for (var i = 0; i < items.length; i++) {
            if (a == items[i].a) {
                if (!b || b == items[i].b) return items[i];
            }
        }
        return null;
    }

    me.addListener('beforeclose', function (key, args) {
        for (var i = 0, item ; item = items[i++];) {
            if (args.a == item.a) {
                utils.removeItem(items, item);
                item.t.remove();
                item.c.remove();
                item = null;
            }
        }
    });

    //添加Tab
    me.commands['addtab'] = {
        execCommand: function (key, args) {
            var temp = getTab(args.a, args.b);
            if (temp == null) {
                var name = args.title || args.a + "_" + args.b;
                temp = newTab(args.a, args.b, args.icon, args.color, args.params, name, args.canClose, args.index);
            }
            return temp;
        }
    };

    //取得tab页
    me.commands['gettab'] = {
        execCommand: function (key, args) {
            return getTab(args.a, args.b);
        }
    };

    //显现当前页
    me.commands['show'] = {
        execCommand: function (key, args) {
            var temp = getTab(args.a, args.b);
            if (temp && !temp.t.hasClass(ACTCSS)) temp.t.children().children('span').tab('show');
        }
    };

	//构建头部导航
	me.commands['buildheader'] = {
        execCommand: function (key, args) {
            //alert(key);
			headernav.append(args.html);
        }
    };
};
﻿/*IWF.plugins['index'] = function () {

    var me = this;
    var nav = { icon: 'icon-home', color: 'icon-blue', title: '首页', a: 'home', b: 'index',index:1 };

    var leftRoot, rightRoot;

    me.addListener('init', function () { me.execCommand('addtab', nav); });
	
    me.addListener('initurl', function () {
        me.execCommand('go', nav);
		alert();
    });

    function flash(args, tab) {
        if (tab.c.children().length == 0) {
            var temp = $('<div class="row"></div>').appendTo(tab.c);
            rightRoot = $('<div class="col-sm-9"></div>').appendTo(temp);
			initUI(rightRoot);
        }
        me.execCommand('show', { a: args.a });
    }

	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/flowpackage/html/flowbrowser.html",function(){
			
		});
    }

    me.addListener(nav.a, function (key, args) {
        var tab = me.execCommand('gettab', { a: args.a }) || me.execCommand('addtab', nav);
        flash(args, tab);
    });
};
*/

﻿IWF.plugins['message'] = function () {

    var me = this;

    me.commands['window'] = {
        execCommand: function (key, args) {

            var temp = $('<div id="window" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">'
                + '<div class="modal-dialog modal-md">'
                + '<div class="modal-content">'
                + '</div>'
                + '</div>'
                + '</div>').appendTo('body').on('hidden.bs.modal', function (e) {
                    temp.remove();
                }).on('loaded.bs.modal', function (event) {
                    /*有优化空间*/
                    var win = $(this);
                    if(winLoad) winLoad(win,args);
                    win.find('#win-ok').bind('click', function () {
                        if (winSave) winSave(win,args);
                        win.modal('hide');
                    });
                });
            temp.modal(args);
            return temp;
        }
    };

    me.commands['waiting'] = {
        execCommand: function (key, json, callback) {
            var box = $(boxBgTpl).appendTo(me.body);
            var root = box.win = $(rootTpl).appendTo(box);
            box.title = $(utils.replaceTpl(titleTpl, { title: '等待' })).appendTo(root);
            var content = box.content = $(contentTpl).appendTo(root);
            box.content.css({ padding: '20px' });
            box.content.append('<img src="resources/loading.gif" align="middle" style="margin:10px;" />');
            box.content.append((json) ? json.text : '加载中，请稍候。');
            setPosition(root);
            box.close = function () {
                box.remove();
            }
            return box;
        }
    };

    me.commands['prompt'] = {
        execCommand: function (key, json, callback) {
            var box = $(boxBgTpl).appendTo(me.body);
            var root = box.win = $(rootTpl).appendTo(box);
            box.title = $(utils.replaceTpl(titleTpl, { title: '系统输入' })).appendTo(root);
            var content = box.content = $(contentTpl).appendTo(root);

            for (var i = 0, item; item = json[i++];) {
                if (utils.isString(item)) $(utils.replaceTpl(textTpl, { text: item })).appendTo(content);
                else {
                    var ui = $(utils.replaceTpl(itemTpl, item)).appendTo(content);
                    if (item.options) {
                        item.ui = $('<select style="width:200px;"></select>').appendTo(ui);
                        for (var j = 0, ji; ji = item.options[j++];) {
                            item.ui.append(utils.replaceTpl('<option value="{value}">{text}</option>', ji));
                        }
                    } else if (item.label) {
                        ui.append(item.label);
                    } else {
                        item.ui = $('<input style="width:200px;"/>').appendTo(ui);
                    }
                    if (item.value) item.ui.val(item.value);
                }
            }

            box.foot = $(footTpl).appendTo(root);
            setPosition(root);
            var buttons = [{
                text: '[ 确定 ]',
                click: function () {
                    for (var i = 0, item; item = json[i++];) {
                        if (item.ui) item.value = item.ui.val();
                    }
                    if (callback) callback(json);
                    box.remove();
                }
            }, {
                text: '[ 取消 ]',
                click: function () {
                    box.remove();
                }
            }
            ];
            box.foot.iwfToolBar({ data: buttons });
            return box;
        }
    };

    me.commands['alert'] = {
        execCommand: function (key, text, callback) {
            var temp = $('<div id="alertdialg" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">'
                + '<div class="modal-dialog modal-sm">'
                + '<div class="modal-content">'
                + '<div class="modal-header">'
                + '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
                + '<h4 class="modal-title">系统提示</h4>'
                + '</div>'
                + '<div class="modal-body"></div>'
                + '</div>'
                + '</div>'
                + '</div>').appendTo('body').on('hidden.bs.modal', function (e) {
                    temp.remove();
                });

            temp.find('.modal-body').text(text);
            temp.modal();
        }
    };

    me.commands['confirm'] = {
        execCommand: function (key, text, callback) {

            var temp = $('<div id="confirmdialg" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">'
                + '<div class="modal-dialog modal-md">'
                + '<div class="modal-content">'
                + '<div class="modal-header">'
                + '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
                + '<h4 class="modal-title">系统提示</h4>'
                + '</div>'
                + '<div class="modal-body"></div>'
                + '<div class="modal-footer">'
                + '<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>'
                + '<button type="button" class="btn btn-primary">保存</button>'
                + '</div>'
                + '</div>'
                + '</div>'
                + '</div>').appendTo('body').on('hidden.bs.modal', function (e) {
                    temp.remove();
                });
            temp.find('.modal-body').text(text);
            temp.modal();
            return temp;
        }
    };
};
﻿IWF.plugins['navmenus'] = function () {

    var me = this;

    var navMenus = [
    	{
          icon: '', title: '', color: '', a: '', b: '', key: '', perm: '',
      	},
        { icon: 'fa fa-tasks', title: '样板', color: 'icon-blue', a: 'skin', b: 'skinlist', key: 'skin', perm: 'sysadm', needPlatformVersion: true },
        {
            icon: 'fa fa-gears', title: '设置', color: 'icon-green', a: '', b: '', key: 'config', perm: '',
            subMenus: [
                { icon: 'fa fa-cog', color: 'icon-red', title: '网站设置', a: 'config', b: 'configsite', perm: 'siteadm' }
                , { icon: 'fa fa-navicon ', color: 'icon-red', title: '网站导航', a: 'config', b: 'configmenu', perm: 'sysadm' }
                , { icon: 'fa fa-key', color: 'icon-blue', title: '管理员列表', a: 'config', b: 'listadmin', perm: 'siteadm' }
                , { icon: 'fa fa-key', color: 'icon-blue', title: '修改密码', a: 'config', b: 'editadminpass', perm: '' }
                , { icon: 'fa fa-group', color: 'icon-green', title: '在线客服', a: 'config', b: 'onlineIM', perm: 'siteadm' }
                , { icon: 'fa fa-link', color: 'icon-yellow', title: '友情链接', a: 'config', b: 'friendlinks', perm: 'siteadm' }
                , { icon: 'fa fa-refresh', color: 'icon-red', title: '更新授权', a: 'config', b: 'license', perm: 'sysadm' }
                , { icon: 'fa fa-cloud', color: 'icon-yellow', title: '网站备份', a: 'config', b: 'backuplist', perm: 'sysadm', needPlatformVersion: true }
                , { icon: 'fa fa-database', color: 'icon-yellow', title: '导出网站', a: 'config', b: 'export', perm: 'sysadm', licensePerm: 'ENABLE_EXPORT_WEBSITE', needPlatformVersion: true }
            ]
        },
        
        {
            icon: 'fa fa-file-text', title: '文章', color: 'icon-blue', a: 'news', b: 'newslist', key: 'news', perm: 'articleadm',
            subMenus: [
                { icon: 'fa fa-list-ul', color: 'icon-red', title: '文章列表', a: 'news', b: 'newslist', perm: 'articleadm' }
		        , { icon: 'fa fa-list-alt', color: 'icon-blue', title: '文章分类', a: 'news', b: 'newsclass', perm: 'articleadm' }
                , { icon: 'fa fa-plus', color: 'icon-red', title: '添加文章', a: 'news', b: 'newsedit', perm: 'articleadm' }
            ]
        },
        {
            icon: 'fa  fa-cubes', title: '产品', color: 'icon-blue', a: 'business', b: 'productlist', key: 'product', perm: 'productadm',
            subMenus: [
                { icon: 'fa fa-list-ul', color: 'icon-blue', title: '产品列表', a: 'business', b: 'productlist', perm: 'productadm' }
                , { icon: 'fa fa-inbox', color: 'icon-blue', title: '店铺产品列表', a: 'business', b: 'productstorylist', perm: 'sysadm', licensePerm: 'ENABLE_AGENT'}
                , { icon: 'fa fa-list-alt', color: 'icon-red', title: '产品分类', a: 'business', b: 'productclass', perm: 'productadm' }
                , { icon: 'fa fa-plus', color: 'icon-yellow', title: '添加产品', a: 'business', b: 'productedit', perm: 'productadm' }
                , { icon: 'fa fa-comments', color: 'icon-blue', title: '产品评论', a: 'business', b: 'productcomment', perm: 'productadm' }
                , { icon: 'fa fa-cog', color: 'icon-blue', title: '产品参数', a: 'business', b: 'productparams', perm: 'siteadm' }
                , { icon: 'fa fa-tags', color: 'icon-blue', title: '产品标签', a: 'business', b: 'productlabel', perm: 'siteadm' }
				, { icon: 'fa fa-paint-brush', color: 'icon-blue', title: '产品详情样式', a: 'business', b: 'productstyle', perm: 'sysadm' }
				
            ]
        },
        {
            icon: 'fa fa-share-alt', title: '分销', color: 'icon-blue', a: 'business', b: 'tichengreview', key: 'fenxiao', perm: 'fenxiaoadm', licensePerm: 'ENABLE_FENXIAO',
            subMenus: [
                { icon: 'fa fa-cc', color: 'icon-blue', title: '分销提成审核', a: 'business', b: 'tichengreview', perm: 'fenxiaoadm', licensePerm: 'ENABLE_FENXIAO' }
                ,{ icon: 'fa fa-cc', color: 'icon-blue', title: '店铺分销提成审核', a: 'business', b: 'storetichengreview', perm: 'fenxiaoadm', licensePerm: 'ENABLE_AGENT' }
                , { icon: 'fa fa-money', color: 'icon-blue', title: '提现记录', a: 'business', b: 'tixianlist', perm: 'fenxiaoadm', licensePerm: 'ENABLE_FENXIAO' }
            ]
        },
        {
            icon: 'fa fa-user', title: '会员', color: 'icon-blue', a: 'business', b: 'userlist', key: 'user', perm: 'useradm',
            subMenus: [
                { icon: 'fa fa-user', color: 'icon-blue', title: '会员管理', a: 'business', b: 'userlist', perm: 'useradm' }
                , { icon: 'fa fa-comment', color: 'icon-red', title: '消息管理', a: 'business', b: 'usermsglist', perm: 'useradm' }
                , { icon: 'fa fa-plus', color: 'icon-yellow', title: '添加会员', a: 'business', b: 'useredit', perm: 'useradm' }
            ]
        },
        {
            icon: 'fa fa-calendar', title: '订单', color: 'icon-blue', a: 'business', b: 'orderlist', key: 'order', perm: 'orderadm', licensePerm: 'ENABLE_SHOP',
            subMenus: [
                { icon: 'fa fa-calendar', color: 'icon-blue', title: '订单管理', a: 'business', b: 'orderlist', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
                ,{ icon: 'fa fa-truck', color: 'icon-blue', title: '退款管理', a: 'business', b: 'refundslist', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
                , { icon: 'fa fa-pie-chart', color: 'icon-blue', title: '商城统计', a: 'business', b: 'shopstatistics', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
            ]
        },
        { icon: 'fa fa-money', color: 'icon-blue', title: '财务', a: 'business', b: 'financelist', perm: 'financeadm', licensePerm: 'ENABLE_SHOP' 
        },
        {
            icon: 'fa fa-inbox', title: '功能', color: 'icon-blue', a: '', b: '', key: 'otherfeatures', perm: 'siteadm',
            subMenus: [
                { icon: 'fa fa-table', color: 'icon-green', title: '自定义表单管理', a: 'form', b: 'formlist', perm: 'siteadm' }
                , { icon: 'fa fa-picture-o', color: 'icon-red', title: '相册管理', a: 'business', b: 'sitegallerylist', perm: 'siteadm' }
                , { icon: 'fa fa-comments', color: 'icon-red', title: '留言管理', a: 'business', b: 'messagelist', perm: 'siteadm' }
                , { icon: 'fa fa-download', color: 'icon-red', title: '下载管理', a: 'business', b: 'downloadlist', perm: 'siteadm' }
                , { icon: 'fa fa-bar-chart', color: 'icon-red', title: '流量统计', a: 'flow', b: 'flowrecord', perm: 'siteadm' }
                , { icon: 'fa fa-folder-open', color: 'icon-red', title: '文件管理', a: 'config', b: 'foldermanage', perm: 'siteadm' }
            ]
        },
        { icon: 'fa fa-bullhorn', title: '推广', color: 'icon-blue', a: 'seo', b: 'seoengin', key: 'tuiguang', perm: 'siteadm', licensePerm: 'ENABLE_SEO' }
    ];

    var contentNavMenus = [
         [
            { title: '网站设置', a: 'config', b: 'configsite', perm: 'siteadm' }
            , { title: '文章设置', a: 'news', b: 'newsconfig', perm: 'siteadm' }
            , { title: '商城设置', a: 'business', b: 'shoppingmallconfig', perm: 'siteadm', licensePerm: 'ENABLE_SHOP' }
            , { title: '分销设置', a: 'business', b: 'shopconfig', perm: 'siteadm', licensePerm: 'ENABLE_FENXIAO' }
            , { title: '会员设置', a: 'business', b: 'userconfig', perm: 'siteadm' }
			 , { title: '优惠券设置', a: 'business', b: 'couponlist', perm: 'siteadm',licensePerm: 'ENABLE_SHOP' }
		   , { title: '优惠券新增/修改', a: 'business', b: 'couponedit', perm: 'siteadm',licensePerm: 'ENABLE_SHOP',hide:true }
            , { title: '积分设置', a: 'business', b: 'jifenconfig', perm: 'siteadm', licensePerm: 'ENABLE_SHOP' }
			, { title: '多语言设置', a: 'config', b: 'configlang', perm: 'sysadm', licensePerm: 'ENABLE_MULTI_LANGUAGE' }
            , { title: '伪静态设置', a: 'config', b: 'configrewrite', perm: 'sysadm', licensePerm: 'ENABLE_SEO' }
			, { title: '留言设置', a: 'business', b: 'messageconfig', perm: 'siteadm' }
			, { title: '论坛设置', a: 'business', b: 'bbsconfig', perm: 'siteadm' }
         ]
        , [
            { title: '管理员列表', a: 'config', b: 'listadmin', perm: 'siteadm' }
            , { title: '新增/修改管理员', a: 'config', b: 'editadmin', perm: 'siteadm' }
            , { title: '修改密码', a: 'config', b: 'editadminpass', perm: '' }
        ]
        , [
            { title: '店铺管理', a: 'o2o', b: 'storemanage', perm: 'storeadm', licensePerm: 'ENABLE_AGENT'}
            ,{title: '代理设置', a: 'o2o', b: 'o2oagentconfig', perm: 'siteadm', licensePerm: 'ENABLE_AGENT'}
            ,{ title: '商家入驻设置', a: 'o2o', b: 'o2oconfig', perm: 'siteadm', licensePerm: 'ENABLE_UPLOAD_PRODUCT'}
        ]
        , [
            { title: '文章列表', a: 'news', b: 'newslist', perm: 'articleadm' }
            , { title: '文章分类', a: 'news', b: 'newsclass', perm: 'articleadm' }
            , { title: '新增/修改文章', a: 'news', b: 'newsedit', perm: 'articleadm' }
        ]
        , [
            { title: '产品列表', a: 'business', b: 'productlist', perm: 'productadm' }
            , { title: '店铺产品列表', a: 'business', b: 'productstorylist', perm: 'sysadm', licensePerm: 'ENABLE_AGENT'}
            , { title: '产品分类', a: 'business', b: 'productclass', perm: 'productadm' }
            , { title: '新增/修改产品', a: 'business', b: 'productedit', perm: 'productadm' }
            , { title: '批量添加', a: 'business', b: 'productbatadd', perm: 'productadm' }
            , { title: '产品评论', a: 'business', b: 'productcomment', perm: 'productadm' }
            , { title: '产品参数', a: 'business', b: 'productparams', perm: 'siteadm' }
            , { title: '产品标签', a: 'business', b: 'productlabel', perm: 'siteadm' }
            , { title: '产品详情样式', a: 'business', b: 'productstyle', perm: 'sysadm' }
        ]
        , [
            { title: '分销提成审核', a: 'business', b: 'tichengreview', perm: 'fenxiaoadm', licensePerm: 'ENABLE_FENXIAO' }
            , { title: '店铺分销提成审核', a: 'business', b: 'storetichengreview', perm: 'fenxiaoadm', licensePerm: 'ENABLE_AGENT' }
            , { title: '提现记录', a: 'business', b: 'tixianlist', perm: 'fenxiaoadm', licensePerm: 'ENABLE_FENXIAO' }
        ]
        , [
            { title: '会员管理', a: 'business', b: 'userlist', perm: 'useradm' }        
            , { title: '新增/修改会员', a: 'business', b: 'useredit', perm: 'useradm' }
			, { title: '消息管理', a: 'business', b: 'usermsglist', perm: 'useradm' }
			, { title: '新增/修改消息', a: 'business', b: 'usermsgedit', perm: 'useradm' }
        ]
        , [
            { title: '订单管理', a: 'business', b: 'orderlist', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
            , { title: '退款管理', a: 'business', b: 'refundslist', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
        ]
        , [
           	{ title: '商城统计', a: 'business', b: 'shopstatistics', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
            , { title: '销售统计', a: 'business', b: 'salesstatistics', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
        ]
        , [
            { title: '财务管理', a: 'business', b: 'financelist', perm: 'financeadm', licensePerm: 'ENABLE_SHOP' }
        ]
        , [
            { title: '访问记录', a: 'flow', b: 'flowrecord', perm: 'siteadm' }
            , { title: '日统计', a: 'flow', b: 'flowday', perm: 'siteadm' }
            , { title: '月统计', a: 'flow', b: 'flowmonth', perm: 'siteadm' }
            , { title: '浏览器统计', a: 'flow', b: 'flowbrowser', perm: 'siteadm' }
            , { title: '地区统计', a: 'flow', b: 'flowarea', perm: 'siteadm' }
            , { title: '来源统计', a: 'flow', b: 'flowsource', perm: 'siteadm' }
            , { title: '计数器设置', a: 'flow', b: 'counter', perm: 'siteadm' }
        ]
        , [
            { title: '下载管理', a: 'business', b: 'downloadlist', perm: 'siteadm' }
            , { title: '添加/修改下载', a: 'business', b: 'downloadedit', perm: 'siteadm' }
            , { title: '下载分类', a: 'business', b: 'downloadclass', perm: 'siteadm' }
        ]
        , [
            { title: '公众号绑定', a: 'weixin', b: 'wxconfig', perm: 'configwx' }
            , { title: '自定义菜单', a: 'weixin', b: 'wxmenu', perm: 'wxadm' }
            , { title: '自动回复', a: 'weixin', b: 'wxreply', perm: 'wxadm' }
            , { title: '关键词回复', a: 'weixin', b: 'wxkeyword', hide: true, perm: 'wxadm' }
            , { title: '群发管理', a: 'weixin', b: 'wxgroupsend', perm: 'wxadm' }
            , { title: '素材管理', a: 'weixin', b: 'wxnewslist', perm: 'wxadm' }
            , { title: '粉丝管理', a: 'weixin', b: 'wxuserlist', perm: 'wxadm' }
            , { title: '消息管理', a: 'weixin', b: 'wxmsglist', perm: 'wxadm' }
            , { title: '消息通知', a: 'weixin', b: 'wxtemplate', perm: 'wxadm' }
        ]
        , [
            { title: 'APP管理', a: 'app', b: 'applist', perm: 'appadm', needPlatformVersion: true }
            , { title: '添加/修改App', a: 'app', b: 'appedit', perm: 'appadm' }
        ]
		, [
			{ title: '网站导航', a: 'config', b: 'configmenu', perm: 'sysadm' },
			{ title: '添加/修改导航', a: 'config', b: 'editmenu', perm: 'sysadm' }
		]
		, [
			{ title: '留言列表', a: 'business', b: 'messagelist', perm: 'siteadm' },
			{ title: '留言修改', a: 'business', b: 'messageedit', perm: 'siteadm' }
		]
		, [
			{ title: '自定义表单列表', a: 'form', b: 'formlist', perm: 'siteadm' },
			{ title: '添加/修改自定义表单', a: 'form', b: 'formedit', perm: 'siteadm' },
			{ title: '添加/修改自定义表单字段', a: 'form', b: 'fieldedit', perm: 'siteadm', hide: true },
			{ title: '自定义表单记录', a: 'form', b: 'formlog', perm: 'siteadm', hide: true }
		]
		, [
			{ title: '相册列表', a: 'business', b: 'sitegallerylist', perm: 'siteadm' },
			{ title: '添加/修改相册', a: 'business', b: 'sitegalleryedit', perm: 'siteadm' }
		]
		, [
			{ title: '友情链接', a: 'config', b: 'friendlinks', perm: 'siteadm' },
			{ title: '添加/修改友情链接', a: 'config', b: 'editlink', perm: 'siteadm' }

		]
	
    ];

    var navMobileMenus = [
    	{
          icon: '', title: '', color: '', a: '', b: '', key: '', perm: '',
     	},	
        {
          icon: 'fa fa-mobile', title: '微官网', color: 'icon-green', a: '', b: '', key: 'config', perm: 'siteadm',
          subMenus: [
            { icon: 'fa fa-tasks', color: 'icon-blue', title: '选择样板', a: 'skin', b: 'skinlist', perm: 'sysadm', needPlatformVersion: true }
            , { icon: 'fa fa-cog', color: 'icon-red', title: '网站设置', a: 'config', b: 'configsite', perm: 'siteadm' }
			, { icon: 'fa fa-navicon (alias)', color: 'icon-red', title: '网站导航', a: 'config', b: 'configmenu', perm: 'sysadm' }
            , { icon: 'fa fa-key', color: 'icon-blue', title: '管理员列表', a: 'config', b: 'listadmin', perm: 'siteadm' }
            , { icon: 'fa fa-key', color: 'icon-blue', title: '修改密码', a: 'config', b: 'editadminpass', perm: '' }
            , { icon: 'fa fa-comments', color: 'icon-red', title: '留言管理', a: 'business', b: 'messagelist', perm: 'siteadm' }
            , { icon: 'fa fa-table', color: 'icon-green', title: '自定义表单管理', a: 'form', b: 'formlist', perm: 'siteadm' }
            , { icon: 'fa fa-cloud', color: 'icon-yellow', title: '网站备份', a: 'config', b: 'backuplist', perm: 'sysadm', needPlatformVersion: true }
            , { icon: 'fa fa-database', color: 'icon-yellow', title: '导出网站', a: 'config', b: 'export', perm: 'sysadm', licensePerm: 'ENABLE_EXPORT_WEBSITE', needPlatformVersion: true }
          ]
      },
      {
          icon: 'fa fa-shopping-cart', title: '店掌柜', color: 'icon-blue', a: 'o2o', b: 'storemanage', perm: 'storeadm', key: 'o2o', licensePerm: 'ENABLE_AGENT',
          subMenus: [
              {icon: 'fa fa-shopping-cart', title: '店铺管理', color: 'icon-blue', a: 'o2o', b: 'storemanage', perm: 'storeadm' , licensePerm: 'ENABLE_AGENT'}
              ,{icon: 'fa fa-share-alt', title: '代理设置', color: 'icon-blue', a: 'o2o', b: 'o2oagentconfig', perm: 'siteadm', licensePerm: 'ENABLE_AGENT'}
              ,{icon: 'fa fa-cog', title: '商家入驻设置', color: 'icon-blue', a: 'o2o', b: 'o2oconfig', perm: 'siteadm', licensePerm: 'ENABLE_UPLOAD_PRODUCT'}
          ]
      },
      {
          icon: 'fa fa-weixin', title: '公众号', color: 'icon-blue', a: '', b: '', key: 'weixin', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN',
          subMenus: [
              { icon: 'fa fa-lock', color: 'icon-red', title: '公众号绑定', a: 'weixin', b: 'wxconfig', perm: 'configwx', licensePerm: 'ENABLE_WEIXIN' }
              , { icon: 'fa fa-align-left', color: 'icon-blue', title: '自定义菜单', a: 'weixin', b: 'wxmenu', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN' }
              , { icon: 'fa fa-send (alias)', color: 'icon-red', title: '自动回复', a: 'weixin', b: 'wxreply', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN' }
              , { icon: 'fa fa-send-o (alias)', color: 'icon-red', title: '群发管理', a: 'weixin', b: 'wxgroupsend', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN' }
              , { icon: 'fa fa-newspaper-o', color: 'icon-red', title: '素材管理', a: 'weixin', b: 'wxnewslist', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN' }
              , { icon: 'fa fa-star', color: 'icon-red', title: '粉丝管理', a: 'weixin', b: 'wxuserlist', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN' }
              , { icon: 'fa fa-comment', color: 'icon-red', title: '消息管理', a: 'weixin', b: 'wxmsglist', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN' }
              , { icon: 'fa fa-comments-o', color: 'icon-red', title: '消息通知', a: 'weixin', b: 'wxtemplate', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN' }
          ]
      },
      {
          icon: 'fa fa-book', title: '微营销', color: 'icon-blue', a: 'weixy', b: 'lucknew', key: 'weixy', perm: 'wyxadm', licensePerm: 'ENABLE_WEIXIN'
      },
      {
          icon: 'fa fa-file-text', title: '文章', color: 'icon-blue', a: 'news', b: 'newslist', key: 'news', perm: 'articleadm',
          subMenus: [
              { icon: 'fa fa-list-ul', color: 'icon-red', title: '文章列表', a: 'news', b: 'newslist', perm: 'articleadm' }
              , { icon: 'fa fa-list-alt', color: 'icon-blue', title: '文章分类', a: 'news', b: 'newsclass', perm: 'articleadm' }
              , { icon: 'fa fa-plus', color: 'icon-red', title: '添加文章', a: 'news', b: 'newsedit', perm: 'articleadm' }
          ]
      },
      {
          icon: 'fa fa-cubes', title: '产品', color: 'icon-blue', a: 'business', b: 'productlist', key: 'product', perm: 'productadm',
          subMenus: [
              { icon: 'fa fa-list-ul', color: 'icon-blue', title: '产品列表', a: 'business', b: 'productlist', perm: 'productadm' }
              , { icon: 'fa fa-inbox', color: 'icon-blue', title: '店铺产品列表', a: 'business', b: 'productstorylist', perm: 'sysadm', licensePerm: 'ENABLE_AGENT'}
              , { icon: 'fa fa-list-alt', color: 'icon-red', title: '产品分类', a: 'business', b: 'productclass', perm: 'productadm' }
              , { icon: 'fa fa-plus', color: 'icon-blue', title: '添加产品', a: 'business', b: 'productedit', perm: 'productadm' }
              , { icon: 'fa fa-comments', color: 'icon-blue', title: '产品评论', a: 'business', b: 'productcomment', perm: 'productadm' }
              , { icon: 'fa fa-cog', color: 'icon-blue', title: '产品参数', a: 'business', b: 'productparams', perm: 'siteadm' }
              , { icon: 'fa fa-tags', color: 'icon-blue', title: '产品标签', a: 'business', b: 'productlabel', perm: 'siteadm' }
              , { icon: 'fa fa-paint-brush', color: 'icon-blue', title: '产品详情样式', a: 'business', b: 'productstyle', perm: 'sysadm' }
          ]
      },
      {
          icon: 'fa fa-share-alt', title: '分销', color: 'icon-blue', a: 'business', b: 'tichengreview', key: 'fenxiao', perm: 'fenxiaoadm', licensePerm: 'ENABLE_FENXIAO',
          subMenus: [
              { icon: 'fa fa-cc', color: 'icon-blue', title: '分销提成审核', a: 'business', b: 'tichengreview', perm: 'fenxiaoadm', licensePerm: 'ENABLE_FENXIAO' }
              ,{ icon: 'fa fa-cc', color: 'icon-blue', title: '店铺分销提成审核', a: 'business', b: 'storetichengreview', perm: 'fenxiaoadm', licensePerm: 'ENABLE_AGENT' }
              , { icon: 'fa fa-money', color: 'icon-blue', title: '提现记录', a: 'business', b: 'tixianlist', perm: 'fenxiaoadm', licensePerm: 'ENABLE_FENXIAO' }
          ]
      },
      {
          icon: 'fa fa-user', title: '会员', color: 'icon-blue', a: 'business', b: 'userlist', key: 'user', perm: 'useradm',
          subMenus: [
              { icon: 'fa fa-user', color: 'icon-blue', title: '会员管理', a: 'business', b: 'userlist', perm: 'useradm' }
              , { icon: 'fa fa-comments', color: 'icon-red', title: '消息管理', a: 'business', b: 'usermsglist', perm: 'useradm' }
              , { icon: 'fa fa-plus', color: 'icon-yellow', title: '添加会员', a: 'business', b: 'useredit', perm: 'useradm' }
          ]
      },
      {
          icon: 'fa fa-calendar', title: '订单', color: 'icon-blue', a: 'business', b: 'orderlist', key: 'order', perm: 'orderadm', licensePerm: 'ENABLE_SHOP',
          subMenus: [
              { icon: 'fa fa-calendar', color: 'icon-blue', title: '订单管理', a: 'business', b: 'orderlist', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
              , { icon: 'fa fa-truck', color: 'icon-blue', title: '退款管理', a: 'business', b: 'refundslist', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
              , { icon: 'fa fa-pie-chart', color: 'icon-blue', title: '商城统计', a: 'business', b: 'shopstatistics', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
          ]
      },
      {
         icon: 'fa fa-money', color: 'icon-blue', title: '财务', a: 'business', b: 'financelist', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' 
      },
      {
          icon: 'fa fa-apple', title: 'APP', color: 'icon-blue', a: 'app', b: 'applist', key: 'app', perm: 'appadm', needPlatformVersion: true
      },
      {
            icon: 'fa fa-inbox', title: '功能', color: 'icon-blue', a: '', b: '', key: 'otherfeatures', perm: 'siteadm',
            subMenus: [
                { icon: 'fa fa-table', color: 'icon-green', title: '自定义表单管理', a: 'form', b: 'formlist', perm: 'siteadm' }
                , { icon: 'fa fa-picture-o', color: 'icon-red', title: '相册管理', a: 'business', b: 'sitegallerylist', perm: 'siteadm' }
                , { icon: 'fa fa-comments', color: 'icon-red', title: '留言管理', a: 'business', b: 'messagelist', perm: 'siteadm' }
                , { icon: 'fa fa-folder-open', color: 'icon-red', title: '文件管理', a: 'config', b: 'foldermanage', perm: 'siteadm' }
            ]
        },
      {
          icon: 'fa fa-bullhorn', title: '推广', color: 'icon-blue', a: 'seo', b: 'seoengin', key: 'tuiguang', perm: 'siteadm', licensePerm: 'ENABLE_SEO'
      }
    ];
	
	var navMenus2 = [
		 {
          icon: '', title: '', color: '', a: '', b: '', key: '', perm: '',
     	 },
        { 
        	icon: 'fa fa-tasks', title: '商城装修', color: 'icon-blue', a: 'skin', b: 'skinlist', key: 'skin', perm: 'sysadm' ,
            subMenus: [
                { icon: 'fa fa-tasks', color: 'icon-blue', title: '选择样板', a: 'skin', b: 'skinlist', perm: 'sysadm', needPlatformVersion: true }
            	,{icon: 'fa fa-cog', color: 'icon-red', title: '商城设置', a: 'config', b: 'configsite', perm: 'siteadm' }
                , { icon: 'fa fa-navicon ', color: 'icon-red', title: '商城导航', a: 'config', b: 'configmenu', perm: 'sysadm' }
                , { icon: 'fa fa-key', color: 'icon-blue', title: '管理员列表', a: 'config', b: 'listadmin', perm: 'siteadm' }
                , { icon: 'fa fa-key', color: 'icon-blue', title: '修改密码', a: 'config', b: 'editadminpass', perm: '' }
                , { icon: 'fa fa-group', color: 'icon-green', title: '在线客服', a: 'config', b: 'onlineIM', perm: 'siteadm' }
                , { icon: 'fa fa-link', color: 'icon-yellow', title: '友情链接', a: 'config', b: 'friendlinks', perm: 'siteadm' }
                , { icon: 'fa fa-refresh', color: 'icon-red', title: '更新授权', a: 'config', b: 'license', perm: 'sysadm' }
                , { icon: 'fa fa-cloud', color: 'icon-yellow', title: '商城备份', a: 'config', b: 'backuplist', perm: 'sysadm', needPlatformVersion: true }
                , { icon: 'fa fa-database', color: 'icon-yellow', title: '导出网站', a: 'config', b: 'export', perm: 'sysadm', licensePerm: 'ENABLE_EXPORT_WEBSITE', needPlatformVersion: true }
            ]
        },
        {
            icon: 'fa fa-file-text', title: '文章', color: 'icon-blue', a: 'news', b: 'newslist', key: 'news', perm: 'articleadm',
            subMenus: [
                { icon: 'fa fa-list-ul', color: 'icon-red', title: '文章列表', a: 'news', b: 'newslist', perm: 'articleadm' }
		        , { icon: 'fa fa-list-alt', color: 'icon-blue', title: '文章分类', a: 'news', b: 'newsclass', perm: 'articleadm' }
                , { icon: 'fa fa-plus', color: 'icon-red', title: '添加文章', a: 'news', b: 'newsedit', perm: 'articleadm' }
            ]
        },
        {
            icon: 'fa  fa-cubes', title: '产品', color: 'icon-blue', a: 'business', b: 'productlist', key: 'product', perm: 'productadm',
            subMenus: [
                { icon: 'fa fa-list-ul', color: 'icon-blue', title: '产品列表', a: 'business', b: 'productlist', perm: 'productadm' }
                , { icon: 'fa fa-inbox', color: 'icon-blue', title: '店铺产品列表', a: 'business', b: 'productstorylist', perm: 'sysadm', licensePerm: 'ENABLE_AGENT' }
                , { icon: 'fa fa-list-alt', color: 'icon-red', title: '产品分类', a: 'business', b: 'productclass', perm: 'productadm' }
                , { icon: 'fa fa-plus', color: 'icon-yellow', title: '添加产品', a: 'business', b: 'productedit', perm: 'productadm' }
                , { icon: 'fa fa-comments', color: 'icon-blue', title: '产品评论', a: 'business', b: 'productcomment', perm: 'productadm' }
                , { icon: 'fa fa-cog', color: 'icon-blue', title: '产品参数', a: 'business', b: 'productparams', perm: 'siteadm' }
                , { icon: 'fa fa-tags', color: 'icon-blue', title: '产品标签', a: 'business', b: 'productlabel', perm: 'siteadm' }
				, { icon: 'fa fa-paint-brush', color: 'icon-blue', title: '产品详情样式', a: 'business', b: 'productstyle', perm: 'sysadm' }
				
            ]
        },
        {
            icon: 'fa fa-share-alt', title: '分销', color: 'icon-blue', a: 'business', b: 'tichengreview', key: 'fenxiao', perm: 'fenxiaoadm', licensePerm: 'ENABLE_FENXIAO',
            subMenus: [
                { icon: 'fa fa-cc', color: 'icon-blue', title: '分销提成审核', a: 'business', b: 'tichengreview', perm: 'fenxiaoadm', licensePerm: 'ENABLE_FENXIAO' }
                ,                { icon: 'fa fa-cc', color: 'icon-blue', title: '店铺分销提成审核', a: 'business', b: 'storetichengreview', perm: 'fenxiaoadm', licensePerm: 'ENABLE_AGENT' }
                , { icon: 'fa fa-money', color: 'icon-blue', title: '提现记录', a: 'business', b: 'tixianlist', perm: 'fenxiaoadm', licensePerm: 'ENABLE_FENXIAO' }
            ]
        },
        {
            icon: 'fa fa-user', title: '会员', color: 'icon-blue', a: 'business', b: 'userlist', key: 'user', perm: 'useradm',
            subMenus: [
                { icon: 'fa fa-user', color: 'icon-blue', title: '会员管理', a: 'business', b: 'userlist', perm: 'useradm' }
                , { icon: 'fa fa-comment', color: 'icon-red', title: '消息管理', a: 'business', b: 'usermsglist', perm: 'useradm' }
                , { icon: 'fa fa-plus', color: 'icon-yellow', title: '添加会员', a: 'business', b: 'useredit', perm: 'useradm' }
            ]
        },
        {
            icon: 'fa fa-calendar', title: '订单', color: 'icon-blue', a: 'business', b: 'orderlist', key: 'order', perm: 'orderadm', licensePerm: 'ENABLE_SHOP',
            subMenus: [
                { icon: 'fa fa-calendar', color: 'icon-blue', title: '订单管理', a: 'business', b: 'orderlist', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
                ,{ icon: 'fa fa-truck', color: 'icon-blue', title: '退款管理', a: 'business', b: 'refundslist', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
                , { icon: 'fa fa-pie-chart', color: 'icon-blue', title: '商城统计', a: 'business', b: 'shopstatistics', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
            ]
        },
        { icon: 'fa fa-money', color: 'icon-blue', title: '财务', a: 'business', b: 'financelist', perm: 'financeadm', licensePerm: 'ENABLE_SHOP' 
        },
        {
            icon: 'fa fa-inbox', title: '功能', color: 'icon-blue', a: '', b: '', key: 'otherfeatures', perm: 'siteadm',
            subMenus: [
                { icon: 'fa fa-table', color: 'icon-green', title: '自定义表单管理', a: 'form', b: 'formlist', perm: 'siteadm' }
                , { icon: 'fa fa-picture-o', color: 'icon-red', title: '相册管理', a: 'business', b: 'sitegallerylist', perm: 'siteadm' }
                , { icon: 'fa fa-comments', color: 'icon-red', title: '留言管理', a: 'business', b: 'messagelist', perm: 'siteadm' }
                , { icon: 'fa fa-download', color: 'icon-red', title: '下载管理', a: 'business', b: 'downloadlist', perm: 'siteadm' }
                , { icon: 'fa fa-bar-chart', color: 'icon-red', title: '流量统计', a: 'flow', b: 'flowrecord', perm: 'siteadm' }
                , { icon: 'fa fa-folder-open', color: 'icon-red', title: '文件管理', a: 'config', b: 'foldermanage', perm: 'siteadm' }
            ]
        },
        { icon: 'fa fa-bullhorn', title: '推广', color: 'icon-blue', a: 'seo', b: 'seoengin', key: 'tuiguang', perm: 'siteadm', licensePerm: 'ENABLE_SEO' }
    ];
	
	var navMobileMenus2 = [
      {
          icon: '', title: '', color: '', a: '', b: '', key: '', perm: '',
      },
      {
          icon: 'fa fa-mobile', title: '商城装修', color: 'icon-green', a: '', b: '', key: 'config', perm: 'siteadm',
          subMenus: [
            { icon: 'fa fa-tasks', color: 'icon-blue', title: '选择样板', a: 'skin', b: 'skinlist', key: 'skin', perm: 'sysadm', needPlatformVersion: true }
            , { icon: 'fa fa-cog', color: 'icon-red', title: '商城设置', a: 'config', b: 'configsite', perm: 'siteadm' }
			, { icon: 'fa fa-navicon (alias)', color: 'icon-red', title: '商城导航', a: 'config', b: 'configmenu', perm: 'sysadm' }
            , { icon: 'fa fa-key', color: 'icon-blue', title: '管理员列表', a: 'config', b: 'listadmin', perm: 'siteadm' }
            , { icon: 'fa fa-key', color: 'icon-blue', title: '修改密码', a: 'config', b: 'editadminpass', perm: '' }
            , { icon: 'fa fa-comments', color: 'icon-red', title: '留言管理', a: 'business', b: 'messagelist', perm: 'siteadm' }
            , { icon: 'fa fa-table', color: 'icon-green', title: '自定义表单管理', a: 'form', b: 'formlist', perm: 'siteadm' }
            , { icon: 'fa fa-cloud', color: 'icon-yellow', title: '商城备份', a: 'config', b: 'backuplist', perm: 'sysadm', needPlatformVersion: true }
            , { icon: 'fa fa-database', color: 'icon-yellow', title: '导出网站', a: 'config', b: 'export', perm: 'sysadm', licensePerm: 'ENABLE_EXPORT_WEBSITE', needPlatformVersion: true }
          ]
      },
      {
          icon: 'fa fa-shopping-cart', title: '店掌柜', color: 'icon-blue', a: 'o2o', b: 'storemanage', perm: 'storeadm', key: 'o2o', licensePerm: 'ENABLE_AGENT',
          subMenus: [
              {icon: 'fa fa-shopping-cart', title: '店铺管理', color: 'icon-blue', a: 'o2o', b: 'storemanage', perm: 'storeadm', licensePerm: 'ENABLE_AGENT'}
              ,{icon: 'fa fa-share-alt', title: '代理设置', color: 'icon-blue', a: 'o2o', b: 'o2oagentconfig', perm: 'siteadm', licensePerm: 'ENABLE_AGENT'}
              ,{icon: 'fa fa-cog', title: '商家入驻设置', color: 'icon-blue', a: 'o2o', b: 'o2oconfig', perm: 'siteadm', licensePerm: 'ENABLE_UPLOAD_PRODUCT'}
          ]
      },
      {
          icon: 'fa fa-weixin', title: '公众号', color: 'icon-blue', a: '', b: '', key: 'weixin', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN',
          subMenus: [
              { icon: 'fa fa-lock', color: 'icon-red', title: '公众号绑定', a: 'weixin', b: 'wxconfig', perm: 'configwx', licensePerm: 'ENABLE_WEIXIN' }
              , { icon: 'fa fa-align-left', color: 'icon-blue', title: '自定义菜单', a: 'weixin', b: 'wxmenu', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN' }
              , { icon: 'fa fa-send (alias)', color: 'icon-red', title: '自动回复', a: 'weixin', b: 'wxreply', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN' }
              , { icon: 'fa fa-send-o (alias)', color: 'icon-red', title: '群发管理', a: 'weixin', b: 'wxgroupsend', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN' }
              , { icon: 'fa fa-newspaper-o', color: 'icon-red', title: '素材管理', a: 'weixin', b: 'wxnewslist', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN' }
              , { icon: 'fa fa-star', color: 'icon-red', title: '粉丝管理', a: 'weixin', b: 'wxuserlist', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN' }
              , { icon: 'fa fa-comment', color: 'icon-red', title: '消息管理', a: 'weixin', b: 'wxmsglist', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN' }
              , { icon: 'fa fa-comments-o', color: 'icon-red', title: '消息通知', a: 'weixin', b: 'wxtemplate', perm: 'wxadm', licensePerm: 'ENABLE_WEIXIN' }
          ]
      },
      
      {
          icon: 'fa fa-book', title: '微营销', color: 'icon-blue', a: 'weixy', b: 'lucknew', key: 'weixy', perm: 'wyxadm', licensePerm: 'ENABLE_WEIXIN'
      },
      {
          icon: 'fa fa-file-text', title: '文章', color: 'icon-blue', a: 'news', b: 'newslist', key: 'news', perm: 'articleadm',
          subMenus: [
              { icon: 'fa fa-list-ul', color: 'icon-red', title: '文章列表', a: 'news', b: 'newslist', perm: 'articleadm' }
              , { icon: 'fa fa-list-alt', color: 'icon-blue', title: '文章分类', a: 'news', b: 'newsclass', perm: 'articleadm' }
              , { icon: 'fa fa-plus', color: 'icon-red', title: '添加文章', a: 'news', b: 'newsedit', perm: 'articleadm' }
          ]
      },
      {
          icon: 'fa fa-cubes', title: '产品', color: 'icon-blue', a: 'business', b: 'productlist', key: 'product', perm: 'productadm',
          subMenus: [
              { icon: 'fa fa-list-ul', color: 'icon-blue', title: '产品列表', a: 'business', b: 'productlist', perm: 'productadm' }
              , { icon: 'fa fa-inbox', color: 'icon-blue', title: '店铺产品列表', a: 'business', b: 'productstorylist', perm: 'sysadm', licensePerm: 'ENABLE_AGENT' }
              , { icon: 'fa fa-list-alt', color: 'icon-red', title: '产品分类', a: 'business', b: 'productclass', perm: 'productadm' }
              , { icon: 'fa fa-plus', color: 'icon-blue', title: '添加产品', a: 'business', b: 'productedit', perm: 'productadm' }
              , { icon: 'fa fa-comments', color: 'icon-blue', title: '产品评论', a: 'business', b: 'productcomment', perm: 'productadm' }
              , { icon: 'fa fa-cog', color: 'icon-blue', title: '产品参数', a: 'business', b: 'productparams', perm: 'siteadm' }
              , { icon: 'fa fa-tags', color: 'icon-blue', title: '产品标签', a: 'business', b: 'productlabel', perm: 'siteadm' }
              , { icon: 'fa fa-paint-brush', color: 'icon-blue', title: '产品详情样式', a: 'business', b: 'productstyle', perm: 'sysadm' }
              
          ]
      },
      {
          icon: 'fa fa-share-alt', title: '分销', color: 'icon-blue', a: 'business', b: 'tichengreview', key: 'fenxiao', perm: 'fenxiaoadm', licensePerm: 'ENABLE_FENXIAO',
          subMenus: [
              { icon: 'fa fa-cc', color: 'icon-blue', title: '分销提成审核', a: 'business', b: 'tichengreview', perm: 'fenxiaoadm', licensePerm: 'ENABLE_FENXIAO' }
              , { icon: 'fa fa-cc', color: 'icon-blue', title: '店铺分销提成审核', a: 'business', b: 'storetichengreview', perm: 'fenxiaoadm', licensePerm: 'ENABLE_AGENT' }
              , { icon: 'fa fa-money', color: 'icon-blue', title: '提现记录', a: 'business', b: 'tixianlist', perm: 'fenxiaoadm', licensePerm: 'ENABLE_FENXIAO' }
          ]
      },
      {
          icon: 'fa fa-user', title: '会员', color: 'icon-blue', a: 'business', b: 'userlist', key: 'user', perm: 'useradm',
          subMenus: [
              { icon: 'fa fa-user', color: 'icon-blue', title: '会员管理', a: 'business', b: 'userlist', perm: 'useradm' }
              , { icon: 'fa fa-comments', color: 'icon-red', title: '消息管理', a: 'business', b: 'usermsglist', perm: 'useradm' }
              , { icon: 'fa fa-plus', color: 'icon-yellow', title: '添加会员', a: 'business', b: 'useredit', perm: 'useradm' }
          ]
      },
      {
          icon: 'fa fa-calendar', title: '订单', color: 'icon-blue', a: 'business', b: 'orderlist', key: 'order', perm: 'orderadm', licensePerm: 'ENABLE_SHOP',
          subMenus: [
              { icon: 'fa fa-calendar', color: 'icon-blue', title: '订单管理', a: 'business', b: 'orderlist', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
              , { icon: 'fa fa-truck', color: 'icon-blue', title: '退款管理', a: 'business', b: 'refundslist', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
              , { icon: 'fa fa-pie-chart', color: 'icon-blue', title: '商城统计', a: 'business', b: 'shopstatistics', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' }
          ]
      },
      {
         icon: 'fa fa-money', color: 'icon-blue', title: '财务', a: 'business', b: 'financelist', perm: 'orderadm', licensePerm: 'ENABLE_SHOP' 
      },
      {
          icon: 'fa fa-apple', title: 'APP', color: 'icon-blue', a: 'app', b: 'applist', key: 'app', perm: 'appadm', needPlatformVersion: true
      },
      {
            icon: 'fa fa-inbox', title: '功能', color: 'icon-blue', a: '', b: '', key: 'otherfeatures', perm: 'siteadm',
            subMenus: [
                { icon: 'fa fa-table', color: 'icon-green', title: '自定义表单管理', a: 'form', b: 'formlist', perm: 'siteadm' }
                , { icon: 'fa fa-picture-o', color: 'icon-red', title: '相册管理', a: 'business', b: 'sitegallerylist', perm: 'siteadm' }
                , { icon: 'fa fa-comments', color: 'icon-red', title: '留言管理', a: 'business', b: 'messagelist', perm: 'siteadm' }
                , { icon: 'fa fa-folder-open', color: 'icon-red', title: '文件管理', a: 'config', b: 'foldermanage', perm: 'siteadm' }
            ]
        },
      {
          icon: 'fa fa-bullhorn', title: '推广', color: 'icon-blue', a: 'seo', b: 'seoengin', key: 'tuiguang', perm: 'siteadm', licensePerm: 'ENABLE_SEO'
      }
    ];


    function checkMenu(obj) {
        if (obj.hide) return false;
        if (typeof(obj.needPlatformVersion) != 'undefined' && me.loginUser.SingleWeb == true && obj.needPlatformVersion == true) return false;
        if (obj.licensePerm == 'ENABLE_EXPORT_WEBSITE' && !me.hasLicensePerm('ENABLE_EXPORT_WEBSITE')) { return false; }
        if ((obj.licensePerm=="ENABLE_AGENT" || obj.licensePerm=='ENABLE_UPLOAD_PRODUCT') && !me.hasLicensePerm(obj.licensePerm)) return false;
        if (!me.hasPerm('SysAdm') && obj.licensePerm && !me.hasLicensePerm(obj.licensePerm)) return false;
        if (obj.perm) {
            var arr = (obj.perm + '').split(',');
            var flag = false;
            if (obj.perm.indexOf('product') >= 0)
                var ff = 11;
            for (var i = 0; i < arr.length; i++) {
                if (me.hasPerm(arr[i])) {
                    flag = true;
                    break;
                }
            }
            if (!flag) return false;
        }
        //if (obj.perm && !me.hasPerm(obj.perm)) return false;
        return true;
    }

    function getElementTopWithBorder(obj) {
        var i = obj.offsetTop + parseFloat($(obj).css('border-top-width'));
        if (obj.offsetParent != null) i += getElementTopWithBorder(obj.offsetParent);
        return i;
    }

    function getElementLeftWithBorder(obj) {
        var i = obj.offsetLeft + parseFloat($(obj).css('border-left-width'));
        if (obj.offsetParent != null) i += getElementLeftWithBorder(obj.offsetParent);
        return i;
    }

    function buildLeftNav(navMenus) {
        var tab = $('#maintab');
        for (var i = 0; i < navMenus.length; i++) {
            if (!checkMenu(navMenus[i])) continue;
			if(navMenus[i].key == 'skin' && me.loginUser.SingleWeb){
				navMenus[i].title = '设置';
				navMenus[i].a = 'config';
				navMenus[i].b = 'configsite';
			}
            tab.append(utils.replaceTpl('<li key="{key}"><div><div class="tabHandle" style="text-align:center" data-toggle="tab" a="{a}" b="{b}" style="cursor:pointer"><i class="{icon} "/><br>{title}</div></div></li>', navMenus[i]));
            if ($.isArray(navMenus[i].subMenus)) {
                var sHtml = '';
                sHtml += '<div class="sidebarNavPanel" owner="' + navMenus[i].key + '">';
                //sHtml += '<div class="titlebar"><div class="title">' + navMenus[i].title + '</div></div>';
                sHtml += '<div class="content"><ul>';
                for (var j = 0; j < navMenus[i].subMenus.length; j++) {
                    if (!checkMenu(navMenus[i].subMenus[j])) continue;
                    sHtml += utils.replaceTpl('<li a="{a}" b="{b}"><a href="javascript:void(0)"><i class="{icon}"></i><span>{title}</span></a></li>', navMenus[i].subMenus[j]);
                }
                sHtml += '</ul></div>';
                sHtml += '</div>';
                sHtml += '</div>';
                $(sHtml).insertAfter('#maintab>li[key=' + navMenus[i].key + ']');
            }
        }

        var leftNavTimeout = {};
        tab.find('li').off('mouseenter').on('mouseenter', function () {
            $(this).addClass('active');
            var key = $(this).attr('key');
            var leftNav = $('.sidebarNavPanel[owner=' + key + ']');

            leftNav.css({
                top: getElementTopWithBorder(this) - 2,
                left: getElementLeftWithBorder(this) + $(this).outerWidth(false),
                height: 'auto'
            })

            if (parseFloat(leftNav.css('top')) + leftNav.outerHeight() >= window.innerHeight) {
                leftNav.css({
                    top: window.innerHeight - leftNav.outerHeight() - 20                   
                });
            }
            if($(".navWrap ul").scrollTop() !=0){
            	leftNav.css({
                    top: getElementTopWithBorder(this) - $(".navWrap ul").scrollTop()
                });
            }

            leftNav.show();
        }).off('mouseleave').on('mouseleave', function () {
            $(this).removeClass('active');
            var key = $(this).attr('key');
            var leftNav = $('.sidebarNavPanel[owner=' + key + ']');
            leftNavTimeout[key] = setTimeout(function () { leftNav.hide(); }, 1);
        }).off('click').on('click', function () {
            var key = $(this).attr('key');
            var leftNav = $('.sidebarNavPanel[owner=' + key + ']');
            var data = { a: $(this).find('.tabHandle').attr("a"), b: $(this).find('.tabHandle').attr("b") };
            if (data.a && data.b) {
                leftNav.hide();
                me.execCommand('go', data);
            }
        });

        $('.sidebarNavPanel').off('mouseenter').on('mouseenter', function () {
            var key = $(this).attr('owner');
            tab.find('li[key=' + key + ']').addClass('active');
            clearTimeout(leftNavTimeout[key]);
            $('.sidebarNavPanel[owner=' + key + ']').show();
        }).off('mouseleave').on('mouseleave', function () {
            var key = $(this).attr('owner');
            tab.find('li[key=' + key + ']').removeClass('active');
            $('.sidebarNavPanel[owner=' + key + ']').hide();
        });

        $('.sidebarNavPanel li').off('click').on('click', function () {
            var data = { a: $(this).attr("a"), b: $(this).attr("b") };
            var key = $(this).closest('.sidebarNavPanel').attr('owner');
            $(this).closest('.sidebarNavPanel').hide();
            me.execCommand('go', data);
        });

        if (getCookie('SiteType') == 1) {
            $('.navWrap').addClass('mobile').show();
            $('.sidebarNavPanel').addClass('mobileSub')
        } else {
            $('.navWrap').addClass('pc').show();
            $('.sidebarNavPanel').addClass('pcSub')
        }
    }
    
    function buildLeftNav2(navMenus) { 
        var tab = $('#maintab');
        for (var i = 0; i < navMenus.length; i++) {
            if (!checkMenu(navMenus[i])) continue;
			if(navMenus[i].key == 'skin' && me.loginUser.SingleWeb){
				navMenus[i].title = '设置';
				navMenus[i].a = 'config';
				navMenus[i].b = 'configsite';
			}
            tab.append(utils.replaceTpl('<li key="{key}"><div class="tabHandle2" style="text-align:center;height:54px;line-height:54px;border-bottom: 1px solid #3a3d42;" data-toggle="tab" a="{a}" b="{b}" style="cursor:pointer"><i style="position: relative;left: 25px;float: left;top: 14px;" class="{icon} "/>{title}<span style="position: relative;float: right;top: 20px;left: -20px;font-size: 18px;" class="glyphicon glyphicon-menu-right"></span></div></li>', navMenus[i]));
            if ($.isArray(navMenus[i].subMenus)) {
                var sHtml = ''; 
                sHtml += '<div class="sidebarNavPanel2" owner="' + navMenus[i].key + '">';
                //sHtml += '<div class="titlebar"><div class="title">' + navMenus[i].title + '</div></div>';
                sHtml += '<div class="content2"><ul>';
                for (var j = 0; j < navMenus[i].subMenus.length; j++) {
                    if (!checkMenu(navMenus[i].subMenus[j])) continue;
                    sHtml += utils.replaceTpl('<li a="{a}" b="{b}"><a href="javascript:void(0)"><i class="{icon}"></i><span>{title}</span></a></li>', navMenus[i].subMenus[j]);
                }
                sHtml += '</ul></div>';
                sHtml += '</div>';
                sHtml += '</div>';
                $(sHtml).insertAfter('#maintab>li[key=' + navMenus[i].key + ']');
            }
        }
        if (getCookie('SiteType') == 1) {
        	$("#maintab>li[key=o2o]>.tabHandle2 span").append('<img class="newimg" style="position: absolute;top: -16px;right: 22px;" src="/images/newicon.png">')
        	if($(".tabHandle2[b='storemanage']").length == 0){
        		$(".newimg").remove();
        	}
       	}
        
        //tabs
        var leftNavTimeout = {};
        tab.find('li').off('mouseenter').on('mouseenter', function () {
            $(this).addClass('active');
            var key = $(this).attr('key');
            var leftNav = $('.sidebarNavPanel2[owner=' + key + ']');

            leftNav.css({
                top: getElementTopWithBorder(this) - 2,
                left: getElementLeftWithBorder(this) + $(this).outerWidth(false),
                height: 'auto'
            })

            if (parseFloat(leftNav.css('top')) + leftNav.outerHeight() >= window.innerHeight) {
                leftNav.css({
                    top: window.innerHeight - leftNav.outerHeight()
                });
            }
            if($(".navWrap ul").scrollTop() !=0){
            	leftNav.css({
                    top: getElementTopWithBorder(this) - $(".navWrap ul").scrollTop()
                });
            }
            

            leftNav.show();
        }).off('mouseleave').on('mouseleave', function () {
            $(this).removeClass('active');
            var key = $(this).attr('key');
            var leftNav = $('.sidebarNavPanel2[owner=' + key + ']');
            leftNavTimeout[key] = setTimeout(function () { leftNav.hide(); }, 1);
        }).off('click').on('click', function () {
            var key = $(this).attr('key');
            var leftNav = $('.sidebarNavPanel2[owner=' + key + ']');
            var data = { a: $(this).find('.tabHandle2').attr("a"), b: $(this).find('.tabHandle2').attr("b") };
            if (data.a && data.b) {
                leftNav.hide();
                me.execCommand('go', data);
            }
        });

        $('.sidebarNavPanel2').off('mouseenter').on('mouseenter', function () {
            var key = $(this).attr('owner');
            tab.find('li[key=' + key + ']').addClass('active');
            clearTimeout(leftNavTimeout[key]);
            $('.sidebarNavPanel2[owner=' + key + ']').show();
        }).off('mouseleave').on('mouseleave', function () {
            var key = $(this).attr('owner');
            tab.find('li[key=' + key + ']').removeClass('active');
            $('.sidebarNavPanel2[owner=' + key + ']').hide();
        });

        $('.sidebarNavPanel2 li').off('click').on('click', function () {
            var data = { a: $(this).attr("a"), b: $(this).attr("b") };
            var key = $(this).closest('.sidebarNavPanel2').attr('owner');
            $(this).closest('.sidebarNavPanel2').hide();
            me.execCommand('go', data);
        });

        if (getCookie('SiteType') == 1) {
            $('.navWrap').addClass('mobile').show();
            $('.sidebarNavPanel2').addClass('mobileSub')
        } else {
            $('.navWrap').addClass('pc').show();
            $('.sidebarNavPanel2').addClass('pcSub')
        }
    }


    // 添加内容区导航 (暂时去掉)
    // me.commands['buildContentNav'] = {
    //     execCommand: function (key) {
    //         $('.contentNavTab').remove();
    //         if (me.currentModule) {
    //             var data = me.currentModule, items;

    //             for (var i = 0; i < contentNavMenus.length; i++) {
    //                 var menus = contentNavMenus[i];
    //                 for (var j = 0; j < menus.length; j++) {
    //                     var menu = menus[j];
    //                     if (menu.a == data.a && menu.b == data.b) {
    //                         items = menus;
    //                         break;
    //                     }
    //                     if (items) break;
    //                 }
    //             }

    //             if (items) {
    //                 var tab = $('<ul class="nav nav-tabs contentNavTab ' + (getCookie('SiteType') == 1 ? 'contentNavTab_mobile' : '') + '"></ul>');
    //                 for (var i = 0; i < items.length; i++) {
    //                     if (!checkMenu(items[i])) continue;
    //                     var isActive = items[i].a == data.a && items[i].b == data.b;
    //                     //var p = ' p="{&quot;SiteType&quot;:' + document.cookie.match(/sitetype=(\d+)/i)[1] + '}"';
    //                     var p = '';
    //                     tab.append('<li role="presentation" class="' + (isActive ? 'active' : '') + '" onselectstart="false"><a a="' + items[i].a + '" b="' + items[i].b + '"' + p + ' style="cursor:pointer;">' + items[i].title + '</a></li>');
    //                 }
    //                 tab.insertBefore('#maincontent');
    //                 tab.find('a').off('click').on('click', function () {
    //                     var params;
    //                     try {
    //                         params = JSON.parse($(this).attr('p'));
    //                     } catch (ex) {
    //                         //console.log(ex)
    //                     }
    //                     me.execCommand('go', { a: $(this).attr('a'), b: $(this).attr('b'), params: params });
    //                 })
    //             }
    //         }
    //     }
    // };

    // 添加自定义的内容区导航，这样特殊页面就可以特殊处理(暂时去掉)
    // me.commands['buildCustomContentNav'] = {
    //     execCommand: function (key, items) {
    //         $('.contentNavTab').remove();
    //         if (me.currentModule) {
    //             var data = me.currentModule;
    //             if (items) {
    //                 var tab = $('<ul class="nav nav-tabs contentNavTab"></ul>');
    //                 for (var i = 0; i < items.length; i++) {
    //                     if (!checkMenu(items[i])) continue;
    //                     var isActive = items[i].a == data.a && items[i].b == data.b;
    //                     //var p = ' p="{&quot;SiteType&quot;:' + document.cookie.match(/sitetype=(\d+)/i)[1] + '}"';
    //                     var p = '';
    //                     tab.append('<li role="presentation" class="' + (isActive ? 'active' : '') + '" onselectstart="false"><a a="' + items[i].a + '" b="' + items[i].b + '"' + p + ' style="cursor:pointer;">' + items[i].title + '</a></li>');
    //                 }
    //                 tab.insertBefore('#maincontent');
    //                 tab.find('a').off('click').on('click', function () {
    //                     var params;
    //                     try {
    //                         params = JSON.parse($(this).attr('p'));
    //                     } catch (ex) {
    //                         //console.log(ex)
    //                     }
    //                     me.execCommand('go', { a: $(this).attr('a'), b: $(this).attr('b'), params: params });
    //                 })
    //             }
    //         }
    //     }
    // };


    // (暂时去掉)  
    me.addListener('init', function () {
    	if(me.getBackstage()!=2){
        if (getCookie('SiteType') != 1) {
            buildLeftNav(navMenus);
        } else {
            buildLeftNav(navMobileMenus);
        }
        }else{
        	if (getCookie('SiteType') != 1) {
            buildLeftNav2(navMenus2);
        } else { 
            buildLeftNav2(navMobileMenus2); 
        }
        	
        }
    });
}
﻿IWF.plugins['system'] = function () {

    var me = this;

    /*权限*/
    var rule = utils.toJSON(me.options.userInfo.Rule);    
    me.commands['rules'] = {
        execCommand: function (key, arg) {
            if (v = arg.rv) {
                var r = rule[arg.rk || arg.module];
                return (r) ? (r >> v & 1) : false;
            } else {
                return true;
            }
        }
    };

    /*计时器1分钟触发一次*/
    function onTimer() {
        me.fireEvent('timer');
    }

    me.addListener('ready', function () {
        var t = setInterval(onTimer, 60000);
    });

	//获取模块帮助链接
	me.HelpLinks = null;
	me.getModuleHelp = function(moduleType){
		$.ajax({ url: "/index.php?c=Admin/helplink", async: false, dataType: "json", success: function (json) {
				if(json.success){
					me.HelpLinks = json.list;
				}
			}
		});
		for(var i = 0;i < me.HelpLinks.length;i++){
			var item = me.HelpLinks[i];
			if(item.HelpKey == "M_" + moduleType && item.Status == '1' && item.Url != ''){
				return "<a href='"+item.Url+"' target='_blank' class='btn btn-xs btn-warning' style='background:#ca0000'>查看帮助</a>";
			}
		};
		
		//如果找不到，就找没有V2的
		if(/(V\d+)$/i.test(moduleType)) moduleType = moduleType.substring(0,moduleType.length - 2);
		if(/(New)$/i.test(moduleType)) moduleType = moduleType.substring(0,moduleType.length - 3);
		for(var i = 0;i < me.HelpLinks.length;i++){
			var item = me.HelpLinks[i];
			if(item.HelpKey == "M_" + moduleType && item.Status == '1' && item.Url != ''){
				return "<a href='"+item.Url+"' target='_blank' class='btn btn-xs btn-warning'>查看帮助</a>";
			}
		};
		return null;
	};

    //退出系统登录
    me.addListener('logout', function (key, args) {
        $.getJSON("/index.php?c=admin/login&a=logout", { sid: me.sid, _tempid: utils.guid() }, function (json) {

			$.ajax({
				type: "GET",
				async: false,
				url: "/admin/login.aspx?act=logout",
				data: {},
				dataType: "json",
				success: function(data){ console.log(data); }
			});

            me.document.location.href = "index.html";
        });
    });
};
﻿IWF.plugins['urlhash'] = function () {

    var me = this,
    /*缓存最近一次路径*/
        hash = {},
        history = [],
        urlReg = [/#([a-z0-9_-]+)\.([a-z0-9_-]+)\:(\{[^\{]*\})$/i, /#([a-z0-9_-]+)\.([a-z0-9_-]+)$/i, /#([a-z0-9_-]+)$/i];


    /*改变地址路径*/
    me.commands['go'] = {
        execCommand: function (key, args) {
            if (!args) return;
			
            var shs = hash[args.a];
            var hs = args.a + "." + ((args.b) ? args.b : (shs && shs.b) ? shs.b : 'empty');
            if (args.params) hs += ':' + utils.fromJSON(args.params);
            //else if (shs && (shs.b == args.b) && shs.params) hs += ':' + utils.fromJSON(shs.params); 这里有BUG，不应该取缓存里的 shs.params

            /*改变hash*/
            me.window.location.href = me.window.location.pathname + me.window.location.search + "#" + escape(hs);

			if(me.isIE7()) me.fireEvent("hashchange",me.window.location.hash); //IE7 不支持 hashchange 事件，这里要显式调用一下
        }
    };

    //回退
    me.commands['redo'] = {
        execCommand: function (key, args) {
            alert('redo');
        }
    };

    /*关闭缓存路径*/
    me.commands['close'] = {
        execCommand: function (key, args) {
            if (!args) return;
            var key = utils.isString(args) ? args : args.a;
            //在删除之前
            me.fireEvent('beforeclose', { a: key });
            /*移除与关闭模块有关的历史记录*/
            for (var i = history.length - 1; i >= 0; i--) {
                if (history[i].key == key) history.splice(i, 1);
            }
            /*触发关闭事件*/
            //me.fireEvent('close', args);
            /*调用历史回退*/
            if (history.length > 0) {
                me.window.location.href = me.window.location.pathname + me.window.location.search + "#" + escape(history.pop().value);
            } else {
                me.window.location.href = me.window.location.pathname + me.window.location.search;
            }
        }
    };
	
	/*判断浏览器是否是IE7*/
	me.isIE7 = function() {
		var appName = navigator.appName;
		var userAgent = navigator.userAgent;
		var version;
		if (appName == 'Microsoft Internet Explorer') {
			version = /MSIE\s(\S)/.exec(userAgent)[1];
			versionfloat = parseFloat(version);
			if (versionfloat > 1 && versionfloat < 8) {
				return true;
			}
		}
		return false;
	};

    /*URL hash事件*/
    me.addListener('hashchange', function (args) {
        var hashStr = unescape(location.hash);

        if (urlReg[0].test(hashStr) || urlReg[1].test(hashStr) || urlReg[2].test(hashStr)) {
            var moduleKey = RegExp.$1;
            if (!hash[moduleKey]) hash[moduleKey] = { a: moduleKey };
            if (RegExp.$2) hash[moduleKey].b = RegExp.$2;

            if (RegExp.$3) hash[moduleKey].params = utils.toJSON(RegExp.$3); //这时有问题，如果之前的 url 是 a.html#module.action:{name:'123'} ，而后来又变为 a.html#module.action 时，也就是后面没有带参数时，currentModule.params 不会变，所以下面加了个 else (2015/5/15 泉)
			else hash[moduleKey].params = null; //add by 泉
			
            /*保存历史记录*/
            if (RegExp.$1) {
                history.push({ key: moduleKey, value: hashStr.replace(/^#/i, '') });
                if (history.length > 20) history.splice(0, 1);
            }

            me.currentModule = hash[moduleKey];
            me.execCommand('buildContentNav');

            /*插件事件*/
            me.fireEvent('before' + moduleKey, me.currentModule);
            me.fireEvent(moduleKey, me.currentModule);
            me.fireEvent('after' + moduleKey, me.currentModule);
            /*激活全局事件*/
            me.fireEvent('beforedo', me.currentModule);
            me.fireEvent('do', me.currentModule);
            me.fireEvent('afterdo', me.currentModule);
        } else {
            /*如果没有模块被激活则初始化*/
            me.fireEvent('initurl', {});
        }
    });	
};
﻿IWF.plugins['counter'] = function () {

	var me = this;
	
	var myroot = null;
	function initUI(root) {
		
        root.children().remove();
        root.loadHtmlTpl("plugins/flowpackage/html/counter.html",function() {			
            me.execCommand('initContentNav', root);
			$("#BtnSaveConter").unbind('click').click(function(){
				submitForm();
			});
			
			$('#BtnSaveConter').floatSaveBtn();
			
			myroot = root[0];
			loadConfigInfo();
		});
    }

    function loadConfigInfo() {
        //$.getJSON("/admin/flow/counter?act=getconfig", null, function (json) {
    	$.getJSON("/index.php?c=admin/flow/counter&a=getconfig", null, function (json) {
			$("#styles").children().remove();
			ko.applyBindings(json,myroot);

			for(var i = 0; i < json.styles.length;i++){
				var item = json.styles[i];
				var html = '<div style="width:180px;float:left;padding:5px 0;height:40px;line-height:40px">';
				html += '		<label><input type="radio" name="Style" value="'+ item.name +'" '+ (item.name == json.config.Style ? "checked":"") +'>';
				html += '		<span>'+ item.images +'</span></label>';
				html += '	</div>';
				$("#styles").append(html);
			}
        });
    }

    function submitForm() {
        var params = $('#CounterConfigForm').serialize();
		//alert(params);
		//$.post("/admin/flow/counter?act=editconfig",params,function(data, textStatus, jqXHR){
        $.post("/index.php?c=admin/flow/counter&a=editconfig",params,function(data, textStatus, jqXHR){
			if(data.success){
			    $.showResult(true, "保存成功", 1500, function () {
			        loadConfigInfo();
			    });
			}else{
			    $.showResult(false, json.msg);
			}
		},"json");
    }

	function showResult(title,msg,autoClose) {
		$("#ResultDialog").remove();
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
		if(autoClose && autoClose > 0){
			setTimeout(function(){ $("#ResultDialog").remove(); },autoClose);
		}
	}

    me.addListener('counter', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['flowarea'] = function () {

    var me = this;
	
	var mydoc = null;
    function initUI(root) {
		mydoc = root;
        root.children().remove();
        root.loadHtmlTpl("plugins/flowpackage/html/flowarea.html", function () {
            me.execCommand('initContentNav', root);
			bindUIEvent();
			loadFlowArea(0);
		});
    }
	
    function loadFlowArea(step) {
        var params = { sid: me.sid, step: step };
        //$.getJSON("/admin/flow/flowcount?act=GetAreaCount", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/flow/flowcount&a=GetAreaCount", utils.params(params), function (json) {
            
			$("#FlowAreaBody",mydoc).children().remove();
			$("#sum",mydoc).html(json.sum);
			if(json.list){
				for (var i = 0; i <= json.list.length; i++)
				{
					try{
						var dcount = json.list[i].Count_Count;
						var percent1 = (dcount/json.sum).toFixed(2);
						var percent2 = (dcount/json.sum * 100).toFixed(2);
						var percentTab = '<table width="500" border="0" cellpadding="0" cellspacing="0">';
						percentTab += '    <tr>';
						percentTab += '		<td style="background:#00cc00;height:10px;" width="'+ (500 * percent1) +'" ></td>';
						percentTab += '		<td style="background:#efefef;height:10px;"  width="'+ (500 * (1 - percent1)) +'"></td>';
						percentTab += '    </tr>';
						percentTab += ' </table>';

						var html = '<tr bgcolor="#ffffff">';
						html += '<td>{0}</td>'.format(i + 1); //format 方法定义在 core/extend.js
						html += '<td>{0}</td>'.format(json.list[i].Count_Local);
						html += '<td>{0}</td>'.format(json.list[i].Count_Count);
						html += '<td>{0}{1}</td>'.format(percentTab,percent2 + "%");
						html += '</tr>';
						$("#FlowAreaBody",mydoc).append(html);
					}catch(e){}
				}
			}

            bindGridEvent();
        });
    }

	function showResult(title,msg,autoClose) {
		$("#ResultDialog").remove();
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
		if(autoClose && autoClose > 0){
			setTimeout(function(){ $("#ResultDialog").remove(); },autoClose);
		}
	}

	function bindUIEvent(){
		$("#BtnCur",mydoc).click(function(){ loadFlowArea(0) });
		$("#BtnPrev1",mydoc).click(function(){ loadFlowArea(1) });
		$("#BtnPrev2",mydoc).click(function(){ loadFlowArea(2) });
	}

    function bindGridEvent() {
        
    }

    me.addListener('flowarea', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['flowbrowser'] = function () {

    var me = this;
	
	var mydoc = null;
    function initUI(root) {
		mydoc = root;
        root.children().remove();
        root.loadHtmlTpl("plugins/flowpackage/html/flowbrowser.html", function () {
            me.execCommand('initContentNav', root);
			bindUIEvent();
			loadFlowBrowser(0);
		});
    }
	
    function loadFlowBrowser(step) {
        var params = { sid: me.sid, step: step };
        //$.getJSON("/admin/flow/flowcount?act=GetBrowserCount", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/flow/flowcount&a=GetBrowserCount", utils.params(params), function (json) {
            
			$("#FlowBrowserBody",mydoc).children().remove();
			$("#sum",mydoc).html(json.sum);
			if(json.list){
				for (var i = 0; i <= json.list.length; i++)
				{
					try{
						var dcount = json.list[i].Count_Count;
						var percent1 = (dcount/json.sum).toFixed(2);
						var percent2 = (dcount/json.sum * 100).toFixed(2);
						var percentTab = '<table width="500" border="0" cellpadding="0" cellspacing="0">';
						percentTab += '    <tr>';
						percentTab += '		<td style="background:#00cc00;height:10px;" width="'+ (500 * percent1) +'" ></td>';
						percentTab += '		<td style="background:#efefef;height:10px;"  width="'+ (500 * (1 - percent1)) +'"></td>';
						percentTab += '    </tr>';
						percentTab += ' </table>';

						var html = '<tr bgcolor="#ffffff">';
						html += '<td>{0}</td>'.format(i + 1); //format 方法定义在 core/extend.js
						html += '<td>{0}</td>'.format(json.list[i].Count_Browser);
						html += '<td>{0}</td>'.format(json.list[i].Count_Count);
						html += '<td>{0}{1}</td>'.format(percentTab,percent2 + "%");
						html += '</tr>';
						$("#FlowBrowserBody",mydoc).append(html);
					}catch(e){}
				}
			}

            bindGridEvent();
        });
    }

	function showResult(title,msg,autoClose) {
		$("#ResultDialog").remove();
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
		if(autoClose && autoClose > 0){
			setTimeout(function(){ $("#ResultDialog").remove(); },autoClose);
		}
	}

	function bindUIEvent(){
		$("#BtnCur",mydoc).click(function(){ loadFlowBrowser(0) });
		$("#BtnPrev1",mydoc).click(function(){ loadFlowBrowser(1) });
		$("#BtnPrev2",mydoc).click(function(){ loadFlowBrowser(2) });
	}

    function bindGridEvent() {
        
    }

    me.addListener('flowbrowser', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['flowday'] = function () {

    var me = this;
	
	var mydoc = null;
    function initUI(root) {
		mydoc = root;
        root.children().remove();
        root.loadHtmlTpl("plugins/flowpackage/html/flowday.html", function () {
            me.execCommand('initContentNav', root);
			bindUIEvent();
			loadFlowDay(0);
		});
    }
	
    function loadFlowDay(step) {
        var params = { sid: me.sid, step: step };
        //$.getJSON("/admin/flow/flowcount?act=GetDayCount", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/flow/flowcount&a=GetDayCount", utils.params(params), function (json) {
            
			$("#FlowDayBody",mydoc).children().remove();
			$("#spdate",mydoc).html(json.info.year + " 年 " + json.info.month + " 月");
			$("#sum",mydoc).html(json.info.sum);
			if(json.dayscount){
				for (var day = 1; day <= json.info.maxday; day++)
				{
					var dcount = json.dayscount['CountD' + day];
					var percent1 = (dcount/json.info.sum).toFixed(2);
					var percent2 = (dcount/json.info.sum * 100).toFixed(2);
					var percentTab = '<table width="500" border="0" cellpadding="0" cellspacing="0">';
					percentTab += '    <tr>';
					percentTab += '		<td  style="background:#00cc00;height:10px;" width="'+ (500 * percent1) +'" ></td>';
					percentTab += '		<td style="background:#efefef;height:10px;"  width="'+ (500 * (1 - percent1)) +'"></td>';
					percentTab += '    </tr>';
					percentTab += ' </table>';

					var html = '<tr bgcolor="#ffffff">';
					html += '<td>{0}-{1}-{2}</td>'.format(json.info.year,json.info.month,day); //format 方法定义在 core/extend.js
					html += '<td>{0}</td>'.format(new Date(json.info.year,json.info.month - 1,day).getChineseWeekName());
					html += '<td>{0}</td>'.format(dcount);
					html += '<td>{0}{1}</td>'.format(percentTab,percent2 + "%");
					html += '</tr>';
					$("#FlowDayBody",mydoc).append(html);
				}
			}

            bindGridEvent();
        });
    }

	function showResult(title,msg,autoClose) {
		$("#ResultDialog").remove();
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
		if(autoClose && autoClose > 0){
			setTimeout(function(){ $("#ResultDialog").remove(); },autoClose);
		}
	}

	function bindUIEvent(){
		$("#BtnCur",mydoc).click(function(){ loadFlowDay(0) });
		$("#BtnPrev1",mydoc).click(function(){ loadFlowDay(1) });
		$("#BtnPrev2",mydoc).click(function(){ loadFlowDay(2) });
	}

    function bindGridEvent() {
        
    }

    me.addListener('flowday', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['flowmonth'] = function () {

    var me = this;
	
	var mydoc = null;
    function initUI(root) {
		mydoc = root;
        root.children().remove();
        root.loadHtmlTpl("plugins/flowpackage/html/flowmonth.html", function () {
            me.execCommand('initContentNav', root);
			bindUIEvent();
			loadFlowMonth(0);
		});
    }
	
    function loadFlowMonth(step) {
        var params = { sid: me.sid, step: step };
        //$.getJSON("/admin/flow/flowcount?act=GetMonthCount", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/flow/flowcount&a=GetMonthCount", utils.params(params), function (json) {
            
			$("#FlowMonthBody",mydoc).children().remove();
			$("#spdate",mydoc).html(json.info.year + " 年 ");
			$("#sum",mydoc).html(json.info.sum);
			if(json.mouthcount){
				for (var month = 1; month <= 12; month++)
				{
					var dcount = json.mouthcount['CountM' + month];
					var percent1 = (dcount/json.info.sum).toFixed(2);
					var percent2 = (dcount/json.info.sum * 100).toFixed(2);
					var percentTab = '<table width="500" border="0" cellpadding="0" cellspacing="0">';
					percentTab += '    <tr>';
					percentTab += '		<td style="background:#00cc00;height:10px;" width="'+ (500 * percent1) +'" ></td>';
					percentTab += '		<td style="background:#efefef;height:10px;"  width="'+ (500 * (1 - percent1)) +'"></td>';
					percentTab += '    </tr>';
					percentTab += ' </table>';

					var html = '<tr bgcolor="#ffffff">';
					html += '<td>{0} 年 {1} 月</td>'.format(json.info.year,month); //format 方法定义在 core/extend.js
					html += '<td>{0}</td>'.format(dcount);
					html += '<td>{0}{1}</td>'.format(percentTab,percent2 + "%");
					html += '</tr>';
					$("#FlowMonthBody",mydoc).append(html);
				}
			}

            bindGridEvent();
        });
    }

	function showResult(title,msg,autoClose) {
		$("#ResultDialog").remove();
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
		if(autoClose && autoClose > 0){
			setTimeout(function(){ $("#ResultDialog").remove(); },autoClose);
		}
	}

	function bindUIEvent(){
		$("#BtnCur",mydoc).click(function(){ loadFlowMonth(0) });
		$("#BtnPrev1",mydoc).click(function(){ loadFlowMonth(1) });
		$("#BtnPrev2",mydoc).click(function(){ loadFlowMonth(2) });
	}

    function bindGridEvent() {
        
    }

    me.addListener('flowmonth', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['flowrecord'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.recordlist = ko.observableArray();
        this.setData = function (data) { this.recordlist(data); };
		this.getTimeDisp = function(time){
			return time.replace(/T/g,' ');
		};
    };

	var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/flowpackage/html/flowrecord.html", function () {
            me.execCommand('initContentNav', root);
			bindUIEvent();
			ko.applyBindings(vm,root[0]);
			loadRecordList(1);
		});
    }
	
	var curpage = 1;
	var itemcount = 0;
    function loadRecordList(page) {
        var params = { sid: me.sid, page: page, pagesize: 20 };
        //$.getJSON("/admin/flow/flowcount?act=GetVisitList", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/flow/flowcount&a=GetVisitList", utils.params(params), function (json) {
            vm.setData(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadRecordList(page); });
                $("#pagination").show();
            }

            bindGridEvent();
        });
    }

	function showResult(title,msg,autoClose) {
		$("#ResultDialog").remove();
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
		if(autoClose && autoClose > 0){
			setTimeout(function(){ $("#ResultDialog").remove(); },autoClose);
		}
	}

	function bindUIEvent(){
		
	}

    function bindGridEvent() {
        
    }

    me.addListener('flowrecord', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['flowsource'] = function () {

    var me = this;
	
	var mydoc = null;
    function initUI(root) {
		mydoc = root;
        root.children().remove();
        root.loadHtmlTpl("plugins/flowpackage/html/flowsource.html", function () {
            me.execCommand('initContentNav', root);
			bindUIEvent();
			loadFlowSource(0);
		});
    }
	
    function loadFlowSource(step) {
        var params = { sid: me.sid, step: step };
        //$.getJSON("/admin/flow/flowcount?act=GetSourceCount", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/flow/flowcount&a=GetSourceCount", utils.params(params), function (json) {
            
			$("#FlowSourceBody",mydoc).children().remove();
			$("#sum",mydoc).html(json.sum);
			if(json.list){
				for (var i = 0; i <= json.list.length; i++)
				{
					try{
						var dcount = json.list[i].Count_Count;
						var percent1 = (dcount/json.sum).toFixed(2);
						var percent2 = (dcount/json.sum * 100).toFixed(2);
						var percentTab = '<table width="500" border="0" cellpadding="0" cellspacing="0">';
						percentTab += '    <tr>';
						percentTab += '		<td style="background:#00cc00;height:10px;" width="'+ (500 * percent1) +'" ></td>';
						percentTab += '		<td style="background:#efefef;height:10px;"  width="'+ (500 * (1 - percent1)) +'"></td>';
						percentTab += '    </tr>';
						percentTab += ' </table>';

						var html = '<tr bgcolor="#ffffff">';
						html += '<td>{0}</td>'.format(i + 1); //format 方法定义在 core/extend.js
						html += '<td>{0}</td>'.format(json.list[i].Count_Site);
						html += '<td>{0}</td>'.format(json.list[i].Count_Count);
						html += '<td>{0}{1}</td>'.format(percentTab,percent2 + "%");
						html += '</tr>';
						$("#FlowSourceBody",mydoc).append(html);
					}catch(e){}
				}
			}

            bindGridEvent();
        });
    }

	function showResult(title,msg,autoClose) {
		$("#ResultDialog").remove();
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
		if(autoClose && autoClose > 0){
			setTimeout(function(){ $("#ResultDialog").remove(); },autoClose);
		}
	}

	function bindUIEvent(){
		$("#BtnCur",mydoc).click(function(){ loadFlowSource(0) });
		$("#BtnPrev1",mydoc).click(function(){ loadFlowSource(1) });
		$("#BtnPrev2",mydoc).click(function(){ loadFlowSource(2) });
	}

    function bindGridEvent() {
        
    }

    me.addListener('flowsource', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['flow'] = function () {
	
    var me = this;
    var nav = { icon: 'fa fa-signal',color: 'icon-red', title: '流量', a: 'flow', b: 'counter', index: 6, canClose: false };

    var leftRoot, rightRoot, leftNav;

    var navConfig = {
        showOption:false,

		data: [
        {
            icon: 'fa fa-edit', color: 'icon-red', title: '计数器',
            items: [
                { icon: 'fa fa-cog', color: 'icon-blue', title: '计数器设置', a: 'flow', b: 'counter' }
            ]
        }, {
            icon: 'fa fa-edit', color: 'icon-red', title: '访问统计',
            items: [
                { icon: 'fa fa-th-large', color: 'icon-blue', title: '日统计', a: 'flow', b: 'flowday'}
                , { icon: 'fa fa-list-ol', color: 'icon-green', title: '月统计', a: 'flow', b: 'flowmonth' }
                , { icon: 'fa fa-globe', color: 'icon-red', title: '浏览器统计', a: 'flow', b: 'flowbrowser' }
                , { icon: 'fa fa-bar-chart', color: 'icon-blue', title: '地区统计', a: 'flow', b: 'flowarea' }
				, { icon: 'fa fa-random', color: 'icon-green', title: '来源统计', a: 'flow', b: 'flowsource' }
				, { icon: 'fa fa-pencil', color: 'icon-red', title: '访问记录', a: 'flow', b: 'flowrecord' }
            ]
        }],

        onItemClick: function (sender, data) {
			leftNav.hide();
			me.execCommand('go', data);
        },

        setSelect: function (args) {
            var index = 0;
            $.each(navConfig.data, function (i, item) {
                index++;
                if (item.a == args.a && item.b == args.b) {
                    navConfig.selectIndex = index;
                }
                if (item.items) {
                    $.each(item.items, function (k, citem) {
                        index++;
                        if (citem.a == args.a && citem.b == args.b) {
                            navConfig.selectIndex = index;
                        }
                    });
                }
            });
        }
    };

    me.addListener('init', function () { 
		var tab = me.execCommand('addtab', nav);
		if (tab.c.children().length == 0) {
            var temp = $('<div class="row"></div>').appendTo(tab.c);
            //leftRoot = $('<div class="col-sm-1 col-md-2 mainside"></div>').appendTo(temp);
            rightRoot = $('<div class="col-sm-9 col-md-10 col-sm-offset-3 col-md-offset-0"></div>').appendTo(temp);
            //leftRoot.append('<div class="navcontent"></div>');
        }

		leftNav = $('<div class="sidebarNavPanel"><div class="titlebar"><div class="title">'+ nav.title +'</div></div><div class="content"><ul></ul></div></div>').appendTo("body");
		leftNav.find('.content>ul').listNav2(tab,leftNav,navConfig);

		tab.t.click(function(){ leftNav.hide(); });
	});

    function flash(args, tab,isgo) {
        

        //原来架框的建立下级菜单过程
		//navConfig.setSelect(args);
        //leftRoot.find('div.navcontent').listNav(navConfig);

		me.execCommand('show', { a: args.a });
        setChildWindow(args,rightRoot,isgo);
    }

    function setChildWindow(args, root,isgo) {
        /*var temp = root.find('#' + args.b);
        if (temp.length == 0) {
            temp = $('<div id="' + args.b + '"></div>').appendTo(root);
        }
        temp.show();
        temp.siblings().hide();
        if(isgo) me.execCommand('go', args);
		else me.fireEvent(args.b, temp);*/

		if(isgo) me.execCommand('go', args);
		else me.fireEvent(args.b, me.content); //me.content 定义在 core/content.js 里
    }

    me.commands['initContentNav' + nav.a] = {
        execCommand: function (key, domObj) {
            var items = navConfig.data[0].items.concat(navConfig.data[1].items);
            me.execCommand('addContentNav', domObj, items);
        }
    }

    me.addListener(nav.a, function (key, args) {
        var tab = me.execCommand('gettab', nav);
        flash(args, tab);
    });
};

﻿IWF.plugins['fieldedit'] = FieldListClass = function (options) {

	var me = this;
	
	var ViewModel = function () {
        this.fieldlist = ko.observableArray();
        this.setData = function (data) { this.fieldlist(data); };
		this.getDisplay = function(fieldType){
			if(fieldType == '3' || fieldType == '4' || fieldType == '5') return "inline-block";
			return "none";
		};
    };
	
	var vm = new ViewModel();
	me.initUI = function(root) {
        root.children().remove();
		root.html();
        root.loadHtmlTpl("/admin/plugins/formpackage/html/fieldedit.html",function() {
			if(me.currentModule.params && me.currentModule.params.hideTitle){
				$(".tableTitle",root).hide();
			}
			if(me.currentModule.params && me.currentModule.params.FormID) $("#FormID",root).val(me.currentModule.params.FormID);
			if(me.currentModule.params && me.currentModule.params.FormName) $("#FormName",root).val(me.currentModule.params.FormName);
			if(me.currentModule.params && me.currentModule.params.HideSaveBtn) $("#BtnSave").hide();
			if(me.currentModule.params && me.currentModule.params.HideTitle) $(".tableTitle",root).hide();
			if(me.currentModule.params && me.currentModule.params.DisableFieldTypes) {
			    var disableFieldTypes = me.currentModule.params.DisableFieldTypes.split(',');
			    $('[name=FieldType]').children('option').each(function (i) {
			        if ($.inArray(this.value + '', disableFieldTypes) > -1) {
			            $(this).hide();
			        }
			    })
			}
			me.initUIEvent();
			ko.applyBindings(vm,root[0]);
			me.loadList();
		});
    }
	
	me.loadList = function(){
		var defaultlist = [];
		var defaultitem = {
			"ID" : "New" + parseInt(Math.random() * 1000000),
			"Name" : "",
			"FieldType" : 1,
			"FieldValues" : "",
			"IsRequire" : 1,
			"IsShow" : 1,
			"ValidateType" : 1
		};
		defaultlist.push(defaultitem);
		var formid = 0;
		if(me.currentModule.params && me.currentModule.params.FormID) formid = me.currentModule.params.FormID;
        $.getJSON("/index.php?c=admin/form/formmanage&a=getfieldlist", utils.params({act: 'getfieldlist',FormID: formid}), function (json) {
            if(json.list && json.list.length > 0) vm.setData(json.list);
			else{
				vm.setData(defaultlist);
				if(me.currentModule.params && me.currentModule.params.DisableEmptyCheck == 1){
					$('#FieldForm .sortUl').children('li').hide();
				}
			}
            me.bindGridEvent();
        });
	}

	me.initUIEvent = function(){
		$("#BtnAddField").off().on('click',function(){
			if($(".sortUl>li:hidden").length == 1 && me.currentModule.params && me.currentModule.params.DisableEmptyCheck == 1){
				$(".sortUl>li").show();
				return;
			}
			var obj = $(".sortUl>li:last-child").clone();
			var newid = parseInt(Math.random() * 100000);
			obj.find("*[name=BtnEditValues]").css("display","none");
			obj.find("input,select,*[name=BtnEditValues]").each(function(i,item){
				var newname = $(item).attr("name").replace(/(New)?\d+$/i,"New" + newid);
				$(item).attr("name",newname);
				if($(item).is('select')){
					$(item).children(':eq(0)').prop('checked', true);
				}else{
					$(item).val('');
				}
			});
			$(".sortUl").append(obj);
			me.bindGridEvent();
		});

		$("#BtnSave").unbind('click').bind('click', function (event) {
			me.submitForm();
        });
	}

	me.bindGridEvent = function() {
		
		$(".CustFieldsTable").disableSelection();
		$(".sortUl").sortable({
			handle: ".CustFieldsT1",
			start: function (event, ui) {
				ui.item.css({ "border": "solid 1px red" });
			},
			update: function (event, ui) {
				
			}, stop: function (event, ui) {
				ui.item.css({ "border": "0" });
			}
		});
		
		$("select[FieldTypeSelector=1]").unbind('change').bind('change', function (event) {
			var type = parseInt($(this).val());
			/*
			if(type >= 3){
				$(this).parent().find("*[name=BtnEditValues]").css("display","inline-block");
			}else{
				$(this).parent().find("*[name=BtnEditValues]").css("display","none");
			}
			*/
			if(type == 1 || type == 2 || type == 6 || type == 7 || type == 8){
				$(this).parent().find("*[name=BtnEditValues]").css("display","none");
			}else{
				$(this).parent().find("*[name=BtnEditValues]").css("display","inline-block");
			}
		});

		$("*[name=BtnEditValues]").unbind().bind('click',function(event){
			var fid = $(this).attr("FieldID");
			var valuesobj = $(this).parent().find("input[IsFieldValues=1]");
			console.log(valuesobj);
			showEditValues(valuesobj);
		});

		$("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			var id = $(this).attr("FieldID");
			if(!confirm("确认删除？")) return;
			if($(".sortUl > li").length <= 1 && (!me.currentModule.params || me.currentModule.params.DisableEmptyCheck != 1)){
				alert("至少应该有一个字段");
				return;
			}
			var obj = $(this);
			$.getJSON("/index.php?c=admin/form/formmanage&a=DeleteFields", utils.params({id:id}), function (json) {
				//loadList();
				$(obj).closest("li").remove();
			});
			return false;
        });		
	}

	me.submitForm = function(fnComplete) {
		var flag = true;
		var paramsObj = $('#FieldForm').serializeObject();
		
		// 先从表单去除隐藏的li，因为当li隐藏时，实际上是客户不需要的
		for(var key in paramsObj){
			if(key.substring(0,'9') == 'FieldName'){
				if(!$('[name=' + key + ']').closest('.sortUl>li').is(':visible')){
					var name = key.replace('FieldName', '');
					delete paramsObj['FieldName' + name];
					delete paramsObj['FieldRequire' + name];
					delete paramsObj['FieldShow' + name];
					delete paramsObj['FieldType' + name];
					delete paramsObj['FieldValidateType' + name];
					delete paramsObj['FieldValues' + name];
				}
			}
		}
		for(var key in paramsObj){
			if(key.substring(0,'9') == 'FieldName'){
				if(paramsObj[key] == ''){
					$("*[name="+ key +"]").css("border","1px solid red");
					flag = false;
				}
			}
		}
		console.log(me.currentModule);
		if (!flag) {
			if(fnComplete){
				fnComplete.call(this,{success:false,msg: "字段名不能为空"});
				return false;
			}else{
				alert("字段名不能为空");
				return false;
			}
		}

		var fieldNames = [];
		for(var key in paramsObj){
			if(key.substring(0,'9') == 'FieldName'){
				if($.inArray(paramsObj[key], fieldNames) > -1){
					alert('字段名：' + paramsObj[key] + '重复');
					return false;
				}
				fieldNames.push(paramsObj[key]);
			}
		}

		var params = paramsObj;
		$.post("/index.php?c=admin/form/formmanage&a=InsertOrUpdateFields",params,function(data, textStatus, jqXHR){
			if(fnComplete){
				fnComplete.call(this,data);
			}else{
				if(data.success){
					$.showResult("提示","表单保存成功",2000);
					me.execCommand('go', { a: 'form', b: 'formlist' });
				}else{
					$.showResult("保存失败",data.msg);
				}
			}
		},"json");
    }

	function showEditValues(valuesobj){
		console.log(valuesobj.val());
		$("#EditValuesDialog").remove();
		var html = "<div id='EditValuesDialog'>请输入选项值，一行一个";
		html += "<textarea id='EditValuesTextarea' class='form-control' rows='6'>"+ $(valuesobj).val().replace(/\|+/gi,"\r\n") +"</textarea>";
		html += "</div>";
		$("body").append(html);
		$("#EditValuesDialog").dialog({
		    resizable: false, title: "请输入选项值", modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); },
		    buttons: {
		        "确定": function () {
		            $(valuesobj).val($("#EditValuesTextarea").val().replace(/[\r\n]+/gi, "|"));
		            $(this).remove();
		        },
		        "取消": function () { $(this).remove(); }
		    }
		}).dialog('widget').find(".ui-dialog-titlebar-close").hide();
	}
	
	if(me && me.addListener){
		me.addListener('fieldedit', function (key, args) {
			me.initUI($(args));
		});
	}

	if(options && options.autoInit){
		initUI(options.uiDom);
	}
}

﻿IWF.plugins['formedit'] = FormEditClass = function (options) {

    var me = this;
	
	var myroot = null;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/formpackage/html/formedit.html",function() {
			myroot = root[0];
			$("#CustForm").validate({
				rules: {
					tbName: "required"
				},
				messages: {
					tbName: "名称不能为空"
				},
				submitHandler: function (form) {
					submitForm();
					return false;
				}
			});
			bindUIEvent();
			$('#BtnSave').floatSaveBtn();
			loadData();
		});
    }

	function bindUIEvent(){

	}
	
    function loadData() {
		if(me.currentModule.params && me.currentModule.params.id){
			var params = { sid: me.sid, id: me.currentModule.params.id };
			$.getJSON("/index.php?c=admin/form/formmanage&a=getinfo", utils.params(params), function (json) {
				ko.applyBindings(json.info,myroot);
			});
		}
    }

    function submitForm() {
        var params = $('#CustForm').serialize();
		$.post("/index.php?c=admin/form/formmanage&a=edit",params,function(data, textStatus, jqXHR){
			if(data.success){
			    $.showResult(true, "表单保存成功", 2000, function () {
			        me.execCommand('go', { a: 'form', b: 'formlist' });
			    });
			}else{
			    $.showResult(false, data.msg);
			}
		},"json");
    }

	if(me && me.addListener){
		me.addListener('formedit', function (key, args) {
			initUI(args);
		});
	}

	if(options && options.autoInit){
		initUI(options.uiDom);
	}
}

﻿IWF.plugins['formlist'] = FormListClass = function (options) {

	var me = this;
	
	var ViewModel = function () {
        this.formlist = ko.observableArray();
        this.setData = function (data) { this.formlist(data); };
    };
	
	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
		root.html();
        root.loadHtmlTpl("plugins/formpackage/html/formlist.html?rand=" + Math.random(),function() {			
			ko.applyBindings(vm,root[0]);
			loadList(1);
			bindUIEvent();
		});
	}

	function bindUIEvent() {
	    $("#BtnSearch").unbind('click').bind('click', function (event) {
	        loadList(1);
	    });
	}
	
	var curpage = 1;
	var itemcount = 0;
	function loadList(page){
        $.getJSON("/index.php?c=admin/form/formmanage&a=getlist", utils.params({act: 'getlist',keyword: $("#keyword").val(), formType: 'CustomForm'}), function (json) {
            vm.setData(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#formpage").hide();
            else {
                //pageNav 方法定义在 /core/ui.js 里
                $("#formpage").pageNav(json.curpage, json.pagecount, 10, function (page) { loadList(page); });
                $("#formpage").show().css("display","block");
            }

            bindGridEvent();
        });
	}

	function bindGridEvent() {
	    $("*[name=BtnGoLog]").unbind('click').bind('click', function (event) {
	        var id = $(this).attr("FormID");
	        me.execCommand('go', { a: 'form', b: 'formlog', params: { FormID: id } });
	        return false;
	    });

		$("*[name=BtnEditFields]").unbind('click').bind('click', function (event) {
			var id = $(this).attr("FormID");
			me.execCommand('go', { a: 'form', b: 'fieldedit', params: { FormID: id} });
			return false;
        });

		$("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
			var id = $(this).attr("FormID");
			me.execCommand('go', { a: 'form', b: 'formedit', params: { id: id} });
			return false;
        });

		$("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			var id = $(this).attr("FormID");
			if(!confirm("确认删除？")) return;
			$.getJSON("/index.php?c=admin/form/formmanage&a=delete", utils.params({id:id}), function (json) {
				if(itemcount > 1) loadList(curpage);
				else loadList(1);
			});
			return false;
        });
	}
	
	if(me && me.addListener){
		me.addListener('formlist', function (key, args) {
			initUI(args);
		});
	}

	if(options && options.autoInit){
		initUI(options.uiDom);
	}
}

﻿IWF.plugins['formlog'] = function () {

    var me = this;
    var formID = 0;
    var formObj = null;
    var fieldList = [];
    var curpage = 1;
    var itemcount = 0;

    function initUI(root) {
        root.children().remove();
        formID = me.currentModule.params.FormID;
        root.loadHtmlTpl("plugins/formpackage/html/formlog.html", function () {
            if (formID > 0) {
                getInfo();
                getFieldList();
                loadRows(1);
                bindUIEvent();
            }
        });
    }

    function getInfo() {
        $.ajax({
            type: 'get',
            url: '/index.php?c=admin/form/formmanage&a=getinfo',
            data: { id: formID },
            async: false,
            cache: false,
            dataType: 'json',
            success: function (json) {
                if (!json.success) {
                    alert(json.msg);
                    return;
                }
                console.log(json);
                $('#formTitle').text(json.info.Name);
                formObj = json.info;
            },
            error: function () {
                alert('获取表单信息异常');
            }
        })
    }

    function getFieldList() {
        $.ajax({
            type: 'get',
            url: '/index.php?c=admin/form/formmanage&a=getfieldlist',
            data: { FormID: formID },
            async: false,
            cache: false,
            dataType: 'json',
            success: function (json) {
                console.log(json);
                if (!json.success) {
                    alert(json.msg);
                    return;
                }
                $("#showListTable>thead").remove();
                var aList = json.list || [];
                var sHtml = '<thead><tr>';
                sHtml += '<th>提交时间</th>';
                for (var i = 0; i < aList.length; i++) {
                    sHtml += '<th>' + aList[i].Name + '</th>';
                }
                sHtml += '<th>操作</th>';
                sHtml += '</tr></thead>';
                $("#showListTable").append(sHtml);
                fieldList = aList;
            },
            error: function () {
                alert('获取字段异常');
            }
        })
    }

    function loadRows(page) {
        $.ajax({
            type: 'get',
            url: '/index.php?c=admin/form/formmanage&a=getrows',
            data: { id: formID, page: page, pagesize: 20, keyword: $('#keyword').val() },
            async: false,
            cache: false,
            dataType: 'json',
            success: function (json) {
                //console.log(json);
                $("#showListTable>tbody").remove();
                var aRows = json.list || [];
                var sHtml = '<tbody>';
                for (var i = 0; i < aRows.length; i++) {
                    sHtml += '<tr>';
                    sHtml += '<td>' + getTime(aRows[i].CrTime) + '</td>';
                    for (var j = 0; j < fieldList.length; j++) {
                        //sHtml += '<td>' + aRows[i]['cc_' + fieldList[j].Name] + '</td>';
                    	if(fieldList[j].FieldType == '6'){
                    		sHtml += '<td><img height="30" src="' + aRows[i]['cc_' + fieldList[j].Name] + '"></td>';
                    	}else{
                    		sHtml += '<td>' + aRows[i]['cc_' + fieldList[j].Name] + '</td>';
                    	}
                    }
                    sHtml += '<td>';
                    sHtml += '<i class="fa fa-user btnread" title="查看"  rowid="' + aRows[i].ID + '"></i>';
                    //sHtml += '<i class="fa fa-edit btnedit" title="修改" rowid="' + aRows[i].ID + '"></i>';
                    sHtml += '<i class="fa fa-trash-o btndelete" title="删除" rowid="' + aRows[i].ID + '"></i>';
                    sHtml += '</td>';
                    sHtml += '</tr>';
                }
                sHtml += '</tbody>';
                $("#showListTable").append(sHtml);

                curpage = json.curpage;
                itemcount = aRows.length;
                if (json.pagecount < 2) $("#pagination").hide();
                else {
                    //pageNav 方法定义在 /core/util.js 里
                    $("#pagination").pageNav(json.curpage, json.pagecount, 20, function (page) { loadRows(page) });
                    $("#pagination").show();
                }
                $("#countinfo").html("共 " + json.total + " 条记录");
            },
            error: function () {
                alert('获取表单数据异常');
            }
        })
    }

    function getTime(time) {
        return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
    }

    function bindUIEvent() {
        $("#btnSearch").unbind('click').bind('click', function (event) {
            loadRows(1);
        });

        $("#btnBack").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'form', b: 'formlist' });
            return false;
        });

        $(".myEditSuccess").find(".close").unbind('click').click(function () {
            loadRows(curpage);
            $(".myEditSuccess").hide();
            return false;
        });

        $(".myAlertError").find(".close").unbind('click').click(function () {
            $(".myAlertError").hide();
            return false;
        });

        $(document).off("click.btndelete").on("click.btndelete", function (e) {
            if ($(e.target).hasClass("btndelete")) {
                if (!confirm("确认删除？")) return false;
                $.ajax({
                    type: 'get',
                    url: '/index.php?c=admin/form/formmanage&a=deleterow',
                    data: { id: $(e.target).attr('rowid') },
                    async: false,
                    cache: false,
                    dataType: 'json',
                    success: function (data) {
                        if (data.success) {
                            $(".myEditSuccess").css({
                                opacity: 1,
                                top: ($(window).outerHeight() - $(".myEditSuccess").outerHeight()) / 2 + 'px',
                                left: ($(window).outerWidth() - $(".myEditSuccess").outerWidth()) / 2 + 'px',
                                position: 'fixed',
                                width: 'auto',
                                height: 'auto'
                            });
                            $(".myEditSuccess").slideToggle(500);
                            //$("#divForm").hide();
                            $(".myAlertError").hide();
                            setTimeout(function () {
                                $(".myEditSuccess").find(".close").click();
                            }, 1500);
                        } else {
                            $(".myAlertError").css('display', 'inline-block');
                            $(".myAlertError").css({
                                opacity: 1,
                                top: ($(window).outerHeight() - $(".myAlertError").outerHeight()) / 2 + 'px',
                                left: ($(window).outerWidth() - $(".myAlertError").outerWidth()) / 2 + 'px',
                                position: 'fixed',
                                width: 'auto',
                                height: 'auto'
                            });
                            $(".spError").html(data.msg);
                            //$("#divForm").hide();
                            $(".myEditSuccess").hide();
                        }
                    },
                    error: function () {
                        alert('获取表单数据异常');
                    }
                });
            }
        });
        
        $(document).off("click.btnread").on("click.btnread", function (e) {
        	if ($(e.target).hasClass("btnread")) {
        	   var html = ['<div id="dialog">'];
        	   $.ajax({
        		   type: "POST",
	               //url: url,
	               url: "/index.php?c=admin/Form/Formmanage&a=GetSelfForm",
	               cache: false,
	               dataType: "json",
	               //data: { 'act': 'GetSelfForm', 'formRowId': obj.FormRowID },
	               data: {'formRowId': $(e.target).attr('rowid') },
	               success: function (data) {
	            	   console.log(data);
	            	   if (data && data.success) {
	            		   html.push('<form id="form' + $(e.target).attr('rowid') + '">');
	            		   html.push('<input type="hidden" name="FormRowID" value="' + $(e.target).attr('rowid') + '"/>');
	            		   html.push('<div id="SelForm">');
                     
	                       $.each(data.formlist, function (i, n) {
	                    	   if(n.FieldType == '6'){
	                    		   html.push('<div class="input-group"><span class="input-group-addon">', n.Name, ':</span><img src="', n.FieldValues, '" name="col' + n.ID + '" /></div>');
	                    	   }else{
	                    		   html.push('<div class="input-group"><span class="input-group-addon">', n.Name, ':</span><input type="text" value="', n.FieldValues, '" name="col' + n.ID + '" class="form-control" readonly="readonly" /></div>');
	                    	   }
	                    	   
	                       });
	                       //html.push('<div style="clear:both;text-align:center;"><input type="button" data-val="form' +  $(e.target).attr('rowid') + '" class="btn btn-primary modify" style="width:100px;" value="修改"/></div>');
	                     
	                       html.push('</div></form></div>');
	            	   }
                   },
                   complete: function (XMLHttpRequest, textStatus) {
                	 /*
                     var imgs = obj.Images.split(',');
                     console.log(imgs);
                     html.push('<ul id="imgMas">');
                     for (var i in imgs) {
                         if (imgs[i]){
                              html.push('<li class="item"><img src="', imgs[i], '"/><i data-gid="',obj.Gid , '" data-vid="', obj.Vid , '" data-file="', imgs[i] ,'" class="DelFile glyphicon glyphicon-remove-circle"></i></li>');
                         };
                     }
                     html.push('</ul></div>');
                     */
	                 $(html.join('')).dialog({
	                     modal: true, width: 680, height: 600,title:"详情", position: { my: "center center", at: "center center", of: window },
	                     open: function (event, ui) {
	                    	 /*
	                         if (msnry) {
	                             msnry.destroy();
	                         }
	                         $("#imgMas").imagesLoaded(function () {
	                             msnry = new Masonry(document.getElementById("imgMas"), {
	                                 itemSelector: '.item'
	                             });
	                         });
	                         */
	                     },
	                     close: function () {
	                         $(this).dialog("destroy");
	                     }
	                 });
                   },
	               error: function (XMLHttpRequest, textStatus, errorThrown) {
	            	   console.log(XMLHttpRequest.responseText);
	               }
        	   	});
        	 }
        });
        
    }

    me.addListener('formlog', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['form'] = function () {
	
    var me = this;

    function flash(args, tab,isgo) {
		me.execCommand('show', { a: args.a });
        setChildWindow(args,isgo);
    }

    function setChildWindow(args,isgo) {
		if(isgo) me.execCommand('go', args);
		else me.fireEvent(args.b, me.content); //me.content 定义在 core/content.js 里
    }

    me.addListener('form', function (key, args) {
        var tab = me.execCommand('gettab', {});
        flash(args, tab);
    });
};

﻿//这个程序功能上 fieldedit 是类似的，只是这个是专门用来给 微调研 设置调查问题的，界面上有比较多的不同，就不跟 fieldedit 放一起了
IWF.plugins['questionedit'] = function (options) {

	var me = this;
	
	var ViewModel = function () {
        this.fieldlist = ko.observableArray();
        this.setData = function (data) { this.fieldlist(data); };
		this.getDisplay = function(fieldType){
			if(fieldType == '3' || fieldType == '4' || fieldType == '5') return "inline-block";
			return "none";
		};
    };
	
	var vm = new ViewModel();
	me.initUIQuestion = function(root) {
        root.children().remove();
		root.html();
        root.loadHtmlTpl("/admin/plugins/formpackage/html/questionedit.html",function() {
			if(me.currentModule.params && me.currentModule.params.hideTitle){
				$(".tableTitle",root).hide();
			}
			if(me.currentModule.params && me.currentModule.params.FormID) $("#FormID",root).val(me.currentModule.params.FormID);
			if(me.currentModule.params && me.currentModule.params.FormName) $("#FormName",root).val(me.currentModule.params.FormName);
			if(me.currentModule.params && me.currentModule.params.HideSaveBtn) $("#BtnSave").hide();
			if(me.currentModule.params && me.currentModule.params.HideTitle) $(".tableTitle",root).hide();
			me.initUIQuestionEvent();
			ko.applyBindings(vm,root[0]);
			me.loadQuestionList();
		});
    }
	
	me.loadQuestionList = function(){
		var defaultlist = [];
		var defaultitem = {
			"ID" : "New" + parseInt(Math.random() * 1000000),
			"Name" : "",
			"FieldType" : 1,
			"FieldValues" : "",
			"IsRequire" : 1,
			"IsShow" : 1,
			"ValidateType" : 1
		};
		defaultlist.push(defaultitem);
		var formid = 0;
		if(me.currentModule.params && me.currentModule.params.FormID) formid = me.currentModule.params.FormID;
        //$.getJSON("/admin/form/formmanage", utils.params({act: 'getfieldlist',FormID: formid}), function (json) {
		$.getJSON("/index.php?c=admin/form/formmanage&a=getfieldlist", utils.params({FormID: formid}), function (json) {
            if(json.list && json.list.length > 0) vm.setData(json.list);
			else vm.setData(defaultlist);
            me.bindQuestionGridEvent();
        });
	}

	me.initUIQuestionEvent = function(){
		$("#BtnAddField").off().on('click',function(){
			var obj = $(".sortUl>li:last-child").clone();
			var newid = parseInt(Math.random() * 100000);
			obj.find("input,select,*[name=BtnEditValues]").each(function(i,item){
				var newname = $(item).attr("name").replace(/(New)?\d+$/i,"New" + newid);
				$(item).attr("name",newname);
				if($(item).attr("type") == 'text' || $(item).attr("IsFieldValues") == '1') $(item).val('');
			});
			$(".sortUl").append(obj);
			me.bindQuestionGridEvent();
		});

		$("#BtnSave").unbind('click').bind('click', function (event) {
			me.submitQuestionForm();
        });
	}

	me.bindQuestionGridEvent = function() {
		
		$(".CustQuestionTable").disableSelection();
		$(".sortUl").sortable({
			handle: ".CustQuestionT1",
			start: function (event, ui) {
				ui.item.css({ "border": "solid 1px red" });
			},
			update: function (event, ui) {
				
			}, stop: function (event, ui) {
				ui.item.css({ "border": "0" });
			}
		});
		
		$("select[FieldTypeSelector=1]").unbind('change').bind('change', function (event) {
			var type = parseInt($(this).val());
			if(type >= 3){
				$(this).parent().find("*[name=BtnEditValues]").css("display","inline-block");
			}else{
				$(this).parent().find("*[name=BtnEditValues]").css("display","none");
			}
		});

		$("*[name=BtnEditValues]").unbind().bind('click',function(event){
			var fid = $(this).attr("FieldID");
			var valuesobj = $(this).parent().find("input[IsFieldValues=1]");
			console.log(valuesobj);
			showEditValues(valuesobj);
		});

		$("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			var id = $(this).attr("FieldID");
			if(!confirm("确认删除？")) return;
			if($(".sortUl > li").length <= 1){
				alert("至少应该有一个问题");
				return;
			}
			var obj = $(this);
			//$.getJSON("/admin/form/formmanage?act=DeleteFields", utils.params({id:id}), function (json) {
			$.getJSON("/index.php?c=admin/form/formmanage&a=DeleteFields", utils.params({id:id}), function (json) {
				$(obj).closest("li").remove();
			});
			return false;
        });		
	}

	me.submitQuestionForm = function(fnComplete) {
		var flag = true;
		var paramsObj = $('#FieldForm').serializeObject();
		for(var key in paramsObj){
			if(key.substring(0,'9') == 'FieldName'){
				if(paramsObj[key] == ''){
					$("*[name="+ key +"]").css("border","1px solid red");
					flag = false;
				}
			}
		}
		if(!flag){
			if(fnComplete){
				fnComplete.call(this,{success:false,msg: "问题不能为空"});
				return false;
			}else{
				alert("问题不能为空");
				return false;
			}
		}

		var params = $('#FieldForm').serialize();
		//$.post("/admin/form/formmanage?act=InsertOrUpdateFields",params,function(data, textStatus, jqXHR){
		$.post("/index.php?c=admin/form/formmanage&a=InsertOrUpdateFields",params,function(data, textStatus, jqXHR){
			if(fnComplete){
				fnComplete.call(this,data);
			}else{
				if(data.success){
					$.showResult("提示","表单保存成功",2000);
					me.execCommand('go', { a: 'form', b: 'formlist' });
				}else{
					$.showResult("保存失败",data.msg);
				}
			}
		},"json");
    }

	function showEditValues(valuesobj){
		console.log(valuesobj.val());
		$("#EditValuesDialog").remove();
		var html = "<div id='EditValuesDialog'>请输入问题选项，一行一个";
		html += "<textarea id='EditValuesTextarea' class='form-control' rows='6'>"+ $(valuesobj).val().replace(/\|+/gi,"\r\n") +"</textarea>";
		html += "</div>";
		$("body").append(html);
		$("#EditValuesDialog").dialog({ resizable: false, title: "请输入问题选项", modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); },
			buttons: { "确定": function() { 
									$(valuesobj).val($("#EditValuesTextarea").val().replace(/[\r\n]+/gi,"|").replace(/[,]+/gi,"")); //多选的时候如果有逗号会导致无法分析结果，这里不允许逗号
									$(this).remove();
							   },
					   "取消": function() { $(this).remove(); }
			}
		});
	}
	
	if(me && me.addListener){
		me.addListener('questionedit', function (key, args) {
			me.initUIQuestion($(args));
		});
	}

	if(options && options.autoInit){
		initUIQuestion(options.uiDom);
	}
}

﻿
IWF.plugins['fxindex'] = function () {

    var me = this;

	function initUI(root) {
	    root.empty();
	   
        root.loadHtmlTpl("plugins/homepackage/html/fxindex.html?v" + new Date().getTime(), function () {
            bindUIEvent();

            if (me.hasPerm("SiteAdm")) {
                $('#fenindex_shopconfig, #fenindex_shoppingmallconfig, #fenindex_shopstatistics, #fenindex_salesstatistics').show();
            } else {
                $('#fenindex_shopconfig, #fenindex_shoppingmallconfig, #fenindex_shopstatistics, #fenindex_salesstatistics').remove();
            }

            if (me.hasPerm("UserAdm")) {
                $('#fenindex_userlist').show();
            } else {
                $('#fenindex_userlist').remove();
            }
            
            if (me.hasPerm("OrderAdm")) {
                $('#fenindex_orderlist').show();
            } else {
                $('#fenindex_orderlist').remove();
            }

            if (me.hasPerm("FenXiaoAdm")) {
                $('#fenindex_tichengreview').show();
            } else {
                $('#fenindex_tichengreview').remove();
            }

            if (me.hasPerm("FinanceAdm")) {
                $('#fenindex_financelist').show();
            } else {
                $('#fenindex_financelist').remove();
            }

            if (me.hasPerm("SiteAdm") || me.hasPerm("FinanceAdm")) {
                $('#fenindex_tongji_panel').show();
            } else {
                $('#fenindex_tongji_panel').remove();
            }
		});
    }

	function bindUIEvent(){
	}

	me.addListener('fxindex', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['home'] = function () {
	
    var me = this;
    var nav = { icon: 'fa fa-home',color: 'icon-red', title: '首页', a: 'home', b: 'index', index: 1, canClose: false };
    var leftRoot, rightRoot;
    var noInstallSkin = true;
	var myroot;
    me.addListener('init', function () { 
		var tab = me.execCommand('addtab', nav);
		tab.t.hide();
		initHeader();
	});

	me.addListener('initurl', function () {
        me.execCommand('go', nav);
    });

	function flash(args, tab, isgo) {
        /*if (tab.c.children().length == 0) {
            var temp = $('<div class="row"></div>').appendTo(tab.c);
            rightRoot = $('<div class="col-sm-9 col-md-12 col-sm-offset-0 col-md-offset-0"></div>').appendTo(temp);
			initUI(rightRoot);
        }*/
	    if (args.b == 'index') {
	        initUI(me.content); //me.content 定义在 core/content.js
	        me.execCommand('show', { a: args.a });
	    } else {
	        me.execCommand('show', { a: args.a });
	        setChildWindow(args, rightRoot, isgo);
	    }
    }

    function setChildWindow(args, root, isgo) {
        if (isgo) me.execCommand('go', args);
        else me.fireEvent(args.b, me.content); //me.content 定义在 core/content.js 里
    }

    me.addListener(nav.a, function (key, args) {
        var tab = me.execCommand('gettab', nav);
        flash(args, tab);
    });

	function initHeader(){
		var tpl = "";
        if (me.getBackstage()!=2) {
            tpl = "pcheader";
            if (getCookie("SiteType") == "1") {
                tpl = "wxheader";
            }
        } else {
            tpl = "pcheader2";
            if (getCookie("SiteType") == "1") {
                tpl = "wxheader2";
            }
        }
		$.get("plugins/homepackage/html/"+ tpl +".html?rand=" + Math.random(), function(result){
			me.execCommand('buildheader',{html: result});
			$("#SiteAdmin").html(me.loginUser.RealName);
			$("#BtnHeadGoHome").unbind().click(function(){ me.execCommand('go', { a: 'home', b: 'index' }); });
			$("#BtnHeadGoHome2").unbind().click(function(){ me.execCommand('go', { a: 'home', b: 'index' }); });
			$("#BtnHeaderChangePass").unbind().click(function(){ me.execCommand('go', { a: 'config', b: 'editadminpass' }); });
			$(".messageLi").mouseover(function () {
				$(".message").show();
			}).mouseout(function () {
				$(".message").hide();
			});
			$(".pcCreateSiteFlow").mouseover(function () {
				$(".helpNav").show();
			}).mouseout(function () {
				$(".helpNav").hide();
			});

			if (!me.hasPerm('ShowPCAdmin') || !me.hasPerm('ShowMobileAdmin')) {
			    $('#liToPC').remove();
			    $('#liToMobile').remove();
			} else {
			    $('#liToPC').show();
			    $('#liToMobile').show();
//			    if(me.hasPerm('ShowPCAdmin')){
//			    	$(".pspan").eq(0).css("color","red");
//			    }else{
//			    	$(".pspan").eq(1).css("color","red");
//			    }
			}

			//不显示编辑网站的按钮
			if(me.loginUser.SingleWeb) $('.siteEditBtn').hide();
			
			if (!me.hasPerm('SysAdm')) {
			    if (!me.hasLicensePerm('ENABLE_PC') || !me.hasLicensePerm('ENABLE_WAP')) {
			        $('#liToPC').remove();
			        $('#liToMobile').remove();
			    }
			}

			if (me.hasPerm('WyxAdm')) {
			    $('#liTowyx').show();
			} else {
			    $('#liTowyx').remove();
			}

			if (me.hasPerm('SysAdm') || (me.hasLicensePerm('ENABLE_FENXIAO') && me.hasPerm('OrderAdm'))) {
			    $('#liTosc').show();
			} else {
			    $('#liTosc').remove();
			}

			if (me.hasPerm("SiteAdm") && me.hasPerm('EditFront')) {
			    $('.wxEditorContent, .pcEditorContent').show();
			} else {
			    $('.wxEditorContent, .pcEditorContent').remove();
			}

			//if(getCookie('SiteType') == 0){
			//	$("#maintab").append("<li><div><div id='linkServiceHelp' class='tabHandle' style='text-align:center;display:none;'><i class='fa fa-question icon-2x'></i><br>服务</div></div></li>");
			//}

			//加载代理商信息
			/*
			var agentinfo = null;
			window['hideServiceHealTimeout'] = null;
			var wuserid = getCookie("WUserID");
			if(location.href.indexOf("debug") > -1) wuserid = "635700660416336250";
			$.getJSON("http://www.72e.net/autoweb/getagentinfo.aspx?wuserid="+ wuserid +"&callback=?", null, function (json) {
				if(json.success){
					agentinfo = json.info;
					if(agentinfo.logo) $("#divServiceHelp *[name=logo]").html("<img src='"+ agentinfo.logo +"'>");
					if(agentinfo.name) $("#divServiceHelp *[name=name]").html(agentinfo.name);
					if(agentinfo.tel) $("#divServiceHelp *[name=tel]").html(agentinfo.tel);
					if(agentinfo.domain) $("#divServiceHelp *[name=domain]").html("<a href='http://"+ agentinfo.domain +"' target='_blank'>" + agentinfo.domain + "</a>");

					$("#linkServiceHelp").show();
					$("#linkServiceHelp").on("mouseenter",function(){
						var left = ($(this).offset().left + $(this).outerWidth() + 2) + 'px';
						var top = $(this).offset().top + $(this).outerHeight() - $("#divServiceHelp").outerHeight();
						$("#divServiceHelp").css({left:left,top:top}).show();
					});
					$("#linkServiceHelp").on("mouseleave",function(){
						window['hideServiceHealTimeout'] = setTimeout(function(){$("#divServiceHelp").hide();},200);
					});
				}
			});
			$("#divServiceHelp").on("mouseleave",function(){$(this).hide()});
			$("#divServiceHelp").on("mouseenter",function(){clearTimeout(window['hideServiceHealTimeout'])});
			*/

			loadLangList();

			$("#LangueSelect").unbind().mouseover(function(){ loadLangList(); });
			$("#LangueSelect").unbind().change(function(){ 
				curlangsiteid = $(this).val();
				$.get("/index.php?c=admin/config/sitelangs&a=GetList&InitSiteID="+ curlangsiteid +"&Lang=" + $('#LangueSelect option:selected').attr("lang"),function(){ window.location = "index.html"; });
			});

			if (getCookie('SiteType') == 1) {
			    if (me.currentModule && me.currentModule.a == 'weixy' && me.currentModule.b == 'lucknew') {
			        CheckWeiXIn();
			        $('#liTowyx a').addClass('switchAct');
			    } else {
			        $('#liToMobile a').addClass('switchAct');
			    }

			    $('#liTowyx a').off('click').on('click', function () {
			        $('.switchStation a').removeClass('switchAct');
			        $('#liTowyx a').addClass('switchAct');
			        CheckWeiXIn();
			    });

			    if (window.location.hash == "#home.fxindex") {
			        $('.switchAct').removeClass('switchAct');
			        $('#liTosc a').addClass('switchAct');
			    }
			}

			$('#liToPC a').off('click').on('click', function () {
			    me.execCommand('go', { a: 'home', b: 'index' });
			    $('.switchStation a').removeClass('switchAct');
			    $('#liToPC a').addClass('switchAct');
			});

			$('#liToMobile a').off('click').on('click', function () {
			    me.execCommand('go', { a: 'home', b: 'index' });
			    $('.switchStation a').removeClass('switchAct');
			    $('#liToMobile a').addClass('switchAct');
			});

			$('#liTosc a').off().on('click', function () {
			    $('.switchAct').removeClass('switchAct');
			    $('#liTosc a').addClass('switchAct');
			    me.execCommand('go', { a: 'home', b: 'fxindex' });
			});


		});
	}

	function initHelp() {
	    $(document).off('click.btnPcGuidance').on('click.btnPcGuidance', '#btnPcGuidance', function () {
	        $('body').pagewalkthrough('close');
	        me.execCommand('go', { a: 'skin', b: 'skinlist' });
	    });

	    $(document).off('click.btnFxscGuidance').on('click.btnFxscGuidance', '#btnFxscGuidance', function () {
	        $('body').pagewalkthrough('close');
	        var searchParamsStr = JSON.stringify({ MetierID: 1015 });  // 1015 : 在线商城
	        searchParamsStr = encodeURIComponent(searchParamsStr);
	        me.execCommand('go', { a: 'skin', b: 'skinlist', params: { searchParams: searchParamsStr } });
	    });

	    $(document).off('click.btnWapGuidance').on('click.btnWapGuidance', '#btnWapGuidance', function () {
	        $('body').pagewalkthrough('close');
	        var searchParamsStr = JSON.stringify({ SiteType: 1, MetierID: '' });
	        searchParamsStr = encodeURIComponent(searchParamsStr);
	        me.execCommand('go', { a: 'skin', b: 'skinlist', params: { searchParams: searchParamsStr } });
	    });

	    $(document).off('click.btnWyxGuidance').on('click.btnWyxGuidance', '#btnWyxGuidance', function () {
	        $('body').pagewalkthrough('close');
	        var searchParamsStr = JSON.stringify({ SiteType: 1, MetierID: '1015' });  // 1015 : 在线商城
	        searchParamsStr = encodeURIComponent(searchParamsStr);
	        me.execCommand('go', { a: 'skin', b: 'skinlist', params: { searchParams: searchParamsStr } });
	    });

	    $(document).off('click.btnWapfxscGuidance').on('click.btnWapfxscGuidance', '#btnWapfxscGuidance', function () {
	        $('body').pagewalkthrough('close');
	        var searchParamsStr = JSON.stringify({ SiteType: 1, MetierID: '1015' });  // 1015 : 在线商城
	        searchParamsStr = encodeURIComponent(searchParamsStr);
	        me.execCommand('go', { a: 'skin', b: 'skinlist', params: { searchParams: searchParamsStr } });
	    });

	    $('body').pagewalkthrough('clearCache');
	    getCookie("SiteType") == "1" ? initMobileHelp() : initPcHelp();
	    noInstallSkin ? $('body').pagewalkthrough('show') : $('body').pagewalkthrough('renderOverlay');
	}

	function initMobileHelp() {
        // 微站帮助引导
	    if (!noInstallSkin) {
	        return;
	        // 安装过模板的显示这个引导
	        $('body').pagewalkthrough({
	            name: 'introduction-mobile',
	            steps: [{
	                wrapper: '#stepTargetElement',
	                popup: {
	                    content: '#walkthrough-mobile-2',
	                    type: 'tooltip',
	                    position: 'right'
	                },
	            }, {
	                wrapper: '#stepTargetElement',
	                popup: {
	                    content: '#walkthrough-mobile-3',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }, {
	                wrapper: '#stepTargetElement',
	                popup: {
	                    content: '#walkthrough-mobile-4',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }, {
	                wrapper: '#stepTargetElement',
	                popup: {
	                    content: '#walkthrough-mobile-5',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }, {
	                wrapper: '#stepTargetElement',
	                popup: {
	                    content: '#walkthrough-mobile-6',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }, {
	                wrapper: '#stepTargetElement',
	                popup: {
	                    content: '#walkthrough-mobile-7',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }, {
	                wrapper: '.editorBtn',
	                popup: {
	                    content: '#walkthrough-mobile-8',
	                    type: 'tooltip',
	                    position: 'left',
	                    width: 1000
	                }
	            }],

	            buttons: {
	                jpwClose: {
	                    i18n: '',
	                    show: true
	                },
	                jpwNext: {
	                    show: false
	                },
	                jpwPrevious: {
	                    show: false
	                },
	                jpwFinish: {
	                    show: false
	                }
	            }
	        });
	    } else {
	        $('body').pagewalkthrough({
	            name: 'introduction-mobile-noinstallskin',
	            steps: [{
	                popup: {
	                    content: '#walkthrough-mobile-1',
	                    type: 'modal',
	                    width: 1000
	                }
	            }],
	            buttons: {
	                // ID of the button
	                jpwClose: {
	                    // Translation string for the button
	                    i18n: '',
	                    // Whether or not to show the button.  Can be a boolean value, or a
	                    // function which returns a boolean value
	                    show: false
	                },
	                jpwNext: {
	                    i18n: '下一步 &rarr;',
	                    show: false//$.fn.pagewalkthrough.defaults.buttons.jpwNext.show//function() {
	                    //return !isLastStep();
	                    //}
	                },
	                jpwPrevious: {
	                    i18n: '&larr; 上一步',
	                    show: false//$.fn.pagewalkthrough.defaults.buttons.jpwPrevious.show//function() {
	                    //return !isFirstStep();
	                    //}
	                },
	                jpwFinish: {
	                    i18n: '完成 &#10004;',
	                    show: false//$.fn.pagewalkthrough.defaults.buttons.jpwFinish.show//function() {
	                    //return isLastStep();
	                    //}
	                }
	            }
	        });
	    }
	}

	function initPcHelp() {
	    // PC站帮助引导
	    if (!noInstallSkin) {
	        return;
            // 安装过模板的显示这个引导
	        $('body').pagewalkthrough({
	            name: 'introduction',
	            steps: [/*{
	                wrapper: '.stepInfo',
	                popup: {
	                    content: '#walkthrough-2',
	                    type: 'tooltip',
	                    position: 'bottom'
	                }
	            }, */{
	                wrapper: '#stepTargetElement',
	                popup: {
	                    content: '#walkthrough-3',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }, {
	                wrapper: '#stepTargetElement',
	                popup: {
	                    content: '#walkthrough-4',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }, {
	                wrapper: '#stepTargetElement',
	                popup: {
	                    content: '#walkthrough-5',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }, {
	                wrapper: '#stepTargetElement',
	                popup: {
	                    content: '#walkthrough-6',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }, {
	                wrapper: '#stepTargetElement',
	                popup: {
	                    content: '#walkthrough-7',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }, {
	                wrapper: '#stepTargetElement',
	                popup: {
	                    content: '#walkthrough-8',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }, {
	                wrapper: '.editorBtn',
	                popup: {
	                    content: '#walkthrough-9',
	                    type: 'tooltip',
	                    position: 'left',
	                    width: 1000
	                }
	            }],
	            buttons: {
	                jpwClose: {
	                    i18n: '',
	                    show: true
	                },
	                jpwNext: {
	                    show: false
	                },
	                jpwPrevious: {
	                    show: false
	                },
	                jpwFinish: {
	                    show: false
	                }
	            }
	        });
	    } else {
	        // 没有安装过模板的显示这个引导
	        $('body').pagewalkthrough({
	            name: 'introduction-noinstallskin',
	            steps: [{
	                popup: {
	                    content: '#walkthrough-1',
	                    type: 'modal',
	                    width: 1000
	                }
	            }],
	            buttons: {
	                // ID of the button
	                jpwClose: {
	                    // Translation string for the button
	                    i18n: '',
	                    // Whether or not to show the button.  Can be a boolean value, or a
	                    // function which returns a boolean value
	                    show: false
	                },
	                jpwNext: {
	                    i18n: '下一步 &rarr;',
	                    show: false//$.fn.pagewalkthrough.defaults.buttons.jpwNext.show//function() {
	                    //return !isLastStep();
	                    //}
	                },
	                jpwPrevious: {
	                    i18n: '&larr; 上一步',
	                    show: false//$.fn.pagewalkthrough.defaults.buttons.jpwPrevious.show//function() {
	                    //return !isFirstStep();
	                    //}
	                },
	                jpwFinish: {
	                    i18n: '完成 &#10004;',
	                    show: false//$.fn.pagewalkthrough.defaults.buttons.jpwFinish.show//function() {
	                    //return isLastStep();
	                    //}
	                }
	            }
	        });
	    }
	}
	
	var isloadingLang = false;
	var curlangsiteid = null;
	function loadLangList(){
		if(isloadingLang) return;
		isloadingLang = true;
		$.getJSON("/index.php?c=admin/config/sitelangs&a=GetList", null, function (json) {
			$("#LangueSelect").children().remove();
			for(var i = 0;i < json.list.length;i++){
				$("#LangueSelect").append("<option value='"+ json.list[i].SiteID +"' lang='"+ json.list[i].Lang +"'>"+ json.list[i].LangName +"</option>");
			}
			if(!curlangsiteid) $("#LangueSelect").val(getCookie("InitSiteID"));
			else $("#LangueSelect").val(curlangsiteid);
        });
		isloadingLang = false;
	}

	function initUI(root) {
        root.children().remove();
		myroot = root;
		var tpl = "";
        if (me.getBackstage()!=2) {
            tpl = "pcindex";
            if (getCookie("SiteType") == "1") {
                tpl = "wxindex";
            }
        } else {
            tpl = "pcindex2";
            if (getCookie("SiteType") == "1") {
                tpl = "wxindex2";
            }
        }

        root.loadHtmlTpl("plugins/homepackage/html/" + tpl + ".html?rand=" + Math.random(), function () {
			

            if (me.getBackstage() != 2) {
                // pc
                if (me.hasPerm('SysAdm')) {
                    $('.siteStep').show();
                    $('.information').show();
                    $('.contentRight').show();
                    //$('.pcEditorContent').show();
                    $('.pcCreateSiteFlow').show();
                    $('.lefDockGuide').show();
                } else {
                    $('.siteStep').remove();
                    $('.information').remove();
                    //$('.pcEditorContent').hide();
                    $('.pcCreateSiteFlow').remove();
                    $('.lefDockGuide').remove();
                }
                if (me.hasPerm("SiteAdm")) {
                    $('.fastChannel').show();
                    $('.contentRight').show();
                } else {
                    $('.fastChannel').remove();
                    $('.contentRight').remove();
                    $('.statistics').find('a').attr('href', 'javascript:;');
                }

                if (!me.hasPerm('SysAdm') && me.hasPerm("SiteAdm")) {
                    $('#common').appendTo('.contentRight').removeClass('tab-pane fade');
                    $('.contentRight .title-tabs, .contentRight .tab-content').hide();
                }

                // mobile
                if (me.hasPerm("SysAdm")) {
                    $('.contentLeft').show();
                    //$('.wxEditorContent').show();
                    $('.pcCreateSiteFlow').show();
                } else {
                    $('.contentLeft').remove();
                    //$('.wxEditorContent').hide();
                    $('.pcCreateSiteFlow').remove();
                }
                if (me.hasPerm("SiteAdm")) {
                    $('.contentRight').show();
                } else {
                    $('.contentRight').remove();
                }
                if (me.hasPerm('WyxAdm')) {
                    $('.wxActivity').show();
                } else {
                    $('.wxActivity').remove();
                }
            } else {
                // new index 
                if (me.hasPerm("SiteAdm")) {
                    $('#fenindex_shopconfig, #fenindex_shoppingmallconfig, #fenindex_shopstatistics, #fenindex_salesstatistics').show();
                } else {
                    $('#fenindex_shopconfig, #fenindex_shoppingmallconfig, #fenindex_shopstatistics, #fenindex_salesstatistics').remove();
                }

                if (me.hasPerm("UserAdm")) {
                    $('#fenindex_userlist').show();
                } else {
                    $('#fenindex_userlist').remove();
                }

                if (me.hasPerm("OrderAdm")) {
                    $('#fenindex_orderlist').show();
                } else {
                    $('#fenindex_orderlist').remove();
                }

                if (me.hasPerm("FenXiaoAdm")) {
                    $('#fenindex_tichengreview').show();
                } else {
                    $('#fenindex_tichengreview').remove();
                }

                if (me.hasPerm("FinanceAdm")) {
                    $('#fenindex_financelist').show();
                } else {
                    $('#fenindex_financelist').remove();
                }

                if (me.hasPerm("SiteAdm") || me.hasPerm("FinanceAdm")) {
                    $('#fenindex_tongji_panel').prev('.cfx').show();
                    $('#fenindex_tongji_panel').show();
                } else {
                    $('#fenindex_tongji_panel').prev('.cfx').remove();
                    $('#fenindex_tongji_panel').remove();
                }

                if (me.hasPerm("SysAdm")) {
                    $('#zhuang_xiu_zhi_nan, .contentLeft').show();
                } else {
                    $('#zhuang_xiu_zhi_nan, .contentLeft').remove();
                }

                if ($('.contentRight li').length > 0) {
                    $('.contentRight').show();
                } else {
                    $('.contentRight').remove();
                }
            }

			if(me.loginUser.SingleWeb){
				$('.contentLeft').hide();
				$('.indexSelSkin').hide();
				$('.t-num').html('');
			}

			var hoverImg = null;
			$('.isShow').hover(function (e) {
				if($(this).find('img').length === 0) return;
				var hoverLabel = $(this).children("label");
				hoverImg = setTimeout(function () {
					hoverLabel.fadeIn(300);
				}, 100);
			}, function (e) {
				clearTimeout(hoverImg);
				$(this).children("label").fadeOut(100);
			});

			loadInfo();
			//CheckWeiXIn();
			// 进入这个页面时打开侧栏菜单
            //$('#accordion>.wxskinmenu>.link').click();
			loadShopInfo();
		});
	}
	window["WeiXIn"] = 0;
	function CheckWeiXIn() {
	    $.ajax({
	        type: "POST",
	        url: "/index.php?c=admin/index&a=checkweixin",
//	        url: "/admin/index",
	        cache: false,
	        dataType: "json",
	        data: { 'a': 'CheckWeiXin' },
	        success: function (data) {
	            $("#WXModal").remove();
	            if (data) {
	                if (data.errorcode != 0) {
	                    if (window["WeiXIn"] == 0) {
	                        var sHtml = '';
	                        sHtml += '<div id="WXModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">';
	                        sHtml += '<div class="modal-dialog">';
	                        sHtml += '<div class="modal-content">';
	                        sHtml += '<div class="modal-header">';
	                        sHtml += '<button type="button" class="close" data-dismiss="modal" aria-label="Close">';
	                        sHtml += '<span aria-hidden="true" class="glyphicon glyphicon-remove" style="color:red;font-size: 1.8rem;"></span>';
	                        sHtml += '</button>';
	                        sHtml += '<h4 class="modal-title">微信息公众号配置失败提示！</h4>';
	                        sHtml += '</div>';
	                        sHtml += '<div class="modal-body">';
	                        sHtml += '<div class="alert alert-danger" role="alert"></div>';
	                        sHtml += '</div>';
	                        sHtml += '</div>';
	                        sHtml += '</div>';
	                        sHtml += '</div>';
	                        $(sHtml).appendTo('body');

	                        $("#WXModal").modal();
	                        var html = data.msg + '<br/><br/><a class="btn btn-primary goWXConfig" data-dismiss="modal" aria-label="Close">现在配置</a>';
	                        $("#WXModal").find(".alert-danger").html(html);
	                        $("#WXModal").on("hidden.bs.modal", function (e) {
	                            me.execCommand('go', { a: 'weixin', b: 'wxconfig' });
	                        });
	                        window["WeiXIn"] = 1;
	                    } else {
	                        me.execCommand('go', { a: 'weixy', b: 'lucknew' });
	                    }
	                }
	            }
	        },
	        error: function (XMLHttpRequest, textStatus, errorThrown) {
	            console.log(XMLHttpRequest.responseText);
	        }
	    });
	}

	function loadInfo(){
		$.getJSON("/index.php?c=admin/index&a=index", null, function (json) {
	    //$.getJSON("/admin/index", null, function (json) {
			if(json.skin === null || json.skin.SkinID == 'default'){
				json.skin = {
					MetierName: "无",
					SkinID: "",
					SkinName: "无"
				};
				$("#SkinImg").html("<img src='/images/noStencil.jpg' width='100%' />");
				$('#BtnVisitSite').attr('href', 'javascript:;').off().on('click',function(){
					me.execCommand('go', {a: 'skin', b: 'skinlist'});
				});
				$('#BtnDesignPage, .siteEditBtn').attr('href', 'javascript:;').off().addClass('disabled').prop('disabled', true);
			}else{
				noInstallSkin = json.noInstallSkin;
				ko.applyBindings(json,me.content[0]);
				if(getCookie("SiteType") == "1"){
					$("#SkinImg").html("<img src='/skin/" + json.skin.SkinID + "/skinsrc/styles/tempshowbig.jpg' width='100%' />");
					if(!json.info.HasWeixin){
						$(".bindingInfo > table").children().remove();
						$(".bindingInfo > table").append("<tr><td><b>您订购的当前版本不支持微信，请升级</b></td></tr>");
					}
				}else{
					$("#SkinImg").html("<img src='/skin/" + json.skin.SkinID + "/skinsrc/images/tempshowbig.jpg' width='100%' />");
					if(json.info.LicenseTips) $("#ReminderText").html(json.info.LicenseTips).show();
					if(json.info.HasWeixin != 1) $("*[WeixinItem=1]").hide();
				}
			}

			//if (me.hasPerm("SysAdm")) initHelp();
        });
	}

	function loadShopInfo() {
		$.getJSON("/index.php?c=admin/order/order&a=GetStatusCount", { queryStatus: "statusNoPay,statusOrderPay,statusOrderOver,statusRefundApply" }, function (json) {
//	    $.getJSON("/admin/order/order?act=GetStatusCount", { queryStatus: "statusNoPay,statusOrderPay,statusOrderOver,statusRefundApply" }, function (json) {
	        if (json.success && json.statusObj) {
	            $('.statusNoPay').text(json.statusObj.statusNoPay);
	            $('.statusOrderPay').text(json.statusObj.statusOrderPay);
	            $('.statusOrderOver').text(json.statusObj.statusOrderOver);
	            $('.statusRefundApply').text(json.statusObj.statusRefundApply);
	        }
	    });
	}
};

﻿IWF.plugins['news'] = function () {

    var me = this;
    var nav = { icon: 'fa fa-book', title: '文章',color:'icon-blue', a: 'news', b: 'newslist', index: 4, canClose: false };

    var leftRoot, rightRoot, leftNav;

    var navConfig = {
        showOption:false,
        data: [
            { icon: 'fa fa-list-ul', color: 'icon-red', title: '文章列表', a: 'news', b: 'newslist' }
			, { icon: 'fa fa-list-alt', color: 'icon-blue', title: '文章分类', a: 'news', b: 'newsclass' }
            , { icon: 'fa fa-plus', color: 'icon-red', title: '新增/修改文章', a: 'news', b: 'newsedit' }
			, { icon: 'fa fa-cog', color: 'icon-green', title: '高级设置', a: 'news', b: 'newsconfig' }
        ],

        onItemClick: function (sender, data) {
			leftNav.hide();	
			me.execCommand('go', data);
        },

        setSelect: function (args) {
            var index = 0;
            $.each(navConfig.data, function (i, item) {
                index++;
                if (item.a == args.a && item.b == args.b) {
                    navConfig.selectIndex = index;
                }
                if (item.items) {
                    $.each(item.items, function (k, citem) {
                        index++;
                        if (citem.a == args.a && citem.b == args.b) {
                            navConfig.selectIndex = index;
                        }
                    });
                }
            });
        }
    };

    me.addListener('init', function () { 
		
		if(me.hasPerm("SiteAdm") || me.hasPerm("ArticleAdm")){
			var tab = me.execCommand('addtab', nav); 
			if (tab.c.children().length == 0) {
				var temp = $('<div class="row"></div>').appendTo(tab.c);
				//leftRoot = $('<div class="col-sm-1 col-md-2 mainside"></div>').appendTo(temp);
				rightRoot = $('<div class="col-sm-9 col-md-10 col-sm-offset-3 col-md-offset-0"></div>').appendTo(temp);
				//leftRoot.append('<div class="navcontent"></div>');
			}

			leftNav = $('<div class="sidebarNavPanel"><div class="titlebar"><div class="title">'+ nav.title +'</div></div><div class="content"><ul></ul></div></div>').appendTo("body");
			leftNav.find('.content>ul').listNav2(tab,leftNav,navConfig);

			tab.t.click(function(){ leftNav.hide(); });
		}
	});

    function flash(args, tab,isgo) {
        
        //navConfig.setSelect(args);
        //leftRoot.find('div.navcontent').listNav(navConfig);

		me.execCommand('show', { a: args.a });
        setChildWindow(args,rightRoot,isgo);
    }

    function setChildWindow(args, root,isgo) {
        /*var temp = root.find('#' + args.b);
        if (temp.length == 0) {
            temp = $('<div id="' + args.b + '"></div>').appendTo(root);
        }
        temp.show();
        temp.siblings().hide();
        if(isgo) me.execCommand('go', args);
		else me.fireEvent(args.b, temp);*/

		if(isgo) me.execCommand('go', args);
		else me.fireEvent(args.b, me.content); //me.content 定义在 core/content.js 里
    }

    me.commands['initContentNav' + nav.a] = {
        execCommand: function (key, domObj) {
            var items = $.map(navConfig.data, function (obj) { return $.extend(true, {}, obj); });
            me.execCommand('addContentNav', domObj, items);
        }
    }

    me.addListener(nav.a, function (key, args) {
        var tab = me.execCommand('gettab', nav);
        flash(args, tab);
    });
};

﻿
IWF.plugins['newsclass'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
		this.array = [];
        this.setData = function (data) { this.array = data;this.list(data);};
		this.getSublist = function(parentid){
			var ret = [];
			for(var i = 0;i < this.array.length;i++){
				if(this.array[i].ParentID == parentid) ret.push(this.array[i]);
			}
			return ret;
		};
		this.getRootList = function(selectValue){
			var ret = [];
			ret.push({ClassID:0, Name: '设置根类别', Selected: false});
			for(var i = 0;i < this.array.length;i++){
				if(this.array[i].ParentID == 0){
					var obj = this.array[i];
					if(selectValue == obj.ClassID) obj['Selected'] = true;
					else obj['Selected'] = false;
					ret.push(obj);
				}
			}
			return ret;
		};
    };
	
	var vm = new ViewModel();
	function initUI(root) {
        root.empty();
        root.loadHtmlTpl("plugins/newspackage/html/newsclass.html", function () {
            me.execCommand('initContentNav', root);
			ko.applyBindings(vm,root[0]);
			bindUIEvent();
			loadNewsClassList();
		});
    }

    function loadNewsClassList() {
       // $.getJSON("/admin/news?act=getclasslist", utils.params({}), function (json) {
    	$.getJSON("/index.php?c=admin/news/news&a=getclasslist", utils.params({}), function (json) {
			if(json.success){
				if(json.sitetype === 1){
					for(var x = 0;x < json.list.length;x++){
						json.list[x].EnableCust = json.list[x].MobileEnableCust;
						json.list[x].PageID = json.list[x].MobilePageID;
					}
				}
				vm.setData(json.list);
				bindGridEvent();
			}else{
				alert("出错了：" + json.msg);
			}
        });
    }

	function showResult(title,msg,autoClose) {
		$("#ResultDialog").remove();
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
		if(autoClose && autoClose > 0){
			setTimeout(function(){ $("#ResultDialog").remove(); },autoClose);
		}
	}
	
	
	function showNewsClassEditDialog(classid,parentid) {
		$.ajax({
				type: "get",
				url:'/index.php?c=admin/news/news&a=GetClassInfo',
	            async: false,
	            cache: false,
	            dataType: "json",
	            data: { ClassID:classid},
	            success: function (data) {
	            	if (!data.success) {
	                    showErrMsg(data.msg);
	                    return;
	                }
  		
	            	var html = "<div id='NewsClassEditDialog'>";
	            	html += "<form>";
	            	html += "<input type='hidden' name='tbClassID' value='"+classid+"'/>";
	            	html += "<p>";
	        		html += "分类名称：<input type='text' name='tbName' size='10' value='"+data.info.Name+"' class='form-control input' style='width:260px;'/>";
	        		html += "</p>";
	        		html += "<p>";
	        		html += "所属父类：<select name='slParentID' class='form-control' style='display:inline;width:260px;' data-bind='options: $root.getRootList("+classid+"), optionsText: \"Name\",optionsValue: \"ClassID\",value: "+parentid+"'></select>";
	        		html += "</p>";	
	        		html += "<input type='button' class='btn btn-primary' style='display:blcok;margin:0 auto;' name='btnEditNewsClass' value='保存'>";
	        		html += "</form>";
	        		html += "</div>";
	        		$("body").append(html);
	        		ko.applyBindings(vm, $('#NewsClassEditDialog')[0]);

	        		$("*[name=btnEditNewsClass]").unbind('click').bind('click', function (event) {
	        			var form = $(this).closest('form');
	        			var formVals = form.serializeObject();
	        			var params = {ClassID: formVals.tbClassID,Name: formVals.tbName,ParentID: formVals.slParentID};
	        			$.getJSON("/index.php?c=admin/news/news&a=editclass", utils.params(params), function (json) {
	        				if(json.success){
	        					$.showResult(true,"修改成功",1000);
	        					$("#NewsClassEditDialog").dialog('close');
	        					loadNewsClassList();
	        				}else{
	        				    $.showResult(false, json.msg);
	        				}
	        			});
	        			
	        		});
	        		
	        		$("#NewsClassEditDialog").dialog({
	        			resizable: false,
	        			title: "修改文章分类",
	        			modal: true,
	        			width: 385,
	        			height: 200,
	        			position: ['center', 'middle'],
	        			close: function(event, ui) { $(this).remove(); },
	        		});

	            },
	            error: function (data) {         	
	                alert("<?php echo \YouZhan\Commons\Common::lg('loadfailed'); ?>");
	            }		
		});		
	}
	
	

	function bindUIEvent(){
		$("#BtnAddNewClass").bind("click",function(){
			var form = $(this).closest('form');
			var formVals = $(form).serializeObject();
			var params = {Name: formVals.tbName,ParentID: formVals.slParentID};
			//$.getJSON("/admin/news?act=editclass", utils.params(params), function (json) {
			$.getJSON("/index.php?c=admin/news/news&a=editclass", utils.params(params), function (json) {
				if(json.success){
				    $.showResult(true, "添加成功", 1000);
					loadNewsClassList();
					$('[name=tbName]').val('');
				}else{
				    $.showResult(false, json.msg);
				}
			});
		});

		$('[name=tbName]').unbind('keypress').bind('keypress', function (evt) {
		    if (evt.keyCode == 13) {
		        $('#BtnAddNewClass').click();
		        evt.stopPropagation();
		        return false;
		    }
		});
	}

	function bindGridEvent() {
		$(".Tables").disableSelection();
		$(".sortUl").sortable({
			handle: ".T1",
			start: function (event, ui) {
				ui.item.css({ "border": "solid 1px red" });
			},
			update: function (event, ui) {

				var orders = new String();
				$(this).find(".MoveItem").each(function (i) {
					orders += $(this).attr("value") + "-" + i + ",";
				});
				$.ajax({
					type: "POST",
					dataType: 'json',
					//url: '/admin/news',
					//data: { act: "MoveClassOrder", Order: orders },
					url: '/index.php?c=admin/news/news',
					data: { a: "MoveClassOrder", Order: orders },
					success: function (json) {
						if(json.success) loadNewsClassList();
						else alert("出错了：" + json.msg);
					},
					error: function (XMLHttpRequest, textStatus, errorThrown) {
						alert("系统出错了." + errorThrown);
					}
				});
			}, stop: function (event, ui) {
				ui.item.css({ "border": "0" });
			}
		});

		$(".SubTable").sortable({
			handle: ".SubHandle",
			start: function (event, ui) {
				ui.item.css({ "border": "solid 1px red" });
			},
			update: function (event, ui) {
				
				var orders = new String();
				$(this).find(".SubHandle").each(function (i) {
					orders += $(this).attr("value") + "-" + i + ",";
				});
				$.ajax({
					type: "POST",
					dataType: 'json',
					//url: '/admin/news',
					//data: { act: "MoveClassOrder", Order: orders },
					url: '/index.php?c=admin/news/news',
					data: { a: "MoveClassOrder", Order: orders },
					success: function (json) { 
						if(json.success) loadNewsClassList();
						else alert("出错了：" + json.msg);
					},
					error: function (XMLHttpRequest, textStatus, errorThrown) {
						alert("系统出错了.");
					}
				});
			}, stop: function (event, ui) {
				ui.item.css({ "border": "0", "border-bottom": "solid 1px #ccc" });
			}
		});

		$("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
			showNewsClassEditDialog($(this).attr("ClassID"),$(this).attr("ParentID"));
			return false;
        });

		$("*[name=BtnDel]").bind("click",function(){
			if(!confirm("确认删除？")) return;
			//$.getJSON("/admin/news?act=deleteclass", utils.params({ClassID:$(this).attr("ClassID")}), function (json) {
			$.getJSON("/index.php?c=admin/news/news&a=deleteclass", utils.params({ClassID:$(this).attr("ClassID")}), function (json) {
				loadNewsClassList();
			});
		});

		$("*[name=BtnEnableCust]").unbind('click').bind('click', function (event) {
            var form = $(this).closest('form');
			var formVals = form.serializeObject();
			var params = {ClassID: $(this).attr("ClassID"),EnableCust: 1};
			//$.getJSON("/admin/news?act=editclasscust", utils.params(params), function (json) {
			$.getJSON("/index.php?c=admin/news/news&a=editclasscust", utils.params(params), function (json) {
				if(json.success){
					//$.showResult("提示","修改成功",1000);
					loadNewsClassList();
				}else{
				    $.showResult(false, json.msg);
				}
			});
        });

		$("*[name=BtnDisableCust]").unbind('click').bind('click', function (event) {
            var form = $(this).closest('form');
			var formVals = form.serializeObject();
			var params = {ClassID: $(this).attr("ClassID"),EnableCust: 0};
			//$.getJSON("/admin/news?act=editclasscust", utils.params(params), function (json) {
			$.getJSON("/index.php?c=admin/news/news&a=editclasscust", utils.params(params), function (json) {
				if(json.success){
					//$.showResult("提示","修改成功",1000);
					loadNewsClassList();
				}else{
				    $.showResult(false, json.msg);
				}
			});
        });

		$("*[name=BtnDesignCust]").bind("click",function(){
		    var url = "/NewsCust/" + $(this).attr("PageID") + "-" + $(this).attr("ClassID") + '.html';
			window.open(url);
		});
	}

    me.addListener('newsclass', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['newsconfig'] = function () {

	var me = this;
	
	var myroot = null;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/newspackage/html/newsconfig.html", function () {
            if (getCookie("SiteType") == 0) {
                $('#pcSetting').show();
                $('#mobileSetting').hide();
            } else if (getCookie("SiteType") == 1) {
                $('#pcSetting').hide();
                $('#mobileSetting').show();
            }
            me.execCommand('initContentNav', root);
			$("#BtnSave").unbind('click').click(function(){
				submitForm();
			});
			
			$('#BtnSave').floatSaveBtn();
			
			myroot = root[0];
			loadConfigInfo();
		});
    }

    function loadConfigInfo() {
    	//$.getJSON("/admin/news?act=getconfig", null, function (json) {
        $.getJSON("/index.php?c=admin/news/news&a=getconfig", null, function (json) {
			ko.applyBindings(json.config,myroot);
        });
    }

    function submitForm() {
        var params = $('#NewsConfigForm').serialize();
        //$.post("/admin/news?act=editconfig",params,function(data, textStatus, jqXHR){
		$.post("/index.php?c=admin/news/news&a=editconfig",params,function(data, textStatus, jqXHR){
			if(data.success){
			    $.showResult(true, "保存成功", 1500);
			}else{
			    $.showResult(false, json.msg);
			}
		},"json");
    }

    me.addListener('newsconfig', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['newsedit'] = function () {

    var me = this;
		
	var ViewModel = function() {
        this.setData = function (data) {
			for(var key in data){
				if(typeof(data[key]) == "object") this[key] = ko.observableArray(data[key]);
				else this[key] = ko.observable(data[key]);
			}
		};
		this.getPublishTime = function(time){
			return time().replace(/T/g," ");
		}
		this.getCheckVal = function(value){
			value = value();
			if(value == '0' || value == 'false') return false;
			return value;
		}
    };
	
	var vm = new ViewModel();
	var myroot = null;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/newspackage/html/newsedit.html?rand=" + Math.random(),function() {
            me.execCommand('initContentNav', root);
			$.validator.addMethod("dateTime", function (value, element) {
                return this.optional(element) || checkDateTime(value);
            }, "时间格式不正确");

			$("#NewsEditForm").validate({
                rules: {
                    tbTitle: "required",
                    tbPublishTime: { required: true, dateTime: true },
                    tbHits: { digits: true }
                },
                messages: {
                    tbTitle: { required: "请输入文章标题" },
                    tbPublishTime: { required: "请选择发布时间", dateTime: "时间格式不正确" },
                    tbHits: { digits: "请输入整数" }
                },
				submitHandler: function (form) {
					submitForm();
					return false;
				}
			});

			//$("#NewsEditTabs",root).tabs({ active: 0 });

			$("#forBaseTable,#forSeoTable,#forAdvTable").bind("click",function(e){ return false;});

			$('#openImageBtn',root).on('click', function () {
                YDM.FileManager('image', 1, function (aUrl) {
                    if (aUrl.length > 0) {
                        $('#previewImgUrl').val(aUrl[0]);
                        $('#previewImg').attr('src', aUrl[0]);
                    }
                })
            });

            $('#clearImageBtn',root).on('click', function () {
                $('#previewImgUrl').val('');
                $('#previewImg').attr('src', '');
            });

            if ($('#publishTime').val() == '') {
                $('#publishTime').val(dtToStr(new Date(), 'yyyy-MM-dd hh:mm:ss'));
            }

            $('#publishTime', myroot).datetimepicker({
                dayOfWeekStart: 1,
                lang: 'ch',
                format: 'Y-m-d H:i:s'
            });

			$('#saveBtn').floatSaveBtn();
			
			loadClsList();
			myroot = root[0];
			if(me.currentModule.params && me.currentModule.params.id) loadNews();
			else initUE();
		});
    }

	function dtToStr(date, fmt) {
	    var o = {
	        "M+": date.getMonth() + 1,                 //月份   
	        "d+": date.getDate(),                    //日   
	        "h+": date.getHours(),                   //小时   
	        "m+": date.getMinutes(),                 //分   
	        "s+": date.getSeconds(),                 //秒   
	        "q+": Math.floor((date.getMonth() + 3) / 3), //季度   
	        "S": date.getMilliseconds()             //毫秒   
	    };
	    if (/(y+)/.test(fmt))
	        fmt = fmt.replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
	    for (var k in o)
	        if (new RegExp("(" + k + ")").test(fmt))
	            fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
	    return fmt;
	}

	var classlist = null;
	function loadClsList() {
		//$.ajax({ url: "/admin/news?act=GetClassList", async: false, dataType: "json", success: function (json) {
		$.ajax({ url: "/index.php?c=admin/news/news&a=GetClassList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					classlist = json.list;
					for(var i = 0;i < json.list.length;i++){
						if(json.list[i].ParentID == 0){
							$("#slClassID").append("<option value='"+ json.list[i].ClassID +"'>"+ json.list[i].Name +"</option>");
							for(var j = 0;j < json.list.length;j++){
								if(json.list[j].ParentID == json.list[i].ClassID){
									$("#slClassID").append("<option value='"+ json.list[j].ClassID +"'> └- "+ json.list[j].Name +"</option>");
								}
							}
						}
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}
	
	var ue = null;
	function initUE() {
	    try {
	        //if (ue != null) {
	            //ue.destroy();
	        //}
	        ue = new baidu.editor.ui.Editor({
	            initialFrameHeight: "300",
	            autoHeightEnabled: true,
	            toolbars: [[
                     'source', '|', 'undo', 'redo', '|',
                     'bold', 'italic', 'underline', 'fontborder', 'strikethrough', 'superscript', 'subscript', 'removeformat', 'formatmatch', 'autotypeset', 'blockquote', 'pasteplain', '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|',
                     'rowspacingtop', 'rowspacingbottom', 'lineheight', '|',
                     'customstyle', 'paragraph', 'fontfamily', 'fontsize', '|',
                     'directionalityltr', 'directionalityrtl', 'indent', '|',
                     'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', '|', 'touppercase', 'tolowercase', '|',
                     'link', 'unlink', 'anchor', '|', 'imagenone', 'imageleft', 'imageright', 'imagecenter', '|',
                     'insertvideo','map', 'gmap', 'insertcode', 'pagebreak',  '|',
                     'horizontal','date', 'time', 'spechars',  '|',
                     'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols','|',
                     'searchreplace'
	            ]]
	        });
	        ue.ready(function () {
	            ue.setContent($("#tbContent", myroot).val());
	        });
	        ue.render('editor');
		} catch (e) {
		    console.log("error: " + e);
		}
	}

    function loadNews() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        //$.getJSON("/admin/news?act=GetNewsInfo", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/news/news&a=GetNewsInfo", utils.params(params), function (json) {
			vm.setData(json.info);
			ko.applyBindings(vm,myroot);
			initUE();
        });
    }

	function checkDateTime(value) {
		var aPart = value.split(/\s+/);
		if (aPart.length != 2)
			return false;

		// date
		sDateRegex = /^(?:(?!0000)[0-9]{4}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-8])|(?:0[13-9]|1[0-2])-(?:29|30)|(?:0[13578]|1[02])-31)|(?:[0-9]{2}(?:0[48]|[2468][048]|[13579][26])|(?:0[48]|[2468][048]|[13579][26])00)-02-29)$/
		if (!sDateRegex.test(aPart[0])) {
			return false;
		}

		// time
		sTimeRegex = /^([0-2][0-9]):([0-5][0-9]):([0-5][0-9])$/;
		if (!sTimeRegex.test(aPart[1])) {
			return false;
		} else {
			if ((parseInt(RegExp.$1) >= 24) || (parseInt(RegExp.$2) >= 60) || (parseInt(RegExp.$3) >= 60)) {
				return false;
			}
		}

		return true;
	}

    function submitForm(form) {
		var html = ue.getContent();
		$('#tbContent').val(html);
        var params = $('#NewsEditForm').serialize();
		//console.log(params);return;
        //$.post("/admin/news?act=EditNews", params, function (data, textStatus, jqXHR) {
        $.post("/index.php?c=admin/news/news&a=EditNews", params, function (data, textStatus, jqXHR) {
            if (data.success) {
                $.showResult(true, "设置已保存", 2000, function () {
                    if (me.currentModule.params && me.currentModule.params.id && me.currentModule.params.searchParams) {
		                me.execCommand('go', { a: 'news', b: 'newslist', params: { searchParams: me.currentModule.params.searchParams } });
		            } else {
		                me.execCommand('go', { a: 'news', b: 'newslist' });
		            }
                });
            } else {
                $.showResult(false, data.msg);
            }
		},"json");
    }

    me.addListener('newsedit', function (key, args) {
		initUI(args);
    });
}

﻿
IWF.plugins['newslist'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.adminlist = ko.observableArray();
        this.setData = function (data) { this.adminlist(data); };
		this.getClassName = function(classid){
			for(var i = 0;i < classlist.length;i++){
				if(classlist[i].ClassID == classid){
					return classlist[i].Name;
				}
			}
			return "未分类";
		}
		this.getTime = function (time) {
		    return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
		}
    };

	var vm = new ViewModel();
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/newspackage/html/newslist.html", function () {
            me.execCommand('initContentNav', root);
			bindUIEvent();
			loadClsList();
			ko.applyBindings(vm,root[0]);
			if (me.currentModule.params && me.currentModule.params.searchParams) {
			    try{
			        searchParams = JSON.parse(decodeURIComponent(me.currentModule.params.searchParams));
			        $("#keyword").val(searchParams.keyword, $("#classid").val(searchParams.classid));
			        loadNewsList(1, searchParams);
			    } catch (ex) {
			        loadNewsList(1);
			    }
			} else {
			    loadNewsList(1);
			}
			// loadNewsList(1);
		});
    }
	
	var classlist = null;
	function loadClsList() {
		$("#classid").children().remove();
		$("#classid").append("<option value=''>--全部分类--</option>");
		//$.ajax({ url: "/admin/news?act=GetClassList", async: false, dataType: "json", success: function (json) {
		$.ajax({ url: "/index.php?c=admin/news/news&a=GetClassList", async: false, dataType: "json", success: function (json) {
				if(json.success){
					classlist = json.list;
					for(var i = 0;i < json.list.length;i++){
						if(json.list[i].ParentID == 0){
							$("#classid").append("<option value='"+ json.list[i].ClassID +"'>"+ json.list[i].Name +"</option>");
							for(var j = 0;j < json.list.length;j++){
								if(json.list[j].ParentID == json.list[i].ClassID){
									$("#classid").append("<option value='"+ json.list[j].ClassID +"'> &nbsp;&nbsp;└-"+ json.list[j].Name +"</option>");
								}
							}
						}
					}
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}
    
	var curpage = 1;
	var itemcount = 0;
	var searchParams = {};
    function loadNewsList(page, params) {
        params = params || { sid: me.sid, keyword: $("#keyword").val(),classid : $("#classid").val(), status: $("#status").val(), page: page, pagesize: 20 };
        //$.getJSON("/admin/news?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/news/news&a=getlist", utils.params(params), function (json) {
            vm.setData(json.list);
			$('#selectAll').prop("checked",false);
			curpage = json.curpage;
			itemcount = json.list.length;
			$(".articleName").each(function () { $(this).attr("href", json.detailurl.replace("{ID}", $(this).attr("articleID"))); });
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadNewsList(page); });
                $("#pagination").show();
            }

            bindGridEvent();
            searchParams = params;
        });
    }

	function showSetClassDialog(id,classid){
		var html = "<div id='SelClassDialog'><center>";
		html += "请选择分类：<select id='setclass_clsid' class='form-control' style='width:160px;display:inline'>";
		html += $("#classid").html();
		html += "</select>";
		$("body").append(html);
		$("#setclass_clsid option:first-child").remove();
		$("#setclass_clsid").val(classid);
		$("#SelClassDialog").dialog({ resizable: false, title: "设置分类", modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); },
			buttons: { "确定": function() { 
									setClass(id,$("#setclass_clsid").val());
									$(this).remove();
							   },
					   "取消": function() { $(this).remove(); }
			}
		});
	}

	function setClass(id,classid){
		var params = {'id':id, 'classid': classid};
		//$.post("/admin/news?act=setclass",params,function(data, textStatus, jqXHR){
		$.post("/index.php?c=admin/news/news&a=setclass",params,function(data, textStatus, jqXHR){	
			if(data.success){
				loadNewsList(curpage);
			}else{
				alert(json.msg);
			}
		},"json");
	}

	function getSelectedArtIDs(){
		var array = new Array();
		$("input[name=artid]:checked").each(function(){
			array.push($(this).val());
		});
		var id = array.join(',');
		return id;
	}

	function showResult(title,msg,autoClose) {
		$("#ResultDialog").remove();
		$("body").append("<div id='ResultDialog' style='background:#fff;padding:10px'>" + msg + "</div>");
		$("#ResultDialog").dialog({ resizable: false, title: title, modal: true, width: 300, position: ['center', 'middle'], close: function (event, ui) { $(this).remove(); } });
		if(autoClose && autoClose > 0){
			setTimeout(function(){ $("#ResultDialog").remove(); },autoClose);
		}
	}

	function bindUIEvent(){
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadNewsList(1);
        });

		$('#selectAll').unbind().on('click', function () {
			$('#showListTable :checkbox:gt(0)').prop('checked', $('#showListTable :checkbox:eq(0)').prop('checked'));
		});

		$("#BtnAddNews").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'news', b: 'newsedit' });
			return false;
        });
		
		$('#BtnSetClass').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else showSetClassDialog(id,0);
			$(document).click();
			return false;
		});

		$('#BtnSetStatus1').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				//$.getJSON("/admin/news?act=setstatus", utils.params({id:id,status: 1}), function (json) {
				$.getJSON("/index.php?c=admin/news/news&a=setstatus", utils.params({id:id,status: 1}), function (json) {
					if(json.success) loadNewsList(curpage);
					else{
						showResult("出错啦",json.msg);
					}
				});
			}
			$(document).click();
			return false;
		});

		$('#BtnSetStatus0').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				//$.getJSON("/admin/news?act=setstatus", utils.params({id:id,status: 0}), function (json) {
				$.getJSON("/index.php?c=admin/news/news&a=setstatus", utils.params({id:id,status: 0}), function (json) {	
					if(json.success) loadNewsList(curpage);
					else{
						showResult("出错啦",json.msg);
					}
				});
			}
			$(document).click();
			return false;
		});

		$('#BtnSetRecommend1').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				//$.getJSON("/admin/news?act=setrecommend", utils.params({id:id,recommend: 1}), function (json) {
				$.getJSON("/index.php?c=admin/news/news&a=setrecommend", utils.params({id:id,recommend: 1}), function (json) {
					if(json.success) loadNewsList(curpage);
					else{
						showResult("出错啦",json.msg);
					}
				});
			}
			$(document).click();
			return false;
		});

		$('#BtnSetRecommend0').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				//$.getJSON("/admin/news?act=setrecommend", utils.params({id:id,recommend: 0}), function (json) {
				$.getJSON("/index.php?c=admin/news/news&a=setrecommend", utils.params({id:id,recommend: 0}), function (json) {
					if(json.success) loadNewsList(curpage);
					else{
						showResult("出错啦",json.msg);
					}
				});
			}
			$(document).click();
			return false;
		});

		$('#BtnSetTop1').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				//$.getJSON("/admin/news?act=settop", utils.params({id:id,top: 1}), function (json) {
				$.getJSON("/index.php?c=admin/news/news&a=settop", utils.params({id:id,top: 1}), function (json) {
					if(json.success) loadNewsList(curpage);
					else{
						showResult("出错啦",json.msg);
					}
				});
			}
			$(document).click();
			return false;
		});

		$('#BtnSetTop0').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				//$.getJSON("/admin/news?act=settop", utils.params({id:id,top: 0}), function (json) {
				$.getJSON("/index.php?c=admin/news/news&a=settop", utils.params({id:id,top: 0}), function (json) {
					if(json.success) loadNewsList(curpage);
					else{
						showResult("出错啦",json.msg);
					}
				});
			}
			$(document).click();
			return false;
		});

		$('#BtnDelSelected').unbind().on('click', function () {
			var id = getSelectedArtIDs();
			if(!id) alert('请至少选择一篇文章');
			else{
				if(confirm("确认删除吗?")){
					//$.getJSON("/admin/news?act=delete", utils.params({'id': id}), function (json) {
					$.getJSON("/index.php?c=admin/news/news&a=delete", utils.params({'id': id}), function (json) {
						if(json.success){
							if(id.split(',').length >= itemcount) loadNewsList(1);
							else loadNewsList(curpage);
						}else{
							showResult("出错啦",json.msg);
						}
					});
				}
			}
			return false;
		});

		$('#BtnDelAll').unbind().on('click', function () {
			if(confirm("确认删除吗?")){
				//$.getJSON("/admin/news?act=deleteall", null, function (json) {
				$.getJSON("/index.php?c=admin/news/news&a=deleteall", null, function (json) {
					if(json.success) loadNewsList(1);
					else{
						showResult("出错啦",json.msg);
					}
				});
			}
			return false;
		});
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
        	var searchParamsStr = JSON.stringify(searchParams);
            searchParamsStr = encodeURIComponent(searchParamsStr);
            console.log(searchParamsStr);
            me.execCommand('go', { a: 'news', b: 'newsedit', params: { id: $(this).attr("AID"), searchParams: searchParamsStr } });
            // me.execCommand('go', { a: 'news', b: 'newsedit', params: { id: $(this).attr("AID")} });
			return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			//$.getJSON("/admin/news?act=Delete", utils.params({id:$(this).attr("AID")}), function (json) {
			$.getJSON("/index.php?c=admin/news/news&a=Delete", utils.params({id:$(this).attr("AID")}), function (json) {
				if(json.success){
					if(itemcount > 1) loadNewsList(curpage);
					else loadNewsList(1);
				}else{
					showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetActive]").unbind('click').bind('click', function (event) {
			//$.getJSON("/admin/news?act=setstatus", utils.params({id:$(this).attr("AID"),status: 1}), function (json) {
			$.getJSON("/index.php?c=admin/news/news&a=setstatus", utils.params({id:$(this).attr("AID"),status: 1}), function (json) {
				if(json.success){
					loadNewsList(curpage);
				}else{
					showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetTop]").unbind('click').bind('click', function (event) {
			//$.getJSON("/admin/news?act=settop", utils.params({id:$(this).attr("AID"),status: 1}), function (json) {
			$.getJSON("/index.php?c=admin/news/news&a=settop", utils.params({id:$(this).attr("AID"),status: 1}), function (json) {
				if(json.success) loadNewsList(curpage);
				else{
					showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetRecommend]").unbind('click').bind('click', function (event) {
			//$.getJSON("/admin/news?act=setrecommend", utils.params({id:$(this).attr("AID"),status: 1}), function (json) {
			$.getJSON("/index.php?c=admin/news/news&a=setrecommend", utils.params({id:$(this).attr("AID"),status: 1}), function (json) {
				if(json.success) loadNewsList(curpage);
				else{
					showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetClass]").unbind('click').bind('click', function (event) {
			showSetClassDialog($(this).attr("AID"),$(this).attr("ClassID"));
			return false;
        });		
    }

    me.addListener('newslist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

IWF.plugins['o2o'] = function () {

    var me = this;
    var nav = { icon: 'fa fa-shopping-cart', title: '店掌柜', color: 'icon-blue', a: 'o2o', b: 'storemanage', index: 2, canClose: false , licensePerm: 'ENABLE_AGENT'};
    var leftRoot, rightRoot, leftNav;

    var navConfig = {
        showOption:false,
        data: [
            { icon: 'fa fa-shopping-cart', color: 'icon-red', title: '店铺管理', a: 'o2o', b: 'storemanage', licensePerm: 'ENABLE_AGENT' },
            { icon: 'fa fa-share-alt', color: 'icon-blue', title: '代理设置', a: 'o2o', b: 'shopconfig', licensePerm: 'ENABLE_AGENT' },
            { icon: 'fa fa-shopping-cart', color: 'icon-blue', title: '店掌柜设置', a: 'o2o', b: 'o2oconfig', licensePerm: 'ENABLE_UPLOAD_PRODUCT' }
        ],

        onItemClick: function (sender, data) {
            leftNav.hide(); 
            me.execCommand('go', data);
        },

        setSelect: function (args) {
            var index = 0;
            $.each(navConfig.data, function (i, item) {
                index++;
                if (item.a == args.a && item.b == args.b) {
                    navConfig.selectIndex = index;
                }
                if (item.items) {
                    $.each(item.items, function (k, citem) {
                        index++;
                        if (citem.a == args.a && citem.b == args.b) {
                            navConfig.selectIndex = index;
                        }
                    });
                }
            });
        }
    };

    me.addListener('init', function () { 
        if(me.hasPerm("SiteAdm") || me.hasPerm("ArticleAdm")){
            var tab = me.execCommand('addtab', nav); 
            if (tab.c.children().length == 0) {
                var temp = $('<div class="row"></div>').appendTo(tab.c);
                //leftRoot = $('<div class="col-sm-1 col-md-2 mainside"></div>').appendTo(temp);
                rightRoot = $('<div class="col-sm-9 col-md-10 col-sm-offset-3 col-md-offset-0"></div>').appendTo(temp);
                //leftRoot.append('<div class="navcontent"></div>');
            }

            leftNav = $('<div class="sidebarNavPanel"><div class="titlebar"><div class="title">'+ nav.title +'</div></div><div class="content"><ul></ul></div></div>').appendTo("body");
            leftNav.find('.content>ul').listNav2(tab,leftNav,navConfig);

            tab.t.click(function(){ leftNav.hide(); });
        }
    });

    function flash(args, tab,isgo) {

        me.execCommand('show', { a: args.a });
        setChildWindow(args,rightRoot,isgo);
    }

    function setChildWindow(args, root,isgo) {

        if(isgo) me.execCommand('go', args);
        else me.fireEvent(args.b, me.content); //me.content 定义在 core/content.js 里
    }

    me.commands['initContentNav' + nav.a] = {
        execCommand: function (key, domObj) {
            var items = $.map(navConfig.data, function (obj) { return $.extend(true, {}, obj); });
            me.execCommand('addContentNav', domObj, items);
        }
    }

    me.addListener(nav.a, function (key, args) {
        var tab = me.execCommand('gettab', nav);
        flash(args, tab);
    });
};


IWF.plugins['manage'] = function () {

    var me = this;

    // var ViewModel = function () {
    //     this.list = ko.observableArray();
    //     this.setData = function (data) { this.list(data); };
    //     this.showImage = function (image) {
    //         if(!image) image = "/images/hudongimg/wall.jpg";
    //         return image;
    //     }
    //     this.getTime = function(time){
    //         if(/^(1970)/.test(time)) return "不限制结束时间";
    //         return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
    //     }
    // };

    // var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/o2opackage/html/manage.html",function(){       
        });
    }
        
    
    me.addListener('manage', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['o2oagentconfig'] = function () {

    var me = this;

    var myroot = null;
    function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_FENXIAO')) {
            root.load("/index.php?c=admin/page/Versiontip&page=shopconfig");
            return;
        }
//        root.loadHtmlTpl("plugins/businesspackage/html/shopconfig.html?v=" + Math.random(), function () {
        root.loadHtmlTpl("plugins/o2opackage/html/agentsetting.html?v=" + Math.random(), function () {
            myroot = root[0];
            if (me.hasLicensePerm('ENABLE_AGENT')) {
                $('[aboutagent="1"]').show();

            } else {
                $('[aboutagent="1"]').remove();
              
            }
            
            var EnableAgent=false;
            bindUIEvent();

            loadConfig();
        });
    }

    function loadConfig(custom) {
        //$.getJSON("/admin/business/shopconfig?act=getinfo", null, function (json) {
    	$.getJSON("/index.php?c=admin/business/shopconfig&a=getinfo", null, function (json) {
    		json.info.proxy_delivery=me.hasLicensePerm('ENABLE_AGENT_PROXY_DELIVERY');
    		if(!custom)
    		{
    			ko.applyBindings({ config: json.info}, myroot);
    			EnableAgent= $("#EnableAgent").prop("checked");
    		}
            try {
            	var t = json.info.ApplyAgentInfo ? json.info.ApplyAgentInfo : 0 ;
            	if(json.info.AgentYongJin)
            		eval("var agentYongJin = " + json.info.AgentYongJin);
            	else
            		var agentYongJin = '';
            	if(json.info.FenXiaoYongJin)
            		eval("var fenxiaoYongJin = " + json.info.FenXiaoYongJin);
            	else
            		var fenxiaoYongJin = '';
                eval("var applyAgentInfo = " + t );
                var level = 0;
                var per=100;
                var ay=0;
//                for (var k in agentYongJin) { level++; }
//                if (level > json.info.AgentLevel) 
                if(custom)
                	level = custom;
                else
                	level = json.info.AgentLevel;
                
                if(applyAgentInfo)
                {
                	for (var a = 1; a <= level; a++) 
                	{
                		if(agentYongJin['level'+a])
                		per-=agentYongJin['level'+a];
                	}
                	var flevel = json.info.FenXiaoLevel< Object.keys(fenxiaoYongJin).length ? json.info.FenXiaoLevel : Object.keys(fenxiaoYongJin).length;
                	
                	for(var b=1;b <= flevel ;b++)
                	{
                		if(fenxiaoYongJin['level'+b])
                			per-=fenxiaoYongJin['level'+b];
                	}
                }
                	
                for (var i = 1; i <= level; i++) {
                	if(applyAgentInfo&&applyAgentInfo[i])
                	{
                		if(agentYongJin){
                			var yongjin=agentYongJin['level'+i];
                			console.log(yongjin);
                		}
                		else
                			var yongjin=0;
                		$('#agentlist tr:last').after('<tr class="alist">'
                			+'<td>'+i+'级代理</td>'
                			+'<td>'+applyAgentInfo[i]['fee']+'</td>'
                			+'<td>'+AgentPrivellege(applyAgentInfo[i])+'</td>'
                			+'<td>'+yongjin+'</td>'
                			+'<td><a href="javascript:openDialog('+i+','+(per+parseFloat(agentYongJin['level'+i]))+')" class="edit">操作</a></td>'
                			+'</tr>');
                	}
                	else
                	{
                		if(agentYongJin['level'+i])
                			ay=agentYongJin['level'+i];
                		else
                			ay=0;
                		$('#agentlist tr:last').after('<tr class="alist">'
                    			+'<td>'+i+'级代理</td>'
                    			+'<td>0</td>'
                    			+'<td></td>'
                    			+'<td>'+ay+'</td>'
                    			+'<td><a href="javascript:openDialog('+i+','+per+')" class="edit">操作</a></td>'
                    			+'</tr>');
                	}
                }
                

            } catch (e) { }

        });
    }



    function bindUIEvent() {

    	$('#AgentLevel').off('keyup',function(){
    		 var value = $(this).val();
             if (value.length == 1) {
                 value = value.replace(/[^1-9]/g, '');
             } else {
                 value = value.replace(/\D/g, '');
             }
    		$(this).val(value);
    	}).off("afterpaste").on("afterpaste", function () {
            var value = $(this).val();
            if (value.length == 1) {
                value = value.replace(/[^1-9]/g, '');
            } else {
                value = value.replace(/\D/g, '');
            }
            $(this).val(value);
        }).off("change").on("change", function () {
        	$('.alist').remove();
        	loadConfig( $(this).val());
        });
    	
    	$('.BtnSave').unbind().click(function(){
            //验证同级奖励百分比
            var r= /^\d+(\.\d+)?$/;
            var levelreward = parseFloat($.trim($('#AgentSameLevelReward').val()));
            if(!r.test(levelreward) && $.trim($('#AgentSameLevelReward').val()) != ''){
                $.showResult(false, '请输入正确的同级奖励！',2000);
                return;
            }
    		$.post('/index.php?c=admin/o2o/o2oconfig&a=saveAgentConfig',$('form').serialize(),function(data){
    			if(data.success)
    				 $.showResult(true, "保存成功");
    			else
    				$.showResult(false, data.msg);
    		});
    	});
    	
    	$('#EnableAgent').change(function(){
    		if(!EnableAgent)
    		{
    			EnableAgent=true;
    			$('.agent_more').show();
    		}
    		else
    		{
    			EnableAgent=false;
    			$('.agent_more').hide();
    		}
    	});
  
    }

   function AgentPrivellege(json)
   {
	   var txt='';
	   if(json['agent_decoration'])
		   txt+='店铺装修';
	   if(json['agent_delivery'])
		   txt+=' 自行发货';
	   if(json['agent_coupon'])
		   txt+=' 发优惠券';
		   
	   return txt;
   }

    me.addListener('o2oagentconfig', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

function openDialog(id,surplus)
{
	   $('#AgentInfoDialog').remove();
		var param='?id='+id+'&surplus='+surplus;
		$("body").append("<div id='AgentInfoDialog' style='overflow-y:hidden'><iframe src='/admin/widget/AgentLevelSetting.html"+param+"' frameborder='0' width='100%' height='100%'></iframe></div>");
		var title = '修改等级权限';
		$('#AgentInfoDialog').dialog({width:'400',height:'500',modal:true,title:title});
		$('#AgentInfoDialog').closest('.ui-dialog').find('.ui-dialog-content').css('padding','0');
		return false;
}
IWF.plugins['o2oconfig'] = function () {

    var me = this;

    var ViewModel = function () {
        this.list = ko.observableArray();
        this.array = [];
        this.setData = function (data) {
            for (var key in data) {
                if (typeof (data[key]) == "object")
                { this[key] = ko.observableArray(data[key]); }
                else {
                    this[key] = ko.observable(data[key]);
                }
            }
        };
        //店铺类目
        this.setClassData = function (data) { this.array = data;this.list(data);};
        this.getSublist = function(parentid){
            var ret = [];
            for(var i = 0;i < this.array.length;i++){
                if(this.array[i].ParentID == parentid) ret.push(this.array[i]);
            }
            return ret;
        };
        this.grade = ko.observableArray([]);
        this.getRootList = function(selectValue){
            var ret = [];
            ret.push({ClassID:0, ClassName: '根类', Selected: false});
            for(var i = 0;i < this.array.length;i++){
                if(this.array[i].ParentID == 0){
                    var obj = this.array[i];
                    if(selectValue == obj.ClassID) obj['Selected'] = true;
                    else obj['Selected'] = false;
                    ret.push(obj);
                }
            }
            return ret;
        };
        this.getSecondList = function (selectValue) {
            var ret = [];
            ret.push({ ClassID: 0, ClassName: '根类',ParentID:-1, Selected: false });
            for (var i = 0; i < this.array.length; i++) {
                if (this.array[i].ParentID == 0) {
                    var o1st = $.extend({}, this.array[i]);
                    if(selectValue == o1st.ClassID) o1st.Selected = true;
                    ret.push(o1st);
                    
                }
            }
            return ret;
        }//店铺类目end
    };

    var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_AGENT')) {
            root.load("/index.php?c=admin/page/Versiontip&page=shopconfig");
            return;
        }
        root.loadHtmlTpl("plugins/o2opackage/html/o2oconfig.html?v=" + Math.random(),function(){
            LoadConfig();
            bindUIEvent();
            loadStoreClassList();
            // ko.applyBindings(vm,root[0]);
            // $('#BtnSave').click(function(){
            //     submitForm();
            // });
        });
    }
    //店铺类目操作
    function loadStoreClassList() {
        $.getJSON("/index.php?c=admin/o2o/o2oconfig&a=getclasslist", utils.params({}), function (json) {
            if(json.success){
                vm.setClassData(json.list);
                bindGridEvent();
            }else{
                alert("出错了：" + json.msg);
            }
        });
    }
    function bindUIEvent(){
        $("#BtnAddStoreClass").bind("click",function(){
            var form = $(this).closest('form');
            var formVals = $(form).serializeObject();
            var params = {Name: formVals.tbName,ParentID: formVals.slParentID};
            $.getJSON("/index.php?c=admin/o2o/o2oconfig&a=editclass", utils.params(params), function (json) {

                if(json.success){
                    $.showResult(true, "添加成功", 1000);
                    loadStoreClassList();
                }else{
                    $.showResult(false, json.msg);
                }
            });
        });

        $('[name=tbName]').unbind('keypress').bind('keypress', function (evt) {
            if (evt.keyCode == 13) {
                $('#BtnAddProClass').click();
                evt.stopPropagation();
                return false;
            }
        });
    }

    function bindGridEvent() {
        $(".Tables").disableSelection();
        $(".sortUl").sortable({
            handle: ".T1",
            start: function (event, ui) {
                ui.item.css({ "border": "solid 1px red" });
            },
            update: function (event, ui) {

                var orders = new String();
                $(this).find(".MoveItem").each(function (i) {
                    orders += $(this).attr("value") + "-" + i + ",";
                });
                $.ajax({
                    type: "POST",
                    dataType: 'json',
                    url:'/index.php?c=admin/o2o/o2oconfig&a=MoveClassOrder',
                    data: { Order: orders },
                    success: function (json) {
                        if(json.success) loadStoreClassList();
                        else alert("出错了：" + json.msg);
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert("系统出错了." + errorThrown);
                    }
                });
            }, stop: function (event, ui) {
                ui.item.css({ "border": "0" });
            }
        });

        $(".SubTable").sortable({
            handle: ".SubHandle",
            start: function (event, ui) {
                ui.item.css({ "border": "solid 1px red" });
            },
            update: function (event, ui) {
                
                var orders = new String();
                $(this).find(".SubHandle").each(function (i) {
                    orders += $(this).attr("value") + "-" + i + ",";
                });
                $.ajax({
                    type: "POST",
                    dataType: 'json',
                    url: '/admin/o2o/o2oconfig',
                    data: { a: "MoveClassOrder", Order: orders },
                    success: function (json) { 
                        if(json.success) loadStoreClassList();
                        else alert("出错了：" + json.msg);
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert("系统出错了.");
                    }
                });
            }, stop: function (event, ui) {
                ui.item.css({ "border": "0", "border-bottom": "solid 1px #ccc" });
            }
        });

        

        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var form = $(this).closest('form');
            var formVals = form.serializeObject();
            var params = { ClassID: formVals.tbClassID, Name: formVals.tbName, ParentID: formVals.slParentID, Image: formVals.previewImgUrl };
            $.getJSON("/index.php?c=admin/o2o/o2oconfig&a=editclass", utils.params(params), function (json) {

                if(json.success){
                    $.showResult(true, "修改成功", 1000);
                    loadStoreClassList();
                }else{
                    $.showResult(false, json.msg);
                }
            });
        });

        $("*[name=BtnDel]").bind("click",function(){
            if(!confirm("确认删除？")) return;
            $.getJSON("/index.php?c=admin/o2o/o2oconfig&a=deleteclass", utils.params({ClassID:$(this).attr("ClassID")}), function (json) {
                loadStoreClassList();
            });
        });

    }//店铺类目操作end

    
    function BindEvent(){
        if($('#PersonalApply').is(':checked')){
            $('.idcau').show();
        }else{
            $('.idcau').hide();
        }
        
        if($('#CompanyApply').is(':checked')){
            $('.blau').show();
        }else{
            $('.blau').hide();
        }
        $('#PersonalApply').off('click').on('click',function(){
            if($('#PersonalApply').is(':checked')){
                $('.idcau').show();
            }else{
                $('.idcau').hide();
            }
        });
        $('#CompanyApply').off('click').on('click',function(){
            if($('#CompanyApply').is(':checked')){
                $('.blau').show();
            }else{
                $('.blau').hide();
            }
        });

        $('#addgrade').click(function(){
            //添加时初始化表单
            $('#grade-name').val('');
            $('#grade-pronum').val('');
            $('#grade-price').val('');
            $('#grade-desc').val('');
            $('#gradeinput').show();
            $('.StoreGradeTable').hide();
        });
        $('#gradecan').click(function(){
            $('#gradeinput').hide();
            $('.StoreGradeTable').show();
        });
        $('#gradesub').click(function(){
            if($('#grade-name').val() == ''){
                alert('等级名称不能为空！');
                $('#grade-name').focus();
                return;
            }
            if($('#grade-pronum').val() != '' && !isInteger(parseInt($('#grade-pronum').val()))){
                alert("请输入正确的可上传产品数量！");
                $('#grade-pronum').focus();
                return;
            }
            if($('#storecom').val() == '' || !isFloat(parseFloat($('#storecom').val()))) //parseInt($('#storecom').val()))
            {
            	alert('请输入0-100之间');
            	$('#storecom').focus();
            	return ;
            }
            if($('#grade-price').val() == '' || !isFloat(parseFloat($('#grade-price').val()))){
                alert("请输入正确的入驻费用(保留两位小数)！");
                $('#grade-price').focus();
                return;
            }else{
                $('#grade-price').val(parseFloat($('#grade-price').val())+0);
            }
            var params = $('#StoreGradeForm').serializeObject();
            $.post("/index.php?c=admin/o2o/o2oconfig&a=EditGrade", params, function (data, textStatus, jqXHR) {
                if (data.success) {
                   $.showResult3(true,'',1000,function(){window.location.reload()});
                   //$.showResult(true, "保存成功", 2000);
                   //为空 则上传产品数不限
                   if(params.ProductNum == ''){
                        params.ProductNum = '不限';
                   }
                   if(data.isnew){
                        $('.StoreGradeTable tbody').append('<tr><td class="name'+data.gid+'">'+params.GradeName+'</td><td class="price'+data.gid+'">'+params.GradePrice+'</td><td class="num'+data.gid+'">'+params.ProductNum+'</td><input type="hidden" name="StoreGradeID" value="'+params.GradeDesc+'" class="desc'+data.gid+'" /><td><a href="javascript:;" class="btn btn-link editg" gid="'+data.gid+'">编辑</a> <a class="btn btn-link delg" href="javascript:;" gid="'+data.gid+'">删除</a></td></tr>');
                   }else{
                        $('.desc'+data.gid).val(params.GradeDesc);
                        $('.name'+data.gid).text(params.GradeName);
                        $('.price'+data.gid).text(params.GradePrice);
                        $('.num'+data.gid).text(params.ProductNum);
                   }
                   $('#gradeinput').hide();
                   $('.StoreGradeTable').show();
                } else {
                    $.showResult(false, data.msg);
                }
            }, "json");
        });
        $(document).on('click','.editg',function(){
        // $('.editg').off('click').on('click',function(){
            var gid = $(this).attr('gid');
            $('#gradeid').val(gid);
            $('#grade-name').val($('.name'+gid).text());
            //为空 则上传产品数不限
            if($.trim($('.num'+gid).text()) == '不限'){
                $('#grade-pronum').val('');
            }else{
                $('#grade-pronum').val($('.num'+gid).text());
            }
            
            $('#grade-price').val($('.price'+gid).text());
            $('#grade-desc').val($('.desc'+gid).val());
            $('#storecom').val($('.com'+gid).text());
            $('#storefenxiaocom').val($('.fenxiaocom'+gid).text());
            $('#storetotalcom').val($('.totalcom'+gid).text());
            $('input[name="IsProductAuditing"]:checked').prop('checked',false);
            $('input[name="IsProductAuditing"][value="'+$('.aud'+gid).attr('value')+'"]').prop('checked',true);
            $('#gradeinput').show();
            $('.StoreGradeTable').hide();
        });
        $(document).on('click','.delg',function(){
        // $('.delg').off('click').on('click',function(){
            var gname = $('.name'+$(this).attr('gid')).text();
            var thisg = $(this).parent().parent();
            if(confirm('确定删除店铺等级 "'+gname+'" 吗？')){
                var params = {gid:$(this).attr('gid')};
                $.post("/index.php?c=admin/o2o/o2oconfig&a=DelGrade", params, function (data, textStatus, jqXHR) {
                    if (data.success) {
                        thisg.remove();
                       $.showResult(true, "删除成功", 2000);
                    } else {
                        $.showResult(false, data.msg);
                    }
                }, "json");
            }
        });
        //保存商家设置
        $('#PlatformState').change(function(){
        	if($(this).val()=='1')
        		$('.StoreGradeTable').show();
        	else
        		$('.StoreGradeTable').hide();
            submitForm();
        });
    }
    //判断正整数
    function isInteger(num){
        var r = /^\d+$/;
        return r.test(num);
    }
    //判断正浮点数 小数点最多两位
    function isFloat(num){
        var r= /^\d+(\.\d{1,2})?$/;
        return r.test(num);
    }
    function LoadConfig(){
        $.getJSON("/index.php?c=admin/o2o/o2oconfig&a=getconfig", null, function (json) {
            vm.setData(json.config);
            vm.grade(json.grade);
            ko.applyBindings(vm, document.getElementById("configdiv"));
            BindEvent();
        });
    }    
    function submitForm() {
        var params = $('#O2oConfigForm').serializeObject();
        $.post("/index.php?c=admin/o2o/o2oconfig&a=EditConfig", params, function (data, textStatus, jqXHR) {
            if (data.success) {
               $.showResult(true, "保存成功", 2000);
            } else {
                $.showResult(false, data.msg);
            }
        }, "json");
    }
    me.addListener('o2oconfig', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['shopconfig2'] = function () {

    var me = this;

    var myroot = null;
    function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_FENXIAO')) {
            root.load("/index.php?c=admin/page/Versiontip&page=shopconfig");
            return;
        }
        root.loadHtmlTpl("plugins/businesspackage/html/shopconfig.html?v=" + Math.random(), function () {
            myroot = root[0];
            if (me.hasLicensePerm('ENABLE_AGENT')) {
                $('[aboutagent="1"]').show();
            } else {
                $('[aboutagent="1"]').remove();
                // $.get("/index.php?c=admin/page/Versiontip&page=shopconfig&msgtype=alert", null, function (json) {
                //     $('#EnableAgent').popover({
                //         content:json,
                //         placement:'bottom',
                //         title:'注意',
                //     });
                // });
                // $('#EnableAgent').unbind('click').click(function(){
                //     $('body').unbind('click').click(function (event) {
                //         var target = $(event.target);
                //         if (!target.hasClass('popover') && target.parent('popover-content').length === 0 && target.parent('popover-title').length === 0 && target.parent('popover').length === 0 && target.data('toggle') !== 'popover' && target.prop("tagName") != 'INPUT') {
                //             $('#EnableAgent').popover('hide');
                //         }
                //     });
                //     $("#EnableAgent").prop("checked",false);
                //     return;
                // });
            }
            

            bindUIEvent();
			
            $('#BtnSave').floatSaveBtn();
			
            loadConfig();
        });
    }

    function loadConfig() {
        //$.getJSON("/admin/business/shopconfig?act=getinfo", null, function (json) {
    	$.getJSON("/index.php?c=admin/business/shopconfig&a=getinfo", null, function (json) {
    		json.info.proxy_delivery=me.hasLicensePerm('ENABLE_AGENT_PROXY_DELIVERY');
            ko.applyBindings({ config: json.info}, myroot);
            try {
                eval("var yongJin = " + json.info.FenXiaoYongJin);
                var level = 0;
                for (var k in yongJin) { level++; }
                if (level > json.info.FenXiaoLevel) level = json.info.FenXiaoLevel;
                addFenXiaoLevel(level, yongJin);
            } catch (e) { }

            try {
                eval("var agentYongJin = " + json.info.AgentYongJin);
                var level = 0;
                for (var k in agentYongJin) { level++; }
                if (level > json.info.AgentLevel) level = json.info.AgentLevel;
                addAgentLevel(level, agentYongJin);
            } catch (e) { }

            if($('.BtnSelBg').eq(3).hasClass('selectedbg')){
                $('.customCon').css({'display':'block','padding':'8px'});
            }
            if($('#FenXiaoQRCode').val()== '/images/SelBg1.jpg'){
                $('.BtnSelBg').removeClass('selectedbg');
                $('.BtnSelBg').eq(0).addClass('selectedbg');
            }else if($('#FenXiaoQRCode').val()== '/images/SelBg2.jpg'){
                $('.BtnSelBg').removeClass('selectedbg');
                $('.BtnSelBg').eq(1).addClass('selectedbg');
            }else if($('#FenXiaoQRCode').val()== '/images/SelBg3.jpg'){
                $('.BtnSelBg').removeClass('selectedbg');
                $('.BtnSelBg').eq(2).addClass('selectedbg');
            }else{
                $('.BtnSelBg').removeClass('selectedbg');
                $('.BtnSelBg').eq(3).addClass('selectedbg');
            }

            var src = json.info.FenXiaoQRCode;
            if (!src) src = "/images/SelBg1.jpg";
            $("#tdFenXiaoQRCode").prepend("<img id='FenXiaoQRCodePreview' src='" + src + "' height='400' draggable='false'/>");
            /*
            if (!json.info.FenXiaoQRCodeTipsLeft) $("#FenXiaoQRCodeTipsLeft").val(15);
            if (!json.info.FenXiaoQRCodeTipsTop) $("#FenXiaoQRCodeTipsTop").val(30);
            if (!json.info.FenXiaoFontSize) $("#FenXiaoFontSize").val(14);

            if (!json.info.FenXiaoQRCodeLeft) $("#FenXiaoQRCodeLeft").val(16);
            if (!json.info.FenXiaoQRCodeTop) $("#FenXiaoQRCodeTop").val(66);

            if (!json.info.FenXiaoHeadLeft) $("#FenXiaoHeadLeft").val(35);
            if (!json.info.FenXiaoHeadeTop) $("#FenXiaoHeadeTop").val(15);*/
			calTichengDemoList();			
        });
    }

	function calTichengDemoList(){
		var price = 1000;
		var amount = 600;
		var chengben = 400;
		//计算代理的提成
		var EnableAgent = $("#EnableAgent").prop("checked");
		var AgentLevel = parseInt($("#AgentLevel").val());
		var ahtml = "";
		var allAgentMoney = 0;
		var allpercent = 0;
		if(EnableAgent){
			ahtml = "<b>代理提成表：</b><table class='table table-hover table-bordered'><tr><td>代理级别</td><td>下级用户购买提成</td><td>代理拿货价</td></tr>";
			for(var i = 1;i <= AgentLevel;i++){
				var percent = $("#AgentYongJin" + i).val();
				percent = percent / 100;
				ahtml += "<tr><td>" + i + " 级代理</td><td><font color='red'>"+ parseFloat((amount * percent).toFixed(2)) +"</font> 元</td><td><font color='red'>"+ parseFloat((chengben + amount * allpercent).toFixed(2)) +"</font> 元</td></tr>";
				allpercent += percent;
				allAgentMoney += parseFloat((amount * percent).toFixed(2));
			}
			ahtml += "</table>";
			if(me.hasLicensePerm('ENABLE_AGENT_PROXY_DELIVERY'))
				$('.agent_delivery').show();
			$('.agent_binding').show();
			$('.agent_decoration').show();
			$('.agent_coupon').show();
		}
		else
		{
			$('.agent_delivery').hide();
			$('.agent_binding').hide();
			$('.agent_decoration').hide();
			$('.agent_coupon').hide();
		}
		
		//计算分销员的提成
		var EnableFenXiao = $("#EnableFenXiao").prop("checked");
		var FenXiaoLevel = parseInt($("#FenXiaoLevel").val());
		var html = "";
		if(EnableFenXiao){
			html = "<b>分销员提成表：</b><br>";
			var allFenXiaoMoney = 0;
			for(var i = 1;i <= FenXiaoLevel;i++){
				var percent = $("#FenXiaoYongJin" + i).val();
				percent = percent / 100;
				html += i + " 级分销提成：<font color='red'>"+ parseFloat((amount * percent).toFixed(2)) +"</font> 元<br>";
				allFenXiaoMoney += parseFloat((amount * percent).toFixed(2));
			}
		}
		//算出商家最终得到的钱
		var shtml = "商家最终得到： <font color='red'>"+ (EnableAgent ? chengben : (price - allFenXiaoMoney)) +"</font> 元" + (EnableAgent ? "(当有代理时，商家与一级代理间是底价结算)":"");
		shtml += "<br><br>如果商家不希望以底价结算，那可以将代理会员都设置为二级以上代理，那么商家得到的钱就是 底价+ 一级代理的提成，如此类推";
		$("#divTichengDemoList").html(ahtml + html + shtml);
	}

	function loadPrice(){
		//先加载独立的分成配置表
		var productFenXiaoSetting = null;
		//$.ajax({ url: "/admin/product/ProductFenXiaoSetting?act=getlist", async: false, dataType: "json", success: function (json) {
		$.ajax({ url: "/index.php?c=admin/product/Productfenxiaosetting&a=getlist", async: false, dataType: "json", success: function (json) {	
				productFenXiaoSetting = json.list;
			}
		});

		var params = { sid: me.sid,keyword: $("#pricekeyword").val(), page: 1, pagesize: 2000 };
		//$.getJSON("/admin/product/productmanage?act=getlist", utils.params(params), function (productdata) {
		$.getJSON("/index.php?c=admin/product/productmanage&a=getlist", utils.params(params), function (productdata) {
            var products = productdata.list;

			//$.getJSON("/admin/business/shopconfig?act=getinfo", null, function (configdata) {
            $.getJSON("/index.php?c=admin/business/shopconfig&a=getinfo", null, function (configdata) {
				var config = configdata.info;
				if(config.FenXiaoYongJin == ''){
					config.FenXiaoYongJin = '{}';
				}
				if(config.AgentYongJin == ''){
					config.AgentYongJin = '{}';
				}
				eval("var FenXiaoYongJin = " + config.FenXiaoYongJin);
				eval("var AgentYongJin = " + config.AgentYongJin);
				var html = "";
				if(config.EnableAgent == 1){
					html += "说明：代理直接分销提成 = 产品销售价 - 代理拿货价 - 总分销提成，下级代理销售提成 = 下级代理拿货价 - 自己拿货价";
				}
				html += "<table class='table table-bordered' style='background:white'><tr>";
				html += "<td rowspan='2' scope='row'>编号</td>";
				html += "<td rowspan='2'>名称</td>";
				html += "<td rowspan='2'>代理底价</br>(最高级代理商)</td>";
				html += "<td rowspan='2'>销售价</td>";
				if(config.EnableAgent == 1) html += "<td colspan='"+ config.AgentLevel +"'>代理拿货价/下级用户购买提成</td>";
				html += "<td colspan='"+ config.FenXiaoLevel +"'>分销提成</td>";
				html += "</tr>";
				html += "<tr>";
				if(config.EnableAgent == 1){
					for(var i = 1;i <= config.AgentLevel;i++){
						html += "<td>"+ i +"级代理("+AgentYongJin['level' + i]+"%)</td>";
					}
				}
				for(var i = 1;i <= config.FenXiaoLevel;i++){
					html += "<td>"+ i +"级分销("+FenXiaoYongJin['level' + i]+"%)</td>";
				}
				html += "</tr>";
				for(var i = 0;i < products.length;i++){
					var flag = false;
					eval("var FenXiaoYongJinPro = " + config.FenXiaoYongJin);
					eval("var AgentYongJinPro = " + config.AgentYongJin);
					if(productFenXiaoSetting && productFenXiaoSetting.length > 0){
						for(var v = 0; v < productFenXiaoSetting.length;v++){
							if(productFenXiaoSetting[v].ID == products[i].FenXiaoID){
								eval("FenXiaoYongJinPro = " + productFenXiaoSetting[v].FenXiaoYongJin);
								eval("AgentYongJinPro = " + productFenXiaoSetting[v].AgentYongJin);
								flag = true;
								break;
							}
						}
					}

					var amount = products[i].Price - products[i].CostPrice;
					var proname = products[i].Name;
					if(proname.length > 10) proname = proname.substring(0,10) + "...";
					if(flag) proname = "<font color='red'>" + proname + "</font>";
					var allfenxiaopercent = 0;
					var allfenxiaomoney2 = 0;
					for(var level = 1;level <= config.FenXiaoLevel;level++){
						var key = "level" + level;
                        if (FenXiaoYongJinPro[key] && FenXiaoYongJinPro[key].toString().substr(0,1) == "$")
                        {
                            allfenxiaomoney2 += parseFloat("0" + FenXiaoYongJinPro[key].substr(1));
                            flag = true;
                        }
                        else
                        {
							var percent = FenXiaoYongJinPro[key];
							percent /= 100;
							allfenxiaopercent += percent;
						}
					}
					var allfenxiaomoney = 0;
					if (flag) allfenxiaomoney = allfenxiaomoney2;
					else allfenxiaomoney = parseFloat((allfenxiaopercent * amount).toFixed(2));

					html += "<tr>";
					html += "<td rowspan='2'>"+ (i+1) +"</td>";
					html += "<td rowspan='2'><a href='#' class='productinfo' productid='"+ products[i].ProductID +"' title='"+ products[i].Name +"'>"+ proname +"</a></td>";
					html += "<td rowspan='2'>"+ products[i].CostPrice +"</td>";
					html += "<td rowspan='2'>"+ products[i].Price +"</td>";
					var agentpercent = 0;
					var agentprice = 0;
					if(config.EnableAgent == 1){
						for(var level = 1;level <= config.AgentLevel;level++){
							var percent = 0;
                            var m1 = 0;
                            var m2 = 0;
                            var key = "level" + level;
							if (AgentYongJinPro[key] && AgentYongJinPro[key].toString().substr(0,1) == "$")
                            {
                                m1 = parseFloat("0" + AgentYongJinPro[key].substr(1));
                                var keynext = "level" + (level + 1);
                                if (AgentYongJinPro[keynext] && AgentYongJinPro[keynext].toString().substr(0,1) == "$"){
                                    m2 = parseFloat("0" + AgentYongJinPro[keynext].substr(1)) - m1;
                                }
                            }
                            else
                            {
                                percent = AgentYongJinPro[key];
                                m1 = products[i].CostPrice + parseFloat((agentpercent * amount).toFixed(2));
                                m2 = parseFloat((percent / 100 * amount).toFixed(2));
                                agentpercent += percent / 100;
                            }

                            var m3 = parseFloat((products[i].Price - m1 - allfenxiaomoney).toFixed(2)); //销价-自己拿货价-总分销提成
                            html +=("<td rowspan='2'>拿货价：<font color='green'>" + m1 + "</font>");
                            if (level < config.AgentLevel) html += ("<br><font color='blue'>下级代理销售提成：" + m2 + "</font>");
                            html +=("<br><font color='#684b20'>直接分销提成：" + m3 + "</font></td>");
						}
					}
					html += "<td colspan='"+ config.FenXiaoLevel +"' align='center'>总分成："+ allfenxiaomoney +" 元</td>";
					html += "</tr><tr>";
					for(var level = 1;level <= config.FenXiaoLevel;level++){
						var key = "level" + level;
                        var m1 = 0;
                        if (FenXiaoYongJinPro[key] && FenXiaoYongJinPro[key].toString().substr(0,1) == "$")
                        {
                            m1 = parseFloat("0" + FenXiaoYongJinPro[key].substr(1));
                        }
                        else
                        {
							var percent = FenXiaoYongJinPro['level' + level];
							percent /= 100;
                            m1 = parseFloat((percent * amount).toFixed(2));
						}
						html += "<td>";
						html += "<font color='red'>"+ m1 +"</font></td>";
					}
					html += "</tr>";
				}
				html += "</table>";
				$("#FenXiaoPriceList").html(html);
				$("#FenXiaoPriceList .productinfo").unbind().click(function(element){
					me.execCommand('go', { a: 'business', b: 'productedit', params: { id: $(this).attr("productid") } });
					return false;
				});
			});
			//console.log(products);//ProductID Price CostPrice Name
        });
	}

    function bindUIEvent() {

		$("#FenXiaoTable",myroot).unbind("change").change(function(){
			calTichengDemoList();
		});
		$("#BtnExportPriceList").unbind().click(function(){
			//window.open("/admin/business/shopconfig?act=exportpricelist");
			window.open("/index.php?c=admin/business/shopconfig&a=exportpricelist");
		});
		$("#BtnSearch").unbind().click(loadPrice);
        $("#FenXiaoFontSize").unbind().bind("change",markTipsPosition);
        $("#BtnMarkTips").unbind().click(markTipsPosition);
        $("#BtnMarkQrcode").unbind().click(markQrCodePosition);
        $("#BtnMarkHead").unbind().click(markHeadPosition);

        $('.subTab a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            if ($(e.target).is("a[href=#divFenXiaoQRCode]")) {
                $("#markTipsPosition,#markQrcodePosition,#markHeadPosition").show();
            } else {
                $("#markTipsPosition,#markQrcodePosition,#markHeadPosition").hide();
            }

            if ($(e.target).is("a[href=#FenXiaoPriceTable]")) {
                //$("#BtnSave").hide();
                $(".floatSaveBox").hide();
                loadPrice();
            }
            else {
                //$("#BtnSave").show();
                $(".floatSaveBox").show();
            }

            if ($(e.target).is("a[href=#divFenXiaoQRCode]")) {
                markTipsPosition();
                markQrCodePosition();
                markHeadPosition();
            }
        });
        $('.BtnSelBg').click(function  () {
            $('.BtnSelBg').removeClass('selectedbg');
            $(this).addClass('selectedbg');
            if ($(this).index() == 0) {
                $('#FenXiaoQRCode').val('/images/SelBg1.jpg');
                $('#FenXiaoQRCodePreview').attr('src','/images/SelBg1.jpg');
            }else if($(this).index() == 1){
                $('#FenXiaoQRCode').val('/images/SelBg2.jpg');
                $('#FenXiaoQRCodePreview').attr('src','/images/SelBg2.jpg');
            }else if($(this).index() == 2){
                $('#FenXiaoQRCode').val('/images/SelBg3.jpg');
                $('#FenXiaoQRCodePreview').attr('src','/images/SelBg3.jpg');
            }else if ($(this).index() == 3) {
                $('#FenXiaoQRCode').val(' ');
                $('#FenXiaoQRCodePreview').attr('src','/images/SelBg4.jpg');
            };
             if ($(this).hasClass('selectedbg') && $(this).index() == 3) {
                $('.customCon').css({'display':'block','padding':'8px'});
            }else{
                $('.customCon').css({'display':'none','padding':'0px'});
            };

        })

        $("#BtnSelQRCode").unbind('click').bind("click", function () {
            top.YDM.FileManager('image', 1, function (aUrl) {
                if (aUrl.length > 0) {
                    $('#FenXiaoQRCode').val(aUrl[0]);
                    $('#FenXiaoQRCodePreview').attr('src', aUrl[0]);
                }
            })
        });
        $("#BtnSave").unbind().bind('click', function (event) {
            var params = $('#ShopConfigForm').serializeObject();
            var percent = 0;
            var agentfee = parseFloat($('#AgentSiteFee').val());
            var fenXiaoLevel = parseInt($('#FenXiaoLevel').val());
            var agentLevel = parseInt($('#AgentLevel').val());

            if ($("#EnableAgent").prop("checked")) {
                $('[id^=FenXiaoYongJin]').each(function () {
                    var num = $(this).attr('id').replace(/FenXiaoYongJin/i, '');
                    if (num > fenXiaoLevel) return true;
                    percent += parseFloat('0' + $(this).val());
                });
            }

            if ($("#EnableFenXiao").prop("checked")) {
                $('[id^=AgentYongJin]').each(function () {
                    var num = $(this).attr('id').replace(/AgentYongJin/i, '');
                    if (num > agentLevel) return true;
                    percent += parseFloat('0' + $(this).val());
                });
            }
   
            /*
            for (var key in params) {
                if (/^FenXiaoYongJin\d+/.test(key) || /^AgentYongJin\d+/.test(key)) {
                    if(/^AgentYongJin\d+/.test(key) && $("#EnableAgent").prop("checked") == false) continue;
					if(/^FenXiaoYongJin\d+/.test(key) && $("#EnableFenXiao").prop("checked") == false) continue;
                    // percent += parseFloat(('0' + params[key]).toFixed(2));
					percent += parseFloat('0' + params[key]);
                }
            }
            */

            if (isNaN(percent)) {
                $.showResult(false, "代理或分销的总提成输入格式有误");
                return;
            }

            if (percent > 100) {
                $.showResult(false, "代理+分销的总提成点不能超过100%");
                return;
            }
            if(agentfee>100||agentfee<0||isNaN(agentfee) && $("input[name='EnableAgentDelivery']:checked").val() ){
            	$.showResult(false,"平台手续费只能0-100的小数");
            	return ;
            }
            	

            if (!/^\d+$/.test($('[name=MinTiXian]').val())) {
                $.showResult(false, '最小提现金额请请输入正整数');
                return;
            }

            if (!/^\d+$/.test($('[name=FenXiaoMinAmount]').val())) {
                $.showResult(false, '分销员最低必须消费金额请输入正整数');
                return;
            }

            var flag = true;
            $('[name^=FenXiaoYongJin]').each(function () {
                if (this.value != '' && !/^[0-9]+([.]{1}[0-9])?$/.test(this.value)) {
                    $.showResult(false, '只能保留一位小数');
                    flag = false;
                    return false;
                }
            });
            $('[name^=AgentYongJin]').each(function () {
                // if (this.value != '' && !/^\d+$/.test(this.value)) {
                if (this.value != '' && !/^[0-9]+([.]{1}[0-9])?$/.test(this.value)) {
                    $.showResult(false, '只能保留一位小数');
                    flag = false;
                    return false;
                }
            });
            if (!flag) return;
            if (percent < 100 && $("#EnableAgent").prop("checked") == true) {
                var dialog = bootbox.dialog({
                    title: '提示',
                    message: '<div style="font-size:14px;">您开启的代理+分销设置百分比必须为100% </br><font style="color:red;">注意：商家只拿到产品代理底价，利润全部分配给代理和分销员！</font></br>如有疑问请查看代理/分销价格表！</div>',
                    buttons: {
                        confirm: {
                            label: "确定",
                            className: 'btn-success',
                            callback: function () {
                               savejson(params);
                            }
                        },
                        close1: {
                            label: "取消",
                            className: "btn-default",
                            callback: function () {
                                $(this).modal('hide');
                            }
                        }
                      
                    }
                });
                return;
            }

            if (me.hasLicensePerm('ENABLE_AGENT')) {
                if (percent == 100 || (percent < 100 && $("#EnableAgent").prop("checked") == false)) {
                    savejson(params);
                };
            } else {
                // 没有代理权限，小于等于100可以保存
                savejson(params);
            }
            return false;
        });
        function savejson (params) {  
            //$.post("/admin/business/shopconfig?act=editfenxiaoconfig", params, function (data, textStatus, jqXHR) {
        	$.post("/index.php?c=admin/business/shopconfig&a=editfenxiaoconfig", params, function (data, textStatus, jqXHR) {
                if (data.success) {
                    $.showResult(true, "保存成功", 2000);
                } else {
                    $.showResult(false, data.msg);
                }
            }, "json");
        }

        $("#DisabledButton").unbind().bind("click", function () {
            if ($(this).val() == 0) {
                $(this).val(1);
            } else {
                $(this).val(0);
            }
        });

        $("#FenXiaoLevel").off("keyup").on('keyup', function () {
            var value = $(this).val();
            if (value.length == 1) {
                value = value.replace(/[^1-9]/g, '');
            } else {
                value = value.replace(/\D/g, '');
            }
            $(this).val(value);
        }).off("afterpaste").on("afterpaste", function () {
            var value = $(this).val();
            if (value.length == 1) {
                value = value.replace(/[^1-9]/g, '');
            } else {
                value = value.replace(/\D/g, '');
            }
            $(this).val(value);
        }).off("change").on("change", function () {
            addFenXiaoLevel(parseInt($(this).val()));
        });

        $("#AgentLevel").off("keyup").on('keyup', function () {
            var value = $(this).val();
            if (value.length == 1) {
                value = value.replace(/[^1-9]/g, '');
            } else {
                value = value.replace(/\D/g, '');
            }
            $(this).val(value);
        }).off("afterpaste").on("afterpaste", function () {
            var value = $(this).val();
            if (value.length == 1) {
                value = value.replace(/[^1-9]/g, '');
            } else {
                value = value.replace(/\D/g, '');
            }
            $(this).val(value);
        }).off("change").on("change", function () {
            addAgentLevel(parseInt($(this).val()));
        });

        $("#FenXiaoQRCodeSize").off("keyup").on('keyup', function () {
            var value = $(this).val();
            if (value.length == 1) {
                value = value.replace(/[^1-9]/g, '');
            } else {
                value = value.replace(/\D/g, '');
            }
            $(this).val(value);
        }).off("afterpaste").on("afterpaste", function () {
            var value = $(this).val();
            if (value.length == 1) {
                value = value.replace(/[^1-9]/g, '');
            } else {
                value = value.replace(/\D/g, '');
            }
            $(this).val(value);
        }).off("change").on("change", function () {
            var qrsize = parseInt($("#FenXiaoQRCodeSize").val());
            var bili = 63 / 200 * qrsize; //计算图例的二维码与真实尺寸的比例
            $("#markQrcodePosition").css({ width: bili + 'px', height: bili + 'px' });
        });

        $('#ShowFenXiaoAlly').off().on('click', function () {
            if ($(this).prop('checked')) {
                $('#ShowFenXiaoAllyLevel2, #ShowFenXiaoAllyLevel3, #ShowFenXiaoAllyLevelOther').prop('disabled', false);
            } else {
                $('#ShowFenXiaoAllyLevel2, #ShowFenXiaoAllyLevel3, #ShowFenXiaoAllyLevelOther').prop('checked', false).prop('disabled', true);
            }
        });
    }

    function addFenXiaoLevel(level, values) {
        for (var i = 1; i <= level; i++) {
            var obj = $("#trXiaoYongJin" + i);
            if (obj.length == 0) {
                obj = $("<tr id='trXiaoYongJin" + i + "'><td style='text-align:right;'>" + i + " 级分销提成：</td><td><input type='text' class='form-control input' id='FenXiaoYongJin" + i + "' name='FenXiaoYongJin" + i + "'>%</td></tr>").insertBefore($("#trMinTiXian"));
            } else {
                obj.show();
            }
            if (values && values['level' + i]) {
                obj.find("input").val(values['level' + i]);
            }
        }
        for (var i = level + 1; i <= 100; i++) {
            var obj = $("#trXiaoYongJin" + i);
            if (obj.length > 0) {
                obj.hide();
            }
        }
    }

    function addAgentLevel(level, values) {
        for (var i = 1; i <= level; i++) {
            var obj = $("#trAgentYongJin" + i);
            if (obj.length == 0) {
                obj = $("<tr id='trAgentYongJin" + i + "'><td style='text-align:right;'>" + i + " 级代理提成：</td><td><input type='text' class='form-control input' id='AgentYongJin" + i + "' name='AgentYongJin" + i + "'>%</td></tr>").insertBefore($("#trAgentEnd"));
            } else {
                obj.show();
            }
            if (values && values['level' + i]) {
                obj.find("input").val(values['level' + i]);
            }
        }
        for (var i = level + 1; i <= 100; i++) {
            var obj = $("#trAgentYongJin" + i);
            if (obj.length > 0) {
                obj.hide();
            }
        }
    }
    var headLeft = 0, headTop = 0;
    function markHeadPosition() {
        $("#markHeadPosition").remove();
        $(myroot).append("<div id='markHeadPosition' style='position:absolute;width:85px;height:85px;border-radius:50%;overflow:hidden;padding:0;border:0;cursor:move;'><img src='/images/share/head.png' width='100%'></div>");
        var img = $("#FenXiaoQRCodePreview");
        var imgpos = $("#FenXiaoQRCodePreview").position();
        $("#markHeadPosition").css({ top: imgpos.top + "px", left: imgpos.left + "px", width: '85px', height: '85px' });
        headLeft = parseFloat($("#FenXiaoHeadLeft").val());
        headTop = parseFloat($("#FenXiaoHeadeTop").val());
        if (headLeft) $("#markHeadPosition").css("left", imgpos.left + img.width() * headLeft / 100);
        if (headTop) $("#markHeadPosition").css("top", imgpos.top + img.height() * headTop / 100);
        $("#markHeadPosition").draggable({
            containment: $("#FenXiaoQRCodePreview"),
            drag: function (event, ui) {
                headLeft = ((ui.position.left - imgpos.left) / $("#FenXiaoQRCodePreview").width() * 100).toFixed(2);
                headTop = ((ui.position.top - imgpos.top) / $("#FenXiaoQRCodePreview").height() * 100).toFixed(2);
                console.log(headLeft + "," + headTop);
                $("#FenXiaoHeadLeft").val(headLeft);
                $("#FenXiaoHeadeTop").val(headTop);
            }
        });
    }
    var tipsLeft = 0, tipsTop = 0;
    function markTipsPosition() {
        $("#markTipsPosition").remove();
        $(myroot).append("<div id='markTipsPosition' style='position:absolute;width:200px;height:50px;background:none;border:0;padding:0;color:white;cursor:move;white-space:nowrap;'><span style='width: 10em;display: inline-block;overflow: hidden;'>我是XX</span><br>向您推荐 XXXXXX</div>");
        var img = $("#FenXiaoQRCodePreview");
        var imgpos = $("#FenXiaoQRCodePreview").position();
        var fontSize = parseInt($("#FenXiaoFontSize").val());
        $("#markTipsPosition").css({ 'top': imgpos.top + "px", 'left': imgpos.left + "px",'font-size':fontSize +"px" });
        tipsLeft = parseFloat($("#FenXiaoQRCodeTipsLeft").val());
        tipsTop = parseFloat($("#FenXiaoQRCodeTipsTop").val());
        if (tipsLeft) $("#markTipsPosition").css("left", imgpos.left + img.width() * tipsLeft / 100);
        if (tipsTop) $("#markTipsPosition").css("top", imgpos.top + img.height() * tipsTop / 100);
        $("#markTipsPosition").draggable({
            containment: $("#FenXiaoQRCodePreview"),
            drag: function (event, ui) {
                tipsLeft = ((ui.position.left - imgpos.left) / $("#FenXiaoQRCodePreview").width() * 100).toFixed(2);
                tipsTop = ((ui.position.top - imgpos.top) / $("#FenXiaoQRCodePreview").height() * 100).toFixed(2);
                console.log(tipsLeft + "," + tipsTop);
                $("#FenXiaoQRCodeTipsLeft").val(tipsLeft);
                $("#FenXiaoQRCodeTipsTop").val(tipsTop);
            }
        });
    }

    var qrcodeLeft = 0, qrcodeTop = 0;
    function markQrCodePosition() {
        $("#markQrcodePosition").remove();
        $(myroot).append("<div id='markQrcodePosition' style='position:absolute;width:80px;height:80px;overflow:hidden;color:white;padding:0;border:0;cursor:move;'><img src='plugins/businesspackage/html/skinsrc/images/qrcode.jpg' width='100%'></div>");
        var img = $("#FenXiaoQRCodePreview");
        var imgpos = $("#FenXiaoQRCodePreview").position();
        var qrsize = parseInt($("#FenXiaoQRCodeSize").val());
        if (!qrsize) qrsize = 200;
        var bili = 63 / 200 * qrsize; //计算图例的二维码与真实尺寸的比例
        $("#markQrcodePosition").css({ top: imgpos.top + "px", left: imgpos.left + "px", width: bili + 'px', height: bili + 'px' });
        qrcodeLeft = parseFloat($("#FenXiaoQRCodeLeft").val());
        qrcodeTop = parseFloat($("#FenXiaoQRCodeTop").val());
        if (qrcodeLeft) $("#markQrcodePosition").css("left", imgpos.left + img.width() * qrcodeLeft / 100);
        if (qrcodeTop) $("#markQrcodePosition").css("top", imgpos.top + img.height() * qrcodeTop / 100);
        $("#markQrcodePosition").draggable({
            containment: $("#FenXiaoQRCodePreview"),
            drag: function (event, ui) {
                qrcodeLeft = ((ui.position.left - imgpos.left) / $("#FenXiaoQRCodePreview").width() * 100).toFixed(2);
                qrcodeTop = ((ui.position.top - imgpos.top) / $("#FenXiaoQRCodePreview").height() * 100).toFixed(2);
                console.log(qrcodeLeft + "," + qrcodeTop);
                $("#FenXiaoQRCodeLeft").val(qrcodeLeft);
                $("#FenXiaoQRCodeTop").val(qrcodeTop);
            }
        });
    }

    me.addListener('shopconfig2', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

IWF.plugins['storemanage'] = function () {

    var me = this;
    var ViewModel = function() {
        this.list = ko.observableArray();
        this.setData = function(data) { this.list(data); };
        this.sgrade = ko.observableArray();
        this.sclass = ko.observableArray();
        this.sinfo = ko.observableArray();
        this.agentl = ko.observableArray();
        this.pconfig = ko.observableArray();
        this.array = [];
        this.uploadproper = ko.observable();

        this.getTime = function (time) {
            if(time){
                if(/^(0000|1970)/.test(time)) return "";
                return time.split(' ')[0];
            }
        }

        
        this.getSublist = function(parentid){
            var ret = [];
            for(var i = 0;i < this.array.length;i++){
                if(this.array[i].ParentID == parentid) ret.push(this.array[i]);
            }
            return ret;
        };
        
    }
    var ViewModelLevel = function () {
        this.setData = function (data) {
            for(var key in data){
                if(data[key] == null){
                    this[key]=0;
                }else{
                    this[key] = data[key];
                }   
            }
        };      
    };
    var vm = new ViewModel();
    vm.uploadproper(me.hasLicensePerm('ENABLE_UPLOAD_PRODUCT'));
    var myroot = null;
    var ssclass = [];
    function initUI(root) {
        root.children().remove();
        if (!me.hasLicensePerm('ENABLE_AGENT')) {
            root.load("/index.php?c=admin/page/Versiontip&page=shopconfig");
            return;
        }

        root.loadHtmlTpl("plugins/o2opackage/html/storemanage.html?v=" + Math.random(),function(){
            myroot = root[0];
            LoadStoreList(1);
            LoadStoreGC();

            ko.applyBindings(vm,$('#O2oStoreTabs')[0]);
            $(function() {
                $( "#TimeBegin" ).datepicker({
                    format: "yyyy-mm-dd",
                    defaultDate: "+1w",
                    changeMonth: true,
                    dateFormat: "yy-mm-dd",
                    language: "zh-CN",
                    orientation: "bottom auto",
                    showOptions: { direction: "down" },
                    onClose: function( selectedDate ) {
                        $('#TimeEnd').datepicker( "option", "minDate", selectedDate );
                    }
                });
                $( "#TimeEnd" ).datepicker({
                    format: "yyyy-mm-dd",
                    defaultDate: "+1w",
                    changeMonth: true,
                    dateFormat: "yy-mm-dd",
                    language: "zh-CN",
                    orientation: "bottom auto",
                    showOptions: { direction: "down" },
                    onClose: function( selectedDate ) {
                        $( "#TimeBegin" ).datepicker( "option", "maxDate", selectedDate );
                    }
                });

            });
            
        });

    }
    
    var curpage = 1;
    function LoadStoreList(page,params){
        params = params || {keyword: $("#keyword").val(),TimeBegin: $("#TimeBegin").val(),TimeEnd: $("#TimeEnd").val(),storegrade: $("#storegrade").val(),allstate: $("#allstate").val(),sstoreagent: $("#sstoreagent").val(),page: page,pagesize: 20};
        // params = params || {page:page,pagesize:20};
        $.getJSON("/index.php?c=admin/o2o/storemanage&a=GetStoreList",utils.params(params), function(json) {
            if(json.success){
                vm.setData(json.list);
                curpage = json.curpage;
                if(json.pagecount < 2) $("#pagination").hide(); else {
                    //pageNav 方法定义在 /core/util.js 里
                    $("#pagination").pageNav(json.curpage, json.pagecount, 10, function(page) { LoadStoreList(page); });
                    $("#pagination").show();
                }
                $('#Total').html('共 ' + json.pagecount + ' 页， ' + json.count + '条记录');
                bindUIEvent();
            }else{
                alert(json.msg);
            }
        });
    }
    function bindUIEvent() {
        if(!me.hasLicensePerm('ENABLE_UPLOAD_PRODUCT')){
            $('.storegradeshow').remove();
        }
        $("<div></div>").appendTo(myroot).loadHtmlTpl("/admin/widget/userSelector.html",function(){
            $('#Addstore').userSelector({
                //新增店铺
                selectUser: function (data) {
                    $.post('/index.php?c=admin/o2o/storemanage&a=IsExistStore',{webuserid:data.userid},function(json){
                        if(json.success){
                            $('#StoreInfoFrom')[0].reset();
                            $('#StorePerFrom')[0].reset();
                            $('#wusername').attr('userid', data.userid).val(data.nickName);
                            $('#perstoreid').attr('userid', data.userid);
                            $('#storeinfo').show();
                            $('#storeper').show();
                            $('.subTab li').removeClass('active');
                            $('#storeper').addClass('active');
                            $('.tab-pane').removeClass('active');
                            $('#StorePer').addClass('active');
                            $('#StorePer').addClass('in');
                            getCouponList(data.userid,0);
                            $('#storeagent').val(json.agent);
                            $( "#storeexp,#storecre" ).datepicker({
                                format: "yyyy-mm-dd",
                                defaultDate: '+1w',
                                changeMonth: true,
                                dateFormat: "yy-mm-dd",
                                language: "zh-CN",
                                orientation: "bottom auto",
                                showOptions: { direction: "down" },
                                
                            });
                            
                        }else{
                            $.showResult(false, json.msg);
                        }
                    },'json');
                    
                    
                }
            });
        });
        $("#BtnSearch").unbind('click').bind('click', function(event) {
            LoadStoreList(1);
        });
        
        $('#storem').unbind('click').bind('click',function(event){
            $('#storeinfo').hide();
            $('#storeper').hide();
            LoadStoreList(1);
        });
        //地址选择器
        $('#areadiv').districtSeletor({ showCountry: 0 }).find('select').addClass('form-control').css({'width':'30%','display':'inline-block'});
        $('.level1').css('display','none');
       
        $('.BtnInfo,.BtnEdit').off('click').on('click',function(event){
            // StoreClassSub();
            var storeid = $(this).attr('StoreID');
            var userid = $(this).attr('UserID');
            var username = $('#nname'+userid).attr('alt');
            var isagent = $('#isagent'+userid).attr('agent');
            isagent = isagent?isagent:'';
            if(storeid){
                var params = {storeid:storeid};
            }else{
                //只有代理等级 没有店铺数据 
                $('#StoreInfoFrom')[0].reset();
                $('#StorePerFrom')[0].reset();
                $('#wusername').attr('userid', userid).val(username);
                $('#perstoreid').attr('userid', userid);
                $('#storeagent').val(isagent);
                $.ajax({
                    url:"/index.php?c=admin/o2o/storemanage&a=SaveStoreInfo",
                    async: false,//同步执行
                    type:'POST',
                    data:{userid:userid,storeid:-1,wusername:username},
                    dataType:'JSON',
                    success:function(json){
                        if(json.success){
                            $('#storeinfo').show();
                            $('#storeper').show();
                            $('.subTab li').removeClass('active');
                            $('#storeper').addClass('active');
                            $('.tab-pane').removeClass('active');
                            $('#StorePer').addClass('active');
                            $('#StorePer').addClass('in');
                            getCouponList(userid,0);
                            
                            $( "#storeexp,#storecre" ).datepicker({
                                format: "yyyy-mm-dd",
                                defaultDate: '+1w',
                                changeMonth: true,
                                dateFormat: "yy-mm-dd",
                                language: "zh-CN",
                                orientation: "bottom auto",
                                showOptions: { direction: "down" },
                                // onClose: function( selectedDate ) {
                                //     $( "#TimeBegin" ).datepicker( "option", "maxDate", selectedDate );
                                // }
                            });
                        }else{
                            $.showResult(false, json.msg);
                        }
                    }
                });
                
                return false;
            }
            
            var tclass = $(this).hasClass('BtnInfo');

            //获取store详细信息
            $.getJSON("/index.php?c=admin/o2o/storemanage&a=GetStoreInfo",utils.params(params), function(json) {
                if(json.success){
                    $('#StoreInfoFrom')[0].reset();
                    $('#StorePerFrom')[0].reset();
                    // $('#coulist').remove();
                    vm.sinfo(json.sinfo);
                    vm.pconfig(json.pconfig);

                    $('#storeinfo').show();
                    $('#storeper').show();
                    if(tclass){
                        $('.subTab li').removeClass('active');
                        $('#storeinfo').addClass('active');
                        $('.tab-pane').removeClass('active');
                        $('#StoreInfo').addClass('active');
                        $('#StoreInfo').addClass('in');
                    }else{
                        $('.subTab li').removeClass('active');
                        $('#storeper').addClass('active');
                        $('.tab-pane').removeClass('active');
                        $('#StorePer').addClass('active');
                        $('#StorePer').addClass('in');
                    }
                    if(json.sinfo.StoreType == '1'){
                        $('#storeaudtype').val('1');
                    }else if(json.sinfo.StoreType == '0'){
                        $('#storeaudtype').val('0');
                    }else{
                        $('#storeaudtype').val('');
                    }
                    //区域地址赋值
                    if(json.sinfo.StoreArea != ''){
                        if(json.sinfo.StoreArea.length > 1){
                            $('#areadiv').districtSeletor('setValue', {
                                countryID: 1,
                                provinceID: json.sinfo.StoreArea[0],
                                cityID: json.sinfo.StoreArea[1],
                                districtID: json.sinfo.StoreArea[2],
                            });
                        }else{
                            $('#areadiv').districtSeletor('setValue', {
                                countryID: 1,
                                provinceID: json.sinfo.StoreArea[0],
                                
                            });
                        }
                        
                    }
                    if(json.sinfo.StoreClass == 0){
                        json.sinfo.StoreClass = '';
                    }
                    $('#storeinfog').val(json.sinfo.StoreGrade);
                    $('#storeinfoc').val(json.sinfo.StoreClass);
                    $('#storeproaud').val(json.sinfo.IsProductAuditing);
                    if(json.sinfo.AgentState == 0)
                        json.sinfo.AgentState = '';
                    $('#storeagent').val(json.sinfo.AgentState);

                    //图片放大
                    $('.showimg').off('click').on('click',function(event){
                        $('#imgInModalID').attr('src',$(this).attr('src'));
                        $('#imgModal').modal();
                    });
                    //载入优惠券
                    getCouponList(userid,json.sinfo.AgentCoupon);
                    //初始化日期选择器
                    if(json.sinfo.StoreCreateTime)
                        var storecre = new Date(json.sinfo.StoreCreateTime.replace(/-/g,"/"));
                    else
                        var storecre = '+1w';
                    if(json.sinfo.StoreExpireTime)
                        var storeexp = new Date(json.sinfo.StoreExpireTime.replace(/-/g,"/"));
                    else
                        var storeexp = '+1w';
                    $( "#storecre" ).datepicker({
                        format: "yyyy-mm-dd",
                        defaultDate: storecre,
                        changeMonth: true,
                        dateFormat: "yy-mm-dd",
                        language: "zh-CN",
                        orientation: "bottom auto",
                        showOptions: { direction: "down" },
                        // onselect : function(dateText, inst){
                        //     alert(dateText.setFullYear(dateText.getFullYear()+1));
                        //     $('#storeexp').datepicker('option','defaultDate',dateText.setFullYear(dateText.getFullYear()+1));
                        // }, 
                    });
                    $( "#storeexp" ).datepicker({
                        format: "yyyy-mm-dd",
                        defaultDate: storeexp,
                        changeMonth: true,
                        dateFormat: "yy-mm-dd",
                        language: "zh-CN",
                        orientation: "bottom auto",
                        showOptions: { direction: "down" },
                        
                    });
                    
                }else{
                    alert(json.msg);
                }
            });
            
        });
        
        $(".BtnAgent").unbind('click').bind('click', function (event) {
            loadFenXiaoInFo($(this).attr("UserID"));
            return false;
        });


        //选择所有会员
        $('#selectAll').unbind().on('click', function() {
            $('#showListTable :checkbox:gt(0)').prop('checked', $('#showListTable :checkbox:eq(0)').prop('checked'));
        });

        //删除所选会员
        $('#BtnDelSelect').off('click').on('click',function(){
            
            if(!$("input[name=StoreID]").is(':checked')) alert('请至少选择一个店铺'); else {
                var storeid = getSelectedArtIDs();
                if(confirm("确认删除吗?")) {
                    $.getJSON("/index.php?c=admin/o2o/storemanage&a=DeleteStore",utils.params({'storeid': storeid}),function(json){
                    if(json.success){
                        LoadStoreList(1);
                        $.showResult(true, "删除成功", 2000);
                    }else{
                        LoadStoreList(1);
                        $.showResult(false, data.msg);
                    }
                });
                }
            }
        });
        
        $('input[name="AgentCoupon"]').change(function(){
            if($(this).prop('checked'))
            {
                $('.lcoupon').show();
            }
            else
            {
                $('.lcoupon').hide();
                $('.lcoupon').find('input[type="checkbox"]').prop('checked',false);
            }
            
        });

        //保存店铺信息
        $('.floatSaveBtn').off('click').on('click',function(){
            //没有多商户权限 或 没有商家等级 不去验证日期
            var storegrade = parseInt($('#storeinfog').val());
            if(me.hasLicensePerm('ENABLE_UPLOAD_PRODUCT') && storegrade > 0){
                if($('#storecre').val() == '' && !$('#storecre').val()){
                    $.showResult(false, "请输入开店时间！", 2000,function(){
                        
                    });
                    return;
                }

                if($('#storeexp').val() == '' && !$('#storeexp').val()){
                    $.showResult(false, "请输入店铺过期时间！", 2000,function(){
                        
                    });
                    return;
                }
            }

            if($('#wusername').attr('userid') != '' && $('#wusername').attr('userid') != undefined ){
                
                var params = $('#StoreInfoFrom').serializeObject();
                params.userid = $('#wusername').attr('userid');
                params.storeid = $('#storename').attr('storeid');
                $.ajax({
                    url:"/index.php?c=admin/o2o/storemanage&a=SaveStoreInfo",
                    async: false,//同步执行
                    type:'POST',
                    data:params,
                    dataType:'JSON',
                    success:function(json){
                        if(json.success){
                            if($('#perstoreid').attr('userid')){
                                var params2 = $('#StorePerFrom').serializeObject();
                                params2.userid = $('#wusername').attr('userid');
                                $.post("/index.php?c=admin/o2o/storemanage&a=SaveStorePer",params2,function(json){
                                    if(json.success){
                                        $.showResult(true, "保存成功", 2000,function(){
                                            window.location.reload();
                                        });
                                        // me.execCommand('go', { a: 'o2o', b: 'storemanage' });
                                        
                                    }else{
                                        $.showResult(false, json.msg);
                                    }
                                },'json');
                            }else{
                                alert('无效的会员ID！');
                            }
                        }else{
                            $.showResult(false, json.msg);
                        }
                    },
                    error:function(){
                        alert('保存出错，请重试！');
                    }
                });
            }else{
                alert('请选择会员！');
            }
            
        });
        
    }

    //获取优惠券列表
    function getCouponList(userid,AgentCoupon){
        var div='<div class="lcoupon"><div><input type="checkbox" id="allCoupon"> 选择所有优惠券</div>';
        $.getJSON("/index.php?c=admin/business/coupon&a=GetList&isagent=1",'uid='+userid,function(data){
            for(var l in data.list)
            {
                if(data.list[l].AgentUserID)
                    var checked=data.list[l].AgentUserID.indexOf('('+data.storeid+'|')>=0 ? 'checked':'';
                else
                    var checked='';
                div+='<div><input type="checkbox" name="coupon[]" value="'+data.list[l].CouponID+'" '+checked+'> '+data.list[l].Title+'</div>';
            } 
            div+='</div>';
            $('#coulist').html(div);
            //优惠券全选
            $('#allCoupon').off('click').on('click',function (){
                if($(this).prop('checked'))
                    $('.lcoupon').find('input[type="checkbox"]').prop('checked',true);
                else
                    $('.lcoupon').find('input[type="checkbox"]').prop('checked',false);
            });
            //优惠券列表的显示
            if(AgentCoupon == '1'){
                $('.lcoupon').show();
            }else{
                $('.lcoupon').hide();
            }
        });
    }
    //获取批量storeid
    function getSelectedArtIDs() {
        var array = new Array();
        $("input[name=StoreID]:checked").each(function() {
            array.push($(this).val());
        });
        var id = array.join(',');
        return id;
    }
    function loadFenXiaoInFo(userid){
        $('.fenxiaodialog').remove();
        $("#divFenXiaoInfo").dialog({
            width: 700, height: 420, resizable: true, modal: true,
            dialogClass:"fenxiaodialog",
            title: '分销详情',
            open: function (event, ui) {
                $('.loadingPanel').remove();
                $.getJSON("/index.php?c=admin/user/usermanage&a=GetChildLevel", utils.params({UserID: userid}), function (json) {
                    vmlevel = new ViewModelLevel();
                    vmlevel.setData(json);
                    ko.applyBindings(vmlevel,$("#divFenXiaoInfo")[0]);      
                    // bindGridEvent();
                    $('.loadingPanel').remove();
                });
            },
            close: function (event, ui) {
                $(this).dialog("close");
            }
        });
    }
    
    function LoadStoreGC(){
        var agentlevel = new Array();
        $.getJSON("/index.php?c=admin/o2o/storemanage&a=GetStoreGradeClass",null,function(json){
            if(json.success){
                vm.sgrade(json.sgrade);
                vm.sclass(json.sclass);
                vm.array = json.sclass;
                ssclass = json.sclass;
                StoreClassSub();
                if(parseInt(json.agentlevel) > 0){
                    for(var i=1;i<=parseInt(json.agentlevel);i++){
                        var atemp = {key:i,val:i+"级代理"};
                        agentlevel.push(atemp);
                    }
                    vm.agentl(agentlevel);
                }
            }else{
                alert(json.msg);
            }
        });
    }
    function StoreClassSub(){
        
        $('.sclass').each(function(){
            for(var i=ssclass.length-1;i>0;i--){
                if(ssclass[i].ParentID == $(this).val()){
                    $(this).after('<option value='+ssclass[i].ClassID+'>&nbsp;&nbsp;&nbsp;└─'+ssclass[i].ClassName+'</option>')
                }
            }
        });
    }
    me.addListener('storemanage', function (key, args) {
        initUI(args);
    });
}
﻿IWF.plugins['seo'] = function () {
	
    var me = this;
    var nav = { icon: 'icon-bullhorn',color: 'icon-blue', title: '推广', a: 'seo', b: 'seoengin', index: 9, canClose: false };

    var leftRoot, rightRoot, leftNav;

    var navConfig = {
        showOption:false,

		data: [
            //{ icon: 'icon-sitemap', color: 'icon-red', title: '搜索引擎提交', a: 'seo', b: 'seoengin' }
        ],

        onItemClick: function (sender, data) {
			leftNav.hide();
			me.execCommand('go', data);
        },

        setSelect: function (args) {
            var index = 0;
            $.each(navConfig.data, function (i, item) {
                index++;
                if (item.a == args.a && item.b == args.b) {
                    navConfig.selectIndex = index;
                }
                if (item.items) {
                    $.each(item.items, function (k, citem) {
                        index++;
                        if (citem.a == args.a && citem.b == args.b) {
                            navConfig.selectIndex = index;
                        }
                    });
                }
            });
        }
    };

    me.addListener('init', function () { 
		var tab = me.execCommand('addtab', nav);
		if (tab.c.children().length == 0) {
            var temp = $('<div class="row"></div>').appendTo(tab.c);
            //leftRoot = $('<div class="col-sm-1 col-md-2 mainside"></div>').appendTo(temp);
            rightRoot = $('<div class="col-sm-9 col-md-10 col-sm-offset-3 col-md-offset-0"></div>').appendTo(temp);
            //leftRoot.append('<div class="navcontent"></div>');
        }

		leftNav = $('<div class="sidebarNavPanel"><div class="titlebar"><div class="title">'+ nav.title +'</div></div><div class="content"><ul></ul></div></div>').appendTo("body");
		leftNav.find('.content>ul').listNav2(tab,leftNav,navConfig);

		tab.t.click(function(){ leftNav.hide(); });
	});

    function flash(args, tab,isgo) {
        

        //原来架框的建立下级菜单过程
		//navConfig.setSelect(args);
        //leftRoot.find('div.navcontent').listNav(navConfig);

		me.execCommand('show', { a: args.a });
        setChildWindow(args,rightRoot,isgo);
    }

    function setChildWindow(args, root,isgo) {
        /*var temp = root.find('#' + args.b);
        if (temp.length == 0) {
            temp = $('<div id="' + args.b + '"></div>').appendTo(root);
        }
        temp.show();
        temp.siblings().hide();
        if(isgo) me.execCommand('go', args);
		else me.fireEvent(args.b, temp);*/

		if(isgo) me.execCommand('go', args);
		else me.fireEvent(args.b, me.content); //me.content 定义在 core/content.js 里
    }

    me.addListener(nav.a, function (key, args) {
        var tab = me.execCommand('gettab', nav);
        flash(args, tab);
    });
};

﻿IWF.plugins['seoengin'] = function () {

	var me = this;
	
	function initUI(root) {
		
        root.children().remove();
        root.loadHtmlTpl("plugins/seopackage/html/seoengin.html",function() {			
			
		});
    }

    me.addListener('seoengin', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['skin'] = function () {
	
    var me = this;
    var nav = { icon: 'fa fa-tasks',color: 'icon-blue', title: '样板', a: 'skin', b: 'skinlist', index: 2, canClose: false };

    var leftRoot, rightRoot, leftNav;

    var navConfig = {
        showOption:false,

		data: [],

        onItemClick: function (sender, data) {
			leftNav.hide();
			me.execCommand('go', data);
        },

        setSelect: function (args) {
            var index = 0;
            $.each(navConfig.data, function (i, item) {
                index++;
                if (item.a == args.a && item.b == args.b) {
                    navConfig.selectIndex = index;
                }
                if (item.items) {
                    $.each(item.items, function (k, citem) {
                        index++;
                        if (citem.a == args.a && citem.b == args.b) {
                            navConfig.selectIndex = index;
                        }
                    });
                }
            });
        }
    };

    me.addListener('init', function () {
		var tab = me.execCommand('addtab', nav);
		if (tab.c.children().length == 0) {
            var temp = $('<div class="row"></div>').appendTo(tab.c);
            //leftRoot = $('<div class="col-sm-1 col-md-2 mainside"></div>').appendTo(temp);
            rightRoot = $('<div class="col-sm-9 col-md-10 col-sm-offset-3 col-md-offset-0"></div>').appendTo(temp);
            //leftRoot.append('<div class="navcontent"></div>');
        }

		leftNav = $('<div class="sidebarNavPanel"><div class="titlebar"><div class="title">'+ nav.title +'</div></div><div class="content"><ul></ul></div></div>').appendTo("body");
		leftNav.find('.content>ul').listNav2(tab,leftNav,navConfig);
		if(!me.hasPerm("SysAdm")) tab.t.hide();
		tab.t.click(function(){ leftNav.hide(); });
	});

    function flash(args, tab,isgo) {
        

        //原来架框的建立下级菜单过程
		//navConfig.setSelect(args);
        //leftRoot.find('div.navcontent').listNav(navConfig);

		me.execCommand('show', { a: args.a });
        setChildWindow(args,rightRoot,isgo);
    }

    function setChildWindow(args, root,isgo) {
        /*var temp = root.find('#' + args.b);
        if (temp.length == 0) {
            temp = $('<div id="' + args.b + '"></div>').appendTo(root);
        }
        temp.show();
        temp.siblings().hide();
        if(isgo) me.execCommand('go', args);
		else me.fireEvent(args.b, temp);*/

		if(isgo) me.execCommand('go', args);
		else me.fireEvent(args.b, me.content); //me.content 定义在 core/content.js 里
    }

    me.addListener(nav.a, function (key, args) {
        var tab = me.execCommand('gettab', nav);
        flash(args, tab);
    });
};

﻿IWF.plugins['skinlist'] = SkinClass = function (options) {

	var me = this;
	
	var ViewModel = function () {
		this.hottestSkins = ko.observableArray();
        this.skinlist = ko.observableArray();
        this.setData = function (data) { this.skinlist(data); };
		this.getMark = function(Mark,SkinType){
			if (Mark == "1" && SkinType == 1)
                return "<img src='/images/pay.gif' border='0' align='absmiddle' alt='付费，获得授权后可免费使用' />";
            return "";
		}
		this.isHot = function(skinID){
			if($.inArray(skinID, this.hottestSkins()) > -1 && $('#searchOrderBy').val() == 'used'){
				return true;
			}
			return false;
		}
		this.isShowUsedAmount = function(){
			return $('#searchOrderBy').val() == 'used';
		}
    };
	
	var vm = new ViewModel();
	var SiteType = 0, noInstallSkin = true, firstInstallType = 1, hasShowHelp = false, isInFrontDesignPage = false, isShowCurTpl = true;
	function initUI(root) {
	    SiteType = getCookie("SiteType");
	    isInFrontDesignPage = location.pathname.indexOf('/admin/skin.html') > -1;
	    isInFrontDesignPage |= location.pathname.indexOf('/admin/firstinstallskin.html') > -1;
	    isShowCurTpl &= location.pathname.indexOf('/admin/firstinstallskin.html') == -1;

	    if (me.currentModule && me.currentModule.params) {
	        if (me.currentModule.params.SiteType == 1) {
	            SiteType = 1;
	        } else if (me.currentModule.params.SiteType == 0) {
	            SiteType = 0;
	        }
	    }

        root.children().remove();
		root.html();
		var tpl = "skinlist";
		if(SiteType == "1") tpl = "wskinlist";
		root.loadHtmlTpl("plugins/skinpackage/html/" + tpl + ".html?rand=" + Math.random(), function () {
		    hasShowHelp = false;

			loadMetier();
			loadColors();
			ko.applyBindings(vm, root[0]);

            // 商城类站点先显示商城分类的
			InitSearchMetier();

			if (SiteType == 1 && options && $.inArray(options.templateType, ['normal', 'responsive']) > -1) {
			    $('#templateType').val(options.templateType);
			}

            // 外部指定就以外部搜索条件为优
			if (me.currentModule && me.currentModule.params && me.currentModule.params.searchParams) {
			    try {
			        searchParams = JSON.parse(decodeURIComponent(me.currentModule.params.searchParams));
			        $("#MetierID").val(searchParams.MetierID);
			    } catch (ex) {
			    }
			}

			$("#spTplList").hide();

			$('#btnSearch').off().on('click', function () {
			    loadTpl(1);
			})

			loadTpl(1);

			if (isShowCurTpl) {
			    $('[iscurtpl="1"]').show();
			} else {
			    $('[iscurtpl="1"]').hide();
			}
		});
    }
    
	function loadMetier(){
		$("#MetierID").children().remove();
		$("#MetierID").append("<option value=''>行业分类</option>");
		//$.ajax({ url: "/admin/skin/skinmanage?act=LoadMetier", async: false, dataType: "json", success: function (json) {
		$.ajax({ url: "/index.php?c=admin/skin/skinmanage&a=loadMetier", async: false, dataType: "json", success: function (json) {
				if(json.success){
				    // 因为实际上只有两级，所以可以这样分级
				    for (var i = 0; i < json.list.length; i++) {
				        var iMetierID = json.list[i].ID;
				        var sMetierName = json.list[i].Name;
				        var iParentID = json.list[i].ParentID;
				        if (iParentID == 0) {
				            // 在线商城排最前
				            if (iMetierID == 1015)
				                $("#MetierID option:eq(0)").after("<option value='" + iMetierID + "'>" + sMetierName + "</option>");
				            else
				                $("#MetierID").append("<option value='" + iMetierID + "'>" + sMetierName + "</option>");
                            // TODO 这里因为“在线商城”排前面，所以下面append要处理
				            // 先隐藏二级
				            /*
				            for (var j = 0; j < json.list.length; j++) {
				                var iChildMetierID = json.list[j].ID;
				                var sChildMetierName = json.list[j].Name;
				                var iChildParentID = json.list[j].ParentID;
				                if (iChildParentID == iMetierID) {
				                    $("#MetierID").append("<option value='" + iChildMetierID + "'>└-" + sChildMetierName + "</option>");
				                }
				            }
                            */
				        }
				    }
				}else{
					alert("出错了：" + json.msg);
				}
			}
		});
	}

	function loadColors(){
	    $.ajax({
	        //url: "/admin/skin/skinmanage?act=LoadColor", async: true, dataType: "json", success: function (json) {
			url: "/index.php?c=admin/skin/skinmanage&a=loadColor", async: true, dataType: "json", success: function (json) {
	            if (json.success) {
	                $("#spColors .Colors").replaceWith(json.ColorSelect);
	                $("#spColors .Colors").css({ 'display': 'none', 'z-index': 100 }).addClass('well well-sm');
	                $("#spColors").find("label").append("<i></i>");
	                $("#spColors>div>:first-child").addClass("Active");
	                $('#curColor').off().on('click', function () {
	                    $("#spColors .Colors").toggle();
	                })

	                $("#spColors").find("label").unbind().click(function () {
	                    $('#searchColor').val($(this).attr('value'));
	                    $("#spColors").find("label").removeClass("Active");
	                    $(this).addClass("Active");
	                    $("#spColors .Colors").toggle();
	                    //loadTpl(1);
	                    $('#curColor').html($(this).prop('outerHTML') + '<span class="caret">');
	                });
	            } else {
	                alert("出错了：" + json.msg);
	            }
	        }
	    });
	}
	
	function InitSearchMetier(){
		/* 
		// 前台编辑不能用
		if (me.getBackstage() == 2) {
			$('#MetierID').val('1015');
		}
		*/

		var backstage = 0;
	    $.ajax({
			url: "/index.php?c=admin/login&a=getbackstage", async: false, cache:false, dataType: "json", success: function (json) {
	            if (!json.success) {
					alert("出错了：" + json.msg);
					return;
	            }			
				backstage = json.backstage;
	        }, error:function(){
				alert(arguments[0].responseText);
			}
	    });

		// 商城类站点先显示商城分类的
		if(backstage == 2){
			$('#MetierID').val('1015');
		}
	}

	var curpage = 1;
	var itemcount = 0;
	function loadTpl(page) {
		$(".loadingTpl").show();
		var action = "loadPcSkinInfo";
		if(SiteType == "1") action = "loadWapSkinInfo";
		var params = {
		    act: action,
		    MetierID: $("#MetierID").val(),
		    ColorStyle: $("#spColors").find("label.Active").attr("value"),
		    Keyword: $('#searchKeyword').val(),
		    OrderBy: $('#searchOrderBy option:selected').val(),
		    TemplateType: $('#templateType').val(),
		    page: page,
		    pagesize: 7,
		};
		//$.getJSON("/admin/skin/skinmanage", utils.params(params), function (json) {
		$.getJSON("/index.php?c=admin/skin/skinmanage&a=" + action, utils.params(params), function (json) {
		    noInstallSkin = json.noInstallSkin;
		    firstInstallType = json.firstInstallType;
            vm.setData(json.list);
			if(json.hottestSkins) vm.hottestSkins(json.hottestSkins);
            //$('*[name=BtnViewBig]').off('error').on('error', function () {
            //    var img = this;
            //    if ($(img).attr('reloaded') == 1) return;
            //    img.src = (img.src + '').replace(/\.jpg$/i, '\.gif');
            //    $(img).attr('reloaded', 1);
            //});

			$("#PcSkin").html(json.Skin);
			if(SiteType == 1) $("#CurPcTemplate").attr("src","/skin/"+ json.WapSkin +"/skinsrc/styles/tempshow.gif");
			else $("#CurPcTemplate").attr("src","/skin/"+ json.Skin +"/skinsrc/images/tempshow.gif");

			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#skinPageNav").hide();
            else {
                //pageNav 方法定义在 /core/ui.js 里
                $("#skinPageNav").pageNav(json.curpage, json.pagecount, 10, function (page) { loadTpl(page); });
                $("#skinPageNav").show().css("display","block");
            }
			$(".loadingTpl").hide();
			$("#spTplList").show().css("display","block");

			bindGridEvent();

			//initHelp();
        });
	}

	function InstallTpl(SkinID, SkinType, Mark, smallImage, metierName, SkinName, IsExcellent, MatingSkin, MatingSkinSmallImage) {
	    if (SkinType == 3 && me.hasLicensePerm && !me.hasLicensePerm('ENABLE_RESPONSIVE')) {
	        $.showResult(false, '当前版本无H5响应式功能，请选择网站类型—手机站，进行安装！');
	        return;
	    }

        var ver = 2;
        var forms = "";
		var setheight = false;
        if (ver < 1 && Mark == "1"){
            forms = "<ul class='UlCon PCError'><li>" + SkinID + "为高级样板，<%=ExpireMessage%></li></ul>";
        } else {
            var f = '<table id="installDialog" class="table" border="0" cellspacing="0">';
            f += '<tbody>';
            f += '<tr>';

			if(SkinType == 1){
				f += '<td width="100" align="right" class="leftName">缩略图：</td>';
				f += '<td >';
				f += '<div class="pcImgCont" ><div style="height:128px;overflow:hidden;"><img class="installPreviewImg" src="' + smallImage + '" width="168"></div><div class="imgMask" >'+ SkinID +'</div></div>';
				f += '</td>';
				if(IsExcellent == "1"){
					f += '<td  align="center" style="width:50px;"><span class="matchText" >配</span></td>';
					f += '<td style="width:190px;">';
					f += '<div class="phoneImgCont" ><div style="height:138px;overflow:hidden;"><img class="installPreviewImg" src="' + MatingSkinSmallImage + '" width="88"></div><div class="imgMask" >'+ MatingSkin +'</div></div>';
					f += '</td>';
				}
			}else{
				f += '<td width="100" align="right" class="leftName">缩略图：</td>';
				f += '<td width="100">';
				f += '<div class="phoneImgCont" ><div style="height:128px;overflow:hidden;"><img class="installPreviewImg" src="' + smallImage + '" width="88"></div><div class="imgMask" >'+ SkinID +'</div></div>';
				f += '</td>';
				if(IsExcellent == "1"){
					f += '<td  align="center" style="width:50px;padding: 0;" ><span class="matchText" >配</span></td>';
					f += '<td  style="width:190px;">';
					f += '<div class="pcImgCont" ><div style="height:128px;overflow:hidden;"><img class="installPreviewImg" src="' + MatingSkinSmallImage + '" width="168"></div><div class="imgMask" >'+ MatingSkin +'</div></div>';
					f += '</td>';
				}
			}

            f += '</tr>';
            f += '<td align="right" class="leftName">类别：</td>';
            f += '<td colspan="3"><b class="installMetierName">' + metierName + '</b></td>';
            f += '</tr>';
            if (noInstallSkin) { // 首次安装
                f += '<tr style="display:none;" ><td colspan="4"><input type="radio" name="raSetData" value="' + firstInstallType + '" checked="checked"></td></tr>';
            } else {
                f += '<tr>';
                f += '<td align="right" class="leftName">操作：</td>';
                f += '<td colspan="3"><input type="radio" name="raSetData" value="0" checked="checked">&nbsp;只复制样板皮肤<font color="#FF0000">（所有数据及模块保留）</font></td>';
                f += '</tr>';
                f += '<tr>';
				f += '<td align="right" ></td>';
                f += '<td colspan="3">';
                f += '<input type="radio" name="raSetData" value="1">';
                f += '&nbsp;复制样板皮肤及布局<font color="#FF0000">（前台所有模块会被覆盖，但后台数据保留）</font>';
                f += '</td>';
                f += '</tr>';
                if (SkinType == 1) {
                    f += '<tr id="installTr2">';
					f += '<td align="right" ></td>';
                    f += '<td colspan="3"><input type="radio" name="raSetData" value="2">&nbsp;完全复制样板<font color="#FF0000">（将您的全部模块和数据清空，请谨慎操作慎用！）</font></td>';
                    f += '</tr>';
                }
            }
			if(IsExcellent == "1"){
				f += '<tr>';
				f += '<td align="right" class="leftName">同步：</td>'
				f += '<td colspan="3">';
				f += '<input type="checkbox" id="cbInstallMatingSkin" name="cbInstallMatingSkin" value="1" '+ (noInstallSkin ? 'checked="checked"':'') +'>';
				f += '安装配套的'+ (SkinType == 1 ? '手机站' : 'PC站') +'样板'				
				f += '</td>';
				f += '</tr>';
			}
            f += '</tbody>';
            f += '<input type="hidden" value="' + SkinID + '" name="HSKD" id="HSKD" />';
            f += '<input type="hidden" value="' + SkinType + '" name="HTYPE" id="HTYPE" />';
            f += '</table>';

			forms = f;
        }
        
        if (SkinType == 2 && ver < 2) {
            forms = "<span class='WapError'>当前版本不支持微站，请升级至更高级版！</span>";
        }

        var dialog = bootbox.dialog({
            title: '安装样板',
            message: forms,
            buttons: {
				confirm: {
                    label: "确定",
                    className: "btn-success",
                    callback: function () {
                        InstallTpl2();
                    }
                },
                close1: {
                    label: "关闭",
                    className: "btn-default",
                    callback: function () {
                        $(this).modal('hide');
                    }
                }
              
            }
        });
	}

	function InstallTpl2() {
        var skid = $("#HSKD").val();
        var sType = $("#HTYPE").val();
		var installMatingSkin = $('#cbInstallMatingSkin:checked').val();
		var InstallType = parseInt($('input:radio[name=raSetData]:checked').val());
		if (!noInstallSkin && InstallType == 2) {
		    if (!confirm("此选项将您的全部模块和数据清空，请谨慎操作慎用！！")) {
		        return;
		    }
		}

		var dialog2 = bootbox.dialog({
		    title: '正在安装样板，请耐心等候',
		    closeButton: false,
		    message: "<p><img src='/images/stepLoading.gif' align='center' style='max-width: 100%;'/></p>"
		});
		dialog2.find('.modal-dialog').css({ 'margin-top': '260px' });
		
		var params = { SkinID: skid, SkinType: sType, InstallType: InstallType, SiteType: SiteType,installMatingSkin: installMatingSkin };
		setTimeout(function () {
		    //$.getJSON("/admin/skin/skinmanage?act=InstallSkin", utils.params(params), function (json) {
			$.getJSON("/index.php?c=admin/skin/skinmanage&a=InstallSkin", utils.params(params), function (json) {
		        bootbox.hideAll();
		        if (json.success) {
		            $("#PcSkin").html(skid);
		            if (sType == 2) $("#CurPcTemplate").attr("src", "/skin/" + skid + "/skinsrc/styles/tempshow.gif");
		            else $("#CurPcTemplate").attr("src", "/skin/" + skid + "/skinsrc/images/tempshow.gif");

		            var link = "/?SiteType=0";
		            if (sType == "2") link = "/?SiteType=1";

		            // 前台安装样板，直接刷新页面
		            if (isInFrontDesignPage) {
		                parent.location = '/';
		            } else {
		                var html = '<div class="frame">';
		                html += '<div class="frame_c">';
		                html += '<div style="width:482px;height:120px;margin:0 auto;">';
		                html += '<a href="javascript:;" onclick="bootbox.hideAll();location.href=\'#config.configsite\'">网站资料</a>';
		                html += '<a href="javascript:;" onclick="bootbox.hideAll();location.href=\'#config.configmenu\'">设置导航</a>';
		                html += '<a href="javascript:;" onclick="bootbox.hideAll();location.href=\'#business.productedit\'">添加产品</a>';
		                html += '<a href="javascript:;" onclick="bootbox.hideAll();location.href=\'#news.newsedit\'">添加新闻</a>';
		                html += '<a href="javascript:;" onclick="bootbox.hideAll();window.open(\'/\')">网站编辑</a>';
		                html += '</div>';
		                html += '</div>';
		                html += '</div>';
		                bootbox.dialog({
		                    title: '样板安装成功',
		                    message: html,
		                    className: 'installSuccessDialog'
		                }).css({ 'margin-top': 200 });
		            }
		        } else {
		            var html = "安装失败：" + json.msg;
		            var dialog3 = bootbox.dialog({
		                title: '',
		                message: html
		            }).css({ 'margin-top': '260px' });
		        }
		    });
		}, 1);
    }

	function bindGridEvent() {
		
		// $("*[name=BtnViewBig]").unbind('click').bind('click', function (event) {
		// 	var BigImage = $(this).attr("BigImage");
		// 	var SkinID = $(this).attr("SkinID");
		// 	$("#ViewBigDialog").remove();
		// 	$("body").append("<div id='ViewBigDialog' style='background:#fff;padding:10px'><img src='"+ BigImage +"' "+ (SiteType == "1" ? "width='300'":"") +"></div>");
		// 	$("#ViewBigDialog").dialog({ resizable: false, title: SkinID, modal: true, width: (SiteType == "1" ? 330 : 850), position: ['center', 'top'], close: function (event, ui) { $(this).remove(); } });
  //       });

		$("*[name=BtnPreview]").unbind('click').bind('click', function (event) {
			var skinid = $(this).attr("SkinID");
			var skintype = $(this).attr("SkinType");
			var demourl = $(this).attr("DemoUrl");
			/*if(skintype == "1") window.open("/?Skin=" + skinid);
			else{
				if(window.parent.PhoneView) window.parent.PhoneView();
				else window.open("/?PhoneView=1&wapskin=" + skinid);
			}*/
		    //window.open(demourl);
			if (SiteType == 1) {
			    demourl = encodeURIComponent(demourl);
			    window.open("/admin/page/MobilePreview.html?previewUrl=" + demourl);
			} else {
			    if (demourl.indexOf("?") > -1)
			        demourl += '&';
			    else
			        demourl += '?';
			    window.open(demourl + 'SiteType=0');
			}
			return false;
        });

		$("*[name=BtnInstall]").unbind('click').bind('click', function (event) {
			var skinid = $(this).attr("SkinID");
			var skintype = $(this).attr("SkinType");
			var mark = $(this).attr("Mark");
			var smallImage = $(this).attr("SmallImage");
			var metierName = $(this).attr("MetierName");
			var SkinName = $(this).attr("SkinName");
			var IsExcellent = $(this).attr("IsExcellent");
			var MatingSkin = $(this).attr("MatingSkin");
			var MatingSkinSmallImage = $(this).attr("MatingSkinSmallImage");
			InstallTpl(skinid, skintype, mark, smallImage, metierName,SkinName,IsExcellent,MatingSkin,MatingSkinSmallImage);
			return false;
        });
	}
	
	function initHelp() {
        // 当前页已经显示过引导的话，或者当前页是嵌套在前台设计界面的ifreme里，不显示引导
	    if (hasShowHelp || isInFrontDesignPage) return;

	    $('body').pagewalkthrough('clearCache');
	    if (getCookie("SiteType") == "1") {
	        $('body').pagewalkthrough({
	            name: 'skin',
	            steps: [{
	                wrapper: '[name="BtnInstall"]',
	                popup: {
	                    content: '#walkthrough-mobile-1',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }, {
	                wrapper: '[name="BtnPreview"]',
	                popup: {
	                    content: '#walkthrough-2',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }],
	            buttons: {
	                jpwClose: {
	                    i18n: '',
	                    show: true
	                },
	                jpwNext: {
	                    i18n: '下一步 &rarr;',
	                    show: false
	                },
	                jpwPrevious: {
	                    i18n: '&larr; 上一步',
	                    show: false
	                },
	                jpwFinish: {
	                    i18n: '完成 &#10004;',
	                    show: false
	                }
	            }
	        });
	    } else {
	        $('body').pagewalkthrough({
	            name: 'skin',
	            steps: [{
	                wrapper: '[name="BtnInstall"]',
	                popup: {
	                    content: '#walkthrough-1',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }, {
	                wrapper: '[name="BtnPreview"]',
	                popup: {
	                    content: '#walkthrough-2',
	                    type: 'tooltip',
	                    position: 'right'
	                }
	            }],
	            buttons: {
	                jpwClose: {
	                    i18n: '',
	                    show: true
	                },
	                jpwNext: {
	                    i18n: '下一步 &rarr;',
	                    show: false
	                },
	                jpwPrevious: {
	                    i18n: '&larr; 上一步',
	                    show: false
	                },
	                jpwFinish: {
	                    i18n: '完成 &#10004;',
	                    show: false
	                }
	            }
	        });
	    }

	    noInstallSkin ? $('body').pagewalkthrough('show') : $('body').pagewalkthrough('renderOverlay');
	    hasShowHelp = true;
	}

	if(me && me.addListener){
		me.addListener('skinlist', function (key, args) {
			initUI(args);
		});
	}

	if(options && options.autoInit){
		initUI(options.uiDom);
	}
}

﻿IWF.plugins['weixin'] = function () {

  var me = this, leftRoot, rightRoot, leftNav, nav = {
    icon: 'fa fa-inbox', color: 'icon-blue', title: '消息', a: 'weixin', b: 'wxconfig', index: 7, canClose: false
  }, navConfig = {
    showOption: false, data: [], onItemClick: function(sender, data) {
      leftNav.hide();
      me.execCommand('go', data);
    },

    setSelect: function(args) {
      var index = 0;
      $.each(navConfig.data, function(i, item) {
        index++;
        if(item.a == args.a && item.b == args.b) {
          navConfig.selectIndex = index;
        }
        if(item.items) {
          $.each(item.items, function(k, citem) {
            index++;
            if(citem.a == args.a && citem.b == args.b) {
              navConfig.selectIndex = index;
            }
          });
        }
      });
    }
  };

  me.addListener('init', function() {
    var tab = me.execCommand('addtab', nav);
    if(tab.c.children().length == 0) {
      var temp = $('<div class="row"></div>').appendTo(tab.c);
      //leftRoot = $('<div class="col-sm-1 col-md-2 mainside"></div>').appendTo(temp);
      rightRoot = $('<div class="col-sm-9 col-md-10 col-sm-offset-3 col-md-offset-0"></div>').appendTo(temp);
      //leftRoot.append('<div class="navcontent"></div>');
    }

    leftNav = $('<div class="sidebarNavPanel"><div class="titlebar"><div class="title">' + nav.title +
      '</div></div><div class="content"><ul></ul></div></div>').appendTo("body");
    leftNav.find('.content > ul').listNav2(tab, leftNav, navConfig);
    if(!me.hasPerm("SysAdm")) tab.t.hide();
    tab.t.click(function() { leftNav.hide(); });
  });

	utils.addScript("/scripts/jQuery/masonry.js");

    function flash(args, tab,isgo) {
		me.execCommand('show', { a: args.a });
        setChildWindow(args,isgo);
    }

    function setChildWindow(args,isgo) {
		if(isgo) me.execCommand('go', args);
		else me.fireEvent(args.b, me.content); //me.content 定义在 core/content.js 里
    }

    me.commands['initContentNavweixin'] = {
        execCommand: function (key, domObj) {
            var items = [];
            items.push({ title: '公众号设置', a: 'weixin', b: 'wxconfig' });
          if(!!(getCookie('SiteType') - 0)) {
            items.push({title: '自定义菜单', a: 'weixin', b: 'wxmenu'});
            items.push({title: '自动回复', a: 'weixin', b: 'wxreply'});
            items.push({title: '关键词回复', a: 'weixin', b: 'wxkeyword'});
            items.push({title: '群发管理', a: 'weixin', b: 'wxgroupsend'});
            items.push({title: '素材管理', a: 'weixin', b: 'wxnewslist'});
            items.push({title: '用户管理', a: 'weixin', b: 'wxuserlist'});
          }
            items.push({ title: '模板消息', a: 'weixin', b: 'wxtemplate' });
            me.execCommand('addContentNav', domObj, items);
        }
    }

    me.addListener('weixin', function (key, args) {
        var tab = me.execCommand('gettab', {});
        flash(args, tab);
    });
};

﻿IWF.plugins['wxconfig'] = function () {

    var me = this;
	
	var myroot = null;
	function initUI(root) {
	    root.children().remove();
	    
	    root.loadHtmlTpl("plugins/weixinpackage/html/wxconfig.html?v=" + Math.random(), function () {
	        me.execCommand('initContentNav', root);
	        $("#UserCheck").off().change(function () {
	            if ($(this).is(":checked")) {
	                $("#ConvertUser").val(1);
	            } else {
	                $("#ConvertUser").val(0);
	            }
	        });
			$("#WxConfForm").validate({
				invalidHandler: function () {
                    $(".error").removeClass("gray none");
                },
				rules: {
					WeiXinId: "required"
					, WeiXin: "required"
					, WxType: "required"
					, QRCode: "required"
                    , AppId: "required"
                    , AppSecret: "required"
				},
				messages: {
					WeiXin: "请输入微信息公众号！"
                    , WeiXinId: "请输入微信息公众号的原始ID！"
                    , WxType: "请选择公众号的类型！"
                    , QRCode: "请上传微信二维码图片！"
                    , AppId: { required: "请输入开发者AppId" }
                    , AppSecret: { required: "请输入开发者AppSecret" }
				},
				submitHandler: function (form) {
					submitForm();
					return false;
				}
			});
			
			bindUIEvent();
			myroot = root[0];
			loadData();
		});
    }

	function bindUIEvent(){
		$("#AddImage").unbind('click').bind("click",function(){
			openImageDialog();
		});

		$("a[name=LinkHelp]").unbind('click').bind("click",function(){
			var url = $(this).get(0).href.toString().replace("#W","?token=" + escape($("#Token").val()) + "&url=" + escape($("#ApiUrl").text()) + "#W");
			window.open(url);
			return false;
		});

		$("#resetAll").unbind('click').click(function () {
            $('#ModalContent').html("<i class='fa fa-exclamation-triangle' style='color:red;font-size:30px;margin-top:-5px;'></i><span style='margin-left:10px;color:red;font-size:1.2em'><strong>注意：</strong>重置公众号只保留自定义菜单和图文素材，其他内容全部清空并无法恢复，请谨慎操作！</span>");
            if (!$(".modal-footer").is("div")) {
                $(".modal-footer").show();
                $('.modal-body').after('<div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">取消重置</button><button type="button" class="btn btn-primary resetAllWx">确认重置</button></div>');
            }
            $('#myModal').modal();
		});

		$("#wt1").unbind('click').click(function () {
		    $("#haiTr").show();
		});

		$("#wt2").unbind('click').click(function () {
		    $("#haiTr").show();
		});

		$("#wt3").unbind('click').click(function () {
		    $("#haiTr").hide();
		});

		$("#wt4").unbind('click').click(function () {
		    $("#haiTr").show();
		});

		$("#hai0").unbind('click').click(function () {
		    $("#hai1Info").hide();
		});

		$("#hai1").unbind('click').click(function () {
		    $("#hai1Info").show();
		});
		
		$("#linkWebAuth").unbind('click').click(function () {
		    $("#modalWebAuth").modal();
			return false;
		});

		$('#AuthVerify').unbind('change').on('change', function(){
			try{
				var filename = this.files[0].name;
				$('#txAuthVerifyFileName').val(filename);
			}catch(ex){
				alert('很抱歉，您的浏览器不支持上传');
			}
		});
		
		$(document).on("click", document.body, function (e) {
			var _this = $(e.target);
			if (_this.hasClass("resetAllWx")) {
				$('#ModalContent').html("<span class='sending'><img src='/images/loading1.gif'/>正在重置公众号...</span>");
				$.getJSON("/index.php?c=admin/weixin/wxconfig&a=ResetAll", null,
//				$.getJSON("/admin/weixin/wxconfig?act=ResetAll", null,
			   function (data) {
				   $(".modal-footer").hide();
				   if (data != null && data.success) {
					   $('#ModalContent').html("公众号重置成功！");
					   
					   document.location.reload(true);
				   } else {
					   $('#ModalContent').html("公众号重置失败！");
				   }
			   }, "json");
			}
		});
	}

	function openImageDialog() {
		top.YDM.FileManager('image', 1, function (aUrl) {
			$("#QRCode").val(aUrl);
			if ($("#QRImage").is("img")) {
				$("#QRImage").attr("src", aUrl);
			} else {
			    var img = $('<img id="QRImage" src="' + aUrl + '" style="width:180px;position:absolute;left:690px;top:170px;"/>');
				$("#AddImage").after(img);
			}
		});
	}
	
    function loadData() {
    	$.getJSON("/index.php?c=admin/weixin/wxconfig&a=getinfo", null, function (json) {
			if(json.domainlist){
				$("#slDomainName").children().remove();
				$("#slDomainName").append("<option value=''>--请选择--</option>");
				$('#slAuthDomainName').children().remove();
				$("#slAuthDomainName").append("<option value=''>--请选择--</option>");
				for(var i = 0;i < json.domainlist.length;i++){
				    $("#slDomainName").append("<option value='" + json.domainlist[i] + "'>" + json.domainlist[i] + "</option>");
				    $("#slAuthDomainName").append("<option value='" + json.domainlist[i] + "'>" + json.domainlist[i] + "</option>");
				}
			}
			
			if(json.info){
				ko.applyBindings(json.info,myroot);
				var domain = getDomain(document.domain);
				if(json.info.DomainName) domain = json.info.DomainName;
				$("#ApiUrl").html(["http://", domain, "/wxapi?InitSiteID=", json.info.SiteId, "&wxid=",json.info.WeiXinId].join(""));
				if (json.info.QRCImage) {
					var img = $('<img id="QRImage" src="' + json.info.QRCImage + '" style="width:180px;position:absolute;left:690px;top:170px;"/>');
					$("#AddImage").after(img);
				}
				if (json.info.WeiXinId) {
					$("#WeiXinId").prop("readonly",true);
				}
				if(/^demo/.test(json.info.WeiXinId)){ //如果微信ID是以demo开头，说明是从模板复制出来的，要处理下
					$("#WeiXinId").val('');
					$("#WeiXinId").prop("readonly",false);
					$("#ApiUrl").html('');
				}
				if(json.info.WxType != 3)
				{
					$("#haiTr").show();
					if(json.info.HideAuthorizeInfo == 1)
					{
						$("#hai0").attr("checked", false);
						$("#hai1").attr("checked", true);
						$("#hai1Info").show();
					}
				}
				$("#slDomainName").val(json.info.DomainName);
				console.log(json.info.DomainName);
				$("#slAuthDomainName").val(json.info.AuthDomainName);
				if(json.info.AuthVerify){
					$("#AuthVerifyTips").html("<font color='red'>您之前已经上传了验证文件 "+json.info.AuthVerify+"，如需更新验证文件请再次上传，否则请忽略</font>");
				}
			}
		});
    }

    function submitForm() {
		if($("#slDomainName").val() == ''){
			alert('请选择微信绑定的接口域名');
			return false;
		}
		if ($("#slDomainName").val().indexOf(".yz168.cc")>-1 && !getCookie('said')) {
			var dialog = bootbox.dialog({
	            title: '危险提示',
	            message: '<p style="color: red;margin:20px;text-align: center;font-size:18px">接口域名不要选择我司二级域名，否则微信公众号—基本配置信息提交会出现以下提示：</p><div style="width: 523px;margin: 0 auto;"> <img src="/images/domaintips.png" alt="" /></div><p style="color: red;margin:20px;text-align: center;font-size:25px">建议绑定自己的域名</p>',
	            buttons: {
	                close1: {
	                    label: "我知道了",
	                    className: "btn-default",
	                    callback: function () {
	                        $(this).modal('hide');
	                        $("#slDomainName").val('');
	                    }
	                }
	              
	            }
	        });
		}else{
			save ();
		}
    }

    function save () {
		var params = $('#WxConfForm').serializeObject();
		/*
        $.post("/index.php?c=admin/weixin/wxconfig&a=edit", params, function (data, textStatus, jqXHR) {
			if(data.success){
			    $.showResult(true, "微信配置保存成功", 2000, function () {
			        loadData();
			    });
			}else{
			    $.showResult(false, data.msg);
			}
		},"json");*/
		$.ajaxFileUpload
		(
			{
				url: '/index.php?c=admin/weixin/wxconfig&a=edit', //用于文件上传的服务器端请求地址
				secureuri: false, //是否需要安全协议，一般设置为false
				fileElementId: 'AuthVerify', //文件上传域的ID
				dataType: 'json', //返回值类型 一般设置为json
				data: params,
				success: function (json, status)
				{
				    if (json.success) {
				        $.showResult(true, "微信配置保存成功", 2000, function () {
							loadData();
						});
				    } else {
				        $.showResult(false, json.msg);
				    }
				},
				error: function (data, status, e)
				{
					console.log(e);
					alert(e);
				}
			}
		);
    }
    me.addListener('wxconfig', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['wxgroupsend'] = function () {

    var me = this;
	
	//加载素材信息的页数
    var pageCount = 0;
    var curPage = 1;
    var pSize = 10;

	var GroupModel = function () {
        self = this;
        self.GroupList = ko.observableArray([]);
        self.LoadGroup = function () {
          //  $.post("/admin/weixin/wxgroupsend", { "action": "load"},
        	$.post("/index.php?c=admin/weixin/wxgroupsend&a=index", { "action": "load"},
               function (data) {
                   console.log(data);
                   if (data != null) {
                       if (data.success) {
                           self.GroupList(data.list);
                       }
                   }
               }, "json");
        };
        self.LoadGroup();
    }

	var myroot = null;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixinpackage/html/wxgroupsend.html", function () {
            me.execCommand('initContentNav', root);
			myroot = root[0];
			ko.applyBindings(new GroupModel(),myroot);
			curPage = 1;
			bindUIEvent();
		});
    }
	
	function bindUIEvent(){
	    $(document).off("click.iuuyy").on("click.iuuyy", document.body, function (e) {
			var _this = $(e.target);
			if (_this.hasClass("PageNav")) {
				curPage = parseInt(_this.attr("data-value"));
				MessageList();
				e.preventDefault();
			};
			if (_this.hasClass('sendmessage')) {
				if ("text" == $("#MessageType").val().toLowerCase()) {
					$("#EventData").val($("#msgText").val());
				}
				if ($("#EventData").val() != "") {
					GrpuSend();
				} else {
					$(".error").removeClass('none');
				}
				e.preventDefault();
			}
			if (_this.hasClass('wxGroup')) {
				$("#GroupId").val(_this.attr("data-gid"))
				$("#GroupText").text(_this.attr("data-name"));
				e.preventDefault();
			}
			if (_this.hasClass('sex')) {
				$("#SexText").text(_this.text());
				$("#Sex").val(_this.attr("data-value"));
				e.preventDefault();
			}
		});

		$(document).on("click", "#container>dl", function (e) {
			$("#container>dl").removeClass("selected");
			$(this).addClass("selected");
		});

		$(function () {
			$("#WxTabs").tabs();
			$("#WxTabs").on("tabsactivate", function (event, ui) {
				$("#MessageType").val(ui.newTab.attr("data-value"));
			});
			$(".SelectNews").click(function (e) {
				var msgType = $("#MessageType").val();
				if ("image" == msgType.toLowerCase()) {
					YDM.FileManager('image', 1, function (aUrl) {
						$("#EventData").val(aUrl);
						this.tar = $("#" + msgType);
						this.tar.children(".Content").append('<img src="' + aUrl + '"/>');
						this.tar.children(".BeginNews").hide();
					});
				} else {
					BindDialog(this.msgType);
				}
			});
		});
	}

	function BindDialog(val) {
        if (val !== "TEXT") {
            $('<div id="dialog" class="none"><div id="container"></div></div>').dialog({
                modal: true, width: 750, height: 560, position: { my: "center", at: "center", of: window },
                resizable: false,
                open: function () {
                    MessageList();
                },
                buttons: {
                    "确定": function () {
                        this.messageType = $("#MessageType").val()
                        this.eventData = $(".selected").attr("data-value")
                        $("#EventData").val(this.eventData);

                        //BeginNews
                        this.tar = $("#" + this.messageType);
                        this.tar.children(".Content").append($(".selected").clone().removeAttr('style'));
                        this.tar.children(".BeginNews").hide();

                        $(this).dialog("close");
                    },
                    "取消": function () { $(this).dialog("close"); }
                },
                close: function (event, ui) {
                    $("#container").empty();
                    $(".PageDiv").remove();
                    $("#dialog").dialog("destroy");
                    $("#dialog").remove();
                }
            });
        }
    }

    var MessageList = function () {
		$.getJSON('/index.php?c=admin/weixin/wxmenu', { a: "LoadData", page: curPage,size: pSize, t: $("#MessageType").val() },
        function (data) {
            if (typeof (data) == "object" && data != null && data.success) {
                pageCount = data.Count;
                var dl = [];
                $.each(data.list, function (j, m) {
                    dl.push(MessageRender(jQuery.parseJSON(m.JsonContent), m.Nid));
                });
                $("#container").html(dl.join(''));

                if (!$(".ui-dialog-buttonpane").children().eq(0).hasClass("PageDiv")) {
                    this.page = ['<div class="PageDiv">'];
                    this.page.push('<ul class="pagination">');
                    for (var i = 0; i < pageCount; i++) {
                        var page = i + 1;
                        this.page.push('<li><a href="#" class="PageNav" data-value="', page, '">', page, '</a></li>');
                    }
                    this.page.push('</ul>');
                    this.page.push('</div>');
                    $(".ui-dialog-buttonpane").prepend(this.page.join(''));
                }
                setTimeout(function () {
                    $("#dialog>#container").masonry({
                        itemSelector: '.News_Content'
                    });
                }, 500);
            }
        });
    };

	function GrpuSend() {
        console.log($("#f1").serialize().toString());
        $.ajax({
            type: "POST",
       //     url: "/admin/weixin/wxgroupsend",
            url:"/index.php?c=admin/weixin/wxgroupsend",
            beforeSend: function () {
                $('#ModalContent').html("<span class='sending'><img src='/images/loading1.gif'/>正在发送信息!</span>");
                $('#myModal').modal();
            },
            data: $("#f1").serialize().toString() + "&action=send",
            dataType: "json",
            success: function (data) {
                console.log(data);
                if (data !== null) {
                    if (data.success) {
                        $('#ModalContent').html(data.message);
                        $(".Content").empty();
                        $(".BeginNews").show();
                        setTimeout(function () {
                            $('#myModal').modal('hide');
                            f1.reset();
                            $("#GroupText").text("全部用户");
                            $("#SexText").text("全部");
                            $("#WxTabs").tabs("option", "active", 0);
                        }, 1000);
                    } else {
                        $('#ModalContent').html(data.msg);
                    }
                } else {
                    $('#ModalContent').html("服务器没有返回！");
                }
            }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
                $('#ModalContent').html("发送失败");
            }
        });
    }

    function MessageRender(list, val) {
        var dl = ['<dl class="News_Content" data-value="', val, '">'];
        $.each(list, function (i, n) {
            if (i) {
                dl.push('<dd class="dd" data-val="', i, '"><p><a></a><i class="fa fa-edit"></i><b class="fa fa-remove"></b></p>');
                dl.push('<label><b class="title', i, '">', n.Title, '</b></label>')
                dl.push('<span class="ImgID', i, '"><b>缩略图</b><img src="', n.PicUrl, '"/></span>');
                dl.push('</dd>');
            } else {
                dl.push('<dd class="dt" data-val="', i, '">');
                dl.push('<p><a></a><i class="fa fa-edit"></i></p>');
                dl.push('<span id="BigImg" class="ImgID', i, '"><b>封面图片</b><img src="', n.PicUrl, '"/></span>');
                dl.push('<label>');
                dl.push('<i></i>');
                dl.push('<b class="title', i, '">', n.Title, '</b>');
                dl.push('</label>');
                dl.push('</dd>');
            }
        });
        dl.push('<dt><p></p><i class="fa fa-check"></i></dt>');
        dl.push('</dl>');
        return dl.join("");
    }

    me.addListener('wxgroupsend', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['wxkeyword'] = function () {

    var me = this;

    //加载素材信息的页数
    var pageCount = 0;
    var curPage = 1;
    var pSize = 10;
    //每页显示记录数
    var rcSize = 10;
    //当前页
    var kocurPage = 1;
    //导航页数
    var pageSize = 10;

    var msgModel = function () {
        var self = this;
        self.keyword = null;
        self.messageList = ko.observableArray([]);
        self.LoadMessage = function (page) {
            $.ajax({
                type: "POST",
//                url: "admin/weixin/wxkeyword",
                url: "/index.php?c=admin/weixin/weixinkeyword",
                async: true,
                cache: false,
                dataType: "json",
                data: { action: "load", page: page, size: rcSize },
                success: function (data) {
                    console.log(data);
                    if (data != null && data.success) {
                        self.messageList(data.list);
                        kocurPage = page;
                        if (data.Count > 1) {
                            $("#pagination").pageNav(kocurPage, data.Count, 10, function (ipage) { self.LoadMessage(ipage); });
                            $("#pagination").show();
                        } else $("#pagination").hide();
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
        self.loadKeyWord = function (key) {
            console.log(key);
            LoadContent(key.Kid);
            ko.applyBindings(key, document.getElementById("f1"));
        };
        self.delKeyWord = function (key) {
            $.ajax({
                type: "POST",
//                url: "admin/weixin/wxkeyword",
                url: "/index.php?c=admin/weixin/weixinkeyword",
                cache: false,
                beforeSend: function (XMLHttpRequest) {
                    $('#ModalContent').html("<span class='sending'><img src='/images/loading1.gif'/>正在删除关键词信息!</span>");
                    $('#myModal').modal();
                },
                dataType: "json",
                data: { action: 'delete', kid: key.Kid },
                success: function (data) {
                    if (data != null) {
                        if (data.success) {
                            $('#ModalContent').html("关键词信息已经删除！");
                            setTimeout(function () { self.LoadMessage(kocurPage); $('#myModal').modal('hide'); }, 1000);
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $('#ModalContent').html("系统错误！");
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
    };

    var m = new msgModel();
    var myroot = null;
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixinpackage/html/wxkeyword.html", function () {
            kocurPage = 1;
            curPage = 1;
            myroot = root[0];
            ko.applyBindings(m, document.getElementById('dataList'));
            m.LoadMessage(1);
            bindUIEvent();
            me.execCommand('initContentNav', root);
        });
    }

    function bindUIEvent() {
        $('#f1').validate({
            rules: {
                KeyWords: "required"
                , EventData: "required"
            },
            messages: {
                KeyWords: "请输入关键词！"
                , EventData: "请输入或选择内容！"
            },
            ignore: "",
            errorLabelContainer: $('.errorContainer'),
            submitHandler: function (form) {
                Save();
                return false;
            }
        });

        $(document).on("click", document.body, function (e) {
            var _this = $(e.target);
            if (_this.hasClass("PageNav")) {
                curPage = parseInt(_this.attr("data-value"));
                MessageList();
                e.preventDefault();
            };
            if (_this.hasClass("delKey")) {
                $(".Content").html("");
                $(".BeginNews").show();
                EditDialog();
                e.preventDefault();
            }
        });
        $(".goAdd").off("click").on("click", function (e) {
            e.preventDefault();
            $(".ui-dialog").remove();
            me.execCommand('go', { a: $(this).attr("data-a"), b: $(this).attr("data-b") });
        });
        $(document).on("click", "#container>dl", function (e) {
            $("#container>dl").removeClass("selected");
            $(this).addClass("selected");
        });

        $(".BoxTitle").tabs({ active: 2 });
        $(".BoxTitle").on("tabsactivate", function (event, ui) {
            var act = $(".BoxTitle").tabs("option", "active");
            if (2 != act) {
                //document.location = 'autoreply.aspx#' + $(".BoxTitle").tabs("option", "active");
                me.execCommand('go', { a: "weixin", b: "wxreply", params: { tab: $(".BoxTitle").tabs("option", "active") } });
            }
        });
        $("#WxTabs").tabs();
        $("#WxTabs").on("tabsactivate", function (event, ui) {
            var mt = ui.newTab.attr("data-value");
            $("#MessageType").val(mt);
            if(mt=='LBS')
            	$("#EventData").val('lbs');
        });

        $("#addKey").click(function () {
            $("#WxTabs").tabs("option", "active", 0);
            $(".Content").empty();
            f1.reset();
            EditDialog();
        });

        $(".SelectNews").click(function (e) {
            var msgType = $("#MessageType").val();
            if ($(this).closest("div").attr("data-value")) {
                msgType = $(this).closest("div").attr("data-value");
                $("#MessageType").val(msgType);
            }
            if ("image" == msgType.toLowerCase()) {
                YDM.FileManager('image', 1, function (aUrl) {
                    $("#EventData").val(aUrl);
                    this.tar = $("#" + msgType);
                    $(".Content").empty();
                    this.tar.children(".Content").html('<img src="' + aUrl + '"/>');
                    this.tar.children(".BeginNews").hide();
                });
            } else {
                BindDialog(msgType);
            }
        });
    }

    function EditDialog() {
        $("#f1").dialog({
            modal: true, width: 750, height: 700, position: { my: "center", at: "center", of: window },
            resizable: false,
            buttons: {
                "确定": function () {
                    if ("text" == $("#MessageType").val().toLowerCase()) {
                        $("#EventData").val($("#msgText").val());
                    }
                    f1.SubSave.click();
                },
                "取消": function () { $(this).dialog("close"); }
            },
            close: function (event, ui) {
                $(this).dialog("destroy");
            }
        });
    }

    function BindDialog(val) {
        if (val !== "TEXT") {

            $('<div id="dialog" class="none"><div id="container"></div></div>').dialog({
                modal: true, width: 750, height: 560, position: { my: "center", at: "center", of: window },
                resizable: false,
                open: function () {
                    MessageList();
                },
                buttons: {
                    "确定": function () {
                        this.messageType = $("#MessageType").val();
                        this.eventData = $(".selected").attr("data-value");
                        console.log(this.eventData);
                        $("#EventData").val(this.eventData);
                        $(".Content").empty();
                        //BeginNews
                        if (this.messageType == "RESERVE" || this.messageType == "RESEARCH" || this.messageType == "WALL" || this.messageType == "GALLERY" || this.messageType == "VOTE" || this.messageType == "SIGNIN" || this.messageType == "SHAREPOWER" || this.messageType == "REDPACK" || this.messageType == "PACKMERGE" || this.messageType == "DISCOUNT" || this.messageType == "COUPON" ||this.messageType == "INDIANA") {
                            this.tar = $("#PARTY");
                            this.tar.children(".Content").html($(".selected").clone().removeAttr('style'));
                            this.tar.children(".BeginNews").hide();
                        } else {
                            this.tar = $("#" + this.messageType);
                            this.tar.children(".Content").html($(".selected").clone().removeAttr('style'));
                            this.tar.children(".BeginNews").hide();
                        }

                        $(this).dialog("close");
                    },
                    "取消": function () { $(this).dialog("close"); }
                },
                close: function (event, ui) {
                    $("#container").empty();
                    $(".PageDiv").remove();
                    $("#dialog").dialog("destroy");
                    $("#dialog").remove();
                }
            });
        }
    }

    var MessageList = function () {
        console.log($("#MessageType").val());
//        $.getJSON('/admin/weixin/WxMenu', { act: "LoadData", page: curPage, size: pSize, t: $("#MessageType").val() },
        $.getJSON('/index.php?c=admin/weixin/Wxmenu', { a: "LoadData", page: curPage, size: pSize, t: $("#MessageType").val() },
        function (data) {
            console.log(data);
            if (data && data.success) {
                pageCount = data.Count;
                var dl = [];
                $.each(data.list, function (j, m) {
                	console.log(jQuery.parseJSON(m.JsonContent));
                    dl.push(MessageRender(jQuery.parseJSON(m.JsonContent), m.Nid));
                });
                $("#container").html(dl.join(''));

                if (!$(".ui-dialog-buttonpane").children().eq(0).hasClass("PageDiv")) {
                    this.page = ['<div class="PageDiv">'];
                    this.page.push('<ul class="pagination">');
                    for (var i = 0; i < pageCount; i++) {
                        var page = i + 1;
                        this.page.push('<li><a href="#" class="PageNav" data-value="', page, '">', page, '</a></li>');
                    }
                    this.page.push('</ul>');
                    this.page.push('</div>');
                    $(".ui-dialog-buttonpane").prepend(this.page.join(''));
                }
                setTimeout(function () {
                    $("#dialog>#container").masonry({
                        itemSelector: '.News_Content'
                    });
                }, 500);
            }
        });
    };

    function Save() {
        console.log($("#f1").serialize().toString());
        $.ajax({
            type: "POST",
//            url: "admin/weixin/wxkeyword",
            url: "/index.php?c=admin/weixin/weixinkeyword",
            beforeSend: function () {
                $('#ModalContent').html("<span class='sending'><img src='/images/loading1.gif'/>正在保存信息!</span>");
                $('#myModal').modal();
            },
            data: $("#f1").serialize().toString() + "&action=save",
            dataType: "json",
            success: function (data) {
                console.log(data);
                if (data !== null) {
                    if (data.success) {
                        $("#f1").dialog("close");
                        $('#ModalContent').html("信息保存成功！");
                        setTimeout(function () {
                            $('#myModal').modal('hide');
                            f1.reset();
                            $("#WxTabs").tabs("option", "active", 0);
                            $(".Content").empty();
                            $(".BeginNews").show();
                            m.LoadMessage(kocurPage);
                        }, 1000);
                    } else {
                        $('#ModalContent').html(data.msg);
                    }
                } else {
                    $('#ModalContent').html("服务器没有返回！");
                }
            }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    };

    function MessageRender(list, val) {
        var dl = ['<dl class="News_Content" data-value="', val, '">'];
        $.each(list, function (i, n) {
            if (i) {
                dl.push('<dd class="dd" data-val="', i, '"><p><a></a><i class="fa fa-edit"></i><b class="fa fa-remove"></b></p>');
                dl.push('<label><b class="title', i, '">', n.Title, '</b></label>')
                dl.push('<span class="ImgID', i, '"><b>缩略图</b><img src="', n.PicUrl, '"/></span>');
                dl.push('</dd>');
            } else {
                dl.push('<dd class="dt" data-val="', i, '">');
                dl.push('<p><a></a><i class="fa fa-edit"></i></p>');
                dl.push('<span id="BigImg" class="ImgID', i, '"><b>封面图片</b><img src="', n.PicUrl, '"/></span>');
                dl.push('<label>');
                dl.push('<i></i>');
                dl.push('<b class="title', i, '">', n.Title, '</b>');
                dl.push('</label>');
                dl.push('</dd>');
            }
        });
        dl.push('<dt><p></p><i class="fa fa-check"></i></dt>');
        dl.push('</dl>');
        return dl.join("");
    }

    function LoadContent(kid) {
        $.ajax({
            type: "POST",
//            url: "admin/weixin/wxkeyword",
            url: "/index.php?c=admin/weixin/weixinkeyword",
            data: { action: 'getkeyword', kid: kid },
            dataType: "json",
            success: function (data) {
                if (data != null) {
                    if (data.success) {
                        this.tar = $("#" + data.msgType);
                        $("#MessageType").val(data.msgType);
                        switch (data.msgType.toUpperCase()) {
                            case "TEXT": {
                                $("#WxTabs").tabs("option", "active", 0);
                                break;
                            }
                            case "IMAGE": {
                                $("#WxTabs").tabs("option", "active", 2);
                                this.img = '<div><img src="' + $("#EventData").val() + '" style="max-width:500px;"/></div>';
                                this.tar.children(".Content").html(this.img);
                                this.tar.children(".BeginNews").hide();
                                break;
                            }
                            case "NEWS": {
                                $("#WxTabs").tabs("option", "active", 1);
                                this.tar.children(".Content").html(MessageRender(data.list));
                                this.tar.children(".BeginNews").hide();
                                break;
                            }
                            case "PRODUCT": {
                                $("#WxTabs").tabs("option", "active", 3);
                                this.tar.children(".Content").html(MessageRender(data.list));
                                this.tar.children(".BeginNews").hide();
                                break;
                            }
                            case "DISCOUNT":
                            case "PACKMERGE":
                            case "REDPACK":
                            case "VOTE":
                            case "SIGNIN":
                            case "SHAREPOWER":
                            case "RESEARCH":
                            case "WALL":
                            case "GALLERY":
							case "COUPON":
							case "INDIANA":
                            case "RESERVE": {
                                $("#WxTabs").tabs("option", "active", 4);
                                $("#PARTY").children(".Content").html(MessageRender(data.list));
                                $("#PARTY").children(".BeginNews").hide();
                                $("#MessageType").val(data.msgType); //因为重用了PARTY的tab，当激活tab时设置又会自动设置一下#MessageType,所以这里要重设置一次
                                break;
                            }
                            case "PARTY": {
                                $("#WxTabs").tabs("option", "active", 4);
                                $("#" + data.msgType).children(".Content").html(MessageRender(data.list));
                                $("#" + data.msgType).children(".BeginNews").hide();
                                break;
                            }
                            case "LBS": {
                            	 $("#WxTabs").tabs("option", "active", 5);
                            	break;
                            }
                            
                        }
                    } else {
                        $('#ModalContent').html(data.msg);
                        $('#myModal').modal();
                    }
                } else {
                    $('#ModalContent').html("服务器没有返回数据！");
                    $('#myModal').modal();
                }
            }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    }

    me.addListener('wxkeyword', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['wxmenu'] = function () {

    var me = this;

    var myroot = null;
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixinpackage/html/wxmenu.html?rand=" + Math.random(), function () {
            me.execCommand('initContentNav', root);
            myroot = root[0];
            bindUIEvent();
			loadWxConfig();
            loadMenu();
        });
    }
	
	var wxconfig = null;
	function loadWxConfig(){
//		$.ajax({ url: "/admin/weixin/wxconfig?act=getinfo", async: false, dataType: "json", success: function (json) {
		$.ajax({ url: "/index.php?c=admin/weixin/wxconfig&a=getinfo", async: false, dataType: "json", success: function (json) {		
				if(json.info){
					wxconfig = json.info;
				}
			}
		});
	}

    function bindUIEvent() {
        $("#msgText").blur(function () {
            $("#EventData").val($(this).val());
            Save("SaveMenu");
        });
        $("#wxmenumain").unbind();
        $(document).off('click.wxmenu focusin.wxmenu').on("click.wxmenu focusin.wxmenu", function (e) {
            var _this = $(e.target);
            if (_this.attr("id") && e.type == 'click' && "getlink" == _this.attr("id").toLowerCase()) {
                top.YDM.LinkSelector($("#gotoLink").val(), function (url) {
                    if (/^(http:|https:)/.test(url) == false) {
						var domain = getDomain();
						if(wxconfig && wxconfig.DomainName) domain = wxconfig.DomainName;
                        url = "http://" + domain + url;
                    }
                    $("#gotoLink").val(url);
                    $("#gotoLink").trigger("change");
                }, null, { rewrite: 0 });
           	 $("#MType").val("view");
                e.stopPropagation();
            }
            if (_this.hasClass("PageNav")) {
                curPage = parseInt(_this.attr("data-value"));
                MessageList();
            }
            if (_this.hasClass("syslink")) {
                $("#gotoLink").val(_this.attr("data-url"));
                $("#EventData").val(_this.attr("data-url"));
                $("#MType").val("view");
                $("#MessageType").val("LINK");
                $(".UrlBox").hide();
                Save("SaveMenu");
                e.stopPropagation();
            }
            if (_this.hasClass("resetnews")) {
                $(".WxMenuEvent").hide();
                $("#WxType").show();
             //   Save("ResetMenu");
                e.preventDefault();
            }
            if (_this.hasClass("addSubMenu")) {
                $("#Default").hide();
                AddMenu(_this, 1);
            }
            if (_this.hasClass("editMenu")) {
                $("#Default").hide();
                AddMenu(_this, 2);
            }
            if (_this.hasClass("delMenu")) {
                $("#Default").hide();
                DeleteMenu(_this);
            }
            if (_this.hasClass("LoadMenu")) {
                $("#Default").hide();
                $("#MContent").hide();
                var val = _this.parent().attr("value");
                $("#MenuID").val(val);

                $(".mt").removeClass("back");
                _this.parent().addClass("back");
                this.subLength = _this.parent().next("ul").children("li").length;
                if (_this.parent().next().children().eq(0).is("li")) {
                    $(".WxMenuEvent").hide();
                    $("#note").show();
                    if (this.subLength < 5) {
                        $("#subCoun").show();
                        $("#isFull").hide();
                        $("#subCoun>h3>span").html(5 - this.subLength);
                    } else {
                        $("#subCoun").hide();
                        $("#isFull").show();
                    }
                } else {
                    LoadContent(val);
                }
                if (_this.parent().is("li")) {
                    $("#WxType>.WxType>.AddMenu").hide();
                    $("#WxType>.WxType").css({ "width": "370px", "margin": "50px auto", "float": "none" });
                } else {
                    $("#WxType>.WxType").css("width", "550px");
                    $("#WxType>.WxType>.AddMenu").show();
                }
            }
            if (_this.hasClass("DelCurNews")) {
                _this.parent().prev(".BeginNews").show();
                _this.parent().hide().empty();
            }
            if (_this.hasClass("glyphicon-arrow-up")) {
                var box = _this.parent().parent();
                var childs = null;
                if (box.is("label")) {
                    box = box.parent();
                }
                if (box.prev() && (box.prev().is("dd") || box.prev().is("li"))) {
                    box.after(box.prev());
                    if (box.is("li")) {
                        childs = box.parent().children();
                    } else {
                        childs = box.parent().children("dd");
                    }
                    AjaxSort(childs);
                }
            }
            if (_this.hasClass("glyphicon-arrow-down")) {
                var box = _this.parent().parent();
                var childs = null;
                if (box.is("label")) {
                    box = box.parent();
                }
                if (box.next() && (box.next().is("dd") || box.next().is("li"))) {
                    box.before(box.next());
                    if (box.is("li")) {
                        childs = box.parent().children();
                    } else {
                        childs = box.parent().children("dd");
                    }
                    AjaxSort(childs);
                }
            }

        });
        
        $("#wxmenumain").on("mouseover mouseout", ".mt", function (e) {
            if (e.type == "mouseover") {
                $(this).children(".ddtt").css("visibility", "visible");
                e.stopPropagation();
            }
            if (e.type == "mouseout") {
                $(this).children(".ddtt").css("visibility", "hidden");
                e.stopPropagation();
            }
        });
        $(document).off("click.wxmenu_datacontainer_dl").on("click.wxmenu_datacontainer_dl", "#datacontainer>dl", function (e) {
            $("#datacontainer>dl").removeClass("selected");
            $(this).addClass("selected");
            e.stopPropagation();
        });

        $("#gotoLink").on("change", function () {
            //避免与选择系链接的动作冲突，这里延时一下
            if (!$(this).val()) return;
            $("#EventData").val($(this).val());
            Save("SaveMenu");
        });

        $(".AddMenu").unbind().click(function () {
            if ($(".back").next("ul").children("li").length < 5) {
                AddMenu($(".back").find("i"), 1);
            } else {
                $('#ModalContent').html("当前的二级菜单最多只能为5个。");
                $('#myModal').modal();
            }
        });
        $(".SelectNews").unbind().click(function (e) {
            this.msgType = $("#MessageType").val();
            if ($(this).closest("div").attr("data-value")) {
                this.msgType = $(this).closest("div").attr("data-value");
                $("#MessageType").val(this.msgType);
            }
            if ("image" == this.msgType.toLowerCase()) {
                YDM.FileManager('image', 1, function (aUrl) {
                    $("#EventData").val(aUrl);
                    Save("SaveMenu");
                });
            } else {
                BindDialog(this.msgType);
            }
        });
        $("#WxTabs").off().on("tabsactivate", function (event, ui) {
            $("#MType").val("click");
            $("#MessageType").val(ui.newTab.attr("data-value"));
            //初始化分页参数
            pageCount = 0;
            curPage = 1;
            pSize = 10;
            if (ui.newPanel.children(".NContent").length == 0) {
                $("#EventData").val("");
            }
        });
        $("#btnQRCODE").unbind().click(function () {
            $("#EventData").val("QRCODE");
            Save("SaveMenu");
        });
        //定位保存
        $("#btnLBSMAP").unbind().click(function () {
            $("#EventData").val("LBSMAP");
            Save("SaveMenu");
        });
        $("#MContent").unbind().click(function () {
            $(this).hide();
            var mt = $("#MessageType").val().toUpperCase();
            var vContent = $(".WXContent").html();
            $(".WxMenuEvent").hide();
            if ("LINK" == mt) {
                $("#link").show();
                $("#gotoLink").val(vContent.replace(/(&amp;)/ig, '&'));
            }
            else {
                $("#WxTabs").tabs().show();
                if (mt == "TEXT") {
                    $("#msgText").val($("#EventData").val());
                } else {
                    vContent = '<div class="NContent">' + vContent + '<div class="DelCurNews">删除</div></div>';
                    //$("#" + mt).children(".NContent").remove();
                    $("#" + mt).append(vContent);
                    $("#" + mt + ">.BeginNews").hide();
                    switch (mt) {
                        case "NEWS": {
                            $("#WxTabs").tabs("option", "active", 1);
                            break;
                        }
                        case "IMAGE": {
                            $("#WxTabs").tabs("option", "active", 2);
                            break;
                        }
                        case "PRODUCT": {
                            $("#WxTabs").tabs("option", "active", 3);
                            break;
                        }
                        case "DISCOUNT":
                        case "PACKMERGE":
                        case "REDPACK":
                        case "SHAREPOWER":
                        case "SIGNIN":
                        case "VOTE":
                        case "RESERVE":
                        case "RESEARCH":
                        case "WALL":
                        case "GALLERY":
						case "COUPON":
						case "INDIANA":
                        case "PARTY": {
             //               $("#PARTY").append(vContent);
                            $("#PARTY>.BeginNews").hide();
                            $("#WxTabs").tabs("option", "active", 4);
                            break;
                        }
                        case "QRCODE": {
                            $("#WxTabs").tabs("option", "active", 5);
                            $(".NContent").remove();
                            break;
                        }
                        case "LBS" :{
                        	 $("#WxTabs").tabs("option", "active", 6);
                             break;
                        }
                    }
                }
            }
        });

        $(".news").unbind().click(function () {
            $(".WxMenuEvent").hide();
            $("#WxTabs").show().tabs();
            $("#WxTabs").tabs("option", "active", 0);
            //$("#NEWS").children(".NContent").remove();
            $("#WxTabs").find(".NContent").remove();
            $(".BeginNews").show();
            $("#MType").val("click");
            $("#MessageType").val("TEXT");
        });

        $(".urLink").unbind().click(function () {
            $(".WxMenuEvent").hide();
            $("#link").show();
            $('#gotoLink').val('');
            $("#MType").val("view");
            $("#MessageType").val("LINK");
        });

        $("#BtnPublishMenu").unbind().click(function () {
            PublishMenu();
            return false;
        });
    }
    function AjaxSort(elems) {
        var mus = [];
        $.each(elems, function (i, n) {
            mus.push({ OrderBy: i, mid: $(n).data('val') });
        });
        $.ajax({
            type: "POST",
            url:"/index.php?c=admin/weixin/wxmenu&a=SortMenu",
//            url: "/admin/weixin/WxMenu",
            cache: false,
            dataType: "json",
            data: { 'json': JSON.stringify(mus) },
//            data: { 'act': 'SortMenu', 'json': JSON.stringify(mus) },
            success: function (data) {
                if (data&&!data.success) {
                    $('#ModalContent').html("操作失败，请刷新页面重试！");
                    $('#myModal').modal();
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    }
    var pageCount = 0;
    var curPage = 1;
    var pSize = 10;
    function MessageRender(list, val) {
        var dl = ['<dl class="News_Content" data-value="', val, '">'];
        $.each(list, function (i, n) {
            if (i) {
                dl.push('<dd class="dd" data-val="', i, '"><p><a></a><i class="fa fa-edit"></i><b class="fa fa-remove"></b></p>');
                dl.push('<label><b class="title', i, '">', n.Title, '</b></label>')
                dl.push('<span class="ImgID', i, '"><b>缩略图</b><img src="', n.PicUrl, '"/></span>');
                dl.push('</dd>');
            } else {
                dl.push('<dd class="dt" data-val="', i, '">');
                dl.push('<p><a></a><i class="fa fa-edit"></i></p>');
                dl.push('<span id="BigImg" class="ImgID', i, '"><b>封面图片</b><img src="', n.PicUrl, '"/></span>');
                dl.push('<label>');
                dl.push('<i></i>');
                dl.push('<b class="title', i, '">', n.Title, '</b>');
                dl.push('</label>');
                dl.push('</dd>');
            }
        });
        dl.push('<dt><p></p><i class="fa fa-check"></i></dt>');
        dl.push('</dl>');
        return dl.join("");
    }

    var MessageList = function () {
//        $.getJSON("/admin/weixin/wxmenu", { act: "LoadData", page: curPage, size: pSize, t: $("#MessageType").val() },
    	$.getJSON("/index.php?c=admin/weixin/wxmenu", { a: "LoadData", page: curPage, size: pSize, t: $("#MessageType").val() },
		function (data) {
		    if (typeof (data) == "object" && data != null && data.success) {
		        pageCount = data.Count;
		        var dl = [];
		        $.each(data.list, function (j, m) {
		            dl.push(MessageRender(jQuery.parseJSON(m.JsonContent), m.Nid));
		        });
		        $("#datacontainer").html(dl.join(''));

		        if (!$(".ui-dialog-buttonpane").children().eq(0).hasClass("PageDiv")) {
		            this.page = ['<div class="PageDiv">'];
		            this.page.push('<ul class="pagination">');
		            for (var i = 0; i < pageCount; i++) {
		                var page = i + 1;
		                this.page.push('<li><a href="javascript:void(0)" class="PageNav" data-value="', page, '">', page, '</a></li>');
		            }
		            this.page.push('</ul>');
		            this.page.push('</div>');
		            $(".ui-dialog-buttonpane").prepend(this.page.join(''));
		        }
		        setTimeout(function () {
		            $("#dialog>#datacontainer").masonry({
		                itemSelector: '.News_Content'
		            });
		        }, 500);
		    }
		});
    };

    function loadMenu() {
        $.ajax({
            type: "POST",
            url: '/index.php?c=admin/weixin/wxmenu&a=LoadMenu',
//            url: '/admin/weixin/WxMenu',
            data: { act: "LoadMenu" },
            dataType: "json",
            success: function (data) {
                $.each(data, function (n, v) {
                    if (typeof (v) == "object") {
                        $.each(v, function (n1, v1) {
                            var nm = '<dd data-val="' + v1.mid + '"><label class="mt" value="' + v1.mid + '"><span class="LoadMenu">' + v1.name + '</span><tt class="ddtt"><i class="addSubMenu"></i><em class="editMenu"></em><b class="delMenu"></b><p class="glyphicon glyphicon-arrow-up"></p><q class="glyphicon glyphicon-arrow-down"></q></tt></label><ul>';
                            if (typeof (v1.sub_button) == "object") {
                                $.each(v1.sub_button, function (n2, v2) {
                                    nm += '<li class="mt" value="' + v2.mid + '" data-val="' + v2.mid + '"><span class="LoadMenu">' + v2.name + '</span><tt class="ddtt"><em class="editMenu"></em><b class="delMenu"></b><p class="glyphicon glyphicon-arrow-up"></p><q class="glyphicon glyphicon-arrow-down"></q></tt></li>';
                                });
                            }
                            nm += '</ul></dd>';
                            $(".WxMenu").append(nm);
                        });
                    }
                });

            }
        });
    }

    function BindDialog(val) {
        if (val !== "TEXT") {
            $('<div id="dialog" class="none"><div id="datacontainer"></div></div>').dialog({
                modal: true, width: 760, height: 560, position: { my: "center", at: "center", of: window },
                resizable: false,
                open: function () {
                    MessageList();
                },
                buttons: {
                    "确定": function () {
                        $("#EventData").val($(".selected").attr("data-value"));
                        Save("SaveMenu");
                        $(this).dialog("close");
                    },
                    "取消": function () {
                        $(this).dialog("close");
                    }
                },
                close: function (event, ui) {
                    $("#datacontainer").empty();
                    $(".PageDiv").remove();
                    $("#dialog").dialog("destroy");
                }
            });
        }
    }

    function LoadContent(value) {
        $(".WXContent").empty();
        /*if ("QRCODE" == $("#MessageType").val()) {
            $("#MContent").show();
            $(".WxMenuEvent").hide();
            $(".content_title>strong").html("订阅者点击该菜单会收到以下消息");
            $("#Content").show().children(".WXContent").html($("#QRCODE").clone());
            return;
        }**/

        $.ajax({
            type: "POST",
//            url: '/admin/weixin/WxMenu',
//            data: { act: "LoadEventData", n: value },
            url:'/index.php?c=admin/weixin/wxmenu&a=LoadEventData',
            data:{n:value},
            dataType: "json",
            success: function (data) {
                //console.log(data);
                if (data != null) {
                    if (data.success) {
                        $("#MContent").show();
                        $(".WxMenuEvent").hide();
                        $("#MessageType").val(data.msgtype);
                        $("#EventData").val(data.eventdata.replace(/(&amp;)/ig, '&'));
                        $("#MType").val(data.mtype);
                        $(".content_title>strong").html("订阅者点击该菜单会收到以下消息");

                        switch (data.msgtype.toUpperCase()) {
                            case "LINK": {
                                $(".content_title>strong").html("订阅者点击该菜单会跳到以下链接");
                                $("#Content").show().children(".WXContent").html(data.eventdata);
                                $("#MType").val('view');
                                break;
                            }
                            case "TEXT": {
                                $("#Content").show().children(".WXContent").html(data.eventdata);
                                $("#EventData").val(data.eventdata);
                                break;
                            }
                            case "IMAGE": {
                                this.img = '<div style="border:solid 1px #ddd;padding:10px;"><img src="' + data.eventdata + '" style="max-width:500px;"/></div>';
                                $("#Content").show().children(".WXContent").html(this.img);
                                break;
                            }
                            case "QRCODE": {
                                $("#Content").show().children(".WXContent").html("当前菜单应用了【<a href='#business.shopconfig'>分销二维码】");
                                break;
                            }
                            case "NEWS":
                           	 $("#Content").show().children(".WXContent").html(MessageRender(jQuery.parseJSON(data.list)));
                           	 break;
                            case "DISCOUNT":
                            case "PACKMERGE":
                            case "REDPACK":
                            case "SHAREPOWER":
                            case "SIGNIN":
                            case "VOTE":
                            case "PARTY":
                            case "RESERVE":
                            case "RESEARCH":
                            case "WALL":
                            case "GALLERY":
                            case "PRODUCT":
							case "COUPON":
					        case "ARTICLE":
							case "INDIANA":
								 $("#Content").show().children(".WXContent").html(MessageRender(data.list));
								 break;
							case "LBS":
								 $("#Content").show().children(".WXContent").html("当前菜单应用了lbs定位图文");
								break;
                    
                        }
                    } else {
                        $(".WxMenuEvent").hide();
                        $("#WxType").show();
                    }
                } else {
                    $('#ModalContent').html("服务器没有返回数据！");
                    $('#myModal').modal();
                }
            }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    }

    function DeleteMenu(getObj) {
        getObj = getObj.parent().parent();
        var pid = getObj.attr("value");
        $.ajax({
            type: "POST",
//            url: '/admin/weixin/WxMenu',
//            data: { act: "DeleteMenu", p: pid },
            url: '/index.php?c=admin/weixin/wxmenu&a=deletemenu',
            data: {p: pid },
            dataType: "json",
            success: function (data) {
                if (data !== null) {
                    if (data.success) {
                        if (getObj.is("li")) {
                            var ul=getObj.parent();
                            getObj.remove();
                            AjaxSort(ul.children("li"));
                        } else {
                            var dl = getObj.parent().parent();
                            getObj.parent().remove();
                            AjaxSort(dl.children("dd"));
                        }
                        $('#ModalContent').html("操作成功！");
                        $('#myModal').modal();
                    } else {
                        $('#ModalContent').html(data.error);
                        $('#myModal').modal();
                    }
                } else {
                    $('#ModalContent').html("服务器没有返回！");
                    $('#myModal').modal();
                }
            }
        });
    }

    //vt：1添加  2修改
    function AddMenu(getObj, vt) {
        var isSub = getObj.parent().parent().is("li");
        if (getObj.parent().is("dt")) {
            if ($(".mt").parents("dd").length >= 3) {
                $('#ModalContent').html("一级菜单最多只能为3个。");
                $('#myModal').modal();
                return;
            }
        }
        if (getObj.is("i")) {
            isSub = getObj.parent().is("tt");
            if (getObj.parent().parent().next("ul").children("li").length >= 5) {
                $('#ModalContent').html("当前的二级菜单最多只能为5个。");
                $('#myModal').modal();
                return;
            }
        }
        var obj = $('<div class="AddInput">一级菜单8个字符4个汉字，二级菜单20个字母10个汉字:<br/><div class="input-group"><span class="input-group-addon" id="basic-addon1">菜单名称</span><input type="text" class="form-control"  placeholder="菜单名称" aria-describedby="basic-addon1" name="mName" id="mName" value="' + (vt == 2 ? getObj.parent().parent().children("span").html() : '') + '"/></div><label class="error" for="mName" style="display:none;"></label></div>');
        $("body").append(obj);
        $(obj).dialog({
            modal: true, title:'菜单设置', width: 450, height: 'auto', position: { my: "center", at: "center", of: window },
            resizable: false,
            buttons: {
                "保存": function () {
                    if (Check($("#mName"), 1, isSub ? 20 : 8)) {
                        var val = $("#mName").val();
                        var box = getObj.parent().parent();
                        var pid = box.attr("value");
                        var orderby = 0;
                        if (box.is("label")) {
                            box = box.parent();
                            orderby= box.find("ul").children("li").length
                        } else {
                            orderby = box.children("dd").length;
                        }
                        //console.log(box);
                        //console.log(orderby);
                        $.ajax({
                            type: "POST",
//                            url: '/admin/weixin/WxMenu',
                            url: '/index.php?c=admin/weixin/wxmenu',
                            data: { "a": (vt == 1 ? "AddMenu" : "EditMenu"), "p": pid, "n": val,"orderby":orderby },
//                            data: { "act": (vt == 1 ? "AddMenu" : "EditMenu"), "p": pid, "n": val,"orderby":orderby },
                            dataType: "json",
                            success: function (data) {
                                if (data !== null) {
                                    if (data.success) {
                                        if (vt == 1) {
                                            $(".mt").removeClass("back");

                                            if (pid == 0) {
                                                var nm = $('<dd data-val="' + data.mid + '"><label class="mt back" value="' + data.mid + '"><span class="LoadMenu">' + val + '</span><tt class="ddtt"><i class="addSubMenu"></i><em class="editMenu"></em><b class="delMenu"></b><p class="glyphicon glyphicon-arrow-up"></p><q class="glyphicon glyphicon-arrow-down"></q></tt></label><ul></ul></dd>');
                                                box.append(nm);
                                                $("#WxType>.WxType").css("width", "550px");
                                                $("#WxType>.WxType>.AddMenu").show();
                                            } else {
                                                var nm = $('<li class="mt back" value="' + data.mid + '" data-val="'+data.mid+'"><span class="LoadMenu">' + val + '</span><tt class="ddtt"><em class="editMenu"></em><b class="delMenu"></b><p class="glyphicon glyphicon-arrow-up"></p><q class="glyphicon glyphicon-arrow-down"></q></tt></li>');
                                                box.find("ul").append(nm);
                                                $("#WxType>.WxType>.AddMenu").hide();
                                                $("#WxType>.WxType").css({ "width": "370px", "margin": "50px auto", "float": "none" });
                                            }

                                            $("#MenuID").val(data.mid);
                                            $(".WxMenuEvent").hide();
                                            $("#WxType").show();
                                        } else {
                                            getObj.parent().parent().children("span").html(val);
                                        }
                                    } else {
                                        $('#ModalContent').html(data.msg);
                                        $('#myModal').modal();
                                    }
                                } else {
                                    $('#ModalContent').html("服务器没有返回！");
                                    $('#myModal').modal();
                                }
                            }
                        });
                        $(this).dialog("close");
                    }
                },
                "取消": function () { $(this).dialog("close"); }
            },
            close: function (event, ui) {
                $(this).dialog("destroy").remove();
            }
        });
    }

    function Check(obj, min, max) {
        var val = obj.val();
        var oLen = 0// val.replace(/[a-zA-Z0-9\u4e00-\u9fa5]/g, "").length;
        if (oLen == 0) {
            var len = val.replace(/[^\u4e00-\u9fa5]/g, "").length * 2 + val.replace(/[\u4e00-\u9fa5]/g, "").length;
            if (len <= max && len >= min) {
                return true;
            } else {
                /*if ($("#mName").hasClass("error")) {
                    $('label[for="' + obj.attr("name") + '"]').html("菜单名字长度只能为" + max + "个字符(" + (max / 2) + "个中文)。");
                } else {
                    obj.addClass("error").after('<label class="error" for="mName">菜单名字长度只能为' + max + '个字符(' + (max / 2) + '个中文)。</label>');
                }*/
                $("label[for='mName']").text('菜单名字长度只能为' + max + '个字符(' + (max / 2) + '个中文)。').show();
                obj.focus();
                return false;
            }
        } else {
            /*if ($("#mName").hasClass("error")) {
                $('label[for="' + obj.attr("name") + '"]').html("菜单名字不能包含特殊字符。");
            } else {
                obj.addClass("error").after('<label class="error" for="mName">菜单名字不能包含特殊字符。</label>');
            }*/
            $("label[for='mName']").text('菜单名字不能包含特殊字符。').show();
            obj.focus();
            return false;
        }
    }

    function PublishMenu() {
        $.ajax({
//            type: "POST",
//            url: '/admin/weixin/WxMenu',
        	type:'GET',
            url:'/index.php?c=admin/weixin/wxmenu',
            beforeSend: function (XMLHttpRequest) {
                $('#ModalContent').html("<span class='sending'><img src='/images/loading1.gif'/>正在发布自定义菜单!</span>");
                $('#myModal').modal();
            },
//            data: { act: "PublishMenuPOST" },
            data:{a:'PublishMenu'},
            dataType: "json",
            success: function (data) {
                //console.log(data);
                if (data !== null) {
                    $('#ModalContent').html(data.msg);
                } else {
                    $('#ModalContent').html("服务器没有返回！");
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                $('#ModalContent').html(XMLHttpRequest.responseText);
            }
        });
    }

    function UrlListBox(o) {
        if ($(".UrlBox").is("div")) {
            $(".UrlBox").show();
            return;
        }

        var _box = $('<div class="UrlBox"><dl><dt><img src="/Images/loading1.gif" /></dt></dl></div>');
        o.after(_box);
        o.bind("focusout", function () { _box.remove(); });
        _box.hover(function () { o.unbind("focusout"); }, function () { $(this).remove(); });

        $.ajax({
            type: "POST",
            url: '/admin/weixin/WxNews',
            data: { "action": "menu" },
            dataType: "json",
            cache: false,
            success: function (data) {
                //console.log(data);
                if (data !== null) {
                    var arrDd = [];
                    $.each(data.list, function (i, n) {
                        arrDd.push('<dd class="syslink" data-url="', n.key, '">', n.value, '</dd>')
                    });
                    _box.children("dl").html(arrDd.join(""));
                } else {
                    $('#ModalContent').html("服务器没有返回！");
                    $('#myModal').modal();
                }
            },
            complete: function (XMLHttpRequest, textStatus) {
                _box.find("dt").remove();
            }
        });
    }

    function Save(action) {
        $.ajax({
            type: "POST",
//            url: '/admin/weixin/WxMenu',
//            data: $("#WxMenuForm").serialize().toString() + '&act=' + action,          
            url:'/index.php?c=admin/weixin/wxmenu&a='+action,
            data: $("#WxMenuForm").serialize().toString() ,          
            dataType: "json",
            success: function (data) {
                if (data !== null) {
                    if (data.success) {
                        LoadContent($("#MenuID").val());
                    }
                    $('#ModalContent').html(data.msg);
                    $('#myModal').modal();
                } else {
                    $('#ModalContent').html("服务器没有返回！");
                    $('#myModal').modal();
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert(XMLHttpRequest.responseText);
            }
        });
    }

    me.addListener('wxmenu', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['wxmsglist'] = function () {

    var me = this;

	//每页显示记录数
    var rcSize = 20;
    //当前页
    var curPage = 1;
    //导航页数
    var pageSize = 10;
        
    var msgModel = function () {
        var self = this;
        self.messageList = ko.observableArray([]);
        self.LoadMessage = function (page) {
            $.ajax({
                type: "POST",
                //url: "/admin/weixin/wxmsglist",
                url: "/index.php?c=admin/weixin/wxmsglist",
                async: true,
                cache: false,
                dataType: "json",
                data: { action: "load", page: page, size: rcSize },
                success: function (data) {
                    if (data != null && data.success) {
                        self.messageList(data.list);
                        curPage = page;
						if(data.Count > 1){
							$("#pagination").pageNav(curPage, data.Count, 10, function (ipage) { $("#ReBack").hide();$(document.body).append($("#ReBack")); self.LoadMessage(ipage); });
							$("#pagination").show();
						}else $("#pagination").hide();
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
    };
	
	var myroot = null;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixinpackage/html/wxmsglist.html?v=" + Math.random(),function() {
			curPage = 1;
			myroot = root[0];
			bindUIEvent();
			var m = new msgModel();
			ko.applyBindings(m,myroot);
			m.LoadMessage(curPage);
		});
    }
	
	function bindUIEvent(){
		$(document,$(myroot)).off('click').on("click", myroot, function (e) {
			_this = $(e.target);
			if (_this.hasClass("QuickBack")) {
				$("#BackText").val('');
				$("#OpenId").val('');
				this.tar = _this.parent().parent().parent();
				this.tar.append($("#ReBack"));
				$("#ReBack").show();
				$("input[name='OpenId']").val(_this.attr("data-val"));
			}
			if (_this.hasClass("send")) {
				var text = $("#BackText").val();
				var openid = $("#OpenId").val();
				console.log(text + ":" + openid);
				$.ajax({
					type: "POST",
//					url: "/admin/weixin/wxmsglist",
					url: "/index.php?c=admin/weixin/wxmsglist",
					cache: false,
					beforeSend: function (XMLHttpRequest) {
						$('#ModalContent').html("<span class='sending'><img src='/images/loading1.gif'/>正在发送信息!</span>");
						$('#myModal').modal();
					},
					dataType: "json",
					data: { action: 'send', openid: $("#OpenId").val(), text: $("#BackText").val() },
					success: function (data) {
						console.log(data);
						if (data != null && data.success) {
							$('#ModalContent').html("信息发送成功！");
							setTimeout(function () {
								$('#myModal').modal('hide');
								$("#ReBack").hide();
							}, 500);
						} else {
							$('#ModalContent').html("信息发送失败！" + data.msg);
						}
					},
					error: function (XMLHttpRequest, textStatus, errorThrown) {
					    //console.log(XMLHttpRequest.responseText);
					    $('#ModalContent').html(XMLHttpRequest.responseText);
					}, complete: function (XMLHttpRequest, textStatus) {
					    setTimeout(function () {
					        $('#myModal').modal('hide');
					    }, 3000);
					}
				});
			}
			if (_this.hasClass("retract")) {
				$("#BackText").val('');
				$("#OpenId").val('');
				$("#ReBack").hide();
			}
		});

		$('.msgList').off('mouseover.wxPic').on("mouseover.wxPic", '.wxPic', function (e) {
			var img = $(this);
			$("#divImgPreview").remove();
			var html = "<div id='divImgPreview' style='padding:5px;border:1px solid #cccccc;background:white;position:absolute;width:400px;height:400px;text-align:center;'>";
			html += "<img src='" + img.prop('src')  + "' style='max-width:100%;max-height:100%;'/>";
			html += "</div>";
			$("body").append(html);
			var top = img.offset().top;
			var left = img.offset().left + img.outerWidth();
			$("#divImgPreview").css({top:top,left:left});
		}).off('mouseout.wxPic').on("mouseout.wxPic", '.wxPic', function (e) {
			$("#divImgPreview").remove();
		});
	}

    me.addListener('wxmsglist', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['wxnews'] = function () {

    var me = this;
	
	var myroot = null;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixinpackage/html/wxnews.html",function() {
			myroot = root[0];
			bindUIEvent();
		});
    }
	
	var ue = null;
	function bindUIEvent() {
		//ue = UE.getEditor('Content', {
		//	toolbars: [[
		//		'bold', 'italic', 'underline','strikethrough','removeformat'
		//		, 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
		//		, 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify'
		//		, 'imagenone', 'imageleft', 'imageright', 'imagecenter'
		//	]]
		//});
		
	    ue = new baidu.editor.ui.Editor();

	    ue.render('Content');

		ue.addListener("blur", function () {
			if (this.hasContents()) {
				var vIndex = $("#ConIndex").val();
				$("#Content" + vIndex).val(this.getContent());
			}
		});
		ue.addListener("selectionchange", function () {
			if (this.hasContents()) {
				var vIndex = $("#ConIndex").val();
				$("#Content" + vIndex).val(this.getContent());
			}
		});

		$(document).on("click focusin", "body", function (e) {
			if ("link" == e.target.id.toLowerCase() || "Title" == e.target.id.toLowerCase()) {
				$("#error").hide();
			}
			if ("link" == e.target.id.toLowerCase()) {
				LuckShow($(e.target), $("#SysLink"),true);
			}
			if ($(e.target).parent().attr("id") && "syslink" == $(e.target).parent().attr("id").toLowerCase()) {
				this.url = $(e.target).attr("data-value");
				$("#Link").val(this.url);
				$(e.target).parent().hide();
				this.i = $("#ConIndex").val();
				$("#Link" + this.i).val(this.url);
			}
		});

		setTimeout(InitNewsLoad, 100);
        if ($("#SysLink").children().length == 0) {
            $.post("/admin/weixin/wxnews", { "action": "menu" },
//        	$.post("/index.php?c=admin/weixin/weixinnews", { "action": "menu" },
               function (data) {
                   if (!$.isEmptyObject(data) && data.success) {
                       var arrLi = [];
                       $.each(data.list, function (i, n) {
                           arrLi.push('<li data-value="', n.key, '">', n.value, '</li>');
                       });
                       $("#SysLink").html(arrLi.join(""));
                   }
               }, "json");
        }
        $("#btnSave").click(function () {
            if (CheckALL()) {
                SaveWxnews(false);
            }
        });
        $("#btnSavePreview").click(function () {
            if (CheckALL()) {
                SaveWxnews(true);
            }
        });

        if ($(".title0").height() > 30) {
            $(".title0").parent().children().css("height", "60px");
            $(".title0").parent().css({ "height": "60px" });
        }
        $("#Title").keypress(function () {
            titleChange($(this));
        }).keyup(function () { titleChange($(this)); }).blur(function () { titleChange($(this)); });
        $("#Description").keypress(function () {
            descrChange($(this));
        }).keyup(function () { descrChange($(this)); }).blur(function () { descrChange($(this)); });
        $("#Link").keypress(function () {
            linkChange($(this));
        }).keyup(function () { linkChange($(this)); }).blur(function () { linkChange($(this)); });

        $("#btnUpLoad").click(function () {
            $('#uploadFile').fileUploadStart();
        });
        $(".News_Content").children().each(function (i) {
            if ($(this).hasClass("add")) {
                $(this).click(function () { addMessage(); ClosePreviewInfo(); });
            } else {
                bindEvent($(this), i);
            }
        });

        $("#AddImage").click(function () {
            YDM.FileManager('image', 1, function (aUrl) {
                var vIndex = $("#ConIndex").val();
                $("#Image" + vIndex).val(aUrl);
                $(".ImgID" + vIndex).find('img').remove();
                $(".ImgID" + vIndex).prepend('<img src="' + aUrl + '"/>');

                var vImg = $('<img src="' + aUrl + '"/><tt>删除</tt>');
                vImg.filter("tt").click(function () { deleteImage(aUrl, vIndex); });
                if ($("#BackImg>dd").html() == null) {
                    var dd = $('<dd></dd>');
                    $("#BackImg").append(dd);
                    $("#BackImg>dd").html(vImg)
                } else {
                    $("#BackImg>dd").html(vImg)
                }
            });
        });

        $(".News_Preview_Btn").click(function () {
            ClosePreviewInfo();
        })
	}

	function ClosePreviewInfo()
	{
	    $(".News_Preview").hide();
	    $(".News_Preview_Btn").hide();
	    $("#f1").show();
	}

	function ShowPreviewInfo()
	{
	    $("#f1").hide();
	    $(".News_Preview").show();
	    $(".News_Preview_Btn").show();
	}

	function SaveWxnews(isPreview)
	{
	    $.ajax({
	        type: "POST",
//	        url: "/admin/weixin/wxnews",
	        url: "/index.php?c=admin/weixin/weixinnews",
	        data: $("#WxNewsForm").serialize().toString() + '&action=Save',
	        dataType: "json",
	        cache: false,
	        success: function (data) {
	            if (data !== null) {
	                if (data.success) {
	                    $('#ModalContent').html(data.msg);
	                    $('#myModal').modal();
	                    if ($('#nid').val() == '') $('#nid').val(data.Nid);
	                    setTimeout(function ()
	                    {
	                        $('#myModal').modal("hide");
                            //预览
	                        if (isPreview) 
	                        {
	                            ShowPreviewInfo();
	                            $.ajax({
	                                type: "POST",
//	                                url: "/admin/weixin/wxnews",
	                                url: "/index.php?c=admin/weixin/weixinnews",
	                                data: 'nid=' + data.Nid + '&action=preview',
	                                dataType: "json",
	                                cache: false,
	                                success: function (data) {
	                                    if (data !== null && data.data) {
	                                        var obj = jQuery.parseJSON(data.data);
	                                        var addHtml = "";
	                                        $.each(obj, function (index, item) {
	                                            var nidCur = item.Nid;
	                                            var linkCur = item.Link;
	                                            var titleCur = item.Title;
	                                            addHtml += "<span class='qrcode'><span>" + titleCur + "</span><img src='" + linkCur + "' /></span>";
	                                        });

	                                        $("#News_Qrcode").html(addHtml);
	                                    }
	                                }
	                            });
	                        }
                            //返回列表
	                        else setTimeout(function () { me.execCommand('go', { a: "weixin", b: "wxnewslist" }); }, 1000);
	                    }, 2000);
	                } else {
	                    $('#ModalContent').html(data.msg);
	                    $('#myModal').modal();
	                }
	            } else {
	                $('#ModalContent').html("服务器没有返回！");
	                $('#myModal').modal();
	            }
	        }, error: function (XMLHttpRequest, textStatus, errorThrown) {
	            console.log(XMLHttpRequest.responseText);
	        }
	    });
	}

	function LuckShow(tag,menu,up) {
        if (typeof (arguments[0]) == "object" && typeof (arguments[1]) == "object") {
            var o = arguments[0];
            var table = arguments[1];
            table.show();
            o.bind("focusout", function () { table.hide(); });
            table.hover(function () { o.unbind("focusout"); }, function () { $(this).hide(); });
            if (up) {
                this.height = table.height() + o.height()+10;
                table.css({ "margin-top": (-this.height) + "px" });
            }
        }
    }

	function titleChange(obj) {
        var vIndex = $("#ConIndex").val();
        var val = obj.val();
        $("#Title" + vIndex).val(val);
        $(".title" + vIndex).html(val);
        if ($(".title0").height() > 30) {
            $(".title0").parent().children().css("height", "60px");
            $(".title0").parent().css({ "height": "60px" });
        }
    }

    function descrChange(obj) {
        var vIndex = $("#ConIndex").val();
        var val = obj.val();
        $("#Description" + vIndex).val(val);
    }

    function ConChange(obj) {
        var vIndex = $("#ConIndex").val();
        var val = obj.val();
        $("#Content" + vIndex).val(val);
    }

    function linkChange(obj) {
        var vIndex = $("#ConIndex").val();
        var val = obj.val();
        var isTest = /^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(val);
        if (val !== "" && !isTest) {
            obj.addClass("error")
            $("#error").show().addClass("error").html("链接不合法！");
        } else {
            obj.removeClass("error");
            $("#error").hide();
        }
        $("#Link" + vIndex).val(val);
    }

    function deleteImage(vFile, vIndex) {
        $(".ImgID" + vIndex + ">img").remove();
        $("#Image" + vIndex).val("");
        $("#BackImg>dd").remove();
    }

    function addMessage() {
        var objConten = $(".News_Content");
        var vIndex = objConten.children().length - 1;
        if (vIndex < 8) {
            this.dd = ['<dd class="dd" data-val="', vIndex, '"><p><a></a><i class="fa fa-edit"></i><b class="fa fa-remove"></b></p>'];
            this.dd.push('<label><b class="title', vIndex, '"></b></label>')
            this.dd.push('<span class="ImgID', vIndex, '"><b>缩略图</b></span>');
            this.dd.push('<input type="hidden" id="Title', vIndex, '" class="CkTitle" name="Title', vIndex, '"/>');
            this.dd.push('<input type="hidden" id="Image', vIndex, '" name="Image', vIndex, '"/>');
            this.dd.push('<input type="hidden" id="Description', vIndex, '" name="Descr', vIndex, '"/>');
            this.dd.push('<input type="hidden" id="Content', vIndex, '" name="Content', vIndex, '"/>');
            this.dd.push('<input type="hidden" id="Link', vIndex, '" name="Link', vIndex, '" class="CkUrl"/>');
            this.dd.push('</dd>');
            var objVdd = $(this.dd.join(''));
            objConten.children().last().before(objVdd);
            bindEvent(objVdd);
        } else {
            $('#ModalContent').html('你最多只可以加入8条图文消息！');
            $('#myModal').modal();
        }
    }

    function CheckALL() {
        var r = true;
        var _msg = "";
        $(".CkTitle").each(function () {
            this.t = $(this).val();
            this.i = $(this).attr("id").replace(/[^\d]/ig, "");
            if (this.t == "") {
                r = false;
                _msg ="图文【"+this.i+ "】标题不能为空";
                return;
            }
            if (this.t.length > 64) {
                r = false;
                _msg = "图文【" + this.i + "】标题长度不能超过64字！";
                return;
            }
        });
        if (!r) {
            $("#error").show().addClass("error").html(_msg);
            return r;
        }
        $(".CkImage").each(function () {
            this.t = $(this).val();
            this.i = $(this).attr("id").replace(/[^\d]/ig, "");
            if (this.t == "") {
                r = false;
                _msg = "请上传图文【" + this.i + "】封面！";
                return;
            }
        });
        if (!r) {
            $("#error").show().addClass("error").html(_msg);
            return r;
        }
        $(".CkContent").each(function () {
            this.t = $(this).val();
            this.i = $(this).attr("id").replace(/[^\d]/ig, "");
            if (this.t == "") {
                r = false;
                _msg = "请输入图文【" + this.i + "】内容！";
                return;
            }
        });
        if (!r) {
            $("#error").show().addClass("error").html(_msg);
            return r;
        }
        $(".CkUrl").each(function () {
            var vUrl = $(this).val();
            this.i = $(this).attr("id").replace(/[^\d]/ig, "");
            if (vUrl != "") {
                r = /^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(vUrl);
                if (!r) {
                    _msg = "图文【" + this.i + "】链接不合法！";
                    return;
                }
            }
        });
        if (!r) {
            $("#error").show().addClass("error").html(_msg);
        }
        return r;
    }

    function bindEvent(obj) {
        var i = obj.attr("data-val");
        obj.mouseover(function () {
            $(this).children("p").css("visibility", "visible");
        }).mouseout(function () {
            $(this).children("p").css("visibility", "hidden");
        });
        obj.children("p").children("b").click(function () {
            obj.remove();
            var vDt = $(".News_Content>.dt");
            var offsetTop = vDt.height() / 2;
            $(".iLeft").css({ "margin-top": offsetTop + "px" });
            $(".News_Form").css({ "margin-top": "10px" });
            f1.reset();
            ue.execCommand('cleardoc');
            $("#BackImg>.dd").remove();
        });
        obj.children("p").children("i").click(function (e) {
            f1.reset();
            ue.execCommand('cleardoc');
            $("#ConIndex").val(i);
            var vTitle = $("#Title" + i).val();
            $("#Title").val(vTitle);
            var vImage = $("#Image" + i).val();
            var vDescr = $("#Description" + i).val();
            $("#Description").val(vDescr);
            var vLink = $("#Link" + i).val();
            $("#Link").val(vLink);
            this.ct = $("#Content" + i).val();
            ue.setContent(UE.utils.html(this.ct));

            if (vImage !== "") {
                var vImg = $('<img src="' + $("#Image" + i).val() + '"/><tt>删除</tt>');
                vImg.filter("tt").click(function () { deleteImage(vImage, i); });
                if ($("#BackImg>dd").html() == null) {
                    var dd = $('<dd></dd>');
                    $("#BackImg").append(dd);
                    $("#BackImg>dd").html(vImg)
                } else {
                    $("#BackImg>dd").html(vImg)
                }
            } else {
                $("#BackImg>dd").remove();
            }
            this.top = obj.offset().top;
            $(".News_Form").css("margin-top", (this.top - obj.parent().offset().top) + "px");
            ClosePreviewInfo();
        });
    }

    function InitNewsLoad() {
		if(!me.currentModule.params) return;
		if(!me.currentModule.params.nid) return;
        var nid = me.currentModule.params.nid;
        if (nid.length) {
            $("#nid").val(nid);
            $.ajax({
                type: "POST",
//                url: "/admin/weixin/wxnews",
                url: "/index.php?c=admin/weixin/weixinnews",
                async: true,
                cache: false,
                context: $(".News_Content"),
                dataType: "json",
                data: { action: 'get', val: nid },
                success: function (data) {
                    if (data != null && data.success) {
                        var dl = [];
                        $.each(data.list, function (i, n) {
                            if (i) {
                                dl.push('<dd class="dd" data-val="', i, '"><p><a></a><i class="fa fa-edit"></i><b class="fa fa-remove"></b></p>');
                                dl.push('<label><b class="title', i, '">', n.Title, '</b></label>')
                                dl.push('<span class="ImgID', i, '"><b>缩略图</b><img src="', n.PicUrl, '"/></span>');
                                dl.push('<input type="hidden" id="Title', i, '" class="CkTitle" name="Title', i, '" value="', n.Title, '"/>');
                                dl.push('<input type="hidden" id="Image', i, '" name="Image', i, '" value="', n.PicUrl, '"/>');
                                dl.push('<input type="hidden" id="Description', i, '" name="Description', i, '" value="', n.Description, '"/>');
                                dl.push('<input type="hidden" id="Content', i, '" name="Content', i, '" value="', n.Content, '"/>');
                                dl.push('<input type="hidden" id="Link', i, '" name="Link', i, '" class="CkUrl" value="', n.Url, '"/>');
                                dl.push('</dd>');
                            } else {
                                dl.push('<dd class="dt" data-val="', i, '">');
                                dl.push('<p><a></a><i class="fa fa-edit"></i></p>');
                                dl.push('<span id="BigImg" class="ImgID', i, '"><b>封面图片</b><img src="', n.PicUrl, '"/></span>');
                                dl.push('<label>');
                                dl.push('<i></i>');
                                dl.push('<b class="title', i, '">', n.Title, '</b>');
                                dl.push('</label>');
                                dl.push('<input type="hidden" id="Title', i, '" name="Title', i, '" class="CkTitle" value="', n.Title, '"/>');
                                dl.push('<input type="hidden" id="Image', i, '" name="Image', i, '" value="', n.PicUrl, '"/>');
                                dl.push('<input type="hidden" id="Description', i, '" name="Description', i, '" value="', n.Description, '"/>');
                                dl.push('<input type="hidden" id="Content', i, '" name="Content', i, '" value="', n.Content, '"/>');
                                dl.push('<input type="hidden" id="Link', i, '" name="Link', i, '" class="CkUrl" value="', n.Url, '"/>');
                                dl.push('</dd>');

                                $("#ConIndex").val(i);
                                $("#Title").val(n.Title);
                                $("#Description").val(n.Description);
                                ue.setContent(UE.utils.html(n.Content));
                                $("#Link").val(n.Url);
                                if (n.PicUrl !== "") {
                                    var vImg = $('<img src="' + n.PicUrl + '"/><tt>删除</tt>');
                                    vImg.filter("tt").click(function () { deleteImage(n.PicUrl, 0); });
                                    if ($("#BackImg>dd").html() == null) {
                                        var dd = $('<dd></dd>');
                                        dd.html(vImg);
                                        $("#BackImg").append(dd);
                                    } else {
                                        $("#BackImg>dd").html(vImg)
                                    }
                                } else {
                                    $("#BackImg>dd").remove();
                                }
                            }
                        });
                        $(this).children(".dt").remove();
                        $(this).prepend(dl.join(''));
                        $(this).children().not(".add").each(function (i) {
                            bindEvent($(this));
                        });
                        $(this).children("p").children("i").click();
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        }
    }

    me.addListener('wxnews', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['wxnewslist'] = function () {

    var me = this;

	var pageCount = 0;
	var curPage = 1;
	var pSize = 3;
	var Model = function () {
		var self = this;
		self.PageList = ko.observableArray();
		self.PageChange = function (n) {
			self.GetDataList(n.index);
		};
		self.GetDataList = function (p) {
//			$.post("/admin/weixin/wxnewslist", { action: "load", page: p,size:pSize },
			$.post("/index.php?c=admin/weixin/wxnewslist", { action: "load", page: p,size:pSize },
			function (data) {
				if (typeof (data) == "object" && data != null && data.success) {
					var dl = [];
					$.each(data.list, function (j, m) {
						dl.push('<dl class="News_Content" id="N',m.Nid,'">');
						$.each(jQuery.parseJSON(m.JsonContent), function (i, n) {
							if (i) {
								dl.push('<dd class="dd" data-val="', i, '"><p><a></a><i class="fa fa-edit"></i><b class="fa fa-remove"></b></p>');
								dl.push('<label><b class="title', i, '">', n.Title, '</b></label>')
								dl.push('<span class="ImgID', i, '"><b>缩略图</b><img src="', n.PicUrl, '"/></span>');
								dl.push('<input type="hidden" id="Title', i, '" class="CkTitle" name="Title', i, '" value="', n.Title, '"/>');
								dl.push('<input type="hidden" id="Image', i, '" name="Image', i, '" value="', n.PicUrl, '"/>');
								dl.push('<input type="hidden" id="Description', i, '" name="Description', i, '" value="', n.Description, '"/>');
								dl.push('<input type="hidden" id="Content', i, '" name="Content', i, '" value="', n.Content, '"/>');
								dl.push('<input type="hidden" id="Link', i, '" name="Link', i, '" class="CkUrl" value="', n.Url, '"/>');
								dl.push('</dd>');
							} else {
								dl.push('<dd class="dt" data-val="', i, '">');
								dl.push('<p><a></a><i class="fa fa-edit"></i></p>');
								dl.push('<span id="BigImg" class="ImgID', i, '"><b>封面图片</b><img src="', n.PicUrl, '"/></span>');
								dl.push('<label>');
								dl.push('<i></i>');
								dl.push('<b class="title', i, '">', n.Title, '</b>');
								dl.push('</label>');
								dl.push('<input type="hidden" id="Title', i, '" name="Title', i, '" class="CkTitle" value="', n.Title, '"/>');
								dl.push('<input type="hidden" id="Image', i, '" name="Image', i, '" value="', n.PicUrl, '"/>');
								dl.push('<input type="hidden" id="Description', i, '" name="Description', i, '" value="', n.Description, '"/>');
								dl.push('<input type="hidden" id="Content', i, '" name="Content', i, '" value="', n.Content, '"/>');
								dl.push('<input type="hidden" id="Link', i, '" name="Link', i, '" class="CkUrl" value="', n.Url, '"/>');
								dl.push('</dd>');
							}
						});
						dl.push('<dt class="Operate"><a href="#weixin.wxnews:{nid:\'',m.Nid,'\'}"><i class="fa fa-edit"></i></a><span><i class="fa fa-remove DelNews" data-value="', m.Nid, '"></i></span></dt>');
						dl.push('</dl>');
					});
					$("#container").html(dl.join(''));
					if (data.Count > 1) {
						if (pageCount == 0 || data.Count > pageCount) {
							pageCount = data.Count;
							var pArr = [];
							for (var i = 1; i < pageCount + 1; i++) {
								pArr.push({ index: i });
							}
							self.PageList(pArr);
							console.log(pArr);
						}
						curPage = p;
					}
					$("#container").masonry({
						itemSelector: '.News_Content'
					});
					setTimeout(function () {
					    if ($("#container").height() == 0) {
					        $("#container").css("height", "auto");
					    }
					}, 100);
				}
			});
		};
		self.GetDataList(curPage);
	};
	
	var myroot = null;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixinpackage/html/wxnewslist.html", function () {
            me.execCommand('initContentNav', root);
			pageCount = 0;
			curPage = 1;
			myroot = root[0];
			bindUIEvent();
			ko.applyBindings(new Model(),myroot);
		});
    }
	
	var nid = null;
	function bindUIEvent(){
		$(document).on("click", ".DelNews", function (e) {
			nid = $(this).attr("data-value");
			$('#ModalContent').html("删除后无法恢复！");
			$('#myModal').modal();
		});

		var button = $('<div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">取消</button><button type="button" class="btn btn-primary" id="Delete">删除</button></div>');
		$(".modal-content").append(button);
		button.children("#Delete").click(function () {
			if (nid&&nid!="") {
//				$.post("/admin/weixin/wxnewslist", { action: "delete", id: nid }, function (data) {
				$.post("/index.php?c=admin/weixin/wxnewslist", { action: "delete", id: nid }, function (data) {
					if (data != null && data.success) {
						$('#myModal').modal("hide");
						$("#N" + nid).remove();
					} else {
						$('#ModalContent').html("删除后无法恢复！");
					}
				});
			}
		});
	}

    me.addListener('wxnewslist', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['wxremind'] = function () {

    var me = this;
   
    
    var myroot = null;
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixinpackage/html/wxremind.html", function () {
        	

            myroot = root[0];

            loadWxRemind();	
            bindUIEvent();
            me.execCommand('initContentNav', root);
        });    
    }
    
    
    function loadWxRemind() {
    	$.getJSON("/index.php?c=admin/weixin/Wxremind", null, function (json) {
    		ko.applyBindings(json.info,myroot);
        });
    }
    



    function bindUIEvent() {
        $(".BoxTitle").tabs({ active: 3 });
        $(".BoxTitle").on("tabsactivate", function (event, ui) {
            var act = $(".BoxTitle").tabs("option", "active");
            if (3 != act) {
                me.execCommand('go', { a: "weixin", b: "wxreply", params: { tab: $(".BoxTitle").tabs("option", "active") } });
            }
        });

        
        $('#RemindSaveBtn').off().on('click', function () {
            var params = $('#RemindForm').serialize();

            $.ajax({
                type: 'post',
                url: '/index.php?c=admin/weixin/Wxremind&a=edit',
                async: false,
                cache: false,
                data: params,
                dataType: 'json',
                success: function (json) {
                    if (!json.success) {
                        $.showResult(false, json.msg);
                        return;
                    }
                    $.showResult(true, "保存成功", 2000);
                },
                error: function () {
                    $.showResult(false, arguments[0].responseText);
                },
                complete: function () {
                	loadWxRemind();
                }
            });

        });

    }

    me.addListener('wxremind', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['wxreply'] = function () {

    var me = this;

	var pageCount = 0;
    var curPage = 1;
    var pSize = 10;
	var myroot = null;
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixinpackage/html/wxreply.html", function () {
            me.execCommand('initContentNav', root);
			myroot = root[0];
			bindUIEvent();
		});
    }
	
	function bindUIEvent(){
		$(document).on("click", myroot, function (e) {
			var _this = $(e.target);
			if (_this.hasClass("PageNav")) {
				curPage = parseInt(_this.attr("data-value"));
				MessageList();
				e.preventDefault();
			};
			if (_this.hasClass("DelCurNews")) {
				_this.parent().prev(".BeginNews").show();
				_this.parent().hide().empty();
				e.preventDefault();
			};
			if (_this.hasClass("resetnews")) {
				
				InitLoad("reset", $("#RBType").val());
				e.preventDefault();
			}
			if (_this.attr("id") && "savebtn" == _this.attr("id").toLowerCase()) {
				Save();
			}
		});
		$(document).on("click", "#container>dl", function (e) {
			$("#container>dl").removeClass("selected");
			$(this).addClass("selected");
		});

		$("#msgText").unbind().change(function () {
            $("#EventData").val($(this).val());
        });
        $("#MContent").unbind().click(function () {
            $(this).hide();
            var mt = $("#MessageType").val().toUpperCase();
            var vContent = $(".WXContent").html();
            $("#Content").hide();
            $(".BoxContent").show();
            if (mt == "TEXT") {
                $("#msgText").val($("#EventData").val());
            } else {
                vContent = '<div class="NContent">' + vContent + '<div class="DelCurNews btn btn-primary">删除</div></div>';
                $("#" + mt).children(".NContent").remove();
                $("#" + mt).append(vContent);
                $("#" + mt + ">.BeginNews").hide();
                switch (mt) {
                    case "NEWS": {
                        $("#WxTabs").tabs("option", "active", 1);
                        break;
                    }
                    case "IMAGE": {
                        $("#WxTabs").tabs("option", "active", 2);
                        break;
                    }
                    case "PRODUCT": {
                        $("#WxTabs").tabs("option", "active", 3);
                        break;
                    }
                    case "PARTY": {
                        $("#WxTabs").tabs("option", "active", 4);
                        break;
                    }
                }
            }
        });
		
		var tab = "subscribe";
//		if(me.currentModule.params && me.currentModule.params.tab) tab = me.currentModule.params.tab;
		$("#WxTabs,.BoxTitle").tabs({ active: tab });
        
         // $('.subTab li').click(function  () {
         //    $('.subTab li').removeClass("active");
         //     $(this).addClass("active");
         // })


        $("#WxTabs").off("tabsactivate").on("tabsactivate", function (event, ui) {
            $("#MessageType").val(ui.newTab.attr("data-value"));
        });
        $(".BoxTitle").off("tabsactivate").on("tabsactivate", function (event, ui) {
            var rbt = ui.newTab.attr("data-value");
            if ("keyword" == rbt.toLowerCase()) {
                document.location = '#weixin.wxkeyword';
            }else if("remind" == rbt.toLowerCase()){
                document.location = '#weixin.wxremind';
            } else {
                $("#RBType").val(rbt);
                $("#msgText").val("");
                InitLoad("load", rbt);
            }
        });

        $(".SelectNews").unbind().click(function (e) {
            this.msgType = $("#MessageType").val();
            if ("image" == this.msgType.toLowerCase()) {
                YDM.FileManager('image', 1, function (aUrl) {
                    $("#EventData").val(aUrl);
                    Save(8);
                });
            } else {
                BindDialog(this.msgType);
            }
        });
        InitLoad("load",1);
	}

	function InitLoad(acType,rbType) {
        $.ajax({
            type: "POST",
//            url: "/admin/weixin/wxreply",
            url: '/index.php?c=admin/weixin/wxreply&a=index',
            async: true,
            cache: false,
            beforeSend: function () {
                if ("reset" == acType.toLowerCase()) {
                    $('#ModalContent').html("<span class='sending'><img src='/images/loading1.gif'/>重置信息!</span>");
                    $('#myModal').modal();
                }
            },
            dataType: "json",
            data: { action: acType, RBType: rbType },
            success: function (data) {
                console.log(data);
                if (data != null) {
                    if ("load" == acType.toLowerCase()) {
                        if (data.success) {
                            $("#MessageType").val(data.msgtype);
                            $("#EventData").val(data.eventdata);
                            LoadContent(data.msgtype, data.eventdata);
                        } else {
                            $("#Content").hide();
                            $(".BoxContent").show();
                            $("#MessageType").val("TEXT");
                            $("#EventData").val("");
                        }
                    }
                    if ("reset" == acType.toLowerCase()) {
                        if (data.success) {
                            $("#Content").hide();
                            $(".BoxContent").show();
                            setTimeout(function () {
                                $('#myModal').modal('hide');
                            }, 1000);
                        } else {
                            $('#ModalContent').html("重置信息失败！");
                        }
                    }
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    }

    function BindDialog(val) {
        if (val !== "TEXT") {
            this.dailog = $('<div id="dialog" class="none"><div id="container"></div></div>');
            $(myroot).append(this.dailog);
            this.dailog.dialog({
                modal: true, width: 750, height: 560, position: { my: "center", at: "center", of: window },
                resizable: false,
                open: function () {
                    MessageList();
                },
                buttons: {
                    "确定": function () {
                        this.messageType = $("#MessageType").val()
                        this.eventData = $(".selected").attr("data-value")
                        $("#EventData").val(this.eventData);
                        Save();
                        LoadContent(this.messageType,this.eventData);
                        $(this).dialog("close");
                    },
                    "取消": function () {$(this).dialog("close");}
                },
                close: function (event, ui) {
                    $("#container").empty();
                    $(".PageDiv").remove();
                    $("#dialog").dialog("destroy");
                    $("#dialog").remove();
                }
            });
        }
    }

    var MessageList = function () {
        $.getJSON('/index.php?c=admin/weixin/Wxmenu', { act: "LoadData", page: curPage,size: pSize, t: $("#MessageType").val() },
        function (data) {
            if (typeof (data) == "object" && data != null && data.success) {
				
                pageCount = data.Count;
                var dl = [];
                $.each(data.list, function (j, m) {
                    dl.push(MessageRender(jQuery.parseJSON(m.JsonContent), m.Nid));
                });
                $("#container").html(dl.join(''));

                if (!$(".ui-dialog-buttonpane").children().eq(0).hasClass("PageDiv")) {
                    this.page = ['<div class="PageDiv">'];
                    this.page.push('<ul class="pagination">');
                    for (var i = 0; i < pageCount; i++) {
                        var page = i + 1;
                        this.page.push('<li><a href="#" class="PageNav" data-value="', page, '">', page, '</a></li>');
                    }
                    this.page.push('</ul>');
                    this.page.push('</div>');
                    $(".ui-dialog-buttonpane").prepend(this.page.join(''));
                }
                setTimeout(function () {
                    $("#dialog>#container").masonry({
                        itemSelector: '.News_Content'
                    });
                }, 500);
            }
        });
    };
	
    function Save() {
        $.ajax({
            type: "POST",
//            url: "/admin/weixin/wxreply",
            url: "/index.php?c=admin/weixin/wxreply&a=index",
            beforeSend: function () {
                $('#ModalContent').html("<span class='sending'><img src='/images/loading1.gif'/>正在保存信息!</span>");
                $('#myModal').modal();
            },
            data: $("#f1").serialize().toString()+"&action=save",
            dataType: "json",
            success: function (data) {
                console.log(data);
                if (data !== null) {
                    if (data.success) {
                        var messageType = $("#MessageType").val();
                        var eventData = $("#EventData").val();
                        
                        $('#ModalContent').html("信息保存成功！");
                        setTimeout(function () {
                            $('#myModal').modal('hide');

                            LoadContent(messageType, eventData);
                        }, 1000);
                    } else {
                        $('#ModalContent').html(data.msg);
                    }
                } else {
                    $('#ModalContent').html("服务器没有返回！");
                }
            },error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    };

    function MessageRender(list, val) {
        var dl = ['<dl class="News_Content" data-value="', val, '">'];
        $.each(list, function (i, n) {
            if (i) {
                dl.push('<dd class="dd" data-val="', i, '"><p><a></a><i class="fa fa-edit"></i><b class="fa fa-remove"></b></p>');
                dl.push('<label><b class="title', i, '">', n.Title, '</b></label>')
                dl.push('<span class="ImgID', i, '"><b>缩略图</b><img src="', n.PicUrl, '"/></span>');
                dl.push('</dd>');
            } else {
                dl.push('<dd class="dt" data-val="', i, '">');
                dl.push('<p><a></a><i class="fa fa-edit"></i></p>');
                dl.push('<span id="BigImg" class="ImgID', i, '"><b>封面图片</b><img src="', n.PicUrl, '"/></span>');
                dl.push('<label>');
                dl.push('<i></i>');
                dl.push('<b class="title', i, '">', n.Title, '</b>');
                dl.push('</label>');
                dl.push('</dd>');
            }
        });
        dl.push('<dt><p></p><i class="fa fa-check"></i></dt>');
        dl.push('</dl>');
        return dl.join("");
    }

    function LoadContent(messageType, eventData) {
        $.ajax({
            type: "POST",
//            url: "/admin/weixin/wxreply",
            url:'/index.php?c=admin/weixin/wxreply&a=index',
            data: { action: 'getmsg', MessageType: messageType, EventData: eventData },
            dataType: "json",
            success: function (data) {
                console.log("LoadContent:");
                console.log(data);
                if (data != null) {
                    console.log(data);
                    if (data.success) {
                        $("#Content").show();
                        $(".BoxContent").hide();
                        $("#MContent").show();
                        $("#MessageType").val(data.msgtype);
                        $("#EventData").val(data.eventdata);
                        if ($(".BoxTitle").tabs("option", "active")) {
                            $(".content_title").html("公众号收到不匹配的信息会响应以下消息；<span class='resetnews'>重设信息</span>");
                        } else {
                            $(".content_title").html("关注该微信公众号会收到以下消息；<span class='resetnews'>重设信息</span>");
                        }
                        switch (data.msgtype.toUpperCase()) {
                            case "TEXT": $("#Content").show().children(".WXContent").html(data.eventdata);
                                break;
                            case "IMAGE": {
                                this.img = '<div><img src="' + eventData + '" style="max-width:500px;"/></div>';
                                $("#Content").show().children(".WXContent").html(this.img);
                                break;
                            }
                            case "NEWS":
                            case "PRODUCT":
                            case "PARTY":
                                $("#Content").show().children(".WXContent").html(MessageRender(data.list));
                                break;
                        }
                    } else {
                        $('#ModalContent').html(data.msg);
                        $('#myModal').modal();
                    }
                } else {
                    $('#ModalContent').html("服务器没有返回数据！");
                    $('#myModal').modal();
                }
            }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    }

    me.addListener('wxreply', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['wxtemplate'] = function() {
  var me = this, nowConfig = null, TemplateShortID = {
    "1.1" : "TM00015",
    "1.2" : "TM00015",
    "1.3" : "OPENTM202243318",
    "1.4" : "OPENTM207002946",
    "1.5" : "OPENTM207795583",
    "1.6" : "TM00015",
    "2.1": "OPENTM207679900",
    "2.2": "OPENTM200465417",
    "2.3": "OPENTM207679900",
	"2.4": "OPENTM401426285",
    "3.1" : "OPENTM207679900",
    "3.2" : "OPENTM207679900",
    "3.3" : "OPENTM207679900",
    "3.4" : "TM00015",
    "3.5" : "TM00015",
    "3.6" : "TM00015",
    "3.7" : "OPENTM207002946",
    "3.8" : "OPENTM207002946",
    "3.9" : "OPENTM207002946",
    "3.11": "OPENTM207795583",
    "3.12": "OPENTM207795583",
    "3.13": "OPENTM207795583",
  }, IDTemplate = {
    "TM00015": ["{{first.DATA}}",
"支付金额：{{orderMoneySum.DATA}}",
"商品信息：{{orderProductName.DATA}}",
"{{Remark.DATA}}"],
    "OPENTM207795583": ["{{first.DATA}}",
"预约单号：{{keyword1.DATA}}",
"预约项目：{{keyword2.DATA}}",
"退款理由：{{keyword3.DATA}}",
"{{remark.DATA}}"],
    "TM00430": ["{{first.DATA}}",
"退款金额：{{orderProductPrice.DATA}}",
"商品详情：{{orderProductName.DATA}}",
"订单编号：{{orderName.DATA}}",
"{{remark.DATA}}"],
    "OPENTM202243318": ["{{first.DATA}}",
"订单内容：{{keyword1.DATA}}",
"物流服务：{{keyword2.DATA}}",
"快递单号：{{keyword3.DATA}}",
"收货信息：{{keyword4.DATA}}",
"{{remark.DATA}}"],
    "OPENTM207002946": ["{{first.DATA}}",
"订单内容：{{keyword1.DATA}}",
"物流服务：{{keyword2.DATA}}",
"快递单号：{{keyword3.DATA}}",
"收货信息：{{keyword4.DATA}}",
"{{remark.DATA}}"],
    "OPENTM207679900": ["{{first.DATA}}",
"会员ID：{{keyword1.DATA}}",
"加入时间：{{keyword2.DATA}}",
"{{remark.DATA}}"],
    "OPENTM200750297": ["{{first.DATA}}",
"店铺名称：{{keyword1.DATA}}",
"商品名称：{{keyword2.DATA}}",
"下单时间：{{keyword3.DATA}}",
"下单金额：{{keyword4.DATA}}",
"付款状态：{{keyword5.DATA}}",
"{{remark.DATA}}"],
    "OPENTM207762668": ["{{first.DATA}}",
"订单编号：{{keyword1.DATA}}",
"商品名称：{{keyword2.DATA}}",
"购买者：{{keyword3.DATA}}",
"退款金额：{{keyword4.DATA}}",
"退单时间：{{keyword5.DATA}}",
"{{remark.DATA}}"],
    "OPENTM201812627": ["{{first.DATA}}",
"佣金金额：{{keyword1.DATA}}",
"时间：{{keyword2.DATA}}",
"{{remark.DATA}}"],
    "OPENTM200465417": ["{{first.DATA}}",
"类型：{{keyword1.DATA}}",
"金额：{{keyword2.DATA}}",
"时间：{{keyword3.DATA}}",
"{{remark.DATA}}"],
    "OPENTM401426285": ["{{first.DATA}}",
"用户昵称：{{keyword1.DATA}}",
"最新等级：{{keyword2.DATA}}",
"生效时间：{{keyword3.DATA}}",
"{{remark.DATA}}"],
    /*编号OPENTM202183094
     标题商品支付成功通知
     行业IT科技 - 互联网|电子商务
     使用人数1215
     最后修改时间2015-01-15 16:50:58
     详细内容
     {{first.DATA}}
     付款金额：{{keyword1.DATA}}
     商品详情：{{keyword2.DATA}}
     支付方式：{{keyword3.DATA}}
     交易单号：{{keyword4.DATA}}
     交易时间：{{keyword5.DATA}}
     {{remark.DATA}}
     内容示例
     您好，您的商品已支付成功
     付款金额：5500元
     商品详情：苹果APPLE 6S 128G
     支付方式：微信支付
     交易单号：110820141210000016
     交易时间：2014年7月21日 18:36
     您可以到交易记录查看更多信息*/


    /*编号OPENTM207847168
     标题订单生成成功
     行业IT科技 - 互联网|电子商务
     使用人数18
     最后修改时间2015-09-28 09:46:48
     详细内容
     {{first.DATA}}
     订单编号：{{keyword1.DATA}}
     生成时间：{{keyword2.DATA}}
     订单金额：{{keyword3.DATA}}
     订单商品：{{keyword4.DATA}}
     {{remark.DATA}}
     内容示例
     您好，您已下单成功。
     订单编号：1509270001
     生成时间：2015-09-17 18:00:00
     订单金额：50元
     订单商品：剃须刀 1把
     如有疑问，请联系...*/


    /*编号OPENTM207351887
     标题订单通知
     行业IT科技 - IT软件与服务
     使用人数33
     最后修改时间2015-08-19 12:14:59
     详细内容
     {{first.DATA}}
     产品名称：{{keyword1.DATA}}
     订单编号：{{keyword2.DATA}}
     通知内容：{{keyword3.DATA}}
     {{remark.DATA}}
     内容示例
     您已预订成功，请在24小时内完成支付。
     产品名称：20134-0815
     订单编号：A39393939331
     通知内容：预订时间 2015-08-01  15:34
     如有疑问，请拨打咨询热线*/
  }, EventDefault = {
    "1.1": {
      'first': '您好，您的会员： {USER}  已下单：',
      'orderMoneySum': '{PRICE}',
      'orderProductName': '{INFO}',
      'Remark': '订单编号：{ORDERID}, 请到后台查看跟进。'
    },
    "1.2": {
        'first': '您好，您已下单成功：',
        'orderMoneySum': '{PRICE}',
        'orderProductName': '{INFO}',
        'Remark': '订单编号：{ORDERID}, 谢谢客官。',
    },
    "1.3": {
        "first": "嗖嗖嗖，您的快递已发货，我们正加速送到您的手上。",
        "keyword1": "{INFO}",
        "keyword2": "{LOGISTICS}",
        "keyword3": "{EXPRESSLISTNO}",
        "keyword4": "{CONSIGNEE}",
        "remark": "请您耐心等候。",
    },
    "1.4": {
        "first": "您好，您的会员：{USER} {CONFIRMACTION}。",
        "keyword1": "{INFO}",
        "keyword2": "{LOGISTICS}",
        "keyword3": "{EXPRESSLISTNO}",
        "keyword4": "{CONSIGNEE}",
        "remark": "请到后台核查。",
    },
    "1.5": {
      "first": "您好，会员： {USER}  有一个退款单需要处理",
      "keyword1": "{ORDERNO}",
      "keyword2": "{INFO}",
      "keyword3": "{REASON}",
      "remark": "请到后台跟进管理。",
    },
    "1.6": {
        'first': '您好，您的会员： {USER}  已下单：',
        'orderMoneySum': '{PRICE}',
        'orderProductName': '{INFO}',
        'Remark': '订单编号：{ORDERID}, 请到后台查看跟进。'
    },
    "2.1": {
      'first': '您好，您的商城有新会员加入，会员名：{USER}',
      'keyword1': '{USERID}',
      'keyword2': '{JOINTIME}',
      'remark': '请到后台核查。',
    },
    "2.2": {
        'first': '尊敬的用户，您的账户资金发生以下变动！',
        'keyword1': '财务{TYPESTR}',
        'keyword2': '{MONEY}',
        'keyword3': '{TIME}',
        'remark': '请到后台核查。',
    },
    "2.3": {
        'first': '您好，您有新的下级会员加入，会员名：{USER}',
        'keyword1': '{USERID}',
        'keyword2': '{JOINTIME}',
        'remark': '请到后台核查。',
    },
	"2.4": {
        'first': '恭喜您的会员等级升级了！',
        'keyword1': '{USER}',
        'keyword2': '{LEVEL}',
		'keyword3': '{UPGRADETIME}',
        'remark': '请到后台核查。',
    },
    "3.1": {
      'first': '您好，您有新的下级会员加入，会员名：{USER}',
      'keyword1': '{USERID}',
      'keyword2': '{JOINTIME}',
      'remark': '请到后台核查。',
    },
    "3.2": {
        'first': '您好，您的下级：{FENXIAO1} 有新的下级会员加入，会员名：{USER}',
        'keyword1': '{USERID}',
        'keyword2': '{JOINTIME}',
        'remark': '请到后台核查。',
    },
    "3.3": {
        'first': '您好，您的下级：{FENXIAO1} 的下级：{FENXIAO2} 有新的下级会员加入，会员名：{USER}',
        'keyword1': '{USERID}',
        'keyword2': '{JOINTIME}',
        'remark': '请到后台核查。',
    },
    "3.4": {
        'first': '您的下级： {USER}  已下单成功',
        'orderMoneySum': '{PRICE}',
        'orderProductName': '{INFO}',
        'Remark': '订单编号：{ORDERID}, 请到后台查看跟进。'
    },
    "3.5": {
        'first': '您的下级： {FENXIAO1} 的下级会员：{USER}  已下单成功',
        'orderMoneySum': '{PRICE}',
        'orderProductName': '{INFO}',
        'Remark': '订单编号：{ORDERID}, 请到后台查看跟进。'
    },
    "3.6": {
        'first': '您的下级：  {FENXIAO1} 的下级：{FENXIAO2} 的下级会员：{USER}  已下单成功',
        'orderMoneySum': '{PRICE}',
        'orderProductName': '{INFO}',
        'Remark': '订单编号：{ORDERID}, 请到后台查看跟进。'
    },
    "3.7": {
      "first": "您的下级：{USER} {CONFIRMACTION}。",
      "keyword1": "{INFO}",
      "keyword2": "{LOGISTICS}",
      "keyword3": "{EXPRESSLISTNO}",
      "keyword4": "{CONSIGNEE}",
      "remark": "请到后台核查。",
    },
    "3.8": {
        "first": '您的下级： {FENXIAO1} 的下级会员：{USER} {CONFIRMACTION}',
        "keyword1": "{INFO}",
        "keyword2": "{LOGISTICS}",
        "keyword3": "{EXPRESSLISTNO}",
        "keyword4": "{CONSIGNEE}",
        "remark": "请到后台核查。",
    },
    "3.9": {
          "first": '您的下级：  {FENXIAO1} 的下级：{FENXIAO2} 的下级会员：{USER} {CONFIRMACTION}',
          "keyword1": "{INFO}",
          "keyword2": "{LOGISTICS}",
          "keyword3": "{EXPRESSLISTNO}",
          "keyword4": "{CONSIGNEE}",
          "remark": "请到后台核查。",
    },
    "3.11": {
      "first": "您好，您的下级：{USER} 申请了退单。",
      "keyword1": "{ORDERNO}",
      "keyword2": "{INFO}",
      "keyword3": "{REASON}",
      "remark": "请到后台跟进管理。",
    },
    "3.12": {
    	"first": '您的下级： {FENXIAO1} 的下级会员：{USER}  申请了退单。',
        "keyword1": "{ORDERNO}",
        "keyword2": "{INFO}",
        "keyword3": "{REASON}",
        "remark": "请到后台跟进管理。",
    },
    "3.13": {
    	"first": '您的下级：  {FENXIAO1} 的下级：{FENXIAO2} 的下级会员：{USER}  申请了退单。',
        "keyword1": "{ORDERNO}",
        "keyword2": "{INFO}",
        "keyword3": "{REASON}",
        "remark": "请到后台跟进管理。",
    },
  }, EventVariables = {
    "1.1" : {"USER": "新提交订单的会员", "PRICE": "订单金额", "INFO": "订单商品信息", "ORDERID": "订单编号",},
    "1.2" : {"PRICE": "订单金额", "INFO": "订单商品信息", "ORDERID": "订单编号",},
    "1.3" : {"INFO": "订单详情", "LOGISTICS": "物流服务", "EXPRESSLISTNO": "物流单号", "CONSIGNEE": "收货信息",},
    "1.4" : {"USER": "确认收货的会员", "CONFIRMACTION":"会员确认收货或者系统自动确认收货","INFO": "订单详情", "LOGISTICS": "物流服务", "EXPRESSLISTNO": "物流单号", "CONSIGNEE": "收货信息",},
    "1.5" : {"USER": "申请退款的会员", "ORDERNO": "订单编号", "INFO": "订单内容", "REASON": "退款理由",},
    "1.6" : {"USER": "新提交订单的会员", "PRICE": "订单金额", "INFO": "订单商品信息", "ORDERID": "订单编号",},

    "2.1": { "USER": "新加入的会员名", "USERID": "会员ID", "JOINTIME": "加入时间", },
    "2.2": { "TYPESTR": "入账或支出", "MONEY": "这笔财务涉及的金额", "TIME": "新增财务记录时间", },
    "2.3" : {"USER": "新加入的会员名", "USERID": "会员ID", "JOINTIME": "加入时间",},
	"2.4" : {"USER": "升级的会员名", "LEVEL": "升级后的等级名称", "UPGRADETIME": "生效时间",},
    
    "3.1" : {"USER": "新加入的会员名", "USERID": "会员ID", "JOINTIME": "加入时间",},
    "3.2" : {"FENXIAO1":"下1级会员名","USER": "新加入的会员名", "USERID": "会员ID", "JOINTIME": "加入时间",},
    "3.3" : {"FENXIAO1":"下1级会员名","FENXIAO2":"下2级会员名","USER": "新加入的会员名", "USERID": "会员ID", "JOINTIME": "加入时间",},
    
    "3.4" : {"USER": "新提交订单的会员", "PRICE": "订单金额", "INFO": "订单商品信息", "ORDERID": "订单编号",},
    "3.5" : {"FENXIAO1":"下1级会员名","USER": "新提交订单的会员", "PRICE": "订单金额", "INFO": "订单商品信息", "ORDERID": "订单编号",},
    "3.6" : {"FENXIAO1":"下1级会员名","FENXIAO2":"下2级会员名","USER": "新提交订单的会员", "PRICE": "订单金额", "INFO": "订单商品信息", "ORDERID": "订单编号",},
    
    "3.7" : {"USER": "确认收货的会员", "CONFIRMACTION":"会员确认收货或者系统自动确认收货","INFO": "订单详情", "LOGISTICS": "物流服务", "EXPRESSLISTNO": "物流单号", "CONSIGNEE": "收货信息",},
    "3.8" : {"FENXIAO1":"下1级会员名","CONFIRMACTION":"会员确认收货或者系统自动确认收货","USER": "确认收货的会员", "INFO": "订单详情", "LOGISTICS": "物流服务", "EXPRESSLISTNO": "物流单号", "CONSIGNEE": "收货信息",},
    "3.9" : {"FENXIAO1":"下1级会员名","CONFIRMACTION":"会员确认收货或者系统自动确认收货","FENXIAO2":"下2级会员名","USER": "确认收货的会员", "INFO": "订单详情", "LOGISTICS": "物流服务", "EXPRESSLISTNO": "物流单号", "CONSIGNEE": "收货信息",},
   
    "3.11" : {"USER": "申请退款的会员", "ORDERNO": "订单编号", "INFO": "订单内容", "REASON": "退款理由",},
    "3.12" : {"FENXIAO1":"下1级会员名","USER": "申请退款的会员", "ORDERNO": "订单编号", "INFO": "订单内容", "REASON": "退款理由",},
    "3.13" : {"FENXIAO1":"下1级会员名","FENXIAO2":"下2级会员名","USER": "申请退款的会员", "ORDERNO": "订单编号", "INFO": "订单内容", "REASON": "退款理由",},
  }, SmsSupportEvent = [
      "1.1", "1.2", "1.3","1.4", "1.5", "1.6", "2.1", "2.2", "2.3", "2.4", "3.1", "3.2", "3.3", "3.4", "3.5", "3.6", "3.7", "3.8", "3.9", "3.11", "3.12", "3.13"
  ];

  function initUI(root) {
    root.children().remove();
    root.loadHtmlTpl("plugins/weixinpackage/html/wxtemplate.html?rand=" + Math.random(), function() {
        me.execCommand('initContentNav', root);

        if (!me.hasPerm('configwx')) {
            $('#MustBeCertifiedAccount').show();
        }else{
            $('#MustBeCertifiedAccount').remove();
        }
      curPage = 1;
      myroot = root[0];
      if(!$("#WXModal")[0]) {
        var sHtml = '';
        sHtml += '<div id="WXModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">';
        sHtml += '<div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header">';
        sHtml += '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"';
        sHtml += ' class="glyphicon glyphicon-remove" style=" color: red; font-size: 1.8rem; "></span>';
        sHtml += '</button><h4 class="modal-title">添加新微信模板消息</h4></div><div class="modal-body">';
        sHtml += '<div class="alert alert-danger" role="alert"></div></div><div class="modal-footer">';
        sHtml += '<button type="button" class="btn btn-default cancel" data-dismiss="modal">关闭</button>';
        sHtml += '<button type="button" class="btn btn-primary submit disabled" disabled>提交更改</button></div></div></div></div>';
        $(sHtml).appendTo('body');
        $("#WXModal").find(".modal-body").html($('#ConfigTemplate').html()).modal('hide');
      }
      bindUIEvent();
      //ko.applyBindings(m, myroot);
      //m.LoadUser(curPage);
      loadData();
    });
  };
  function loadData() {
    $('#addTemplate').prop('disabled', true);
    //$.getJSON("/admin/weixin/wxconfig?act=getinfo", null, function(json) {
    $.getJSON("/index.php?c=admin/weixin/wxconfig&a=getinfo", null, function(json) {
      //con sole.log(json);
      if(json.info.WxType == 3) {
        $('#maincontent > div').addClass('Certified')
      }
    });
//    $.getJSON("/admin/weixin/WxTempMsg?act=ReadConfig", null, function(data, textStatus, jqXHR) {
    $.getJSON("/index.php?c=admin/weixin/weixintempmsg&a=ReadConfig", null, function(data, textStatus, jqXHR) {
      nowConfig = data;
      var html = '', json;
      //con sole.log(data);
      for(var ii in data) {
//        console.log(ii);
//        console.log(data[ii]);
//        json = JSON.parse(data[ii]);
        json =data[ii];
        html += '<tr><!--<td><input type="checkbox" /></td>--><td>' + json['chrTitle'] + '</td>' + '<td>' +
          document.querySelector('[value="' + ii + '"]').innerHTML + '</td>' + '<td>' + (json['activity'] - 0 ? '是' : '否') +
          '</td>' +
          '<td>' + (SmsSupportEvent.indexOf(ii) == -1 ? '不支持' : (json['activity_sms'] - 0 ? '开启' : '禁用')) + '</td>' +
          '<td><a href="javascript:(function(){})();" class="edit" data-id="' + ii + '">编辑</a>' +
          '<a href="javascript:(function(){})();" class="del" data-id="' + ii + '">删除</a></td>' + '</tr>';
      }
      $('#TbodyConfigList').html(html);
      $('#COLEmpty').css('display', $.trim(html) === '' ? '' : 'none');
      $('#addTemplate').prop('disabled', false);
      //console.log(data);
    });
  };
  function bindUIEvent() {
    $("#addTemplate").unbind('click').bind("click", function() {
        ConfigTemplate();
        //SetEventTypeSelectionSmsText();
    });
    $(document).off('click', '#GetTemplateID').on('click', '#GetTemplateID', function() {
      FetchTemplateId($('#TempShortID').html());
    }).off('click', '#WXModal button.submit').on('click', '#WXModal button.submit', function() {
//      $.post('/admin/weixin/WxTempMsg?act=WriteConfig', $("#FormTempConfig").serialize(), function(data, textStatus, jqXHR) {
    	$.post('/index.php?c=admin/weixin/weixintempmsg&a=WriteConfig', $("#FormTempConfig").serialize(), function(data, textStatus, jqXHR) {
    	//console.log(arguments);
        loadData();
      });
      $('#WXModal').modal('hide');
    }).off('change', "#EventTypeSelection").on('change', '#EventTypeSelection', function(Event) {
      SetEventType(Event.target.value);
    }).unbind('click', '#TbodyConfigList a.edit').bind("click", '#TbodyConfigList a.edit', function(event) {
      if($(event.target).data('id') && $(event.target).hasClass('edit')) {
        ConfigTemplate($(event.target).data('id'));
      }
    }).unbind('click', '#TbodyConfigList a.del').bind("click", '#TbodyConfigList a.del', function(event) {
      if($(event.target).data('id') && $(event.target).hasClass('del')) {
//        $.post('/admin/weixin/WxTempMsg?act=WriteConfig', {
    	  $.post('/index.php?c=admin/weixin/weixintempmsg&a=WriteConfig', {
          "EventType": $.trim($(event.target).data('id'))
        }, function(data, textStatus, jqXHR) {
          //console.log(arguments);
          loadData();
        });
      }
    }).unbind('click', '#TestTemplate').bind('click', '#TestTemplate', function() {
      $.trim($(event.target).data('eventid')) && $.get("/admin/weixin/WxTempMsg?act=testSend", {
        EventID: $.trim($(event.target).data('eventid'))
      })
    });
    ;
  };
  function SetEventType(value) {
    //con sole.log(value === "");
    $('[name="templateid"], #GetTemplateID, #MSGLink, #WXModal button.submit').prop('disabled', value === "");
    $('#BoundingRect').css('display', value !== "" ? 'none' : '');
    $('#TempShortID').html(TemplateShortID[value] || '');
    (loadTemplateId(TemplateShortID[value] || ''));
    var Temp = (function(value) {
      //return IDTemplate[TemplateShortID[value]];
      var aa = IDTemplate[TemplateShortID[value]], bb = new Array();
      if(typeof aa === 'undefined') return [];
      for(var i = 0; i < aa.length; i++) bb.push(aa[i]);
      return bb;
    })(value);
    //con sole.log(Temp);
    for(var i = 0, v; v = Temp[i++];) {
      var discribe = v.replace(/\{\{.+?}}/, '');
      //console.log(discribe);
      Temp[i - 1] = '' +
        (discribe === "" ? '' : '<div class="input-group"><span class="input-group-addon">' + discribe + '</span>') +
        '<input type="text" class="form-control" name="' + (v.match(/\{\{(.+)}}/, '')[1]) + /* /\{\{(.+)\.DATA}}/ */
        '" aria-label="..." placeholder="' + (v.replace(discribe, '')) + '">' +
        (discribe === "" ? '' : '</div>');
    }
    $('#MSGTemplate').html(Temp.join(''));
    $('#VarList').html('');
    EventVariables[value] && (function() {
      var s = '';
      for(var ii in EventVariables[value]) {
        s += '<p>{' + ii + '}: 代表 ' + EventVariables[value][ii] + '；</p>';
      }
      $('#VarList').html(s);
    })();
    EventDefault[value] && (function() {
      for(var ii in EventDefault[value]) {
          //document.querySelector('[name="' + ii + '.DATA"]').value = EventDefault[value][ii];
          $('[name="' + ii + '.DATA"]').val(EventDefault[value][ii]);
      }
    })();
    value === "" || ReadConfig(value);
  };
  function ConfigTemplate(EventID) {
    $('#WXModal').modal('show');
    $('#WXModal button.submit').attr('disabled', true);
    //var html = /* data.msg + */'<br/><br/><a class="btn btn-primary goWXConfig" data-dismiss="modal"
    // aria-label="Close">现在配置</a>';
    $("#WXModal").find(".modal-body").html($('#ConfigTemplate').html());
    for(var ii in nowConfig) {
      $('option[value="' + ii + '"]').attr('disabled', true);
    }
    if(EventID){
      $("#EventTypeSelection").val(EventID).trigger('change').attr('disabled', true)
        .after('<input type="hidden" name="EventType" value="'+EventID+'" />')
        .after(document.getElementById('EventTypeSelection').selectedOptions[0].innerHTML).hide();
    } else {
      $('#TemplateConfig').addClass('Loaded');
      //$('#WXModal button.submit').attr('disabled', false);
    }
    /*$("#WXModal").on("hidden.bs.modal", function (e) {
     me.execCommand('go', { a: 'weixin', b: 'wxconfig' });
     });*/
  };
  function FetchTemplateId(ShortID){
    //con sole.log('aslkfjl');
//    $.trim(ShortID) && $.getJSON("/admin/weixin/WxTempMsg?act=GetId", {TemplateShortId: $.trim(ShortID)}, TemplateIDResponse);
	  $.trim(ShortID) && $.getJSON("/index.php?c=admin/weixin/weixintempmsg&a=getid", {TemplateShortId: $.trim(ShortID)}, TemplateIDResponse);

  }
  function loadTemplateId(ShortID) {
//	  $.trim(ShortID) && $.getJSON("/admin/weixin/WxTempMsg?act=ReadId", {TemplateShortId: $.trim(ShortID)}, TemplateIDResponse);
	  $.trim(ShortID) && $.getJSON("/index.php?c=admin/weixin/weixintempmsg&a=ReadId", {TemplateShortId: $.trim(ShortID)}, TemplateIDResponse);

  };
  function TemplateIDResponse(json){
    console.log(json);
    if(!json.success && json.getidErrorMessage){
    	alert(json.getidErrorMessage);
    	return false;
    }
    if(json.errorMessage && json.errorMessage.errcode === 40102) {
      $('[name="templateid"]').css('width', 280);
      $('#SetIndustry').show().on('click', function() {
        $('#SetIndustry').hide();
        $('[name="templateid"]').css('width', 400);
        $.getJSON("/admin/weixin/WxTempMsg?act=SetIndustry", function(data, textStatus, jqXHR) { });
      });
    }
    var Bool = json.errorMessage && json.errorMessage.IsSuccess || !json.errorMessage && json.success;
      $('[name="templateid"]')
        .attr('disabled', Bool)
        .css('width', Bool ? 460 : 400)
        .val(Bool ? json.id : '');
      $('#GetTemplateID').css('display', Bool ? 'none' : '');
    $('#TemplateIDConfig').addClass('Loaded');
    $('#WXModal button.submit')[(Bool ? 'remove' : 'add') + 'Class']('disabled');
  }

  function ReadConfig(EventID) {
    // 根据是否支持短信来显隐选项
    if (SmsSupportEvent.indexOf(EventID) == -1) {
        $('#trActivitySms').hide();
        $('#activity_sms0').click();
    } else {
        $('#trActivitySms').show();
        //$('#activity_sms1').click();
    }
//    $.getJSON("/admin/weixin/WxTempMsg?act=ReadConfig", {EventID: $.trim(EventID)}, function(data, textStatus, jqXHR) {
    $.getJSON("/index.php?c=admin/weixin/weixintempmsg&a=ReadConfig", {EventID: $.trim(EventID)}, function(data, textStatus, jqXHR) {
      for(var ii in data) {
        if($('[name="' + ii + '"]').attr('type') == 'radio') {
          $('[name="' + ii + '"][value="' + data[ii] + '"]').parent().trigger('click');
        } else {
          $('[name="' + ii + '"]').val(data[ii]);
        }
      }
      $('#TemplateConfig').addClass('Loaded');
      $('#WXModal button.submit').attr('disabled', false);
    })
  }

  function SetEventTypeSelectionSmsText() {
      $('#EventTypeSelection option').each(function () {
          if (!isNaN(parseFloat(this.value)) && SmsSupportEvent.indexOf(this.value) > -1 && this.text.indexOf('----') == -1) {
              var text = $(this).text();
              $(this).text($(this).text() + '------------(支持短信)');
          }
      });
  }

  me.addListener('wxtemplate', function(key, args) {
    initUI(args);
  });
};
﻿IWF.plugins['wxuserlist'] = function () {

    var me = this;

	//每页显示记录数
    var rcSize = 5;
    //当前页
    var curPage = 1;
    //导航页数
    var pageNum = 10;
    //组ID
    var groupId = -1;
        
    var msgModel = function () {
        var self = this;
        self.UserList = ko.observableArray([]);
        self.GroupList = ko.observableArray([]);
        self.UserCount = ko.observable();
        self.CurGroup = -1;
        self.Search = function () {
            self.LoadUser(1, $("#nikeName").val(), $("#sex").val());
        };
        self.SelectGroup = function (g) {
            if (g) {
                groupId = g.GroupId
            } else {
                groupId = -1;
            }
            self.CurGroup = groupId;
            $("#nikeName").val("");
            $("#sex").val(0)
            $("#sexText").text("全部");
            self.LoadUser(1);
        }
		self.GetUserCount = function(){
			var count = 0;
			$.each(self.GroupList(), function(key, val) {
				count += val.GCount;
			});
			return count;
		}
        self.Create = function () {
            $('<div id="dialog"><input type="text" id="GName"/></div>').dialog({
                modal: true, width: 350, height: 'auto', position: { my: "center", at: "center", of: window },
                resizable: false,
                buttons: {
                    "保存": function () {
                        var gname = $("#GName").val();
                        $.ajax({
                            type: "POST",
//                            url: "/admin/weixin/wxuserlist",
                            url: "/index.php?c=admin/weixin/wxuserlist",
                            cache: false,
                            beforeSend: function () {
                                $('#ModalContent').html("<span class='sending'><img src='/images/loading1.gif'/>正在保存分组!</span>");
                                $('#myModal').modal();
                            },
                            dataType: "json",
                            data: { action: "create", gname: gname },
                            success: function (data) {
                                console.log(data);
                                if (data != null) {
                                    if (data.success) {
                                        m.LoadUser(curPage);
                                        $('#ModalContent').html("<span class='sending'>新建分组成功!</span><i class='fa fa-check' style='font-size:2em;color:green;'></i>");
                                        setTimeout(function () {
                                            $('#myModal').modal('hide');
                                        }, 1000);
                                    } else {
                                        $('#ModalContent').html("<i class='fa fa-exclamation-triangle'></i><span class='sending'><img src='/images/loading1.gif'/>新建分组失败!</span>");
                                    }
                                }
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                $('#ModalContent').html("<i class='fa fa-exclamation-triangle'></i><span class='sending'>新建分组出错了，请重试!");
                                console.log(XMLHttpRequest.responseText);
                            }
                        });
                        $(this).dialog("close");
                    },
                    "取消": function () {
                        $(this).dialog("close");
                    }
                },
                close: function (event, ui) {
                    $(this).dialog("destroy");
                    $(this).remove();
                }
            });
        };
        self.LoadUser = function (page, name, sex) {
            $.ajax({
                type: "POST",
//                url: "/admin/weixin/wxuserlist",
                url: "/index.php?c=admin/weixin/wxuserlist",
                async: true,
                cache: false,
                dataType: "json",
                data: { action: "load", page: page, size: rcSize, gid: groupId, nike: name, sex: sex },
                success: function (data) {
                    console.log(data);
                    if (data != null && data.success) {
                        self.WxOwnerOpenID(data.WxOwnerOpenID);
                        self.UserList(data.List);
                        self.GroupList(data.GroupList)
                        self.UserCount(data.UserCount);
                        curPage = page;
                        $('.wxOwnerFlag').each(function () {
                            if ($(this).attr('data-openId') != '' && (data.WxOwnerOpenID + "") != '' && (data.WxOwnerOpenID + "").indexOf($(this).attr('data-openId') + "") > -1) {
                                $(this).show();
                                $(this).siblings('.btnCancelWxOwner').show();
                            }
                        })
						if(data.Count > 1){
						    $("#pagination").pageNav(curPage, data.Count, pageNum, function (ipage) {
						        self.LoadUser(ipage, $("#nikeName").val(), $("#sex").val());
						    });
							$("#pagination").show();
						}else $("#pagination").hide();
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
        self.SynUsers = function recurse(json) {
        	var data={action: "synuser"};
        	if(json)
        	{
        		for (var s in json)
        		{ 
        			data[s]=json[s]; 
        		}
        	}
            $.ajax({
                type: "POST",
//                url: "/admin/weixin/wxuserlist",
                url: "/index.php?c=admin/weixin/wxuserlist",
                cache: false,
                beforeSend: function (XMLHttpRequest) {
                	if(!json)
                	{
                		$('#ModalContent').html("<span class='sending'><img src='/images/loading1.gif'/>正在同步用户信息!</span> <span id='percent'></span>");
                		$('#myModal').modal();
                	}
                },
                dataType: "json",
                data:  data ,
                success: function (data) {
                    console.log(data);
                    if (data != null) {
                        if (data.success) {
                        	if(data.commet)
                        	{
                        		if(data.finish)
                        		{
                        			self.LoadUser(1);
    	                            $('#ModalContent').html("同步成功！");
    	                            setTimeout(function () {
    	                                $('#myModal').modal('hide');
    	                            }, 1000);
                        		}
                        		else
                        		{
                        			$('#percent').html(data.percent+'%');
                        			var tjson={'no':data.no,'nextopenid':data.nextopenid};
                        			recurse(tjson);
                        		}
                        	}
                        	else
                        	{
	                            self.LoadUser(1);
	                            $('#ModalContent').html("同步成功！");
	                            setTimeout(function () {
	                                $('#myModal').modal('hide');
	                            }, 1000);
                        	}
                        } else {
                            $('#ModalContent').html(data.msg);
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
        self.WxOwnerOpenID = ko.observable();
        self.Contains = function (container, content) {
            return ("" + container).indexOf(content + "") > -1;
        }
    };
	
	var myroot = null;
	var m = new msgModel();
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixinpackage/html/wxuserlist.html?rand=" + Math.random(), function () {
            me.execCommand('initContentNav', root);
			curPage = 1;
			myroot = root[0];
			bindUIEvent();
			ko.applyBindings(m,myroot);
			m.LoadUser(curPage);
		});
    }
	
	function bindUIEvent() {
	    $(document, $(myroot)).on("click", myroot, function (e) {
	        var _this = $(e.target);
	        if (_this.hasClass("sex")) {
	            $("#sexText").text(_this.text());
	            $("#sex").val(_this.attr("data-val"));
	            e.stopPropagation();
	        }
	        if (_this.hasClass("GEdit")) {
	            var gid = _this.parent().attr("data-val");
	            var gname = _this.parent().attr('data-name');
	            var obj = $('<div id="dialog"><input type="text" id="GName" value="' + gname + '"/><input type="hidden" id="Gid" value="' + gid + '"/></div>');
	            $(obj).dialog({
	                modal: true, width: 350, height: 'auto', position: { my: "center", at: "center", of: window },
	                resizable: false,
	                buttons: {
	                    "保存": function () {
	                        gname = $("#GName").val();
	                        $.ajax({
	                            type: "POST",
	                           // url: "/admin/weixin/wxuserlist",
	                            url : "/index.php?c=admin/weixin/wxuserlist",
	                            cache: false,
	                            beforeSend: function (XMLHttpRequest) {
	                                $('#ModalContent').html("<span class='sending'><img src='/images/loading1.gif'/>正在修改分组!</span>");
	                                $('#myModal').modal();
	                            },
	                            dataType: "json",
	                            data: { action: "modify", groupid: gid, gname: gname },
	                            success: function (data) {
	                                if (data != null) {
	                                    if (data.success) {
	                                        console.log($("#GP" + gid).html(gname));
	                                        $('#ModalContent').html("<span class='sending'>修改成功!</span><i class='fa fa-check' style='font-size:2em;color:green;'></i>");
	                                        setTimeout(function () {
	                                            $('#myModal').modal('hide');
	                                        }, 1000);
	                                    } else {
	                                        $('#ModalContent').html("<span class='sending'><img src='/images/loading1.gif'/>修改失败!</span>");
	                                    }
	                                }
	                            },
	                            error: function (XMLHttpRequest, textStatus, errorThrown) {
	                                $('#ModalContent').html("<i class='fa fa-exclamation-triangle' style='color:red;font-size:30px;position:absolute;margin-top:-5px;'></i><span class='sending'>出错了，请重试!");
	                                console.log(XMLHttpRequest.responseText);
	                            }
	                        });
	                        $(this).dialog("close");
	                    },
	                    "取消": function () {
	                        $(this).dialog("close");
	                    }
	                },
	                close: function (event, ui) {
	                    $(this).dialog("destroy");
	                    $(this).remove();
	                }
	            });
	            e.stopPropagation();
	        }
	        if (_this.hasClass("GDel")) {
	            console.log(_this.parent().attr("data-val"));
	            var gid = _this.parent().attr("data-val");
	            $.ajax({
	                type: "POST",
	          //      url: "/admin/weixin/wxuserlist",
	                url: "/index.php?c=admin/weixin/wxuserlist",
	                async: true,
	                cache: false,
	                beforeSend: function (XMLHttpRequest) {
	                    $('#ModalContent').html("<span class='sending'><img src='/images/loading1.gif'/>正在修改分组!</span>");
	                    $('#myModal').modal();
	                },
	                dataType: "json",
	                data: { action: "delete", groupid: gid },
	                success: function (data) {
	                    if (data != null && data.success) {
	                        $("#DDG" + gid).remove();
	                        $('#ModalContent').html("<span class='sending'>删除成功!</span><i class='fa fa-check' style='font-size:2em;color:green;'></i>");
	                        setTimeout(function () {
	                            $('#myModal').modal('hide');
	                        }, 1000);
	                    }
	                },
	                error: function (XMLHttpRequest, textStatus, errorThrown) {
	                    $('#ModalContent').html("<i class='fa fa-exclamation-triangle' style='color:red;font-size:30px;position:absolute;margin-top:-5px;'></i><span class='sending'>出错了，请重试!");
	                    console.log(XMLHttpRequest.responseText);
	                }
	            });
	            e.stopPropagation();
	        }

	        if (_this.hasClass("changeGroup")) {
	            var openId = _this.attr("data-openid");
	            var gid = _this.attr("data-gid");
	            var gname = _this.text();
	            $.ajax({
	                type: "POST",
//	                url: "/admin/weixin/wxuserlist",
	                url: "/index.php?c=admin/weixin/wxuserlist", 
	                cache: false,
	                beforeSend: function (XMLHttpRequest) {
	                    $('#ModalContent').html("<span class='sending'><img src='/images/loading1.gif'/>正在变更分组!</span>");
	                    $('#myModal').modal();
	                },
	                dataType: "json",
	                data: { action: "changeGroup", openid: openId, groupid: gid },
	                success: function (data) {
	                    console.log(data);
	                    if (data != null) {
	                        if (data.success) {
	                            $("#Text" + openId).text(gname)
	                            $('#ModalContent').html("<span class='sending'>变更成功!</span><i class='fa fa-check' style='font-size:2em;color:green;'></i>");
	                            setTimeout(function () {
	                                $('#myModal').modal('hide');
	                            }, 1000);
	                        } else {
	                            $('#ModalContent').html("变更分组失败！");
	                        }
	                    }
	                },
	                error: function (XMLHttpRequest, textStatus, errorThrown) {
	                    $('#ModalContent').html("<i class='fa fa-exclamation-triangle' style='color:red;font-size:30px;position:absolute;margin-top:-5px;'></i><span class='sending'>出错了，请重试!");
	                    console.log(XMLHttpRequest.responseText);
	                }
	            });
	            e.stopPropagation();
	            return false;
	        }
	    });
	    $(document, $(myroot)).on("mouseover", myroot, function (e) {
	        var _this = $(e.target);
	        if (e.type == "mouseover") {
	            if (_this.hasClass("GEdit") || _this.hasClass("GDel")) {
	                e.stopPropagation();
	            }
	            if (_this.hasClass("selfGroup")) {
	                var option = $('<i class="GEdit"></i><del class="GDel"></del>');
	                _this.append(option);
	                _this.hover(null, function () {
	                    $(this).children().each(function () {
	                        if (!$(this).is("span")) {
	                            $(this).remove();
	                        }
	                    });
	                });
	            }
	        }
	    });

	    $(document, $(myroot)).off('click.WxOwner').on('click.WxOwner', '.btnSetWxOwner, .btnCancelWxOwner', function (evt) {
	        var data = {
	            enable: $(this).attr('enable') == '1' ? 1 : 0,
	            openid: $(this).attr('data-openId')
	        }

	        $.ajax({
	            type: 'post',
//	            url: '/admin/weixin/WxUserList?act=SetWxOwner',
	            url: '/index.php?c=admin/weixin/wxuserlist&a=setwxowner',
	            data: data,
	            dataType: 'json',
	            success: function (json) {
	                if (!json.success) {
	                    alert(json.msg);
	                    return;
	                }
	                alert("设置成功");
	                me.execCommand('go', { a: 'weixin', b: 'wxuserlist', params: { t: new Date().getTime() } });
	            },
	            error: function (req) {
	                alert(req.responseText);
	            }
	        });
	        evt = evt == window.event;
	        evt.cancelbubble = true;
	        if (evt.preventDefault) evt.preventDefault();
	        return false;
	    });

	    $(document, $(myroot)).off('mouseenter.WxOwner').on('mouseenter.WxOwner', '.UserList li', function (evt) {
	        var enable = $(this).find('.wxOwnerFlag').css('display') != 'none';
	        if (enable) {
	            //$(this).find('.btnCancelWxOwner').show();
	        } else {
	            $(this).find('.btnSetWxOwner').show();
	        }
	    }).off('mouseleave.WxOwner').on('mouseleave.WxOwner', '.UserList li', function () {
	        $(this).find('.btnSetWxOwner').hide();
	    });
	    
	}

    me.addListener('wxuserlist', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['discounting'] = function () {
    var me = this, url = "/index.php?c=admin/weiyx/discounting";
    Date.prototype.AddDays = function (day) {
        this.time = this.valueOf();
        if (day && !isNaN(day)) {
            this.time += (day * 60 * 60 * 24 * 1000);
        }
        this.nd = new Date(this.time);
        this.setYear(this.nd.getFullYear());
        this.setMonth(this.nd.getMonth());
        this.setDate(this.nd.getDate());
        this.setHours(this.nd.getHours());
        this.setMinutes(this.nd.getMinutes());
        this.setSeconds(this.nd.getSeconds());
        this.setMilliseconds(this.nd.getMilliseconds());
    }
    Date.prototype.FormatString = function () {
        this.date = this.valueOf();
        this.dt = new Date(this.date);
        return [this.dt.getFullYear(), "-", this.dt.getMonth() + 1, "-", this.dt.getDate(), " ", this.dt.getHours(), ":", this.dt.getMinutes(), ":00"].join("");
    }

    var voteModel = function () {
        var self = this;
        self.setData = function (data) {
            for (var key in data) {
                if (typeof (data[key]) == "object")
                { this[key] = ko.observableArray(data[key]); }
                else {
                    this[key] = ko.observable(data[key]);
                }
            }
        };
        self.AwardList = ko.observableArray([]);
        self.key = ko.observable();
        self.link = ko.observable();
        self.Format = function (n) {
            return n().replace(/T/g, " ");
        };
    };
    var vm = new voteModel();
    function LoadProductList(pid) {
        $.ajax({
            type: "POST",
            url: url,
            cache: false,
            context: null,
            beforeSend: function (XMLHttpRequest) {
                this;
            },
            dataType: "json",
            // data: { 'act': 'ProductList' },
            data: { 'a': 'ProductList' },
            success: function (data) {
                console.log(data);
                if (data.success) {
                    var html = [];
                    $.each(data.list, function (i, n) {
                        if (n.ProductID === pid) {
                            console.log(pid)
                            $("#CurProduct").text(n.Name);
                        }
                        html.push('<li><a class="product" href="javascript:void(0);" data-id="', n.ProductID, '" data-price="', n.Price, '" data-costprice="', n.CostPrice, '" data-count="', n.ProductQuantity, '">', n.Name, '</a></li>');
                    });
                    $('#Product').html(html.join(''));
                }
            },
            complete: function (XMLHttpRequest, textStatus) {
                this;
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    };
    function LoadInfo(id) {
        $.ajax({
            type: "POST",
            url: url,
            cache: false,
            dataType: "json",
            // data: { 'act': 'GetInfo', 'id': id },
            data: { 'a': 'GetInfo', 'id': id },
            success: function (data) {
                console.log(data);
                if (data.success) {
                    console.log(data.info);
                    vm.setData(data.info);
                    vm.key(data.key);
                    vm.link(data.link);
                    $("#WxShow").attr("src", data.info.WxImage);
                    $('<img style="width:200px;height:200px;border:solid 10px #fff;" src="/index.php?c=admin/weiyx/discounting&a=qrcode&id=' + data.info.Did + '"/>').appendTo($(".qrcode"));

                    if (data.info.DiscType == 1) {
                        $(".MaxRedPack").removeClass("none");
                        $("#MinText").text("最小砍价金额");
                    } else {
                        $(".MaxRedPack").addClass("none");
                        $("#MinText").text("固定砍价金额");
                    }

                    LoadProductList(data.info.ProductId);
                    ko.applyBindings(vm, document.getElementById("voteTabs"));

                    initUE();
                    setTimeout(function () {
                        var viewBody = $(window.frames["frameView"].document.body);
                        viewBody.find("#BePrice").html("底价: ￥" + (data.info.BasePrice/100) + "(库存:"+data.info.ProductCount+")");
                        viewBody.find("#OrPrice").html("原价:￥" + (data.info.Price/100));
                        viewBody.find("#PName").text("产品名称产品名称产品名称");
                        viewBody.find(".swiper-wrapper").html('<div class="swiper-slide"><img src="/images/fullswitch/bg1.jpg"/></div>');
                    }, 1000);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    };
    function BindUpLoadImg(args) {
        $('.uploadBtn,.BtnCover', args).off("click").on('click', function (e) {
            var _this = $(this);
            var _thisInput = _this.prev();

            YDM.FileManager('image', 1, function (aUrl) {
                if (aUrl.length > 0) {
                    if (_thisInput.is("input") && _thisInput.attr("id")) {
                        var viewBody = $(window.frames["frameView"].document.body);
                        switch (_thisInput.attr("id").toLowerCase()) {
                            case "wximage": {
                                if (_this.next().is("img")) {
                                    _this.next().attr("src", aUrl[0]);
                                } else {
                                    _this.after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", aUrl[0]));
                                }
                                break
                            }
                        }
                        _thisInput.val(aUrl[0]);
                    }
                }
            })
        });
    };
    function initFormEvent() {
        ///当前时间与传入的时间比较
        jQuery.validator.addMethod("CKDate", function (value, element, params) {
            var ereg = /^(\d{1,4})(-|\/)(\d{1,2})(-|\/)(\d{1,2})(\s{1})(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            var s = value.match(ereg);
            if (s == null) {
                return false;
            }
            var e = $(params).val().match(ereg);
            var sDate = Number(new Date(s[1], s[3] - 1, s[5], s[7], s[8], s[9]).valueOf());
            var eDate = Number(new Date(e[1], e[3] - 1, e[5], e[7], e[8], e[9]).valueOf());
            return this.optional(element) || ((sDate - eDate) > 0);
        }, jQuery.validator.format("当前时间不能早于{0}的时间."));
        jQuery.validator.addMethod("IsDate", function (value, element) {
            var ereg = /^(\d{1,4})(-|\/)(\d{1,2})(-|\/)(\d{1,2})(\s{1})(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            var r = value.match(ereg);
            if (r == null) {
                return false;
            }
            var d = new Date(r[1], r[3] - 1, r[5], r[7], r[8], r[9]);
            var result = (d.getFullYear() == r[1] && (d.getMonth() + 1) == r[3] && d.getDate() == r[5] && d.getHours() == r[7] && d.getMinutes() == r[8] && d.getSeconds() == r[9]);
            return this.optional(element) || (result);
        }, "请输入正确的日期");
        jQuery.validator.addMethod("CKPrice", function (value, element, params) {
            return this.optional(element) || parseFloat(value) > parseInt($(params).val());
        }, jQuery.validator.format("售价不能低于底价."));
        jQuery.validator.addMethod("MinMax", function (value, element, params) {
            return this.optional(element) || $(".MaxRedPack").hasClass("none") || parseFloat(value) > parseInt($(params).val());
        }, jQuery.validator.format("."));

        $("#MainForm").validate({
            invalidHandler: function () {
                $(".gray").removeClass("gray");
                $("#voteTabs").tabs({ active: 0 });
            },
            rules: {
                Title: "required"
				, WxImage: "required"
                , ProductCount: { required: true, digits: true }
				, ProductId: { required: true, digits: true }
                , BasePrice: { required: true, number: true, min: 0 }
                , Price: { required: true, number: true, CKPrice: "#BasePrice" }
                , MinValue: { required: true, number: true }
                , MaxValue: { required: true, number: true, MinMax: "#MinValue" }
                , Description: "required"
				, SDate: { required: true, IsDate: true }
				, EDate: { required: function () { return $("#SDate").val() != ""; }, IsDate: true, CKDate: "#SDate" }
            },
            messages: {
                Title: "请输入活动标题！"
				, WxImage: "请上微信传封面图！"
                , ProductCount: { required: "请输入活动产品数量", digits: "只能输入数值" }
				, ProductId: { required: "请选择产品", digits: "产品不正确！" }
                , BasePrice: { required: "请输入产品底价", number: "价格只能为数值", min: "价格不能小于0" }
                , Price: { required: "请输入产品售价", number: "价格只能为数值", CKPrice: "售价不能低于底价" }
                , MinValue: { required: "请输入砍价金额", number: "金额只能输入数值" }
                , MaxValue: { required: "请输入最大随机金额", number: "金额只能输入数值", MinMax: "最大随机金额不能小于最小金额！" }
                , Description: "请输入活动简介"
				, SDate: { required: "请输入活动开始时间！", IsDate: "正确的日期格式：2015-01-01 12:00:00" }
				, EDate: { required: "请输入活动结束时间！", IsDate: "正确的日期格式：2015-01-01 18:00:00", CKDate: "结束时间不能早于开始时间！" }
            },
            submitHandler: function (form) {
                submitForm();
                return false;
            },
            ignore: []
        });
		
		$("<div></div>").appendTo(myroot).load("/admin/widget/WxPaySetting.html?v=" + Math.random(), function(){
			$('.btnShowWxPaySetting').wxPaySetting();
		});
    };
    function submitForm() {
        // var params = $('#MainForm').serialize() + "&act=Save";
        var params = $('#MainForm').serialize() + "&a=Save";
        $.post(url, params, function (data, textStatus, jqXHR) {
            if (data.success) {
                $('<div id="success">保存成功</div>').dialog({
                    modal: true, width: 400, close: function () {
                        $("#success").dialog("destroy");
                        me.execCommand('go', { a: 'weixy', b: 'discountlist' });
                    }
                });
            } else {
                $('<div id="error">' + data.msg + '</div>').dialog({
                    modal: true, width: 400, title: "保存失败", close: function () { $("#error").dialog("destroy"); }
                });
            }
        }, "json");
    };
    var myroot = null;
    this.addListener('discounting', function (key, args) {
        args.loadHtmlTpl("plugins/weixypackage/html/discounting.html?v=" + Math.random(), function () {

            myroot = args[0];

			if (!me.hasLicensePerm('ENABLE_JIFEN')){
				$("input,select",myroot).each(function(i,item){
					if(($(item).attr("name") + "").indexOf("JiFen") > -1){
						$(item).prop("readonly",true);
						$(item).css("height","50px");
						if($(item)[0].tagName == 'SELECT') $(item).hide();
					}
				});
				$("#forJiFenIn,#forJiFenOut").each(function(i,item){
					$(item).html($(item).html() + " <font color='red'><br>当前版本不支持积分功能，请升级到旗舰版以上</font>");
				});
			}

            $("#voteTabs").tabs();
            $('#SDate,#EDate').datetimepicker({
                dayOfWeekStart: 1,
                lang: 'ch',
                format: 'Y-m-d H:i:00'
            });
            BindUpLoadImg(args);
            initFormEvent();
            BindOnEvent();
            $("#voteTabs").on("tabsactivate", function (event, ui) {
                this.index = $("#voteTabs").tabs("option", "active");
                var viewBody = $(window.frames["frameView"].document.body);
                viewBody.find("section").hide();
                if (this.index == 1) {
                    viewBody.find("#Detail").show();
                } else if (this.index == 2) {
                    viewBody.find("#Join").show();
                } else {
                    viewBody.find("#Home").show();
                }
            });
            if (me.currentModule.params && me.currentModule.params.id) {
                LoadInfo(me.currentModule.params.id);
                $(".IsEdit").show();
                $("#LinkMenu").off("click").on("click", function () {
                    me.execCommand('go', { a: 'weixin', b: 'wxmenu' });
                });
            } else {
                this.date = new Date();
                $("#SDate").val(this.date.FormatString());
                this.date.AddDays(10);
                $("#EDate").val(this.date.FormatString());

                initUE();
                $("#link").attr("disabled", 'disabled').val("保存后才可以生成相应的链接！");
                initCustomForm();
                LoadProductList();
            }

            if ($("#WxImage").val() != "") {
                if ($(".BtnCover").next().is("img")) {
                    $(".BtnCover").next().attr("src", $("#WxImage").val());
                } else {
                    $(".BtnCover").after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", $("#WxImage").val()));
                }
            }

			if(!me.hasLicensePerm("ENABLE_WEIKANJIA") && window["WeikanjiaAdModalShow"] != 1){
				$("#WeikanjiaAdModal2").modal();
				window["WeikanjiaAdModalShow"] = 1;
				return;
			}

        });
    });
    function BindOnEvent() {
        $('input[name="DiscType"]').off("click.xxx").on("click.xxx", function () {
            console.log($(this).val());
            if ($(this).val() == 0) {
                $(".MaxRedPack").addClass("none");
                $("#MinText").text("固定砍价金额");
            } else {
                $(".MaxRedPack").removeClass("none");
                $("#MinText").text("最小砍价金额");
            }
        });
        $("input[type='text']").on("keyup focus", function (e) {
            var viewBody = $(window.frames["frameView"].document.body);
            var _this = $(e.target);
            if ("productcount" == _this.attr("id").toLowerCase()) {
                viewBody.find("#BePrice").html("底价: ￥" + $("#BasePrice").val() + "(库存:" + _this.val() + ")");
                e.preventDefault();
            }
            if ("baseprice" == _this.attr("id").toLowerCase()) {
                viewBody.find("#BePrice").html("底价: ￥" + _this.val() + "(库存:" + $("#ProductCount").val() + ")");
                e.preventDefault();
            }
            if ("price" == _this.attr("id").toLowerCase()) {
                viewBody.find("#OrPrice").html("原价:￥" + _this.val());
                e.preventDefault();
            }
        });
        $(document).off("click.xxxx").on("click.xxxx", function (e) {
            var _this = $(e.target);
            if (_this.hasClass("upImage")) {
                YDM.FileManager('image', 1, function (aUrl) {
                    var index = _this.attr("data-val");
                    $("#image" + index).val(aUrl[0]);
                    $("#show" + index).attr("src", aUrl[0]).show();
                });
            };
            if (_this.hasClass("imgshow")) {
                $('<div></div>').dialog({
                    modal: true, width: 680, height: 600, position: { my: "center center", at: "center center", of: window },
                    open: function (event, ui) {
                        $(this).append('<img src="' + _this.attr("src") + '" style="width:100%"/>');
                    },
                    close: function () {
                        $(this).dialog("destroy");
                    }
                });
            };
            if (_this.hasClass("product")) {
                $("#ProductId").val(_this.data("id"));
                $("#BasePrice").val(_this.data("costprice"));
                $("#Price").val(_this.data("price"));
                $("#CurProduct").text(_this.text());
                $("#ProductCount").val(_this.data("count"));
            };
        });
    };
    var ue = null;
    function initUE() {
        var html = $('#Detail').val() == "" ? "活动规则：<br/>活动范围：<br />活动人群：<br />" : $('#Detail').val();
        ue = new baidu.editor.ui.Editor({
            toolbars: [[
                'removeformat', 'bold', 'italic', 'underline', 'strikethrough'
                , 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
                , 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', 'link', 'unlink'
            ]]
        });

        ue.render('Detail');
        ue.ready(function () {
            ue.setContent(UE.utils.html(html));
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#content").html(ue.getContent());
        });
        ue.addListener('contentChange', function (editor) {
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#content").html(ue.getContent());
            viewBody.find("#ProductDetail").html("产品详情……");
        });
    }
    function initCustomForm(formid, formname) {
        $("#selfForm").html("<iframe name='customFormFrame' src='widget/customform.html?FormID=" + formid + "&FormName=" + formname + "&HideSaveBtn=1&HideTitle=1' frameborder='0' width='100%' height='400'></iframe>");
    };

};
﻿IWF.plugins['discountlist'] = function () {

    // var me = this, url = "/admin/weixy/discounting";
    var me = this, url = "/index.php?c=admin/weiyx/discounting";
    var ViewModel = function () {
        var self = this;
        self.datalist = ko.observableArray();
        self.WeiXinId = ko.observable();
        self.State = function (obj, e) {
            $.ajax({
                type: "POST",
                url: url,
                cache: false,
                context: $(e.target),
                dataType: "json",
                // data: { 'act': 'SetState', 'id': obj.Did, 'state': obj.State },
                data: { 'a': 'SetState', 'id': obj.Did, 'state': obj.State },
                success: function (data) {
                    if (data.success) {
                        $(this)[obj.State ? "addClass" : "removeClass"]("glyphicon-eye-close");
                        $(this)[obj.State ? "removeClass" : "addClass"]("glyphicon-eye-open");
                        obj.State = obj.State ? 0 : 1;
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
        self.showImage = function (t) {
            var image = "";
            $.each(me.Party, function (i, o) {
                if (o.type == t) {
                    image = o.image;
                    return;
                }
            });
            return image;
        }
        this.getTime = function (time) {
            return time.replace(/T/gi, "\r\n").replace(/(\.\d+)/, "");
        }
    };

    var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/discountlist.html", function () {
			
			bindUIEvent();
            ko.applyBindings(vm, root[0]);
            loadList(1);

			if(!me.hasLicensePerm("ENABLE_WEIKANJIA") && window["WeikanjiaAdModalShow"] != 1){
				$("#WeikanjiaAdModal").modal();
				window["WeikanjiaAdModalShow"] = 1;
				return;
			}
        });
    }

    var curpage = 1;
    var itemcount = 0;
    function loadList(page) {

        // var params = { 'act': 'DataList', keyword: $("#keyword").val(), page: page, pagesize: 20 };
        var params = { 'a': 'DataList', keyword: $("#keyword").val(), page: page, pagesize: 20 };
        $.getJSON(url, params, function (json) {
            console.log(json);
            vm.datalist(json.list)
            vm.WeiXinId(json.wxid);
            curpage = json.curpage;
            itemcount = json.list ? json.list.length : 0;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadList(page); });
                $("#pagination").show();
            }
            bindGridEvent();
        });
    }

    function bindUIEvent() {
        $("#BtnSearch").unbind('click').bind('click', function (event) {
            loadList(1);
        });
    }

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).data("id") }
            me.execCommand('go', { a: 'weixy', b: 'discounting', params: params });
            return false;
        });

        $("*[name=BtnGoJoin]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).data("id") }
            me.execCommand('go', { a: 'weixy', b: 'discountuser', params: params });
            return false;
        });
        $("*[name=BtnOrder]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).data("id") }
            me.execCommand('go', { a: 'weixy', b: 'discountorders', params: params });
            return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
            if (!confirm("确认删除？")) return false;
            // $.getJSON(url, { 'act': 'Delete', id: $(this).data("id") }, function (json) {
            $.getJSON(url, { 'a': 'Delete', id: $(this).data("id") }, function (json) {
                if (json.success) {
                    if (itemcount > 1)
                        loadList(curpage);
                    else loadList(1);
                } else {
                    $.showResult("出错啦", json.msg);
                }
            });
            return false;
        });
        $(".QrCode").mouseover(function () {
            // var img = $('<img class="QRCode" style="position:absolute;width:150px;height:150px;top:-60px;z-index:10;border:solid 10px #fff;" src="/admin/weixy/discounting?act=qrcode&id=' + $(this).data("val") + '"/>')
            var img = $('<img class="QRCode" style="position:absolute;width:150px;height:150px;top:-60px;z-index:10;border:solid 10px #fff;" src="/index.php?c=admin/weiyx/discounting&a=qrcode&id=' + $(this).data("val") + '"/>')
            $(this).parent().append(img);
        }).mouseout(function () {
            $(".QRCode").remove();
        });
    }

    me.addListener('discountlist', function (key, args) {
        args.addClass('row');
        initUI(args);

    });
}

﻿IWF.plugins['discountuser'] = function () {
    var me = this;
    // var url = "/admin/weixy/discounting", id = "", curpage = 1, rcsize = 10, pagesize = 10;
    var url = "/index.php?c=admin/weiyx/discounting", id = "", curpage = 1, rcsize = 10, pagesize = 10;
    var ucur = 1, csize = 10, unavsize = 5;
    var UserLog = function () {
        this.List = ko.observableArray([]);
        this.BitImage = function (img) {
            return img ? img.replace(/\/0$/ig, '/132') : "";
        }
        this.getTime = function (time) {
            return time ? time.replace(/T/gi, " ").replace(/(\.\d+)/, "") : "";
        }
    };
    var vUser = new UserLog();
    var ViewModel = function () {
        var self = this;
        self.SortIndex = ko.observable(0);
        self.UserList = ko.observableArray([]);
        self.BitImage = function (img) {
            return img ? img.replace(/\/0$/ig, '/132') : "";
        }
        self.getTime = function (time) {
            return time ? time.replace(/T/gi, " ").replace(/(\.\d+)/, "") : "";
        }
        self.LoadUserList = function () {
            $.ajax({
                type: "POST",
                url: url,
                // data: { 'act': 'UserList', 'id': id, 'cur': curpage, 'rcsize': rcsize },
                data: { 'a': 'UserList', 'id': id, 'cur': curpage, 'rcsize': rcsize },
                cache: false,
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    if (data) {
                        if (data.success) {
                            vm.UserList(data.list);
                            var pageCount = Math.floor(data.recordCount / rcsize);
                            pageCount = (data.recordCount % rcsize) > 0 ? pageCount + 1 : pageCount;
                            $("#pageCount").text(pageCount);
                            $("#rcCount").text(data.recordCount);
                            $("#pagination").pageNav(curpage, pageCount, pagesize, function (page) {
                                curpage = page;
                                self.LoadUserList();
                            });
                            if (curpage > 0) {
                                self.SortIndex(rcsize * (curpage - 1));
                            }
                        } else {
                            console.log(data.msg);
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
        self.Del = function (obj) {
            if (!confirm("确认删除？")) return false;
            // $.getJSON(url, { 'act': 'DeleteUser','id':obj.Did,'duid':obj.DUid, 'uid': obj.UGuid }, function (data) {
            $.getJSON(url, { 'a': 'DeleteUser','id':obj.Did,'duid':obj.DUid, 'uid': obj.UGuid }, function (data) {
                if (data && data.success) {
                    vm.LoadUserList();
                } else {
                    $.showResult("出错啦", data.msg);
                }
            });
        };
        self.PriceList = function (obj) {
            $.ajax({
                type: "POST",
                url: url,
                cache: false,
                beforeSend: function (XMLHttpRequest) {
                    this; // 调用本次AJAX请求时传递的options参数
                },
                dataType: "json",
                // data: { 'act': 'UserLog', 'id': obj.Did, 'uid': obj.UGuid, 'cur': ucur, 'rcsize': csize },
                data: { 'a': 'UserLog', 'id': obj.Did, 'uid': obj.UGuid, 'cur': ucur, 'rcsize': csize },
                success: function (data) {
                    console.log(data);
                    if (data.success) {
                        vUser.List(data.list);
                        $("#myModal").modal();
                        var pageCount = Math.floor(data.rcount / csize);
                        pageCount = (data.rcount % rcsize) > 0 ? pageCount + 1 : pageCount;
                        //Navpage
                        $("#Navpage").pageNav(ucur, pageCount, unavsize, function (page) {
                            console.log(page);
                            ucur = page;
                            self.PriceList(obj);
                        });
                    }
                },
                complete: function (XMLHttpRequest, textStatus) {
                    this; // 调用本次AJAX请求时传递的options参数
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
    };
    var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/discountuser.html", function () {
            id = me.currentModule.params.id;
            curpage = 1;
            ko.applyBindings(vm, document.getElementById("showListTable"));
            ko.applyBindings(vUser, document.getElementById("myModal"));
            vm.LoadUserList();
        });
    }
    me.addListener('discountuser', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}
﻿IWF.plugins['galleryedit'] = function () {

    var me = this;

    var ViewModel = function () {
        this.setData = function (data) {
            for (var key in data) {
                this[key] = data[key];
            }
        };
		this.showImage = function (image) {
			image = "<img src='"+ image +"' width='360'>";
			$("#ImgPreview").show();
	        return image;
	    }
        this.getTime = function (time) {
			if(/^(1970)/.test(time)) return "";
            return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
        }
    };
    
    var vm = new ViewModel();
    var myroot = null;
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/galleryedit.html", function () {
            myroot = root[0];
			initFormEvent();
			$("#handleweixin",myroot).off().on("click",function(){ showPreviewPage("weixin") });
			$("#handlegallery",myroot).off().on("click",function(){ showPreviewPage("gallery") });
			$("#prevBtn,#nextBtn").off().on("click",function(){ showPreviewPage() });
			$("#gallery-tabs",myroot).tabs();
			$("#Title",myroot).unbind().change(function(){$(myroot).find("#weixintitle").html($(this).val())});
			$("#Banner",myroot).unbind().change(function(){ $(myroot).find("#weixinimage").prop("src",$(this).val())});
						
			$('#Banner',myroot).on('click', function () {
                YDM.FileManager('image', 1, function (aUrl) {
                    if (aUrl.length > 0) {
                        $('#Banner').val(aUrl[0]);
						$('#Banner').trigger('change');
                        $('#ImgPreview').html("<img src='"+ aUrl[0] +"' width='360'>").show();
                    }
                })
            });
			
            if (me.currentModule.params && me.currentModule.params.id) loadInfo();
			else{
				showPreviewPage();
			}
        });
    }

    function initFormEvent() {
        $("#MainForm",myroot).validate({
            invalidHandler: function () {
                $(".gray").removeClass("gray");
            },
            rules: {
                Title: "required"
				, Banner: "required"
				, Intro: "required"
            },
            messages: {
                Title: { required: "请输入标题！" }
				, Banner: "请选择封面"
				, Intro: "请输入简介"
            },
            submitHandler: function (form) {
                submitForm();
                return false;
            },
			errorPlacement: function(error, element) {
			   error.insertAfter(element);
			   var id = element.closest(".ui-tabs-panel").attr("id");
			   $("#gallery-tabs",myroot).tabs("option", "active", 0);
		   },
			ignore: []
        });
    }

	function showPreviewPage(){
		var title = $("#Title",myroot).val();
		var image = $("#Banner",myroot).val();
		if(!title) title = "相册标题";
		if(!image) image = "/images/hudongimg/gallery.jpg";
		$("#previewframe").html('<center style="padding:10px"><img src="'+ image +'" id="weixinimage" width="100%"><div style="background:#EEEEEE;text-align:left;color:#333333;padding-left:20px;padding:5px;"><b id="weixintitle">'+ title +'</b></div></center>');
	}
	
	var ue = null;
	function initUE() {
	    try {
	        ue = new baidu.editor.ui.Editor({
				initialFrameWidth: "360",
	            initialFrameHeight: "350",
	            autoHeightEnabled: true,
	            toolbars: [[
                     'bold', 'italic', 'underline', 'strikethrough', 'removeformat'
					, 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
					, 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify'
					, 'imagenone', 'imageleft', 'imageright', 'imagecenter'
	            ]]
	        });
	        ue.ready(function () {
	            ue.setContent($("#Detail", myroot).val());
	        });
	        ue.render('editor');
		} catch (e) {
		    console.log("error: " + e);
		}
	}
		
    function loadInfo() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        console.log(params);
        // $.getJSON("/admin/weixy/gallerymanage?act=GetInfo", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/gallery&a=GetInfo", utils.params(params), function (json) {
            vm.setData(json);
            ko.applyBindings(vm, myroot);
			// var qrcodesrc = "/admin/weixy/gallerymanage?act=qrcode&id=" + json.info.ID;
            var qrcodesrc = "/index.php?c=admin/weiyx/gallery&a=QRCode&id=" + json.info.ID; 
			$("#ImgQrcode",myroot).html("<img src='"+ qrcodesrc +"' width='138'/>");
			$("#BtnWeixinMenu",myroot).removeClass("disabled");
			$("#LabWeixinMenu",myroot).hide();
			$("#WallUrl",myroot).prop("rows",3);
			showPreviewPage();
        });
    }
		
	function submitForm() {
        var params = $('#MainForm').serializeObject();
        // $.post("/admin/weixy/gallerymanage?act=Edit", params, function (data, textStatus, jqXHR) {
        $.post("/index.php?c=admin/weiyx/gallery&a=Edit", params, function (data, textStatus, jqXHR) {
            if (data.success) {
                $('<div id="success">保存成功</div>').dialog({
                    modal: true, width: 400, close: function () {
                        $("#success").dialog("destroy");
                        me.execCommand('go', { a: 'weixy', b: 'gallerylist'});
                    }
                });
            } else {
                $('<div id="error">'+data.msg+'</div>').dialog({
                    modal: true, width: 400,title:"保存失败", close: function () { $("#error").dialog("destroy"); }
                });
            }
        }, "json");
    }

    me.addListener('galleryedit', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['gallerylist'] = function () {

    var me = this;

	var ViewModel = function () {
	    this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
		this.showImage = function (image) {
	        return image;
	    }
		this.getTime = function(time){
			if(/^(1970)/.test(time)) return "不限制结束时间";
			return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
		}
    };

	var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/gallerylist.html",function(){
			// $("#linkGallery").text("http://"+ getDomain() +"/gallery");
            $("#linkGallery").text("http://"+ getDomain() +"/index.php?c=front/GalleryIndex");   
			bindUIEvent();
			ko.applyBindings(vm,root[0]);
			loadgallerylist(1);	
        });
    }
	    
	var curpage = 1;
	var itemcount = 0;
    function loadgallerylist(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(),page: page, pagesize: 20 };
        // $.getJSON("/admin/weixy/gallerymanage?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/gallery&a=GetList", utils.params(params), function (json) {
            vm.setData(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadgallerylist(page); });
                $("#pagination").show();
            }
            bindGridEvent();
        });
    }

    function bindUIEvent() {
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadgallerylist(1);
        });
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("GalleryID") };
			me.execCommand('go', { a: 'weixy', b: 'galleryedit', params: params });
			return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			// $.getJSON("/admin/weixy/gallerymanage?act=Delete", utils.params({id:$(this).attr("GalleryID")}), function (json) {
            $.getJSON("/index.php?c=admin/weiyx/gallery&a=Delete", utils.params({id:$(this).attr("GalleryID")}), function (json) { 
				if(json.success){
					if(itemcount > 1) loadgallerylist(curpage);
					else loadgallerylist(1);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnUploadGallery]").unbind('click').bind('click', function (event) {
			var params = {id: $(this).attr("GalleryID") };
            me.execCommand('go', { a: 'weixy', b: 'galleryupload', params: params });
			return false;
        });

		$("*[name=BtnSetStatus]").unbind('click').bind('click', function (event) {
			// $.getJSON("/admin/weixy/gallerymanage?act=setstatus", utils.params({id:$(this).attr("GalleryID"),status: $(this).attr("Status")}), function (json) {
            $.getJSON("/index.php?c=admin/weiyx/gallery&a=SetStatus", utils.params({id:$(this).attr("GalleryID"),status: $(this).attr("Status")}), function (json) { 
				if(json.success){
					loadgallerylist(curpage);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
		});
		
        $(".fa-qrcode").mouseover(function () {
			var maxh = $("#showListTable").position().top;
			$("#divQRCodePreview").remove();
			// var qrcodesrc = "/admin/weixy/gallerymanage?act=qrcode&id=" + $(this).attr("data-val");
            var qrcodesrc = "/index.php?c=admin/weiyx/gallery&a=QRCode&id=" + $(this).attr("data-val"); 
			var html = "<div id='divQRCodePreview' class='divQRCodePreview' style='padding:5px;border:1px solid #cccccc;background:white;position:absolute;z-index:999'>";
			html += "<img src='"+ qrcodesrc +"' width='150'/>";
			html += "</div>";
			$("body").append(html);
			var top = $(this).offset().top + 20;
			if(top + $("#divQRCodePreview").height() > maxh) top = $(this).offset().top - $("#divQRCodePreview").height();
			$("#divQRCodePreview").css({top:top,left:$(this).offset().left + 20});
			
		}).mouseout(function () {
		    $("#divQRCodePreview").remove();
		});
    }

    me.addListener('gallerylist', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['galleryupload'] = function () {

    var me = this;
    
	var ViewModel = function () {
        this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
		this.getImage = function(image){
			var imgsrc = "/comdata/"+ getCookie("InitSiteID") +"/gallery/" + image;
			return imgsrc;
		};
    };

    var myroot = null;
	var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
		var initfunc = function(){
			root.loadHtmlTpl("plugins/weixypackage/html/galleryupload.html", function () {
				myroot = root[0];
				initSwfUpload();
				bindGridEvent();

				$(".fa-qrcode").mouseover(function () {
					var maxh = $("#linkPreview").position().top;
					$("#divQRCodePreview").remove();
					// var qrcodesrc = "/admin/weixy/gallerymanage?act=qrcode&id=" + $(this).attr("data-val");
                    var qrcodesrc = "/index.php?c=admin/weiyx/gallery&a=QRCode&id=" + $(this).attr("data-val"); 
					var html = "<div id='divQRCodePreview' class='divQRCodePreview' style='padding:5px;border:1px solid #cccccc;background:white;position:absolute;z-index:999'>";
					html += "<img src='"+ qrcodesrc +"' width='150'/>";
					html += "</div>";
					$("body").append(html);
					var top = $(this).offset().top + 20;
					if(top + $("#divQRCodePreview").height() > maxh) top = $(this).offset().top - $("#divQRCodePreview").height();
					$("#divQRCodePreview").css({top:top,left:$(this).offset().left + 20});
					
				}).mouseout(function () {
					$("#divQRCodePreview").remove();
				});

				if (me.currentModule.params && me.currentModule.params.id) loadInfo();
				ko.applyBindings(vm,$("#gridtbody")[0]);
				loadList();
			});
		}
		initfunc();
    }
	
    function loadInfo() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        // $.getJSON("/admin/weixy/gallerymanage?act=GetInfo", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/gallery&a=GetInfo", utils.params(params), function (json) {
            ko.applyBindings(json.info, $("#GalleryInfo")[0]);
			$("#linkPreview").attr("href","/index.php?c=front/Gallery&id=" + json.info.ID);
			$("#linkPreview").text("http://"+ location.host +"/index.php?c=front/Gallery&id=" + json.info.ID);
        });
    }

	function loadList() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        // $.getJSON("/admin/weixy/gallerymanage?act=GetImageList", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/gallery&a=GetImageList", utils.params(params), function (json) {
			$("#gridtbody").children().remove();
            vm.setData(json.list);
			bindGridEvent();
        });
    }

	var swfu;
	function initSwfUpload(){
		if ($("#swfUploadPlaceholder").is("span")) {
			var params = {};
			if(me.currentModule.params && me.currentModule.params.id) params["id"] = me.currentModule.params.id;
			params['ssid'] = getCookie("sid") || '';
            swfu = new SWFUpload({
                // upload_url: "/admin/weixy/gallerymanage?act=UploadImg&InitSiteID=" + getCookie('InitSiteID'),
                upload_url: "/index.php?c=admin/weiyx/gallery&a=UploadImg&InitSiteID=" + getCookie('InitSiteID'),
                post_params: params,
                file_size_limit: "3 MB",
                file_types: "*.jpg;*.gif;*.png",
                file_types_description: "Image Files",
                /*file_upload_limit: "5",*/
                file_queue_error_handler: fileQueueError,
                file_dialog_complete_handler: fileDialogComplete,
                upload_progress_handler: uploadProgress,
                upload_error_handler: uploadError,
                upload_success_handler: uploadSuccess,
                upload_complete_handler: uploadComplete,
                button_image_url: "/images/swfuplod-bg.gif",
                button_placeholder_id: "swfUploadPlaceholder",
                button_width: 96,
                button_height: 34,
                button_text: '<b><font color="#ffffff">添加图片</font></b>',
                button_text_top_padding: 8,
                button_text_left_padding: 5,
                button_window_mode: SWFUpload.WINDOW_MODE.OPAQUE,
                flash_url: "/share/swfupload.swf",
                custom_settings: {
                    upload_target: "FileProgressContainer"
                },
                debug: false
            });
        }
	}

	function uploadSuccess(file, serverResponse) {
        try {
			console.log(this);
			eval("var data = " + serverResponse);
            if(data.success){
				addImg(data.fileName);
			}else{
				$.showResult("错误",data.msg);
			}
            var progress = new FileProgress(file, this.customSettings.upload_target);
            progress.setStatus("Thumbnail Created.");
            progress.toggleCancel(false);
        } catch (ex) {
            this.debug(ex);
        }
    }

	function addImg(image){
		loadList();
	}

	function bindGridEvent(){
		$("#btnSave").unbind().bind('click',function(){
			submitForm();
		});

		$("*[btnUpload=1]").unbind().bind('click',function(){
			var obj = $(this);
			$("#Filedata").click();
			$("#Filedata").unbind().change(function(){
				if($("#Filedata").val() != "") singleUpload(obj);
			});
		});
		
		$("#gridtbody").sortable({
			handle: ".image > img",
			start: function (event, ui) {
				ui.item.css({ "border": "solid 1px red" });
			},
			update: function (event, ui) {
				
			}, stop: function (event, ui) {
				ui.item.css({ "border": "1px solid #cccccc" });
			}
		});

		$("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			var id = $(this).attr("ItemID");
			var file = $(this).attr("file");
			if(!confirm("确认删除？")) return;
			var obj = $(this);
			// $.getJSON("/admin/weixy/gallerymanage?act=DeleteImg", utils.params({id: id, file: file}), function (json) {
            $.getJSON("/index.php?c=admin/weiyx/gallery&a=DeleteImg", utils.params({id: id, file: file}), function (json) { 
				$(obj).closest("div.item").remove();
			});
			return false;
        });	
	}

	function singleUpload(btnobj){
		var params = {};
		params["itemid"] = $(btnobj).attr("itemid");
		params["oldfile"] = $(btnobj).attr("file");
		$(btnobj).val("处理中...");
		$(btnobj).prop("disabled",true);
		$.ajaxFileUpload
		(
			{
				// url: '/admin/weixy/gallerymanage?act=UploadImg', //用于文件上传的服务器端请求地址
                url: '/index.php?c=admin/weiyx/gallery&a=UploadImg', 
				secureuri: false, //是否需要安全协议，一般设置为false
				fileElementId: 'Filedata', //文件上传域的ID
				dataType: 'json', //返回值类型 一般设置为json
				data: params,
				success: function (data, status)
				{
					if(data.success){
						var tr = $(btnobj).closest("div.item");
						tr.find("*[isname=1]").val(data.fileName);
						tr.find("*[isimg=1]").attr("src","/comdata/"+ getCookie("SiteID") +"/gallery/" + data.fileName);
					}else{
						$.showResult("错误",data.msg);
					}
					$(btnobj).val("更换图片");
					$(btnobj).prop("disabled",false);
				},
				error: function (data, status, e)
				{
					$.showResult("错误",e);
					$(btnobj).val("更换图片");
					$(btnobj).prop("disabled",false);
				}
			}
		);
	}
	
	function submitForm() {
        var params = $('#MainForm').serializeObject();
		params['id'] = me.currentModule.params.id;
        // $.post("/admin/weixy/gallerymanage?act=InsertOrUpdateImages", params, function (data, textStatus, jqXHR) {
        $.post("/index.php?c=admin/weiyx/gallery&a=InsertOrUpdateImages", params, function (data, textStatus, jqXHR) {
            if (data.success) {
				loadList();
                $('<div id="success"><b><font size="4">保存成功</font></b> <input type=button class="btn btn-success" onclick="$(\'#success\').dialog(\'destroy\')" value="继续编辑图片" /> <input type="button" value="返回列表" class="btn btn-info" onclick="$(\'#success\').dialog(\'destroy\');location=\'#weixy.gallerylist\'"></div>').dialog({
                    modal: true, width: 400, close: function () {
                        $("#success").dialog("destroy");
                    }
                });
            } else {
                $('<div id="error">'+data.msg+'</div>').dialog({
                    modal: true, width: 400,title:"保存失败", close: function () { $("#error").dialog("destroy"); }
                });
            }
        }, "json");
    }

    me.addListener('galleryupload', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['weixy'] = function () {
	
    var me = this;

    function flash(args, tab,isgo) {
		me.execCommand('show', { a: args.a });
        setChildWindow(args,isgo);
    }

    function setChildWindow(args,isgo) {
		if(typeof(me.loginUser.ProductStatus) != 'undefined' && me.loginUser.ProductStatus != '3'){
			//me.content.load("/index.php?c=admin/page/Versiontip&page=" + args.b);
			me.content.children().remove();
			me.content.append("<div style='padding:50px;font-size:20px;color:red'>试用产品不能使用微营销功能</div>");
            return;
	}else{
			if(isgo) me.execCommand('go', args);
			else me.fireEvent(args.b, me.content);
		}
    }

    me.addListener('weixy', function (key, args) {
        var tab = me.execCommand('gettab', {});
        flash(args, tab);
    });
};

IWF.plugins['indianalist'] = function () {

    var me = this, url = "/index.php?c=admin/weiyx/indiana";
    var ViewModel = function () {
        var self = this;
        self.datalist = ko.observableArray();
        self.WeiXinId = ko.observable();
        self.showt = ko.observable();
        self.setstatus=function (obj, e) {
            $.ajax({
                type: "POST",
                url: url+'&a=setdisplay',
                dataType: "json",
                data: { 'status': e.target.value },
                success: function (data) {
                	if(data.success)
                	{
                		obj.showt = e.target.value;
                		if(e.target.value)
                			e.target.checked=true;
                		else
                			e.target.checked=false;
                	}
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                    
                }
            });
        };
        self.State = function (obj, e) {
           	if(obj.State<=1)
           	{
            $.ajax({
                type: "POST",
                url: url+'&a=setstate',
                cache: false,
                context: $(e.target),
                dataType: "json",
                data: { 'id': obj.Id, 'state': obj.State },
                success: function (data) {
             
                    if (data.success) {
                 //       $(this)[obj.State ? "addClass" : "removeClass"]("glyphicon-eye-close");
                 //       $(this)[obj.State ? "removeClass" : "addClass"]("glyphicon-eye-open");
                    	if(obj.State==1)
                    	{
                    		$(this).html('开启'); 
                    		$(this).parents('tr').find('.State').html('未生效');
                    	}
                    	else
                    	{
                    		$(this).html('关闭'); 
                    		$(this).parents('tr').find('.State').html('进行中');
                    	}
                    	
                    	 obj.State = obj.State ? 0 : 1;
                    }
                    else
                    	 $.showResult('出错',data.msg);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
           	}
           	else
           		alert('活动已结束');
        };
        self.showImage = function (t) {
            var image = "";
            $.each(me.Party, function (i, o) {
                if (o.type == t) {
                    image = o.image;
                    return;
                }
            });
            return image;
        }
        this.getTime = function (time) {
            return time.replace(/T/gi, "\r\n").replace(/(\.\d+)/, "");
        }
    };

    var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/indianalist.html", function () {
        	$("#linkindiana").text("http://"+ getDomain() +"/index.php?c=front/wxindiana").attr('href',"http://"+ getDomain() +"/index.php?c=front/wxindiana");
			bindUIEvent();
            ko.applyBindings(vm, root[0]);
            loadList(1);

//			if(!me.hasLicensePerm("ENABLE_WEIKANJIA") && window["WeikanjiaAdModalShow"] != 1){
//				$("#WeikanjiaAdModal").modal();
//				window["WeikanjiaAdModalShow"] = 1;
//				return;
//			}
        });
    }

    var curpage = 1;
    var itemcount = 0;
    function loadList(page) {

        var params = { 'a': 'dataList', keyword: $("#keyword").val(), page: page, pagesize: 20 };
        $.getJSON(url, params, function (json) {
            console.log(json);
            vm.datalist(json.list)
            vm.WeiXinId(json.wxid);
            vm.showt(json.usercenter_indiana);
            curpage = json.curpage;
            itemcount = json.list ? json.list.length : 0;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadList(page); });
                $("#pagination").show();
            }
            bindGridEvent();
        });
    }

    function bindUIEvent() {
        $("#BtnSearch").unbind('click').bind('click', function (event) {
            loadList(1);
        });
    }

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).data("id") }
            me.execCommand('go', { a: 'weixy', b: 'indianing', params: params });
            return false;
        });

        $("*[name=BtnGoJoin]").unbind('click').bind('click', function (event) {
        	
        	$("#IndianaModal .participate").html('');
        	 $("#IndianaModal .reward").html('');
        	//读取参与记录
        	 $.getJSON(url, { 'a': 'joinrecord', id: $(this).data("id") }, function (json) {
        		 var part=json.participate;
        		 var reward=json.reward;
        		 var table,stit,delivery='';
        		 
        		 for(a=0;a<part.length;a++)
        		 {
	    				table+='<tr>'
        			 		 +'<td>'+part[a].User+'</td>'
	    					 +'<td>'+part[a].Addtime+'</td>'
	    					 +'<td>￥'+part[a].Price+'</td>'
	    					 +'</tr>';
        		 }
        		 $("#IndianaModal .participate").html('<tr class="th" >'
  						+'<th style="width:100px">用户名</th>'
  						+'<th style="width:100px">时间</th>'
  						+'<th style="width:50px">支付</th>'
  						+'</tr>'+table);
        		 if(reward!=undefined)  //中奖记录
        		 { 
        			 switch(reward.RewardStatus)
        			 {
        			 	case 1:
        			 		stit='待发货';

        			 		delivery='<tr><td><a target="_target"  class="btn btn-primary" href="#business.orderedit:{\'id\':\''+reward.Orderid+'\',\'status\':1}">发货</a></td></tr>';

        			 		break;
        			 	case 2:
        			 		stit='已发货';
        			 		break;
        			 	case 3:
        			 		stit='已完成';
        			 		break;
        			 	default:
        			 		stit='等待用户领奖登记';
    			 			break; 		
        			 }
        			 
        			 $("#IndianaModal .reward").html('<table class="table">'
        					 +'<tr><td style="width:250px">用户名:'+reward.User+'</td><td>订单编号:'+reward.Orderid+'</td><tr>'
        					 +'<tr><td>电话:'+reward.mobile +'</td><td>中奖时间:'+reward.RewardDate+'</td></tr>'
        					 +'<tr><td>收件人:'+reward.contact+'</td><td>幸运码:'+reward.Lucknumber+'</td></tr>'
        					 +'<tr><td>收件地址:'+reward.address+'</td></tr>'
        					 +'<tr><td>状态:'+stit+'</td></tr>'
        					 +delivery
        					 +'</table>');
        		 }

        	 });
        	$("#IndianaModal").modal();       
        	return false;
        	/*
            var params = { id: $(this).data("id") }
            me.execCommand('go', { a: 'weixy', b: 'discountuser', params: params });
            return false;
            */
        });
        $("*[name=BtnOrder]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).data("id") }
            me.execCommand('go', { a: 'weixy', b: 'discountorders', params: params });
            return false;
        });

//        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
//            if (!confirm("确认删除？")) return false;
//            $.getJSON(url, { 'a': 'Delete', id: $(this).data("id") }, function (json) {
//                if (json.success) {
//                    if (itemcount > 1)
//                        loadList(curpage);
//                    else loadList(1);
//                } else {
//                    $.showResult("出错啦", json.msg);
//                }
//            });
//            return false;
//        });
//        $(".fa-qrcode").mouseover(function () {
//    		var maxh = $("#showListTable").position().top;
//    		$("#divQRCodePreview").remove();
//    		var qrcodesrc = "index.php?c=admin/weixy/indiana&a=qrcode";
//    		var html = "<div id='divQRCodePreview' class='divQRCodePreview' style='padding:5px;border:1px solid #cccccc;background:white;position:absolute;z-index:999'>";
//    		html += "<img src='"+ qrcodesrc +"' width='150'/>";
//    		html += "</div>";
//    		$("body").append(html);
//    		var top = $(this).offset().top + 20;
//    		if(top + $("#divQRCodePreview").height() > maxh) top = $(this).offset().top - $("#divQRCodePreview").height();
//    		$("#divQRCodePreview").css({top:top,left:$(this).offset().left + 20});
//    		
//    	}).mouseout(function () {
//    	    $("#divQRCodePreview").remove();
//    	});
        $(".fa-qrcode").mouseover(function () {
        	var url=$("#linkindiana").text();
            var img = $('<img class="divQRCodePreview" style="position:absolute;top:50px;width:150px;height:150px;top:60px;z-index:10;border:solid 10px #fff;" src="/index.php?c=admin/weiyx/indiana&a=qrcode&url='+url+'"/>')
            $(this).parent().append(img);
        }).mouseout(function () {
            $(".divQRCodePreview").remove();
        });
    }
    

    me.addListener('indianalist', function (key, args) {
        args.addClass('row');
        initUI(args);

    });
}

IWF.plugins['indianing'] = function () {
    var me = this, url = "/index.php?c=admin/weiyx/indiana";
//    Date.prototype.AddDays = function (day) {
//        this.time = this.valueOf();
//        if (day && !isNaN(day)) {
//            this.time += (day * 60 * 60 * 24 * 1000);
//        }
//        this.nd = new Date(this.time);
//        this.setYear(this.nd.getFullYear());
//        this.setMonth(this.nd.getMonth());
//        this.setDate(this.nd.getDate());
//        this.setHours(this.nd.getHours());
//        this.setMinutes(this.nd.getMinutes());
//        this.setSeconds(this.nd.getSeconds());
//        this.setMilliseconds(this.nd.getMilliseconds());
//    }
    Date.prototype.FormatString = function () {
        this.date = this.valueOf();
        this.dt = new Date(this.date);
        return [this.dt.getFullYear(), "-", this.dt.getMonth() + 1, "-", this.dt.getDate(), " ", this.dt.getHours(), ":", this.dt.getMinutes(), ":00"].join("");
    }

    var voteModel = function () {
        var self = this;
        self.setData = function (data) {
            for (var key in data) {
                if (typeof (data[key]) == "object")
                { this[key] = ko.observableArray(data[key]); }
                else {
                    this[key] = ko.observable(data[key]);
                }
            }
        };
        self.AwardList = ko.observableArray([]);
        self.key = ko.observable();
        self.link = ko.observable();
        self.Format = function (n) {
            return n().replace(/T/g, " ");
        };
    };
    var vm = new voteModel();
    function LoadProductList(pid) {
        $.ajax({
            type: "GET",
            url: url,
            cache: false,
            context: null,
            beforeSend: function (XMLHttpRequest) {
                this;
            },
            dataType: "json",
            data: { 'a': 'ProductList' },
            success: function (data) {
                console.log(data);
                if (data.success) {
                    var html = [];
                    $.each(data.list, function (i, n) {
                        if (n.ProductID === pid) {
                            console.log(pid)
                            $("#CurProduct").text(n.Name);
                        }
                        html.push('<li><a class="product" href="javascript:void(0);" data-id="', n.ProductID, '" data-price="', n.Price, '" data-costprice="', n.CostPrice, '" data-count="', n.ProductQuantity, '">', n.Name, '</a></li>');
                    });
                    $('#Product').html(html.join(''));
                }
            },
            complete: function (XMLHttpRequest, textStatus) {
                this;
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    };

    function LoadInfo(id) {
        $.ajax({
            type: "GET",
            url: url,
            cache: false,
            dataType: "json",
            data: { 'a': 'GetInfo', 'id': id },
            success: function (data) {
                console.log(data);
                if (data.success) {
                	if(data.info)
                	{
	                    vm.setData(data.info);
	                    vm.key(data.key);
	                    vm.link(data.link);
	                    $("#WxShow").attr("src", data.info.WxImage);
                	
                    $('<img style="width:200px;height:200px;border:solid 10px #fff;" src="/index.php?c=admin/weiyx/indiana&a=qrcode&url=' + encodeURIComponent(data.link) + '"/>').appendTo($(".qrcode"));

//                    if (data.info.DiscType == 1) {
//                        $(".MaxRedPack").removeClass("none");
//                        $("#MinText").text("最小砍价金额");
//                    } else {
//                        $(".MaxRedPack").addClass("none");
//                        $("#MinText").text("固定砍价金额");
//                    }

                    LoadProductList(data.info.ProductId);
                    ko.applyBindings(vm, document.getElementById("voteTabs"));

                	if(!data.fx_version)
                	{
                		$('input[name="Distribution"][value="0"]').attr('checked',true);
                		$('input[name="Distribution"]').attr('disabled',true);
                		$('.commission').hide();
                	}
                    initUE();
                	}               	
                	
                		
//                    setTimeout(function () {
//                        var viewBody = $(window.frames["frameView"].document.body);
//                        viewBody.find("#BePrice").html("底价: ￥" + (data.info.BasePrice/100) + "(库存:"+data.info.ProductCount+")");
//                        viewBody.find("#OrPrice").html("原价:￥" + (data.info.Price/100));
//                        viewBody.find("#PName").text("产品名称产品名称产品名称");
//                        viewBody.find(".swiper-wrapper").html('<div class="swiper-slide"><img src="/images/fullswitch/bg1.jpg"/></div>');
//                    }, 1000);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    };
    function BindUpLoadImg(args) {
        $('.uploadBtn,.BtnCover', args).off("click").on('click', function (e) {
            var _this = $(this);
            var _thisInput = _this.prev();

            YDM.FileManager('image', 1, function (aUrl) {
                if (aUrl.length > 0) {
                    if (_thisInput.is("input") && _thisInput.attr("id")) {
                        var viewBody = $(window.frames["frameView"].document.body);
                        switch (_thisInput.attr("id").toLowerCase()) {
                            case "wximage": 
                            { 	
                                if (_this.next().is("img")) {
                                    _this.next().attr("src", aUrl[0]);
                                } else {
                                    _this.after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", aUrl[0]));
                                }
                                break;
                            }
                        }
                        _thisInput.val(aUrl[0]);
                    }
                }
            })
        });
    };
    function initFormEvent() {
        ///当前时间与传入的时间比较
//        jQuery.validator.addMethod("CKDate", function (value, element, params) {
//            var ereg = /^(\d{1,4})(-|\/)(\d{1,2})(-|\/)(\d{1,2})(\s{1})(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
//            var s = value.match(ereg);
//            if (s == null) {
//                return false;
//            }
//            var e = $(params).val().match(ereg);
//            var sDate = Number(new Date(s[1], s[3] - 1, s[5], s[7], s[8], s[9]).valueOf());
//            var eDate = Number(new Date(e[1], e[3] - 1, e[5], e[7], e[8], e[9]).valueOf());
//            return this.optional(element) || ((sDate - eDate) > 0);
//        }, jQuery.validator.format("当前时间不能早于{0}的时间."));
//        jQuery.validator.addMethod("IsDate", function (value, element) {
//            var ereg = /^(\d{1,4})(-|\/)(\d{1,2})(-|\/)(\d{1,2})(\s{1})(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
//            var r = value.match(ereg);
//            if (r == null) {
//                return false;
//            }
//            var d = new Date(r[1], r[3] - 1, r[5], r[7], r[8], r[9]);
//            var result = (d.getFullYear() == r[1] && (d.getMonth() + 1) == r[3] && d.getDate() == r[5] && d.getHours() == r[7] && d.getMinutes() == r[8] && d.getSeconds() == r[9]);
//            return this.optional(element) || (result);
//        }, "请输入正确的日期");
    	jQuery.validator.addMethod("isFloat", function(value, element) { return this.optional(element) || /^[-\+]?\d+(\.\d+)?$/.test(value); });
        jQuery.validator.addMethod("CKPrice", function (value, element, params) {
 //       	console.log(parseFloat($(params).val())%parseFloat(value));
            return this.optional(element) || (parseFloat(value) <= parseFloat($(params).val()) &&  /[.]/.test(parseFloat($(params).val())/parseFloat(value)) ==false) ; //相除要为整数
        }, jQuery.validator.format("原价除以夺宝价要为整数"));
      
        $("#MainForm").validate({
            invalidHandler: function () {
                $(".gray").removeClass("gray");
                $("#voteTabs").tabs({ active: 0 });
            },
            rules: {
                Title: "required"
				, WxImage: "required"
                , ProductPrice: { required: true, isFloat: true,maxlength:10 }
				, ProductId: { required: true, digits: true }
                , IndianaPrice: { required: true, isFloat: true, CKPrice: "#ProductPrice" }
                , Description: "required"
                , Level1: {digits: true,maxlength:2}
                , Level2: {digits: true,maxlength:2}
                , Level3: {digits: true,maxlength:2}
            },
            messages: {
                Title: "请输入活动标题！"
				, WxImage: "请上微信传封面图！"
                , ProductPrice: { required: "请输入活动产品价格", isFloat: "只能输入数值" }
				, ProductId: { required: "请选择产品", digits: "产品不正确！" }
                , IndianaPrice: { required: "请输入产品售价", isFloat: "价格只能为数值", CKPrice: "原价除以夺宝价要为整数" }
                , Description: "请输入活动简介"
                , Level1: {digits: "请输入两位整数",maxlength:"请输入两位整数"}
                , Level2: {digits: "请输入两位整数",maxlength:"请输入两位整数"}
                , Level3: {digits: "请输入两位整数",maxlength:"请输入两位整数"}
            },
            submitHandler: function (form,ng) {
            for(var p=0;p<form.length;p++) 
            {
            	if(form[p].name =='Distribution')
            	{
	            	if($('input[name="Distribution"][value="1"]')[0].checked==true)
	            	{
		            	var sum=parseInt($('input[name="Level1"]').val())+
		            		parseInt($('input[name="Level2"]').val())+
		            		parseInt($('input[name="Level3"]').val());
		            	if(sum>=100)
		            	{
		            		alert('分销比例必能大于100');
		            		return false;
		            	}
	            	}
	            	
	        	}
            }
                submitForm();
                return false;
            },
            ignore: []
        });
    };
    function submitForm() {
        var params = $('#MainForm').serialize() ;
        $.post(url+'&a=save', params, function (data, textStatus, jqXHR) {
            if (data.success) {
                $('<div id="success">保存成功</div>').dialog({
                    modal: true, width: 400, close: function () {
                        $("#success").dialog("destroy");
                        me.execCommand('go', { a: 'weixy', b: 'indianalist' });
                    }
                });
            } else {
                $('<div id="error">' + data.msg + '</div>').dialog({
                    modal: true, width: 400, title: "保存失败", close: function () { $("#error").dialog("destroy"); }
                });
            }
        }, "json");
    };
    var myroot = null;
    this.addListener('indianing', function (key, args) {

        args.loadHtmlTpl('plugins/weixypackage/html/indianing.html?v=' + Math.random(), function () {

            myroot = args[0];

//			if (!me.hasLicensePerm('ENABLE_JIFEN')){
//				$("input,select",myroot).each(function(i,item){
//					if(($(item).attr("name") + "").indexOf("JiFen") > -1){
//						$(item).prop("readonly",true);
//						$(item).css("height","50px");
//						if($(item)[0].tagName == 'SELECT') $(item).hide();
//					}
//				});
//				$("#forJiFenIn,#forJiFenOut").each(function(i,item){
//					$(item).html($(item).html() + " <font color='red'><br>当前版本不支持积分功能，请升级到旗舰版以上</font>");
//				});
//			}
            if ($("#WxImage").val() != "") {
                if ($(".BtnCover").next().is("img")) {
                    $(".BtnCover").next().attr("src", $("#WxImage").val());
                } else {
                    $(".BtnCover").after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", $("#WxImage").val()));
                }
            }

            $("#voteTabs").tabs();
            $('#SDate,#EDate').datetimepicker({
                dayOfWeekStart: 1,
                lang: 'ch',
                format: 'Y-m-d H:i:00'
            });
            BindUpLoadImg(args);
            initFormEvent();
            BindOnEvent();
            LoadProductList();
            $("#voteTabs").on("tabsactivate", function (event, ui) {
                this.index = $("#voteTabs").tabs("option", "active");
                var viewBody = $(window.frames["frameView"].document.body);
                viewBody.find("section").hide();
                if (this.index == 1) {
                    viewBody.find("#Detail").show();
                } else if (this.index == 2) {
                    viewBody.find("#Join").show();
                } else {
                    viewBody.find("#Home").show();
                }
            });

            if (me.currentModule.params && me.currentModule.params.id) {
                LoadInfo(me.currentModule.params.id);
                $(".IsEdit").show();
                $("#LinkMenu").off("click").on("click", function () {
                    me.execCommand('go', { a: 'weixin', b: 'wxmenu' });
                });
            } else {
            	LoadInfo();
                this.date = new Date();
                $("#SDate").val(this.date.FormatString());
                this.date.AddDays(10);
                $("#EDate").val(this.date.FormatString());

                initUE();
                $("#link").attr("disabled", 'disabled').val("保存后才可以生成相应的链接！");
                initCustomForm();

            }
            


            $('#ProductPrice').focusout(function(){
            	var val=parseFloat($('#ProductPrice').val()).toFixed(2);//默认带2位小数
            	$('#ProductPrice').val(val);
            });
            $('#IndianaPrice').focusout(function(){
            	var val=parseFloat($('#IndianaPrice').val()).toFixed(2);
            	$('#IndianaPrice').val(val);
            });
            $('input[name="Distribution"]').change(function(){
            	var p=$('input[name="Distribution"]:checked').val();
            	if(p==1)
            	{
            		$('.commission').show();
            		$('.commission .form-control').attr('disabled',false);
            	}
            	else
            	{
            		$('.commission').hide();
            		$('.commission .form-control').attr('disabled',true);
            	}
            });
//			if(!me.hasLicensePerm("ENABLE_WEIKANJIA") && window["WeikanjiaAdModalShow"] != 1){
//				$("#WeikanjiaAdModal2").modal();
//				window["WeikanjiaAdModalShow"] = 1;
//				return;
//			}

			$("<div></div>").appendTo(myroot).load("/admin/widget/WxPaySetting.html?v=" + Math.random(), function(){
				$('.btnShowWxPaySetting').wxPaySetting();
			});
        });
    });
    function BindOnEvent() {
        $('input[name="DiscType"]').off("click.xxx").on("click.xxx", function () {
            console.log($(this).val());
            if ($(this).val() == 0) {
                $(".MaxRedPack").addClass("none");
                $("#MinText").text("固定砍价金额");
            } else {
                $(".MaxRedPack").removeClass("none");
                $("#MinText").text("最小砍价金额");
            }
        });
        /*
        $("input[type='text']").on("keyup focus", function (e) {
            var viewBody = $(window.frames["frameView"].document.body);
            var _this = $(e.target);
            if ("productcount" == _this.attr("id").toLowerCase()) {
                viewBody.find("#BePrice").html("底价: ￥" + $("#BasePrice").val() + "(库存:" + _this.val() + ")");
                e.preventDefault();
            }
            if ("baseprice" == _this.attr("id").toLowerCase()) {
                viewBody.find("#BePrice").html("底价: ￥" + _this.val() + "(库存:" + $("#ProductCount").val() + ")");
                e.preventDefault();
            }
            if ("price" == _this.attr("id").toLowerCase()) {
                viewBody.find("#OrPrice").html("原价:￥" + _this.val());
                e.preventDefault();
            }
        });
        */
        $(document).off("click.xxxx").on("click.xxxx", function (e) {
            var _this = $(e.target);
            if (_this.hasClass("upImage")) {
                YDM.FileManager('image', 1, function (aUrl) {
                    var index = _this.attr("data-val");
                    $("#image" + index).val(aUrl[0]);
                    $("#show" + index).attr("src", aUrl[0]).show();
                });
            };
            if (_this.hasClass("imgshow")) {
                $('<div></div>').dialog({
                    modal: true, width: 680, height: 600, position: { my: "center center", at: "center center", of: window },
                    open: function (event, ui) {
                        $(this).append('<img src="' + _this.attr("src") + '" style="width:100%"/>');
                    },
                    close: function () {
                        $(this).dialog("destroy");
                    }
                });
            };
            if (_this.hasClass("product")) {
                $("#ProductId").val(_this.data("id"));
                $("#BasePrice").val(_this.data("costprice"));
                $("#Price").val(_this.data("price"));
                $("#CurProduct").text(_this.text());
                $("#ProductCount").val(_this.data("count"));
            };
        });
    };
    var ue = null;
    function initUE() {
        var html = $('#Detail').val() == "" ? "活动规则：<br/>活动范围：<br />活动人群：<br />" : $('#Detail').val();
        ue = new baidu.editor.ui.Editor({
            toolbars: [[
                'removeformat', 'bold', 'italic', 'underline', 'strikethrough'
                , 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
                , 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', 'link', 'unlink'
            ]]
        });

        ue.render('Detail');
        ue.ready(function () {
            ue.setContent(UE.utils.html(html));
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#content").html(ue.getContent());
        });
        ue.addListener('contentChange', function (editor) {
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#content").html(ue.getContent());
            viewBody.find("#ProductDetail").html("产品详情……");
        });
    }
    function initCustomForm(formid, formname) {
        $("#selfForm").html("<iframe name='customFormFrame' src='widget/customform.html?FormID=" + formid + "&FormName=" + formname + "&HideSaveBtn=1&HideTitle=1' frameborder='0' width='100%' height='400'></iframe>");
    };

};
IWF.plugins['lbsstore_edit'] = function () {
		var me = this;
		utils.addScript("/framework/ref/scripts/jquery-validator-method.js");
		utils.addScript("/framework/ref/scripts/jquery.class.js");
		utils.addScript("/framework/ref/scripts/jquery.city.js");
		var ViewModel = function() {
	        this.setData = function (data) {
				for(var key in data){
					if(typeof(data[key]) == "object") this[key] = ko.observableArray(data[key]);
					else this[key] = ko.observable(data[key]);
				}
			};
			this.getTime = function(time){
				return time().replace(/T/g," ");
			}
	    };
		var arr=['7','8','10','11','12'];
		var vm = new ViewModel();
        var myroot = null;
        function initUI(root) {
        	if(arr.indexOf(me.loginUser.License)<0) 
        	{
        		alert('当前版本不支持此功能');
        		return false;
        	}
            root.children().remove();
            root.loadHtmlTpl("plugins/weixypackage/html/lbsstore_edit.html?v=" + Math.random(), function () {
                myroot = root[0];
                $("#Tabs",myroot).tabs();
                if (me.currentModule.params && me.currentModule.params.id) 
                {
                	$.ajax({
                		 type: "POST",
                         url: '/index.php?c=admin/weiyx/lbsstore',
                         cache: false,
                         dataType: "json",
                         // data: { 'act': 'GetInfo', 'id': id },
                         data: { 'a': 'GetInfo', 'id': me.currentModule.params.id },
                         success: function (data) {
                        	vm.setData(data.info);
                 			ko.applyBindings(vm,myroot);
                 			
                        	$("#City").City(data.info.Province ||0,data.info.City||0);
                 			$("#province").addClass("form-control").css({"width":110,"display":"inline"});
                			$("#city").addClass("form-control").css({"width":110,"display":"inline"});
                			
                         },
                	});
                	
                }
                else
                {
                	 $("#City").City(0,0);
            		$("#province").addClass("form-control").css({"width":110,"display":"inline"});
        			$("#city").addClass("form-control").css({"width":110,"display":"inline"});
                }
    		
    			
    			$.validator.addMethod("mobile", function(value, element) {
    				return this.optional(element) || isMobile(value);
    			}, "手机号码格式不正确");
    			
    			$("#MainForm").validate({
    				rules:{
    					Name:'required',
    					province:'required',
    					city:'required',
    					Address:'required',
    					Longtitude:{required:true,number:true},
    					Lantitude:{required:true,number:true},
    					Mobile:{mobile:true}
    				},
    				messages:{
    					Name:{required:'必填'},
    					province:{required:'必填'},
    					city:{required:'必填'},
    					Address:{required:'必填'},
    					Longtitude:{required:'必填',number:'请填写小数'},
    					Lantitude:{required:'必填',number:'请填写小数'},
    					Mobile:{mobile:'手机号码格式不正确'}
    				},
    				submitHandler: function (form) {
    	                submitForm();
    	                return false;
    	            },
    			});
    			
            });
        }
        
        function submitForm(params)
        {
        	var params =$('.MainForm').serialize();
        	$.post('/index.php?c=admin/weiyx/lbsstore&a=save',params,function(data){
        		if(data.success)
        		{
        			   $('<div id="success">保存成功</div>').dialog({
                           modal: true, width: 400, close: function () {
                               $("#success").dialog("destroy");
                               me.execCommand('go', { a: 'weixy', b: 'lbsstore_list' });
                           }
                       });
        		}else
        			$('<div id="success">保存失败</div>').dialog({
                        modal: true, width: 400
                    });
        	},'json');
        }
        
        me.addListener('lbsstore_edit', function (key, args) {
            initUI(args);
        });
}
IWF.plugins['lbsstore_list'] = function () {

    var me = this;
    var arr=['7','8','10','11','12'];

	var ViewModel = function () {
	    this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
        this.getTime = function (time) {
            return time.replace(/T/gi, "\r\n").replace(/(\.\d+)/, "");
        }
    };

	var vm = new ViewModel();
    function initUI(root) {
        if(arr.indexOf(me.loginUser.License)<0) 
    	{
    		alert('当前版本不支持此功能');
    		return false;
    	}
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/lbsstore_list.html",function(){
			bindUIEvent();
		
			loadlist(1);			
			ko.applyBindings(vm,root[0]);
        });
    }
	    
	var curpage = 1;
	var itemcount = 0;
    function loadlist(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(),page: page, pagesize: 20 };
        // $.getJSON("/admin/weixy/wallmanage?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/lbsstore&a=GetList", utils.params(params), function (json) {
            vm.setData(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadlist(page); });
                $("#pagination").show();
            }
            bindGridEvent();
        });
    }

    function bindUIEvent() {
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadlist(1);
        });

		$("#BtnAddLuck").unbind().bind('click', function (event) {
		    me.execCommand('go', { a: 'weixy', b: 'walledit', params: me.currentModule.params });
			return false;
        });
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("ID") };
			me.execCommand('go', { a: 'weixy', b: 'lbsstore_edit', params: params });
			return false;
        });
/*
		$("*[name=BtnGoFans]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("WallID") };
			me.execCommand('go', { a: 'weixy', b: 'wallusers', params: params });
			return false;
        });

		$("*[name=BtnGoMsgList]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("WallID") };
			me.execCommand('go', { a: 'weixy', b: 'wallmsglist', params: params });
			return false;
        });

		$("*[name=BtnGoScreen]").unbind('click').bind('click', function (event) {
			var params = {id: $(this).attr("WallID") };
            //me.execCommand('go', { a: 'weixy', b: 'wallusers', params: params });
			// window.open("/wall/" + $(this).attr("WallID") + "/");
            // window.open("http://"+window.location.host+"/index.php?c=front/wall&a=index&id=" + $(this).attr("WallID"));
            window.open("/index.php?c=front/wall&id=" + $(this).attr("WallID"));
			return false;
        });
*/
        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			// $.getJSON("/admin/weixy/wallmanage?act=Delete", utils.params({id:$(this).attr("WallID")}), function (json) {
            $.getJSON("/index.php?c=admin/weiyx/lbsstore&a=Delete", utils.params({id:$(this).attr("ID")}), function (json) { 
				if(json.success){
					if(itemcount > 1) loadlist(curpage);
					else loadlist(1);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });

        /*
		$("*[name=BtnSetStatus]").unbind('click').bind('click', function (event) {
			// $.getJSON("/admin/weixy/wallmanage?act=setstatus", utils.params({id:$(this).attr("WallID"),status: $(this).attr("Status")}), function (json) {
            $.getJSON("/index.php?c=admin/weiyx/wall&a=SetStatus", utils.params({id:$(this).attr("WallID"),status: $(this).attr("Status")}), function (json) { 
				if(json.success){
					loadlist(curpage);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
		});
		*/
		
        $(".fa-qrcode").mouseover(function () {
			var maxh = $("#showListTable").position().top;
			$("#divQRCodePreview").remove();
			// var qrcodesrc = "/admin/weixy/wallmanage?act=qrcode&id=" + $(this).attr("data-val");
            var qrcodesrc = "/index.php?c=admin/weiyx/wall&a=qrcode&id=" + $(this).attr("data-val"); 
			var html = "<div id='divQRCodePreview' class='divQRCodePreview' style='padding:5px;border:1px solid #cccccc;background:white;position:absolute;z-index:999'>";
			html += "<img src='"+ qrcodesrc +"' width='150'/>";
			html += "</div>";
			$("body").append(html);
			var top = $(this).offset().top + 20;
			if(top + $("#divQRCodePreview").height() > maxh) top = $(this).offset().top - $("#divQRCodePreview").height();
			$("#divQRCodePreview").css({top:top,left:$(this).offset().left + 20});
			
		}).mouseout(function () {
		    $("#divQRCodePreview").remove();
		});
    }

    me.addListener('lbsstore_list', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['luckedit'] = function () {

    var me = this;
		
	var ViewModel = function() {
        this.setData = function (data) {
			for(var key in data){
				if(typeof(data[key]) == "object") this[key] = ko.observableArray(data[key]);
				else this[key] = ko.observable(data[key]);
			}
		};
		this.getTime = function(time){
			return time().replace(/T/g," ");
		}
    };
	
	var vm = new ViewModel();
	var myroot = null;
	window.awards = [];
	function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/luckedit.html?rand=" + Math.random(),function() {
			
			//if (!me.hasLicensePerm('ENABLE_JIFEN')){
				$("input,select",root[0]).each(function(i,item){
					if(($(item).attr("name") + "").indexOf("JiFen") > -1){
						$(item).prop("readonly",true);
						if($(item)[0].tagName == 'SELECT') $(item).hide();
					}
				});
				$("#forJiFenIn,#forJiFenOut").each(function(i,item){
					$(item).html($(item).html() + " <font color='red'>当前版本不支持积分功能，请升级到旗舰版以上版本</font>");
				});
			//}

			$("*[name=spLuckName]").html(me.currentModule.params.LuckName);
			$("#LuckType").val(me.currentModule.params.LuckType);

			$(".myEditSuccess").find(".close").unbind('click').click(function(){
				me.execCommand('go', { a: 'weixy', b: 'lucklist',params:{LuckType:me.currentModule.params.LuckType, LuckName: me.currentModule.params.LuckName } });
				return false;
			});

			$(".myAlertError").find(".close").unbind('click').click(function(){
				$("#divForm").show();
				$(".myAlertError").hide();
				return false;
			});

			$('#BtnSelStartImage',root).off().on('click', function () {
                YDM.FileManager('image', 1, function (aUrl) {
                    if (aUrl.length > 0) {
                        $('#StartImage').val(aUrl[0]);
						$('#PreviewStartImage').attr("src",aUrl[0]);
                    }
                })
            });

			$('#BtnSelEndImage',root).off().on('click', function () {
                YDM.FileManager('image', 1, function (aUrl) {
                    if (aUrl.length > 0) {
                        $('#EndImage').val(aUrl[0]);
						$('#PreviewEndImage').attr("src",aUrl[0]);
                    }
                })
            });

			//日期控件
			$('#StartTime,#EndTime').datetimepicker({
				dayOfWeekStart: 1,
				lang: 'ch',
				format: 'Y-m-d H:i:00'
			});

			$("#ImageStyle").change(function () {
				var img = ["<img src='/images/PartyImage/", $(this).val(), ".png'/>"].join('');
				$("#StyleShow").html(img);
			});
			
			initFormEvent();
			
			myroot = root[0];
			if(me.currentModule.params && me.currentModule.params.id) loadInfo();
			else initUE();
		});
    }

	function initFormEvent(){

		///当前时间与传入的时间比较
		jQuery.validator.addMethod("CKDate", function (value, element, params) {
			var vDate = Number(new Date(value).valueOf());
			var pDate = Number(new Date($(params).val()).valueOf());
			return this.optional(element) || ((vDate - pDate) > 0);
		}, jQuery.validator.format("当前时间不能早于{0}的时间."));

		$("#MainForm").validate({
			invalidHandler: function () {
				$(".gray").removeClass("gray");
			},
			rules: {
				LuckTitle: { required: true }
				, LuckTips: "required"
				, RepeatTips: "required"
				, EndTips: "required"
				, LuckRatio: { required: true, number: true }
				, StartImage: "required"
				, EndImage: "required"
				, LuckNumber: { required: true }
				, level0: "required"
				, level1: "required"
				, level2: "required"
				, award0: "required"
				, award1: "required"
				, award2: "required"
				, count0: { required: true, digits: true }
				, count1: { required: true, digits: true }
				, count2: { required: true, digits: true }
				, rate0: { required: true, digits: true }
				, rate1: { required: true, digits: true }
				, rate2: { required: true, digits: true }
				, StartTime: { required: true, date: true }
				, EndTime: { required: function () { return $("#StartTime").val() != ""; }, date: true, CKDate: "#StartTime" }
				, UserLimit: { required: true, number: true }
				, AnonymousLimit: { required: true, number: true }
				, LuckLimit: { required: true, number: true }
			},
			messages: {
				LuckTitle: { required: "请输入活动标题！" }
				, LuckTips: "请输入中奖提示！"
				, RepeatTips: "请输入重复抽奖提示！"
				, EndTips: "请输入活动结束提示！"
				, LuckRatio: { required: "请输入中奖系数！", number: "只能输入数值！" }
				, level0: ""
				, level1: ""
				, level2: ""
				, award0: ""
				, award1: ""
				, award2: ""
				, count0: { required: "", digits: "数量只能输入整数" }
				, count1: { required: "", digits: "数量只能输入整数" }
				, count2: { required: "", digits: "数量只能输入整数" }
				, rate0: { required: "", digits: "概率只能是整数" }
				, rate1: { required: "", digits: "概率只能是整数" }
				, rate2: { required: "", digits: "概率只能是整数" }
				, StartImage: "请选择开始封面"
				, EndImage: "请选择结束封面"
				, LuckNumber: { required: "请输入中奖号码！" }
				, StartTime: { required: "请输入活动开始时间！", date: "正确的日期格式：2015-01-01 12:00:00" }
				, EndTime: { required: "请输入活动结束时间！", date: "正确的日期格式：2015-01-01 18:00:00", CKDate: "结束时间不能早于开始时间！" }
				, UserLimit: { required: "-1禁止;0:无限/天;n次/天", number: "只能输入数值！" }
				, AnonymousLimit: { required: "-1禁止;0:无限/天;n次/天", number: "只能输入数值！" }
				, UserLimit: { required: "-1禁止;0:无限/天;n次/天", number: "只能输入数值！" }
				, AnonymousLimit: { required: "-1禁止;0:无限/天;n次/天", number: "只能输入数值！" }
				, LuckLimit: { required: "-1禁止;0:无限/天;n次/天", number: "只能输入数值！" }
			},
			submitHandler: function (form) {
				submitForm();
				return false;
			},
			ignore: []
		});		
	}
	
	var ue = null;
	function initUE(){
		var html = $('#LuckDetail').val();
		
		/*try{
			UE.getEditor('LuckDetail').destroy();
		}catch(e){}
		ue = UE.getEditor('LuckDetail', {
			toolbars: [[
				'bold', 'italic', 'underline', 'fontborder', 'strikethrough', 'superscript', 'subscript', 'removeformat', 'formatmatch', 'autotypeset'
				, 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc'
				, '|', 'link', 'unlink', 'anchor', '|', 'emotion', 'pagebreak'
				, '|', 'paragraph', 'fontfamily', 'fontsize', '|'
				,'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', '|'
				,'imagenone', 'imageleft', 'imageright', 'imagecenter', '|','horizontal', 'spechars'
			]]
			, contextMenu: []
		});
		ue.ready(function() {
			ue.setContent(UE.utils.html(html));
		});*/

		ue = new baidu.editor.ui.Editor({
	        toolbars: [[
                'bold', 'italic', 'underline', 'strikethrough', 'removeformat'
                , 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
                , 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify'
                , 'imagenone', 'imageleft', 'imageright', 'imagecenter'
	        ]]
	    });

	    ue.render('LuckDetail');
		ue.ready(function() {
			ue.setContent(UE.utils.html(html));
		});
	}

    function loadInfo() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        $.getJSON("/admin/weixy/luckmanage?act=GetInfo", utils.params(params), function (json) {
			vm.setData(json.info);
			ko.applyBindings(vm,myroot);
			initUE();
			window.awards = $.parseJSON(json.info.LuckAward);
			$.each(awards, function (i, n) {
				if (typeof (n) == "object") {
					$("#level" + i).val(n.level);
					$("#award" + i).val(n.award);
					$("#count" + i).val(n.count);
					$("#rate" + i).val(n.rate);
				}
			});
        });
    }

    function submitForm(form) {
		var html = ue.getContent();
		$('#LuckDetail').val(html);
        var params = $('#MainForm').serializeObject();
		//console.log(params);return false;
		$.post("/admin/weixy/luckmanage?act=Edit",params,function(data, textStatus, jqXHR){
			if(data.success){
				$(".myEditSuccess").show();
				$("#divForm").hide();
				$(".myAlertError").hide();
			}else{
				$(".myAlertError").show();
				$(".spError").html(data.msg);
				$("#divForm").hide();
				$(".myEditSuccess").hide();
			}
		},"json");
    }

    me.addListener('luckedit', function (key, args) {
		initUI(args);
    });
}

﻿IWF.plugins['lucklist'] = function () {

    var me = this;
    me.Party = [{}
        , { type: 1, LuckName: "幸运转盘", image: "/images/PartyImage/dzp.jpg" }
        , { type: 2, LuckName: "砸金蛋", image: "/images/PartyImage/zjd.jpg" }
        , { type: 3, LuckName: "刮刮卡", image: "/images/PartyImage/ggk.jpg" }
        , { type: 4, LuckName: "幸运卡片", image: "/images/PartyImage/xykp.jpg" }];
	var ViewModel = function () {
	    this.lucklist = ko.observableArray();
	    this.showImage = function (t) {
	        var image = "";
	        $.each(me.Party, function (i,o) {
	            if (o.type == t) {
	                image = o.image;
	                return;
	            }
	        });
	        return image;
	    }
        this.setData = function (data) { this.lucklist(data); };
		this.getTime = function(time){
			return time.replace(/T/gi," ").replace(/(\.\d+)/,"");
		}
		this.weixin = ko.observable();
    };

	var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/lucklist.html?v=" + Math.random(),function(){
			bindUIEvent();
			ko.applyBindings(vm,root[0]);
			loadlucklist(1);
            
			
        });

    }
	    
	var curpage = 1;
	var itemcount = 0;
    function loadlucklist(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(),type: me.currentModule.params.LuckType, page: page, pagesize: 20 };
        // $.getJSON("/admin/weixy/luckmanage?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/luck&a=GetList", utils.params(params), function (json) {
            console.log(json);
            vm.setData(json.list);
            vm.weixin(json.weixinid);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadlucklist(page); });
                $("#pagination").show();
            }

            bindGridEvent();

        });
    }

    

    function bindUIEvent() {

	    if (me.currentModule.params.LuckType) {
	        this.LuckName = me.Party[me.currentModule.params.LuckType].LuckName;
	        $("*[name=spLuckName]").html(this.LuckName);
	        $("#BtnAddLuck").val("添加" + this.LuckName);
	    }
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadlucklist(1);
        });

		$("#BtnAddLuck").unbind().bind('click', function (event) {
		    //me.execCommand('go', { a: 'weixy', b: 'luckedit', params: me.currentModule.params });
		    me.execCommand('go', { a: 'weixy', b: 'partyedit', params: me.currentModule.params });
			return false;
        });
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("Lid"), LuckType: $(this).attr("data-type") }
			me.execCommand('go', { a: 'weixy', b: 'partyedit', params: params });
			return false;
        });

		$("*[name=BtnGoLuckLog]").unbind('click').bind('click', function (event) {
			var params = {lid: $(this).attr("Lid"), LuckType:me.currentModule.params.LuckType, LuckName:me.currentModule.params.LuckName }
            me.execCommand('go', { a: 'weixy', b: 'luckusers', params: params });
			return false;
        });

		$("*[name=BtnExport]").unbind('click').bind('click', function (event) {
		    //var params = { lid: $(this).attr("Lid"), LuckType: me.currentModule.params.LuckType, LuckName: me.currentModule.params.LuckName }
		    window.open('/index.php?c=admin/weiyx/luckmanage&a=export&lid=' + $(this).attr("Lid"));
		    return false;
		});

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			// $.getJSON("/admin/weixy/luckmanage?act=Delete", utils.params({id:$(this).attr("Lid")}), function (json) {
            $.getJSON("/index.php?c=admin/weiyx/luck&a=Delete", utils.params({id:$(this).attr("Lid")}), function (json) {         
				if(json.success){
					if(itemcount > 1) loadlucklist(curpage);
					else loadlucklist(1);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetStatus]").unbind('click').bind('click', function (event) {
			// $.getJSON("/admin/weixy/luckmanage?act=setstatus", utils.params({id:$(this).attr("Lid"),status: $(this).attr("LuckStatu")}), function (json) {
            $.getJSON("/index.php?c=admin/weiyx/luck&a=setstatus", utils.params({id:$(this).attr("Lid"),status: $(this).attr("LuckStatu")}), function (json) { 
				if(json.success){
					loadlucklist(curpage);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
		});
        $(".QrCode").mouseover(function () {
		    // var img = $('<img class="QRCode" style="position:absolute;width:150px;height:150px;top:-60px;z-index:10;border:solid 10px #fff;" src="/admin/weixy/luckmanage?act=qrcode&id=' + $(this).attr("data-val") + '"/>')
            var img = $('<img class="QRCode" style="position:absolute;width:150px;height:150px;top:-60px;z-index:10;border:solid 10px #fff;" src="/index.php?c=admin/weiyx/luck&a=qrcode&id=' + $(this).attr("data-val") + '"/>'); 
		    $(this).parent().append(img);
		}).mouseout(function () {
		    $(".QRCode").remove();
		});
    }

    me.addListener('lucklist', function (key, args) {
        args.addClass('row');
        initUI(args);
        
    });
}

﻿IWF.plugins['lucknew'] = function () {
    this.addListener('lucknew', function (key, args) {
        args.loadHtmlTpl("plugins/weixypackage/html/lucknew.html", function () {
			if(!me.hasLicensePerm("ENABLE_WEIXIN") && window["WeixyAdModalShow"] != 1){
				$("#AdModal").modal();
				window["WeixyAdModalShow"] = 1;
				return;
			}
		});		
    });
};
﻿IWF.plugins['luckusers'] = function () {

    // var me = this,url="/admin/weixy/luckmanage";
    var me = this,url="/index.php?c=admin/weiyx/luck";
    var curpage = 1,pagesize = 10, itemcount=0;
	var ViewModel = function () {
        this.luckusers = ko.observableArray();
		this.luckinfo = {};
		this.setData = function (list, luck) { this.luckinfo = luck; this.luckusers(list); };
		this.CheckOut = function (obj, e) {
		    // $.post(url, { 'act': 'CheckOut', "id": obj.LogId, 'luckid': obj.Lid, "state": obj.State ? 1 : 0 },
            $.post(url, { 'a': 'CheckOut', "id": obj.LogId, 'luckid': obj.Lid, "state": obj.State ? 1 : 0 }, 
               function (data) {
                   if (data.success) {
                       LoadLuckusers();
                   }
               }, "json");
		};
		this.getTime = function(time){
			return time.replace(/T/gi," ").replace(/(\.\d+)/,"");
		}
		this.getLevel = function(number){
			var LuckAward = this.luckinfo.LuckAward;
			LuckAward = LuckAward.replace("\\\"","\"");
			eval("var LuckAwardObj = " + LuckAward);
			var level = "未中奖";
            for (var i = 0; i < LuckAwardObj.length; i++)
            {
                if ( i + 1 == number)
                {
					level = LuckAwardObj[i].level;
                    break;
                }
            }
		    return level;
		}
		this.getAward = function(number){
			var LuckAward = this.luckinfo.LuckAward;
			LuckAward = LuckAward.replace("\\\"","\"");
			eval("var LuckAwardObj = " + LuckAward);
			var award = "没有奖品";
            for (var i = 0; i < LuckAwardObj.length; i++)
            {
				if ( i + 1 == number)
                {
					award = LuckAwardObj[i].award;
                    break;
                }
            }
		    return award;
		}
    };

	var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/luckusers.html",function(){
			bindUIEvent();
			ko.applyBindings(vm,root[0]);
			LoadLuckusers();
		});
    }
	    
	
    function LoadLuckusers() {

        // $.getJSON("/admin/weixy/luckmanage?act=getluckusers", { lid: me.currentModule.params.lid, page: curpage, pagesize: pagesize,key:$("#key").val() }, function (json) {
        $.getJSON("/index.php?c=admin/weiyx/luck&a=getluckusers", { lid: me.currentModule.params.lid, page: curpage, pagesize: pagesize,key:$("#key").val() }, function (json) {
            console.log(json);
            vm.setData(json.list,json.luckinfo);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(curpage, json.pagecount, 10, function (page) {
                    curpage = page;
                    LoadLuckusers();
                });
                $("#pagination").show();
            }

            bindGridEvent();
        });
    }

	function bindUIEvent(){
		$("*[name=spLuckName]").html(me.currentModule.params.LuckName);

		$("#BtnSearch").unbind('click').bind('click', function (event) {
			LoadLuckusers();
        });

		$("#BtnBack").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'weixy', b: 'lucklist',params:{LuckType: me.currentModule.params.LuckType, LuckName: me.currentModule.params.LuckName } });
			return false;
        });
	}

    function bindGridEvent() {
        $("*[name=BtnGoUser]").unbind('click').bind('click', function (event) {
			var params = {UserGUID: $(this).attr("UserGUID")};
            me.execCommand('go', { a: 'business', b: 'useredit', params: params });
			return false;
        });
    }

    me.addListener('luckusers', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['packmerge'] = function () {
    var me = this, url = "/admin/weixy/redpack";
    Date.prototype.AddDays = function (day) {
        this.time = this.valueOf();
        if (day && !isNaN(day)) {
            this.time += (day * 60 * 60 * 24 * 1000);
        }
        this.nd = new Date(this.time);
        this.setYear(this.nd.getFullYear());
        this.setMonth(this.nd.getMonth());
        this.setDate(this.nd.getDate());
        this.setHours(this.nd.getHours());
        this.setMinutes(this.nd.getMinutes());
        this.setSeconds(this.nd.getSeconds());
        this.setMilliseconds(this.nd.getMilliseconds());
    }
    Date.prototype.FormatString = function () {
        this.date = this.valueOf();
        this.dt = new Date(this.date);
        return [this.dt.getFullYear(), "-", this.dt.getMonth() + 1, "-", this.dt.getDate(), " ", this.dt.getHours(), ":", this.dt.getMinutes(), ":00"].join("");
    }
    function BindUpLoadImg(args) {
        $('.BtnCover', args).off("click").on('click', function (e) {
            var _this = $(this);
            var _thisInput = _this.prev();
            
            YDM.FileManager('image', 1, function (aUrl) {
                if (aUrl.length > 0) {
                    if (_thisInput.is("input") && _thisInput.attr("id")) {
                        var viewBody = $(window.frames["frameView"].document.body);
                        if ("wximage" == _thisInput.attr("id").toLowerCase()) {
                            if (_this.next().is("img")) {
                                _this.next().attr("src", aUrl[0]);
                            } else {
                                _this.after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", aUrl[0]));
                            }
                        }
                        _thisInput.val(aUrl[0]);
                    }
                }
            });
        });
    };
    function initFormEvent() {
        ///当前时间与传入的时间比较
        jQuery.validator.addMethod("CKDate", function (value, element, params) {
            var ereg = /^(\d{1,4})(-|\/)(\d{1,2})(-|\/)(\d{1,2})(\s{1})(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            var s = value.match(ereg);
            if (s == null) {
                return false;
            }
            var e = $(params).val().match(ereg);
            var sDate = Number(new Date(s[1], s[3] - 1, s[5], s[7], s[8], s[9]).valueOf());
            var eDate = Number(new Date(e[1], e[3] - 1, e[5], e[7], e[8], e[9]).valueOf());
            return this.optional(element) || ((sDate - eDate) > 0);
        }, jQuery.validator.format("当前时间不能早于{0}的时间."));
        jQuery.validator.addMethod("IsDate", function (value, element) {
            var ereg = /^(\d{1,4})(-|\/)(\d{1,2})(-|\/)(\d{1,2})(\s{1})(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            var r = value.match(ereg);
            if (r == null) {
                return false;
            }
            var d = new Date(r[1], r[3] - 1, r[5], r[7], r[8], r[9]);
            var result = (d.getFullYear() == r[1] && (d.getMonth() + 1) == r[3] && d.getDate() == r[5] && d.getHours() == r[7] && d.getMinutes() == r[8] && d.getSeconds() == r[9]);
            return this.optional(element) || (result);
        }, "请输入正确的日期");
        jQuery.validator.addMethod("valuelength", function (value, element, params) {
            var val = value.replace(/[^\w\u4e00-\u9fa5]/ig, "");
            var length = (val.replace(/[^\u4e00-\u9fa5]/g, "").length * 3) + value.replace(/[^\w]/ig, "").length;
            return this.optional(element) || length <= params;
        }, jQuery.validator.format("长度不能超{0}字符."));

        $("#MainForm").validate({
            invalidHandler: function () {
                $(".gray").removeClass("gray");
            },
            rules: {
                ActName: { required: true, valuelength: 32 }
                , SendName: { required: true, valuelength: 32 }
                , Wishing: { required: true, valuelength: 120 }
                , AmountCount: { required: true, number: true, min: 1 }
				, WxImage: "required"
                , RedPackCount: { required: true, number: true, min: 1 }
                , MinAmount: { required: true, number: true, range: [0.5, 200] }
                , MaxAmount: { required: true, number: true, range: [0.5, 200] }
                , Description: "required"
				, SDate: { required: true, IsDate: true }
				, EDate: { required: function () { return $("#SDate").val() != ""; }, IsDate: true, CKDate: "#SDate" }
            },
            messages: {
                ActName: { required: "请输入投票标题！" }
                , SendName: { required: "请输入发送者简称" }
                , Wishing: { required: "请输入祝福语" }
                , AmountCount: { required: "请输入红包总额！", number: "只能输入数字！", min: "红包红包总额不能小于1元！" }
				, WxImage: "请上传封面图！"
                , RedPackCount: { required: "请输入红包个数！", number: "只能输入数字！", min: "红包个数最小不能为零！" }
                , MinAmount: { required: "请输入红包最小面值！", number: "只能输入数字！", range: $.validator.format("最小面值不能小于{0}元大于{1}元！") }
                , MaxAmount: { required: "请输入红包最大面值！", number: "只能输入数字！", range: $.validator.format("最大面值不能小于{0}元大于{1}元！") }
                , Description: "请输入简介"
				, SDate: { required: "请输入活动开始时间！", IsDate: "正确的日期格式：2015-01-01 12:00:00" }
				, EDate: { required: "请输入活动结束时间！", IsDate: "正确的日期格式：2015-01-01 18:00:00", CKDate: "结束时间不能早于开始时间！" }
            },
            submitHandler: function (form) {
                submitForm();
                return false;
            },
            ignore: []
        });

		$("<div></div>").appendTo(myroot).load("/admin/widget/WxPaySetting.html?v=" + Math.random(), function(){
			$('.btnShowWxPaySetting').wxPaySetting();
		});
		
    };
    function submitForm() {
        //var params = $('#MainForm').serialize() + "&act=Save";
    	var params = $('#MainForm').serialize();
        //$.post(url, params, function (data) {
    	$.post("/index.php?c=admin/Weiyx/RedPack&a=Save", params, function (data) {
            if (data&& data.success) {
                $('<div id="success">保存成功</div>').dialog({
                    modal: true, width: 400, close: function () {
                        $("#success").dialog("destroy");
                        me.execCommand('go', { a: 'weixy', b: 'packmergelist' });
                    }
                });
            } else {
                $('<div id="error">' + data.msg + '</div>').dialog({
                    modal: true, width: 400, title: "保存失败", close: function () { $("#error").dialog("destroy"); }
                });
            }
        }, "json");
    };
    var myroot = null;
    this.addListener('packmerge', function (key, args) {
        args.loadHtmlTpl("plugins/weixypackage/html/packmerge.html?v=" + Math.random(), function () {
            myroot = args[0];
            $("#voteTabs").tabs();
            $('#SDate,#EDate').datetimepicker({
                dayOfWeekStart: 1,
                lang: 'ch',
                format: 'Y-m-d H:i:00'
            });
            BindUpLoadImg(args);
            initFormEvent();
            BindOnEvent();
            $("#voteTabs").on("tabsactivate", function (event, ui) {
                this.index = $("#voteTabs").tabs("option", "active");
                var viewBody = $(window.frames["frameView"].document.body);
                if (this.index == 1) {
                    viewBody.find("#content").html(ue.getContent());
                    viewBody.find("#Detail").modal();
                    $(".modal-backdrop").css({ "z-index": "-1","width":"0","height":"0","top":"0","buttom":"0" });
                } else {
                    viewBody.find("#Detail").modal("hide");
                }
            });
            if (me.currentModule.params && me.currentModule.params.id) {
                LoadInfo(me.currentModule.params.id);
                $(".IsEdit").show();
                $("#LinkMenu").off("click").on("click", function () {
                    me.execCommand('go', { a: 'weixin', b: 'wxmenu' });
                });
            } else {
                this.date = new Date();
                $("#SDate").val(this.date.FormatString());
                this.date.AddDays(10);
                $("#EDate").val(this.date.FormatString());

                initUE();
                $("#link").attr("disabled", 'disabled').val("保存后才可以生成相应的链接！");
            }
            
            if ($("#WxImage").val() != "") {
                if ($(".BtnCover").next().is("img")) {
                    $(".BtnCover").next().attr("src", $("#WxImage").val());
                } else {
                    $(".BtnCover").after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", $("#WxImage").val()));
                }
            }
        });
    });
    var voteModel = function () {
        this.setData = function (data) {
            for (var key in data) {
                if (typeof (data[key]) == "object")
                { this[key] = ko.observableArray(data[key]); }
                else {
                    this[key] = ko.observable(data[key]);
                }
            }
        };
        this.key = ko.observable();
        this.link = ko.observable();
        this.Format = function (n) {
            return n().replace(/T/g, " ");
        };
    };
    var vm = new voteModel();
    function LoadInfo(id) {
        $.ajax({
            type: "POST",
            //url: url,
            url: "/index.php?c=admin/Weiyx/RedPack&a=GetRedPack",
            cache: false,
            dataType: "json",
            //data: { 'act': 'GetRedPack', 'id': id,'packtype':1 },
            data: { 'id': id,'packtype':1 },
            success: function (data) {
                if (data != null) {
                    if (data.success) {
                        vm.setData(data.info)
                        vm.key(data.key);
                        vm.link(data.link);
                        $("#WxShow").attr("src", data.info.WxImage);
                        //$('<img style="width:200px;height:200px;border:solid 10px #fff;" src="/admin/weixy/redpack?act=qrcode&packtype=1&id=' + data.info.Rid + '"/>').appendTo($(".qrcode"));
                        $('<img style="width:200px;height:200px;border:solid 10px #fff;" src="/index.php?c=admin/weiyx/RedPack&a=qrcode&packtype=1&id=' + data.info.Rid + '"/>').appendTo($(".qrcode"));
                        ko.applyBindings(vm, document.getElementById("voteTabs"));
                        initUE();
                    }
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    };
    function BindOnEvent() {
        $("input[type='text']").on("keyup focus", function (e) {
            var _this = $(e.target);
            var viewBody = $(window.frames["frameView"].document.body);
            if ("banner" == _this.attr("id").toLowerCase()) {
                viewBody.find("#Banner").attr("src", _this.val());
                e.preventDefault();
            }
        });
        $(document).off("click.xxxx").on("click.xxxx", function (e) {
            var _this = $(e.target);
            if (_this.hasClass("imgshow")) {
                $('<div></div>').dialog({
                    modal: true, width: 680, height: 600, position: { my: "center center", at: "center center", of: window },
                    open: function (event, ui) {
                        $(this).append('<img src="'+_this.attr("src")+'" style="width:100%"/>');
                    },
                    close: function () {
                        $(this).dialog("destroy");
                    }
                });
            };
        });
    };
    var ue = null;
    function initUE() {
        var html = $('#Detail').val() == "" ? "活动规则：<br/>活动范围：<br />活动人群：<br />" : $('#Detail').val();
        ue = new baidu.editor.ui.Editor({
            toolbars: [[
                'removeformat','bold', 'italic', 'underline', 'strikethrough'
                , 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
                , 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', 'link', 'unlink'
            ]]
        });

        ue.render('Detail');
        ue.ready(function () {
            ue.setContent(UE.utils.html(html));
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#content").html(ue.getContent());
        });
        ue.addListener('contentChange', function (editor) {
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#content").html(ue.getContent());
        });
    }
};
﻿IWF.plugins['packmergelist'] = function () {

    var me = this, url = "/admin/weixy/redpack", curpage = 1, rcCount = 0, rcSize = 10, navSize = 10;

    var ViewModel = function () {
        var self = this;
        self.datalist = ko.observableArray();
        self.WeiXinId = ko.observable();
        self.State = function (obj, e) {
            $.ajax({
                type: "POST",
                //url: url,
                url: "/index.php?c=admin/Weiyx/RedPack&a=SetState",
                cache: false,
                context: $(e.target),
                dataType: "json",
                //data: { 'act': 'SetState', 'id': obj.Rid, 'state': $(e.target).data("state") },
                data: { 'id': obj.Rid, 'state': $(e.target).data("state") },
                success: function (data) {
                    if (data != null) {
                        if (data.success) {
                            var state = parseInt($(this).attr("data-state"));
                            $(this).attr("data-state", state ? 0 : 1);
                            $(this)[state ? "addClass" : "removeClass"]("glyphicon-eye-close");
                            $(this)[state == 0 ? "addClass" : "removeClass"]("glyphicon-eye-open");
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
        this.getTime = function (time) {
            return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
        }
        self.LoadDataList = function () {
            //$.post(url, { 'act': 'DataList','packtype':1, 'key': $("#keyword").val(), 'curpage': curpage, 'rcsize': rcSize }, function (data) {
        	$.post("/index.php?c=admin/Weiyx/RedPack&a=DataList", { 'packtype':1, 'key': $("#keyword").val(), 'curpage': curpage, 'rcsize': rcSize }, function (data) {
                if (data && data.success) {
                    console.log(data);
                    vm.datalist(data.list)
                    vm.WeiXinId(data.wxid);
                    rcCount = data.count;
                    var pageCount = Math.floor(rcCount % rcSize > 0 ? rcCount / rcSize + 1 : rcCount / rcSize);
                    if (pageCount < 2)
                    { $("#pagination").hide(); }
                    else {
                        $("#pagination").pageNav(curpage, pageCount, navSize, function (page) {
                            curpage = page;
                            self.LoadDataList();
                        });
                        $("#pagination").show();
                    }
                    bindGridEvent();
                }
            }, "json");
        };
    };
    var vm = new ViewModel();

    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/packmergelist.html", function () {
            bindUIEvent();
            ko.applyBindings(vm, root[0]);
            vm.LoadDataList();
        });
    }

    function bindUIEvent() {
        $("#BtnSearch").unbind('click').bind('click', function (event) {
            if ($("#keyword").val() != "") {
                vm.LoadDataList();
            }
        });
    }

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).data("rid") }
            me.execCommand('go', { a: 'weixy', b: 'packmerge', params: params });
            return false;
        });

        $("*[name=BtnGoJoin]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).data("rid") }
            me.execCommand('go', { a: 'weixy', b: 'redpackuser', params: params });
            return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
            if (!confirm("确认删除？")) return false;
            //$.post(url, { 'act': 'Delete', id: $(this).data("rid") }, function (data) {
            $.post("/index.php?c=admin/Weiyx/RedPack&a=Delete", { id: $(this).data("rid") }, function (data) {
                if (data&&data.success) {
                    vm.LoadDataList();
                } else {
                    $.showResult("出错啦", data.msg);
                }
            },"json");
            return false;
        });

        $(".QrCode").mouseover(function () {
            //var img = $('<img class="QRCode" style="position:absolute;width:150px;height:150px;top:-60px;z-index:10;border:solid 10px #fff;" src="/admin/weixy/redpack?act=qrcode&packtype=1&id=' + $(this).attr("data-val") + '"/>')
        	var img = $('<img class="QRCode" style="position:absolute;width:150px;height:150px;top:-60px;z-index:10;border:solid 10px #fff;" src="/index.php?c=admin/weiyx/RedPack&a=qrcode&packtype=1&id=' + $(this).attr("data-val") + '"/>')
            $(this).parent().append(img);
        }).mouseout(function () {
            $(".QRCode").remove();
        });
    }

    me.addListener('packmergelist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['partyedit'] = function () {

    var me = this;
    var ue = null;
    me.dHtml = ['<div id="imgDialog">'];
    me.dHtml.push('<div style="width:360px;height:100px;margin:auto;text-align:center;">');
    me.dHtml.push('<img id="img-show" src="${IMGSRC}" style="max-width:360px;max-height:100px;"/>');
    me.dHtml.push('</div>');
    me.dHtml.push('</div>');

    var ViewModel = function () {
        this.setData = function (data) {
            for (var key in data) {
                if (typeof (data[key]) == "object") this[key] = ko.observableArray(data[key]);
                else this[key] = ko.observable(data[key]);
            }
        };
        this.LuckKey = ko.observable();
        this.Link = ko.observable();
        this.getTime = function (time) {
            return time().replace(/T/g, " ");
        }
    };
    Date.prototype.AddDays = function (day) {
        this.time = this.valueOf();
        if (day && !isNaN(day)) {
            this.time += (day * 60 * 60 * 24 * 1000);
        }
        this.nd = new Date(this.time);
        this.setYear(this.nd.getFullYear());
        this.setMonth(this.nd.getMonth());
        this.setDate(this.nd.getDate());
        this.setHours(this.nd.getHours());
        this.setMinutes(this.nd.getMinutes());
        this.setSeconds(this.nd.getSeconds());
        this.setMilliseconds(this.nd.getMilliseconds());
    }
    Date.prototype.FormatString = function () {
        this.date = this.valueOf();
        this.dt = new Date(this.date);
        return [this.dt.getFullYear(), "-", this.dt.getMonth() + 1, "-", this.dt.getDate(), " ", this.dt.getHours(), ":", this.dt.getMinutes(), ":00"].join("");
    }
    var vm = new ViewModel();
    var myroot = null;
    window.awards = [];
    /*
    string KeyWord(微信触发关键词)
    string PartyImage(活动图)
    string IndexImage(首页背景)
    string StartImage(微信图文封面)
    string EndImage(活动结束)
    string NotImage(没中奖图片)
    */
    var defaultdata = [
        { LuckName: "幸运转盘", KeyWord: "幸运转转转", PartyImage: "/images/PartyImage/bigWheel.png", IndexImage: "/images/PartyImage/dzpHomeBg.jpg", StartImage: "/images/PartyImage/dzp.jpg", EndImage: "/images/PartyImage/end.png", NotImage: "/images/PartyImage/faiImg.png" },
	    { LuckName: "幸运转盘", KeyWord: "幸运转转转", PartyImage: "/images/PartyImage/bigWheel.png", IndexImage: "/images/PartyImage/dzpHomeBg.jpg", StartImage: "/images/PartyImage/dzp.jpg", EndImage: "/images/PartyImage/end.png", NotImage: "/images/PartyImage/faiImg.png" },
        { LuckName: "砸金蛋", KeyWord: "砸金蛋", PartyImage: "/images/PartyImage/eggFrenzy.png", IndexImage: "/images/PartyImage/zjdHomeBg.jpg", StartImage: "/images/PartyImage/zjd.jpg", EndImage: "/images/PartyImage/end.png", NotImage: "/images/PartyImage/faiImg.png" },
        { LuckName: "刮刮卡", KeyWord: "刮刮卡", PartyImage: "/images/PartyImage/scratchCard.png", IndexImage: "/images/PartyImage/ggkHomeBg.jpg", StartImage: "/images/PartyImage/ggk.jpg", EndImage: "/images/PartyImage/end.png", NotImage: "/images/PartyImage/faiImg.png" },
        { LuckName: "幸运卡片", KeyWord: "幸运卡片", PartyImage: "/images/PartyImage/luckyCard.png", IndexImage: "/images/PartyImage/xykpHomeBg.jpg", StartImage: "/images/PartyImage/xykp.jpg", EndImage: "/images/PartyImage/end.png", NotImage: "/images/PartyImage/faiImg.png" }
    ];
    var aModel = function () {
        this.list = ko.observableArray([]);
    }
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/partyedit.html?rand=" + Math.random(), function () {

			if (!me.hasLicensePerm('ENABLE_JIFEN')){
				$("input,select",root[0]).each(function(i,item){
					if(($(item).attr("name") + "").indexOf("JiFen") > -1){
						$(item).prop("readonly",true);
						$(item).css("height","50px");
						if($(item)[0].tagName == 'SELECT') $(item).hide();
					}
				});
				$("#forJiFenIn,#forJiFenOut").each(function(i,item){
					$(item).html($(item).html() + " <font color='red'><br>当前版本不支持积分功能，请升级到旗舰版以上</font>");
				});
			}

            $("*[name=spLuckName]").html(defaultdata[me.currentModule.params.LuckType].LuckName);
            $(".myAlertError").find(".close").unbind('click').click(function () {
                $("#divForm").show();
                $(".myAlertError").hide();
                return false;
            });

            $('#BtnSelStartImage', root).off().on('click', function () {
                YDM.FileManager('image', 1, function (aUrl) {
                    if (aUrl.length > 0) {
                        $('#StartImage').val(aUrl[0]);
                        $('#PreviewStartImage').attr("src", aUrl[0]);
                    }
                })
            });

            $('#BtnSelEndImage', root).off().on('click', function () {
                YDM.FileManager('image', 1, function (aUrl) {
                    if (aUrl.length > 0) {
                        $('#EndImage').val(aUrl[0]);
                        $('#PreviewEndImage').attr("src", aUrl[0]);
                    }
                })
            });

            //日期控件
            $('#StartTime,#EndTime').datetimepicker({
                dayOfWeekStart: 1,
                lang: 'ch',
                format: 'Y-m-d H:i:0'
            });

            $("#ImageStyle").change(function () {
                var img = ["<img src='/images/PartyImage/", $(this).val(), ".png'/>"].join('');
                $("#StyleShow").html(img);
            });

            initFormEvent();

            myroot = root[0];
            if (me.currentModule.params && me.currentModule.params.id) {
                loadInfo();
                $(".IsEdit").show();
            } else {
                this.date = new Date();
                $("#StartTime").val(this.date.FormatString());
                this.date.AddDays(10);
                $("#EndTime").val(this.date.FormatString());
                $(".IsEdit").hide();
                initUE();
            }
            var ti = me.currentModule.params.LuckType ? me.currentModule.params.LuckType : 1;
            Preview(root, ti);
        });
    }
    function Preview(root, ti) {
        var am = new aModel();
        ko.applyBindings(am, document.getElementById("awardList"));

        $("#party-image").attr("src", defaultdata[ti].PartyImage);
        $("#LuckType").val(ti);
        this.ii = $("#IndexImage").val().length == 0 ? defaultdata[ti].IndexImage : $("#IndexImage").val();
        $("#index").css({ "background": "url(" + this.ii + ")", "background-size": "100%", "background-repeat": "no-repeat" });
        this.si = $("#StartImage").val().length == 0 ? defaultdata[ti].StartImage : $("#StartImage").val();
        $(".weixin-img").css({ "background": "url(" + this.si + ")", "background-size": "100%", "background-repeat": "no-repeat" });
        this.ni = $("#RepeatImage").val().length == 0 ? defaultdata[ti].NotImage : $("#RepeatImage").val();
        $(".repeat-img").css({ "background": "url(" + this.ni + ")", "background-size": "100%", "background-repeat": "no-repeat" });
        this.ei = $("#EndImage").val().length == 0 ? defaultdata[ti].EndImage : $("#EndImage").val();
        $(".endImage").css({ "background": "url(" + this.ei + ")", "background-size": "100%", "background-repeat": "no-repeat" });
        var layer = 0;

        $("#party-tabs").tabs();
        $("#party-nav").tabs({ disabled: [1, 3, 5, 7, 9, 11] });
        $("#party-nav").on("tabsactivate", function (event, ui) {
            this.index = $("#party-nav").tabs("option", "active");
            layer = this.index == 0 ? this.index : this.index / 2;
            if (layer == 2) {
                $("#party-tabs").tabs({ active: 1 });
                var awardArr = new Array();
                for (var i = 0; i < 6; i++) {
                    awardArr.push({ level: $("#level" + i).val(), award: $("#award" + i).val() });
                }
                am.list(awardArr);
            }
            $("[data-group='tab']").hide();
            if (layer > 1) {
                $("[data-layer='1']").show();
            } else {
                $("[data-layer='1']").hide();
            }
            $("[data-layer='" + layer + "']").show();
        });
        $("#prevBtn,#nextBtn").disableSelection();
        $("#prevBtn").off("click").on("click", function () {
            layer--;
            if (layer < 0) {
                layer = 5;
            }
            $("#party-nav").tabs({ active: layer * 2 });
        });
        $("#nextBtn").off("click").on("click", function () {
            layer++;
            if (layer > 6) {
                layer = 0;
            }
            $("#party-nav").tabs({ active: layer * 2 });
        });
        /*加载表单默认值*/
        $("#weixin-title").text($("#LuckTitle").val());
        $("#party-title").text($("#LuckTitle").val());
        $("#start-time").text($("#StartTime").val());
        $("#end-time").text($("#EndTime").val());
        //$(".setDetail").text($("#LuckDetail").val());
        $("#repeat-tips").text($("#RepeatTips").val());
        $("#end-tips").text($("#EndTips").val());

        $(".close-panel").off("click").on("click", function () {
            $(this).parent().hide();
        });

        $(".bind-input").off("keyup focus").on("keyup focus", function (e) {
            console.log(123);
            if ("keyup" == e.type.toLowerCase()) {
                var awardArr = new Array();
                for (var i = 0; i < 6; i++) {
                    awardArr.push({ level: $("#level" + i).val(), award: $("#award" + i).val() });
                }
                am.list(awardArr);
            }
            if ("focus" == e.type.toLowerCase()) {
                var awardArr = new Array();
                for (var i = 0; i < 6; i++) {
                    awardArr.push({ level: $("#level" + i).val(), award: $("#award" + i).val() });
                }
                am.list(awardArr);
            }
        });

        $(".is-editor").off("mouseover").on("mouseover", function (e) {
            var _this = $(e.target);
            if ("mouseover" == e.type.toLowerCase()) {
                if (_this.hasClass("party-help")) {
                    e.stopPropagation();
                }
                if (_this.hasClass("is-editor")) {
                    $(".hoveractive").removeClass("hoveractive");
                    _this.addClass("hoveractive");
                    _this.append('<div class="party-help">编辑</div>');
                    this.w = _this.width() - 40;
                    $(".party-help").css({ "top": "0", "right": "0px" });
                    $(".party-help").click(function (e) {
                        this.val = _this.attr("data-val").toLowerCase();
                        if ("setparty" == this.val) {
                            $("#party-tabs").tabs({ active: 1 });
                        } else {
                            $("#party-tabs").tabs({ active: 0 });
                        }
                        //首页背景
                        if ("setindex" == this.val) {
                            this.indexEmpty = $("#IndexImage").val().length == 0;
                            this.indeximg = this.indexEmpty ? defaultdata[ti].IndexImage : $("#IndexImage").val();
                            this.indexDialog = me.dHtml.join('').replace('${IMGSRC}', this.indeximg);

                            $(this.indexDialog).dialog({
                                modal: true, width: 400, title: "首页背景",
                                buttons: {
                                    "替换图片": function () {
                                        YDM.FileManager('image', 1, function (aUrl) {
                                            $("#index").css({ "background": "url(" + aUrl + ")", "background-size": "100%", "background-repeat": "no-repeat" });
                                            $("#IndexImage").val(aUrl);
                                            $("#imgDialog").dialog("destroy");
                                        });
                                    }, "默认图片": function () {
                                        $("#index").css({ "background": "url(" + defaultdata[ti].IndexImage + ")", "background-size": "100%", "background-repeat": "no-repeat" });
                                        $("#IndexImage").val("");
                                        $("#imgDialog").dialog("destroy");
                                    }
                                },
                                close: function () {
                                    $("#imgDialog").dialog("destroy");
                                }
                            });
                        }
                        //活动结束
                        if ("endimg" == this.val) {
                            this.endEmpty = $("#EndImage").val().length == 0;
                            this.endimg = this.endEmpty ? defaultdata[ti].EndImage : $("#EndImage").val();

                            this.endcontent = me.dHtml.join('').replace('${IMGSRC}', this.endimg);

                            $(this.endcontent).dialog({
                                modal: true, width: 400, title: "活动结束",
                                buttons: {
                                    "替换图片": function () {
                                        YDM.FileManager('image', 1, function (aUrl) {
                                            $(".endImage").css({ "background": "url(" + aUrl + ")", "background-size": "100%", "background-repeat": "no-repeat" });
                                            $("#EndImage").val(aUrl);
                                            $("#imgDialog").dialog("destroy");
                                        });
                                    },
                                    "默认图片": function () {
                                        $(".endImage").css({ "background": "url(" + defaultdata[ti].EndImage + ")", "background-size": "100%", "background-repeat": "no-repeat" });
                                        $("#EndImage").val("");
                                        $("#imgDialog").dialog("destroy");
                                    }
                                },
                                close: function () {
                                    $("#imgDialog").dialog("destroy");
                                }
                            });
                        }
                        //封面
                        if ("setcover" == this.val) {
                            this.startEmpty = $("#StartImage").val().length == 0;
                            this.img = this.startEmpty ? defaultdata[ti].StartImage : $("#StartImage").val();
                            this.startContent = me.dHtml.join('').replace('${IMGSRC}', this.img);

                            $(this.startContent).dialog({
                                modal: true, width: 400, title: "微信图文封面",
                                buttons: {
                                    "替换图片": function () {
                                        YDM.FileManager('image', 1, function (aUrl) {
                                            $(".weixin-img").css({ "background": "url(" + aUrl + ")", "background-size": "100%", "background-repeat": "no-repeat" });
                                            $("#StartImage").val(aUrl);
                                            $("#imgDialog").dialog("destroy");
                                        });
                                    },
                                    "默认图片": function () {
                                        $(".weixin-img").css({ "background": "url(" + defaultdata[ti].StartImage + ")", "background-size": "100%", "background-repeat": "no-repeat" });
                                        $("#StartImage").val("");
                                        $("#imgDialog").dialog("destroy");
                                    }
                                },
                                close: function () {
                                    $("#imgDialog").dialog("destroy");
                                }
                            });
                        }
                        //没中奖
                        if ("backimage" == this.val) {
                            this.empty = $("#RepeatImage").val().length == 0;
                            this.notImage = this.empty ? defaultdata[ti].NotImage : $("#RepeatImage").val();
                            this.noluck = me.dHtml.join('').replace('${IMGSRC}', this.notImage);
                            $(this.noluck).dialog({
                                modal: true, width: 400, title: "没中奖图片",
                                buttons: {
                                    "替换图片": function () {
                                        YDM.FileManager('image', 1, function (aUrl) {
                                            $("#RepeatImage").val(aUrl);
                                            _this.css({ "background-image": "url(" + aUrl + ")", "background-size": "100%", "background-repeat": "no-repeat" });
                                            $("#imgDialog").dialog("destroy");
                                        });
                                    },
                                    "默认图片": function () {
                                        $("#RepeatImage").val("");
                                        _this.css({ "background-image": "url(" + defaultdata[ti].NotImage + ")", "background-size": "100%", "background-repeat": "no-repeat" });
                                        $("#imgDialog").dialog("destroy");
                                    }
                                },
                                close: function () {
                                    $("#imgDialog").dialog("destroy");
                                }
                            });
                        }
                        this.target = $("." + _this.attr("data-val"));
                        $(".editing").removeClass("editing");
                        this.target.not(".notborder").addClass("editing");
                        e.stopPropagation();
                    });

                    _this.hover(null, function () {
                        $(this).removeClass("hoveractive");
                        $(".party-help").remove();
                        e.stopPropagation();
                    });
                }
                e.stopPropagation();
            }
        });

        $("#LuckTitle", root).off("keyup focus").on("keyup focus", function () {
            $(this).parent().removeClass("editing");
            $("#party-title").text($(this).val());
            $("#weixin-title").text($(this).val());
        });
        $("#LuckTips", root).off("keyup focus").on("keyup focus", function () {
            $(this).parent().removeClass("editing");
            $("#setTips").text($(this).val());
        });
        $("#UserLimit", root).off("keyup focus").on("keyup focus", function () {
            $(this).parent().removeClass("editing");
            $("#luck-num").text($(this).val());
        });
        $("#LuckDetail", root).off("keyup focus").on("keyup focus", function () {
            $(this).parent().removeClass("editing");
            this.content = $(this).val();
            if (this.content.length > 0) {
                this.content = this.content.replace(/[\n\r]/ig, '<br/>');
                $(".setDetail").html(this.content);
            }
        });
        $("#RepeatTips", root).off("keyup focus").on("keyup focus", function () {
            $(this).parent().removeClass("editing");
            $("#repeat-tips").text($(this).val());
        });
        $("#EndTips", root).off("keyup focus").on("keyup focus", function () {
            $(this).parent().removeClass("editing");
            $("#end-tips").text($(this).val());
        });
        $("#StartTime", root).off("blur").on("blur", function () {
            $(this).parent().removeClass("editing");
            $("#start-time").text($(this).val());
        });
        $("#EndTime", root).off("blur").on("blur", function () {
            $(this).parent().removeClass("editing");
            $("#end-time").text($(this).val());
        });
        /*=================*/
        $(".user-head").off("click").on("click", function () {
            $("#party-nav").tabs({ active: 10 });
        });
        $("#LoadAward").off("click").on("click", function () {
            $("#award").show();
            $("#party-tabs").tabs({ active: 1 });
            $("#party-nav").tabs({ active: 4 });
            $("#award").show();
            var awardArr = new Array();
            for (var i = 0; i < 6; i++) {
                awardArr.push({ level: $("#level" + i).val(), award: $("#award" + i).val() });
            }
            am.list(awardArr);
        });
    }

    function initFormEvent() {
        ///当前时间与传入的时间比较
        jQuery.validator.addMethod("CKDate", function (value, element, params) {
            var ereg = /^(\d{1,4})(-|\/)(\d{1,2})(-|\/)(\d{1,2})(\s{1})(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            var s = value.match(ereg);
            if (s == null) {
                return false;
            }
            var e = $(params).val().match(ereg);
            var sDate = Number(new Date(s[1], s[3] - 1, s[5], s[7], s[8], s[9]).valueOf());
            var eDate = Number(new Date(e[1], e[3] - 1, e[5], e[7], e[8], e[9]).valueOf());
            return this.optional(element) || ((sDate - eDate) > 0);
        }, jQuery.validator.format("当前时间不能早于{0}的时间."));
        jQuery.validator.addMethod("IsDate", function (value, element) {
            var ereg = /^(\d{1,4})(-|\/)(\d{1,2})(-|\/)(\d{1,2})(\s{1})(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            var r = value.match(ereg);
            if (r == null) {
                return false;
            }
            var d = new Date(r[1], r[3] - 1, r[5], r[7], r[8], r[9]);
            var result = (d.getFullYear() == r[1] && (d.getMonth() + 1) == r[3] && d.getDate() == r[5] && d.getHours() == r[7] && d.getMinutes() == r[8] && d.getSeconds() == r[9]);
            return this.optional(element) || (result);
        }, "请输入正确的日期");
        $("#MainForm").validate({
            invalidHandler: function () {
                $(".gray").removeClass("gray");
            },
            rules: {
                LuckTitle: { required: true }
				, LuckTips: "required"
				, RepeatTips: "required"
				, EndTips: "required"
				, level0: "required"
				, level1: "required"
				, level2: "required"
				, award0: "required"
				, award1: "required"
				, award2: "required"
				, count0: { required: true, digits: true }
				, count1: { required: true, digits: true }
				, count2: { required: true, digits: true }
                , count3: { digits: true }
                , count4: { digits: true }
                , count5: { digits: true }
				, rate0: { required: true, digits: true }
				, rate1: { required: true, digits: true }
				, rate2: { required: true, digits: true }
                , rate3: { digits: true }
                , rate4: { digits: true }
                , rate5: { digits: true }
				, StartTime: { required: true, IsDate: true }
				, EndTime: { required: function () { return $("#StartTime").val() != ""; }, IsDate: true, CKDate: "#StartTime" }
				, UserLimit: { required: true, digits: true }
				, LuckLimit: { required: true, digits: true }
                , TotalUserLimit: { required: true, digits: true}
                , TotalLuckLimit: { required: true, digits: true}
                , JiFenOut: { required: true, digits: true}
            },
            messages: {
                LuckTitle: { required: "请输入活动标题！" }
				, LuckTips: "请输入中奖提示！"
				, RepeatTips: "请输入重复抽奖提示！"
				, EndTips: "请输入活动结束提示！"
				, level0: "请输入奖项类别"
				, level1: "请输入奖项类别"
				, level2: "请输入奖项类别"
				, award0: "请输入奖品内容"
				, award1: "请输入奖品内容"
				, award2: "请输入奖品内容"
				, count0: { required: "", digits: "数量只能输入整数" }
				, count1: { required: "", digits: "数量只能输入整数" }
				, count2: { required: "", digits: "数量只能输入整数" }
                , count3: { digits: "数量只能输入整数" }
                , count4: { digits: "数量只能输入整数" }
                , count5: { digits: "数量只能输入整数" }
				, rate0: { required: "", digits: "概率只能是整数" }
				, rate1: { required: "", digits: "概率只能是整数" }
				, rate2: { required: "", digits: "概率只能是整数" }
                , rate3: { digits: "概率只能是整数" }
                , rate4: { digits: "概率只能是整数" }
                , rate5: { digits: "概率只能是整数" }
				, StartTime: { required: "请输入活动开始时间！", date: "正确的日期格式：2015-01-01 12:00:00" }
				, EndTime: { required: "请输入活动结束时间！", date: "正确的日期格式：2015-01-01 18:00:00", CKDate: "结束时间不能早于开始时间！" }
				, UserLimit: { required: "0:无限/天;n次/天", digits: "<span style='color:#ca0000;'>只能输入数值！</span>" }
				, LuckLimit: { required: "0:无限/天;n次/天", digits: "<span style='color:#ca0000;'>只能输入数值！</span>" }
                , TotalUserLimit: { required: "0:无限", digits: "<span style='color:#ca0000;'>只能输入数值！</span>"}
                , TotalLuckLimit: { required: "0:无限", digits: "<span style='color:#ca0000;'>只能输入数值！</span>"}
                , JiFenOut: { required: "参加此活动需要使用多少积分，0表示不需要积分", digits: "<span style='color:#ca0000;'>只能输入数值！</span>"}
            },
            submitHandler: function (form) {
                submitForm();
                return false;
            },
            ignore: []
        });
    }
    function initUE() {
        var html = $('#LuckDetail').val() == '' ? '中奖后凭兑奖码联系xxx即可兑奖' : $('#LuckDetail').val();
        ue = new baidu.editor.ui.Editor({
            initialFrameWidth: "360",
            initialFrameHeight: "350",
            autoHeightEnabled: true,
            toolbars: [[
                 'bold', 'italic', 'underline', 'strikethrough', 'removeformat'
                , 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
                , 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify'
                , 'imagenone', 'imageleft', 'imageright', 'imagecenter'
            ]]
        });
        ue.ready(function () {
            ue.setContent(UE.utils.html(html));
        });
        ue.addListener('contentChange', function (editor) {
            $(".setDetail").html(ue.getContent());
        });
        ue.render('LuckDetail');
    }

    function loadInfo() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        console.log(params);
        // $.getJSON("/admin/weixy/luckmanage?act=GetInfo", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/luck&a=GetInfo", utils.params(params), function (json) {
            console.log(json);
            vm.setData(json.info);
            vm.LuckKey(json.key);
            vm.Link(json.link);
            ko.applyBindings(vm, document.getElementById("party-tabs"));
            if (json.info.Lid.length > 0 && json.setWeiXin) {
                // $('<img style="width:200px;" />').attr("src", "/admin/weixy/luckmanage?act=qrcode&id=" + json.info.Lid).appendTo($("#QRCode"));
                $('<img style="width:200px;" />').attr("src", "/index.php?c=admin/weiyx/luck&a=qrcode&id=" + json.info.Lid).appendTo($("#QRCode"));
                $("#LinkMenu").off("click").on("click", function () {
                    me.execCommand('go', { a: 'weixin', b: 'wxmenu' });
                });
            } else {
                $(".IsEdit").hide();
            }
            initUE();
            window.awards = $.parseJSON(json.info.LuckAward);
            $.each(awards, function (i, n) {
                if (typeof (n) == "object") {
                    $("#level" + i).val(n.level);
                    $("#award" + i).val(n.award);
                    $("#count" + i).val(n.count);
                    $("#rate" + i).val(n.rate);
                }
            });
        });
    }

    function submitForm(form) {
        if ($('#TotalUserLimit').val() !== '0' && parseInt($('#TotalUserLimit').val()) < parseInt($('#UserLimit').val())) {
            alert('总抽奖机会不能少于每天抽奖机会');
            return;
        }
        //每天抽奖机会为0  总抽奖次数不为0 
        if (parseInt($('#UserLimit').val()) <= 0 && parseInt($('#TotalUserLimit').val()) > 0){
            alert('总抽奖机会不能少于每天抽奖机会');
            return;
        }
        if ($('#TotalLuckLimit').val() !== '0' && parseInt($('#TotalLuckLimit').val()) < parseInt($('#LuckLimit').val())) {
            alert('中奖总限制不能少于每天中奖限制');
            return;
        }
        //每天中奖次数为0  总中奖次数不为0 
        if (parseInt($('#LuckLimit').val()) <= 0 && parseInt($('#TotalLuckLimit').val()) > 0) {
            alert('中奖总限制不能少于每天中奖限制');
            return;
        }
        //中奖概率限制
        var ratesum = 0;
        $("[name^='rate']").each(function(){
            ratesum += parseInt($(this).val());
        });
        if(ratesum > 100){
            alert("所有奖项的中奖概率值之和不能超过100%!");
            return;
        }
        var params = $('#MainForm').serializeObject();
        // $.post("/admin/weixy/luckmanage?act=Edit", params, function (data, textStatus, jqXHR) {
        $.post("/index.php?c=admin/weiyx/luck&a=Edit", params, function (data, textStatus, jqXHR) {
            if (data.success) {
                $('<div id="success">保存成功！<br/>' + data.msg + '</div>').dialog({
                    modal: true, width: 400, close: function () {
                        $("#success").dialog("destroy");
                        me.execCommand('go', { a: 'weixy', b: 'lucklist', params: { LuckType: me.currentModule.params.LuckType } });
                    }
                });
            } else {
                $('<div id="error">' + data.msg + '</div>').dialog({
                    modal: true, width: 400, title: "保存成功", close: function () { $("#error").dialog("destroy"); }
                });
            }
        }, "json");
    }
    me.addListener('partyedit', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['redpack'] = function () {
    var me = this, url = "/admin/weixy/redpack";
    Date.prototype.AddDays = function (day) {
        this.time = this.valueOf();
        if (day && !isNaN(day)) {
            this.time += (day * 60 * 60 * 24 * 1000);
        }
        this.nd = new Date(this.time);
        this.setYear(this.nd.getFullYear());
        this.setMonth(this.nd.getMonth());
        this.setDate(this.nd.getDate());
        this.setHours(this.nd.getHours());
        this.setMinutes(this.nd.getMinutes());
        this.setSeconds(this.nd.getSeconds());
        this.setMilliseconds(this.nd.getMilliseconds());
    }
    Date.prototype.FormatString = function () {
        this.date = this.valueOf();
        this.dt = new Date(this.date);
        return [this.dt.getFullYear(), "-", this.dt.getMonth() + 1, "-", this.dt.getDate(), " ", this.dt.getHours(), ":", this.dt.getMinutes(), ":00"].join("");
    }
    function BindUpLoadImg(args) {
        $('.BtnCover', args).off("click").on('click', function (e) {
            var _this = $(this);
            var _thisInput = _this.prev();

            YDM.FileManager('image', 1, function (aUrl) {
                if (aUrl.length > 0) {
                    if (_thisInput.is("input") && _thisInput.attr("id")) {
                        var viewBody = $(window.frames["frameView"].document.body);
                        if ("wximage" == _thisInput.attr("id").toLowerCase()) {
                            if (_this.next().is("img")) {
                                _this.next().attr("src", aUrl[0]);
                            } else {
                                _this.after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", aUrl[0]));
                            }
                        }
                        if ("backimage" == _thisInput.attr("id").toLowerCase()) {
                            var viewBody = $(window.frames["frameView"].document.body);
                            if (_this.next().is("img")) {
                                _this.next().attr("src", aUrl[0]);
                            } else {
                                _this.after($("<img id='BcShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", aUrl[0]));
                            }
                            console.log(viewBody.find(".redPack").html());
                            viewBody.find(".redPack").css({ "background-image": "url(" + aUrl[0] + ")" });//.attr("src", aUrl[0]);
                        }
                        _thisInput.val(aUrl[0]);
                    }
                }
            });
        });
    };
    function initFormEvent() {
        ///当前时间与传入的时间比较
        jQuery.validator.addMethod("CKDate", function (value, element, params) {
            var ereg = /^(\d{1,4})(-|\/)(\d{1,2})(-|\/)(\d{1,2})(\s{1})(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            var s = value.match(ereg);
            if (s == null) {
                return false;
            }
            var e = $(params).val().match(ereg);
            var sDate = Number(new Date(s[1], s[3] - 1, s[5], s[7], s[8], s[9]).valueOf());
            var eDate = Number(new Date(e[1], e[3] - 1, e[5], e[7], e[8], e[9]).valueOf());
            return this.optional(element) || ((sDate - eDate) > 0);
        }, jQuery.validator.format("当前时间不能早于{0}的时间."));
        jQuery.validator.addMethod("IsDate", function (value, element) {
            var ereg = /^(\d{1,4})(-|\/)(\d{1,2})(-|\/)(\d{1,2})(\s{1})(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            var r = value.match(ereg);
            if (r == null) {
                return false;
            }
            var d = new Date(r[1], r[3] - 1, r[5], r[7], r[8], r[9]);
            var result = (d.getFullYear() == r[1] && (d.getMonth() + 1) == r[3] && d.getDate() == r[5] && d.getHours() == r[7] && d.getMinutes() == r[8] && d.getSeconds() == r[9]);
            return this.optional(element) || (result);
        }, "请输入正确的日期");
        jQuery.validator.addMethod("valuelength", function (value, element, params) {
            var val = value.replace(/[^\w\u4e00-\u9fa5]/ig, "");
            var length = (val.replace(/[^\u4e00-\u9fa5]/g, "").length * 3) + value.replace(/[^\w]/ig, "").length;
            return this.optional(element) || length <= params;
        }, jQuery.validator.format("长度不能超{0}字符."));

        $("#MainForm").validate({
            invalidHandler: function () {
                $(".gray").removeClass("gray");
            },
            rules: {
                ActName: { required: true, valuelength: 32 }
                , SendName: { required: true, valuelength: 32 }
                , Wishing: { required: true, valuelength: 120 }
                , AmountCount: { required: true, number: true, min: 1 }
				, WxImage: "required"
                , RedPackCount: { required: true, number: true, min: 1 }
                , MinAmount: { required: true, number: true, range: [1, 200] }
                , MaxAmount: { required: true, number: true, range: [1, 200] }
                , Description: "required"
				, SDate: { required: true, IsDate: true }
				, EDate: { required: function () { return $("#SDate").val() != ""; }, IsDate: true, CKDate: "#SDate" }
            },
            messages: {
                ActName: { required: "请输入活动标题！" }
                , SendName: { required: "请输入发送者简称" }
                , Wishing: { required: "请输入祝福语" }
                , AmountCount: { required: "请输入红包总额！", number: "只能输入数字！", min: "红包红包总额不能小于1元！" }
				, WxImage: "请上传封面图！"
                , RedPackCount: { required: "请输入红包个数！", number: "只能输入数字！", min: "红包个数最小不能为零！" }
                , MinAmount: { required: "请输入红包最小面值！", number: "只能输入数字！", range: $.validator.format("最小面值不能小于{0}元大于{1}元！") }
                , MaxAmount: { required: "请输入红包最大面值！", number: "只能输入数字！", range: $.validator.format("最大面值不能小于{0}元大于{1}元！") }
                , Description: "请输入简介"
				, SDate: { required: "请输入活动开始时间！", IsDate: "正确的日期格式：2015-01-01 12:00:00" }
				, EDate: { required: "请输入活动结束时间！", IsDate: "正确的日期格式：2015-01-01 18:00:00", CKDate: "结束时间不能早于开始时间！" }
            },
            submitHandler: function (form) {
                submitForm();
                return false;
            },
            ignore: []
        });

		$("<div></div>").appendTo(myroot).load("/admin/widget/WxPaySetting.html?v=" + Math.random(), function(){
			$('.btnShowWxPaySetting').wxPaySetting();
		});
    };
    function submitForm() {
        var html = $('<div id="SuccessDialog"><img class="Loading" src="/images/loading.gif"/>正在保存，请要不关闭或刷新页面...</div>');
        html.dialog({
            modal: true, title: "正在保存", width: 400
        });
        $('#suButton').attr('disabled', true);
        //var params = $('#MainForm').serialize() + "&act=Save";
        var params = $('#MainForm').serialize();
        //$.post(url, params, function (data) {
        $.post("/index.php?c=admin/Weiyx/RedPack&a=Save", params, function (data) {
            console.log(data);
            if (data.success) {
                html.html('<strong style="color:red;">红包保存成功！</strong>');
                html.parent().find(".ui-dialog-title").html("保存成功！");
                html.dialog({
                    close: function () {
                        html.dialog("destroy");
                        me.execCommand('go', { a: 'weixy', b: 'redpacklist' });
                    }
                });
            } else {
                html.html('<strong style="color:red;">'+data.msg+'！</strong>');
                html.parent().find(".ui-dialog-title").html("保存失败！");
                html.dialog({
                    close: function () {
                        html.dialog("destroy");
                    }
                });
                $('#suButton').attr('disabled', false);
                $('.Loading').remove();
            }
        }, "json");
    };
    var myroot = null;
    this.addListener('redpack', function (key, args) {
        args.loadHtmlTpl("plugins/weixypackage/html/redpack.html?v=" + Math.random(), function () {
            myroot = args[0];
            $("#voteTabs").tabs();
            $('#SDate,#EDate').datetimepicker({
                dayOfWeekStart: 1,
                lang: 'ch',
                format: 'Y-m-d H:i:00'
            });
            BindUpLoadImg(args);
            initFormEvent();
            BindOnEvent();
            $("#voteTabs").on("tabsactivate", function (event, ui) {
                this.index = $("#voteTabs").tabs("option", "active");
                var viewBody = $(window.frames["frameView"].document.body);
                if (this.index == 1) {
                    viewBody.find("#content").html(ue.getContent());
                    viewBody.find("#Detail").modal();
                    $(".modal-backdrop").css({ "z-index": "-1", "width": "0", "height": "0", "top": "0", "buttom": "0" });
                } else {
                    viewBody.find("#Detail").modal("hide");
                }
            });
            if (me.currentModule.params && me.currentModule.params.id) {
                LoadInfo(me.currentModule.params.id);
                $(".IsEdit").show();
                $("#LinkMenu").off("click").on("click", function () {
                    me.execCommand('go', { a: 'weixin', b: 'wxmenu' });
                });
            } else {
                this.date = new Date();
                $("#SDate").val(this.date.FormatString());
                this.date.AddDays(10);
                $("#EDate").val(this.date.FormatString());

                initUE();
                $("#link").attr("disabled", 'disabled').val("保存后才可以生成相应的链接！");
            }

            if ($("#WxImage").val() != "") {
                if ($("#WxImage").next(".BtnCover").next().is("img")) {
                    $("#WxImage").next(".BtnCover").next().attr("src", $("#WxImage").val());
                } else {
                    $("#WxImage").next(".BtnCover").after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", $("#WxImage").val()));
                }
            }
            if ($("#BackImage").val() != "") {
                if ($("#BackImage").next(".BtnCover").next().is("img")) {
                    $("#BackImage").next(".BtnCover").next().attr("src", $("#WxImage").val());
                } else {
                    $("#BackImage").next(".BtnCover").after($("<img id='BcShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", $("#BackImage").val()));
                }
            }
        });
    });
    var voteModel = function () {
        this.setData = function (data) {
            for (var key in data) {
                if (typeof (data[key]) == "object")
                { this[key] = ko.observableArray(data[key]); }
                else {
                    this[key] = ko.observable(data[key]);
                }
            }
        };
        this.key = ko.observable();
        this.link = ko.observable();
        this.Format = function (n) {
            return n().replace(/T/g, " ");
        };
    };
    var vm = new voteModel();
    function LoadInfo(id) {
        $.ajax({
            type: "POST",
            //url: url,
            url: "/index.php?c=admin/Weiyx/RedPack&a=GetRedPack",
            cache: false,
            dataType: "json",
            //data: { 'act': 'GetRedPack', 'id': id },
            data: {'id': id },
            success: function (data) {
                if (data != null) {
                    if (data.success) {
                        vm.setData(data.info)
                        vm.key(data.key);
                        vm.link(data.link);
                        $("#WxShow").attr("src", data.info.WxImage);
                        $("#BcShow").attr("src", data.info.BackImage);
                        
                        //$('<img style="width:200px;height:200px;border:solid 10px #fff;" src="/admin/weixy/redpack?act=qrcode&id=' + data.info.Rid + '"/>').appendTo($(".qrcode"));
                        $('<img style="width:200px;height:200px;border:solid 10px #fff;" src="/index.php?c=admin/weiyx/RedPack&a=qrcode&id=' + data.info.Rid + '"/>').appendTo($(".qrcode"));

                        
                        ko.applyBindings(vm, document.getElementById("voteTabs"));
                        if ($('input[name="RedType"]:checked').val() == 0) {
                            $(".MaxRedPack").addClass("none");
                        } else {
                            $(".MaxRedPack").removeClass("none");
                        }
                        initUE();
                        setTimeout(function () {
                            if ($("#BackImage").val() != "") {
                                $(window.frames["frameView"].document.body).find(".redPack").css("background-image", "url(" + $("#BackImage").val() + ")");
                            }
                        }, 500);
                    }
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    };
    function BindOnEvent() {

        $('input[name="RedType"]').off("click.xxx").on("click.xxx", function () {
            console.log($(this).val());
            if ($(this).val() == 0) {
                $(".MaxRedPack").addClass("none");
            } else {
                $(".MaxRedPack").removeClass("none");
            }
        });
        $("input[type='text']").on("keyup focus", function (e) {
            var _this = $(e.target);
            var viewBody = $(window.frames["frameView"].document.body);
            if ("banner" == _this.attr("id").toLowerCase()) {
                viewBody.find("#Banner").attr("src", _this.val());
                e.preventDefault();
            }
        });
        $(document).off("click.xxxx").on("click.xxxx", function (e) {
            var _this = $(e.target);
            if (_this.hasClass("imgshow")) {
                $('<div></div>').dialog({
                    modal: true, width: 680, height: 600, position: { my: "center center", at: "center center", of: window },
                    open: function (event, ui) {
                        $(this).append('<img src="' + _this.attr("src") + '" style="width:100%"/>');
                    },
                    close: function () {
                        $(this).dialog("destroy");
                    }
                });
            };
        });
    };
    var ue = null;
    function initUE() {
        var html = $('#Detail').val() == "" ? "活动规则：<br/>活动范围：<br />活动人群：<br />" : $('#Detail').val();
        ue = new baidu.editor.ui.Editor({
            toolbars: [[
                'removeformat', 'bold', 'italic', 'underline', 'strikethrough'
                , 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
                , 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', 'link', 'unlink'
            ]]
        });

        ue.render('Detail');
        ue.ready(function () {
            ue.setContent(UE.utils.html(html));
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#content").html(ue.getContent());
        });
        ue.addListener('contentChange', function (editor) {
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#content").html(ue.getContent());
        });
    }
};
﻿IWF.plugins['redpacklist'] = function () {

    var me = this, url = "/admin/weixy/redpack", curpage = 1, rcCount = 0, rcSize = 10, navSize = 10;

    var ViewModel = function () {
        var self = this;
        self.datalist = ko.observableArray();
        self.WeiXinId = ko.observable();
        self.State = function (obj, e) {
        	obj.State = obj.State ? 0 : 1;
            $.ajax({
                type: "POST",
                //url: url,
                url: "/index.php?c=admin/Weiyx/RedPack&a=SetState",
                cache: false,
                context: $(e.target),
                dataType: "json",
                //data: { 'act': 'SetState', 'id': obj.Rid, 'state': obj.State },
                data: {'id': obj.Rid, 'state':  obj.State },
                success: function (data) {
                    if (data != null) {
                        if (data.success) {
                            var state = parseInt($(this).attr("data-state"));
                            $(this).attr("data-state", state ? 0 : 1);
                            var newstate = parseInt($(this).attr("data-state"));
                            $(this)[newstate == 0 ? "addClass" : "removeClass"]("glyphicon-eye-close");
                            $(this)[newstate ? "addClass" : "removeClass"]("glyphicon-eye-open");
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
        this.getTime = function (time) {
            return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
        }
        self.LoadDataList = function () {
            //$.post(url, { 'act': 'DataList', 'key': $("#keyword").val(), 'curpage': curpage, 'rcsize': rcSize }, function (data) {
        	$.post("/index.php?c=admin/Weiyx/RedPack&a=DataList", {'key': $("#keyword").val(), 'curpage': curpage, 'rcsize': rcSize }, function (data) {
                if (data && data.success) {
                    console.log(data);
                    vm.datalist(data.list)
                    vm.WeiXinId(data.wxid);
                    rcCount = data.count;
                    var pageCount = Math.floor(rcCount % rcSize > 0 ? rcCount / rcSize + 1 : rcCount / rcSize);
                    if (pageCount < 2)
                    { $("#pagination").hide(); }
                    else {
                        $("#pagination").pageNav(curpage, pageCount, navSize, function (page) {
                            curpage = page;
                            self.LoadDataList();
                        });
                        $("#pagination").show();
                    }
                    bindGridEvent();
                }
            }, "json");
        };
    };
    var vm = new ViewModel();

    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/redpacklist.html?t="+Math.random(), function () {
            bindUIEvent();
            ko.applyBindings(vm, root[0]);
            vm.LoadDataList();
        });
    }

    function bindUIEvent() {
        $("#BtnSearch").unbind('click').bind('click', function (event) {
            if ($("#keyword").val() != "") {
                vm.LoadDataList();
            }
        });
    }

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).data("rid") }
            me.execCommand('go', { a: 'weixy', b: 'redpack', params: params });
            return false;
        });

        $("*[name=BtnGoJoin]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).data("rid") }
            me.execCommand('go', { a: 'weixy', b: 'redpackuser', params: params });
            return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
            if (!confirm("确认删除？")) return false;
            //$.post(url, { 'act': 'Delete', id: $(this).data("rid") }, function (data) {
            $.post("/index.php?c=admin/Weiyx/RedPack&a=Delete", {id: $(this).data("rid") }, function (data) {
                if (data&&data.success) {
                    vm.LoadDataList();
                } else {
                    $.showResult("出错啦", data.msg);
                }
            },"json");
            return false;
        });

        $(".QrCode").mouseover(function () {
            //var img = $('<img class="QRCode" style="position:absolute;width:150px;height:150px;top:-60px;z-index:10;border:solid 10px #fff;" src="/admin/weixy/redpack?act=qrcode&id=' + $(this).attr("data-val") + '"/>')
        	var img = $('<img class="QRCode" style="position:absolute;width:150px;height:150px;top:-60px;z-index:10;border:solid 10px #fff;" src="/index.php?c=admin/weiyx/RedPack&a=qrcode&id=' + $(this).attr("data-val") + '"/>')
            $(this).parent().append(img);
        }).mouseout(function () {
            $(".QRCode").remove();
        });
    }

    me.addListener('redpacklist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['redpackuser'] = function () {
    var me = this;
    var url = "/admin/weixy/redpack", id = "", curpage = 1, rcsize = 10, pagesize = 10;
    var ViewModel = function () {
        var self = this;
        self.SortIndex = ko.observable(0);
        self.UserList = ko.observableArray([]);
        self.BitImage = function (img) {

            return img && img.length > 0 ? img.replace(/\/0$/ig, '/132') : "";
        }
        self.getTime = function (time) {
            return time ? time.replace(/T/gi, " ").replace(/(\.\d+)/, "") : "";
        }
        self.LoadUserList = function () {
            $.ajax({
                type: "POST",
                //url: url,
                url: "/index.php?c=admin/weiyx/RedPack&a=RedPackUser",
                //data: { 'act': 'RedPackUser', 'id': id, 'cur': curpage, 'rcsize': rcsize },
                data: { 'id': id, 'cur': curpage, 'rcsize': rcsize },
                cache: false,
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    if (data != null) {
                        if (data.success) {
                            vm.UserList(data.list);
                            var pageCount = parseInt(data.count / rcsize);
                            pageCount = (data.count % rcsize) > 0 ? pageCount + 1 : pageCount;
                            $("#pageCount").text(pageCount);
                            $("#rcCount").text(data.count);
                            $("#pagination").pageNav(curpage, pageCount, pagesize, function (page) {
                                curpage = page;
                                self.LoadUserList();
                            });
                            if (curpage > 0) {
                                self.SortIndex(rcsize * (curpage - 1));
                            }
                        } else {
                            console.log(data.msg);
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
        self.HelpUserList = ko.observableArray([]);
        self.HelpUser = function (obj, e) {
            console.log(e);
            //$.post(url, { 'act': 'GetHelp', "id": obj.Lid, "rid": obj.Rid },
            $.post("/index.php?c=admin/weiyx/RedPack&a=GetHelp", {"id": obj.Lid, "rid": obj.Rid },
           function (data) {
               console.log(data);
               if (data.success) {
                   self.HelpUserList(data.list);
                   $("#myModal").modal();
               }
           }, "json");
        };
        self.Del = function (obj) {
            if (!confirm("确认删除？")) return false;
            //$.getJSON(url, { 'act': 'DeleteUser', 'id': obj.Lid, 'rid': obj.Rid }, function (data) {
            $.getJSON("/index.php?c=admin/weiyx/RedPack&a=DeleteUser", { 'id': obj.Lid, 'rid': obj.Rid }, function (data) {
                if (data && data.success) {
                    vm.LoadUserList();
                } else {
                    $.showResult("出错啦", data.msg);
                }
            });
        };
    };
    var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/redpackuser.html", function () {
            id = me.currentModule.params.id;
            curpage = 1;
            ko.applyBindings(vm, document.getElementById("VoteUser"));
            vm.LoadUserList();
        });
    }
    me.addListener('redpackuser', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}
﻿IWF.plugins['researchedit'] = function () {

    var me = this;

    var ViewModel = function () {
        this.setData = function (data) {
            for (var key in data) {
                this[key] = data[key];
            }
        };
		this.showImage = function (image) {
	        if(!image) image = "/images/hudongimg/research.jpg";
			image = "<img src='"+ image +"' width='360'>";
			$("#ImgPreview").show();
	        return image;
	    }
        this.getTime = function (time) {
			if(/^(1970)/.test(time)) return "";
            return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
        }
    };
    
    var vm = new ViewModel();
    var myroot = null;
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/researchedit.html", function () {
            myroot = root[0];
			initFormEvent();
			$("#handleweixin",myroot).off().on("click",function(){ showPreviewPage("weixin") });
			$("#handleresearch",myroot).off().on("click",function(){ showPreviewPage("research") });
			$("#prevBtn,#nextBtn").off().on("click",function(){ showPreviewPage() });
			$("#research-nav",myroot).tabs();
			$("#research-nav",myroot).tabs({ disabled: [1, 3, 5, 7, 9, 11] });
			$("#research-tabs",myroot).tabs();
			$("#Title",myroot).unbind().change(function(){$(myroot).find("#weixintitle").html($(this).val())});
			$("#Banner",myroot).unbind().change(function(){ $(myroot).find("#weixinimage").prop("src",$(this).val())});
			
			if (!me.hasLicensePerm('ENABLE_JIFEN')){
				$("input,select",myroot).each(function(i,item){
					if(($(item).attr("name") + "").indexOf("JiFen") > -1){
						$(item).prop("readonly",true);
						$(item).css("height","50px");
						if($(item)[0].tagName == 'SELECT') $(item).hide();
					}
				});
				$("#forJiFenIn,#forJiFenOut").each(function(i,item){
					$(item).html($(item).html() + " <font color='red'><br>当前版本不支持积分功能，请升级到旗舰版以上</font>");
				});
			}

			//日期控件
            $('#StartTime,#EndTime',myroot).datetimepicker({
                dayOfWeekStart: 1,
                lang: 'ch',
                format: 'Y-m-d H:i:00'
            });
			
			//图片选择
			$('#Banner',myroot).on('click', function () {
                YDM.FileManager('image', 1, function (aUrl) {
                    if (aUrl.length > 0) {
                        $('#Banner').val(aUrl[0]);
						$('#Banner').trigger('change');
                        $('#ImgPreview').html("<img src='"+ aUrl[0] +"' width='360'>").show();
                    }
                })
            });
			
            if (me.currentModule.params && me.currentModule.params.id) loadInfo();
			else{
				initUE();
				initCustomForm("","");
				showPreviewPage("weixin");
			}
        });
    }

    function initFormEvent() {
        ///当前时间与传入的时间比较
        jQuery.validator.addMethod("CheckDate", function (value, element, params) {
            var vDate = Number(new Date(value).valueOf());
            var pDate = Number(new Date($(params).val()).valueOf());
            return this.optional(element) || ((vDate - pDate) > 0);
        }, jQuery.validator.format("当前时间不能早于{0}的时间."));

        $("#MainForm",myroot).validate({
            invalidHandler: function () {
                $(".gray").removeClass("gray");
            },
            rules: {
                Title: "required"
				, Intro: "required"
				, StartTime: { date: true }
				, EndTime: { date: true, CheckDate: $("#StartTime",myroot) }
            },
            messages: {
                Title: { required: "请输入标题！" }
				, Intro: "请输入简介"
				, StartTime: { required: "请输入活动开始时间！", date: "正确的日期格式：2015-01-01 12:00:00" }
				, EndTime: { required: "请输入活动结束时间！", date: "正确的日期格式：2015-01-01 18:00:00", CheckDate: "结束时间不能早于开始时间！" }
            },
            submitHandler: function (form) {
                submitForm();
                return false;
            },
			errorPlacement: function(error, element) {
			   error.insertAfter(element);
			   var id = element.closest(".ui-tabs-panel").attr("id");
			   $("#research-tabs",myroot).tabs("option", "active", 0);
		   },
			ignore: []
        });
    }
	
	var ue = null;
	function initUE() {
	    try {
	        ue = new baidu.editor.ui.Editor({
				initialFrameWidth: "360",
	            initialFrameHeight: "350",
	            autoHeightEnabled: true,
	            toolbars: [[
                     'bold', 'italic', 'underline', 'strikethrough', 'removeformat'
					, 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
					, 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify'
					, 'imagenone', 'imageleft', 'imageright', 'imagecenter'
	            ]]
	        });
	        ue.ready(function () {
	            ue.setContent($("#Detail", myroot).val());
	        });
	        ue.render('editor');
		} catch (e) {
		    console.log("error: " + e);
		}
	}
	
	var curpage = 'weixin';
	function showPreviewPage(page){
		if(!page){
			if(curpage == 'research'){ page = 'weixin'; curpage = 'weixin'; }
			else { page = 'research'; curpage = 'research'; }
		}else{
			curpage = page;
		}
		$("#research-nav",myroot).tabs("option", "active", page == 'weixin' ? 0: 2);
		if(page == 'research'){
			var id = 0;
			if($("#id").val()) id = $("#id").val();
			//$("#previewframe").html('<iframe width="100%" height="100%" frameborder="0" src="/research/'+id+'/"></iframe>');
			$("#previewframe").html('<iframe width="100%" height="100%" frameborder="0" src="/index.php?c=front/Research&id='+id+'"></iframe>');
		}
		else{
			var title = $("#Title",myroot).val();
			var image = $("#Banner",myroot).val();
			if(!title) title = "活动标题";
			if(!image) image = "/images/hudongimg/research.jpg";
			$("#previewframe").html('<center style="padding:10px"><img src="'+ image +'" id="weixinimage" width="100%"><div style="background:#EEEEEE;text-align:left;color:#333333;padding-left:20px;padding:5px;"><b id="weixintitle">'+ title +'</b></div></center>');
		}
	}
	
	function initCustomForm(formid,formname){
		$("#research-form").html("<iframe name='customQuestionFrame' src='widget/customquestion.html?FormID=" + formid + "&FormName=" + formname +"&HideSaveBtn=1&HideTitle=1&DisableFieldTypes=6,7,8&t="+Math.random()+"' frameborder='0' width='100%' height='400'></iframe>");
	}
	
    function loadInfo() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        console.log(params);
        //$.getJSON("/admin/weixy/researchmanage?act=GetInfo", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/ResearchManage&a=GetInfo", utils.params(params), function (json) {
            vm.setData(json);
            ko.applyBindings(vm, myroot);
			initUE();
			initCustomForm(json.info.FormID,"");
			showPreviewPage('weixin');
			//var qrcodesrc = "/admin/weixy/researchmanage?act=qrcode&id=" + json.info.ID;
			var qrcodesrc = "/index.php?c=admin/weiyx/ResearchManage&a=qrcode&id=" + json.info.ID;
			$("#ImgQrcode",myroot).html("<img src='"+ qrcodesrc +"' width='138'/>");
			$("#BtnWeixinMenu",myroot).removeClass("disabled");
			$("#LabWeixinMenu",myroot).hide();
			$("#ReserveUrl",myroot).prop("rows",3);
        });
    }
		
	function submitMyForm() {
		var html = ue.getContent();
		$("#Detail", myroot).val(html);
        var params = $('#MainForm').serializeObject();
        //$.post("/admin/weixy/researchmanage?act=Edit", params, function (data, textStatus, jqXHR) {
        $.post("/index.php?c=admin/weiyx/ResearchManage&a=Edit", params, function (data, textStatus, jqXHR) {
            if (data.success) {
                $('<div id="success">保存成功</div>').dialog({
                    modal: true, width: 400, close: function () {
                        $("#success").dialog("destroy");
                        me.execCommand('go', { a: 'weixy', b: 'researchlist'});
                    }
                });
            } else {
                $('<div id="error">'+data.msg+'</div>').dialog({
                    modal: true, width: 400,title:"保存失败", close: function () { $("#error").dialog("destroy"); }
                });
            }
        }, "json");
    }

    function submitForm() {
		var func = function(data){
			console.log(data);
			if(!data.success){
				alert(data.msg);
				$("#research-tabs",myroot).tabs("option", "active", 2);
				return;	
			}
			if(data && data.success){
				if(data.newform && data.newform.ID){
					$("#FormID",myroot).val(data.newform.ID);
					initCustomForm(data.newform.ID,data.newform.Name);
				}
				submitMyForm();
			}else{
				window.frames['customQuestionFrame'].location = window.frames['customQuestionFrame'].location;
			}
		}
		window.frames['customQuestionFrame'].framework.submitQuestionForm(func);
    }

    me.addListener('researchedit', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['researchlist'] = function () {

    var me = this;

	var ViewModel = function () {
	    this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
		this.showImage = function (image) {
	        if(!image) image = "/images/hudongimg/research.jpg";
	        return image;
	    }
		this.getTime = function(time){
			if(/^(1970)/.test(time)) return "不限制结束时间";
			return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
		}
    };

	var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/researchlist.html",function(){
			bindUIEvent();
			ko.applyBindings(vm,root[0]);
			loadresearchlist(1);			
        });
    }
	    
	var curpage = 1;
	var itemcount = 0;
    function loadresearchlist(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(),page: page, pagesize: 20 };
        //$.getJSON("/admin/weixy/researchmanage?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/ResearchManage&a=getlist", utils.params(params), function (json) {
            vm.setData(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadresearchlist(page); });
                $("#pagination").show();
            }
            bindGridEvent();
        });
    }

    function bindUIEvent() {
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadresearchlist(1);
        });

		$("#BtnAddLuck").unbind().bind('click', function (event) {
		    me.execCommand('go', { a: 'weixy', b: 'researchedit', params: me.currentModule.params });
			return false;
        });
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("ReserveID") };
			me.execCommand('go', { a: 'weixy', b: 'researchedit', params: params });
			return false;
        });

		$("*[name=BtnGoLog]").unbind('click').bind('click', function (event) {
			var params = {id: $(this).attr("ReserveID") };
            me.execCommand('go', { a: 'weixy', b: 'researchsum', params: params });
			return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			//$.getJSON("/admin/weixy/researchmanage?act=Delete", utils.params({id:$(this).attr("ReserveID")}), function (json) {
			$.getJSON("/index.php?c=admin/weiyx/ResearchManage&a=Delete", utils.params({id:$(this).attr("ReserveID")}), function (json) {
				if(json.success){
					if(itemcount > 1) loadresearchlist(curpage);
					else loadresearchlist(1);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetStatus]").unbind('click').bind('click', function (event) {
			//$.getJSON("/admin/weixy/researchmanage?act=setstatus", utils.params({id:$(this).attr("ReserveID"),status: $(this).attr("Status")}), function (json) {
			$.getJSON("/index.php?c=admin/weiyx/ResearchManage&a=setstatus", utils.params({id:$(this).attr("ReserveID"),status: $(this).attr("Status")}), function (json) {
				if(json.success){
					loadresearchlist(curpage);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
		});
		
        $(".fa-qrcode").mouseover(function () {
			var maxh = $("#showListTable").position().top;
			$("#divQRCodePreview").remove();
			//var qrcodesrc = "/admin/weixy/researchmanage?act=qrcode&id=" + $(this).attr("data-val");
			var qrcodesrc = "/index.php?c=admin/weiyx/ResearchManage&a=qrcode&id=" + $(this).attr("data-val");
			var html = "<div id='divQRCodePreview' class='divQRCodePreview' style='padding:5px;border:1px solid #cccccc;background:white;position:absolute;z-index:999'>";
			html += "<img src='"+ qrcodesrc +"' width='150'/>";
			html += "</div>";
			$("body").append(html);
			var top = $(this).offset().top + 20;
			if(top + $("#divQRCodePreview").height() > maxh) top = $(this).offset().top - $("#divQRCodePreview").height();
			$("#divQRCodePreview").css({top:top,left:$(this).offset().left + 20});
			
		}).mouseout(function () {
		    $("#divQRCodePreview").remove();
		});
    }

    me.addListener('researchlist', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['researchsum'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
		this.index = 0;
        this.setData = function (list) { this.list(list);this.index = 0; };
		this.getTime = function(time){
			return time.replace(/T/gi," ").replace(/(\.\d+)/,"");
		}
		this.getQuestion = function(question){
			return (++this.index) + "、" + question;
		}
    };

	var vm = new ViewModel();
    function initUI(root) {
		
		var func = function(){
			root.children().remove();
			root.loadHtmlTpl("plugins/weixypackage/html/researchsum.html",function(){
				bindUIEvent();
				ko.applyBindings(vm,root[0]);
				loadSumInfo(1);
			});
		}

		utils.addScript("http://cdn.hcharts.cn/highcharts/highcharts.js",func);
    }
	    
	var curpage = 1;
	var itemcount = 0;
    function loadSumInfo(page) {
		$("#Loading").html("正在加载数据，请稍候...");
        var params = { id: me.currentModule.params.id, page: page, pagesize: 20 };
        //$.getJSON("/admin/weixy/researchmanage?act=GetResearchSumInfo", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/ResearchManage&a=GetResearchSumInfo", utils.params(params), function (json) {
            $("#divTips").html("共有 "+ json.total +" 人参与调研");
			vm.setData(json.list);
			for(var i = 0;i < json.list.length;i++){
				var chartObj = $("#chart_" + json.list[i].ColID);
				//多选是时候应该用柱形图
				console.log(json.list[i].ColID);
				var data = [];
				var allzero = true;
				for(var k = 0;k < json.list[i].Answers.length;k++){
					var name = json.list[i].Answers[k].Answer;
					var value = (json.list[i].Answers[k].Count / json.total * 100);
					if(value > 0) allzero = false;
					data.push([name,value]);
				}
				if(!allzero){
					if(json.list[i].FieldType == 3) createChartPie(chartObj,data); //单选选用饼图
					if(json.list[i].FieldType == 5) createChartCol(chartObj,data); //多选是时候应该用柱形图
				}
			}
        });
    }

	//柱形图
	function createChartCol(chartObj,chartdata){
		var xAxis = [];
		for(j = 0;j < chartdata.length;j++){
			xAxis.push(chartdata[j][0]);
		}
		$(chartObj).css("width","700px");
		$(chartObj).highcharts({
            chart: {
				type: 'column'
			},
            title: {
                text: ''
            },
			legend:{
				enabled:false,
				align: 'right'
			},
			credits:{
				 enabled:false // 禁用版权信息
			},
			xAxis: {
				categories: xAxis,
				crosshair: true
			},
			yAxis: {
				min: 0,
				max: 100,
				title: {
					text: '百分比(%)'
				}
			},
            plotOptions: {
				series: {
					borderWidth: 0,
					dataLabels: {
						enabled: true,
						format: '{point.y:.1f}%'
					}
				}
			},
			tooltip: {
				headerFormat: '',//headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
				pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.2f}%</b><br/>'
			},
            series: [{
                colorByPoint: true,
                data: chartdata
            }]
        });
	}
	
	//饼图
	function createChartPie(chartObj,data){
		$(chartObj).highcharts({
            chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false
            },
            title: {
                text: ''
            },
            tooltip: {
        	    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
            },
			legend:{ 
				align: 'right'
			},
			credits:{
				 enabled:false // 禁用版权信息
			},
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    /*dataLabels: {
                        enabled: false
                    },*/
					dataLabels: {
						enabled: true,
						color: '#000000',
						connectorColor: '#000000',
						format: '<b>{point.name}</b>: {point.percentage:.1f} %'
					},
                    showInLegend: false
                }
            },
            series: [{
                type: 'pie',
                name: '百分比',
                data: data
            }]
        });
	}

	function bindUIEvent(){

		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadSumInfo(1);
        });

		$("#BtnBack").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'weixy', b: 'researchlist' });
			return false;
        });
	}

    me.addListener('researchsum', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['reserveedit'] = function () {

    var me = this;

    var ViewModel = function () {
        this.setData = function (data) {
            for (var key in data) {
                this[key] = data[key];
            }
        };
		this.showImage = function (image) {
	        if(!image) image = "/images/hudongimg/reserve.jpg";
			image = "<img src='"+ image +"' width='360'>";
			$("#ImgPreview").show();
	        return image;
	    }
        this.getTime = function (time) {
			if(/^(0000|1970)/.test(time)) return "";
            return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
        }
    };
    
    var vm = new ViewModel();
    var myroot = null;
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/reserveedit.html?v=" + Math.random(), function () {
            myroot = root[0];
			initFormEvent();
			$("#handleweixin",myroot).off().on("click",function(){ showPreviewPage("weixin") });
			$("#handlereserve",myroot).off().on("click",function(){ showPreviewPage("reserve") });
			$("#prevBtn,#nextBtn").off().on("click",function(){ showPreviewPage() });
			$("#reserve-nav",myroot).tabs();
			$("#reserve-nav",myroot).tabs({ disabled: [1, 3, 5, 7, 9, 11] });
			$("#reserve-tabs",myroot).tabs();
			$("#Title",myroot).unbind().change(function(){$(myroot).find("#weixintitle").html($(this).val())});
			$("#Banner",myroot).unbind().change(function(){ $(myroot).find("#weixinimage").prop("src",$(this).val())});
			
			if (!me.hasLicensePerm('ENABLE_JIFEN')){
				$("input,select",myroot).each(function(i,item){
					if(($(item).attr("name") + "").indexOf("JiFen") > -1){
						$(item).prop("readonly",true);
						$(item).css("height","50px");
						if($(item)[0].tagName == 'SELECT') $(item).hide();
					}
				});
				$("#forJiFenIn,#forJiFenOut").each(function(i,item){
					$(item).html($(item).html() + " <font color='red'><br>当前版本不支持积分功能，请升级到旗舰版以上</font>");
				});
			}

			//日期控件
            $('#StartTime,#EndTime',myroot).datetimepicker({
                dayOfWeekStart: 1,
                lang: 'ch',
                format: 'Y-m-d H:i:00'
            });
			
			//图片选择
			$('#Banner',myroot).on('click', function () {
                YDM.FileManager('image', 1, function (aUrl) {
                    if (aUrl.length > 0) {
                        $('#Banner').val(aUrl[0]);
						$('#Banner').trigger('change');
                        $('#ImgPreview').html("<img src='"+ aUrl[0] +"' width='360'>").show();
                    }
                })
            });
			
            if (me.currentModule.params && me.currentModule.params.id) loadInfo();
			else{
				initUE();
				initCustomForm("","");
				showPreviewPage("weixin");
			}
        });
    }

    function initFormEvent() {
        ///当前时间与传入的时间比较
        jQuery.validator.addMethod("CheckDate", function (value, element, params) {
            var vDate = Number(new Date(value).valueOf());
            var pDate = Number(new Date($(params).val()).valueOf());
            return this.optional(element) || ((vDate - pDate) > 0);
        }, jQuery.validator.format("当前时间不能早于{0}的时间."));

        $("#MainForm",myroot).validate({
            invalidHandler: function () {
                $(".gray").removeClass("gray");
            },
            rules: {
                Title: "required"
				, Intro: "required"
				, StartTime: { date: true }
				, EndTime: { date: true, CheckDate: $("#StartTime",myroot) }
            },
            messages: {
                Title: { required: "请输入标题！" }
				, Intro: "请输入简介"
				, StartTime: { required: "请输入活动开始时间！", date: "正确的日期格式：2015-01-01 12:00:00" }
				, EndTime: { required: "请输入活动结束时间！", date: "正确的日期格式：2015-01-01 18:00:00", CheckDate: "结束时间不能早于开始时间！" }
            },
            submitHandler: function (form) {
                submitForm();
                return false;
            },
			errorPlacement: function(error, element) {
			   error.insertAfter(element);
			   var id = element.closest(".ui-tabs-panel").attr("id");
			   $("#reserve-tabs",myroot).tabs("option", "active", 0);
		   },
			ignore: []
        });
    }
	
	var ue = null;
	function initUE() {
	    try {
	        ue = new baidu.editor.ui.Editor({
				initialFrameWidth: "360",
	            initialFrameHeight: "350",
	            autoHeightEnabled: true,
	            toolbars: [[
                     'bold', 'italic', 'underline', 'strikethrough', 'removeformat'
					, 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
					, 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify'
					, 'imagenone', 'imageleft', 'imageright', 'imagecenter'
	            ]]
	        });
	        ue.ready(function () {
	            ue.setContent($("#Detail", myroot).val());
	        });
	        ue.render('editor');
		} catch (e) {
		    console.log("error: " + e);
		}
	}
	
	var curpage = 'weixin';
	function showPreviewPage(page){
		if(!page){
			if(curpage == 'reserve'){ page = 'weixin'; curpage = 'weixin'; }
			else { page = 'reserve'; curpage = 'reserve'; }
		}else{
			curpage = page;
		}
		$("#reserve-nav",myroot).tabs("option", "active", page == 'weixin' ? 0: 2);
		if(page == 'reserve'){
			var id = 0;
			if($("#id").val()) id = $("#id").val();
			$("#previewframe").html('<iframe width="100%" height="100%" frameborder="0" src="/reserve/'+id+'/"></iframe>');
		}
		else{
			var title = $("#Title",myroot).val();
			var image = $("#Banner",myroot).val();
			if(!title) title = "活动标题";
			if(!image) image = "/images/hudongimg/reserve.jpg";
			$("#previewframe").html('<center style="padding:10px;"><img src="'+ image +'" id="weixinimage" width="100%"><div style="background:#EEEEEE;text-align:left;color:#333333;padding-left:20px;padding:5px;"><b id="weixintitle">'+ title +'</b></div></center>');
		}
	}
	
	function initCustomForm(formid,formname){
		$("#reserve-form").html("<iframe name='customFormFrame' src='widget/customform.html?FormID=" + formid + "&FormName=" + formname +"&HideSaveBtn=1&HideTitle=1&DisableFieldTypes=6,7,8' frameborder='0' width='100%' height='400'></iframe>");
	}
	
    function loadInfo() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        console.log(params);
        // $.getJSON("/admin/weixy/reservemanage?act=GetInfo", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/reserve&a=GetInfo", utils.params(params), function (json) {
            vm.setData(json);
            ko.applyBindings(vm, myroot);
			initUE();
			initCustomForm(json.info.FormID,"");
			showPreviewPage('weixin');
			// var qrcodesrc = "/admin/weixy/reservemanage?act=qrcode&id=" + json.info.ID;
            var qrcodesrc = "/index.php?c=admin/weiyx/reserve&a=QRCode&id=" + json.info.ID; 
			$("#ImgQrcode",myroot).html("<img src='"+ qrcodesrc +"' width='138'/>");
			$("#BtnWeixinMenu",myroot).removeClass("disabled");
			$("#LabWeixinMenu",myroot).hide();
			$("#ReserveUrl",myroot).prop("rows",3);
        });
    }
		
	function submitMyForm() {
		var html = ue.getContent();
		$("#Detail", myroot).val(html);
        var params = $('#MainForm').serializeObject();
        // $.post("/admin/weixy/reservemanage?act=Edit", params, function (data, textStatus, jqXHR) {
        $.post("/index.php?c=admin/weiyx/reserve&a=Edit", params, function (data, textStatus, jqXHR) {
            if (data.success) {
                $('<div id="success">保存成功</div>').dialog({
                    modal: true, width: 400, close: function () {
                        $("#success").dialog("destroy");
                        me.execCommand('go', { a: 'weixy', b: 'reservelist'});
                    }
                });
            } else {
                $('<div id="error">'+data.msg+'</div>').dialog({
                    modal: true, width: 400,title:"保存失败", close: function () { $("#error").dialog("destroy"); }
                });
            }
        }, "json");
    }

    function submitForm() {
		var func = function(data){
			console.log(data);
			if(!data.success){
				alert(data.msg);
				$("#reserve-tabs",myroot).tabs("option", "active", 2);
				return;	
			}
			if(data && data.success){
				if(data.newform && data.newform.ID){
					$("#FormID",myroot).val(data.newform.ID);
					initCustomForm(data.newform.ID,data.newform.Name);
				}
				submitMyForm();
			}else{
				window.frames['customFormFrame'].location = window.frames['customFormFrame'].location;
			}
		}
		window.frames['customFormFrame'].framework.submitForm(func);
    }

    me.addListener('reserveedit', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['reservelist'] = function () {

    var me = this;

	var ViewModel = function () {
	    this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
		this.showImage = function (image) {
	        if(!image) image = "/images/hudongimg/reserve.jpg";
	        return image;
	    }
		this.getTime = function(time){
			if(/^(0000|1970)/.test(time)) return "不限制结束时间";
			return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
		}
    };

	var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/reservelist.html",function(){
			bindUIEvent();
			ko.applyBindings(vm,root[0]);
			loadreservelist(1);			
        });
    }
	    
	var curpage = 1;
	var itemcount = 0;
    function loadreservelist(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(),page: page, pagesize: 20 };
        // $.getJSON("/admin/weixy/reservemanage?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/reserve&a=GetList", utils.params(params), function (json) {
            vm.setData(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadreservelist(page); });
                $("#pagination").show();
            }
            bindGridEvent();
        });
    }

    function bindUIEvent() {
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadreservelist(1);
        });

		$("#BtnAddLuck").unbind().bind('click', function (event) {
		    me.execCommand('go', { a: 'weixy', b: 'reserveedit', params: me.currentModule.params });
			return false;
        });
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("ReserveID") };
			me.execCommand('go', { a: 'weixy', b: 'reserveedit', params: params });
			return false;
        });

		$("*[name=BtnGoLog]").unbind('click').bind('click', function (event) {
			var params = {id: $(this).attr("ReserveID") };
            me.execCommand('go', { a: 'weixy', b: 'reserveusers', params: params });
			return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			// $.getJSON("/admin/weixy/reservemanage?act=Delete", utils.params({id:$(this).attr("ReserveID")}), function (json) {
            $.getJSON("/index.php?c=admin/weiyx/reserve&a=Delete", utils.params({id:$(this).attr("ReserveID")}), function (json) { 
				if(json.success){
					if(itemcount > 1) loadreservelist(curpage);
					else loadreservelist(1);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetStatus]").unbind('click').bind('click', function (event) {
			// $.getJSON("/admin/weixy/reservemanage?act=setstatus", utils.params({id:$(this).attr("ReserveID"),status: $(this).attr("Status")}), function (json) {
            $.getJSON("/index.php?c=admin/weiyx/reserve&a=SetStatus", utils.params({id:$(this).attr("ReserveID"),status: $(this).attr("Status")}), function (json) { 
				if(json.success){
					loadreservelist(curpage);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
		});

        $(".fa-qrcode").mouseover(function () {
			var maxh = $("#showListTable").position().top;
			$("#divQRCodePreview").remove();
			// var qrcodesrc = "/admin/weixy/reservemanage?act=qrcode&id=" + $(this).attr("data-val");
			var qrcodesrc = "/index.php?c=admin/weiyx/reserve&a=QRCode&id=" + $(this).attr("data-val");
            var html = "<div id='divQRCodePreview' class='divQRCodePreview' style='padding:5px;border:1px solid #cccccc;background:white;position:absolute;z-index:999'>";
			html += "<img src='"+ qrcodesrc +"' width='150'/>";
			html += "</div>";
			$("body").append(html);
			var top = $(this).offset().top + 20;
			if(top + $("#divQRCodePreview").height() > maxh) top = $(this).offset().top - $("#divQRCodePreview").height();
			$("#divQRCodePreview").css({top:top,left:$(this).offset().left + 20});
			
		}).mouseout(function () {
		    $("#divQRCodePreview").remove();
		});
    }

    me.addListener('reservelist', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['reserveusers'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
        this.setData = function (list) { this.list(list); };
		this.getTime = function(time){
			return time.replace(/T/gi," ").replace(/(\.\d+)/,"");
		}
    };

	var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/reserveusers.html?v=" + Math.random(),function(){
			bindUIEvent();
			//ko.applyBindings(vm,root[0]);
			loadusers(1);
		});
    }
	    
	var curpage = 1;
	var itemcount = 0;
    function loadusers(page) {
        //var params = { id: me.currentModule.params.id, page: page, pagesize: 20 };
        // $.getJSON("/admin/weixy/reservemanage?act=GetReserveUsers", { id: me.currentModule.params.id, page: page, pagesize: 20 }, function (json) {
        $.getJSON("/index.php?c=admin/weiyx/reserve&a=GetReserveUsers", { id: me.currentModule.params.id, page: page, pagesize: 20 }, function (json) {
            //vm.setData(json.list);
            console.log(json);
			showList(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadusers(page); });
                $("#pagination").show();
            }
			$("#countinfo").html("共 "+ json.total +" 条记录");
            bindGridEvent();
        });
    }
	
	function getTime(time){
		return time.replace(/T/gi," ").replace(/(\.\d+)/,"");
	}

	function showList(list){
		$("#showListTable").children().remove();
		if(list && list.length > 0){
			//先建立表头
			var th = "<tr>";
			for(key in list[0]){
				if(key == "CrTime")	th += "<td>时间</td>";
				else if(/^cc_/.test(key)) th += "<td>"+ key.replace("cc_","") +"</td>";
			}
			th += "<td></td></tr>";
			th += "</tr>";
			$("#showListTable").append(th);
			
			th = "<tr>";
			for(i = 0;i < list.length;i++){
				for(key in list[i]){
				    if (key == "CrTime") th += "<td><div style='width: 160px;'>" + getTime(list[i][key]) + "</div></td>";
					else if(/^cc_/.test(key)) th += "<td>"+ list[i][key] +"</td>";
				}
				th += "<td><div style='width:100px;'><input type='button' value='修改' data-json='"+list[i].toString()+"' data-rowid='"+ list[i].FormRowID +"' class='btn btn-primary btn-xs btnedit'>";
				th += "<input type='button' value='删除' data-logid='" + list[i].ID  + "' class='btn btn-danger btn-xs btndelete' style='margin-left: 10px;'></td></tr>";
				th += "</div></tr>";
			}
			$("#showListTable").append(th);
		}else{
			$("#showListTable").append("<tr><td align='center'>目前还没有任何人预约</td></tr>");
		}
		$("#showListTable").addClass("table table-hover table-bordered");
	}

	function bindUIEvent(){

		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadusers(1);
        });

		$("#BtnBack").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'weixy', b: 'reservelist' });
			return false;
		});
		$(document).off("click.btnedit").on("click.btnedit", function (e) {
		    if ($(e.target).hasClass("btnedit")) {
		        var rid = $(e.target).data("rowid");
		        var html = ['<div id="dialog">'];
		        $.ajax({
		            type: "POST",
		            // url: "/admin/weixy/reservemanage",
		            url: "/index.php?c=admin/weiyx/reserve",
                    cache: false,
		            dataType: "json",
                    data: { 'a': 'GetSelfForm', 'formRowId': rid },
		            // data: { 'act': 'GetSelfForm', 'formRowId': rid },
		            success: function (data) {
		                console.log(data);
		                if (data && data.success) {
		                    html.push('<form id="form' + rid + '">');
		                    html.push('<input type="hidden" name="FormRowID" value="' + rid + '"/>');
		                    html.push('<div id="SelForm">');

		                    $.each(data.formlist, function (i, n) {
		                        html.push('<div class="input-group"><span class="input-group-addon">', n.Name, ':</span><input type="text" value="', n.FieldValues, '" name="col' + n.ID + '" class="form-control"/></div>');
		                    });
		                    html.push('<div style="clear:both;text-align:center;"><input type="button" data-val="form' + rid + '" class="btn btn-primary modify" style="width:100px;" value="修改"/></div>');
		                    html.push('</div></form></div>');
		                }
		            },
		            complete: function (XMLHttpRequest, textStatus) {
		                $(html.join('')).dialog({
		                    modal: true, width: 680, height: 600, title: "修改", position: { my: "center center", at: "center center", of: window },
		                    close: function () {
		                        $(this).dialog("destroy");
		                    }
		                });
		            },
		            error: function (XMLHttpRequest, textStatus, errorThrown) {
		                console.log(XMLHttpRequest.responseText);
		            }
		        });
		    }
		});
		$(document).off("click.modify").on("click.modify", function (e) {
		    if ($(e.target).hasClass("modify")) {
		        var params = $("#" + $(e.target).data("val")).serialize();
		        // $.post("/admin/weixy/reservemanage?act=Modify", params,
                $.post("/index.php?c=admin/weiyx/reserve&a=Modify", params,
               function (data) {
                   if (data && data.success) {
                       $("<div id='ResultModify'></div>").dialog({
                           modal: true, width: 200, height: 100, title: "修改", position: { my: "center center", at: "center center", of: window },
                           open: function (event, ui) {
                               $(this).append("<strong style='color:red;'>修改成功</strong>");
                           },
                           close: function () {
                               $(this).dialog("destroy");
                           }
                       });
                   }
               }, "json");
		    }
		});
		$(document).off("click.btndelete").on("click.btndelete", function (e) {
		    if ($(e.target).hasClass("btndelete")) {
		        var rid = $(e.target).data("logid");
		        console.log(e.target)
		        bootbox.dialog({
		            message: "<h4>确定删除该用户的预约记录吗？</h4>",
		            buttons: {
		                cancel: {
		                    label: '取消',
		                    className: 'btn-default'
		                },
		                confirm: {
		                    label: '确定',
		                    className: 'btn-primary',
		                    callback: function () {
		                        // $.post("/admin/weixy/reservemanage?act=DeleteLog", { LogID: rid },
                                    $.post("/index.php?c=admin/weiyx/reserve&a=DeleteLog", { LogID: rid }, 
                                    function (data) {
                                        bootbox.dialog({ message: data.success ? '删除成功' : '删除失败', onEscape: true, closeButton: false, backdrop: true });
                                        loadusers(curpage);
                                    }, "json");
		                    }
		                }
		            }
		        });
		    }
		});
	}

    function bindGridEvent() {
        $("*[name=BtnGoUser]").unbind('click').bind('click', function (event) {
			var params = {UserID: $(this).attr("UserID")};
            me.execCommand('go', { a: 'business', b: 'useredit', params: params });
			return false;
        });
    }

    me.addListener('reserveusers', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['Seckill'] = function () {
    var myroot = null;
    this.addListener('Seckill', function (key, args) {
        args.loadHtmlTpl("plugins/weixypackage/html/Seckill.html", function () {
            myroot = args[0];
            $("#voteTabs").tabs();
            $('#SDate,#EDate').datetimepicker({
                dayOfWeekStart: 1,
                lang: 'ch',
                format: 'Y-m-d H:i:00'
            });

            $("#voteTabs").on("tabsactivate", function (event, ui) {
                this.index = $("#voteTabs").tabs("option", "active");
                var viewBody = $(window.frames["frameView"].document.body);
                viewBody.find("section").hide();
                if (this.index == 1) {
                    viewBody.find("#Detail").show();
                } else if (this.index == 2) {
                    viewBody.find("#Join").show();
                } else {
                    viewBody.find("#Home").show();
                }
            });
            if (me.currentModule.params && me.currentModule.params.id) {
                LoadInfo(me.currentModule.params.id);
                $(".IsEdit").show();
                $("#LinkMenu").off("click").on("click", function () {
                    me.execCommand('go', { a: 'weixin', b: 'wxmenu' });
                });
            } else {
                this.date = new Date();
                $("#SDate").val(this.date.FormatString());
                this.date.AddDays(10);
                $("#EDate").val(this.date.FormatString());

                initUE();
                $("#link").attr("disabled", 'disabled').val("保存后才可以生成相应的链接！");
                initCustomForm();
                LoadProductList();
            }

            if ($("#WxImage").val() != "") {
                if ($(".BtnCover").next().is("img")) {
                    $(".BtnCover").next().attr("src", $("#WxImage").val());
                } else {
                    $(".BtnCover").after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", $("#WxImage").val()));
                }
            }
            
        });
    });


    var ue = null;
    function initUE() {
        var html = $('#Detail').val() == "" ? "活动规则：<br/>活动范围：<br />活动人群：<br />" : $('#Detail').val();
        ue = new baidu.editor.ui.Editor({
            toolbars: [[
                'removeformat', 'bold', 'italic', 'underline', 'strikethrough'
                , 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
                , 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', 'link', 'unlink'
            ]]
        });

        ue.render('Detail');
        ue.ready(function () {
            ue.setContent(UE.utils.html(html));
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#content").html(ue.getContent());
        });
        ue.addListener('contentChange', function (editor) {
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#content").html(ue.getContent());
            viewBody.find("#ProductDetail").html("产品详情……");
        });
    }
};
﻿
﻿IWF.plugins['share'] = function () {
    // var me = this, url = "/admin/weixy/sharepower";
    var me = this, url = "/index.php?c=admin/weiyx/SharePower";
    Date.prototype.AddDays = function (day) {
        this.time = this.valueOf();
        if (day && !isNaN(day)) {
            this.time += (day * 60 * 60 * 24 * 1000);
        }
        this.nd = new Date(this.time);
        this.setYear(this.nd.getFullYear());
        this.setMonth(this.nd.getMonth());
        this.setDate(this.nd.getDate());
        this.setHours(this.nd.getHours());
        this.setMinutes(this.nd.getMinutes());
        this.setSeconds(this.nd.getSeconds());
        this.setMilliseconds(this.nd.getMilliseconds());
    }
    Date.prototype.FormatString = function () {
        this.date = this.valueOf();
        this.dt = new Date(this.date);
        return [this.dt.getFullYear(), "-", this.dt.getMonth() + 1, "-", this.dt.getDate(), " ", this.dt.getHours(), ":", this.dt.getMinutes(), ":00"].join("");
    }
    function BindUpLoadImg(args) {
        $('.uploadBtn,.BtnCover', args).off("click").on('click', function (e) {
            var _this = $(this);
            var _thisInput = _this.prev();
            
            YDM.FileManager('image', 1, function (aUrl) {
                if (aUrl.length > 0) {
                    if (_thisInput.is("input") && _thisInput.attr("id")) {
                        var viewBody = $(window.frames["frameView"].document.body);
                        switch (_thisInput.attr("id").toLowerCase()) {
                            case "wximage": {
                                if (_this.next().is("img")) {
                                    _this.next().attr("src", aUrl[0]);
                                } else {
                                    _this.after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", aUrl[0]));
                                }
                                break
                            }
                            case "banner": {
                                console.log(viewBody);
                                if (_this.next().is("img")) {
                                    _this.next().attr("src", aUrl[0]);
                                } else {
                                    _this.after($("<img id='bShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", aUrl[0]));
                                }
                                viewBody.find("#Banner").attr("src", aUrl[0]);
                                break
                            }
                        }
                        _thisInput.val(aUrl[0]);
                    }
                }
            })
        });
    };
    function initFormEvent() {
        ///当前时间与传入的时间比较
        jQuery.validator.addMethod("CKDate", function (value, element, params) {
            var ereg = /^(\d{1,4})(-|\/)(\d{1,2})(-|\/)(\d{1,2})(\s{1})(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            var s = value.match(ereg);
            if (s == null) {
                return false;
            }
            var e = $(params).val().match(ereg);
            var sDate = Number(new Date(s[1], s[3] - 1, s[5], s[7], s[8], s[9]).valueOf());
            var eDate = Number(new Date(e[1], e[3] - 1, e[5], e[7], e[8], e[9]).valueOf());
            return this.optional(element) || ((sDate - eDate) > 0);
        }, jQuery.validator.format("当前时间不能早于{0}的时间."));
        jQuery.validator.addMethod("IsDate", function (value, element) {
            var ereg = /^(\d{1,4})(-|\/)(\d{1,2})(-|\/)(\d{1,2})(\s{1})(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            var r = value.match(ereg);
            if (r == null) {
                return false;
            }
            var d = new Date(r[1], r[3] - 1, r[5], r[7], r[8], r[9]);
            var result = (d.getFullYear() == r[1] && (d.getMonth() + 1) == r[3] && d.getDate() == r[5] && d.getHours() == r[7] && d.getMinutes() == r[8] && d.getSeconds() == r[9]);
            return this.optional(element) || (result);
        }, "请输入正确的日期");
        $("#MainForm").validate({
            invalidHandler: function () {
                $(".gray").removeClass("gray");
            },
            rules: {
                Title: "required"
				, WxImage: "required"
				, Banner: "required"
                , Description: "required"
				, SDate: { required: true, IsDate: true }
				, EDate: { required: function () { return $("#SDate").val() != ""; }, IsDate: true, CKDate: "#SDate" }
            },
            messages: {
                Title: "请输入投票标题！"
				, WxImage: "请上传封面图！"
				, Banner: "请上传Banner图！"
                , Description: "请输入简介"
				, SDate: { required: "请输入活动开始时间！", IsDate: "正确的日期格式：2015-01-01 12:00:00" }
				, EDate: { required: "请输入活动结束时间！", IsDate: "正确的日期格式：2015-01-01 18:00:00", CKDate: "结束时间不能早于开始时间！" }
            },
            submitHandler: function (form) {
                submitForm();
                return false;
            },
            ignore: []
        });
    };
    function submitForm() {
        // var params = $('#MainForm').serialize() + "&act=Save";
        var params = $('#MainForm').serialize() + "&a=Save";
        console.log(params);
        $.post(url, params, function (data, textStatus, jqXHR) {
            if (data.success) {
                $('<div id="success">保存成功</div>').dialog({
                    modal: true, width: 400, close: function () {
                        $("#success").dialog("destroy");
                        me.execCommand('go', { a: 'weixy', b: 'sharelist' });
                    }
                });
            } else {
                $('<div id="error">' + data.msg + '</div>').dialog({
                    modal: true, width: 400, title: "保存失败", close: function () { $("#error").dialog("destroy"); }
                });
            }
        }, "json");
    };
    var myroot = null;
    this.addListener('share', function (key, args) {
        args.loadHtmlTpl("plugins/weixypackage/html/share.html", function () {
            myroot = args[0];

			if (!me.hasLicensePerm('ENABLE_JIFEN')){
				$("input,select",myroot).each(function(i,item){
					if(($(item).attr("name") + "").indexOf("JiFen") > -1){
						$(item).prop("readonly",true);
						$(item).css("height","50px");
						if($(item)[0].tagName == 'SELECT') $(item).hide();
					}
				});
				$("#forJiFenIn,#forJiFenOut").each(function(i,item){
					$(item).html($(item).html() + " <font color='red'><br>当前版本不支持积分功能，请升级到旗舰版以上</font>");
				});
			}

            $("#voteTabs").tabs();
            $('#SDate,#EDate').datetimepicker({
                dayOfWeekStart: 1,
                lang: 'ch',
                format: 'Y-m-d H:i:00'
            });
            BindUpLoadImg(args);
            initFormEvent();
            BindOnEvent();
            $("#voteTabs").on("tabsactivate", function (event, ui) {
                this.index = $("#voteTabs").tabs("option", "active");
                var viewBody = $(window.frames["frameView"].document.body);
                viewBody.find("section").hide();
                if (this.index == 1) {
                    viewBody.find("#Detail").show();
                } else if (this.index == 2) {
                    viewBody.find("#Join").show();
                } else {
                    viewBody.find("#Home").show();
                }
            });
            if (me.currentModule.params && me.currentModule.params.id) {
                LoadInfo(me.currentModule.params.id);
                $(".IsEdit").show();
                $("#LinkMenu").off("click").on("click", function () {
                    me.execCommand('go', { a: 'weixin', b: 'wxmenu' });
                });
            } else {
                this.date = new Date();
                $("#SDate").val(this.date.FormatString());
                this.date.AddDays(10);
                $("#EDate").val(this.date.FormatString());

                initUE();
                $("#link").attr("disabled", 'disabled').val("保存后才可以生成相应的链接！");
                initCustomForm();
            }
            
            if ($("#WxImage").val() != "") {
                if ($(".BtnCover").next().is("img")) {
                    $(".BtnCover").next().attr("src", $("#WxImage").val());
                } else {
                    $(".BtnCover").after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", $("#WxImage").val()));
                }
            }
            if ($("#Banner").val() != "") {
                if ($(".uploadBtn").next().is("img")) {
                    $(".uploadBtn").next().attr("src", $("#Banner").val());
                } else {
                    $(".uploadBtn").after($("<img id='bShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", $("#Banner").val()));
                }
            }
        });
    });

    var voteModel = function () {
        this.setData = function (data) {
            for (var key in data) {
                if (typeof (data[key]) == "object")
                { this[key] = ko.observableArray(data[key]); }
                else {
                    this[key] = ko.observable(data[key]);
                }
            }
        };
        this.AwardList = ko.observableArray([]);
        this.key = ko.observable();
        this.link = ko.observable();
        this.Format = function (n) {
            return n().replace(/T/g, " ");
        };
    };
    var vm = new voteModel();
    function LoadInfo(id) {
        $.ajax({
            type: "POST",
            url: url,
            cache: false,
            dataType: "json",
            // data: { 'act': 'GetInfo', 'id': id },
            data: { 'a': 'GetInfo', 'id': id },
            success: function (data) {
                console.log(data);
                if (data != null) {
                    if (data.success) {
                        vm.setData(data.share)
                        vm.key(data.key);
                        vm.link(data.link);
                        initCustomForm(data.share.FormID, "");
                        $("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", data.share.WxImage);
                        $("<img id='bShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", data.share.Banner);
                        $('<img style="width:200px;height:200px;border:solid 10px #fff;" src="/index.php?c=admin/weiyx/SharePower&a=qrcode&id=' + data.share.Sid + '"/>').appendTo($(".qrcode"));
                        var awardlist = jQuery.parseJSON(data.share.Award);
                        vm.AwardList(awardlist);
                        //修改的图片 再次进入的时候编辑页面还是显示默认图片  修改如下：
                        if ($("#WxImage").val() != "") {
                            if ($(".BtnCover").next().is("img")) {
                                $(".BtnCover").next().attr("src", data.share.WxImage);
                            } else {
                                $(".BtnCover").after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", data.share.WxImage));
                            }
                        }
                        if ($("#Banner").val() != "") {
                            if ($(".uploadBtn").next().is("img")) {
                                $(".uploadBtn").next().attr("src", data.share.Banner);
                            } else {
                                $(".uploadBtn").after($("<img id='bShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", data.share.Banner));
                            }
                        }
                        ko.applyBindings(vm, document.getElementById("voteTabs"));
                        initUE();
                        setTimeout(function () { $(".upImage").show(); }, 1000);
                        
                    }
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    };
    function BindOnEvent() {
        $("input[type='text'],#Corp").on("keyup focus", function (e) {
            var _this = $(e.target);
            var viewBody = $(window.frames["frameView"].document.body);
            if ("banner" == _this.attr("id").toLowerCase()) {
                viewBody.find("#Banner").attr("src", _this.val());
                e.preventDefault();
            }
            if ("corp" == _this.attr("id").toLowerCase()) {
                viewBody.find("#Corp").html(_this.val().replace(/[\n\r]/ig, "<br/>"));
                e.preventDefault();
            }
        });
        $(document).off("click.xxxx").on("click.xxxx", function (e) {
            var _this = $(e.target);
            if (_this.hasClass("upImage")) {
                YDM.FileManager('image', 1, function (aUrl) {
                    var index = _this.attr("data-val");
                    $("#image" + index).val(aUrl[0]);
                    $("#show" + index).attr("src", aUrl[0]).show();
                });
            };
            if (e.target.id == "AddAward") {
                var childs = $(".setAward>tbody").children().length;
                this.tr = ['<tr><td class="glyphicon glyphicon-remove delRow"></td><td><input id="level', childs, '" name="level', childs, '" type="text" class="form-control level-width bind-input" maxlength="10"/></td>'];
                this.tr.push('<td><input id="award', childs, '" name="award', childs, '" type="text" class="form-control award-width bind-input" maxlength="50"/></td>');
                this.tr.push('<td><input id="image', childs, '" name="image', childs, '" type="hidden" class="form-control level-width bind-input"/><input type="button" id="but', childs, '"  data-val="', childs, '" class="btn btn-primary btn-xs upImage" value="上传"/><img id="show', childs, '" class="imgshow" /></td>');
                this.tr.push('</tr>');
                $(".setAward>tbody").append($(this.tr.join('')));
            };
            if (_this.hasClass("imgshow")) {
                $('<div></div>').dialog({
                    modal: true, width: 680, height: 600, position: { my: "center center", at: "center center", of: window },
                    open: function (event, ui) {
                        $(this).append('<img src="'+_this.attr("src")+'" style="width:100%"/>');
                    },
                    close: function () {
                        $(this).dialog("destroy");
                    }
                });
            };
            if (_this.hasClass("delRow")) {
                var childs = $(".setAward>tbody").children().length;
                if (childs > 1) {
                    _this.parent().remove();
                }
            };
        });
    };
    var ue = null;
    function initUE() {
        var html = $('#Detail').val() == "" ? "活动规则：<br/>活动范围：<br />活动人群：<br />" : $('#Detail').val();
        ue = new baidu.editor.ui.Editor({
            toolbars: [[
                'removeformat','bold', 'italic', 'underline', 'strikethrough'
                , 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
                , 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', 'link', 'unlink'
            ]]
        });

        ue.render('Detail');
        ue.ready(function () {
            ue.setContent(UE.utils.html(html));
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#content").html(ue.getContent());
        });
        ue.addListener('contentChange', function (editor) {
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#content").html(ue.getContent());
        });
        
    }
    function initCustomForm(formid, formname) {
        $("#selfForm").html("<iframe name='customFormFrame' src='widget/customform.html?FormID=" + formid + "&FormName=" + formname + "&HideSaveBtn=1&HideTitle=1' frameborder='0' width='100%' height='400'></iframe>");
    };
    
};
﻿IWF.plugins['sharelist'] = function () {

    // var me = this, url = "/admin/weixy/sharepower";
    var me = this, url = "/index.php?c=admin/weiyx/SharePower";
    var ViewModel = function () {
        var self = this;
        self.datalist = ko.observableArray();
        self.WeiXinId = ko.observable();
	    self.State = function (obj, e) {
	        $.ajax({
	            type: "POST",
	            url: url,
	            cache: false,
	            context: $(e.target),
	            dataType: "json",
	            // data: { 'act': 'SetState', 'id': obj.Sid, 'state': $(e.target).attr("data-state") },
                data: { 'a': 'SetState', 'id': obj.Sid, 'state': $(e.target).attr("data-state") }, 
	            success: function (data) {
	                if (data != null) {
	                    if (data.success) {
	                        var state = parseInt($(this).attr("data-state"));
	                        $(this).attr("data-state", state ? 0 : 1);
	                        $(this)[state ? "addClass" : "removeClass"]("glyphicon-eye-close");
	                        $(this)[state == 0 ? "addClass" : "removeClass"]("glyphicon-eye-open");
	                    }
	                }
	            },
	            error: function (XMLHttpRequest, textStatus, errorThrown) {
	                console.log(XMLHttpRequest.responseText);
	            }
	        });
	    };
	    self.showImage = function (t) {
	        var image = "";
	        $.each(me.Party, function (i,o) {
	            if (o.type == t) {
	                image = o.image;
	                return;
	            }
	        });
	        return image;
	    }
		this.getTime = function(time){
			return time.replace(/T/gi," ").replace(/(\.\d+)/,"");
		}
    };

	var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/sharelist.html",function(){
			bindUIEvent();
			ko.applyBindings(vm,root[0]);
			loadList(1);
        });
    }
	    
	var curpage = 1;
	var itemcount = 0;
	function loadList(page) {
        
	    // var params = { 'act': 'DataList', keyword: $("#keyword").val(), page: page, pagesize: 20 };
        var params = { 'a': 'DataList', keyword: $("#keyword").val(), page: page, pagesize: 20 }; 
	    $.getJSON(url, params, function (json) {
            console.log(json);
            vm.datalist(json.list)
            vm.WeiXinId(json.wxid);
			curpage = json.curpage;
			itemcount = json.list ? json.list.length : 0;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadList(page); });
                $("#pagination").show();
            }
            bindGridEvent();
        });
    }

    function bindUIEvent() {
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadList(1);
        });
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("data-sid")}
			me.execCommand('go', { a: 'weixy', b: 'share', params: params });
			return false;
        });

        $("*[name=BtnGoJoin]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).data("sid")}
            me.execCommand('go', { a: 'weixy', b: 'shareuser', params: params });
			return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			// $.getJSON(url, {'act':'Delete', id: $(this).attr("data-sid") }, function (json) {
            $.getJSON(url, {'a':'Delete', id: $(this).attr("data-sid") }, function (json) { 
				if(json.success){
				    if (itemcount > 1)
				        loadList(curpage);
					else loadList(1);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetStatus]").unbind('click').bind('click', function (event) {
		    // $.getJSON(url, { 'act': 'SetState', id: $(this).attr("data-sid"), status: $(this).attr("State") }, function (json) {
            $.getJSON(url, { 'a': 'SetState', id: $(this).attr("data-sid"), status: $(this).attr("State") }, function (json) { 
				if(json.success){
					loadList(curpage);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
		});
        $(".QrCode").mouseover(function () {
            // var img = $('<img class="QRCode" style="position:absolute;width:150px;height:150px;top:-60px;z-index:10;border:solid 10px #fff;" src="/admin/weixy/sharepower?act=qrcode&id=' + $(this).attr("data-val") + '"/>')
            var img = $('<img class="QRCode" style="position:absolute;width:150px;height:150px;top:-60px;z-index:10;border:solid 10px #fff;" src="/index.php?c=admin/weiyx/SharePower&a=qrcode&id=' + $(this).attr("data-val") + '"/>')
		    $(this).parent().append(img);
		}).mouseout(function () {
		    $(".QRCode").remove();
		});
    }

    me.addListener('sharelist', function (key, args) {
        args.addClass('row');
        initUI(args);
        
    });
}

﻿IWF.plugins['shareuser'] = function () {
    var me = this;
    // var url = "/admin/weixy/sharepower", sid = "", curpage = 1, rcsize = 10, pagesize = 10;
    var url = "/index.php?c=admin/weiyx/SharePower", sid = "", curpage = 1, rcsize = 10, pagesize = 10;
    var ViewModel = function () {
        var self = this;
        self.SortIndex = ko.observable(0);
        self.UserList = ko.observableArray([]);
        self.BitImage = function (img) {
            return img ? img.replace(/\/0$/ig, '/132') : "";
        }
        self.getTime = function (time) {
            return time ? time.replace(/T/gi, " ").replace(/(\.\d+)/, "") : "";
        }
        self.LoadUserList = function () {
            $.ajax({
                type: "POST",
                url: url,
                // data: { 'act': 'UserList', 'id': sid, 'cur': curpage, 'rcsize': rcsize },
                data: { 'a': 'UserList', 'id': sid, 'cur': curpage, 'rcsize': rcsize },
                cache: false,
                dataType: "json",
                success: function (data) {
                    if (data != null) {
                        if (data.success) {
                            vm.UserList(data.list);
                            var pageCount = Math.floor(data.recordCount / rcsize);
                            pageCount = (data.recordCount % rcsize) > 0 ? pageCount + 1 : pageCount;
                            $("#pageCount").text(pageCount);
                            $("#rcCount").text(data.recordCount);
                            $("#pagination").pageNav(curpage, pageCount, pagesize, function (page) {
                                curpage = page;
                                self.LoadUserList();
                            });
                            if (curpage > 0) {
                                self.SortIndex(rcsize * (curpage - 1));
                            }
                        } else {
                            console.log(data.msg);
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
        self.Del = function (obj) {
            if (!confirm("确认删除？")) return false;
            console.log(obj);
            // $.getJSON(url, { 'act': 'DeleteUser', 'id': obj.Sid, 'suid': obj.SUid, 'uid': obj.UGuid }, function (data) {
            $.getJSON(url, { 'a': 'DeleteUser', 'id': obj.Sid, 'suid': obj.SUid, 'uid': obj.UGuid }, function (data) {
                if (data.success) {
                    vm.LoadUserList();
                } else {
                    $.showResult("出错啦", data.msg);
                }
            });
        };
    };
    var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/shareuser.html", function () {
            sid = me.currentModule.params.id;
            curpage = 1;
            ko.applyBindings(vm, document.getElementById("showListTable"));
            vm.LoadUserList();
        });
    }
    me.addListener('shareuser', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}
﻿IWF.plugins['signin'] = function () {
    var me = this;
    // var url = '/admin/weixy/SignIn', curPage = 1, rcSize = 10, navSize = 10;
    var url = '/index.php?c=admin/weiyx/SignIn', curPage = 1, rcSize = 10, navSize = 10;
    var voteModel = function () {
        var self = this;
        this.setData = function (data) {
            for (var key in data) {
                if (typeof (data[key]) == "object")
                { this[key] = ko.observableArray(data[key]); }
                else {
                    this[key] = ko.observable(data[key]);
                }
            }
        };
        self.Key = ko.observable();
        self.Link = ko.observable();
        self.Model2ConMax = ko.observable();
        self.SignInLogs = ko.observableArray([]);
        self.Model2ConPoint = ko.observableArray([]);
        self.m2max = ko.observableArray([]);
        self.LoadSignInLog = function () {
            $.ajax({
                type: "POST",
                url: url,
                cache: false,
                dataType: "json",
                // data: { 'act': 'SignInLogs','curPage':curPage,'rcSize':rcSize },
                data: { 'a': 'SignInLogs','curPage':curPage,'rcSize':rcSize },
                success: function (data) {
                    console.log(data);
                    if (data && data.success) {
                        self.SignInLogs(data.list);
                        var pageCount = Math.floor(data.recordcount % rcSize > 0 ? data.recordcount / rcSize + 1 : data.recordcount / rcSize);
                        if (pageCount > 0) {
                            $("#pagination").pageNav(curPage, pageCount, navSize, function (page) {
                                curPage = page;
                                self.LoadSignInLog();
                            });
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        }
        self.DateFormat = function (obj) {
            return obj.replace("T", " ");
        }
    };
    var vm = new voteModel();
    function BindUpLoadImg(args) {
        $('.BtnCover', args).off("click").on('click', function (e) {
            var _this = $(this);
            var _thisInput = $("#MsgCover");
            YDM.FileManager('image', 1, function (aUrl) {
                if (aUrl.length > 0) {
                    if (_thisInput.is("input") && _thisInput.attr("id") && "msgcover" == _thisInput.attr("id").toLowerCase()) {
                        if (_this.next().is("img")) {
                            _this.next().attr("src", aUrl[0]);
                        } else {
                            _this.after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", aUrl[0]));
                        }
                        _thisInput.val(aUrl[0]);
                    }
                    $('#WXCover').attr('src', aUrl[0]);
                }
            });
        });
    };
    function initFormEvent() {
        $("#MainForm").validate({
            invalidHandler: function () {
                $(".gray").removeClass("gray");
            },
            rules: {
                MsgTitle: "required",
                Point: { digits: true },
                ConPoint: { digits: true },
                ConPointMax: { digits: true },
            },
            messages: {
                MsgTitle: "请输入标题！",
                Point: { digits: "<span style='color:#ca0000;'>只能输入整数！</span>" },
                ConPoint: { digits: "<span style='color:#ca0000;'>只能输入整数！</span>" },
                ConPointMax: { digits: "<span style='color:#ca0000;'>只能输入整数！</span>" },
            },
            submitHandler: function (form) {
                var tt = $(form).serializeObject();
                if(parseInt($('#ConPoint').val()) > parseInt($('#ConPointMax').val()) && parseInt($('#ConPointMax').val()) > 0){
                    alert('连续签到激励上限 不能小于 连续签到激励！');
                    return;
                }
                // alert(tt.Sid);
                tt.Sid = '';
                // // tt.splice('Sid',1);
                // var ss = '';
                // for(var i in tt){
                //     ss += i+':'+tt[i]+"\n";
                // }
                // alert(ss);

                // $.post("/admin/weixy/SignIn?act=Save", $(form).serialize(), function (data, textStatus, jqXHR) {
                $.post("/index.php?c=admin/weiyx/SignIn&a=Save", tt, function (data, textStatus, jqXHR) {
                    if (data.success) {
                        $('<div id="success">保存成功</div>').dialog({
                            modal: true, width: 400, close: function () {
                                $("#success").dialog("destroy");
                            }
                        });
                    } else {
                        $('<div id="error">' + data.msg + '</div>').dialog({
                            modal: true, width: 400, title: "保存失败", close: function () { $("#error").dialog("destroy"); }
                        });
                    }
                }, "json");
                return false;
            },
            ignore: []
        });
    };
    function M2signhelp(){
        var m2clastp = parseInt($('[id^=m2ConPoint]:last').val());
        var m2cfirstp = parseInt($('#m2ConPoint1').val());
        var m2cd = $('[id^=m2ConPoint]').length;
        if(isNaN(m2clastp)) m2clastp = 0;
        if(isNaN(m2cfirstp)) m2cfirstp = 0;
        var ttm2 = "开启后，连续签到第"+(m2cd+1)+"天获得的积分从第一天重新计算循环，即第"+(m2cd+1)+"天会获得"+m2cfirstp+"积分；关闭后，不会从第一天重新循环，而是继续获得第"+m2cd+"天的积分数，即第"+(m2cd+1)+"天会获得"+m2clastp+"积分。";
        $('#m2pm').attr('title',ttm2);
        
        $('#m2ConPoint1').keyup(function(){
            m2cfirstp = parseInt($(this).val());
            if(isNaN(m2cfirstp)) m2cfirstp = 0;
            ttm2 = "开启后，连续签到第"+(m2cd+1)+"天获得的积分从第一天重新计算循环，即第"+(m2cd+1)+"天会获得"+m2cfirstp+"积分；关闭后，不会从第一天重新循环，而是继续获得第"+m2cd+"天的积分数，即第"+(m2cd+1)+"天会获得"+m2clastp+"积分。";
            $('#m2pm').attr('title',ttm2);
        });
        $('[id^=m2ConPoint]:last').keyup(function(){
            m2clastp = parseInt($(this).val());
            if(isNaN(m2clastp)) m2clastp = 0;
            ttm2 = "开启后，连续签到第"+(m2cd+1)+"天获得的积分从第一天重新计算循环，即第"+(m2cd+1)+"天会获得"+m2cfirstp+"积分；关闭后，不会从第一天重新循环，而是继续获得第"+m2cd+"天的积分数，即第"+(m2cd+1)+"天会获得"+m2clastp+"积分。";
            $('#m2pm').attr('title',ttm2);
        });
    }
    function ConPointShow(){
        $('#m1').unbind('click').click(function(){
            $('#signmodel2').hide();
            $('#signmodel1').show();
        });
        $('#m2').unbind('click').click(function(){
            $('#signmodel1').hide();
            $('#signmodel2').show();
        });
        var ConState = $("input[name='ConSigninState']:checked").val();
        if(ConState == 1){
            $('#ConPointTab').css('display','block');
        }else{
            $('#ConPointTab').css('display','none');
        }
        $('#c1').unbind('click').click(function(){
            var ConState1 = $("input[name='ConSigninState']:checked").val();
            if(ConState1 == 1){
                $('#ConPointTab').css('display','block');
            }else{
                $('#ConPointTab').css('display','none');
            }
        });
        $('#c2').unbind('click').click(function(){
            var ConState2 = $("input[name='ConSigninState']:checked").val();
            if(ConState2 == 1){
                $('#ConPointTab').css('display','block');
            }else{
                $('#ConPointTab').css('display','none');
            }
        });
        var conpoint = parseInt($('#ConPoint').val());
        var point = parseInt($('#Point').val());
        var conpointmax = parseInt($('#ConPointMax').val());
        var tt = "每连续签到1天可多获得的积分数，比如,基础签到积分为"+point+",连续签到叠加积分为"+conpoint+",第1天签到积分为 "+point+",第2天为 "+(point+conpoint)+",第3天为 "+(point+conpoint*2)+",第4天为 "+(point+conpoint*3)+",第5天为 "+(point+conpoint*4)+" ... ...";
        var ttm = "连续签到叠加的最大积分,比如,基础签到积分为"+point+",叠加上限为"+conpointmax+",则用户连续签到可以获得的最大积分为 ("+point+" + "+conpointmax+") = "+(point+conpointmax);
        if(conpoint != 0 && point != 0 && !isNaN(conpoint) && !isNaN(point) && conpointmax != 0 && !isNaN(conpointmax)){
            $('#conp').attr('title',tt);
            $('#conpm').attr('title',ttm);
        }
        $('#ConPoint').keyup(function(){
            conpoint = parseInt($(this).val());
            tt = "每连续签到1天可多获得的积分数，比如,基础签到积分为"+point+",连续签到叠加积分为"+conpoint+",第1天签到积分为 "+point+",第2天为 "+(point+conpoint)+",第3天为 "+(point+conpoint*2)+",第4天为 "+(point+conpoint*3)+",第5天为 "+(point+conpoint*4)+" ... ...";
            if(conpoint != 0 && point != 0 && !isNaN(conpoint) && !isNaN(point)){
                $('#conp').attr('title',tt);
            }
        });
        $('#ConPointMax').keyup(function(){
            conpointmax = parseInt($('#ConPointMax').val());
            ttm = "连续签到叠加的最大积分,比如,基础签到积分为"+point+",叠加上限为"+conpointmax+",则用户连续签到可以获得的最大积分为 ("+point+" + "+conpointmax+") = "+(point+conpointmax);
            if(conpoint != 0 && point != 0 && !isNaN(conpoint) && !isNaN(point) && conpointmax != 0 && !isNaN(conpointmax)){
                $('#conpm').attr('title',ttm);
            }
        });
        $('#Point').keyup(function(){
            point = parseInt($(this).val());
            tt = "每连续签到1天可多获得的积分数，比如,基础签到积分为"+point+",连续签到叠加积分为"+conpoint+",第1天签到积分为 "+point+",第2天为 "+(point+conpoint)+",第3天为 "+(point+conpoint*2)+",第4天为 "+(point+conpoint*3)+",第5天为 "+(point+conpoint*4)+" ... ...";
            ttm = "连续签到叠加的最大积分,比如,基础签到积分为"+point+",叠加上限为"+conpointmax+",则用户连续签到可以获得的最大积分为 ("+point+" + "+conpointmax+") = "+(point+conpointmax);
            if(conpoint != 0 && point != 0 && !isNaN(conpoint) && !isNaN(point) && conpointmax != 0 && !isNaN(conpointmax)){
                $('#conp').attr('title',tt);
                $('#conpm').attr('title',ttm);
            }
        });
        
        M2signhelp();
        $('.signhelp').tooltip();

    }
    function m2ConShow(){
        $("#Model2ConMax").bootstrapSwitch({
            'size':'mini',
            'onColor':'success',
            'offColor':'danger',
            'onText':'开启',
            'offText':'关闭'
        });
        AddDelBtn();
        // $("#m2ConMax").bootstrapSwitch('setSizeClass','mini');
    }
    function AddDelBtn(){
        $('.del-btn').unbind('click').click(function(){
            var thisday = $(this).attr('did');
            var upday = parseInt(thisday) - 1;
            if(upday == 1){
                var uphtml = '<span disabled class="input-group-addon btn btn-danger del-btn" did="'+upday+'">删除</span><span class="input-group-addon btn btn-info add-btn" did="'+upday+'">添加</span>  ';
            }else{
                var uphtml = '<span class="input-group-addon btn btn-danger del-btn" did="'+upday+'">删除</span><span class="input-group-addon btn btn-info add-btn" did="'+upday+'">添加</span>  ';
            }
            
            $(this).parent().prev().find('.label-error').before(uphtml);
            $(this).parent().remove();
            M2signhelp();
            AddDelBtn();
        });
        $('.add-btn').unbind('click').click(function(){
            var lastid = $(this).attr('did');
            var newday = parseInt(lastid)+1;
            if(newday >= 30){
                var addday = '<div class="input-group"><span class="input-group-addon">第 '+newday+' 天</span><input id="m2ConPoint'+newday+'" name="m2ConPoint['+newday+']" value="0" class="form-control" style="width:50px;" /><span class="input-group-addon">积分</span><span class="input-group-addon btn btn-danger del-btn" did="'+newday+'">删除</span><span disabled class="input-group-addon btn btn-info add-btn" did="'+newday+'">添加</span><label for="m2ConPoint'+newday+'" generated="true" class="label-error error gray"></label></div>';
            }else{
                var addday = '<div class="input-group"><span class="input-group-addon">第 '+newday+' 天</span><input id="m2ConPoint'+newday+'" name="m2ConPoint['+newday+']" value="0" class="form-control" style="width:50px;" /><span class="input-group-addon">积分</span><span class="input-group-addon btn btn-danger del-btn" did="'+newday+'">删除</span><span class="input-group-addon btn btn-info add-btn" did="'+newday+'">添加</span><label for="m2ConPoint'+newday+'" generated="true" class="label-error error gray"></label></div>';
            }
            
            $(this).parent().after(addday);
            $(this).prev('span').remove();
            $(this).remove();
            M2signhelp();
            AddDelBtn();
        });
    }
    this.addListener('signin', function (key, args) {
        args.loadHtmlTpl("plugins/weixypackage/html/signin.html", function () {
            $("#SignTabs").tabs();
            BindUpLoadImg(args[0]);
            BindEvent(args[0]);
            initFormEvent();
            
            initUE();
            if ($("#MsgCover").val() != "") {
                if ($(".BtnCover").next().is("img")) {
                    $(".BtnCover").next().attr("src", $("#MsgCover").val());
                } else {
                    $(".BtnCover").after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", $("#MsgCover").val()));
                }
                $("#WXCover").attr('src', $("#MsgCover").val());
            }
            GetSignIn();
            
            $("#SignTabs").on("tabsactivate", function (event, ui) {
                this.index = $("#SignTabs").tabs("option", "active");
                if (this.index == 2) {
                    vm.LoadSignInLog();
                    $("#btnSave").hide();
                } else {
                    $("#btnSave").show();
                }
            });
        });
    });
    var ue=null
    function initUE() {
        try{
            ue = new baidu.editor.ui.Editor({
                initialFrameWidth: "360",
                initialFrameHeight: "350",
                autoHeightEnabled: true,
                toolbars: [[
                     'bold', 'italic', 'underline', 'strikethrough', 'removeformat'
                    , 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
                    , 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify'
                    , 'imagenone', 'imageleft', 'imageright', 'imagecenter'
                ]]
            });
            
            ue.render('MsgDetail');
        } catch (e) {
            console.log(e);
        }
    }
    function BindEvent(root) {
        $("#MsgTitle", root).off("keyup focus blur").on("keyup focus blur", function (e) {
            $(".WXTitle").text($(this).val());
        });
    };
    function GetSignIn() {
        $.ajax({
            type: "POST",
            url: url,
            cache: false,
            // data: { 'act': 'GetSignIn' },
            data: { 'a': 'GetSignIn' },
            dataType: "json",
            success: function (data) {
                console.log(data);
                if (data && data.success) {
                    vm.setData(data.signin)
                    vm.Key(data.key);
                    vm.Link(data.link);
                    if(!data.signin.Model2ConPoint){
                        //初始化模式2
                        data.signin.Model2ConPoint = '[{"day":1,"point":1},{"day":2,"point":1},{"day":3,"point":1},{"day":4,"point":1},{"day":5,"point":5}]';
                    }
                    if(!data.signin.ConPoint && data.signin.ConPoint != '0'){
                        data.signin.ConPoint = 1;
                    }
                    if(!data.signin.ConPointMax){
                        data.signin.ConPointMax = 0;
                    }
                    var m2p = jQuery.parseJSON(data.signin.Model2ConPoint);
                    var m2m = m2p[m2p.length-1];
                    m2p.splice(m2p.length-1,1);
                    vm.m2max(m2m);
                    vm.Model2ConPoint(m2p);
                    var modal = $("input[name='ConSigninState']:checked").val();
                    $('#signmodel'+data.signin.SignModel).show();
                    
                    // $('<img style="width:200px;height:200px;border:solid 10px #fff;" src="/admin/weixy/Signin?act=qrcode"/>').appendTo($(".qrcode"));
                    $('<img style="width:200px;height:200px;border:solid 10px #fff;" src="/index.php?c=admin/weiyx/SignIn&a=QRCode"/>').appendTo($(".qrcode"));
                    ko.applyBindings(vm, document.getElementById("SignTabs"));
                    $("#LinkMenu").off("click").on("click", function () {
                        me.execCommand('go', { a: 'weixin', b: 'wxmenu' });
                    });
                    
                    ue.ready(function () {
                        ue.setContent(UE.utils.html(data.signin.MsgDetail));
                    });
                    $('#WXCover, #WxShow').attr('src', data.signin.MsgCover);

                    ConPointShow();
                    m2ConShow();
                    jQuery.extend(jQuery.validator.messages, {
                        digits: "<span style='color:#ca0000;'>只能输入整数！</span>",
                    });
                } else { $("#Link").attr("disabled", 'disabled'); }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    };
};
IWF.plugins['signinlist'] = function () {

    var me = this;

    var ViewModel = function () {
        this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
        this.showImage = function (image) {
            if(!image) image = "/images/SignIn/Cover.jpg";
            return image;
        }
        this.getTime = function(time){
            if(/^(1970)/.test(time)) return "不限制结束时间";
            return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
        }
    };

    var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/signinlist.html",function(){
            bindUIEvent();
            ko.applyBindings(vm,root[0]);
            loadreservelist(1);         
        });
    }
        
    var curpage = 1;
    var itemcount = 0;
    function loadreservelist(page) {
        // $.getJSON("/admin/weixy/reservemanage?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/SignIn&a=GetList", null, function (json) {
            vm.setData(json.list);
            curpage = json.curpage;
            itemcount = json.list.length;
            
            bindGridEvent();
        });
    }

    function bindUIEvent() {
        $("#BtnSearch").unbind('click').bind('click', function (event) {
            loadreservelist(1);
        });

        $("#BtnAddLuck").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'weixy', b: 'signin', params: me.currentModule.params });
            return false;
        });
    }

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("SiteId") };
            me.execCommand('go', { a: 'weixy', b: 'signin', params: params });
            return false;
        });

        $("*[name=BtnGoLog]").unbind('click').bind('click', function (event) {
            var params = {id: $(this).attr("SiteId") };
            me.execCommand('go', { a: 'weixy', b: 'signinusers', params: params });
            return false;
        });


        $("*[name=BtnSetStatus]").unbind('click').bind('click', function (event) {
            // $.getJSON("/admin/weixy/reservemanage?act=setstatus", utils.params({id:$(this).attr("ReserveID"),status: $(this).attr("Status")}), function (json) {
            $.getJSON("/index.php?c=admin/weiyx/SignIn&a=SetStatus", utils.params({id:$(this).attr("ReserveID"),state: $(this).attr("State")}), function (json) { 
                if(json.success){
                    loadreservelist(curpage);
                }else{
                    $.showResult("出错啦",json.msg);
                }
            });
            return false;
        });

        $(".fa-qrcode").mouseover(function () {
            var maxh = $("#showListTable").position().top;
            $("#divQRCodePreview").remove();
            // var qrcodesrc = "/admin/weixy/reservemanage?act=qrcode&id=" + $(this).attr("data-val");
            var qrcodesrc = "/index.php?c=admin/weiyx/SignIn&a=QRCode&InitSiteID=" + $(this).attr("data-val");
            var html = "<div id='divQRCodePreview' class='divQRCodePreview' style='padding:5px;border:1px solid #cccccc;background:white;position:absolute;z-index:999'>";
            html += "<img src='"+ qrcodesrc +"' width='150'/>";
            html += "</div>";
            $("body").append(html);
            var top = $(this).offset().top + 20;
            if(top + $("#divQRCodePreview").height() > maxh) top = $(this).offset().top - $("#divQRCodePreview").height();
            $("#divQRCodePreview").css({top:top,left:$(this).offset().left + 20});
            
        }).mouseout(function () {
            $("#divQRCodePreview").remove();
        });
    }

    me.addListener('signinlist', function (key, args) {
        initUI(args);
    });
}

IWF.plugins['signinusers'] = function () {
    var me = this;
    // var url = '/admin/weixy/SignIn', curPage = 1, rcSize = 10, navSize = 10;
    var url = '/index.php?c=admin/weiyx/SignIn', curPage = 1, rcSize = 50, navSize = 10;
    var voteModel = function () {
        var self = this;
        this.setData = function (data) {
            for (var key in data) {
                if (typeof (data[key]) == "object")
                { this[key] = ko.observableArray(data[key]); }
                else {
                    this[key] = ko.observable(data[key]);
                }
            }
        };
        self.Key = ko.observable();
        self.Link = ko.observable();
        self.SignInLogs = ko.observableArray([]);
        self.LoadSignInLog = function () {
            $.ajax({
                type: "POST",
                url: url,
                cache: false,
                dataType: "json",
                // data: { 'act': 'SignInLogs','curPage':curPage,'rcSize':rcSize },
                data: { 'a': 'SignInLogs','curPage':curPage,'rcSize':rcSize },
                success: function (data) {
                    console.log(data);
                    if (data && data.success) {
                        self.SignInLogs(data.list);
                        var pageCount = Math.floor(data.recordcount % rcSize > 0 ? data.recordcount / rcSize + 1 : data.recordcount / rcSize);
                        if (pageCount > 0) {
                            $("#pagination").pageNav(curPage, pageCount, navSize, function (page) {
                                curPage = page;
                                self.LoadSignInLog();
                            });
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        }
        self.DateFormat = function (obj) {
            return obj.replace("T", " ");
        }
    };
    var vm = new voteModel();
    
    this.addListener('signinusers', function (key, args) {
        args.loadHtmlTpl("plugins/weixypackage/html/signinusers.html", function () {
            $("#BtnBack").unbind().bind('click', function (event) {
                me.execCommand('go', { a: 'weixy', b: 'signinlist' });
                return false;
            });
            vm.LoadSignInLog();
            ko.applyBindings(vm, document.getElementById("showListTable"));
        });
    });
    
   
};
﻿IWF.plugins['vote'] = function () {
    var me = this;
    Date.prototype.AddDays = function (day) {
        this.time = this.valueOf();
        if (day && !isNaN(day)) {
            this.time += (day * 60 * 60 * 24 * 1000);
        }
        this.nd = new Date(this.time);
        this.setYear(this.nd.getFullYear());
        this.setMonth(this.nd.getMonth());
        this.setDate(this.nd.getDate());
        this.setHours(this.nd.getHours());
        this.setMinutes(this.nd.getMinutes());
        this.setSeconds(this.nd.getSeconds());
        this.setMilliseconds(this.nd.getMilliseconds());
    }
    Date.prototype.FormatString = function () {
        this.date = this.valueOf();
        this.dt = new Date(this.date);
        return [this.dt.getFullYear(), "-", this.dt.getMonth() + 1, "-", this.dt.getDate(), " ", this.dt.getHours(), ":", this.dt.getMinutes(), ":00"].join("");
    }
    me.BindUpLoadImg = function (args) {
        $('.uploadBtn', args).off("click").on('click', function (e) {
            var _this = $(this);
            var _thisInput = _this.prev();
            var viewBody = $(window.frames["frameView"].document.body);
            YDM.FileManager('image', 1, function (aUrl) {
                if (aUrl.length > 0) {
                    if (_thisInput.is("input") && _thisInput.attr("id")) {

                        switch (_thisInput.attr("id").toLowerCase()) {
                            case "wximage": {
                                if (_this.next().is("img")) {
                                    _this.next().attr("src", aUrl[0]);
                                } else {
                                    _this.after($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", aUrl[0]));
                                }
                                break
                            }
                            case "backimage": {
                                if (_this.next().is("img")) {
                                    _this.next().attr("src", aUrl[0]);
                                } else {
                                    _this.after($("<img id='bShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", aUrl[0]));
                                }
                                viewBody.css({ "background-image": "url(" + aUrl[0] + ")" });
                                break
                            }
                            case "banner": {
                                if (_this.next().is("img")) {
                                    _this.next().attr("src", aUrl[0]);
                                } else {
                                    _this.after($("<img id='BannerShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", aUrl[0]));
                                }
                                viewBody.find("#Banner").attr("src", aUrl[0]);
                                break
                            }
                        }
                        _thisInput.val(aUrl[0]);
                    }
                }
            })
        });
    };
    function initFormEvent() {
        ///当前时间与传入的时间比较
        jQuery.validator.addMethod("CKDate", function (value, element, params) {
            var ereg = /^(\d{1,4})(-|\/)(\d{1,2})(-|\/)(\d{1,2})(\s{1})(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            var s = value.match(ereg);
            if (s == null) {
                return false;
            }
            var e = $(params).val().match(ereg);
            var sDate = Number(new Date(s[1], s[3] - 1, s[5], s[7], s[8], s[9]).valueOf());
            var eDate = Number(new Date(e[1], e[3] - 1, e[5], e[7], e[8], e[9]).valueOf());
            return this.optional(element) || ((sDate - eDate) > 0);
        }, jQuery.validator.format("当前时间不能早于{0}的时间."));
        jQuery.validator.addMethod("IsDate", function (value, element) {
            var ereg = /^(\d{1,4})(-|\/)(\d{1,2})(-|\/)(\d{1,2})(\s{1})(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            var r = value.match(ereg);
            if (r == null) {
                return false;
            }
            var d = new Date(r[1], r[3] - 1, r[5], r[7], r[8], r[9]);
            var result = (d.getFullYear() == r[1] && (d.getMonth() + 1) == r[3] && d.getDate() == r[5] && d.getHours() == r[7] && d.getMinutes() == r[8] && d.getSeconds() == r[9]);
            return this.optional(element) || (result);
        }, "请输入正确的日期");
        $("#MainForm").validate({
            invalidHandler: function () {
                $(".gray").removeClass("gray");
            },
            rules: {
                Title: "required"
                , VoteDay: { required: true, digits: true }
				, WxImage: "required"
				, BackImage: "required"
				, Banner: "required"
				, SDate: { required: true, IsDate: true }
				, EDate: { required: function () { return $("#SDate").val() != ""; }, IsDate: true, CKDate: "#SDate" }
				, JiFenInJoin: { required: true,min:0}
				, JiFenIn: { required: true,min:0},
            },
            messages: {
                Title: "请输入投票标题！"
                , VoteDay: { required: "投票规则次数不能为空！", digits: "只能为数值！" }
				, WxImage: "请上传封面图！"
				, BackImage: "请上传背景图！"
				, Banner: "请上传Banner图！"
				, SDate: { required: "请输入活动开始时间！", IsDate: "正确的日期格式：2015-01-01 12:00:00" }
				, EDate: { required: "请输入活动结束时间！", IsDate: "正确的日期格式：2015-01-01 18:00:00", CKDate: "结束时间不能早于开始时间！" }
				, JiFenInJoin: { required: "请输入积分",min: "积分不能为负数"}
				, JiFenIn: { required: "请输入积分",min: "积分不能为负数"},
            },
            submitHandler: function (form) {
                //submitForm();
            	submitMyForm();
                return false;
            },
            ignore: []
        });
    };
    function submitMyForm() {
        var params = $('#MainForm').serializeObject();
        //$.post("/admin/weixy/vote?act=Save", params, function (data, textStatus, jqXHR) {
        $.post("/index.php?c=admin/weiyx/Vote&a=Save", params, function (data, textStatus, jqXHR) {
            if (data.success) {
                $('<div id="success">保存成功</div>').dialog({
                    modal: true, width: 400, close: function () {
                        $("#success").dialog("destroy");
                        me.execCommand('go', { a: 'weixy', b: 'votelist' });
                    }
                });
            } else {
                $('<div id="error">' + data.msg + '</div>').dialog({
                    modal: true, width: 400, title: "保存失败", close: function () { $("#error").dialog("destroy"); }
                });
            }
        }, "json");
    };
    var myroot = null;
    this.addListener('vote', function (key, args) {
        args.loadHtmlTpl("plugins/weixypackage/html/vote.html?t="+Math.random(), function () {
            myroot = args[0];

			if (!me.hasLicensePerm('ENABLE_JIFEN')){
				$("input,select",myroot).each(function(i,item){
					if(($(item).attr("name") + "").indexOf("JiFen") > -1){
						$(item).prop("readonly",true);
						$(item).css("height","50px");
						if($(item)[0].tagName == 'SELECT') $(item).hide();
					}
				});
				$("#forJiFenIn,#forJiFenOut,#forJiFenInJoin").each(function(i,item){
					$(item).html($(item).html() + " <font color='red'><br>当前版本不支持积分功能，请升级到旗舰版以上</font>");
				});
			}

            $("#voteTabs").tabs();
            $('#SDate,#EDate').datetimepicker({
                dayOfWeekStart: 1,
                lang: 'ch',
                format: 'Y-m-d H:i:00'
            });
            me.BindUpLoadImg(args);
            initFormEvent();
            BindOnEvent();
            $("#voteTabs").on("tabsactivate", function (event, ui) {
                this.index = $("#voteTabs").tabs("option", "active");
                var viewBody = $(window.frames["frameView"].document.body);
                viewBody.find("section").hide();
                /*if (this.index == 0) {
                    viewBody.find("#Home").show();
                }*/
                if (this.index == 1) {
                    viewBody.find("#Detail").show();
                } else {
                    viewBody.find("#Home").show();
                }
            });
            if (me.currentModule.params && me.currentModule.params.id) {
                LoadVote(me.currentModule.params.id);
                $(".IsEdit").show();
                $("#LinkMenu").off("click").on("click", function () {
                    me.execCommand('go', { a: 'weixin', b: 'wxmenu' });
                });
            } else {
                this.date = new Date();
                $("#SDate").val(this.date.FormatString());
                this.date.AddDays(10);
                $("#EDate").val(this.date.FormatString());
                initUE();
                $("#VoteLink").attr("disabled", 'disabled');
                initCustomForm();
            }
        });
    });
    var voteModel = function () {
        this.setData = function (data) {
            for (var key in data) {
                if (typeof (data[key]) == "object")
                { this[key] = ko.observableArray(data[key]); }
                else {
                    this[key] = ko.observable(data[key]);
                }
            }
        };
        this.VoteKey = ko.observable();
        this.VoteLink = ko.observable();
        this.Format = function (n) {
            return n().replace(/T/g, " ");
        };
    };
    var vm = new voteModel();
    function LoadVote(id) {
        $.ajax({
            type: "POST",
            //url: "/admin/weixy/vote?act=VoteInfo",
            url: "/index.php?c=admin/weiyx/Vote&a=VoteInfo",
            async: true,
            cache: false,
            dataType: "json",
            data: { vid: id },
            success: function (data) {
                console.log(data);
                if (data != null) {
                    if (data.success) {
                        vm.setData(data.vote)
                        vm.VoteKey(data.voteKey);
                        vm.VoteLink(data.voteLink);
                        initCustomForm(data.vote.FormID, "");
                        $("#SetVoteRule").text(parseInt(data.vote.VoteRule) ? "票/粉丝/天" : "票/粉丝");
                        $("#SetUserRule").text(parseInt(data.vote.UserRule) ? "会员/粉丝" : "匿名");
                        $("[for=WxImage]").before($("<img id='WxShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", data.vote.WxImage));
                        $("[for=BackImage]").before($("<img id='bShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", data.vote.BackImage));
                        $("[for=Banner]").before($("<img id='BannerShow' style='max-height:30px;max-width:50px;margin-left:20px;'/>").attr("src", data.vote.Banner));
                       // $('<img style="width:200px;height:200px;border:solid 10px #fff;" src="/admin/weixy/vote?act=qrcode&id=' + data.vote.Vid + '"/>').appendTo($(".qrcode"));
                        $('<img style="width:200px;height:200px;border:solid 10px #fff;" src="/index.php?c=admin/weiyx/Vote&a=qrcode&id=' + data.vote.Vid + '"/>').appendTo($(".qrcode"));
                        ko.applyBindings(vm, document.getElementById("voteTabs"));
                        initUE();
                    }
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.responseText);
            }
        });
    };
    function BindOnEvent() {
        $("input[type='text'],#Corp").on("keyup focus", function (e) {
            var _this = $(e.target);
            var viewBody = $(window.frames["frameView"].document.body);
            if ("banner" == _this.attr("id").toLowerCase()) {
                viewBody.find("#Banner").attr("src", _this.val());
                e.preventDefault();
            }
            if ("corp" == _this.attr("id").toLowerCase()) {
                viewBody.find("#Corp").html(_this.val().replace(/[\n\r]/ig, "<br/>"));
                e.preventDefault();
            }
        });
        $(".dropdown-menu").off("click").on("click", function (e) {
            var _this = $(e.target);

            if (_this.hasClass("VoteRule")) {
                e.preventDefault();
                $("#SetVoteRule").text(_this.text());
                $("#VoteRule").val(_this.attr("data-value"));
            }
            if (_this.hasClass("UserRule")) {
                e.preventDefault();
                $("#SetUserRule").text(_this.text());
                $("#UserRule").val(_this.attr("data-value"));
            }
        });
    };
    var ue = null, ue1 = null, ue2 = null;;
    function initUE() {
        var corp = $("#Corp").val() == "" ? "主办：xxx公司<br/>协办：xxxx机构" : $("#Corp").val();
        var html = $('#Detail').val() == "" ? "活动规则：<br/>活动范围：<br />活动人群：<br />" : $('#Detail').val();
        var FooterDetail = $("#FooterDetail").val() == "" ? "" : $("#FooterDetail").val();
        ue = new baidu.editor.ui.Editor({
            toolbars: [[
                'removeformat', 'bold', 'italic', 'underline', 'strikethrough'
                , 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
                , 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', 'link', 'unlink'
            ]]
        });


        ue.render('Detail');

        ue.ready(function () {
            ue.setContent(UE.utils.html(html));
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#content").html(ue.getContent());
        });
        ue.addListener('contentChange', function (editor) {
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#content").html(ue.getContent());
        });

        ue1 = new baidu.editor.ui.Editor({
            toolbars: [[
                'removeformat', 'bold', 'italic', 'underline', 'strikethrough'
                , 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
                , 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', 'link', 'unlink'
            ]]
        });
        ue1.render("Corp");
        ue1.ready(function () {
            ue1.setContent(UE.utils.html(corp));
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#Corp").html(ue1.getContent());
        });
        ue1.addListener('contentChange', function (editor) {
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#Corp").html(ue1.getContent());
        });
        //FooterDetail
        ue2 = new baidu.editor.ui.Editor({
            toolbars: [[
                'removeformat', 'bold', 'italic', 'underline', 'strikethrough'
                , 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
                , 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', 'link', 'unlink'
            ]]
        });
        ue2.render("FooterDetail");
        ue2.ready(function () {
            ue2.setContent(UE.utils.html(FooterDetail));
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#FooterDetail").html(ue2.getContent());
        });
        ue2.addListener('contentChange', function (editor) {
            var viewBody = $(window.frames["frameView"].document.body);
            viewBody.find("#FooterDetail").html(ue2.getContent());
        });
    }
    function initCustomForm(formid, formname) {
        $("#selfForm").html("<iframe name='customFormFrame' src='widget/customform.html?FormID=" + formid + "&FormName=" + formname + "&&HideTitle=1&t="+Math.random()+"' frameborder='0' width='100%' height='400'></iframe>");
    };
    function submitForm() {
        var func = function (data) {
            console.log(data);
            if (!data.success) {
                alert(data.msg);
                $("#voteTabs", myroot).tabs("option", "active", 2);
                return;
            }
            if (data && data.success) {
                if (data.newform && data.newform.ID) {
                    $("#FormID", myroot).val(data.newform.ID);
                    initCustomForm(data.newform.ID, data.newform.Name);
                }
                submitMyForm();
            } else {
                window.frames['customFormFrame'].location = window.frames['customFormFrame'].location;
            }
        }
        window.frames['customFormFrame'].framework.submitForm(func);
    }
};
﻿IWF.plugins['votelist'] = function () {

    var me = this;
	var ViewModel = function () {
	    this.lucklist = ko.observableArray();
	    this.showImage = function (t) {
	        var image = "";
	        $.each(me.Party, function (i,o) {
	            if (o.type == t) {
	                image = o.image;
	                return;
	            }
	        });
	        return image;
	    }
		this.getTime = function(time){
			return time.replace(/T/gi," ").replace(/(\.\d+)/,"");
		}
    };

	var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/votelist.html?t="+Math.random(),function(){
			bindUIEvent();
			ko.applyBindings(vm,root[0]);
			loadList(1);
        });

    }
	    
	var curpage = 1;
	var itemcount = 0;
	function loadList(page) {
        
        var params = { sid: me.sid, keyword: $("#keyword").val(), page: page, pagesize: 20 };
        //$.getJSON("/admin/weixy/vote?act=VoteList", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/Vote&a=VoteList", utils.params(params), function (json) {
            console.log(json);
            vm.lucklist(json.list)
			curpage = json.curpage;
			itemcount = json.list ? json.list.length : 0;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadList(page); });
                $("#pagination").show();
            }

            bindGridEvent();

        });
    }

    function bindUIEvent() {
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadList(1);
        });

		$("#BtnAddLuck").unbind().bind('click', function (event) {
		    me.execCommand('go', { a: 'weixy', b: 'vote', params: me.currentModule.params });
			return false;
        });
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("data-vid")}
			me.execCommand('go', { a: 'weixy', b: 'vote', params: params });
			return false;
        });

        $("*[name=BtnGoJoin]").unbind('click').bind('click', function (event) {
            var params = { vid: $(this).attr("data-vid")}
            me.execCommand('go', { a: 'weixy', b: 'voteuser', params: params });
			return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			//$.getJSON("/admin/weixy/vote?act=Delete", utils.params({ id: $(this).attr("data-vid") }), function (json) {
			$.getJSON("/index.php?c=admin/weiyx/Vote&a=Delete", utils.params({ id: $(this).attr("data-vid") }), function (json) {
				if(json.success){
					if(itemcount > 1) loadList(curpage);
					else loadList(1);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetStatus]").unbind('click').bind('click', function (event) {
			//$.getJSON("/admin/weixy/vote?act=setstatus", utils.params({id:$(this).attr("data-vid"),status: $(this).attr("State")}), function (json) {
			$.getJSON("/index.php?c=admin/weiyx/Vote&a=setstatus", utils.params({id:$(this).attr("data-vid"),status: $(this).attr("State")}), function (json) {
				if(json.success){
					loadList(curpage);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
		});
        $(".QrCode").mouseover(function () {
            //var img = $('<img class="QRCode" style="position:absolute;width:150px;height:150px;top:-60px;z-index:10;border:solid 10px #fff;" src="/admin/weixy/vote?act=qrcode&id=' + $(this).attr("data-val") + '"/>')
        	var img = $('<img class="QRCode" style="position:absolute;width:150px;height:150px;top:-60px;z-index:10;border:solid 10px #fff;" src="/index.php?c=admin/weiyx/Vote&a=qrcode&id=' + $(this).attr("data-val") + '"/>')
		    $(this).parent().append(img);
		}).mouseout(function () {
		    $(".QRCode").remove();
		});
    }

    me.addListener('votelist', function (key, args) {
        args.addClass('row');
        initUI(args);
        
    });
}

﻿IWF.plugins['voteuser'] = function () {

    var me = this;
    var url = "/admin/weixy/vote", vid = "", curpage = 1, rcsize = 10, pagesize = 10, msnry = null;
    var ViewModel = function () {
        var self = this;
        this.ItemList = ko.observableArray([]);
        self.BitImage = function (img) {
            var firstImage = img.length > 0 ? img.replace(/^,*/, '').split(',')[0] : "";
            return firstImage.replace(/\./ig, "_s.");
        }
        self.getTime = function (time) {
            return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
        }
        self.Orderby = function (obj) {
            return curpage > 1 ? (rcsize * (curpage - 1)) + obj + 1 : obj + 1;
        }
        self.LoadItems = function (key, sortkey, sort) {
            $.ajax({
                type: "POST",
                //url: "/admin/weixy/vote/",
                url: "/index.php?c=admin/weiyx/Vote&a=VoteItems",
                //data: { 'act': 'VoteItems', 'id': vid, 'cur': curpage, 'rcsize': rcsize, 'key': key, 'sortkey': sortkey, 'sort': sort },
                data: {'id': vid, 'cur': curpage, 'rcsize': rcsize, 'key': key, 'sortkey': sortkey, 'sort': sort },
                cache: false,
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    if (data != null) {
                        if (data.success) {
                            vm.ItemList(data.list);
                            var pageCount = Math.floor(data.recordCount / rcsize);
                            pageCount = (data.recordCount % rcsize) > 0 ? pageCount + 1 : pageCount;
                            $("#pageCount").text(pageCount);
                            $("#rcCount").text(data.recordCount);
                            $("#pagination").pageNav(curpage, pageCount, pagesize, function (page) {
                                curpage = page;
                                self.LoadItems(key, sortkey, sort);
                            });
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
        self.Add = function (obj) {
            $('<div id="dialog"><div class="input-group"><span class="input-group-addon">加票数</span><input id="Number" name="Number" class="form-control" /></div></div>').dialog({
                modal: true, width: 400, title: "为【" + obj.ItemTitle + "】加票",
                buttons: {
                    "保存": function () {
                        $.ajax({
                            type: "POST",
                            //url: "/admin/weixy/vote?act=AddVote",
                            url: "/index.php?c=admin/weiyx/Vote&a=AddVote",
                            cache: false,
                            context: $("[data-gid='" + obj.Gid + "']"),
                            dataType: "json",
                            data: { 'gid': obj.Gid, 'vid': obj.Vid, 'vc': $("#Number").val() },
                            success: function (data) {
                                if (data != null) {
                                    if (data.success) {
                                    	obj.VoteCount = parseInt($("#Number").val()) + parseInt(obj.VoteCount);
                                        $(this).text(obj.VoteCount);
                                        $("#dialog").dialog("destroy");
                                    } else {
                                        $("#dialog").html(data.msg);
                                    }
                                }
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                console.log(XMLHttpRequest.responseText);
                            }
                        });
                    }
                },
                close: function () {
                    $(this).dialog("destroy");
                }
            });
        };
        self.Del = function (obj) {
            if (!confirm("确认删除？")) return false;
            //$.getJSON("/admin/weixy/vote?act=DeletItems", { vid: obj.Vid, gid: obj.Gid }, function (json) {
            $.getJSON("/index.php?c=admin/weiyx/Vote&a=DeletItems", { vid: obj.Vid, gid: obj.Gid }, function (json) {
                if (json.success) {
                    vm.LoadItems($("#keyword").val());
                } else {
                    $.showResult("出错啦", json.msg);
                }
            });
        };
        self.State = function (obj, e) {
            console.log(e);
            $.ajax({
                type: "POST",
                //url: url,
                url: "/index.php?c=admin/weiyx/Vote&a=ItemState",
                cache: false,
                context: $(e.target),
                dataType: "json",
                //data: { 'act': 'ItemState', 'gid': obj.Gid, 'vid': obj.Vid, 'state': $(e.target).attr("data-state") },
                data: {'gid': obj.Gid, 'vid': obj.Vid, 'state': $(e.target).attr("data-state") },
                success: function (data) {
                    if (data != null) {
                        if (data.success) {
                            var state = parseInt($(this).attr("data-state"));
                            $(this).attr("data-state", state ? 0 : 1);
                            $(this)[state ? "addClass" : "removeClass"]("glyphicon-eye-close");
                            $(this)[state == 0 ? "addClass" : "removeClass"]("glyphicon-eye-open");
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
        self.ImageList = function (obj, e) {
            var html = ['<div id="dialog">'];
            $.ajax({
                type: "POST",
                //url: url,
                url: "/index.php?c=admin/weiyx/Vote&a=GetSelfForm",
                cache: false,
                dataType: "json",
                //data: { 'act': 'GetSelfForm', 'formRowId': obj.FormRowID },
                data: {'formRowId': obj.FormRowID },
                success: function (data) {
                    console.log(data);
                    if (data && data.success) {
                        html.push('<form id="form' + obj.FormRowID + '">');
                        html.push('<input type="hidden" name="FormRowID" value="' + obj.FormRowID + '"/>');
                        html.push('<div id="SelForm">');
                        
                        $.each(data.formlist, function (i, n) {
                            html.push('<div class="input-group"><span class="input-group-addon">', n.Name, ':</span><input type="text" value="', n.FieldValues, '" name="col' + n.ID + '" class="form-control"/></div>');
                        });
                        html.push('<div style="clear:both;text-align:center;"><input type="button" data-val="form' + obj.FormRowID + '" class="btn btn-primary modify" style="width:100px;" value="修改"/><input type="button" class="btn btn-primary UpFile" style="margin-left:20px;" value="图片上传" data-gid="' + obj.Gid + '" data-vid="' + obj.Vid + '" /></div>');
                        
                        html.push('</div></form>');
                    }
                },
                complete: function (XMLHttpRequest, textStatus) {
                    var imgs = obj.Images.split(',');
                    console.log(imgs);
                    html.push('<ul id="imgMas">');
                    for (var i in imgs) {
                        if (imgs[i]){
                             html.push('<li class="item"><img src="', imgs[i], '"/><i data-gid="',obj.Gid , '" data-vid="', obj.Vid , '" data-file="', imgs[i] ,'" class="DelFile glyphicon glyphicon-remove-circle"></i></li>');
                        };
                    }
                    html.push('</ul></div>');
                    $(html.join('')).dialog({
                        modal: true, width: 680, height: 600,title:obj.VIndex+"号:"+obj.ItemTitle, position: { my: "center center", at: "center center", of: window },
                        open: function (event, ui) {
                            if (msnry) {
                                msnry.destroy();
                            }
                            $("#imgMas").imagesLoaded(function () {
                                msnry = new Masonry(document.getElementById("imgMas"), {
                                    itemSelector: '.item'
                                });
                            });
                        },
                        close: function () {
                            vm.LoadItems($("#keyword").val());
                            $(this).dialog("destroy");
                        }
                    });
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        };
    };
    var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/voteuser.html?v=" + Math.random(), function () {
            vid = me.currentModule.params.vid;
            console.log(vid);
            bindUIEvent();
            curpage = 1;
            ko.applyBindings(vm, document.getElementById("showListTable"));
            vm.LoadItems();
        });
    }
    function bindUIEvent() {
        $("#BtnSearch").off("click").on("click", function (e) {
            curpage = 1;
            vm.LoadItems($("#keyword").val());
            e.preventDefault();
        });
        $("#BtnKeep").off("click").on("click", function () {
            var keeptop = parseInt($("#keeptop").val());
            if (!keeptop)
                return false;
            $.ajax({
                type: "POST",
                //url: url,
                url: "/index.php?c=admin/weiyx/Vote&a=KeepTop",
                cache: false,
                dataType: "json",
                //data: { 'act': 'KeepTop', 'top': keeptop, 'id': vid },
                data: {'top': keeptop, 'id': vid },
                success: function (data) {
                    if (data && data.success) {
                        $("#keeptop").val('');
                        curpage = 1;
                        vm.LoadItems($("#keyword").val());
                        $('<div id="topsuccess" style="text-align:center;"><span class="glyphicon glyphicon-ok" style="font-size:2em;color:#006600"></span></div>').dialog({
                            modal: true, width: 300, height: 100, title: "操作成功！", position: { my: "center center", at: "center center", of: window },
                            close: function () {
                                $(this).dialog("destroy");
                            }
                        });
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.responseText);
                }
            });
        });
        $(".sort--").off("click").on("click", function () {
            var sort = parseInt($(this).attr("data-sort"));
            vm.LoadItems($("#keyword").val(), $(this).attr("data-val"), sort);
            $(".sort").removeClass("sortBack");
            sort = sort ? 0 : 1;
            $(this).attr("data-sort", sort).addClass("sortBack");
        });
        $(document).off("click.modify").on("click.modify", function (e) {
            if ($(e.target).hasClass("modify")) {
                //var params = $("#" + $(e.target).attr("data-val")).serialize() + '&act=Modify';
                //$.post(url, params,
            	var params = $("#" + $(e.target).attr("data-val")).serialize();
            	$.post("/index.php?c=admin/weiyx/Vote&a=Modify", params,
               function (data) {
                   console.log(data);
                   if (data && data.success) {
                       $("<div id='ResultModify'></div>").dialog({
                           modal: true, width: 200, height: 100, title: "修改成功", position: { my: "center center", at: "center center", of: window },
                           open: function (event, ui) {
                               $(this).append("<strong style='color:red;'>修改成功</strong>");
                           },
                           close: function () {
                               $(this).dialog("destroy");
                           }
                       });
                   }
               }, "json");
            }
        });
        $(document).off("click.UpFile").on("click.UpFile", function (e) {
            if ($(e.target).hasClass("UpFile")) {
                var gid = $(e.target).attr("data-gid");
                var vid = $(e.target).attr("data-vid");
                YDM.FileManager('image', 100, function (aUrl) {
                    //$.post(url, { "act": "UpFile", "imgs": aUrl.toString(),'gid':gid,'vid':vid },
                	$.post("/index.php?c=admin/weiyx/Vote&a=UpFile", {"imgs": aUrl.toString(),'gid':gid,'vid':vid },
                       function (data) {
                           if (data && data.success) {
                               for (var i in data.list) {
                                   $("#imgMas").append(['<li class="item"><img src="', data.list[i], '"/><i data-gid="', gid, '" data-vid="', vid, '" data-file="', data.list[i], '" class="DelFile glyphicon glyphicon-remove-circle"></i></li>'].join(''));
                               }
                               if (msnry) {
                                   msnry.destroy();
                               }
                               $("#imgMas").imagesLoaded(function () {
                                   msnry = new Masonry(document.getElementById("imgMas"), {
                                       itemSelector: '.item'
                                   });
                               });
                           }
                       }, "json");
                });
            }
        });
        $(document).off("click.DelFile").on("click.DelFile", function (e) {
            if ($(e.target).hasClass("DelFile")) {
                var _this = $(e.target);
                //$.post(url, { "act": "DelFile", "vid": _this.attr("data-vid"), 'gid': _this.attr("data-gid"), 'file': _this.attr("data-file") },
                $.post("/index.php?c=admin/weiyx/Vote&a=DelFile", { "vid": _this.attr("data-vid"), 'gid': _this.attr("data-gid"), 'file': _this.attr("data-file") },
               function (data) {
                   console.log(data);
                   if (data != null && data.success) {
                        console.log(_this.parent());
                       _this.parent().remove();
                       if (msnry) {
                           msnry.destroy();
                       }
                       msnry = new Masonry(document.getElementById("imgMas"), {
                           itemSelector:'.item'
                       });
                   }
               }, "json");
            }
        });
    }

    me.addListener('voteuser', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}
﻿IWF.plugins['walledit'] = function () {

    var me = this;

    var ViewModel = function () {
        this.setData = function (data) {
            for (var key in data) {
                this[key] = data[key];
            }
        };
		this.showImage = function (image) {
	        if(!image) image = "/images/hudongimg/wall.jpg";
			image = "<img src='"+ image +"' width='360'>";
			$("#ImgPreview").show();
	        return image;
	    }
		this.showImage2 = function (image,previewObj) {
	        if(!image) return "";
			image = "<img src='"+ image +"'>";
			$("#" + previewObj).show();
	        return image;
	    }
        this.getTime = function (time) {
			if(/^(1970)/.test(time)) return "";
            return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
        }
    };
    
    var vm = new ViewModel();
    var myroot = null;
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/walledit.html", function () {
            myroot = root[0];
			initFormEvent();
			$("#handleweixin",myroot).off().on("click",function(){ showPreviewPage("weixin") });
			$("#handlewall",myroot).off().on("click",function(){ showPreviewPage("wall") });
			$("#prevBtn,#nextBtn").off().on("click",function(){ showPreviewPage() });
			$("#wall-tabs",myroot).tabs();
			$("#Title",myroot).unbind().change(function(){$(myroot).find("#weixintitle").html($(this).val())});
			$("#Banner",myroot).unbind().change(function(){ $(myroot).find("#weixinimage").prop("src",$(this).val())});
			
			//日期控件
            $('#StartTime,#EndTime',myroot).datetimepicker({
                dayOfWeekStart: 1,
                lang: 'ch',
                format: 'Y-m-d H:i:00'
            });
			
			$('#Banner',myroot).on('click', function () {
                YDM.FileManager('image', 1, function (aUrl) {
                    if (aUrl.length > 0) {
                        $('#Banner').val(aUrl[0]);
						$('#Banner').trigger('change');
                        $('#ImgPreview').html("<img src='"+ aUrl[0] +"' width='360'>").show();
                    }
                })
            });

			$('#Background',myroot).on('click', function () {
                YDM.FileManager('image', 1, function (aUrl) {
                    if (aUrl.length > 0) {
                        $('#Background').val(aUrl[0]);
						$('#Background').trigger('change');
						$('#BackgroundPreview').html("<img src='"+ aUrl[0] +"' width='360'>").show();
                    }
                })
            });

			$('#Logo',myroot).on('click', function () {
                YDM.FileManager('image', 1, function (aUrl) {
                    if (aUrl.length > 0) {
                        $('#Logo').val(aUrl[0]);
						$('#Logo').trigger('change');
                        $('#LogoPreview').html("<img src='"+ aUrl[0] +"' width='200'>").show();
                    }
                })
            });

			$('#QRCode',myroot).on('click', function () {
                YDM.FileManager('image', 1, function (aUrl) {
                    if (aUrl.length > 0) {
                        $('#QRCode').val(aUrl[0]);
						$('#QRCode').trigger('change');
                        $('#QRCodePreview').html("<img src='"+ aUrl[0] +"' width='200'>").show();
                    }
                })
            });
			
            if (me.currentModule.params && me.currentModule.params.id) loadInfo();
			else{
				showPreviewPage();
			}
        });
    }

    function initFormEvent() {
        ///当前时间与传入的时间比较
        jQuery.validator.addMethod("CheckDate", function (value, element, params) {
            var vDate = Number(new Date(value).valueOf());
            var pDate = Number(new Date($(params).val()).valueOf());
            return this.optional(element) || ((vDate - pDate) > 0);
        }, jQuery.validator.format("当前时间不能早于{0}的时间."));

        $("#MainForm",myroot).validate({
            invalidHandler: function () {
                $(".gray").removeClass("gray");
            },
            rules: {
                Title: "required"
				, Intro: "required"
				, StartTime: { date: true }
				, EndTime: { date: true, CheckDate: $("#StartTime",myroot) }
            },
            messages: {
                Title: { required: "请输入标题！" }
				, Intro: "请输入简介"
				, StartTime: { required: "请输入活动开始时间！", date: "正确的日期格式：2015-01-01 12:00:00" }
				, EndTime: { required: "请输入活动结束时间！", date: "正确的日期格式：2015-01-01 18:00:00", CheckDate: "结束时间不能早于开始时间！" }
            },
            submitHandler: function (form) {
                submitForm();
                return false;
            },
			errorPlacement: function(error, element) {
			   error.insertAfter(element);
			   var id = element.closest(".ui-tabs-panel").attr("id");
			   $("#wall-tabs",myroot).tabs("option", "active", 0);
		   },
			ignore: []
        });
    }

	function showPreviewPage(){
		var title = $("#Title",myroot).val();
		var image = $("#Banner",myroot).val();
		if(!title) title = "微信墙标题";
		if(!image) image = "/images/hudongimg/wall.jpg";
		$("#previewframe").html('<center style="padding:10px"><img src="'+ image +'" id="weixinimage" width="100%"><div style="background:#EEEEEE;text-align:left;color:#333333;padding-left:20px;padding:5px;"><b id="weixintitle">'+ title +'</b></div></center>');
	}
	
	var ue = null;
	function initUE() {
	    try {
	        ue = new baidu.editor.ui.Editor({
				initialFrameWidth: "360",
	            initialFrameHeight: "350",
	            autoHeightEnabled: true,
	            toolbars: [[
                     'bold', 'italic', 'underline', 'strikethrough', 'removeformat'
					, 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'fontsize'
					, 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify'
					, 'imagenone', 'imageleft', 'imageright', 'imagecenter'
	            ]]
	        });
	        ue.ready(function () {
	            ue.setContent($("#Detail", myroot).val());
	        });
	        ue.render('editor');
		} catch (e) {
		    console.log("error: " + e);
		}
	}
		
    function loadInfo() {
        var params = { sid: me.sid, id: me.currentModule.params.id };
        console.log(params);
        // $.getJSON("/admin/weixy/wallmanage?act=GetInfo", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/wall&a=GetInfo", utils.params(params), function (json) {
            vm.setData(json);
            ko.applyBindings(vm, myroot);
			// var qrcodesrc = "/admin/weixy/wallmanage?act=qrcode&id=" + json.info.ID;
            var qrcodesrc = "/index.php?c=admin/weiyx/wall&a=QRCode&id=" + json.info.ID; 
			$("#ImgQrcode",myroot).html("<img src='"+ qrcodesrc +"' width='138'/>");
			$("#BtnWeixinMenu",myroot).removeClass("disabled");
			$("#LabWeixinMenu",myroot).hide();
			$("#WallUrl",myroot).prop("rows",3);
			showPreviewPage();
        });
    }
		
	function submitForm() {
		//var html = ue.getContent();
		//$("#Detail", myroot).val(html);
        var params = $('#MainForm').serializeObject();
        // $.post("/admin/weixy/wallmanage?act=Edit", params, function (data, textStatus, jqXHR) {
        $.post("/index.php?c=admin/weiyx/wall&a=Edit", params, function (data, textStatus, jqXHR) {
            if (data.success) {
                $('<div id="success">保存成功</div>').dialog({
                    modal: true, width: 400, close: function () {
                        $("#success").dialog("destroy");
                        me.execCommand('go', { a: 'weixy', b: 'walllist'});
                    }
                });
            } else {
                $('<div id="error">'+data.msg+'</div>').dialog({
                    modal: true, width: 400,title:"保存失败", close: function () { $("#error").dialog("destroy"); }
                });
            }
        }, "json");
    }

    me.addListener('walledit', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['walllist'] = function () {

    var me = this;

	var ViewModel = function () {
	    this.list = ko.observableArray();
        this.setData = function (data) { this.list(data); };
		this.showImage = function (image) {
	        if(!image) image = "/images/hudongimg/wall.jpg";
	        return image;
	    }
		this.getTime = function(time){
			if(/^(1970)/.test(time)) return "不限制结束时间";
			return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
		}
    };

	var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/walllist.html",function(){
			bindUIEvent();
			ko.applyBindings(vm,root[0]);
			loadwalllist(1);			
        });
    }
	    
	var curpage = 1;
	var itemcount = 0;
    function loadwalllist(page) {
        var params = { sid: me.sid, keyword: $("#keyword").val(),page: page, pagesize: 20 };
        // $.getJSON("/admin/weixy/wallmanage?act=getlist", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/wall&a=GetList", utils.params(params), function (json) {
            vm.setData(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadwalllist(page); });
                $("#pagination").show();
            }
            bindGridEvent();
        });
    }

    function bindUIEvent() {
		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadwalllist(1);
        });

		$("#BtnAddLuck").unbind().bind('click', function (event) {
		    me.execCommand('go', { a: 'weixy', b: 'walledit', params: me.currentModule.params });
			return false;
        });
	}

    function bindGridEvent() {
        $("*[name=BtnEdit]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("WallID") };
			me.execCommand('go', { a: 'weixy', b: 'walledit', params: params });
			return false;
        });

		$("*[name=BtnGoFans]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("WallID") };
			me.execCommand('go', { a: 'weixy', b: 'wallusers', params: params });
			return false;
        });

		$("*[name=BtnGoMsgList]").unbind('click').bind('click', function (event) {
            var params = { id: $(this).attr("WallID") };
			me.execCommand('go', { a: 'weixy', b: 'wallmsglist', params: params });
			return false;
        });

		$("*[name=BtnGoScreen]").unbind('click').bind('click', function (event) {
			var params = {id: $(this).attr("WallID") };
            //me.execCommand('go', { a: 'weixy', b: 'wallusers', params: params });
			// window.open("/wall/" + $(this).attr("WallID") + "/");
            // window.open("http://"+window.location.host+"/index.php?c=front/wall&a=index&id=" + $(this).attr("WallID"));
            window.open("/index.php?c=front/wall&id=" + $(this).attr("WallID"));
			return false;
        });

        $("*[name=BtnDel]").unbind('click').bind('click', function (event) {
			if(!confirm("确认删除？")) return false;
			// $.getJSON("/admin/weixy/wallmanage?act=Delete", utils.params({id:$(this).attr("WallID")}), function (json) {
            $.getJSON("/index.php?c=admin/weiyx/wall&a=Delete", utils.params({id:$(this).attr("WallID")}), function (json) { 
				if(json.success){
					if(itemcount > 1) loadwalllist(curpage);
					else loadwalllist(1);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
        });

		$("*[name=BtnSetStatus]").unbind('click').bind('click', function (event) {
			// $.getJSON("/admin/weixy/wallmanage?act=setstatus", utils.params({id:$(this).attr("WallID"),status: $(this).attr("Status")}), function (json) {
            $.getJSON("/index.php?c=admin/weiyx/wall&a=SetStatus", utils.params({id:$(this).attr("WallID"),status: $(this).attr("Status")}), function (json) { 
				if(json.success){
					loadwalllist(curpage);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
		});
		
        $(".fa-qrcode").mouseover(function () {
			var maxh = $("#showListTable").position().top;
			$("#divQRCodePreview").remove();
			// var qrcodesrc = "/admin/weixy/wallmanage?act=qrcode&id=" + $(this).attr("data-val");
            var qrcodesrc = "/index.php?c=admin/weiyx/wall&a=qrcode&id=" + $(this).attr("data-val"); 
			var html = "<div id='divQRCodePreview' class='divQRCodePreview' style='padding:5px;border:1px solid #cccccc;background:white;position:absolute;z-index:999'>";
			html += "<img src='"+ qrcodesrc +"' width='150'/>";
			html += "</div>";
			$("body").append(html);
			var top = $(this).offset().top + 20;
			if(top + $("#divQRCodePreview").height() > maxh) top = $(this).offset().top - $("#divQRCodePreview").height();
			$("#divQRCodePreview").css({top:top,left:$(this).offset().left + 20});
			
		}).mouseout(function () {
		    $("#divQRCodePreview").remove();
		});
    }

    me.addListener('walllist', function (key, args) {
        initUI(args);
    });
}

﻿IWF.plugins['wallmsglist'] = function () {

    var me = this;
	
	var template = null;
	var maxMsgId = 0;
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/wallmsglist.html",function(){
			bindUIEvent();
			maxMsgId = 0;
			template = $("#msglist").html();
			$("#msglist").children().remove();
			loadmsglist();
		});
    }
	
	function getTime(time) {
		if(/^(1970)/.test(time)) return "";
		return time.replace(/T/gi, " ").replace(/(\.\d+)/, "");
	}

    function loadmsglist() {
        var params = { id: me.currentModule.params.id,maxMsgId:maxMsgId  };
        // $.getJSON("/admin/weixy/wallmanage?act=GetMsgList", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/wall&a=GetMsgList", utils.params(params), function (json) {
            
			if(json.list && json.list.length  > 0){
				maxMsgId = json.list[json.list.length - 1].MsgId;
				for(var i = 0;i < json.list.length;i++){
					var html = template;
					var status = "<font color='red'>未审</font>";
					var opera = "<font name='BtnReview' color='green' style='cursor:pointer' msgid='"+ json.list[i].MsgId +"' review='1'>审核通过</font>";
					if(!json.list[i].HeadImgUrl) json.list[i].HeadImgUrl = "/images/hudongimg/wall-default-head.jpg";
					if(json.list[i].IsReview == 1) status = "<font color='green'>已审</font>";
					if(json.list[i].IsReview == 1) opera = "<font name='BtnReview' color='red' msgid='"+ json.list[i].MsgId +"' review='0' style='cursor:pointer'>取消审核</font>";

					html = html.replace("{HeadImgUrl}",json.list[i].HeadImgUrl);
					html = html.replace("{Nickname}",json.list[i].Nickname ? json.list[i].Nickname : json.list[i].OpenId);
					html = html.replace("{CrDate}",getTime(json.list[i].CrDate));
					html = html.replace("{Content}",json.list[i].JsonContent.Content);
					html = html.replace("{Status}",status);
					html = html.replace("{Opera}",opera);
					$("#msglist").append(html);
				}
				$("body").scrollTop(99999999);
			}

            bindGridEvent();
			setTimeout(loadmsglist,2000);
        });
    }

	function showList(){
		
	}
	
	function bindUIEvent(){

		$("#BtnBack").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'weixy', b: 'walllist' });
			return false;
        });
	}

    function bindGridEvent() {

		$("*[name=BtnReview]").unbind('click').bind('click', function (event) {
			var review = $(this).attr("review");
			var msgid = $(this).attr("MsgId");
			var obj = $(this);
			// $.getJSON("/admin/weixy/wallmanage?act=SetMsgReview", utils.params({id:msgid,review: review}), function (json) {
            $.getJSON("/index.php?c=admin/weiyx/wall&a=SetMsgReview", utils.params({id:msgid,review: review}), function (json) { 
				if(json.success){
					var status = "<font color='red'>未审</font>";
					if(review == '1') status = "<font color='green'>已审</font>";
					
					var opera = "<font name='BtnReview' color='green' style='cursor:pointer' msgid='"+ msgid +"' review='1'>审核通过</font>";
					if(review == '1') opera = "<font name='BtnReview' color='red' msgid='"+ msgid +"' review='0' style='cursor:pointer'>取消审核</font>";

					$(obj).closest("tr").find(".status").html(status);
					$(obj).parent().html(opera);
					bindGridEvent();
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
		});
    }

    me.addListener('wallmsglist', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

﻿IWF.plugins['wallusers'] = function () {

    var me = this;
	
	var ViewModel = function () {
        this.list = ko.observableArray();
        this.setData = function (list) { this.list(list); };
		this.getTime = function(time){
			if(/^(1970)/.test(time)) return "--";
			return time.replace(/T/gi," ").replace(/(\.\d+)/,"");
		}
		this.showHead = function(img){
			if(!img) img = "/images/hudongimg/wall-default-head.jpg";
			return img;
		}
		this.showName = function(name,openid){
			if(!name) name = "匿名(" + openid + ")";
			return name;
		}
    };

	var vm = new ViewModel();
    function initUI(root) {
        root.children().remove();
        root.loadHtmlTpl("plugins/weixypackage/html/wallusers.html",function(){
			bindUIEvent();
			ko.applyBindings(vm,root[0]);
			loadusers(1);
		});
    }
	    
	var curpage = 1;
	var itemcount = 0;
    function loadusers(page) {
        var params = { id: me.currentModule.params.id,keyword: $("#keyword").val(), page: page, pagesize: 20 };
        // $.getJSON("/admin/weixy/wallmanage?act=GetWallUsers", utils.params(params), function (json) {
        $.getJSON("/index.php?c=admin/weiyx/wall&a=GetWallUsers", utils.params(params), function (json) {
            vm.setData(json.list);
			curpage = json.curpage;
			itemcount = json.list.length;
            if (json.pagecount < 2) $("#pagination").hide();
            else {
                //pageNav 方法定义在 /core/util.js 里
                $("#pagination").pageNav(json.curpage, json.pagecount, 10, function (page) { loadusers(page); });
                $("#pagination").show();
            }
			$("#countinfo").html("共 "+ json.total +" 条记录");
            bindGridEvent();
        });
    }
	
	function getTime(time){
		return time.replace(/T/gi," ").replace(/(\.\d+)/,"");
	}

	function bindUIEvent(){

		$("#BtnSearch").unbind('click').bind('click', function (event) {
			loadusers(1);
        });

		$("#BtnBack").unbind().bind('click', function (event) {
            me.execCommand('go', { a: 'weixy', b: 'walllist' });
			return false;
        });
	}

    function bindGridEvent() {

		$("*[name=BtnSetStatus]").unbind('click').bind('click', function (event) {
			// $.getJSON("/admin/weixy/wallmanage?act=SetFansStatus", utils.params({id:$(this).attr("FansID"),status: $(this).attr("Status")}), function (json) {
            $.getJSON("/index.php?c=admin/weiyx/wall&a=SetFansStatus", utils.params({id:$(this).attr("FansID"),status: $(this).attr("Status")}), function (json) { 
				if(json.success){
					loadusers(curpage);
				}else{
					$.showResult("出错啦",json.msg);
				}
			});
			return false;
		});
    }

    me.addListener('wallusers', function (key, args) {
        args.addClass('row');
        initUI(args);
    });
}

